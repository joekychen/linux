<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › qib › qib_iba7322.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>qib_iba7322.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008, 2009, 2010 QLogic Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file contains all of the code that is specific to the</span>
<span class="cm"> * InfiniPath 7322 chip</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_smi.h&gt;</span>

<span class="cp">#include &quot;qib.h&quot;</span>
<span class="cp">#include &quot;qib_7322_regs.h&quot;</span>
<span class="cp">#include &quot;qib_qsfp.h&quot;</span>

<span class="cp">#include &quot;qib_mad.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_setup_7322_setextled</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_7322_handle_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sendctrl_7322_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">op</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">qib_7322intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">qib_7322bufavail</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sdma_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sdma_idle_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sdma_progress_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sdma_cleanup_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_7322_txchk_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">qib_7322_phys_portstate</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">qib_7322_iblink_state</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">linkcmd</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">linitcmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">force_h1</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adj_tx_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">qib_7322_setpbc_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">ahb_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">serdes_7322_los_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">serdes_7322_init_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">serdes_7322_init_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#define BMASK(msb, lsb) (((1 &lt;&lt; ((msb) + 1 - (lsb))) - 1) &lt;&lt; (lsb))</span>

<span class="cm">/* LE2 serdes values for different cases */</span>
<span class="cp">#define LE2_DEFAULT 5</span>
<span class="cp">#define LE2_5m 4</span>
<span class="cp">#define LE2_QME 0</span>

<span class="cm">/* Below is special-purpose, so only really works for the IB SerDes blocks. */</span>
<span class="cp">#define IBSD(hw_pidx) (hw_pidx + 2)</span>

<span class="cm">/* these are variables for documentation and experimentation purposes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">rcv_int_timeout</span> <span class="o">=</span> <span class="mi">375</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">rcv_int_count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">sdma_idle_cnt</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

<span class="cm">/* Time to stop altering Rx Equalization parameters, after link up. */</span>
<span class="cp">#define RXEQ_DISABLE_MSECS 2500</span>

<span class="cm">/*</span>
<span class="cm"> * Number of VLs we are configured to use (to allow for more</span>
<span class="cm"> * credits per vl, etc.)</span>
<span class="cm"> */</span>
<span class="n">ushort</span> <span class="n">qib_num_cfg_vls</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_vls</span><span class="p">,</span> <span class="n">qib_num_cfg_vls</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_vls</span><span class="p">,</span> <span class="s">&quot;Set number of Virtual Lanes to use (1-8)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">qib_chase</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">chase</span><span class="p">,</span> <span class="n">qib_chase</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">chase</span><span class="p">,</span> <span class="s">&quot;Enable state chase handling&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">qib_long_atten</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* 10 dB ~= 5m length */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">long_attenuation</span><span class="p">,</span> <span class="n">qib_long_atten</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">long_attenuation</span><span class="p">,</span> \
		 <span class="s">&quot;attenuation cutoff (dB) for long copper cable setup&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">qib_singleport</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">singleport</span><span class="p">,</span> <span class="n">qib_singleport</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">singleport</span><span class="p">,</span> <span class="s">&quot;Use only IB port 1; more per-port buffer space&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">qib_krcvq01_no_msi</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">krcvq01_no_msi</span><span class="p">,</span> <span class="n">qib_krcvq01_no_msi</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">krcvq01_no_msi</span><span class="p">,</span> <span class="s">&quot;No MSI for kctx &lt; 2&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Receive header queue sizes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">qib_rcvhdrcnt</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">rcvhdrcnt</span><span class="p">,</span> <span class="n">qib_rcvhdrcnt</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rcvhdrcnt</span><span class="p">,</span> <span class="s">&quot;receive header count&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">qib_rcvhdrsize</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">rcvhdrsize</span><span class="p">,</span> <span class="n">qib_rcvhdrsize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rcvhdrsize</span><span class="p">,</span> <span class="s">&quot;receive header size in 32-bit words&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">qib_rcvhdrentsize</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">rcvhdrentsize</span><span class="p">,</span> <span class="n">qib_rcvhdrentsize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rcvhdrentsize</span><span class="p">,</span> <span class="s">&quot;receive header entry size in 32-bit words&quot;</span><span class="p">);</span>

<span class="cp">#define MAX_ATTEN_LEN 64 </span><span class="cm">/* plenty for any real system */</span><span class="cp"></span>
<span class="cm">/* for read back, default index is ~5m copper cable */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">txselect_list</span><span class="p">[</span><span class="n">MAX_ATTEN_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;10&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kparam_string</span> <span class="n">kp_txselect</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">txselect_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">MAX_ATTEN_LEN</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">setup_txselect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="p">);</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">txselect</span><span class="p">,</span> <span class="n">setup_txselect</span><span class="p">,</span> <span class="n">param_get_string</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">kp_txselect</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">txselect</span><span class="p">,</span> \
		 <span class="s">&quot;Tx serdes indices (for no QSFP or invalid QSFP data)&quot;</span><span class="p">);</span>

<span class="cp">#define BOARD_QME7342 5</span>
<span class="cp">#define BOARD_QMH7342 6</span>
<span class="cp">#define IS_QMH(dd) (SYM_FIELD((dd)-&gt;revision, Revision, BoardID) == \</span>
<span class="cp">		    BOARD_QMH7342)</span>
<span class="cp">#define IS_QME(dd) (SYM_FIELD((dd)-&gt;revision, Revision, BoardID) == \</span>
<span class="cp">		    BOARD_QME7342)</span>

<span class="cp">#define KREG_IDX(regname)     (QIB_7322_##regname##_OFFS / sizeof(u64))</span>

<span class="cp">#define KREG_IBPORT_IDX(regname) ((QIB_7322_##regname##_0_OFFS / sizeof(u64)))</span>

<span class="cp">#define MASK_ACROSS(lsb, msb) \</span>
<span class="cp">	(((1ULL &lt;&lt; ((msb) + 1 - (lsb))) - 1) &lt;&lt; (lsb))</span>

<span class="cp">#define SYM_RMASK(regname, fldname) ((u64)              \</span>
<span class="cp">	QIB_7322_##regname##_##fldname##_RMASK)</span>

<span class="cp">#define SYM_MASK(regname, fldname) ((u64)               \</span>
<span class="cp">	QIB_7322_##regname##_##fldname##_RMASK &lt;&lt;       \</span>
<span class="cp">	 QIB_7322_##regname##_##fldname##_LSB)</span>

<span class="cp">#define SYM_FIELD(value, regname, fldname) ((u64)	\</span>
<span class="cp">	(((value) &gt;&gt; SYM_LSB(regname, fldname)) &amp;	\</span>
<span class="cp">	 SYM_RMASK(regname, fldname)))</span>

<span class="cm">/* useful for things like LaFifoEmpty_0...7, TxCreditOK_0...7, etc. */</span>
<span class="cp">#define SYM_FIELD_ACROSS(value, regname, fldname, nbits) \</span>
<span class="cp">	(((value) &gt;&gt; SYM_LSB(regname, fldname)) &amp; MASK_ACROSS(0, nbits))</span>

<span class="cp">#define HWE_MASK(fldname) SYM_MASK(HwErrMask, fldname##Mask)</span>
<span class="cp">#define ERR_MASK(fldname) SYM_MASK(ErrMask, fldname##Mask)</span>
<span class="cp">#define ERR_MASK_N(fldname) SYM_MASK(ErrMask_0, fldname##Mask)</span>
<span class="cp">#define INT_MASK(fldname) SYM_MASK(IntMask, fldname##IntMask)</span>
<span class="cp">#define INT_MASK_P(fldname, port) SYM_MASK(IntMask, fldname##IntMask##_##port)</span>
<span class="cm">/* Below because most, but not all, fields of IntMask have that full suffix */</span>
<span class="cp">#define INT_MASK_PM(fldname, port) SYM_MASK(IntMask, fldname##Mask##_##port)</span>


<span class="cp">#define SYM_LSB(regname, fldname) (QIB_7322_##regname##_##fldname##_LSB)</span>

<span class="cm">/*</span>
<span class="cm"> * the size bits give us 2^N, in KB units.  0 marks as invalid,</span>
<span class="cm"> * and 7 is reserved.  We currently use only 2KB and 4KB</span>
<span class="cm"> */</span>
<span class="cp">#define IBA7322_TID_SZ_SHIFT QIB_7322_RcvTIDArray0_RT_BufSize_LSB</span>
<span class="cp">#define IBA7322_TID_SZ_2K (1UL&lt;&lt;IBA7322_TID_SZ_SHIFT) </span><span class="cm">/* 2KB */</span><span class="cp"></span>
<span class="cp">#define IBA7322_TID_SZ_4K (2UL&lt;&lt;IBA7322_TID_SZ_SHIFT) </span><span class="cm">/* 4KB */</span><span class="cp"></span>
<span class="cp">#define IBA7322_TID_PA_SHIFT 11U </span><span class="cm">/* TID addr in chip stored w/o low bits */</span><span class="cp"></span>

<span class="cp">#define SendIBSLIDAssignMask \</span>
<span class="cp">	QIB_7322_SendIBSLIDAssign_0_SendIBSLIDAssign_15_0_RMASK</span>
<span class="cp">#define SendIBSLMCMask \</span>
<span class="cp">	QIB_7322_SendIBSLIDMask_0_SendIBSLIDMask_15_0_RMASK</span>

<span class="cp">#define ExtLED_IB1_YEL SYM_MASK(EXTCtrl, LEDPort0YellowOn)</span>
<span class="cp">#define ExtLED_IB1_GRN SYM_MASK(EXTCtrl, LEDPort0GreenOn)</span>
<span class="cp">#define ExtLED_IB2_YEL SYM_MASK(EXTCtrl, LEDPort1YellowOn)</span>
<span class="cp">#define ExtLED_IB2_GRN SYM_MASK(EXTCtrl, LEDPort1GreenOn)</span>
<span class="cp">#define ExtLED_IB1_MASK (ExtLED_IB1_YEL | ExtLED_IB1_GRN)</span>
<span class="cp">#define ExtLED_IB2_MASK (ExtLED_IB2_YEL | ExtLED_IB2_GRN)</span>

<span class="cp">#define _QIB_GPIO_SDA_NUM 1</span>
<span class="cp">#define _QIB_GPIO_SCL_NUM 0</span>
<span class="cp">#define QIB_EEPROM_WEN_NUM 14</span>
<span class="cp">#define QIB_TWSI_EEPROM_DEV 0xA2 </span><span class="cm">/* All Production 7322 cards. */</span><span class="cp"></span>

<span class="cm">/* HW counter clock is at 4nsec */</span>
<span class="cp">#define QIB_7322_PSXMITWAIT_CHECK_RATE 4000</span>

<span class="cm">/* full speed IB port 1 only */</span>
<span class="cp">#define PORT_SPD_CAP (QIB_IB_SDR | QIB_IB_DDR | QIB_IB_QDR)</span>
<span class="cp">#define PORT_SPD_CAP_SHIFT 3</span>

<span class="cm">/* full speed featuremask, both ports */</span>
<span class="cp">#define DUAL_PORT_CAP (PORT_SPD_CAP | (PORT_SPD_CAP &lt;&lt; PORT_SPD_CAP_SHIFT))</span>

<span class="cm">/*</span>
<span class="cm"> * This file contains almost all the chip-specific register information and</span>
<span class="cm"> * access functions for the FAKED QLogic InfiniPath 7322 PCI-Express chip.</span>
<span class="cm"> */</span>

<span class="cm">/* Use defines to tie machine-generated names to lower-case names */</span>
<span class="cp">#define kr_contextcnt KREG_IDX(ContextCnt)</span>
<span class="cp">#define kr_control KREG_IDX(Control)</span>
<span class="cp">#define kr_counterregbase KREG_IDX(CntrRegBase)</span>
<span class="cp">#define kr_errclear KREG_IDX(ErrClear)</span>
<span class="cp">#define kr_errmask KREG_IDX(ErrMask)</span>
<span class="cp">#define kr_errstatus KREG_IDX(ErrStatus)</span>
<span class="cp">#define kr_extctrl KREG_IDX(EXTCtrl)</span>
<span class="cp">#define kr_extstatus KREG_IDX(EXTStatus)</span>
<span class="cp">#define kr_gpio_clear KREG_IDX(GPIOClear)</span>
<span class="cp">#define kr_gpio_mask KREG_IDX(GPIOMask)</span>
<span class="cp">#define kr_gpio_out KREG_IDX(GPIOOut)</span>
<span class="cp">#define kr_gpio_status KREG_IDX(GPIOStatus)</span>
<span class="cp">#define kr_hwdiagctrl KREG_IDX(HwDiagCtrl)</span>
<span class="cp">#define kr_debugportval KREG_IDX(DebugPortValueReg)</span>
<span class="cp">#define kr_fmask KREG_IDX(feature_mask)</span>
<span class="cp">#define kr_act_fmask KREG_IDX(active_feature_mask)</span>
<span class="cp">#define kr_hwerrclear KREG_IDX(HwErrClear)</span>
<span class="cp">#define kr_hwerrmask KREG_IDX(HwErrMask)</span>
<span class="cp">#define kr_hwerrstatus KREG_IDX(HwErrStatus)</span>
<span class="cp">#define kr_intclear KREG_IDX(IntClear)</span>
<span class="cp">#define kr_intmask KREG_IDX(IntMask)</span>
<span class="cp">#define kr_intredirect KREG_IDX(IntRedirect0)</span>
<span class="cp">#define kr_intstatus KREG_IDX(IntStatus)</span>
<span class="cp">#define kr_pagealign KREG_IDX(PageAlign)</span>
<span class="cp">#define kr_rcvavailtimeout KREG_IDX(RcvAvailTimeOut0)</span>
<span class="cp">#define kr_rcvctrl KREG_IDX(RcvCtrl) </span><span class="cm">/* Common, but chip also has per-port */</span><span class="cp"></span>
<span class="cp">#define kr_rcvegrbase KREG_IDX(RcvEgrBase)</span>
<span class="cp">#define kr_rcvegrcnt KREG_IDX(RcvEgrCnt)</span>
<span class="cp">#define kr_rcvhdrcnt KREG_IDX(RcvHdrCnt)</span>
<span class="cp">#define kr_rcvhdrentsize KREG_IDX(RcvHdrEntSize)</span>
<span class="cp">#define kr_rcvhdrsize KREG_IDX(RcvHdrSize)</span>
<span class="cp">#define kr_rcvtidbase KREG_IDX(RcvTIDBase)</span>
<span class="cp">#define kr_rcvtidcnt KREG_IDX(RcvTIDCnt)</span>
<span class="cp">#define kr_revision KREG_IDX(Revision)</span>
<span class="cp">#define kr_scratch KREG_IDX(Scratch)</span>
<span class="cp">#define kr_sendbuffererror KREG_IDX(SendBufErr0) </span><span class="cm">/* and base for 1 and 2 */</span><span class="cp"></span>
<span class="cp">#define kr_sendcheckmask KREG_IDX(SendCheckMask0) </span><span class="cm">/* and 1, 2 */</span><span class="cp"></span>
<span class="cp">#define kr_sendctrl KREG_IDX(SendCtrl)</span>
<span class="cp">#define kr_sendgrhcheckmask KREG_IDX(SendGRHCheckMask0) </span><span class="cm">/* and 1, 2 */</span><span class="cp"></span>
<span class="cp">#define kr_sendibpktmask KREG_IDX(SendIBPacketMask0) </span><span class="cm">/* and 1, 2 */</span><span class="cp"></span>
<span class="cp">#define kr_sendpioavailaddr KREG_IDX(SendBufAvailAddr)</span>
<span class="cp">#define kr_sendpiobufbase KREG_IDX(SendBufBase)</span>
<span class="cp">#define kr_sendpiobufcnt KREG_IDX(SendBufCnt)</span>
<span class="cp">#define kr_sendpiosize KREG_IDX(SendBufSize)</span>
<span class="cp">#define kr_sendregbase KREG_IDX(SendRegBase)</span>
<span class="cp">#define kr_sendbufavail0 KREG_IDX(SendBufAvail0)</span>
<span class="cp">#define kr_userregbase KREG_IDX(UserRegBase)</span>
<span class="cp">#define kr_intgranted KREG_IDX(Int_Granted)</span>
<span class="cp">#define kr_vecclr_wo_int KREG_IDX(vec_clr_without_int)</span>
<span class="cp">#define kr_intblocked KREG_IDX(IntBlocked)</span>
<span class="cp">#define kr_r_access KREG_IDX(SPC_JTAG_ACCESS_REG)</span>

<span class="cm">/*</span>
<span class="cm"> * per-port kernel registers.  Access only with qib_read_kreg_port()</span>
<span class="cm"> * or qib_write_kreg_port()</span>
<span class="cm"> */</span>
<span class="cp">#define krp_errclear KREG_IBPORT_IDX(ErrClear)</span>
<span class="cp">#define krp_errmask KREG_IBPORT_IDX(ErrMask)</span>
<span class="cp">#define krp_errstatus KREG_IBPORT_IDX(ErrStatus)</span>
<span class="cp">#define krp_highprio_0 KREG_IBPORT_IDX(HighPriority0)</span>
<span class="cp">#define krp_highprio_limit KREG_IBPORT_IDX(HighPriorityLimit)</span>
<span class="cp">#define krp_hrtbt_guid KREG_IBPORT_IDX(HRTBT_GUID)</span>
<span class="cp">#define krp_ib_pcsconfig KREG_IBPORT_IDX(IBPCSConfig)</span>
<span class="cp">#define krp_ibcctrl_a KREG_IBPORT_IDX(IBCCtrlA)</span>
<span class="cp">#define krp_ibcctrl_b KREG_IBPORT_IDX(IBCCtrlB)</span>
<span class="cp">#define krp_ibcctrl_c KREG_IBPORT_IDX(IBCCtrlC)</span>
<span class="cp">#define krp_ibcstatus_a KREG_IBPORT_IDX(IBCStatusA)</span>
<span class="cp">#define krp_ibcstatus_b KREG_IBPORT_IDX(IBCStatusB)</span>
<span class="cp">#define krp_txestatus KREG_IBPORT_IDX(TXEStatus)</span>
<span class="cp">#define krp_lowprio_0 KREG_IBPORT_IDX(LowPriority0)</span>
<span class="cp">#define krp_ncmodectrl KREG_IBPORT_IDX(IBNCModeCtrl)</span>
<span class="cp">#define krp_partitionkey KREG_IBPORT_IDX(RcvPartitionKey)</span>
<span class="cp">#define krp_psinterval KREG_IBPORT_IDX(PSInterval)</span>
<span class="cp">#define krp_psstart KREG_IBPORT_IDX(PSStart)</span>
<span class="cp">#define krp_psstat KREG_IBPORT_IDX(PSStat)</span>
<span class="cp">#define krp_rcvbthqp KREG_IBPORT_IDX(RcvBTHQP)</span>
<span class="cp">#define krp_rcvctrl KREG_IBPORT_IDX(RcvCtrl)</span>
<span class="cp">#define krp_rcvpktledcnt KREG_IBPORT_IDX(RcvPktLEDCnt)</span>
<span class="cp">#define krp_rcvqpmaptable KREG_IBPORT_IDX(RcvQPMapTableA)</span>
<span class="cp">#define krp_rxcreditvl0 KREG_IBPORT_IDX(RxCreditVL0)</span>
<span class="cp">#define krp_rxcreditvl15 (KREG_IBPORT_IDX(RxCreditVL0)+15)</span>
<span class="cp">#define krp_sendcheckcontrol KREG_IBPORT_IDX(SendCheckControl)</span>
<span class="cp">#define krp_sendctrl KREG_IBPORT_IDX(SendCtrl)</span>
<span class="cp">#define krp_senddmabase KREG_IBPORT_IDX(SendDmaBase)</span>
<span class="cp">#define krp_senddmabufmask0 KREG_IBPORT_IDX(SendDmaBufMask0)</span>
<span class="cp">#define krp_senddmabufmask1 (KREG_IBPORT_IDX(SendDmaBufMask0) + 1)</span>
<span class="cp">#define krp_senddmabufmask2 (KREG_IBPORT_IDX(SendDmaBufMask0) + 2)</span>
<span class="cp">#define krp_senddmabuf_use0 KREG_IBPORT_IDX(SendDmaBufUsed0)</span>
<span class="cp">#define krp_senddmabuf_use1 (KREG_IBPORT_IDX(SendDmaBufUsed0) + 1)</span>
<span class="cp">#define krp_senddmabuf_use2 (KREG_IBPORT_IDX(SendDmaBufUsed0) + 2)</span>
<span class="cp">#define krp_senddmadesccnt KREG_IBPORT_IDX(SendDmaDescCnt)</span>
<span class="cp">#define krp_senddmahead KREG_IBPORT_IDX(SendDmaHead)</span>
<span class="cp">#define krp_senddmaheadaddr KREG_IBPORT_IDX(SendDmaHeadAddr)</span>
<span class="cp">#define krp_senddmaidlecnt KREG_IBPORT_IDX(SendDmaIdleCnt)</span>
<span class="cp">#define krp_senddmalengen KREG_IBPORT_IDX(SendDmaLenGen)</span>
<span class="cp">#define krp_senddmaprioritythld KREG_IBPORT_IDX(SendDmaPriorityThld)</span>
<span class="cp">#define krp_senddmareloadcnt KREG_IBPORT_IDX(SendDmaReloadCnt)</span>
<span class="cp">#define krp_senddmastatus KREG_IBPORT_IDX(SendDmaStatus)</span>
<span class="cp">#define krp_senddmatail KREG_IBPORT_IDX(SendDmaTail)</span>
<span class="cp">#define krp_sendhdrsymptom KREG_IBPORT_IDX(SendHdrErrSymptom)</span>
<span class="cp">#define krp_sendslid KREG_IBPORT_IDX(SendIBSLIDAssign)</span>
<span class="cp">#define krp_sendslidmask KREG_IBPORT_IDX(SendIBSLIDMask)</span>
<span class="cp">#define krp_ibsdtestiftx KREG_IBPORT_IDX(IB_SDTEST_IF_TX)</span>
<span class="cp">#define krp_adapt_dis_timer KREG_IBPORT_IDX(ADAPT_DISABLE_TIMER_THRESHOLD)</span>
<span class="cp">#define krp_tx_deemph_override KREG_IBPORT_IDX(IBSD_TX_DEEMPHASIS_OVERRIDE)</span>
<span class="cp">#define krp_serdesctrl KREG_IBPORT_IDX(IBSerdesCtrl)</span>

<span class="cm">/*</span>
<span class="cm"> * Per-context kernel registers.  Access only with qib_read_kreg_ctxt()</span>
<span class="cm"> * or qib_write_kreg_ctxt()</span>
<span class="cm"> */</span>
<span class="cp">#define krc_rcvhdraddr KREG_IDX(RcvHdrAddr0)</span>
<span class="cp">#define krc_rcvhdrtailaddr KREG_IDX(RcvHdrTailAddr0)</span>

<span class="cm">/*</span>
<span class="cm"> * TID Flow table, per context.  Reduces</span>
<span class="cm"> * number of hdrq updates to one per flow (or on errors).</span>
<span class="cm"> * context 0 and 1 share same memory, but have distinct</span>
<span class="cm"> * addresses.  Since for now, we never use expected sends</span>
<span class="cm"> * on kernel contexts, we don&#39;t worry about that (we initialize</span>
<span class="cm"> * those entries for ctxt 0/1 on driver load twice, for example).</span>
<span class="cm"> */</span>
<span class="cp">#define NUM_TIDFLOWS_CTXT 0x20 </span><span class="cm">/* 0x20 per context; have to hardcode */</span><span class="cp"></span>
<span class="cp">#define ur_rcvflowtable (KREG_IDX(RcvTIDFlowTable0) - KREG_IDX(RcvHdrTail0))</span>

<span class="cm">/* these are the error bits in the tid flows, and are W1C */</span>
<span class="cp">#define TIDFLOW_ERRBITS  ( \</span>
<span class="cp">	(SYM_MASK(RcvTIDFlowTable0, GenMismatch) &lt;&lt; \</span>
<span class="cp">	SYM_LSB(RcvTIDFlowTable0, GenMismatch)) | \</span>
<span class="cp">	(SYM_MASK(RcvTIDFlowTable0, SeqMismatch) &lt;&lt; \</span>
<span class="cp">	SYM_LSB(RcvTIDFlowTable0, SeqMismatch)))</span>

<span class="cm">/* Most (not all) Counters are per-IBport.</span>
<span class="cm"> * Requires LBIntCnt is at offset 0 in the group</span>
<span class="cm"> */</span>
<span class="cp">#define CREG_IDX(regname) \</span>
<span class="cp">((QIB_7322_##regname##_0_OFFS - QIB_7322_LBIntCnt_OFFS) / sizeof(u64))</span>

<span class="cp">#define crp_badformat CREG_IDX(RxVersionErrCnt)</span>
<span class="cp">#define crp_err_rlen CREG_IDX(RxLenErrCnt)</span>
<span class="cp">#define crp_erricrc CREG_IDX(RxICRCErrCnt)</span>
<span class="cp">#define crp_errlink CREG_IDX(RxLinkMalformCnt)</span>
<span class="cp">#define crp_errlpcrc CREG_IDX(RxLPCRCErrCnt)</span>
<span class="cp">#define crp_errpkey CREG_IDX(RxPKeyMismatchCnt)</span>
<span class="cp">#define crp_errvcrc CREG_IDX(RxVCRCErrCnt)</span>
<span class="cp">#define crp_excessbufferovfl CREG_IDX(ExcessBufferOvflCnt)</span>
<span class="cp">#define crp_iblinkdown CREG_IDX(IBLinkDownedCnt)</span>
<span class="cp">#define crp_iblinkerrrecov CREG_IDX(IBLinkErrRecoveryCnt)</span>
<span class="cp">#define crp_ibstatuschange CREG_IDX(IBStatusChangeCnt)</span>
<span class="cp">#define crp_ibsymbolerr CREG_IDX(IBSymbolErrCnt)</span>
<span class="cp">#define crp_invalidrlen CREG_IDX(RxMaxMinLenErrCnt)</span>
<span class="cp">#define crp_locallinkintegrityerr CREG_IDX(LocalLinkIntegrityErrCnt)</span>
<span class="cp">#define crp_pktrcv CREG_IDX(RxDataPktCnt)</span>
<span class="cp">#define crp_pktrcvflowctrl CREG_IDX(RxFlowPktCnt)</span>
<span class="cp">#define crp_pktsend CREG_IDX(TxDataPktCnt)</span>
<span class="cp">#define crp_pktsendflow CREG_IDX(TxFlowPktCnt)</span>
<span class="cp">#define crp_psrcvdatacount CREG_IDX(PSRcvDataCount)</span>
<span class="cp">#define crp_psrcvpktscount CREG_IDX(PSRcvPktsCount)</span>
<span class="cp">#define crp_psxmitdatacount CREG_IDX(PSXmitDataCount)</span>
<span class="cp">#define crp_psxmitpktscount CREG_IDX(PSXmitPktsCount)</span>
<span class="cp">#define crp_psxmitwaitcount CREG_IDX(PSXmitWaitCount)</span>
<span class="cp">#define crp_rcvebp CREG_IDX(RxEBPCnt)</span>
<span class="cp">#define crp_rcvflowctrlviol CREG_IDX(RxFlowCtrlViolCnt)</span>
<span class="cp">#define crp_rcvovfl CREG_IDX(RxBufOvflCnt)</span>
<span class="cp">#define crp_rxdlidfltr CREG_IDX(RxDlidFltrCnt)</span>
<span class="cp">#define crp_rxdroppkt CREG_IDX(RxDroppedPktCnt)</span>
<span class="cp">#define crp_rxotherlocalphyerr CREG_IDX(RxOtherLocalPhyErrCnt)</span>
<span class="cp">#define crp_rxqpinvalidctxt CREG_IDX(RxQPInvalidContextCnt)</span>
<span class="cp">#define crp_rxvlerr CREG_IDX(RxVlErrCnt)</span>
<span class="cp">#define crp_sendstall CREG_IDX(TxFlowStallCnt)</span>
<span class="cp">#define crp_txdroppedpkt CREG_IDX(TxDroppedPktCnt)</span>
<span class="cp">#define crp_txhdrerr CREG_IDX(TxHeadersErrCnt)</span>
<span class="cp">#define crp_txlenerr CREG_IDX(TxLenErrCnt)</span>
<span class="cp">#define crp_txminmaxlenerr CREG_IDX(TxMaxMinLenErrCnt)</span>
<span class="cp">#define crp_txsdmadesc CREG_IDX(TxSDmaDescCnt)</span>
<span class="cp">#define crp_txunderrun CREG_IDX(TxUnderrunCnt)</span>
<span class="cp">#define crp_txunsupvl CREG_IDX(TxUnsupVLErrCnt)</span>
<span class="cp">#define crp_vl15droppedpkt CREG_IDX(RxVL15DroppedPktCnt)</span>
<span class="cp">#define crp_wordrcv CREG_IDX(RxDwordCnt)</span>
<span class="cp">#define crp_wordsend CREG_IDX(TxDwordCnt)</span>
<span class="cp">#define crp_tx_creditstalls CREG_IDX(TxCreditUpToDateTimeOut)</span>

<span class="cm">/* these are the (few) counters that are not port-specific */</span>
<span class="cp">#define CREG_DEVIDX(regname) ((QIB_7322_##regname##_OFFS - \</span>
<span class="cp">			QIB_7322_LBIntCnt_OFFS) / sizeof(u64))</span>
<span class="cp">#define cr_base_egrovfl CREG_DEVIDX(RxP0HdrEgrOvflCnt)</span>
<span class="cp">#define cr_lbint CREG_DEVIDX(LBIntCnt)</span>
<span class="cp">#define cr_lbstall CREG_DEVIDX(LBFlowStallCnt)</span>
<span class="cp">#define cr_pcieretrydiag CREG_DEVIDX(PcieRetryBufDiagQwordCnt)</span>
<span class="cp">#define cr_rxtidflowdrop CREG_DEVIDX(RxTidFlowDropCnt)</span>
<span class="cp">#define cr_tidfull CREG_DEVIDX(RxTIDFullErrCnt)</span>
<span class="cp">#define cr_tidinvalid CREG_DEVIDX(RxTIDValidErrCnt)</span>

<span class="cm">/* no chip register for # of IB ports supported, so define */</span>
<span class="cp">#define NUM_IB_PORTS 2</span>

<span class="cm">/* 1 VL15 buffer per hardware IB port, no register for this, so define */</span>
<span class="cp">#define NUM_VL15_BUFS NUM_IB_PORTS</span>

<span class="cm">/*</span>
<span class="cm"> * context 0 and 1 are special, and there is no chip register that</span>
<span class="cm"> * defines this value, so we have to define it here.</span>
<span class="cm"> * These are all allocated to either 0 or 1 for single port</span>
<span class="cm"> * hardware configuration, otherwise each gets half</span>
<span class="cm"> */</span>
<span class="cp">#define KCTXT0_EGRCNT 2048</span>

<span class="cm">/* values for vl and port fields in PBC, 7322-specific */</span>
<span class="cp">#define PBC_PORT_SEL_LSB 26</span>
<span class="cp">#define PBC_PORT_SEL_RMASK 1</span>
<span class="cp">#define PBC_VL_NUM_LSB 27</span>
<span class="cp">#define PBC_VL_NUM_RMASK 7</span>
<span class="cp">#define PBC_7322_VL15_SEND (1ULL &lt;&lt; 63) </span><span class="cm">/* pbc; VL15, no credit check */</span><span class="cp"></span>
<span class="cp">#define PBC_7322_VL15_SEND_CTRL (1ULL &lt;&lt; 31) </span><span class="cm">/* control version of same */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">ib_rate_to_delay</span><span class="p">[</span><span class="n">IB_RATE_120_GBPS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IB_RATE_2_5_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_5_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_10_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_20_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_30_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_40_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#define IBA7322_LINKSPEED_SHIFT SYM_LSB(IBCStatusA_0, LinkSpeedActive)</span>
<span class="cp">#define IBA7322_LINKWIDTH_SHIFT SYM_LSB(IBCStatusA_0, LinkWidthActive)</span>

<span class="cm">/* link training states, from IBC */</span>
<span class="cp">#define IB_7322_LT_STATE_DISABLED        0x00</span>
<span class="cp">#define IB_7322_LT_STATE_LINKUP          0x01</span>
<span class="cp">#define IB_7322_LT_STATE_POLLACTIVE      0x02</span>
<span class="cp">#define IB_7322_LT_STATE_POLLQUIET       0x03</span>
<span class="cp">#define IB_7322_LT_STATE_SLEEPDELAY      0x04</span>
<span class="cp">#define IB_7322_LT_STATE_SLEEPQUIET      0x05</span>
<span class="cp">#define IB_7322_LT_STATE_CFGDEBOUNCE     0x08</span>
<span class="cp">#define IB_7322_LT_STATE_CFGRCVFCFG      0x09</span>
<span class="cp">#define IB_7322_LT_STATE_CFGWAITRMT      0x0a</span>
<span class="cp">#define IB_7322_LT_STATE_CFGIDLE         0x0b</span>
<span class="cp">#define IB_7322_LT_STATE_RECOVERRETRAIN  0x0c</span>
<span class="cp">#define IB_7322_LT_STATE_TXREVLANES      0x0d</span>
<span class="cp">#define IB_7322_LT_STATE_RECOVERWAITRMT  0x0e</span>
<span class="cp">#define IB_7322_LT_STATE_RECOVERIDLE     0x0f</span>
<span class="cp">#define IB_7322_LT_STATE_CFGENH          0x10</span>
<span class="cp">#define IB_7322_LT_STATE_CFGTEST         0x11</span>
<span class="cp">#define IB_7322_LT_STATE_CFGWAITRMTTEST  0x12</span>
<span class="cp">#define IB_7322_LT_STATE_CFGWAITENH      0x13</span>

<span class="cm">/* link state machine states from IBC */</span>
<span class="cp">#define IB_7322_L_STATE_DOWN             0x0</span>
<span class="cp">#define IB_7322_L_STATE_INIT             0x1</span>
<span class="cp">#define IB_7322_L_STATE_ARM              0x2</span>
<span class="cp">#define IB_7322_L_STATE_ACTIVE           0x3</span>
<span class="cp">#define IB_7322_L_STATE_ACT_DEFER        0x4</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">qib_7322_physportstate</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_DISABLED</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_DISABLED</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_LINKUP</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_LINKUP</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_POLLACTIVE</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_POLL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_POLLQUIET</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_POLL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_SLEEPDELAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_SLEEP</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_SLEEPQUIET</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_SLEEP</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGDEBOUNCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGRCVFCFG</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGWAITRMT</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGIDLE</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_IDLE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_RECOVERRETRAIN</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_RECOVERWAITRMT</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_RECOVERIDLE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGENH</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_ENH</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGTEST</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGWAITRMTTEST</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7322_LT_STATE_CFGWAITENH</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_CFG_WAIT_ENH</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">qib_chip_specific</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cregbase</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">cntrs</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">rcvmod_lock</span><span class="p">;</span> <span class="cm">/* protect rcvctrl shadow changes */</span>
	<span class="n">spinlock_t</span> <span class="n">gpio_lock</span><span class="p">;</span> <span class="cm">/* RMW of shadows/regs for ExtCtrl and GPIO */</span>
	<span class="n">u64</span> <span class="n">main_int_mask</span><span class="p">;</span>      <span class="cm">/* clear bits which have dedicated handlers */</span>
	<span class="n">u64</span> <span class="n">int_enable_mask</span><span class="p">;</span>  <span class="cm">/* for per port interrupts in single port mode */</span>
	<span class="n">u64</span> <span class="n">errormask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hwerrmask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">gpio_out</span><span class="p">;</span> <span class="cm">/* shadow of kr_gpio_out, for rmw ops */</span>
	<span class="n">u64</span> <span class="n">gpio_mask</span><span class="p">;</span> <span class="cm">/* shadow the gpio mask register */</span>
	<span class="n">u64</span> <span class="n">extctrl</span><span class="p">;</span> <span class="cm">/* shadow the gpio output enable, etc... */</span>
	<span class="n">u32</span> <span class="n">ncntrs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nportcntrs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cntrnamelen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">portcntrnamelen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">numctxts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcvegrcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">updthresh</span><span class="p">;</span> <span class="cm">/* current AvailUpdThld */</span>
	<span class="n">u32</span> <span class="n">updthresh_dflt</span><span class="p">;</span> <span class="cm">/* default AvailUpdThld */</span>
	<span class="n">u32</span> <span class="n">r1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_msix_entries</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sdmabufcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lastbuf_for_pio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stay_in_freeze</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recovery_ports_initted</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_msix_entry</span> <span class="o">*</span><span class="n">msix_entries</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sendchkenable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sendgrhchk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sendibchk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcvavail_timeout</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">emsgbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span> <span class="cm">/* for device error interrupt msg buffer */</span>
<span class="p">};</span>

<span class="cm">/* Table of entries in &quot;human readable&quot; form Tx Emphasis. */</span>
<span class="k">struct</span> <span class="n">txdds_ent</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">amp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pre</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">main</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">post</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vendor_txdds_ent</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">oui</span><span class="p">[</span><span class="n">QSFP_VOUI_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">partnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">sdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">ddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">qdr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">write_tx_serdes_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#define TXDDS_TABLE_SZ 16 </span><span class="cm">/* number of entries per speed in onchip table */</span><span class="cp"></span>
<span class="cp">#define TXDDS_EXTRA_SZ 13 </span><span class="cm">/* number of extra tx settings entries */</span><span class="cp"></span>
<span class="cp">#define TXDDS_MFG_SZ 2    </span><span class="cm">/* number of mfg tx settings entries */</span><span class="cp"></span>
<span class="cp">#define SERDES_CHANS 4 </span><span class="cm">/* yes, it&#39;s obvious, but one less magic number */</span><span class="cp"></span>

<span class="cp">#define H1_FORCE_VAL 8</span>
<span class="cp">#define H1_FORCE_QME 1 </span><span class="cm">/*  may be overridden via setup_txselect() */</span><span class="cp"></span>
<span class="cp">#define H1_FORCE_QMH 7 </span><span class="cm">/*  may be overridden via setup_txselect() */</span><span class="cp"></span>

<span class="cm">/* The static and dynamic registers are paired, and the pairs indexed by spd */</span>
<span class="cp">#define krp_static_adapt_dis(spd) (KREG_IBPORT_IDX(ADAPT_DISABLE_STATIC_SDR) \</span>
<span class="cp">	+ ((spd) * 2))</span>

<span class="cp">#define QDR_DFE_DISABLE_DELAY 4000 </span><span class="cm">/* msec after LINKUP */</span><span class="cp"></span>
<span class="cp">#define QDR_STATIC_ADAPT_DOWN 0xf0f0f0f0ULL </span><span class="cm">/* link down, H1-H4 QDR adapts */</span><span class="cp"></span>
<span class="cp">#define QDR_STATIC_ADAPT_DOWN_R1 0ULL </span><span class="cm">/* r1 link down, H1-H4 QDR adapts */</span><span class="cp"></span>
<span class="cp">#define QDR_STATIC_ADAPT_INIT 0xffffffffffULL </span><span class="cm">/* up, disable H0,H1-8, LE */</span><span class="cp"></span>
<span class="cp">#define QDR_STATIC_ADAPT_INIT_R1 0xf0ffffffffULL </span><span class="cm">/* r1 up, disable H0,H1-8 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">qib_chippport_specific</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">kpregbase</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cpregbase</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">portcntrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">autoneg_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">autoneg_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">ipg_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">chase_timer</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * these 5 fields are used to establish deltas for IB symbol</span>
<span class="cm">	 * errors and linkrecovery errors.  They can be reported on</span>
<span class="cm">	 * some chips during link negotiation prior to INIT, and with</span>
<span class="cm">	 * DDR when faking DDR negotiations with non-IBTA switches.</span>
<span class="cm">	 * The chip counters are adjusted at driver unload if there is</span>
<span class="cm">	 * a non-zero delta.</span>
<span class="cm">	 */</span>
	<span class="n">u64</span> <span class="n">ibdeltainprog</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ibsymdelta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ibsymsnap</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iblnkerrdelta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iblnkerrsnap</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iblnkdownsnap</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iblnkdowndelta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ibmalfdelta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ibmalfsnap</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ibcctrl_a</span><span class="p">;</span> <span class="cm">/* krp_ibcctrl_a shadow */</span>
	<span class="n">u64</span> <span class="n">ibcctrl_b</span><span class="p">;</span> <span class="cm">/* krp_ibcctrl_b shadow */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">qdr_dfe_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chase_end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">autoneg_tries</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recovery_init</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qdr_dfe_on</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qdr_reforce</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Per-bay per-channel rcv QMH H1 values and Tx values for QDR.</span>
<span class="cm">	 * entry zero is unused, to simplify indexing</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">h1_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">no_eep</span><span class="p">;</span>  <span class="cm">/* txselect table index to use if no qsfp info */</span>
	<span class="n">u8</span> <span class="n">ipg_tries</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ibmalfusesnap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_qsfp_data</span> <span class="n">qsfp_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">epmsgbuf</span><span class="p">[</span><span class="mi">192</span><span class="p">];</span> <span class="cm">/* for port error interrupt msg buffer */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span> <span class="cm">/* 0 if not port-specific, else port # */</span>
<span class="p">}</span> <span class="n">irq_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">qib_7322intr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (buf avail)&quot;</span><span class="p">,</span> <span class="n">qib_7322bufavail</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SendBufAvail</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdma 0)&quot;</span><span class="p">,</span> <span class="n">sdma_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaInt_0</span><span class="p">),</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdma 1)&quot;</span><span class="p">,</span> <span class="n">sdma_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaInt_1</span><span class="p">),</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdmaI 0)&quot;</span><span class="p">,</span> <span class="n">sdma_idle_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaIdleInt_0</span><span class="p">),</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdmaI 1)&quot;</span><span class="p">,</span> <span class="n">sdma_idle_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaIdleInt_1</span><span class="p">),</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdmaP 0)&quot;</span><span class="p">,</span> <span class="n">sdma_progress_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaProgressInt_0</span><span class="p">),</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdmaP 1)&quot;</span><span class="p">,</span> <span class="n">sdma_progress_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaProgressInt_1</span><span class="p">),</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdmaC 0)&quot;</span><span class="p">,</span> <span class="n">sdma_cleanup_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaCleanupDone_0</span><span class="p">),</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot; (sdmaC 1)&quot;</span><span class="p">,</span> <span class="n">sdma_cleanup_intr</span><span class="p">,</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">SDmaCleanupDone_1</span><span class="p">),</span> <span class="mi">2</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ibcctrl bits */</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_DISABLE 1</span>
<span class="cm">/* cycle through TS1/TS2 till OK */</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_POLL 2</span>
<span class="cm">/* wait for TS1, then go on */</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_SLEEP 3</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_SHIFT 16</span>

<span class="cp">#define QLOGIC_IB_IBCC_LINKCMD_DOWN 1           </span><span class="cm">/* move to 0x11 */</span><span class="cp"></span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKCMD_ARMED 2          </span><span class="cm">/* move to 0x21 */</span><span class="cp"></span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKCMD_ACTIVE 3 </span><span class="cm">/* move to 0x31 */</span><span class="cp"></span>

<span class="cp">#define BLOB_7322_IBCHG 0x101</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">qib_write_kreg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u32</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">write_7322_initregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">write_7322_init_portregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setup_7322_link_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">check_7322_rxe_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">qib_7322_getsendbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qib_read_ureg32 - read 32-bit virtualized per-context register</span>
<span class="cm"> * @dd: device</span>
<span class="cm"> * @regno: register number</span>
<span class="cm"> * @ctxt: context number</span>
<span class="cm"> *</span>
<span class="cm"> * Return the contents of a register that is virtualized to be per context.</span>
<span class="cm"> * Returns -1 on errors (not distinguishable from valid contents at</span>
<span class="cm"> * runtime; we may add a separate error variable at some point).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">qib_read_ureg32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">qib_ureg</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">regno</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span>
		<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span> <span class="o">?</span>
		 <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span> <span class="o">:</span>
		 <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">uregbase</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_read_ureg - read virtualized per-context register</span>
<span class="cm"> * @dd: device</span>
<span class="cm"> * @regno: register number</span>
<span class="cm"> * @ctxt: context number</span>
<span class="cm"> *</span>
<span class="cm"> * Return the contents of a register that is virtualized to be per context.</span>
<span class="cm"> * Returns -1 on errors (not distinguishable from valid contents at</span>
<span class="cm"> * runtime; we may add a separate error variable at some point).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">qib_read_ureg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">qib_ureg</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readq</span><span class="p">(</span><span class="n">regno</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span>
		<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span> <span class="o">?</span>
		 <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span> <span class="o">:</span>
		 <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">uregbase</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_write_ureg - write virtualized per-context register</span>
<span class="cm"> * @dd: device</span>
<span class="cm"> * @regno: register number</span>
<span class="cm"> * @value: value</span>
<span class="cm"> * @ctxt: context</span>
<span class="cm"> *</span>
<span class="cm"> * Write the contents of a register that is virtualized to be per context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qib_write_ureg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">qib_ureg</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ubase</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span><span class="p">)</span>
		<span class="n">ubase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span> <span class="o">+</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ubase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">uregbase</span> <span class="o">+</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">qib_read_kreg32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u32</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">qib_read_kreg64</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u32</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qib_write_kreg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u32</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * not many sanity checks for the port-specific kernel register routines,</span>
<span class="cm"> * since they are only used when it&#39;s known to be safe.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">qib_read_kreg_port</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qib_write_kreg_port</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span> <span class="o">&amp;&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span> <span class="o">&amp;&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_write_kreg_ctxt - write a device&#39;s per-ctxt 64-bit kernel register</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @regno: the register number to write</span>
<span class="cm"> * @ctxt: the context containing the register</span>
<span class="cm"> * @value: the value to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qib_write_kreg_ctxt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ctxt</span><span class="p">,</span>
				       <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">regno</span> <span class="o">+</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">read_7322_creg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>


<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">read_7322_creg32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>


<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_7322_creg_port</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span> <span class="o">&amp;&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">read_7322_creg_port</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span> <span class="o">||</span> <span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">read_7322_creg32_port</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span> <span class="o">||</span> <span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* bits in Control register */</span>
<span class="cp">#define QLOGIC_IB_C_RESET SYM_MASK(Control, SyncReset)</span>
<span class="cp">#define QLOGIC_IB_C_SDMAFETCHPRIOEN SYM_MASK(Control, SDmaDescFetchPriorityEn)</span>

<span class="cm">/* bits in general interrupt regs */</span>
<span class="cp">#define QIB_I_RCVURG_LSB SYM_LSB(IntMask, RcvUrg0IntMask)</span>
<span class="cp">#define QIB_I_RCVURG_RMASK MASK_ACROSS(0, 17)</span>
<span class="cp">#define QIB_I_RCVURG_MASK (QIB_I_RCVURG_RMASK &lt;&lt; QIB_I_RCVURG_LSB)</span>
<span class="cp">#define QIB_I_RCVAVAIL_LSB SYM_LSB(IntMask, RcvAvail0IntMask)</span>
<span class="cp">#define QIB_I_RCVAVAIL_RMASK MASK_ACROSS(0, 17)</span>
<span class="cp">#define QIB_I_RCVAVAIL_MASK (QIB_I_RCVAVAIL_RMASK &lt;&lt; QIB_I_RCVAVAIL_LSB)</span>
<span class="cp">#define QIB_I_C_ERROR INT_MASK(Err)</span>

<span class="cp">#define QIB_I_SPIOSENT (INT_MASK_P(SendDone, 0) | INT_MASK_P(SendDone, 1))</span>
<span class="cp">#define QIB_I_SPIOBUFAVAIL INT_MASK(SendBufAvail)</span>
<span class="cp">#define QIB_I_GPIO INT_MASK(AssertGPIO)</span>
<span class="cp">#define QIB_I_P_SDMAINT(pidx) \</span>
<span class="cp">	(INT_MASK_P(SDma, pidx) | INT_MASK_P(SDmaIdle, pidx) | \</span>
<span class="cp">	 INT_MASK_P(SDmaProgress, pidx) | \</span>
<span class="cp">	 INT_MASK_PM(SDmaCleanupDone, pidx))</span>

<span class="cm">/* Interrupt bits that are &quot;per port&quot; */</span>
<span class="cp">#define QIB_I_P_BITSEXTANT(pidx) \</span>
<span class="cp">	(INT_MASK_P(Err, pidx) | INT_MASK_P(SendDone, pidx) | \</span>
<span class="cp">	INT_MASK_P(SDma, pidx) | INT_MASK_P(SDmaIdle, pidx) | \</span>
<span class="cp">	INT_MASK_P(SDmaProgress, pidx) | \</span>
<span class="cp">	INT_MASK_PM(SDmaCleanupDone, pidx))</span>

<span class="cm">/* Interrupt bits that are common to a device */</span>
<span class="cm">/* currently unused: QIB_I_SPIOSENT */</span>
<span class="cp">#define QIB_I_C_BITSEXTANT \</span>
<span class="cp">	(QIB_I_RCVURG_MASK | QIB_I_RCVAVAIL_MASK | \</span>
<span class="cp">	QIB_I_SPIOSENT | \</span>
<span class="cp">	QIB_I_C_ERROR | QIB_I_SPIOBUFAVAIL | QIB_I_GPIO)</span>

<span class="cp">#define QIB_I_BITSEXTANT (QIB_I_C_BITSEXTANT | \</span>
<span class="cp">	QIB_I_P_BITSEXTANT(0) | QIB_I_P_BITSEXTANT(1))</span>

<span class="cm">/*</span>
<span class="cm"> * Error bits that are &quot;per port&quot;.</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_P_IBSTATUSCHANGED ERR_MASK_N(IBStatusChanged)</span>
<span class="cp">#define QIB_E_P_SHDR ERR_MASK_N(SHeadersErr)</span>
<span class="cp">#define QIB_E_P_VL15_BUF_MISUSE ERR_MASK_N(VL15BufMisuseErr)</span>
<span class="cp">#define QIB_E_P_SND_BUF_MISUSE ERR_MASK_N(SendBufMisuseErr)</span>
<span class="cp">#define QIB_E_P_SUNSUPVL ERR_MASK_N(SendUnsupportedVLErr)</span>
<span class="cp">#define QIB_E_P_SUNEXP_PKTNUM ERR_MASK_N(SendUnexpectedPktNumErr)</span>
<span class="cp">#define QIB_E_P_SDROP_DATA ERR_MASK_N(SendDroppedDataPktErr)</span>
<span class="cp">#define QIB_E_P_SDROP_SMP ERR_MASK_N(SendDroppedSmpPktErr)</span>
<span class="cp">#define QIB_E_P_SPKTLEN ERR_MASK_N(SendPktLenErr)</span>
<span class="cp">#define QIB_E_P_SUNDERRUN ERR_MASK_N(SendUnderRunErr)</span>
<span class="cp">#define QIB_E_P_SMAXPKTLEN ERR_MASK_N(SendMaxPktLenErr)</span>
<span class="cp">#define QIB_E_P_SMINPKTLEN ERR_MASK_N(SendMinPktLenErr)</span>
<span class="cp">#define QIB_E_P_RIBLOSTLINK ERR_MASK_N(RcvIBLostLinkErr)</span>
<span class="cp">#define QIB_E_P_RHDR ERR_MASK_N(RcvHdrErr)</span>
<span class="cp">#define QIB_E_P_RHDRLEN ERR_MASK_N(RcvHdrLenErr)</span>
<span class="cp">#define QIB_E_P_RBADTID ERR_MASK_N(RcvBadTidErr)</span>
<span class="cp">#define QIB_E_P_RBADVERSION ERR_MASK_N(RcvBadVersionErr)</span>
<span class="cp">#define QIB_E_P_RIBFLOW ERR_MASK_N(RcvIBFlowErr)</span>
<span class="cp">#define QIB_E_P_REBP ERR_MASK_N(RcvEBPErr)</span>
<span class="cp">#define QIB_E_P_RUNSUPVL ERR_MASK_N(RcvUnsupportedVLErr)</span>
<span class="cp">#define QIB_E_P_RUNEXPCHAR ERR_MASK_N(RcvUnexpectedCharErr)</span>
<span class="cp">#define QIB_E_P_RSHORTPKTLEN ERR_MASK_N(RcvShortPktLenErr)</span>
<span class="cp">#define QIB_E_P_RLONGPKTLEN ERR_MASK_N(RcvLongPktLenErr)</span>
<span class="cp">#define QIB_E_P_RMAXPKTLEN ERR_MASK_N(RcvMaxPktLenErr)</span>
<span class="cp">#define QIB_E_P_RMINPKTLEN ERR_MASK_N(RcvMinPktLenErr)</span>
<span class="cp">#define QIB_E_P_RICRC ERR_MASK_N(RcvICRCErr)</span>
<span class="cp">#define QIB_E_P_RVCRC ERR_MASK_N(RcvVCRCErr)</span>
<span class="cp">#define QIB_E_P_RFORMATERR ERR_MASK_N(RcvFormatErr)</span>

<span class="cp">#define QIB_E_P_SDMA1STDESC ERR_MASK_N(SDma1stDescErr)</span>
<span class="cp">#define QIB_E_P_SDMABASE ERR_MASK_N(SDmaBaseErr)</span>
<span class="cp">#define QIB_E_P_SDMADESCADDRMISALIGN ERR_MASK_N(SDmaDescAddrMisalignErr)</span>
<span class="cp">#define QIB_E_P_SDMADWEN ERR_MASK_N(SDmaDwEnErr)</span>
<span class="cp">#define QIB_E_P_SDMAGENMISMATCH ERR_MASK_N(SDmaGenMismatchErr)</span>
<span class="cp">#define QIB_E_P_SDMAHALT ERR_MASK_N(SDmaHaltErr)</span>
<span class="cp">#define QIB_E_P_SDMAMISSINGDW ERR_MASK_N(SDmaMissingDwErr)</span>
<span class="cp">#define QIB_E_P_SDMAOUTOFBOUND ERR_MASK_N(SDmaOutOfBoundErr)</span>
<span class="cp">#define QIB_E_P_SDMARPYTAG ERR_MASK_N(SDmaRpyTagErr)</span>
<span class="cp">#define QIB_E_P_SDMATAILOUTOFBOUND ERR_MASK_N(SDmaTailOutOfBoundErr)</span>
<span class="cp">#define QIB_E_P_SDMAUNEXPDATA ERR_MASK_N(SDmaUnexpDataErr)</span>

<span class="cm">/* Error bits that are common to a device */</span>
<span class="cp">#define QIB_E_RESET ERR_MASK(ResetNegated)</span>
<span class="cp">#define QIB_E_HARDWARE ERR_MASK(HardwareErr)</span>
<span class="cp">#define QIB_E_INVALIDADDR ERR_MASK(InvalidAddrErr)</span>


<span class="cm">/*</span>
<span class="cm"> * Per chip (rather than per-port) errors.  Most either do</span>
<span class="cm"> * nothing but trigger a print (because they self-recover, or</span>
<span class="cm"> * always occur in tandem with other errors that handle the</span>
<span class="cm"> * issue), or because they indicate errors with no recovery,</span>
<span class="cm"> * but we want to know that they happened.</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_SBUF_VL15_MISUSE ERR_MASK(SBufVL15MisUseErr)</span>
<span class="cp">#define QIB_E_BADEEP ERR_MASK(InvalidEEPCmd)</span>
<span class="cp">#define QIB_E_VLMISMATCH ERR_MASK(SendVLMismatchErr)</span>
<span class="cp">#define QIB_E_ARMLAUNCH ERR_MASK(SendArmLaunchErr)</span>
<span class="cp">#define QIB_E_SPCLTRIG ERR_MASK(SendSpecialTriggerErr)</span>
<span class="cp">#define QIB_E_RRCVHDRFULL ERR_MASK(RcvHdrFullErr)</span>
<span class="cp">#define QIB_E_RRCVEGRFULL ERR_MASK(RcvEgrFullErr)</span>
<span class="cp">#define QIB_E_RCVCTXTSHARE ERR_MASK(RcvContextShareErr)</span>

<span class="cm">/* SDMA chip errors (not per port)</span>
<span class="cm"> * QIB_E_SDMA_BUF_DUP needs no special handling, because we will also get</span>
<span class="cm"> * the SDMAHALT error immediately, so we just print the dup error via the</span>
<span class="cm"> * E_AUTO mechanism.  This is true of most of the per-port fatal errors</span>
<span class="cm"> * as well, but since this is port-independent, by definition, it&#39;s</span>
<span class="cm"> * handled a bit differently.  SDMA_VL15 and SDMA_WRONG_PORT are per</span>
<span class="cm"> * packet send errors, and so are handled in the same manner as other</span>
<span class="cm"> * per-packet errors.</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_SDMA_VL15 ERR_MASK(SDmaVL15Err)</span>
<span class="cp">#define QIB_E_SDMA_WRONG_PORT ERR_MASK(SDmaWrongPortErr)</span>
<span class="cp">#define QIB_E_SDMA_BUF_DUP ERR_MASK(SDmaBufMaskDuplicateErr)</span>

<span class="cm">/*</span>
<span class="cm"> * Below functionally equivalent to legacy QLOGIC_IB_E_PKTERRS</span>
<span class="cm"> * it is used to print &quot;common&quot; packet errors.</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_P_PKTERRS (QIB_E_P_SPKTLEN |\</span>
<span class="cp">	QIB_E_P_SDROP_DATA | QIB_E_P_RVCRC |\</span>
<span class="cp">	QIB_E_P_RICRC | QIB_E_P_RSHORTPKTLEN |\</span>
<span class="cp">	QIB_E_P_VL15_BUF_MISUSE | QIB_E_P_SHDR | \</span>
<span class="cp">	QIB_E_P_REBP)</span>

<span class="cm">/* Error Bits that Packet-related (Receive, per-port) */</span>
<span class="cp">#define QIB_E_P_RPKTERRS (\</span>
<span class="cp">	QIB_E_P_RHDRLEN | QIB_E_P_RBADTID | \</span>
<span class="cp">	QIB_E_P_RBADVERSION | QIB_E_P_RHDR | \</span>
<span class="cp">	QIB_E_P_RLONGPKTLEN | QIB_E_P_RSHORTPKTLEN |\</span>
<span class="cp">	QIB_E_P_RMAXPKTLEN | QIB_E_P_RMINPKTLEN | \</span>
<span class="cp">	QIB_E_P_RFORMATERR | QIB_E_P_RUNSUPVL | \</span>
<span class="cp">	QIB_E_P_RUNEXPCHAR | QIB_E_P_RIBFLOW | QIB_E_P_REBP)</span>

<span class="cm">/*</span>
<span class="cm"> * Error bits that are Send-related (per port)</span>
<span class="cm"> * (ARMLAUNCH excluded from E_SPKTERRS because it gets special handling).</span>
<span class="cm"> * All of these potentially need to have a buffer disarmed</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_P_SPKTERRS (\</span>
<span class="cp">	QIB_E_P_SUNEXP_PKTNUM |\</span>
<span class="cp">	QIB_E_P_SDROP_DATA | QIB_E_P_SDROP_SMP |\</span>
<span class="cp">	QIB_E_P_SMAXPKTLEN |\</span>
<span class="cp">	QIB_E_P_VL15_BUF_MISUSE | QIB_E_P_SHDR | \</span>
<span class="cp">	QIB_E_P_SMINPKTLEN | QIB_E_P_SPKTLEN | \</span>
<span class="cp">	QIB_E_P_SND_BUF_MISUSE | QIB_E_P_SUNSUPVL)</span>

<span class="cp">#define QIB_E_SPKTERRS ( \</span>
<span class="cp">		QIB_E_SBUF_VL15_MISUSE | QIB_E_VLMISMATCH | \</span>
<span class="cp">		ERR_MASK_N(SendUnsupportedVLErr) |			\</span>
<span class="cp">		QIB_E_SPCLTRIG | QIB_E_SDMA_VL15 | QIB_E_SDMA_WRONG_PORT)</span>

<span class="cp">#define QIB_E_P_SDMAERRS ( \</span>
<span class="cp">	QIB_E_P_SDMAHALT | \</span>
<span class="cp">	QIB_E_P_SDMADESCADDRMISALIGN | \</span>
<span class="cp">	QIB_E_P_SDMAUNEXPDATA | \</span>
<span class="cp">	QIB_E_P_SDMAMISSINGDW | \</span>
<span class="cp">	QIB_E_P_SDMADWEN | \</span>
<span class="cp">	QIB_E_P_SDMARPYTAG | \</span>
<span class="cp">	QIB_E_P_SDMA1STDESC | \</span>
<span class="cp">	QIB_E_P_SDMABASE | \</span>
<span class="cp">	QIB_E_P_SDMATAILOUTOFBOUND | \</span>
<span class="cp">	QIB_E_P_SDMAOUTOFBOUND | \</span>
<span class="cp">	QIB_E_P_SDMAGENMISMATCH)</span>

<span class="cm">/*</span>
<span class="cm"> * This sets some bits more than once, but makes it more obvious which</span>
<span class="cm"> * bits are not handled under other categories, and the repeat definition</span>
<span class="cm"> * is not a problem.</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_P_BITSEXTANT ( \</span>
<span class="cp">	QIB_E_P_SPKTERRS | QIB_E_P_PKTERRS | QIB_E_P_RPKTERRS | \</span>
<span class="cp">	QIB_E_P_RIBLOSTLINK | QIB_E_P_IBSTATUSCHANGED | \</span>
<span class="cp">	QIB_E_P_SND_BUF_MISUSE | QIB_E_P_SUNDERRUN | \</span>
<span class="cp">	QIB_E_P_SHDR | QIB_E_P_VL15_BUF_MISUSE | QIB_E_P_SDMAERRS \</span>
<span class="cp">	)</span>

<span class="cm">/*</span>
<span class="cm"> * These are errors that can occur when the link</span>
<span class="cm"> * changes state while a packet is being sent or received.  This doesn&#39;t</span>
<span class="cm"> * cover things like EBP or VCRC that can be the result of a sending</span>
<span class="cm"> * having the link change state, so we receive a &quot;known bad&quot; packet.</span>
<span class="cm"> * All of these are &quot;per port&quot;, so renamed:</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_P_LINK_PKTERRS (\</span>
<span class="cp">	QIB_E_P_SDROP_DATA | QIB_E_P_SDROP_SMP |\</span>
<span class="cp">	QIB_E_P_SMINPKTLEN | QIB_E_P_SPKTLEN |\</span>
<span class="cp">	QIB_E_P_RSHORTPKTLEN | QIB_E_P_RMINPKTLEN |\</span>
<span class="cp">	QIB_E_P_RUNEXPCHAR)</span>

<span class="cm">/*</span>
<span class="cm"> * This sets some bits more than once, but makes it more obvious which</span>
<span class="cm"> * bits are not handled under other categories (such as QIB_E_SPKTERRS),</span>
<span class="cm"> * and the repeat definition is not a problem.</span>
<span class="cm"> */</span>
<span class="cp">#define QIB_E_C_BITSEXTANT (\</span>
<span class="cp">	QIB_E_HARDWARE | QIB_E_INVALIDADDR | QIB_E_BADEEP |\</span>
<span class="cp">	QIB_E_ARMLAUNCH | QIB_E_VLMISMATCH | QIB_E_RRCVHDRFULL |\</span>
<span class="cp">	QIB_E_RRCVEGRFULL | QIB_E_RESET | QIB_E_SBUF_VL15_MISUSE)</span>

<span class="cm">/* Likewise Neuter E_SPKT_ERRS_IGNORE */</span>
<span class="cp">#define E_SPKT_ERRS_IGNORE 0</span>

<span class="cp">#define QIB_EXTS_MEMBIST_DISABLED \</span>
<span class="cp">	SYM_MASK(EXTStatus, MemBISTDisabled)</span>
<span class="cp">#define QIB_EXTS_MEMBIST_ENDTEST \</span>
<span class="cp">	SYM_MASK(EXTStatus, MemBISTEndTest)</span>

<span class="cp">#define QIB_E_SPIOARMLAUNCH \</span>
<span class="cp">	ERR_MASK(SendArmLaunchErr)</span>

<span class="cp">#define IBA7322_IBCC_LINKINITCMD_MASK SYM_RMASK(IBCCtrlA_0, LinkInitCmd)</span>
<span class="cp">#define IBA7322_IBCC_LINKCMD_SHIFT SYM_LSB(IBCCtrlA_0, LinkCmd)</span>

<span class="cm">/*</span>
<span class="cm"> * IBTA_1_2 is set when multiple speeds are enabled (normal),</span>
<span class="cm"> * and also if forced QDR (only QDR enabled).  It&#39;s enabled for the</span>
<span class="cm"> * forced QDR case so that scrambling will be enabled by the TS3</span>
<span class="cm"> * exchange, when supported by both sides of the link.</span>
<span class="cm"> */</span>
<span class="cp">#define IBA7322_IBC_IBTA_1_2_MASK SYM_MASK(IBCCtrlB_0, IB_ENHANCED_MODE)</span>
<span class="cp">#define IBA7322_IBC_MAX_SPEED_MASK SYM_MASK(IBCCtrlB_0, SD_SPEED)</span>
<span class="cp">#define IBA7322_IBC_SPEED_QDR SYM_MASK(IBCCtrlB_0, SD_SPEED_QDR)</span>
<span class="cp">#define IBA7322_IBC_SPEED_DDR SYM_MASK(IBCCtrlB_0, SD_SPEED_DDR)</span>
<span class="cp">#define IBA7322_IBC_SPEED_SDR SYM_MASK(IBCCtrlB_0, SD_SPEED_SDR)</span>
<span class="cp">#define IBA7322_IBC_SPEED_MASK (SYM_MASK(IBCCtrlB_0, SD_SPEED_SDR) | \</span>
<span class="cp">	SYM_MASK(IBCCtrlB_0, SD_SPEED_DDR) | SYM_MASK(IBCCtrlB_0, SD_SPEED_QDR))</span>
<span class="cp">#define IBA7322_IBC_SPEED_LSB SYM_LSB(IBCCtrlB_0, SD_SPEED_SDR)</span>

<span class="cp">#define IBA7322_LEDBLINK_OFF_SHIFT SYM_LSB(RcvPktLEDCnt_0, OFFperiod)</span>
<span class="cp">#define IBA7322_LEDBLINK_ON_SHIFT SYM_LSB(RcvPktLEDCnt_0, ONperiod)</span>

<span class="cp">#define IBA7322_IBC_WIDTH_AUTONEG SYM_MASK(IBCCtrlB_0, IB_NUM_CHANNELS)</span>
<span class="cp">#define IBA7322_IBC_WIDTH_4X_ONLY (1&lt;&lt;SYM_LSB(IBCCtrlB_0, IB_NUM_CHANNELS))</span>
<span class="cp">#define IBA7322_IBC_WIDTH_1X_ONLY (0&lt;&lt;SYM_LSB(IBCCtrlB_0, IB_NUM_CHANNELS))</span>

<span class="cp">#define IBA7322_IBC_RXPOL_MASK SYM_MASK(IBCCtrlB_0, IB_POLARITY_REV_SUPP)</span>
<span class="cp">#define IBA7322_IBC_RXPOL_LSB SYM_LSB(IBCCtrlB_0, IB_POLARITY_REV_SUPP)</span>
<span class="cp">#define IBA7322_IBC_HRTBT_MASK (SYM_MASK(IBCCtrlB_0, HRTBT_AUTO) | \</span>
<span class="cp">	SYM_MASK(IBCCtrlB_0, HRTBT_ENB))</span>
<span class="cp">#define IBA7322_IBC_HRTBT_RMASK (IBA7322_IBC_HRTBT_MASK &gt;&gt; \</span>
<span class="cp">	SYM_LSB(IBCCtrlB_0, HRTBT_ENB))</span>
<span class="cp">#define IBA7322_IBC_HRTBT_LSB SYM_LSB(IBCCtrlB_0, HRTBT_ENB)</span>

<span class="cp">#define IBA7322_REDIRECT_VEC_PER_REG 12</span>

<span class="cp">#define IBA7322_SENDCHK_PKEY SYM_MASK(SendCheckControl_0, PKey_En)</span>
<span class="cp">#define IBA7322_SENDCHK_BTHQP SYM_MASK(SendCheckControl_0, BTHQP_En)</span>
<span class="cp">#define IBA7322_SENDCHK_SLID SYM_MASK(SendCheckControl_0, SLID_En)</span>
<span class="cp">#define IBA7322_SENDCHK_RAW_IPV6 SYM_MASK(SendCheckControl_0, RawIPV6_En)</span>
<span class="cp">#define IBA7322_SENDCHK_MINSZ SYM_MASK(SendCheckControl_0, PacketTooSmall_En)</span>

<span class="cp">#define AUTONEG_TRIES 3 </span><span class="cm">/* sequential retries to negotiate DDR */</span><span class="cp"></span>

<span class="cp">#define HWE_AUTO(fldname) { .mask = SYM_MASK(HwErrMask, fldname##Mask), \</span>
<span class="cp">	.msg = #fldname , .sz = sizeof(#fldname) }</span>
<span class="cp">#define HWE_AUTO_P(fldname, port) { .mask = SYM_MASK(HwErrMask, \</span>
<span class="cp">	fldname##Mask##_##port), .msg = #fldname , .sz = sizeof(#fldname) }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qib_hwerror_msgs</span> <span class="n">qib_7322_hwerror_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HWE_AUTO_P</span><span class="p">(</span><span class="n">IBSerdesPClkNotDetect</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HWE_AUTO_P</span><span class="p">(</span><span class="n">IBSerdesPClkNotDetect</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">PCIESerdesPClkNotDetect</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">TempsenseTholdReached</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">MemoryErr</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">PCIeBusParityErr</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">PcieCplTimeout</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">PciePoisonedTLP</span><span class="p">),</span>
	<span class="n">HWE_AUTO_P</span><span class="p">(</span><span class="n">SDmaMemReadErr</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HWE_AUTO_P</span><span class="p">(</span><span class="n">SDmaMemReadErr</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HWE_AUTO_P</span><span class="p">(</span><span class="n">IBCBusFromSPCParityErr</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HWE_AUTO_P</span><span class="p">(</span><span class="n">IBCBusToSPCParityErr</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HWE_AUTO_P</span><span class="p">(</span><span class="n">IBCBusFromSPCParityErr</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">statusValidNoEop</span><span class="p">),</span>
	<span class="n">HWE_AUTO</span><span class="p">(</span><span class="n">LATriggered</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define E_AUTO(fldname) { .mask = SYM_MASK(ErrMask, fldname##Mask), \</span>
<span class="cp">	.msg = #fldname, .sz = sizeof(#fldname) }</span>
<span class="cp">#define E_P_AUTO(fldname) { .mask = SYM_MASK(ErrMask_0, fldname##Mask), \</span>
<span class="cp">	.msg = #fldname, .sz = sizeof(#fldname) }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qib_hwerror_msgs</span> <span class="n">qib_7322error_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">RcvEgrFullErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">RcvHdrFullErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">ResetNegated</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">HardwareErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">InvalidAddrErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">SDmaVL15Err</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">SBufVL15MisUseErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">InvalidEEPCmd</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">RcvContextShareErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">SendVLMismatchErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">SendArmLaunchErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">SendSpecialTriggerErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">SDmaWrongPortErr</span><span class="p">),</span>
	<span class="n">E_AUTO</span><span class="p">(</span><span class="n">SDmaBufMaskDuplicateErr</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span>  <span class="n">qib_hwerror_msgs</span> <span class="n">qib_7322p_error_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">IBStatusChanged</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SHeadersErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">VL15BufMisuseErr</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * SDmaHaltErr is not really an error, make it clearer;</span>
<span class="cm">	 */</span>
	<span class="p">{.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">ErrMask_0</span><span class="p">,</span> <span class="n">SDmaHaltErrMask</span><span class="p">),</span> <span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;SDmaHalted&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">11</span><span class="p">},</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaDescAddrMisalignErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaUnexpDataErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaMissingDwErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaDwEnErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaRpyTagErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDma1stDescErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaBaseErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaTailOutOfBoundErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaOutOfBoundErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SDmaGenMismatchErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendBufMisuseErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendUnsupportedVLErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendUnexpectedPktNumErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendDroppedDataPktErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendDroppedSmpPktErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendPktLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendUnderRunErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendMaxPktLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">SendMinPktLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvIBLostLinkErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvHdrErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvHdrLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvBadTidErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvBadVersionErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvIBFlowErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvEBPErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvUnsupportedVLErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvUnexpectedCharErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvShortPktLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvLongPktLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvMaxPktLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvMinPktLenErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvICRCErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvVCRCErr</span><span class="p">),</span>
	<span class="n">E_P_AUTO</span><span class="p">(</span><span class="n">RcvFormatErr</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Below generates &quot;auto-message&quot; for interrupts not specific to any port or</span>
<span class="cm"> * context</span>
<span class="cm"> */</span>
<span class="cp">#define INTR_AUTO(fldname) { .mask = SYM_MASK(IntMask, fldname##Mask), \</span>
<span class="cp">	.msg = #fldname, .sz = sizeof(#fldname) }</span>
<span class="cm">/* Below generates &quot;auto-message&quot; for interrupts specific to a port */</span>
<span class="cp">#define INTR_AUTO_P(fldname) { .mask = MASK_ACROSS(\</span>
<span class="cp">	SYM_LSB(IntMask, fldname##Mask##_0), \</span>
<span class="cp">	SYM_LSB(IntMask, fldname##Mask##_1)), \</span>
<span class="cp">	.msg = #fldname &quot;_P&quot;, .sz = sizeof(#fldname &quot;_P&quot;) }</span>
<span class="cm">/* For some reason, the SerDesTrimDone bits are reversed */</span>
<span class="cp">#define INTR_AUTO_PI(fldname) { .mask = MASK_ACROSS(\</span>
<span class="cp">	SYM_LSB(IntMask, fldname##Mask##_1), \</span>
<span class="cp">	SYM_LSB(IntMask, fldname##Mask##_0)), \</span>
<span class="cp">	.msg = #fldname &quot;_P&quot;, .sz = sizeof(#fldname &quot;_P&quot;) }</span>
<span class="cm">/*</span>
<span class="cm"> * Below generates &quot;auto-message&quot; for interrupts specific to a context,</span>
<span class="cm"> * with ctxt-number appended</span>
<span class="cm"> */</span>
<span class="cp">#define INTR_AUTO_C(fldname) { .mask = MASK_ACROSS(\</span>
<span class="cp">	SYM_LSB(IntMask, fldname##0IntMask), \</span>
<span class="cp">	SYM_LSB(IntMask, fldname##17IntMask)), \</span>
<span class="cp">	.msg = #fldname &quot;_C&quot;, .sz = sizeof(#fldname &quot;_C&quot;) }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span>  <span class="n">qib_hwerror_msgs</span> <span class="n">qib_7322_intr_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTR_AUTO_P</span><span class="p">(</span><span class="n">SDmaInt</span><span class="p">),</span>
	<span class="n">INTR_AUTO_P</span><span class="p">(</span><span class="n">SDmaProgressInt</span><span class="p">),</span>
	<span class="n">INTR_AUTO_P</span><span class="p">(</span><span class="n">SDmaIdleInt</span><span class="p">),</span>
	<span class="n">INTR_AUTO_P</span><span class="p">(</span><span class="n">SDmaCleanupDone</span><span class="p">),</span>
	<span class="n">INTR_AUTO_C</span><span class="p">(</span><span class="n">RcvUrg</span><span class="p">),</span>
	<span class="n">INTR_AUTO_P</span><span class="p">(</span><span class="n">ErrInt</span><span class="p">),</span>
	<span class="n">INTR_AUTO</span><span class="p">(</span><span class="n">ErrInt</span><span class="p">),</span>      <span class="cm">/* non-port-specific errs */</span>
	<span class="n">INTR_AUTO</span><span class="p">(</span><span class="n">AssertGPIOInt</span><span class="p">),</span>
	<span class="n">INTR_AUTO_P</span><span class="p">(</span><span class="n">SendDoneInt</span><span class="p">),</span>
	<span class="n">INTR_AUTO</span><span class="p">(</span><span class="n">SendBufAvailInt</span><span class="p">),</span>
	<span class="n">INTR_AUTO_C</span><span class="p">(</span><span class="n">RcvAvail</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define TXSYMPTOM_AUTO_P(fldname) \</span>
<span class="cp">	{ .mask = SYM_MASK(SendHdrErrSymptom_0, fldname), \</span>
<span class="cp">	.msg = #fldname, .sz = sizeof(#fldname) }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span>  <span class="n">qib_hwerror_msgs</span> <span class="n">hdrchk_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TXSYMPTOM_AUTO_P</span><span class="p">(</span><span class="n">NonKeyPacket</span><span class="p">),</span>
	<span class="n">TXSYMPTOM_AUTO_P</span><span class="p">(</span><span class="n">GRHFail</span><span class="p">),</span>
	<span class="n">TXSYMPTOM_AUTO_P</span><span class="p">(</span><span class="n">PkeyFail</span><span class="p">),</span>
	<span class="n">TXSYMPTOM_AUTO_P</span><span class="p">(</span><span class="n">QPFail</span><span class="p">),</span>
	<span class="n">TXSYMPTOM_AUTO_P</span><span class="p">(</span><span class="n">SLIDFail</span><span class="p">),</span>
	<span class="n">TXSYMPTOM_AUTO_P</span><span class="p">(</span><span class="n">RawIPV6</span><span class="p">),</span>
	<span class="n">TXSYMPTOM_AUTO_P</span><span class="p">(</span><span class="n">PacketTooSmall</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define IBA7322_HDRHEAD_PKTINT_SHIFT 32 </span><span class="cm">/* interrupt cnt in upper 32 bits */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Called when we might have an error that is specific to a particular</span>
<span class="cm"> * PIO buffer, and may need to cancel that buffer, so it can be re-used,</span>
<span class="cm"> * because we don&#39;t need to force the update of pioavail</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_disarm_7322_senderrbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">any</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">piobcnt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">+</span> <span class="n">NUM_VL15_BUFS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">piobcnt</span> <span class="o">+</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s possible that sendbuffererror could have bits set; might</span>
<span class="cm">	 * have already done this as a result of hardware error handling.</span>
<span class="cm">	 */</span>
	<span class="n">any</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">regcnt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">any</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">any</span><span class="p">)</span>
		<span class="n">qib_disarm_piobufs_set</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">,</span> <span class="n">piobcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* No txe_recover yet, if ever */</span>

<span class="cm">/* No decode__errors yet */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">err_decode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">u64</span> <span class="n">errs</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">qib_hwerror_msgs</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">these</span><span class="p">,</span> <span class="n">lmask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">took</span><span class="p">,</span> <span class="n">multi</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;&amp;</span> <span class="n">msp</span> <span class="o">&amp;&amp;</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">multi</span> <span class="o">=</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">these</span> <span class="o">=</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
			<span class="n">lmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">these</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">these</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">^</span> <span class="n">these</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* separate the strings */</span>
					<span class="o">*</span><span class="n">msg</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
					<span class="n">len</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">sz</span><span class="p">);</span>
				<span class="cm">/* msp-&gt;sz counts the nul */</span>
				<span class="n">took</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">sz</span> <span class="o">-</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>  <span class="n">msp</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">took</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="n">took</span><span class="p">;</span>
				<span class="n">msg</span> <span class="o">+=</span> <span class="n">took</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
					<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">errs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lmask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">multi</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* More than one bit this mask */</span>
				<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">lmask</span> <span class="o">&amp;</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">++</span><span class="n">idx</span><span class="p">;</span>
					<span class="n">lmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">took</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;_%d&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="n">took</span><span class="p">;</span>
				<span class="n">msg</span> <span class="o">+=</span> <span class="n">took</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">msp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If some bits are left, show in hex. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">errs</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%sMORE:%llX&quot;</span><span class="p">,</span> <span class="n">n</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">errs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* only called if r1 set */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">piobuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bufn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pbc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">hdrwords</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">qib_ib_header</span> <span class="n">ibhdr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">lrh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mh">0xF000</span> <span class="o">|</span> <span class="n">QIB_LRH_BTH</span><span class="p">),</span>
		<span class="p">.</span><span class="n">lrh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_LID_PERMISSIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lrh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">hdrwords</span> <span class="o">+</span> <span class="n">SIZE_OF_CRC</span><span class="p">),</span>
		<span class="p">.</span><span class="n">lrh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_LID_PERMISSIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">oth</span><span class="p">.</span><span class="n">bth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
			<span class="p">(</span><span class="n">IB_OPCODE_UD_SEND_ONLY</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">QIB_DEFAULT_P_KEY</span><span class="p">),</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">oth</span><span class="p">.</span><span class="n">bth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">oth</span><span class="p">.</span><span class="n">bth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">oth</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">deth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">oth</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">deth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send a dummy VL15 packet to flush the launch FIFO.</span>
<span class="cm">	 * This will not actually be sent since the TxeBypassIbc bit is set.</span>
<span class="cm">	 */</span>
	<span class="n">pbc</span> <span class="o">=</span> <span class="n">PBC_7322_VL15_SEND</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PBC_PORT_SEL_LSB</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">hdrwords</span> <span class="o">+</span> <span class="n">SIZE_OF_CRC</span><span class="p">);</span>
	<span class="n">piobuf</span> <span class="o">=</span> <span class="n">qib_7322_getsendbuf</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">piobuf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">pbc</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ibhdr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PIO_FLUSH_WC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_flush_wc</span><span class="p">();</span>
		<span class="n">qib_pio_copy</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdrwords</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">qib_flush_wc</span><span class="p">();</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrwords</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">piobuf</span> <span class="o">+</span> <span class="n">hdrwords</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">qib_flush_wc</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qib_pio_copy</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdrwords</span><span class="p">);</span>
	<span class="n">qib_sendbuf_done</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">bufn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called with interrupts disabled and sdma_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_sdma_sendctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">set_sendctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">clr_sendctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_ENABLE</span><span class="p">)</span>
		<span class="n">set_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SDmaEnable</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clr_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SDmaEnable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_INTENABLE</span><span class="p">)</span>
		<span class="n">set_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SDmaIntEnable</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clr_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SDmaIntEnable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_HALT</span><span class="p">)</span>
		<span class="n">set_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SDmaHalt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clr_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SDmaHalt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_DRAIN</span><span class="p">)</span>
		<span class="n">set_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeBypassIbc</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeAbortIbc</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeDrainRmFifo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clr_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeBypassIbc</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeAbortIbc</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeDrainRmFifo</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">);</span>

	<span class="cm">/* If we are draining everything, block sends first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_DRAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SendEnable</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">|=</span> <span class="n">set_sendctrl</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clr_sendctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_CLEANUP</span><span class="p">)</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendctrl</span><span class="p">,</span>
				    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">|</span>
				    <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SDmaCleanup</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_DRAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SendEnable</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_DRAIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
		<span class="n">flush_fifo</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_sdma_hw_clean_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">qib_sdma_event_e50_hw_cleaned</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_sdma_7322_setlengen</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set SendDmaLenGen and clear and set</span>
<span class="cm">	 * the MSB of the generation count to enable generation checking</span>
<span class="cm">	 * and load the internal generation counter.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmalengen</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_cnt</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmalengen</span><span class="p">,</span>
			    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_cnt</span> <span class="o">|</span>
			    <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_7322_SendDmaLenGen_0_Generation_MSB</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must be called with sdma_lock held, or before init finished.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_sdma_update_7322_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Commit writes to memory and advance the tail on the chip */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmatail</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called with interrupts disabled and sdma_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_sdma_hw_start_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Drain all FIFOs.</span>
<span class="cm">	 * The hardware doesn&#39;t require this but we do it so that verbs</span>
<span class="cm">	 * and user applications don&#39;t wait for link active to send stale</span>
<span class="cm">	 * data.</span>
<span class="cm">	 */</span>
	<span class="n">sendctrl_7322_mod</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_FLUSH</span><span class="p">);</span>

	<span class="n">qib_sdma_7322_setlengen</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="n">qib_sdma_update_7322_tail</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Set SendDmaTail */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_head_dma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qib_7322_sdma_sendctrl</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">current_op</span> <span class="o">|</span> <span class="n">QIB_SDMA_SENDCTRL_OP_CLEANUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DISABLES_SDMA ( \</span>
<span class="cp">	QIB_E_P_SDMAHALT | \</span>
<span class="cp">	QIB_E_P_SDMADESCADDRMISALIGN | \</span>
<span class="cp">	QIB_E_P_SDMAMISSINGDW | \</span>
<span class="cp">	QIB_E_P_SDMADWEN | \</span>
<span class="cp">	QIB_E_P_SDMARPYTAG | \</span>
<span class="cp">	QIB_E_P_SDMA1STDESC | \</span>
<span class="cp">	QIB_E_P_SDMABASE | \</span>
<span class="cp">	QIB_E_P_SDMATAILOUTOFBOUND | \</span>
<span class="cp">	QIB_E_P_SDMAOUTOFBOUND | \</span>
<span class="cp">	QIB_E_P_SDMAGENMISMATCH)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_7322_p_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">errs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="n">errs</span> <span class="o">&amp;=</span> <span class="n">QIB_E_P_SDMAERRS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SDMAUNEXPDATA</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;IB%u:%u SDmaUnexpData</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">current_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">qib_sdma_state_s00_hw_down</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s10_hw_start_up_wait</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SDMAHALT</span><span class="p">)</span>
			<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">qib_sdma_event_e20_hw_started</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s20_idle</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s30_sw_clean_up_wait</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s40_hw_clean_up_wait</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SDMAHALT</span><span class="p">)</span>
			<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">qib_sdma_event_e50_hw_cleaned</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s50_hw_halt_wait</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SDMAHALT</span><span class="p">)</span>
			<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">qib_sdma_event_e60_hw_halted</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s99_running</span>:
		<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">qib_sdma_event_e7322_err_halted</span><span class="p">);</span>
		<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">qib_sdma_event_e60_hw_halted</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle per-device errors (not per-port errors)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">handle_7322_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iserr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">errs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log_idx</span><span class="p">;</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_errints</span><span class="o">++</span><span class="p">;</span>
	<span class="n">errs</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errstatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;device error interrupt, &quot;</span>
			 <span class="s">&quot;but no error bits set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t report errors that are masked */</span>
	<span class="n">errs</span> <span class="o">&amp;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">emsgbuf</span><span class="p">;</span>

	<span class="cm">/* do these first, they are most important */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_HARDWARE</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">qib_7322_handle_hwerrors</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">emsgbuf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">log_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">log_idx</span> <span class="o">&lt;</span> <span class="n">QIB_EEP_LOG_CNT</span><span class="p">;</span> <span class="o">++</span><span class="n">log_idx</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_masks</span><span class="p">[</span><span class="n">log_idx</span><span class="p">].</span><span class="n">errs_to_log</span><span class="p">)</span>
				<span class="n">qib_inc_eeprom_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">log_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_SPKTERRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_disarm_7322_senderrbufs</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_txerrs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_INVALIDADDR</span><span class="p">)</span>
		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_txerrs</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_ARMLAUNCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_txerrs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qib_disarm_7322_senderrbufs</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ones we mask off are handled specially below</span>
<span class="cm">	 * or above.  Also mask SDMADISABLED by default as it</span>
<span class="cm">	 * is too chatty.</span>
<span class="cm">	 */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">QIB_E_HARDWARE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">err_decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">emsgbuf</span><span class="p">,</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span>
		   <span class="n">qib_7322error_msgs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Getting reset is a tragedy for all ports. Mark the device</span>
<span class="cm">	 * _and_ the ports as &quot;offline&quot; in way meaningful to each.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pidx</span><span class="p">;</span>

		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Got reset, requires re-init &quot;</span>
			    <span class="s">&quot;(unload and reload driver)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_INITTED</span><span class="p">;</span>  <span class="cm">/* needs re-init */</span>
		<span class="cm">/* mark as having had error */</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">devstatusp</span> <span class="o">|=</span> <span class="n">QIB_STATUS_HWERROR</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">link_speed_supported</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_STATUS_IB_CONF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msg</span> <span class="o">&amp;&amp;</span> <span class="n">iserr</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;%s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there were hdrq or egrfull errors, wake up any processes</span>
<span class="cm">	 * waiting in poll.  We used to try to check which contexts had</span>
<span class="cm">	 * the overflow, but given the cost of that and the chip reads</span>
<span class="cm">	 * to support it, it&#39;s better to just wake everybody up if we</span>
<span class="cm">	 * get an overflow; waiters can poll again if it&#39;s not them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvEgrFullErr</span><span class="p">)</span> <span class="o">|</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvHdrFullErr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">qib_handle_urcv</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvEgrFullErr</span><span class="p">))</span>
			<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_buffull</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_hdrfull</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_error_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">handle_7322_errors</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reenable_chase</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">)</span><span class="n">opaque</span><span class="p">;</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">,</span>
		<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_POLL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_chase</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tnow</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">ibclt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_chase</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">,</span>
		<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">QIB_CHASE_DIS_TIME</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_serdes_issues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ibcst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ibclt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tnow</span><span class="p">;</span>

	<span class="n">ibclt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ibcst</span><span class="p">,</span> <span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkTrainingState</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detect and handle the state chase issue, where we can</span>
<span class="cm">	 * get stuck if we are unlucky on timing on both sides of</span>
<span class="cm">	 * the link.   If we are, we disable, set a timer, and</span>
<span class="cm">	 * then re-enable.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ibclt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_7322_LT_STATE_CFGRCVFCFG</span>:
	<span class="k">case</span> <span class="n">IB_7322_LT_STATE_CFGWAITRMT</span>:
	<span class="k">case</span> <span class="n">IB_7322_LT_STATE_TXREVLANES</span>:
	<span class="k">case</span> <span class="n">IB_7322_LT_STATE_CFGENH</span>:
		<span class="n">tnow</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">&amp;&amp;</span>
		     <span class="n">time_after</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span><span class="p">))</span>
			<span class="n">disable_chase</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">tnow</span><span class="p">,</span> <span class="n">ibclt</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span><span class="p">)</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="n">tnow</span> <span class="o">+</span> <span class="n">QIB_CHASE_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">ibclt</span> <span class="o">&gt;=</span> <span class="n">IB_7322_LT_STATE_CFGTEST</span> <span class="o">&amp;&amp;</span>
	      <span class="n">ibclt</span> <span class="o">&lt;=</span> <span class="n">IB_7322_LT_STATE_CFGWAITENH</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">ibclt</span> <span class="o">==</span> <span class="n">IB_7322_LT_STATE_LINKUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ibcst</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkSpeedQDR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">force_h1</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_reforce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
			<span class="n">serdes_7322_los_enable</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_reforce</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ibcst</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkSpeedQDR</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">ibclt</span> <span class="o">==</span> <span class="n">IB_7322_LT_STATE_CFGENH</span> <span class="o">||</span>
		<span class="n">ibclt</span> <span class="o">==</span> <span class="n">IB_7322_LT_STATE_CFGIDLE</span> <span class="o">||</span>
		<span class="n">ibclt</span> <span class="o">==</span> <span class="n">IB_7322_LT_STATE_LINKUP</span><span class="p">))</span>
		<span class="n">force_h1</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">IS_QMH</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QME</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">==</span> <span class="n">QIB_IB_QDR</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ibclt</span> <span class="o">==</span> <span class="n">IB_7322_LT_STATE_CFGTEST</span> <span class="o">||</span>
	     <span class="n">ibclt</span> <span class="o">==</span> <span class="n">IB_7322_LT_STATE_CFGENH</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">ibclt</span> <span class="o">&gt;=</span> <span class="n">IB_7322_LT_STATE_POLLACTIVE</span> <span class="o">&amp;&amp;</span>
	      <span class="n">ibclt</span> <span class="o">&lt;=</span> <span class="n">IB_7322_LT_STATE_SLEEPQUIET</span><span class="p">)))</span>
		<span class="n">adj_tx_serdes</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibclt</span> <span class="o">!=</span> <span class="n">IB_7322_LT_STATE_LINKUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">ltstate</span> <span class="o">=</span> <span class="n">qib_7322_phys_portstate</span><span class="p">(</span><span class="n">ibcst</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">pibclt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lastibcstat</span><span class="p">,</span> <span class="n">IBCStatusA_0</span><span class="p">,</span>
					  <span class="n">LinkTrainingState</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pibclt</span> <span class="o">==</span> <span class="n">IB_7322_LT_STATE_LINKUP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_RECOVERY_RETRAIN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_RECOVERY_WAITRMT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_RECOVERY_IDLE</span><span class="p">)</span>
			<span class="cm">/* If the link went down (but no into recovery,</span>
<span class="cm">			 * turn LOS back on */</span>
			<span class="n">serdes_7322_los_enable</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_on</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ibclt</span> <span class="o">&lt;=</span> <span class="n">IB_7322_LT_STATE_SLEEPQUIET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* On link down, reenable QDR adaptation */</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
					    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">?</span>
					    <span class="n">QDR_STATIC_ADAPT_DOWN_R1</span> <span class="o">:</span>
					    <span class="n">QDR_STATIC_ADAPT_DOWN</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span>
				<span class="s">&quot; IB%u:%u re-enabled QDR adaptation &quot;</span>
				<span class="s">&quot;ibclt %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ibclt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qib_7322_set_ib_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is per-pport error handling.</span>
<span class="cm"> * will likely get it&#39;s own MSIx interrupt (one for each port,</span>
<span class="cm"> * although just a single handler).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">handle_7322_p_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ignore_this_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iserr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">fmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="cm">/* do this as soon as possible */</span>
	<span class="n">fmask</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_act_fmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmask</span><span class="p">)</span>
		<span class="n">check_7322_rxe_status</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="n">errs</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_errstatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errs</span><span class="p">)</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			 <span class="s">&quot;Port%d error interrupt, but no error bits set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmask</span><span class="p">)</span>
		<span class="n">errs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_E_P_IBSTATUSCHANGED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">epmsgbuf</span><span class="p">;</span>
	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QIB_E_P_BITSEXTANT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">epmsgbuf</span><span class="p">,</span>
			   <span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QIB_E_P_BITSEXTANT</span><span class="p">,</span> <span class="n">qib_7322p_error_msgs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">msg</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">epmsgbuf</span><span class="p">,</span>
				 <span class="s">&quot;no others&quot;</span><span class="p">);</span>
		<span class="n">qib_dev_porterr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;error interrupt with unknown&quot;</span>
				<span class="s">&quot; errors 0x%016Lx set (and %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QIB_E_P_BITSEXTANT</span><span class="p">),</span> <span class="n">msg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SHDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">symptom</span><span class="p">;</span>

		<span class="cm">/* determine cause, then write to clear */</span>
		<span class="n">symptom</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendhdrsymptom</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendhdrsymptom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err_decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">epmsgbuf</span><span class="p">,</span> <span class="n">symptom</span><span class="p">,</span>
			   <span class="n">hdrchk_msgs</span><span class="p">);</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="cm">/* senderrbuf cleared in SPKTERRS below */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SPKTERRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_LINK_PKTERRS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_LINKACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This can happen when trying to bring the link</span>
<span class="cm">			 * up, but the IB link changes state at the &quot;wrong&quot;</span>
<span class="cm">			 * time. The IB logic then complains that the packet</span>
<span class="cm">			 * isn&#39;t valid.  We don&#39;t want to confuse people, so</span>
<span class="cm">			 * we just don&#39;t print them, except at debug</span>
<span class="cm">			 */</span>
			<span class="n">err_decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">epmsgbuf</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_LINK_PKTERRS</span><span class="p">),</span>
				   <span class="n">qib_7322p_error_msgs</span><span class="p">);</span>
			<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">ignore_this_time</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_LINK_PKTERRS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qib_disarm_7322_senderrbufs</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_LINK_PKTERRS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_LINKACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This can happen when SMA is trying to bring the link</span>
<span class="cm">		 * up, but the IB link changes state at the &quot;wrong&quot; time.</span>
<span class="cm">		 * The IB logic then complains that the packet isn&#39;t</span>
<span class="cm">		 * valid.  We don&#39;t want to confuse people, so we just</span>
<span class="cm">		 * don&#39;t print them, except at debug</span>
<span class="cm">		 */</span>
		<span class="n">err_decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">epmsgbuf</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span>
			   <span class="n">qib_7322p_error_msgs</span><span class="p">);</span>
		<span class="n">ignore_this_time</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_LINK_PKTERRS</span><span class="p">;</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_errclear</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>

	<span class="n">errs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ignore_this_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_RPKTERRS</span><span class="p">)</span>
		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_rcverrs</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SPKTERRS</span><span class="p">)</span>
		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_txerrs</span><span class="o">++</span><span class="p">;</span>

	<span class="n">iserr</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">QIB_E_P_RPKTERRS</span> <span class="o">|</span> <span class="n">QIB_E_P_PKTERRS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_SDMAERRS</span><span class="p">)</span>
		<span class="n">sdma_7322_p_errors</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QIB_E_P_IBSTATUSCHANGED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">ibcs</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ltstate</span><span class="p">;</span>

		<span class="n">ibcs</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcstatus_a</span><span class="p">);</span>
		<span class="n">ltstate</span> <span class="o">=</span> <span class="n">qib_7322_phys_portstate</span><span class="p">(</span><span class="n">ibcs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span>
			<span class="n">handle_serdes_issues</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;</span>
		      <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBStatIntReductionEn</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We got our interrupt, so init code should be</span>
<span class="cm">			 * happy and not try alternatives. Now squelch</span>
<span class="cm">			 * other &quot;chatter&quot; from link-negotiation (pre Init)</span>
<span class="cm">			 */</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|=</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBStatIntReductionEn</span><span class="p">);</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span>
					    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Update our picture of width and speed from chip */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">ibcs</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkWidthActive</span><span class="p">))</span> <span class="o">?</span>
			    <span class="n">IB_WIDTH_4X</span> <span class="o">:</span> <span class="n">IB_WIDTH_1X</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">=</span> <span class="p">(</span><span class="n">ibcs</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span>
			<span class="n">LinkSpeedQDR</span><span class="p">))</span> <span class="o">?</span> <span class="n">QIB_IB_QDR</span> <span class="o">:</span> <span class="p">(</span><span class="n">ibcs</span> <span class="o">&amp;</span>
			  <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkSpeedActive</span><span class="p">))</span> <span class="o">?</span>
				   <span class="n">QIB_IB_DDR</span> <span class="o">:</span> <span class="n">QIB_IB_SDR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_LINK_DISABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ltstate</span> <span class="o">!=</span>
		    <span class="n">IB_PHYSPORTSTATE_DISABLED</span><span class="p">)</span>
			<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/*</span>
<span class="cm">			 * Since going into a recovery state causes the link</span>
<span class="cm">			 * state to go down and since recovery is transitory,</span>
<span class="cm">			 * it is better if we &quot;miss&quot; ever seeing the link</span>
<span class="cm">			 * training state go into recovery (i.e., ignore this</span>
<span class="cm">			 * transition for link state special handling purposes)</span>
<span class="cm">			 * without updating lastibcstat.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_RECOVERY_RETRAIN</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_RECOVERY_WAITRMT</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ltstate</span> <span class="o">!=</span> <span class="n">IB_PHYSPORTSTATE_RECOVERY_IDLE</span><span class="p">)</span>
				<span class="n">qib_handle_e_ibstatuschanged</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msg</span> <span class="o">&amp;&amp;</span> <span class="n">iserr</span><span class="p">)</span>
		<span class="n">qib_dev_porterr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;%s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">state_wanted</span> <span class="o">&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* enable/disable chip from delivering interrupts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_set_intr_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_BADINTR</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">int_enable_mask</span><span class="p">);</span>
		<span class="cm">/* cause any pending enabled interrupts to be re-delivered */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* and same for MSIx */</span>
			<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intgranted</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intgranted</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to cleanup as much as possible for anything that might have gone</span>
<span class="cm"> * wrong while in freeze mode, such as pio buffers being written by user</span>
<span class="cm"> * processes (causing armlaunch), send errors due to going into freeze mode,</span>
<span class="cm"> * etc., and try to avoid causing extra interrupts while doing so.</span>
<span class="cm"> * Forcibly update the in-memory pioavail register copies after cleanup</span>
<span class="cm"> * because the chip won&#39;t do it while in freeze mode (the register values</span>
<span class="cm"> * themselves are kept correct).</span>
<span class="cm"> * Make sure that we don&#39;t lose any important interrupts by using the chip</span>
<span class="cm"> * feature that says that writing 0 to a bit in *clear that is set in</span>
<span class="cm"> * *status will cause an interrupt to be generated again (if allowed by</span>
<span class="cm"> * the *mask value).</span>
<span class="cm"> * This is in chip-specific code because of all of the register accesses,</span>
<span class="cm"> * even though the details are similar on most chips.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_clear_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pidx</span><span class="p">;</span>

	<span class="cm">/* disable error interrupts, to avoid confusion */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">link_speed_supported</span><span class="p">)</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">krp_errmask</span><span class="p">,</span>
					    <span class="mi">0ULL</span><span class="p">);</span>

	<span class="cm">/* also disable interrupts; errormask is sometimes overwriten */</span>
	<span class="n">qib_7322_set_intr_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* clear the freeze, and be sure chip saw it */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Force new interrupt if any hwerr, error or interrupt bits are</span>
<span class="cm">	 * still set, and clear &quot;safe&quot; send packet errors related to freeze</span>
<span class="cm">	 * and cancelling sends.  Re-enable error interrupts before possible</span>
<span class="cm">	 * force of re-interrupt on pending interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="n">E_SPKT_ERRS_IGNORE</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span><span class="p">);</span>
	<span class="cm">/* We need to purge per-port errs and reset mask, too */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">link_speed_supported</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">krp_errclear</span><span class="p">,</span> <span class="o">~</span><span class="mi">0Ull</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">krp_errmask</span><span class="p">,</span> <span class="o">~</span><span class="mi">0Ull</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qib_7322_set_intr_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* no error handling to speak of */</span>
<span class="cm">/**</span>
<span class="cm"> * qib_7322_handle_hwerrors - display hardware errors.</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @msg: the output buffer</span>
<span class="cm"> * @msgl: the size of the output buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Use same msg buffer as regular errors to avoid excessive stack</span>
<span class="cm"> * use.  Most hardware errors are catastrophic, but for right now,</span>
<span class="cm"> * we&#39;ll print them and continue.  We reuse the same message buffer as</span>
<span class="cm"> * qib_handle_errors() to avoid excessive stack usage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_handle_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">msgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">hwerrs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isfatal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hwerrs</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrstatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwerrs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Read of hardware error status failed &quot;</span>
			    <span class="s">&quot;(all bits set); ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_hwerrs</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Always clear the error status register, except BIST fail */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span> <span class="n">hwerrs</span> <span class="o">&amp;</span>
		       <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">));</span>

	<span class="n">hwerrs</span> <span class="o">&amp;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">;</span>

	<span class="cm">/* no EEPROM logging, yet */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span><span class="p">)</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Hardware error: hwerr=0x%llx &quot;</span>
			    <span class="s">&quot;(cleared)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hwerrs</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">Control</span><span class="p">,</span> <span class="n">FreezeMode</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No recovery yet...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">LATriggered</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">stay_in_freeze</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If any set that we aren&#39;t ignoring only make the</span>
<span class="cm">			 * complaint once, in case it&#39;s stuck or recurring,</span>
<span class="cm">			 * and we get here multiple times</span>
<span class="cm">			 * Force link down, so switch knows, and</span>
<span class="cm">			 * LEDs are turned off.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_INITTED</span><span class="p">)</span>
				<span class="n">isfatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">qib_7322_clear_freeze</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">isfatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;[Memory BIST test failed, &quot;</span>
			<span class="s">&quot;InfiniPath hardware unusable]&quot;</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
		<span class="cm">/* ignore from now on, so disable until driver reloaded */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err_decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">,</span> <span class="n">hwerrs</span><span class="p">,</span> <span class="n">qib_7322_hwerror_msgs</span><span class="p">);</span>

	<span class="cm">/* Ignore esoteric PLL failures et al. */</span>

	<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;%s hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isfatal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Fatal Hardware Error, no longer&quot;</span>
			    <span class="s">&quot; usable, SN %.16s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * for /sys status file and user programs to print; if no</span>
<span class="cm">		 * trailing brace is copied, we&#39;ll know it was truncated.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">freezemsg</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">freezemsg</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">freezelen</span><span class="p">,</span>
				 <span class="s">&quot;{%s}&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">qib_disable_after_error</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">bail:</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7322_init_hwerrors - enable hardware errors</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> *</span>
<span class="cm"> * now that we have finished initializing everything that might reasonably</span>
<span class="cm"> * cause a hardware error, and cleared those errors bits as they occur,</span>
<span class="cm"> * we can enable hardware errors in the mask (potentially enabling</span>
<span class="cm"> * freeze mode), and enable hardware errors as errors (along with</span>
<span class="cm"> * everything else) in errormask</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_init_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pidx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">extsval</span><span class="p">;</span>

	<span class="n">extsval</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extstatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extsval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_EXTS_MEMBIST_DISABLED</span> <span class="o">|</span>
			 <span class="n">QIB_EXTS_MEMBIST_ENDTEST</span><span class="p">)))</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;MemBIST did not complete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* never clear BIST failure, so reported on each driver load */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span> <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">));</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">);</span>

	<span class="cm">/* clear all */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
	<span class="cm">/* enable errors that are masked, at least this first time. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">link_speed_supported</span><span class="p">)</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">krp_errmask</span><span class="p">,</span>
					    <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable and enable the armlaunch error.  Used for PIO bandwidth testing</span>
<span class="cm"> * on chips that are count-based, rather than trigger-based.  There is no</span>
<span class="cm"> * reference counting, but that&#39;s also fine, given the intended use.</span>
<span class="cm"> * Only chip-specific because it&#39;s all register accesses</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_set_7322_armlaunch</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="n">QIB_E_SPIOARMLAUNCH</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span> <span class="o">|=</span> <span class="n">QIB_E_SPIOARMLAUNCH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_E_SPIOARMLAUNCH</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Formerly took parameter &lt;which&gt; in pre-shifted,</span>
<span class="cm"> * pre-merged form with LinkCmd and LinkInitCmd</span>
<span class="cm"> * together, and assuming the zero was NOP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">linkcmd</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">linitcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mod_wd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linitcmd</span> <span class="o">==</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we are told to disable, note that so link-recovery</span>
<span class="cm">		 * code does not attempt to bring us back up.</span>
<span class="cm">		 * Also reset everything that we can, so we start</span>
<span class="cm">		 * completely clean when re-enabled (before we</span>
<span class="cm">		 * actually issue the disable to the IBC)</span>
<span class="cm">		 */</span>
		<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_LINK_DISABLED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linitcmd</span> <span class="o">||</span> <span class="n">linkcmd</span> <span class="o">==</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Any other linkinitcmd will lead to LINKDOWN and then</span>
<span class="cm">		 * to INIT (if all is well), so clear flag to let</span>
<span class="cm">		 * link-recovery code attempt to bring us back up.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_LINK_DISABLED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear status change interrupt reduction so the</span>
<span class="cm">		 * new state is seen.</span>
<span class="cm">		 */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBStatIntReductionEn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mod_wd</span> <span class="o">=</span> <span class="p">(</span><span class="n">linkcmd</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_IBCC_LINKCMD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">linitcmd</span> <span class="o">&lt;&lt;</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SHIFT</span><span class="p">);</span>

	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|</span>
			    <span class="n">mod_wd</span><span class="p">);</span>
	<span class="cm">/* write to chip to prevent back-to-back writes of ibc reg */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The total RCV buffer memory is 64KB, used for both ports, and is</span>
<span class="cm"> * in units of 64 bytes (same as IB flow control credit unit).</span>
<span class="cm"> * The consumedVL unit in the same registers are in 32 byte units!</span>
<span class="cm"> * So, a VL15 packet needs 4.50 IB credits, and 9 rx buffer chunks,</span>
<span class="cm"> * and we can therefore allocate just 9 IB credits for 2 VL15 packets</span>
<span class="cm"> * in krp_rxcreditvl15, rather than 10.</span>
<span class="cm"> */</span>
<span class="cp">#define RCV_BUF_UNITSZ 64</span>
<span class="cp">#define NUM_RCV_BUF_UNITS(dd) ((64 * 1024) / (RCV_BUF_UNITSZ * dd-&gt;num_pports))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_vls</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">numvls</span><span class="p">,</span> <span class="n">totcred</span><span class="p">,</span> <span class="n">cred_vl</span><span class="p">,</span> <span class="n">vl0extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">numvls</span> <span class="o">=</span> <span class="n">qib_num_vls</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_operational</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up per-VL credits. Below is kluge based on these assumptions:</span>
<span class="cm">	 * 1) port is disabled at the time early_init is called.</span>
<span class="cm">	 * 2) give VL15 17 credits, for two max-plausible packets.</span>
<span class="cm">	 * 3) Give VL0-N the rest, with any rounding excess used for VL0</span>
<span class="cm">	 */</span>
	<span class="cm">/* 2 VL15 packets @ 288 bytes each (including IB headers) */</span>
	<span class="n">totcred</span> <span class="o">=</span> <span class="n">NUM_RCV_BUF_UNITS</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">cred_vl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">288</span> <span class="o">+</span> <span class="n">RCV_BUF_UNITSZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">RCV_BUF_UNITSZ</span><span class="p">;</span>
	<span class="n">totcred</span> <span class="o">-=</span> <span class="n">cred_vl</span><span class="p">;</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rxcreditvl15</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">cred_vl</span><span class="p">);</span>
	<span class="n">cred_vl</span> <span class="o">=</span> <span class="n">totcred</span> <span class="o">/</span> <span class="n">numvls</span><span class="p">;</span>
	<span class="n">vl0extra</span> <span class="o">=</span> <span class="n">totcred</span> <span class="o">-</span> <span class="n">cred_vl</span> <span class="o">*</span> <span class="n">numvls</span><span class="p">;</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rxcreditvl0</span><span class="p">,</span> <span class="n">cred_vl</span> <span class="o">+</span> <span class="n">vl0extra</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numvls</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rxcreditvl0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">cred_vl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* no buffer space for other VLs */</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rxcreditvl0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Notify IBC that credits need to be recalculated */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibsdtestiftx</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IB_SDTEST_IF_TX_0</span><span class="p">,</span> <span class="n">CREDIT_CHANGE</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibsdtestiftx</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IB_SDTEST_IF_TX_0</span><span class="p">,</span> <span class="n">CREDIT_CHANGE</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibsdtestiftx</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numvls</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rxcreditvl0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rxcreditvl15</span><span class="p">);</span>

	<span class="cm">/* Change the number of operational VLs */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">NumVLane</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">numvls</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">NumVLane</span><span class="p">));</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The code that deals with actual SerDes is in serdes_7322_init().</span>
<span class="cm"> * Compared to the code for iba7220, it is minimal.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">serdes_7322_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7322_bringup_serdes - bring up the serdes</span>
<span class="cm"> * @ppd: physical port on the qlogic_ib device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_bringup_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">ibc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SerDes model not in Pd, but still need to</span>
<span class="cm">	 * set up much of IBCCtrl and IBCDDRCtrl; move elsewhere</span>
<span class="cm">	 * eventually.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Put IBC in reset, sends disabled (should be in reset already) */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBLinkEn</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_compat_ddr_negotiate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
						<span class="n">crp_ibsymbolerr</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
						<span class="n">crp_iblinkerrrecov</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* flowcontrolwatermark is in units of KBytes */</span>
	<span class="n">ibc</span> <span class="o">=</span> <span class="mh">0x5ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">FlowCtrlWaterMark</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Flow control is sent this often, even if no changes in</span>
<span class="cm">	 * buffer space occur.  Units are 128ns for this chip.</span>
<span class="cm">	 * Set to 3usec.</span>
<span class="cm">	 */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="mi">24ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">FlowCtrlPeriod</span><span class="p">);</span>
	<span class="cm">/* max error tolerance */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="mh">0xfULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">PhyerrThreshold</span><span class="p">);</span>
	<span class="cm">/* IB credit flow control. */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="mh">0xfULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">OverrunThreshold</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * set initial max size pkt IBC will send, including ICRC; it&#39;s the</span>
<span class="cm">	 * PIO buffer size in dwords, less 1; also see qib_set_mtu()</span>
<span class="cm">	 */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">ibmaxlen</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">MaxPktLen</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">=</span> <span class="n">ibc</span><span class="p">;</span> <span class="cm">/* without linkcmd or linkinitcmd! */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the PCS interface to the serdes (and also ibc, which is still</span>
<span class="cm">	 * in reset from above).  Writes new value of ibcctrl_a as last step.</span>
<span class="cm">	 */</span>
	<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">lse</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Not on re-init after reset, establish shadow</span>
<span class="cm">		 * and force initial config.</span>
<span class="cm">		 */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
							     <span class="n">krp_ibcctrl_b</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IBA7322_IBC_SPEED_QDR</span> <span class="o">|</span>
				<span class="n">IBA7322_IBC_SPEED_DDR</span> <span class="o">|</span>
				<span class="n">IBA7322_IBC_SPEED_SDR</span> <span class="o">|</span>
				<span class="n">IBA7322_IBC_WIDTH_AUTONEG</span> <span class="o">|</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_LANE_REV_SUPPORTED</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lse</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lse</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="cm">/* Muliple speeds enabled */</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">|=</span>
				<span class="p">(</span><span class="n">lse</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_IBC_SPEED_LSB</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IBA7322_IBC_IBTA_1_2_MASK</span> <span class="o">|</span>
				<span class="n">IBA7322_IBC_MAX_SPEED_MASK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lse</span> <span class="o">==</span> <span class="n">QIB_IB_QDR</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">IBA7322_IBC_SPEED_QDR</span> <span class="o">|</span>
				 <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span> <span class="o">:</span>
				<span class="p">(</span><span class="n">lse</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">IBA7322_IBC_SPEED_DDR</span> <span class="o">:</span>
					<span class="n">IBA7322_IBC_SPEED_SDR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IB_WIDTH_1X</span> <span class="o">|</span> <span class="n">IB_WIDTH_4X</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">IB_WIDTH_1X</span> <span class="o">|</span> <span class="n">IB_WIDTH_4X</span><span class="p">))</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">|=</span> <span class="n">IBA7322_IBC_WIDTH_AUTONEG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">|=</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">==</span> <span class="n">IB_WIDTH_4X</span> <span class="o">?</span>
				<span class="n">IBA7322_IBC_WIDTH_4X_ONLY</span> <span class="o">:</span>
				<span class="n">IBA7322_IBC_WIDTH_1X_ONLY</span><span class="p">;</span>

		<span class="cm">/* always enable these on driver reload, not sticky */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IBA7322_IBC_RXPOL_MASK</span> <span class="o">|</span>
			<span class="n">IBA7322_IBC_HRTBT_MASK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_b</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span><span class="p">);</span>

	<span class="cm">/* setup so we have more time at CFGTEST to change H1 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_c</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlC_0</span><span class="p">,</span> <span class="n">IB_FRONT_PORCH</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0xfULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlC_0</span><span class="p">,</span> <span class="n">IB_FRONT_PORCH</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_c</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">serdes_7322_init</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="n">guid</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">guid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">base_guid</span><span class="p">)</span>
			<span class="n">guid</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">base_guid</span><span class="p">)</span> <span class="o">+</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">guid</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">guid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_hrtbt_guid</span><span class="p">,</span> <span class="n">guid</span><span class="p">);</span>
	<span class="cm">/* write to chip to prevent back-to-back writes of ibc reg */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable port */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBLinkEn</span><span class="p">);</span>
	<span class="n">set_vls</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="cm">/* initially come up DISABLED, without sending anything. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|</span> <span class="p">(</span><span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span> <span class="o">&lt;&lt;</span>
					<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SHIFT</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="cm">/* clear the linkinit cmds */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">LinkInitCmd</span><span class="p">);</span>

	<span class="cm">/* be paranoid against later code motion, etc. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl_0</span><span class="p">,</span> <span class="n">RcvIBPortEnable</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rcvctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Also enable IBSTATUSCHG interrupt.  */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_errmask</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_errmask</span><span class="p">,</span>
		<span class="n">val</span> <span class="o">|</span> <span class="n">ERR_MASK_N</span><span class="p">(</span><span class="n">IBStatusChanged</span><span class="p">));</span>

	<span class="cm">/* Always zero until we start messing with SerDes for real */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7322_quiet_serdes - set serdes to txidle</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * Called when driver is being unloaded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_mini_quiet_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_work</span><span class="p">);</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="cm">/* if initted */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Despite the name, actually disables IBC as well. Do it when</span>
<span class="cm">	 * we are as sure as possible that no more packets can be</span>
<span class="cm">	 * received, following the down and the PCS reset.</span>
<span class="cm">	 * The actual disabling happens in qib_7322_mini_pci_reset(),</span>
<span class="cm">	 * along with the PCS being reset.</span>
<span class="cm">	 */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBLinkEn</span><span class="p">);</span>
	<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the adjusted counters so the adjustment persists</span>
<span class="cm">	 * across driver reload.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">||</span>
	    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkdowndelta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">diagc</span><span class="p">;</span>

		<span class="cm">/* enable counter writes */</span>
		<span class="n">diagc</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">,</span>
			       <span class="n">diagc</span> <span class="o">|</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwDiagCtrl</span><span class="p">,</span> <span class="n">CounterWrEnable</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_ibsymbolerr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">-=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span><span class="p">;</span>
			<span class="n">write_7322_creg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_ibsymbolerr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_iblinkerrrecov</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">-=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span><span class="p">;</span>
			<span class="n">write_7322_creg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_iblinkerrrecov</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkdowndelta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_iblinkdown</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">+=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkdowndelta</span><span class="p">;</span>
			<span class="n">write_7322_creg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_iblinkdown</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * No need to save ibmalfdelta since IB perfcounters</span>
<span class="cm">		 * are cleared on driver reload.</span>
<span class="cm">		 */</span>

		<span class="cm">/* and disable counter writes */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">,</span> <span class="n">diagc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_setup_7322_setextled - set the state of the two external LEDs</span>
<span class="cm"> * @ppd: physical port on the qlogic_ib device</span>
<span class="cm"> * @on: whether the link is up or not</span>
<span class="cm"> *</span>
<span class="cm"> * The exact combo of LEDs if on is true is determined by looking</span>
<span class="cm"> * at the ibcstatus.</span>
<span class="cm"> *</span>
<span class="cm"> * These LEDs indicate the physical and logical state of IB link.</span>
<span class="cm"> * For this chip (at least with recommended board pinouts), LED1</span>
<span class="cm"> * is Yellow (logical state) and LED2 is Green (physical state),</span>
<span class="cm"> *</span>
<span class="cm"> * Note:  We try to match the Mellanox HCA LED behavior as best</span>
<span class="cm"> * we can.  Green indicates physical link state is OK (something is</span>
<span class="cm"> * plugged in, and we can train).</span>
<span class="cm"> * Amber indicates the link is logically up (ACTIVE).</span>
<span class="cm"> * Mellanox further blinks the amber LED to indicate data packet</span>
<span class="cm"> * activity, but we have no hardware support for that, so it would</span>
<span class="cm"> * require waking up every 10-20 msecs and checking the counters</span>
<span class="cm"> * on the chip, and then turning the LED off if appropriate.  That&#39;s</span>
<span class="cm"> * visible overhead, so not something we will do.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_setup_7322_setextled</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">extctl</span><span class="p">,</span> <span class="n">ledblink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yel</span><span class="p">,</span> <span class="n">grn</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The diags use the LED to indicate diag info, so we leave</span>
<span class="cm">	 * the external LED alone when the diags are running.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Allow override of LED display for, e.g. Locating system in rack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">led_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grn</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">led_override</span> <span class="o">&amp;</span> <span class="n">QIB_LED_PHYS</span><span class="p">);</span>
		<span class="n">yel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">led_override</span> <span class="o">&amp;</span> <span class="n">QIB_LED_LOG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcstatus_a</span><span class="p">);</span>
		<span class="n">grn</span> <span class="o">=</span> <span class="n">qib_7322_phys_portstate</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IB_PHYSPORTSTATE_LINKUP</span><span class="p">;</span>
		<span class="n">yel</span> <span class="o">=</span> <span class="n">qib_7322_iblink_state</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="n">IB_PORT_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">grn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">yel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">extctl</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
		<span class="o">~</span><span class="n">ExtLED_IB1_MASK</span> <span class="o">:</span> <span class="o">~</span><span class="n">ExtLED_IB2_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">extctl</span> <span class="o">|=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">ExtLED_IB1_GRN</span> <span class="o">:</span> <span class="n">ExtLED_IB2_GRN</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Counts are in chip clock (4ns) periods.</span>
<span class="cm">		 * This is 1/16 sec (66.6ms) on,</span>
<span class="cm">		 * 3/16 sec (187.5 ms) off, with packets rcvd.</span>
<span class="cm">		 */</span>
		<span class="n">ledblink</span> <span class="o">=</span> <span class="p">((</span><span class="mi">66600</span> <span class="o">*</span> <span class="mi">1000UL</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_LEDBLINK_ON_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="mi">187500</span> <span class="o">*</span> <span class="mi">1000UL</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_LEDBLINK_OFF_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yel</span><span class="p">)</span>
		<span class="n">extctl</span> <span class="o">|=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">ExtLED_IB1_YEL</span> <span class="o">:</span> <span class="n">ExtLED_IB2_YEL</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">=</span> <span class="n">extctl</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ledblink</span><span class="p">)</span> <span class="cm">/* blink the LED on packet receive */</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rcvpktledcnt</span><span class="p">,</span> <span class="n">ledblink</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable MSIx interrupt if enabled, call generic MSIx code</span>
<span class="cm"> * to cleanup, and clear pending MSIx interrupts.</span>
<span class="cm"> * Used for fallback to INTx, after reset, and when MSIx setup fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_nomsix</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">intgranted</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">main_int_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">irq_set_affinity_hint</span><span class="p">(</span>
			  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msix</span><span class="p">.</span><span class="n">vector</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msix</span><span class="p">.</span><span class="n">vector</span><span class="p">,</span>
			   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qib_nomsix</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* make sure no MSIx interrupts are left pending */</span>
	<span class="n">intgranted</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intgranted</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intgranted</span><span class="p">)</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intgranted</span><span class="p">,</span> <span class="n">intgranted</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_7322_nomsix</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_setup_7322_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">qib_7322_free_irq</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendchkenable</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendgrhchk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendibchk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">QSFP_GPIO_MOD_PRS_N</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">QSFP_GPIO_MOD_PRS_N</span> <span class="o">&lt;&lt;</span> <span class="n">QSFP_GPIO_PORT2_SHIFT</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_QSFP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_mask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">qib_qsfp_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ibport_data</span><span class="p">.</span><span class="n">smi_ah</span><span class="p">)</span>
			<span class="n">ib_destroy_ah</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ibport_data</span><span class="p">.</span><span class="n">smi_ah</span><span class="o">-&gt;</span><span class="n">ibah</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* handle SDMA interrupts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_7322_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">istat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">intr0</span> <span class="o">=</span> <span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDma</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaIdle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaProgress</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">u64</span> <span class="n">intr1</span> <span class="o">=</span> <span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDma</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaIdle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaProgress</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr0</span><span class="p">)</span>
		<span class="n">qib_sdma_intr</span><span class="p">(</span><span class="n">ppd0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr1</span><span class="p">)</span>
		<span class="n">qib_sdma_intr</span><span class="p">(</span><span class="n">ppd1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INT_MASK_PM</span><span class="p">(</span><span class="n">SDmaCleanupDone</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd0</span><span class="p">,</span> <span class="n">qib_sdma_event_e20_hw_started</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INT_MASK_PM</span><span class="p">(</span><span class="n">SDmaCleanupDone</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd1</span><span class="p">,</span> <span class="n">qib_sdma_event_e20_hw_started</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set or clear the Send buffer available interrupt enable bit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_wantpiobuf_7322_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">needint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needint</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendIntBufAvail</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendIntBufAvail</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Somehow got an interrupt with reserved bits set in interrupt status.</span>
<span class="cm"> * Print a message so we know it happened, then clear them.</span>
<span class="cm"> * keep mainline interrupt handler cache-friendly</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">unknown_7322_ibits</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">istat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">kills</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="n">kills</span> <span class="o">=</span> <span class="n">istat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QIB_I_BITSEXTANT</span><span class="p">;</span>
	<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Clearing reserved interrupt(s) 0x%016llx:&quot;</span>
		    <span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">kills</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intmask</span><span class="p">,</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">int_enable_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">kills</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* keep mainline interrupt handler cache-friendly */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">unknown_7322_gpio_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpiostatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pidx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Boards for this chip currently don&#39;t use GPIO interrupts,</span>
<span class="cm">	 * so clear by writing GPIOstatus to GPIOclear, and complain</span>
<span class="cm">	 * to developer.  To avoid endless repeats, clear</span>
<span class="cm">	 * the bits in the mask, since there is some kind of</span>
<span class="cm">	 * programming error or chip problem.</span>
<span class="cm">	 */</span>
	<span class="n">gpiostatus</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_status</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * In theory, writing GPIOstatus to GPIOclear could</span>
<span class="cm">	 * have a bad side-effect on some diagnostic that wanted</span>
<span class="cm">	 * to poll for a status-change, but the various shadows</span>
<span class="cm">	 * make that problematic at best. Diags will just suppress</span>
<span class="cm">	 * all GPIO interrupts during such tests.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_clear</span><span class="p">,</span> <span class="n">gpiostatus</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check for QSFP MOD_PRS changes</span>
<span class="cm">	 * only works for single port if IB1 != pidx1</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_QSFP</span><span class="p">);</span>
	     <span class="o">++</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">qib_qsfp_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">link_speed_supported</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">QSFP_GPIO_MOD_PRS_N</span><span class="p">;</span>
		<span class="n">ppd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">QSFP_GPIO_PORT2_SHIFT</span> <span class="o">*</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">pins</span><span class="p">;</span>
			<span class="n">qd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">;</span>
			<span class="n">gpiostatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
			<span class="n">pins</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extstatus</span><span class="p">);</span>
			<span class="n">pins</span> <span class="o">&gt;&gt;=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">EXTStatus</span><span class="p">,</span> <span class="n">GPIOIn</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">handled</span><span class="p">;</span>
				<span class="n">qd</span><span class="o">-&gt;</span><span class="n">t_insert</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">ib_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">handled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_mask</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">gpio_irq</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">gpiostatus</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear any troublemakers, and update chip from shadow</span>
<span class="cm">		 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio_irq</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_mask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle errors and unusual events first, separate function</span>
<span class="cm"> * to improve cache hits for fast path interrupt handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">unlikely_7322_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">istat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QIB_I_BITSEXTANT</span><span class="p">)</span>
		<span class="n">unknown_7322_ibits</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">QIB_I_GPIO</span><span class="p">)</span>
		<span class="n">unknown_7322_gpio_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">QIB_I_C_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">error_tasklet</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">Err</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">handle_7322_p_errors</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ppd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">Err</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">handle_7322_p_errors</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ppd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dynamically adjust the rcv int timeout for a context based on incoming</span>
<span class="cm"> * packet rate.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_rcv_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npkts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvavail_timeout</span><span class="p">[</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dynamically adjust idle timeout on chip</span>
<span class="cm">	 * based on number of packets processed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npkts</span> <span class="o">&lt;</span> <span class="n">rcv_int_count</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">npkts</span> <span class="o">&gt;=</span> <span class="n">rcv_int_count</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">rcv_int_timeout</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rcv_int_timeout</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvavail_timeout</span><span class="p">[</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvavailtimeout</span> <span class="o">+</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the main interrupt handler.</span>
<span class="cm"> * It will normally only be used for low frequency interrupts but may</span>
<span class="cm"> * have to handle all interrupts if INTx is enabled or fewer than normal</span>
<span class="cm"> * MSIx interrupts were allocated.</span>
<span class="cm"> * This routine should ignore the interrupt bits for any of the</span>
<span class="cm"> * dedicated MSIx handlers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qib_7322intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">istat</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctxtrbits</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">npkts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">istat</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">istat</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_bad_intrstatus</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Interrupt status all f&#39;s, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* don&#39;t know if it was our interrupt or not */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">istat</span> <span class="o">&amp;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">main_int_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">istat</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* already handled, or shared and not us */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* handle &quot;errors&quot; of various kinds first, device ahead of port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">QIB_I_BITSEXTANT</span> <span class="o">|</span> <span class="n">QIB_I_GPIO</span> <span class="o">|</span>
			      <span class="n">QIB_I_C_ERROR</span> <span class="o">|</span> <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">Err</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">Err</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
		<span class="n">unlikely_7322_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt bits we found set, relatively early, so we</span>
<span class="cm">	 * &quot;know&quot; know the chip will have seen this by the time we process</span>
<span class="cm">	 * the queue, and will re-interrupt if necessary.  The processor</span>
<span class="cm">	 * itself won&#39;t take the interrupt again until we return.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle kernel receive queues before checking for pio buffers</span>
<span class="cm">	 * available since receives can overflow; piobuf waiters can afford</span>
<span class="cm">	 * a few extra cycles, since they were waiting anyway.</span>
<span class="cm">	 */</span>
	<span class="n">ctxtrbits</span> <span class="o">=</span> <span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_I_RCVAVAIL_MASK</span> <span class="o">|</span> <span class="n">QIB_I_RCVURG_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxtrbits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_I_RCVAVAIL_LSB</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_I_RCVURG_LSB</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctxtrbits</span> <span class="o">&amp;</span> <span class="n">rmask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ctxtrbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rmask</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="n">qib_kreceive</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npkts</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxtrbits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctxtrbits</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxtrbits</span> <span class="o">&gt;&gt;</span> <span class="n">QIB_I_RCVAVAIL_LSB</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">ctxtrbits</span> <span class="o">&gt;&gt;</span> <span class="n">QIB_I_RCVURG_LSB</span><span class="p">);</span>
			<span class="n">qib_handle_urcv</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ctxtrbits</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_I_P_SDMAINT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">QIB_I_P_SDMAINT</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">sdma_7322_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">QIB_I_SPIOBUFAVAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_INITTED</span><span class="p">))</span>
		<span class="n">qib_ib_piobufavail</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dedicated receive packet available interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qib_7322pintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">npkts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt bit we expect to be set. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_I_RCVAVAIL_LSB</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_I_RCVURG_LSB</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="n">qib_kreceive</span><span class="p">(</span><span class="n">rcd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npkts</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dedicated Send buffer available interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qib_7322bufavail</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt bit we expect to be set. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="n">QIB_I_SPIOBUFAVAIL</span><span class="p">);</span>

	<span class="cm">/* qib_ib_piobufavail() will clear the want PIO interrupt if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_INITTED</span><span class="p">)</span>
		<span class="n">qib_ib_piobufavail</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qib_wantpiobuf_7322_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dedicated Send DMA interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdma_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt bit we expect to be set. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span> <span class="o">?</span>
		       <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDma</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDma</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">qib_sdma_intr</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dedicated Send DMA idle interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdma_idle_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt bit we expect to be set. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span> <span class="o">?</span>
		       <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaIdle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaIdle</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">qib_sdma_intr</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dedicated Send DMA progress interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdma_progress_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt bit we expect to be set. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span> <span class="o">?</span>
		       <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaProgress</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>
		       <span class="n">INT_MASK_P</span><span class="p">(</span><span class="n">SDmaProgress</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">qib_sdma_intr</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dedicated Send DMA cleanup interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdma_cleanup_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt bit we expect to be set. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span> <span class="o">?</span>
		       <span class="n">INT_MASK_PM</span><span class="p">(</span><span class="n">SDmaCleanupDone</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>
		       <span class="n">INT_MASK_PM</span><span class="p">(</span><span class="n">SDmaCleanupDone</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">qib_sdma_event_e20_hw_started</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up our chip-specific interrupt handler.</span>
<span class="cm"> * The interrupt type has already been setup, so</span>
<span class="cm"> * we just need to do the registration and error checking.</span>
<span class="cm"> * If we are using MSIx interrupts, we may fall back to</span>
<span class="cm"> * INTx later, if the interrupt handler doesn&#39;t get called</span>
<span class="cm"> * within 1/2 second (see verify_interrupt()).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_setup_7322_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clearpend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">msixnum</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">redirect</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">local_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">firstcpu</span><span class="p">,</span> <span class="n">secondcpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">currrcvcpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clearpend</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if not switching interrupt types, be sure interrupts are</span>
<span class="cm">		 * disabled, and then clear anything pending at this point,</span>
<span class="cm">		 * because we are starting clean.</span>
<span class="cm">		 */</span>
		<span class="n">qib_7322_set_intr_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* clear the reset error, init error/hwerror mask */</span>
		<span class="n">qib_7322_init_hwerrors</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

		<span class="cm">/* clear any interrupt bits that might be set */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>

		<span class="cm">/* make sure no pending MSIx intr, and clear diag reg */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intgranted</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_vecclr_wo_int</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Try to get INTx interrupt */</span>
<span class="nl">try_intx:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;irq is 0, BIOS error?  &quot;</span>
				    <span class="s">&quot;Interrupts won&#39;t work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qib_7322intr</span><span class="p">,</span>
				  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">QIB_DRV_NAME</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t setup INTx &quot;</span>
				    <span class="s">&quot;interrupt (irq=%d): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">main_int_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to get MSIx interrupts */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">redirect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">redirect</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
	<span class="n">msixnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_mask</span> <span class="o">=</span> <span class="n">cpumask_of_pcibus</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">firstcpu</span> <span class="o">=</span> <span class="n">cpumask_first</span><span class="p">(</span><span class="n">local_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">firstcpu</span> <span class="o">&gt;=</span> <span class="n">nr_cpu_ids</span> <span class="o">||</span>
			<span class="n">cpumask_weight</span><span class="p">(</span><span class="n">local_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_online_cpus</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">local_mask</span> <span class="o">=</span> <span class="n">topology_core_cpumask</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">firstcpu</span> <span class="o">=</span> <span class="n">cpumask_first</span><span class="p">(</span><span class="n">local_mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">firstcpu</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">secondcpu</span> <span class="o">=</span> <span class="n">cpumask_next</span><span class="p">(</span><span class="n">firstcpu</span><span class="p">,</span> <span class="n">local_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secondcpu</span> <span class="o">&gt;=</span> <span class="n">nr_cpu_ids</span><span class="p">)</span>
			<span class="n">secondcpu</span> <span class="o">=</span> <span class="n">firstcpu</span><span class="p">;</span>
		<span class="n">currrcvcpu</span> <span class="o">=</span> <span class="n">secondcpu</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">msixnum</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">sh</span><span class="p">;</span>

		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span>
			<span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
			<span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* skip if for a non-configured port */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">dd</span><span class="p">;</span>
			<span class="n">lsb</span> <span class="o">=</span> <span class="n">irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lsb</span><span class="p">;</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="n">irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
				 <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">QIB_DRV_NAME</span> <span class="s">&quot;%d%s&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
				<span class="n">irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">ctxt</span><span class="p">;</span>

			<span class="n">ctxt</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_table</span><span class="p">);</span>
			<span class="cm">/* per krcvq context receive interrupt */</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qib_krcvq01_no_msi</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">lsb</span> <span class="o">=</span> <span class="n">QIB_I_RCVAVAIL_LSB</span> <span class="o">+</span> <span class="n">ctxt</span><span class="p">;</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="n">qib_7322pintr</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
				 <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">QIB_DRV_NAME</span> <span class="s">&quot;%d (kctx)&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">msix</span><span class="p">.</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
			<span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Shouldn&#39;t happen since the enable said we could</span>
<span class="cm">			 * have as many as we are trying to setup here.</span>
<span class="cm">			 */</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t setup MSIx &quot;</span>
				<span class="s">&quot;interrupt (vec=%d, irq=%d): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msixnum</span><span class="p">,</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">msix</span><span class="p">.</span><span class="n">vector</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
			<span class="n">qib_7322_nomsix</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">try_intx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">lsb</span> <span class="o">/</span> <span class="n">IBA7322_REDIRECT_VEC_PER_REG</span><span class="p">;</span>
			<span class="n">sh</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsb</span> <span class="o">%</span> <span class="n">IBA7322_REDIRECT_VEC_PER_REG</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IntRedirect0</span><span class="p">,</span> <span class="n">vec1</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">lsb</span><span class="p">);</span>
			<span class="n">redirect</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">msixnum</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sh</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">msixnum</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">QIB_7322_MsixTable_OFFS</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">firstcpu</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span> <span class="o">&amp;&amp;</span>
			<span class="n">zalloc_cpumask_var</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handler</span> <span class="o">==</span> <span class="n">qib_7322pintr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">currrcvcpu</span><span class="p">,</span>
					<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">mask</span><span class="p">);</span>
				<span class="n">currrcvcpu</span> <span class="o">=</span> <span class="n">cpumask_next</span><span class="p">(</span><span class="n">currrcvcpu</span><span class="p">,</span>
					<span class="n">local_mask</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currrcvcpu</span> <span class="o">&gt;=</span> <span class="n">nr_cpu_ids</span><span class="p">)</span>
					<span class="n">currrcvcpu</span> <span class="o">=</span> <span class="n">secondcpu</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">firstcpu</span><span class="p">,</span>
					<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">mask</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">irq_set_affinity_hint</span><span class="p">(</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">msix</span><span class="p">.</span><span class="n">vector</span><span class="p">,</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">msixnum</span><span class="p">].</span><span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msixnum</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize the vector mapping */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">redirect</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intredirect</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">redirect</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">main_int_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">error_tasklet</span><span class="p">,</span> <span class="n">qib_error_tasklet</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dd</span><span class="p">);</span>
<span class="nl">bail:</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7322_boardname - fill in the board name and note features</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> *</span>
<span class="cm"> * info will be based on the board revision register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">qib_7322_boardname</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Will need enumeration of board-types here */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">boardid</span><span class="p">,</span> <span class="n">namelen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">features</span> <span class="o">=</span> <span class="n">DUAL_PORT_CAP</span><span class="p">;</span>

	<span class="n">boardid</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision</span><span class="p">,</span> <span class="n">BoardID</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">boardid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QLE7342_Emulation&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QLE7340&quot;</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_HAS_QSFP</span><span class="p">;</span>
		<span class="n">features</span> <span class="o">=</span> <span class="n">PORT_SPD_CAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QLE7342&quot;</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_HAS_QSFP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QMI7342&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_Unsupported7342&quot;</span><span class="p">;</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Unsupported version of QMH7342</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOARD_QMH7342</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QMH7342&quot;</span><span class="p">;</span>
		<span class="n">features</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOARD_QME7342</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QME7342&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QME7362&quot;</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_HAS_QSFP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QLE7342_TEST&quot;</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_HAS_QSFP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QLE73xy_UNKNOWN&quot;</span><span class="p">;</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Unknown 7322 board type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boardid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">board_atten</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* index into txdds_Xdr */</span>

	<span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">namelen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed allocation for board name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardversion</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardversion</span><span class="p">),</span>
		 <span class="s">&quot;ChipABI %u.%u, %s, InfiniPath%u %u.%u, SW Compat %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">QIB_CHIP_VERS_MAJ</span><span class="p">,</span> <span class="n">QIB_CHIP_VERS_MIN</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span> <span class="n">Arch</span><span class="p">),</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">majrev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span> <span class="n">SW</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_singleport</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">features</span> <span class="o">&gt;&gt;</span> <span class="n">PORT_SPD_CAP_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_SPD_CAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;IB%u: Forced to single port mode&quot;</span>
			    <span class="s">&quot; by module parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="n">PORT_SPD_CAP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine sleeps, so it can only be called from user context, not</span>
<span class="cm"> * from interrupt context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_do_7322_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">msix_vecsave</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">msix_entries</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmdval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">int_line</span><span class="p">,</span> <span class="n">clinesz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Use dev_err so it shows up in logs, etc. */</span>
	<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Resetting InfiniPath unit %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">qib_pcie_getcmd</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">int_line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clinesz</span><span class="p">);</span>

	<span class="n">msix_entries</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span><span class="p">;</span>

	<span class="cm">/* no interrupts till re-initted */</span>
	<span class="n">qib_7322_set_intr_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msix_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_7322_nomsix</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="cm">/* can be up to 512 bytes, too big for stack */</span>
		<span class="n">msix_vecsave</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msix_vecsave</span><span class="p">)</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No mem to save MSIx data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">msix_vecsave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Core PCI (as of 2.6.18) doesn&#39;t save or rewrite the full vector</span>
<span class="cm">	 * info that is set up by the BIOS, so we have to save and restore</span>
<span class="cm">	 * it ourselves.   There is some risk something could change it,</span>
<span class="cm">	 * after we save it, but since we have disabled the MSIx, it</span>
<span class="cm">	 * shouldn&#39;t be touched...</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msix_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">vecaddr</span><span class="p">,</span> <span class="n">vecdata</span><span class="p">;</span>
		<span class="n">vecaddr</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">QIB_7322_MsixTable_OFFS</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)));</span>
		<span class="n">vecdata</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">QIB_7322_MsixTable_OFFS</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msix_vecsave</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msix_vecsave</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vecaddr</span><span class="p">;</span>
			<span class="cm">/* save it without the masked bit set */</span>
			<span class="n">msix_vecsave</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vecdata</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x100000000ULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfdelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* so we check interrupts work again */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Keep chip from being accessed until we are ready.  Use</span>
<span class="cm">	 * writeq() directly, to allow the write even though QIB_PRESENT</span>
<span class="cm">	 * isn&#39;t set.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QIB_INITTED</span> <span class="o">|</span> <span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_DOING_RESET</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|</span> <span class="n">QLOGIC_IB_C_RESET</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">kr_control</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allow MBIST, etc. to complete; longer on each retry.</span>
<span class="cm">		 * We sometimes get machine checks from bus timeout if no</span>
<span class="cm">		 * response, so for now, make it *really* long.</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3000</span><span class="p">);</span>

		<span class="n">qib_pcie_reenable</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cmdval</span><span class="p">,</span> <span class="n">int_line</span><span class="p">,</span> <span class="n">clinesz</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use readq directly, so we don&#39;t need to mark it as PRESENT</span>
<span class="cm">		 * until we get a successful indication that all is well.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">kr_revision</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed to initialize after reset, &quot;</span>
				    <span class="s">&quot;unusable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span>  <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_PRESENT</span><span class="p">;</span> <span class="cm">/* it&#39;s back */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msix_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* restore the MSIx vector address and data if saved above */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msix_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msix</span><span class="p">.</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msix_vecsave</span> <span class="o">||</span> <span class="o">!</span><span class="n">msix_vecsave</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">QIB_7322_MsixTable_OFFS</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)),</span>
				<span class="n">msix_vecsave</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">QIB_7322_MsixTable_OFFS</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)),</span>
				<span class="n">msix_vecsave</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* initialize the remaining registers.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">write_7322_init_portregs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">write_7322_initregs</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_pcie_params</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_width</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span><span class="p">,</span>
			    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">))</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Reset failed to setup PCIe or interrupts; &quot;</span>
				<span class="s">&quot;continuing anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qib_setup_7322_interrupt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_FORCE_NOTIFY</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">bail:</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_DOING_RESET</span><span class="p">;</span> <span class="cm">/* OK or not, no longer resetting */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msix_vecsave</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7322_put_tid - write a TID to the chip</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @tidptr: pointer to the expected TID (in chip) to update</span>
<span class="cm"> * @tidtype: 0 for eager, 1 for expected</span>
<span class="cm"> * @pa: physical address of in memory buffer; tidinvalid if freeing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_put_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tidptr</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidinvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">chippa</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="n">IBA7322_TID_PA_SHIFT</span><span class="p">;</span>

		<span class="cm">/* paranoia checks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">!=</span> <span class="p">(</span><span class="n">chippa</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_TID_PA_SHIFT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Physaddr %lx not 2KB aligned!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pa</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chippa</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_TID_SZ_SHIFT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Physical page address 0x%lx &quot;</span>
				<span class="s">&quot;larger than supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RCVHQ_RCV_TYPE_EAGER</span><span class="p">)</span>
			<span class="n">chippa</span> <span class="o">|=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidtemplate</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* for now, always full 4KB page */</span>
			<span class="n">chippa</span> <span class="o">|=</span> <span class="n">IBA7322_TID_SZ_4K</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">chippa</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">tidptr</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7322_clear_tids - clear all TID entries for a ctxt, expected and eager</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @ctxt: the ctxt</span>
<span class="cm"> *</span>
<span class="cm"> * clear all TID entries for a ctxt, expected and eager.</span>
<span class="cm"> * Used from qib_close().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_clear_tids</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tidbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tidinv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">||</span> <span class="o">!</span><span class="n">rcd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctxt</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">;</span>

	<span class="n">tidinv</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidinvalid</span><span class="p">;</span>
	<span class="n">tidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidbase</span> <span class="o">+</span>
		 <span class="n">ctxt</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidcnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tidbase</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qib_7322_put_tid</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tidbase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RCVHQ_RCV_TYPE_EXPECTED</span><span class="p">,</span>
				 <span class="n">tidinv</span><span class="p">);</span>

	<span class="n">tidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbase</span> <span class="o">+</span>
		 <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegr_tid_base</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tidbase</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qib_7322_put_tid</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tidbase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RCVHQ_RCV_TYPE_EAGER</span><span class="p">,</span>
				 <span class="n">tidinv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7322_tidtemplate - setup constants for TID updates</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> *</span>
<span class="cm"> * We setup stuff that we use a lot, to avoid calculating each time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_tidtemplate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * For now, we always allocate 4KB buffers (at init) so we can</span>
<span class="cm">	 * receive max size packets.  We may want a module parameter to</span>
<span class="cm">	 * specify 2KB or 4KB and/or make it per port instead of per device</span>
<span class="cm">	 * for those who want to reduce memory footprint.  Note that the</span>
<span class="cm">	 * rcvhdrentsize size must be large enough to hold the largest</span>
<span class="cm">	 * IB header (currently 96 bytes) that we expect to handle (plus of</span>
<span class="cm">	 * course the 2 dwords of RHF).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span> <span class="o">==</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidtemplate</span> <span class="o">=</span> <span class="n">IBA7322_TID_SZ_2K</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidtemplate</span> <span class="o">=</span> <span class="n">IBA7322_TID_SZ_4K</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidinvalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_init_7322_get_base_info - set chip-specific flags for user code</span>
<span class="cm"> * @rcd: the qlogic_ib ctxt</span>
<span class="cm"> * @kbase: qib_base_info pointer</span>
<span class="cm"> *</span>
<span class="cm"> * We set the PCIE flag because the lower bandwidth on PCIe vs</span>
<span class="cm"> * HyperTransport can affect some user packet algorithims.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_get_base_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">qib_base_info</span> <span class="o">*</span><span class="n">kinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kinfo</span><span class="o">-&gt;</span><span class="n">spi_runtime_flags</span> <span class="o">|=</span> <span class="n">QIB_RUNTIME_CTXT_MSB_IN_QP</span> <span class="o">|</span>
		<span class="n">QIB_RUNTIME_PCIE</span> <span class="o">|</span> <span class="n">QIB_RUNTIME_NODMA_RTAIL</span> <span class="o">|</span>
		<span class="n">QIB_RUNTIME_HDRSUPP</span> <span class="o">|</span> <span class="n">QIB_RUNTIME_SDMA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
		<span class="n">kinfo</span><span class="o">-&gt;</span><span class="n">spi_runtime_flags</span> <span class="o">|=</span> <span class="n">QIB_RUNTIME_RCHK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_USE_SPCL_TRIG</span><span class="p">)</span>
		<span class="n">kinfo</span><span class="o">-&gt;</span><span class="n">spi_runtime_flags</span> <span class="o">|=</span> <span class="n">QIB_RUNTIME_SPECIAL_TRIGGER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qib_message_header</span> <span class="o">*</span>
<span class="nf">qib_7322_get_msgheader</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">rhf_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">qib_hdrget_offset</span><span class="p">(</span><span class="n">rhf_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_message_header</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">rhf_addr</span> <span class="o">-</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhf_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure number of contexts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_config_ctxts</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nchipctxts</span><span class="p">;</span>

	<span class="n">nchipctxts</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_contextcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">numctxts</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_n_krcv_queues</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">=</span> <span class="n">NUM_IB_PORTS</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">qib_n_krcv_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">&gt;</span> <span class="n">nchipctxts</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">n_krcv_queues</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">/</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">=</span> <span class="n">NUM_IB_PORTS</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">n_krcv_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_cfgctxts</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nctxts</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">+</span> <span class="n">num_online_cpus</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nctxts</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nctxts</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nctxts</span> <span class="o">&lt;=</span> <span class="n">nchipctxts</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qib_cfgctxts</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qib_cfgctxts</span> <span class="o">&lt;=</span> <span class="n">nchipctxts</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="n">qib_cfgctxts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span><span class="p">)</span> <span class="cm">/* none of the above, set to max */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Chip can be configured for 6, 10, or 18 ctxts, and choice</span>
<span class="cm">	 * affects number of eager TIDs per ctxt (1K, 2K, 4K).</span>
<span class="cm">	 * Lock to be paranoid about later motion, etc.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="mi">2ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">ContextCfg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">ContextCfg</span><span class="p">);</span>
	<span class="cm">/* else configure for default 6 receive ctxts */</span>

	<span class="cm">/* The XRC opcode is 5. */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="mi">5ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">XrcTypeCode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * RcvCtrl *must* be written here so that the</span>
<span class="cm">	 * chip understands how to change rcvegrcnt below.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* kr_rcvegrcnt changes based on the number of contexts enabled */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvegrcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_rcvhdrcnt</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrcnt</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">,</span> <span class="n">qib_rcvhdrcnt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrcnt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">,</span>
				    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1024U</span> <span class="o">:</span> <span class="mi">2048U</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_get_ib_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">maskr</span><span class="p">;</span> <span class="cm">/* right-justified mask */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LWID_ENB</span>: <span class="cm">/* Get allowed Link-width */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LWID</span>: <span class="cm">/* Get currently active Link-width */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_SPD_ENB</span>: <span class="cm">/* Get allowed Link speeds */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_SPD</span>: <span class="cm">/* Get current Link spd */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_RXPOL_ENB</span>: <span class="cm">/* Get Auto-RX-polarity enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_POLARITY_REV_SUPP</span><span class="p">);</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_POLARITY_REV_SUPP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LREV_ENB</span>: <span class="cm">/* Get Auto-Lane-reversal enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_LANE_REV_SUPPORTED</span><span class="p">);</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_LANE_REV_SUPPORTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LINKLATENCY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcstatus_b</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusB_0</span><span class="p">,</span> <span class="n">LinkRoundTripLatency</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_OP_VLS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_operational</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_VL_HIGH_CAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_VL_LOW_CAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_OVERRUN_THRESH</span>: <span class="cm">/* IB overrun threshold */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">,</span> <span class="n">IBCCtrlA_0</span><span class="p">,</span>
				<span class="n">OverrunThreshold</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PHYERR_THRESH</span>: <span class="cm">/* IB PHY error threshold */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">,</span> <span class="n">IBCCtrlA_0</span><span class="p">,</span>
				<span class="n">PhyerrThreshold</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LINKDEFAULT</span>: <span class="cm">/* IB link default (sleep/poll) */</span>
		<span class="cm">/* will only take effect when the link state changes */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;</span>
		       <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">LinkDownDefaultState</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">IB_LINKINITCMD_SLEEP</span> <span class="o">:</span> <span class="n">IB_LINKINITCMD_POLL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_HRTBT</span>: <span class="cm">/* Get Heartbeat off/enable/auto */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7322_IBC_HRTBT_LSB</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7322_IBC_HRTBT_RMASK</span><span class="p">;</span> <span class="cm">/* OR of AUTO and ENB */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PMA_TICKS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 0x00 = 10x link transfer rate or 4 nsec. for 2.5Gbs</span>
<span class="cm">		 * Since the clock is always 250MHz, the value is 3, 1 or 0.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_QDR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">&gt;&gt;</span> <span class="n">lsb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">maskr</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Below again cribbed liberally from older version. Do not lean</span>
<span class="cm"> * heavily on it.</span>
<span class="cm"> */</span>
<span class="cp">#define IBA7322_IBC_DLIDLMC_SHIFT QIB_7322_IBCCtrlB_0_IB_DLID_LSB</span>
<span class="cp">#define IBA7322_IBC_DLIDLMC_MASK (QIB_7322_IBCCtrlB_0_IB_DLID_RMASK \</span>
<span class="cp">	| (QIB_7322_IBCCtrlB_0_IB_DLID_MASK_RMASK &lt;&lt; 16))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_set_ib_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">maskr</span><span class="p">;</span> <span class="cm">/* right-justified mask */</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lcmd</span><span class="p">,</span> <span class="n">licmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QIB_IB_CFG_LIDLMC</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Set LID and LMC. Combined to avoid possible hazard</span>
<span class="cm">		 * caller puts LMC in 16MSbits, DLID in 16LSbits of val</span>
<span class="cm">		 */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7322_IBC_DLIDLMC_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7322_IBC_DLIDLMC_MASK</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * For header-checking, the SLID in the packet will</span>
<span class="cm">		 * be masked with SendIBSLMCMask, and compared</span>
<span class="cm">		 * with SendIBSLIDAssignMask. Make sure we do not</span>
<span class="cm">		 * set any bits not covered by the mask, or we get</span>
<span class="cm">		 * false-positives.</span>
<span class="cm">		 */</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendslid</span><span class="p">,</span>
				    <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SendIBSLIDAssignMask</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendslidmask</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SendIBSLMCMask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LWID_ENB</span>: <span class="cm">/* set allowed Link-width */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="cm">/* convert IB value to chip register value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IB_WIDTH_1X</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IB_WIDTH_4X</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_NUM_CHANNELS</span><span class="p">);</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_NUM_CHANNELS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_SPD_ENB</span>: <span class="cm">/* set allowed Link speeds */</span>
		<span class="cm">/*</span>
<span class="cm">		 * As with width, only write the actual register if the</span>
<span class="cm">		 * link is currently down, otherwise takes effect on next</span>
<span class="cm">		 * link change.  Since setting is being explicitly requested</span>
<span class="cm">		 * (via MAD or sysfs), clear autoneg failure status if speed</span>
<span class="cm">		 * autoneg is enabled.</span>
<span class="cm">		 */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="n">IBA7322_IBC_SPEED_LSB</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7322_IBC_SPEED_MASK</span> <span class="o">|</span> <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span> <span class="o">|</span>
			<span class="n">IBA7322_IBC_MAX_SPEED_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Muliple speeds enabled */</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span> <span class="o">|</span>
				<span class="n">IBA7322_IBC_MAX_SPEED_MASK</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IBA7322_IBC_SPEED_QDR</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span><span class="p">;</span>
		<span class="cm">/* IBTA 1.2 mode + min/max + speed bits are contiguous */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_ENHANCED_MODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_RXPOL_ENB</span>: <span class="cm">/* set Auto-RX-polarity enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_POLARITY_REV_SUPP</span><span class="p">);</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_POLARITY_REV_SUPP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LREV_ENB</span>: <span class="cm">/* set Auto-Lane-reversal enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_LANE_REV_SUPPORTED</span><span class="p">);</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBCCtrlB_0</span><span class="p">,</span> <span class="n">IB_LANE_REV_SUPPORTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_OVERRUN_THRESH</span>: <span class="cm">/* IB overrun threshold */</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">,</span> <span class="n">IBCCtrlA_0</span><span class="p">,</span>
				  <span class="n">OverrunThreshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maskr</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">OverrunThreshold</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&lt;&lt;</span>
				<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">OverrunThreshold</span><span class="p">);</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span>
					    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PHYERR_THRESH</span>: <span class="cm">/* IB PHY error threshold */</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">,</span> <span class="n">IBCCtrlA_0</span><span class="p">,</span>
				  <span class="n">PhyerrThreshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maskr</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">PhyerrThreshold</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&lt;&lt;</span>
				<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">PhyerrThreshold</span><span class="p">);</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span>
					    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PKEYS</span>: <span class="cm">/* update pkeys */</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_partitionkey</span><span class="p">,</span> <span class="n">maskr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LINKDEFAULT</span>: <span class="cm">/* IB link default (sleep/poll) */</span>
		<span class="cm">/* will only take effect when the link state changes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IB_LINKINITCMD_POLL</span><span class="p">)</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">LinkDownDefaultState</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/* SLEEP */</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|=</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">LinkDownDefaultState</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_MTU</span>: <span class="cm">/* update the MTU in IBC */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Update our housekeeping variables, and set IBC max</span>
<span class="cm">		 * size, same as init code; max IBC is max we allow in</span>
<span class="cm">		 * buffer, less the qword pbc, plus 1 for ICRC, in dwords</span>
<span class="cm">		 * Set even if it&#39;s unchanged, print debug message only</span>
<span class="cm">		 * on changes.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">ibmaxlen</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">MaxPktLen</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&lt;&lt;</span>
			<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">MaxPktLen</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span>
				    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LSTATE</span>: <span class="cm">/* set the IB link state */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IB_LINKCMD_DOWN</span>:
			<span class="n">lcmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfusesnap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfsnap</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">crp_errlink</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">&amp;&amp;</span>
			    <span class="n">qib_compat_ddr_negotiate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span> <span class="o">=</span>
					<span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
							      <span class="n">crp_ibsymbolerr</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span> <span class="o">=</span>
					<span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
						      <span class="n">crp_iblinkerrrecov</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKCMD_ARMED</span>:
			<span class="n">lcmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_ARMED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfusesnap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfusesnap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfdelta</span> <span class="o">+=</span>
					<span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
							      <span class="n">crp_errlink</span><span class="p">)</span> <span class="o">-</span>
					<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfsnap</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKCMD_ACTIVE</span>:
			<span class="n">lcmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_ACTIVE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;bad linkcmd req 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IB_LINKINITCMD_NOP</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKINITCMD_POLL</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_POLL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKINITCMD_SLEEP</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SLEEP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKINITCMD_DISABLE</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * stop state chase counter and timer, if running.</span>
<span class="cm">			 * wait forpending timer, but don&#39;t clear .data (ppd)!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;bad linkinitcmd req 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">lcmd</span><span class="p">,</span> <span class="n">licmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_OP_VLS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_operational</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_operational</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">set_vls</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_VL_HIGH_LIMIT</span>:
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_highprio_limit</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_HRTBT</span>: <span class="cm">/* set Heartbeat off/enable/auto */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7322_IBC_HRTBT_LSB</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7322_IBC_HRTBT_RMASK</span><span class="p">;</span> <span class="cm">/* OR of AUTO and ENB */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PORT</span>:
		<span class="cm">/* val is the port number of the switch we are connected to. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_work</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">maskr</span> <span class="o">&lt;&lt;</span> <span class="n">lsb</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">maskr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">lsb</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_b</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_set_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctrlb</span><span class="p">;</span>

	<span class="cm">/* only IBC loopback, may add serdes and xgxs loopbacks later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="s">&quot;ibc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span>
						       <span class="n">Loopback</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* disable heart beat, so link will come up */</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Enabling IB%u:%u IBC loopback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span>
							<span class="n">Loopback</span><span class="p">);</span>
		<span class="cm">/* enable heart beat again */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">IBA7322_IBC_HRTBT_RMASK</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_IBC_HRTBT_LSB</span><span class="p">;</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Disabling IB%u:%u IBC loopback &quot;</span>
			    <span class="s">&quot;(normal)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span>
				    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
		<span class="n">ctrlb</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IBA7322_IBC_HRTBT_MASK</span>
					     <span class="o">&lt;&lt;</span> <span class="n">IBA7322_IBC_HRTBT_LSB</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">=</span> <span class="n">ctrlb</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_b</span><span class="p">,</span>
				    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_vl_weights</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ib_vl_weight_elem</span> <span class="o">*</span><span class="n">vl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">regno</span><span class="o">++</span><span class="p">,</span> <span class="n">vl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>

		<span class="n">vl</span><span class="o">-&gt;</span><span class="n">vl</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">VirtualLane</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">VirtualLane</span><span class="p">);</span>
		<span class="n">vl</span><span class="o">-&gt;</span><span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">Weight</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">Weight</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_vl_weights</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ib_vl_weight_elem</span> <span class="o">*</span><span class="n">vl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">regno</span><span class="o">++</span><span class="p">,</span> <span class="n">vl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">vl</span><span class="o">-&gt;</span><span class="n">vl</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">VirtualLane</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
			<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">VirtualLane</span><span class="p">))</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">vl</span><span class="o">-&gt;</span><span class="n">weight</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">Weight</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
			<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">LowPriority0_0</span><span class="p">,</span> <span class="n">Weight</span><span class="p">));</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">IBVLArbiterEn</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">IBVLArbiterEn</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_get_ib_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QIB_IB_TBL_VL_HIGH_ARB</span>:
		<span class="n">get_vl_weights</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_highprio_0</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_TBL_VL_LOW_ARB</span>:
		<span class="n">get_vl_weights</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_lowprio_0</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_set_ib_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QIB_IB_TBL_VL_HIGH_ARB</span>:
		<span class="n">set_vl_weights</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_highprio_0</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_TBL_VL_LOW_ARB</span>:
		<span class="n">set_vl_weights</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_lowprio_0</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_update_7322_usrhead</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">hd</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">updegr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">egrhd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">npkts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Need to write timeout register before updating rcvhdrhead to ensure</span>
<span class="cm">	 * that the timer is enabled on reception of a packet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">&gt;&gt;</span> <span class="n">IBA7322_HDRHEAD_PKTINT_SHIFT</span><span class="p">)</span>
		<span class="n">adjust_rcv_timeout</span><span class="p">(</span><span class="n">rcd</span><span class="p">,</span> <span class="n">npkts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">updegr</span><span class="p">)</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvegrindexhead</span><span class="p">,</span> <span class="n">egrhd</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_7322_hdrqempty</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvhdrtail_kvaddr</span><span class="p">)</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">qib_get_rcvhdrtail</span><span class="p">(</span><span class="n">rcd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrtail</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">head</span> <span class="o">==</span> <span class="n">tail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RCVCTRL_COMMON_MODS (QIB_RCVCTRL_CTXT_ENB | \</span>
<span class="cp">	QIB_RCVCTRL_CTXT_DIS | \</span>
<span class="cp">	QIB_RCVCTRL_TIDFLOW_ENB | \</span>
<span class="cp">	QIB_RCVCTRL_TIDFLOW_DIS | \</span>
<span class="cp">	QIB_RCVCTRL_TAILUPD_ENB | \</span>
<span class="cp">	QIB_RCVCTRL_TAILUPD_DIS | \</span>
<span class="cp">	QIB_RCVCTRL_INTRAVAIL_ENB | \</span>
<span class="cp">	QIB_RCVCTRL_INTRAVAIL_DIS | \</span>
<span class="cp">	QIB_RCVCTRL_BP_ENB | \</span>
<span class="cp">	QIB_RCVCTRL_BP_DIS)</span>

<span class="cp">#define RCVCTRL_PORT_MODS (QIB_RCVCTRL_CTXT_ENB | \</span>
<span class="cp">	QIB_RCVCTRL_CTXT_DIS | \</span>
<span class="cp">	QIB_RCVCTRL_PKEY_DIS | \</span>
<span class="cp">	QIB_RCVCTRL_PKEY_ENB)</span>

<span class="cm">/*</span>
<span class="cm"> * Modify the RCVCTRL register in chip-specific way. This</span>
<span class="cm"> * is a function because bit positions and (future) register</span>
<span class="cm"> * location is chip-specifc, but the needed operations are</span>
<span class="cm"> * generic. &lt;op&gt; is a bit-mask because we often want to</span>
<span class="cm"> * do multiple modifications.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rcvctrl_7322_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_TIDFLOW_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">TidFlowEnable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_TIDFLOW_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">TidFlowEnable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_TAILUPD_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">TailUpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_TAILUPD_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">TailUpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_PKEY_ENB</span><span class="p">)</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl_0</span><span class="p">,</span> <span class="n">RcvPartitionKeyDisable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_PKEY_DIS</span><span class="p">)</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl_0</span><span class="p">,</span> <span class="n">RcvPartitionKeyDisable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rcd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="n">rcd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_ENB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl_0</span><span class="p">,</span> <span class="n">ContextEnableKernel</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_NODMA_RTAIL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">op</span> <span class="o">|=</span> <span class="n">QIB_RCVCTRL_TAILUPD_ENB</span><span class="p">;</span> <span class="cm">/* need reg write */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">TailUpd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Write these registers before the context is enabled. */</span>
		<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">krc_rcvhdrtailaddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
				    <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvhdrqtailaddr_phys</span><span class="p">);</span>
		<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">krc_rcvhdraddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
				    <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvhdrq_phys</span><span class="p">);</span>
		<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">seq_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_DIS</span><span class="p">)</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl_0</span><span class="p">,</span> <span class="n">ContextEnableKernel</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_BP_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">dontDropRHQFull</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_BP_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">dontDropRHQFull</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_INTRAVAIL_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">IntrAvail</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_INTRAVAIL_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">IntrAvail</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Decide which registers to write depending on the ops enabled.</span>
<span class="cm">	 * Special case is &quot;flush&quot; (no bits set at all)</span>
<span class="cm">	 * which needs to write both.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">RCVCTRL_COMMON_MODS</span><span class="p">))</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">RCVCTRL_PORT_MODS</span><span class="p">))</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rcvctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_ENB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Init the context registers also; if we were</span>
<span class="cm">		 * disabled, tail and head should both be zero</span>
<span class="cm">		 * already from the enable, but since we don&#39;t</span>
<span class="cm">		 * know, we have to do it explicitly.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvegrindextail</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvegrindexhead</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>

		<span class="cm">/* be sure enabling write seen; hd/tl should be 0 */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrtail</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="cm">/* If kctxt, interrupt on next receive. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span><span class="p">;</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_INTRAVAIL_ENB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* arm rcv interrupt */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">|</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span><span class="p">;</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_DIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">f</span><span class="p">;</span>

		<span class="cm">/* Now that the context is disabled, clear these registers. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">krc_rcvhdrtailaddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">krc_rcvhdraddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">NUM_TIDFLOWS_CTXT</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
				<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvflowtable</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span>
					       <span class="n">TIDFLOW_ERRBITS</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">krc_rcvhdrtailaddr</span><span class="p">,</span>
						    <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">krc_rcvhdraddr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">NUM_TIDFLOWS_CTXT</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
					<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvflowtable</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span>
						       <span class="n">TIDFLOW_ERRBITS</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Modify the SENDCTRL register in chip-specific way. This</span>
<span class="cm"> * is a function where there are multiple such registers with</span>
<span class="cm"> * slightly different layouts.</span>
<span class="cm"> * The chip doesn&#39;t allow back-to-back sendctrl writes, so write</span>
<span class="cm"> * the scratch register after writing sendctrl.</span>
<span class="cm"> *</span>
<span class="cm"> * Which register is written depends on the operation.</span>
<span class="cm"> * Most operate on the common register, while</span>
<span class="cm"> * SEND_ENB and SEND_DIS operate on the per-port ones.</span>
<span class="cm"> * SEND_ENB is included in common because it can change SPCL_TRIG</span>
<span class="cm"> */</span>
<span class="cp">#define SENDCTRL_COMMON_MODS (\</span>
<span class="cp">	QIB_SENDCTRL_CLEAR | \</span>
<span class="cp">	QIB_SENDCTRL_AVAIL_DIS | \</span>
<span class="cp">	QIB_SENDCTRL_AVAIL_ENB | \</span>
<span class="cp">	QIB_SENDCTRL_AVAIL_BLIP | \</span>
<span class="cp">	QIB_SENDCTRL_DISARM | \</span>
<span class="cp">	QIB_SENDCTRL_DISARM_ALL | \</span>
<span class="cp">	QIB_SENDCTRL_SEND_ENB)</span>

<span class="cp">#define SENDCTRL_PORT_MODS (\</span>
<span class="cp">	QIB_SENDCTRL_CLEAR | \</span>
<span class="cp">	QIB_SENDCTRL_SEND_ENB | \</span>
<span class="cp">	QIB_SENDCTRL_SEND_DIS | \</span>
<span class="cp">	QIB_SENDCTRL_FLUSH)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sendctrl_7322_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp_dd_sendctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* First the dd ones that are &quot;sticky&quot;, saved in shadow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_CLEAR</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_ENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_USE_SPCL_TRIG</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SpecialTriggerEn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Then the ppd ones that are &quot;sticky&quot;, saved in shadow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_SEND_DIS</span><span class="p">)</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SendEnable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_SEND_ENB</span><span class="p">)</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">SendEnable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_DISARM_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

		<span class="n">tmp_dd_sendctrl</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">+</span> <span class="n">NUM_VL15_BUFS</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disarm any buffers that are not yet launched,</span>
<span class="cm">		 * disabling updates until done.</span>
<span class="cm">		 */</span>
		<span class="n">tmp_dd_sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span>
				       <span class="n">tmp_dd_sendctrl</span> <span class="o">|</span>
				       <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">Disarm</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp_ppd_sendctrl</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now drain all the fifos.  The Abort bit should never be</span>
<span class="cm">		 * needed, so for now, at least, we don&#39;t use it.</span>
<span class="cm">		 */</span>
		<span class="n">tmp_ppd_sendctrl</span> <span class="o">|=</span>
			<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeDrainRmFifo</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeDrainLaFifo</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">TxeBypassIbc</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendctrl</span><span class="p">,</span> <span class="n">tmp_ppd_sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp_dd_sendctrl</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_DISARM</span><span class="p">)</span>
		<span class="n">tmp_dd_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">Disarm</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_7322_SendCtrl_DisarmSendBuf_RMASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			 <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">DisarmSendBuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">)))</span>
		<span class="n">tmp_dd_sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">SENDCTRL_COMMON_MODS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">tmp_dd_sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">SENDCTRL_PORT_MODS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * ensure writes have hit chip, then do a few</span>
<span class="cm">		 * more reads, to allow DMA of pioavail registers</span>
<span class="cm">		 * to occur, so in-memory copy is in sync with</span>
<span class="cm">		 * the chip.  Not always safe to sleep.</span>
<span class="cm">		 */</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define _PORT_VIRT_FLAG 0x8000U </span><span class="cm">/* &quot;virtual&quot;, need adjustments */</span><span class="cp"></span>
<span class="cp">#define _PORT_64BIT_FLAG 0x10000U </span><span class="cm">/* not &quot;virtual&quot;, but 64bit */</span><span class="cp"></span>
<span class="cp">#define _PORT_CNTR_IDXMASK 0x7fffU </span><span class="cm">/* mask off flags above */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * qib_portcntr_7322 - read a per-port chip counter</span>
<span class="cm"> * @ppd: the qlogic_ib pport</span>
<span class="cm"> * @creg: the counter to read (not a chip offset)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">qib_portcntr_7322</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">creg</span><span class="p">;</span>
	<span class="cm">/* 0xffff for unimplemented or synthesized counters */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">xlator</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PKTSEND</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_pktsend</span> <span class="o">|</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_WORDSEND</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_wordsend</span> <span class="o">|</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSXMITDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_psxmitdatacount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSXMITPKTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_psxmitpktscount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSXMITWAIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_psxmitwaitcount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_SENDSTALL</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_sendstall</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PKTRCV</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_pktrcv</span> <span class="o">|</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSRCVDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_psrcvdatacount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSRCVPKTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_psrcvpktscount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RCVEBP</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_rcvebp</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RCVOVFL</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_rcvovfl</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_WORDRCV</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_wordrcv</span> <span class="o">|</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RXDROPPKT</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="cm">/* not needed  for 7322 */</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RXLOCALPHYERR</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_rxotherlocalphyerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RXVLERR</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_rxvlerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRICRC</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_erricrc</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRVCRC</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_errvcrc</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRLPCRC</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_errlpcrc</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_BADFORMAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_badformat</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERR_RLEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_err_rlen</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_IBSYMBOLERR</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_ibsymbolerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_INVALIDRLEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_invalidrlen</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_UNSUPVL</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_txunsupvl</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_EXCESSBUFOVFL</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_excessbufferovfl</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRLINK</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_errlink</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_IBLINKDOWN</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_iblinkdown</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_IBLINKERRRECOV</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_iblinkerrrecov</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_LLI</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_locallinkintegrityerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_VL15PKTDROP</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_vl15droppedpkt</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRPKEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp_errpkey</span><span class="p">,</span>
		<span class="cm">/*</span>
<span class="cm">		 * the next 3 aren&#39;t really counters, but were implemented</span>
<span class="cm">		 * as counters in older chips, so still get accessed as</span>
<span class="cm">		 * though they were counters from this code.</span>
<span class="cm">		 */</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSINTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">krp_psinterval</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSSTART</span><span class="p">]</span> <span class="o">=</span> <span class="n">krp_psstart</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSSTAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">krp_psstat</span><span class="p">,</span>
		<span class="cm">/* pseudo-counter, summed for all ports */</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_KHDROVFL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xlator</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			 <span class="s">&quot;Unimplemented portcounter %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">creg</span> <span class="o">=</span> <span class="n">xlator</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">_PORT_CNTR_IDXMASK</span><span class="p">;</span>

	<span class="cm">/* handle non-counters and special cases first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">QIBPORTCNTR_KHDROVFL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* sum over all kernel contexts (skip if mini_init) */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcd</span> <span class="o">||</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ppd</span> <span class="o">!=</span> <span class="n">ppd</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">read_7322_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">QIBPORTCNTR_RXDROPPKT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Used as part of the synthesis of port_rcv_errors</span>
<span class="cm">		 * in the verbs code for IBTA counters.  Not needed for 7322,</span>
<span class="cm">		 * because all the errors are already counted by other cntrs.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">QIBPORTCNTR_PSINTERVAL</span> <span class="o">||</span>
		   <span class="n">reg</span> <span class="o">==</span> <span class="n">QIBPORTCNTR_PSSTART</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">QIBPORTCNTR_PSSTAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* were counters in older chips, now per-port kernel regs */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only fast increment counters are 64 bits; use 32 bit reads to</span>
<span class="cm">	 * avoid two independent reads when on Opteron.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xlator</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_7322_creg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">creg</span> <span class="o">==</span> <span class="n">crp_ibsymbolerr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">-=</span> <span class="n">ret</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">creg</span> <span class="o">==</span> <span class="n">crp_iblinkerrrecov</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">-=</span> <span class="n">ret</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">creg</span> <span class="o">==</span> <span class="n">crp_errlink</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfdelta</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">creg</span> <span class="o">==</span> <span class="n">crp_iblinkdown</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkdowndelta</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Device counter names (not port-specific), one line per stat,</span>
<span class="cm"> * single string.  Used by utilities like ipathstats to print the stats</span>
<span class="cm"> * in a way which works for different versions of drivers, without changing</span>
<span class="cm"> * the utility.  Names need to be 12 chars or less (w/o newline), for proper</span>
<span class="cm"> * display by utility.</span>
<span class="cm"> * Non-error counters are first.</span>
<span class="cm"> * Start of &quot;error&quot; conters is indicated by a leading &quot;E &quot; on the first</span>
<span class="cm"> * &quot;error&quot; counter, and doesn&#39;t count in label length.</span>
<span class="cm"> * The EgrOvfl list needs to be last so we truncate them at the configured</span>
<span class="cm"> * context count for the device.</span>
<span class="cm"> * cntr7322indices contains the corresponding register indices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cntr7322names</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Interrupts</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;HostBusStall</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;E RxTIDFull</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxTIDInvalid</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxTIDFloDrop</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* 7322 only */</span>
	<span class="s">&quot;Ctxt0EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt1EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt2EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt3EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt4EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt5EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt6EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt7EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt8EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt9EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx10EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx11EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx12EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx13EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx14EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx15EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx16EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx17EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">cntr7322indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">cr_lbint</span> <span class="o">|</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">,</span>
	<span class="n">cr_lbstall</span> <span class="o">|</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">,</span>
	<span class="n">cr_tidfull</span><span class="p">,</span>
	<span class="n">cr_tidinvalid</span><span class="p">,</span>
	<span class="n">cr_rxtidflowdrop</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span>
	<span class="n">cr_base_egrovfl</span> <span class="o">+</span> <span class="mi">17</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * same as cntr7322names and cntr7322indices, but for port-specific counters.</span>
<span class="cm"> * portcntr7322indices is somewhat complicated by some registers needing</span>
<span class="cm"> * adjustments of various kinds, and those are ORed with _PORT_VIRT_FLAG</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">portcntr7322names</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;TxPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxFlowPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxWords</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxFlowPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxWords</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxFlowStall</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxDmaDesc</span><span class="se">\n</span><span class="s">&quot;</span>  <span class="cm">/* 7220 and 7322-only */</span>
	<span class="s">&quot;E RxDlidFltr</span><span class="se">\n</span><span class="s">&quot;</span>  <span class="cm">/* 7220 and 7322-only */</span>
	<span class="s">&quot;IBStatusChng</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBLinkDown</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBLnkRecov</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBRxLinkErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBSymbolErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxLLIErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxBadFormat</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxBadLen</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxBufOvrfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxEBP</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxFlowCtlErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxICRCerr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxLPCRCerr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxVCRCerr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxInvalLen</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxInvalPKey</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxPktDropped</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxBadLength</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxDropped</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxInvalLen</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxUnderrun</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxUnsupVL</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxLclPhyErr</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* 7220 and 7322-only from here down */</span>
	<span class="s">&quot;RxVL15Drop</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxVlErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;XcessBufOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxQPBadCtxt</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* 7322-only from here down */</span>
	<span class="s">&quot;TXBadHeader</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">portcntr7322indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">QIBPORTCNTR_PKTSEND</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">crp_pktsendflow</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_WORDSEND</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_PKTRCV</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">crp_pktrcvflowctrl</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_WORDRCV</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_SENDSTALL</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">crp_txsdmadesc</span> <span class="o">|</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">,</span>
	<span class="n">crp_rxdlidfltr</span><span class="p">,</span>
	<span class="n">crp_ibstatuschange</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_IBLINKDOWN</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_IBLINKERRRECOV</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRLINK</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_IBSYMBOLERR</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_LLI</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_BADFORMAT</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERR_RLEN</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RCVOVFL</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RCVEBP</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">crp_rcvflowctrlviol</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRICRC</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRLPCRC</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRVCRC</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_INVALIDRLEN</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRPKEY</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RXDROPPKT</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">crp_txminmaxlenerr</span><span class="p">,</span>
	<span class="n">crp_txdroppedpkt</span><span class="p">,</span>
	<span class="n">crp_txlenerr</span><span class="p">,</span>
	<span class="n">crp_txunderrun</span><span class="p">,</span>
	<span class="n">crp_txunsupvl</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RXLOCALPHYERR</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_VL15PKTDROP</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RXVLERR</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_EXCESSBUFOVFL</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">crp_rxqpinvalidctxt</span><span class="p">,</span>
	<span class="n">crp_txhdrerr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* do all the setup to make the counter reads efficient later */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_7322_cntrnames</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cntr7322names</span><span class="p">;</span> <span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we always have at least one counter before the egrovfl */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;Ctxt0EgrOvfl&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="p">)</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="cm">/* full list; size is without terminating null */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrnamelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cntr7322names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrnamelen</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="n">cntr7322names</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span>
		<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed allocation for counters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">portcntr7322names</span><span class="p">;</span> <span class="n">s</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrnamelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">portcntr7322names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span>
			<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span><span class="p">)</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed allocation for&quot;</span>
				    <span class="s">&quot; portcounters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_read_7322cntrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">namep</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="o">**</span><span class="n">cntrp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">namep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrnamelen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* final read after getting everything */</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cntr7322names</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">cntr</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cntr</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* everything read, or couldn&#39;t get memory */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">cntrp</span> <span class="o">=</span> <span class="n">cntr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">)</span>
				<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_7322_creg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
							 <span class="n">cntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
							 <span class="n">_PORT_CNTR_IDXMASK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_7322_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
							   <span class="n">cntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_read_7322portcntrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">**</span><span class="n">namep</span><span class="p">,</span> <span class="n">u64</span> <span class="o">**</span><span class="n">cntrp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">namep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrnamelen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* final read after getting everything */</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">portcntr7322names</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">cntr</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cntr</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* everything read, or couldn&#39;t get memory */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">cntrp</span> <span class="o">=</span> <span class="n">cntr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">portcntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">)</span>
				<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">qib_portcntr_7322</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
					<span class="n">portcntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="n">_PORT_CNTR_IDXMASK</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">portcntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">_PORT_64BIT_FLAG</span><span class="p">)</span>
				<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_7322_creg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
					   <span class="n">portcntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					    <span class="n">_PORT_CNTR_IDXMASK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
					   <span class="n">portcntr7322indices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_get_7322_faststats - get word counters from chip before they overflow</span>
<span class="cm"> * @opaque - contains a pointer to the qlogic_ib device qib_devdata</span>
<span class="cm"> *</span>
<span class="cm"> * VESTIGIAL IBA7322 has no &quot;small fast counters&quot;, so the only</span>
<span class="cm"> * real purpose of this function is to maintain the notion of</span>
<span class="cm"> * &quot;active time&quot;, which in turn is only logged into the eeprom,</span>
<span class="cm"> * which we don;t have, yet, for 7322-based boards.</span>
<span class="cm"> *</span>
<span class="cm"> * called from add_timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_get_7322_faststats</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">opaque</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">traffic_wds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pidx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If port isn&#39;t enabled or not operational ports, or</span>
<span class="cm">		 * diags is running (can cause memory diags to fail)</span>
<span class="cm">		 * skip this port this time.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_INITTED</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Maintain an activity timer, based on traffic</span>
<span class="cm">		 * exceeding a threshold, so we need to check the word-counts</span>
<span class="cm">		 * even if they are 64-bit.</span>
<span class="cm">		 */</span>
		<span class="n">traffic_wds</span> <span class="o">=</span> <span class="n">qib_portcntr_7322</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIBPORTCNTR_WORDRCV</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">qib_portcntr_7322</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIBPORTCNTR_WORDSEND</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">traffic_wds</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">traffic_wds</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">traffic_wds</span> <span class="o">+=</span> <span class="n">traffic_wds</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">traffic_wds</span> <span class="o">&gt;=</span> <span class="n">QIB_TRAFFIC_ACTIVE_THRESHOLD</span><span class="p">)</span>
			<span class="n">atomic_add</span><span class="p">(</span><span class="n">ACTIVITY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">active_time</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_on</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">&amp;</span>
						<span class="n">QIB_IB_QDR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_LINKINIT</span> <span class="o">|</span> <span class="n">QIBL_LINKARMED</span> <span class="o">|</span>
				    <span class="n">QIBL_LINKACTIVE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_time</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_is_before_jiffies</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
					    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">?</span>
					    <span class="n">QDR_STATIC_ADAPT_INIT_R1</span> <span class="o">:</span>
					    <span class="n">QDR_STATIC_ADAPT_INIT</span><span class="p">);</span>
			<span class="n">force_h1</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">ACTIVITY_TIMER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we were using MSIx, try to fallback to INTx.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_intr_fallback</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* already using INTx */</span>

	<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;MSIx interrupt not detected,&quot;</span>
		 <span class="s">&quot; trying INTx interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qib_7322_nomsix</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">qib_enable_intx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">qib_setup_7322_interrupt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the XGXS (between serdes and IBC).  Slightly less intrusive</span>
<span class="cm"> * than resetting the IBC or external link state, and useful in some</span>
<span class="cm"> * cases to cause some retraining.  To do this right, we reset IBC</span>
<span class="cm"> * as well, then return to previous state (which may be still in reset)</span>
<span class="cm"> * NOTE: some callers of this &quot;know&quot; this writes the current value</span>
<span class="cm"> * of cpspec-&gt;ibcctrl_a as part of it&#39;s operation, so if that changes,</span>
<span class="cm"> * check all callers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="n">reset_bits</span> <span class="o">=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBPCSConfig_0</span><span class="p">,</span> <span class="n">xcv_rreset</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBPCSConfig_0</span><span class="p">,</span> <span class="n">xcv_treset</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBPCSConfig_0</span><span class="p">,</span> <span class="n">tx_rx_reset</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ib_pcsconfig</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">statusValidNoEop</span><span class="p">));</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span>
			    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBLinkEn</span><span class="p">));</span>

	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ib_pcsconfig</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">reset_bits</span><span class="p">);</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ib_pcsconfig</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">reset_bits</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span>
		       <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrClear</span><span class="p">,</span> <span class="n">statusValidNoEopClear</span><span class="p">));</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This code for non-IBTA-compliant IB speed negotiation is only known to</span>
<span class="cm"> * work for the SDR to DDR transition, and only between an HCA and a switch</span>
<span class="cm"> * with recent firmware.  It is based on observed heuristics, rather than</span>
<span class="cm"> * actual knowledge of the non-compliant speed negotiation.</span>
<span class="cm"> * It has a number of hard-coded fields, since the hope is to rewrite this</span>
<span class="cm"> * when a spec is available on how the negoation is intended to work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">autoneg_7322_sendpkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">dcnt</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pbc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">piobuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">dcnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 7 dword header, dword data, icrc */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">qib_7322_setpbc_control</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">pbc</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">control</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">=</span> <span class="n">qib_7322_getsendbuf</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pnum</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* disable header check on this packet, since it can&#39;t be valid */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_txchk_change</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TXCHK_CHG_TYPE_DIS1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">pbc</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
	<span class="n">qib_flush_wc</span><span class="p">();</span>
	<span class="n">qib_pio_copy</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">qib_pio_copy</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_USE_SPCL_TRIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">spcl_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">pnum</span> <span class="o">&gt;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2047</span> <span class="o">:</span> <span class="mi">1023</span><span class="p">;</span>

		<span class="n">qib_flush_wc</span><span class="p">();</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xaebecede</span><span class="p">,</span> <span class="n">piobuf</span> <span class="o">+</span> <span class="n">spcl_off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qib_flush_wc</span><span class="p">();</span>
	<span class="n">qib_sendbuf_done</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pnum</span><span class="p">);</span>
	<span class="cm">/* and re-enable hdr check */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_txchk_change</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TXCHK_CHG_TYPE_ENAB1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * _start packet gets sent twice at start, _done gets sent twice at end</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_autoneg_7322_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">swapped</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hcnt</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xf002ffff</span><span class="p">,</span> <span class="mh">0x48ffff</span><span class="p">,</span> <span class="mh">0x6400abba</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">madpayload_start</span><span class="p">[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x1810103</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2c90000</span><span class="p">,</span> <span class="mh">0x2c9</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1388</span><span class="p">,</span> <span class="mh">0x15e</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="cm">/* rest 0&#39;s */</span>
		<span class="p">};</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">madpayload_done</span><span class="p">[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x1810103</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2c90000</span><span class="p">,</span> <span class="mh">0x2c9</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0x40000001</span><span class="p">,</span> <span class="mh">0x1388</span><span class="p">,</span> <span class="mh">0x15e</span><span class="p">,</span> <span class="cm">/* rest 0&#39;s */</span>
		<span class="p">};</span>

	<span class="n">dcnt</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">madpayload_start</span><span class="p">);</span>
	<span class="n">hcnt</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">swapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for maintainability, do it at runtime */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">madpayload_start</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">madpayload_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw</span><span class="p">;</span>
			<span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">madpayload_done</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">madpayload_done</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">swapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">which</span> <span class="o">?</span> <span class="n">madpayload_done</span> <span class="o">:</span> <span class="n">madpayload_start</span><span class="p">;</span>

	<span class="n">autoneg_7322_sendpkt</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">autoneg_7322_sendpkt</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do the absolute minimum to cause an IB speed change, and make it</span>
<span class="cm"> * ready, but don&#39;t actually trigger the change.   The caller will</span>
<span class="cm"> * do that when ready (if link is in Polling training state, it will</span>
<span class="cm"> * happen immediately, otherwise when link next goes down)</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should only be used as part of the DDR autonegotation</span>
<span class="cm"> * code for devices that are not compliant with IB 1.2 (or code that</span>
<span class="cm"> * fixes things up for same).</span>
<span class="cm"> *</span>
<span class="cm"> * When link has gone down, and autoneg enabled, or autoneg has</span>
<span class="cm"> * failed and we give up until next time we set both speeds, and</span>
<span class="cm"> * then we want IBTA enabled as well as &quot;use max enabled speed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_7322_ibspeed_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">newctrlb</span><span class="p">;</span>
	<span class="n">newctrlb</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IBA7322_IBC_SPEED_MASK</span> <span class="o">|</span>
				    <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span> <span class="o">|</span>
				    <span class="n">IBA7322_IBC_MAX_SPEED_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="cm">/* multiple speeds */</span>
		<span class="n">newctrlb</span> <span class="o">|=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_IBC_SPEED_LSB</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span> <span class="o">|</span>
				    <span class="n">IBA7322_IBC_MAX_SPEED_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">newctrlb</span> <span class="o">|=</span> <span class="n">speed</span> <span class="o">==</span> <span class="n">QIB_IB_QDR</span> <span class="o">?</span>
			<span class="n">IBA7322_IBC_SPEED_QDR</span> <span class="o">|</span> <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span> <span class="o">:</span>
			<span class="p">((</span><span class="n">speed</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span> <span class="o">?</span>
			  <span class="n">IBA7322_IBC_SPEED_DDR</span> <span class="o">:</span> <span class="n">IBA7322_IBC_SPEED_SDR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newctrlb</span> <span class="o">==</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">=</span> <span class="n">newctrlb</span><span class="p">;</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_b</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is only used when we are not talking to another</span>
<span class="cm"> * IB 1.2-compliant device that we think can do DDR.</span>
<span class="cm"> * (This includes all existing switch chips as of Oct 2007.)</span>
<span class="cm"> * 1.2-compliant devices go directly to DDR prior to reaching INIT</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">try_7322_autoneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qib_autoneg_7322_send</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_7322_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_DDR</span><span class="p">);</span>
	<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="cm">/* 2 msec is minimum length of a poll cycle */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ib_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_work</span><span class="p">,</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the empirically determined mechanism for auto-negotiation</span>
<span class="cm"> * of DDR speed with switches.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">autoneg_7322_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">startms</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ppd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qib_chippport_specific</span><span class="p">,</span>
			    <span class="n">autoneg_work</span><span class="p">.</span><span class="n">work</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ppd</span><span class="p">;</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="n">startms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Busy wait for this first part, it should be at most a</span>
<span class="cm">	 * few hundred usec, since we scheduled ourselves for 2msec.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lastibcstat</span><span class="p">,</span> <span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkState</span><span class="p">)</span>
		     <span class="o">==</span> <span class="n">IB_7322_LT_STATE_POLLQUIET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_set_linkstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_LINKDOWN_DISABLE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span> <span class="cm">/* we got there early or told to stop */</span>

	<span class="cm">/* we expect this to timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">,</span>
			       <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">),</span>
			       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">90</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="cm">/* we expect this to timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">,</span>
			       <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">),</span>
			       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1700</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

	<span class="n">set_7322_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_SDR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait up to 250 msec for link to train and get to INIT at DDR;</span>
<span class="cm">	 * this should terminate early.</span>
<span class="cm">	 */</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">,</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">),</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">));</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">==</span> <span class="n">AUTONEG_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_7322_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is used to request IPG set in the QLogic switch.</span>
<span class="cm"> * Only called if r1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">try_7322_ipg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_ibport</span> <span class="o">*</span><span class="n">ibp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">ibport_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">agent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_smp</span> <span class="o">*</span><span class="n">smp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">agent</span> <span class="o">=</span> <span class="n">ibp</span><span class="o">-&gt;</span><span class="n">send_agent</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="n">send_buf</span> <span class="o">=</span> <span class="n">ib_create_send_mad</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IB_MGMT_MAD_HDR</span><span class="p">,</span>
				      <span class="n">IB_MGMT_MAD_DATA</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">send_buf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibp</span><span class="o">-&gt;</span><span class="n">smi_ah</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ib_ah_attr</span> <span class="n">attr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ib_ah</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">attr</span><span class="p">);</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">dlid</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">IB_LID_PERMISSIVE</span><span class="p">);</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
		<span class="n">ah</span> <span class="o">=</span> <span class="n">ib_create_ah</span><span class="p">(</span><span class="n">ibp</span><span class="o">-&gt;</span><span class="n">qp0</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">send_buf</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>
			<span class="n">ibp</span><span class="o">-&gt;</span><span class="n">smi_ah</span> <span class="o">=</span> <span class="n">to_iah</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">send_buf</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ibp</span><span class="o">-&gt;</span><span class="n">smi_ah</span><span class="o">-&gt;</span><span class="n">ibah</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smp</span> <span class="o">=</span> <span class="n">send_buf</span><span class="o">-&gt;</span><span class="n">mad</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">base_version</span> <span class="o">=</span> <span class="n">IB_MGMT_BASE_VERSION</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">mgmt_class</span> <span class="o">=</span> <span class="n">IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">class_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">method</span> <span class="o">=</span> <span class="n">IB_MGMT_METHOD_SEND</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">hop_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">QIB_VENDOR_IPG</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">attr_mod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_post_send_mad</span><span class="p">(</span><span class="n">send_buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ib_free_send_mad</span><span class="p">(</span><span class="n">send_buf</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_tries</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ib_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_work</span><span class="p">,</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Timeout handler for setting IPG.</span>
<span class="cm"> * Only called if r1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipg_7322_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>

	<span class="n">ppd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qib_chippport_specific</span><span class="p">,</span>
			   <span class="n">ipg_work</span><span class="p">.</span><span class="n">work</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ppd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_LINKINIT</span> <span class="o">|</span> <span class="n">QIBL_LINKARMED</span> <span class="o">|</span> <span class="n">QIBL_LINKACTIVE</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_tries</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">try_7322_ipg</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_7322_iblink_state</span><span class="p">(</span><span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ibcs</span><span class="p">,</span> <span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkState</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_7322_L_STATE_INIT</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_INIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_7322_L_STATE_ARM</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_ARMED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_7322_L_STATE_ACTIVE</span>:
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">IB_7322_L_STATE_ACT_DEFER</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_ACTIVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">IB_7322_L_STATE_DOWN</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_DOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns the IBTA port state, rather than the IBC link training state */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">qib_7322_phys_portstate</span><span class="p">(</span><span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ibcs</span><span class="p">,</span> <span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkTrainingState</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qib_7322_physportstate</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_ib_updown</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ibup</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">symadj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mult</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_FORCE_NOTIFY</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Update our picture of width and speed from chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibcs</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkSpeedQDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">=</span> <span class="n">QIB_IB_QDR</span><span class="p">;</span>
		<span class="n">mult</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ibcs</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkSpeedActive</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">=</span> <span class="n">QIB_IB_DDR</span><span class="p">;</span>
		<span class="n">mult</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">=</span> <span class="n">QIB_IB_SDR</span><span class="p">;</span>
		<span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibcs</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusA_0</span><span class="p">,</span> <span class="n">LinkWidthActive</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span> <span class="o">=</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
		<span class="n">mult</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span> <span class="o">=</span> <span class="n">IB_WIDTH_1X</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">delay_mult</span> <span class="o">=</span> <span class="n">ib_rate_to_delay</span><span class="p">[</span><span class="n">mult_to_ib_rate</span><span class="p">(</span><span class="n">mult</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">clr</span><span class="p">;</span>

		<span class="cm">/* Link went down. */</span>
		<span class="cm">/* do IPG MAD again after linkdown, even if last time failed */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clr</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcstatus_b</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusB_0</span><span class="p">,</span> <span class="n">heartbeat_timed_out</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCStatusB_0</span><span class="p">,</span> <span class="n">heartbeat_crosstalk</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clr</span><span class="p">)</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcstatus_b</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_IB_AUTONEG_FAILED</span> <span class="o">|</span>
				     <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)))</span>
			<span class="n">set_7322_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">qib_qsfp_data</span> <span class="o">*</span><span class="n">qd</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">;</span>
			<span class="cm">/* unlock the Tx settings, speed may change */</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_tx_deemph_override</span><span class="p">,</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
				<span class="n">reset_tx_deemphasis_override</span><span class="p">));</span>
			<span class="n">qib_cancel_sends</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
			<span class="cm">/* on link down, ensure sane pcs state */</span>
			<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
			<span class="cm">/* schedule the qsfp refresh which should turn the link</span>
<span class="cm">			   off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_QSFP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qd</span><span class="o">-&gt;</span><span class="n">t_insert</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">ib_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__qib_sdma_running</span><span class="p">(</span><span class="n">ppd</span><span class="p">))</span>
				<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
					<span class="n">qib_sdma_event_e70_go_idle</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clr</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_iblinkdown</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clr</span> <span class="o">==</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkdownsnap</span><span class="p">)</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkdowndelta</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qib_compat_ddr_negotiate</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_IB_AUTONEG_FAILED</span> <span class="o">|</span>
				     <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_SDR</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">&amp;</span> <span class="n">QIB_IB_DDR</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">&lt;</span> <span class="n">AUTONEG_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we are SDR, and auto-negotiation enabled */</span>
			<span class="o">++</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">+=</span>
					<span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
						<span class="n">crp_ibsymbolerr</span><span class="p">)</span> <span class="o">-</span>
						<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span><span class="p">;</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">+=</span>
					<span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
						<span class="n">crp_iblinkerrrecov</span><span class="p">)</span> <span class="o">-</span>
						<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">try_7322_autoneg</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* no other IB status change processing */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_SDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_autoneg_7322_send</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_7322_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_DDR</span><span class="p">);</span>
			<span class="n">qib_7322_mini_pcs_reset</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* no other IB status change processing */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">&amp;</span> <span class="n">QIB_IB_DDR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QIBL_IB_AUTONEG_INPROG</span> <span class="o">|</span>
					 <span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* re-enable SDR, for next link down */</span>
			<span class="n">set_7322_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">);</span>
			<span class="n">symadj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Clear autoneg failure flag, and do setup</span>
<span class="cm">			 * so we&#39;ll try next time link goes down and</span>
<span class="cm">			 * back to INIT (possibly connected to a</span>
<span class="cm">			 * different device).</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_b</span> <span class="o">|=</span> <span class="n">IBA7322_IBC_IBTA_1_2_MASK</span><span class="p">;</span>
			<span class="n">symadj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">symadj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">&amp;&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ipg_tries</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">try_7322_ipg</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">recovery_init</span><span class="p">)</span>
				<span class="n">setup_7322_link_recovery</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">QDR_DFE_DISABLE_DELAY</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfusesnap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibmalfsnap</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
			<span class="n">crp_errlink</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symadj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkdownsnap</span> <span class="o">=</span>
			<span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">crp_iblinkdown</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">+=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">crp_ibsymbolerr</span><span class="p">)</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">+=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">crp_iblinkerrrecov</span><span class="p">)</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibup</span> <span class="o">&amp;&amp;</span> <span class="n">qib_compat_ddr_negotiate</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
			<span class="n">crp_ibsymbolerr</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span> <span class="o">=</span> <span class="n">read_7322_creg32_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
			<span class="n">crp_iblinkerrrecov</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">qib_setup_7322_setextled</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ibup</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Does read/modify/write to appropriate registers to</span>
<span class="cm"> * set output and direction bits selected by mask.</span>
<span class="cm"> * these are in their canonical postions (e.g. lsb of</span>
<span class="cm"> * dir will end up in D48 of extctrl on existing chips).</span>
<span class="cm"> * returns contents of GP Inputs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gpio_7322_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">out</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">read_val</span><span class="p">,</span> <span class="n">new_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some bits being written, lock access to GPIO */</span>
		<span class="n">dir</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">out</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">GPIOOe</span><span class="p">));</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dir</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">GPIOOe</span><span class="p">));</span>
		<span class="n">new_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_out</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_out</span><span class="p">,</span> <span class="n">new_out</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_out</span> <span class="o">=</span> <span class="n">new_out</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is unlikely that a read at this time would get valid</span>
<span class="cm">	 * data on a pin whose direction line was set in the same</span>
<span class="cm">	 * call to this function. We include the read here because</span>
<span class="cm">	 * that allows us to potentially combine a change on one pin with</span>
<span class="cm">	 * a read on another, and because the old code did something like</span>
<span class="cm">	 * this.</span>
<span class="cm">	 */</span>
	<span class="n">read_val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extstatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">read_val</span><span class="p">,</span> <span class="n">EXTStatus</span><span class="p">,</span> <span class="n">GPIOIn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable writes to config EEPROM, if possible. Returns previous state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_eeprom_wen</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prev_wen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_EEPROM_WEN_NUM</span><span class="p">;</span>
	<span class="n">prev_wen</span> <span class="o">=</span> <span class="o">~</span><span class="n">gpio_7322_mod</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">QIB_EEPROM_WEN_NUM</span><span class="p">;</span>
	<span class="n">gpio_7322_mod</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">wen</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">prev_wen</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read fundamental info we need to use the chip.  These are</span>
<span class="cm"> * the registers that describe chip capabilities, and are</span>
<span class="cm"> * saved in shadow registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_7322_chip_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">piobufs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_pagealign</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">uregbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_userregbase</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidcnt</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvtidcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvtidbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvegrbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobufbase</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpiobufbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio2k_bufbase</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobufbase</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpiobufcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpiosize</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize4k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">mtu</span> <span class="o">=</span> <span class="n">ib_mtu_enum_to_int</span><span class="p">(</span><span class="n">qib_ibmtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">QIB_DEFAULT_MTU</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ibmtu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mtu</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ibmtu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mtu</span><span class="p">;</span>

	<span class="cm">/* these may be adjusted in init_chip_wc_pat() */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio2kbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio2k_bufbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio4kbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span>
		 <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobufbase</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * 4K buffers take 2 pages; we use roundup just to be</span>
<span class="cm">	 * paranoid; we calculate it once here, rather than on</span>
<span class="cm">	 * ever buf allocate</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">align4k</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize4k</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">palign</span><span class="p">);</span>

	<span class="n">piobufs</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">NUM_VL15_BUFS</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavregs</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">piobufs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The chip base addresses in cspec and cpspec have to be set</span>
<span class="cm"> * after possible init_chip_wc_pat(), rather than in</span>
<span class="cm"> * get_7322_chip_params(), so split out as separate function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_set_baseaddrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cregbase</span><span class="p">;</span>
	<span class="n">cregbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_counterregbase</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">cregbase</span> <span class="o">+</span>
		<span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">egrtidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbase</span><span class="p">);</span>

	<span class="cm">/* port registers are defined as relative to base of chip */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">+</span>
		<span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">kr_counterregbase</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">cpregbase</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">kr_counterregbase</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a fairly special-purpose observer, so we only support</span>
<span class="cm"> * the port-specific parts of SendCtrl</span>
<span class="cm"> */</span>

<span class="cp">#define SENDCTRL_SHADOWED (SYM_MASK(SendCtrl_0, SendEnable) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl_0, SDmaEnable) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl_0, SDmaIntEnable) |	\</span>
<span class="cp">			   SYM_MASK(SendCtrl_0, SDmaSingleDescriptor) | \</span>
<span class="cp">			   SYM_MASK(SendCtrl_0, SDmaHalt) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl_0, IBVLArbiterEn) |	\</span>
<span class="cp">			   SYM_MASK(SendCtrl_0, ForceCreditUpToDate))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sendctrl_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">diag_observer</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offs</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">only_32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pidx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">local_data</span><span class="p">,</span> <span class="n">all_bits</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The fixed correspondence between Physical ports and pports is</span>
<span class="cm">	 * severed. We need to hunt for the ppd that corresponds</span>
<span class="cm">	 * to the offset we got. And we have to do that without admitting</span>
<span class="cm">	 * we know the stride, apparently.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">psptr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">psoffs</span><span class="p">;</span>

		<span class="n">ppd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">psptr</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">kpregbase</span> <span class="o">+</span> <span class="n">krp_sendctrl</span><span class="p">;</span>
		<span class="n">psoffs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">psptr</span> <span class="o">-</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psoffs</span> <span class="o">==</span> <span class="n">offs</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If pport is not being managed by driver, just avoid shadows. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">&gt;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span>
		<span class="n">ppd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* In any case, &quot;idx&quot; is flat index in kreg space */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>

	<span class="n">all_bits</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">only_32</span><span class="p">)</span>
		<span class="n">all_bits</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span> <span class="o">||</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">all_bits</span><span class="p">)</span> <span class="o">!=</span> <span class="n">all_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * At least some mask bits are zero, so we need</span>
<span class="cm">		 * to read. The judgement call is whether from</span>
<span class="cm">		 * reg or shadow. First-cut: read reg, and complain</span>
<span class="cm">		 * if any bits which should be shadowed are different</span>
<span class="cm">		 * from their shadowed value.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">only_32</span><span class="p">)</span>
			<span class="n">local_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">local_data</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * At least some mask bits are one, so we need</span>
<span class="cm">		 * to write, but only shadow some bits.</span>
<span class="cm">		 */</span>
		<span class="n">u64</span> <span class="n">sval</span><span class="p">,</span> <span class="n">tval</span><span class="p">;</span> <span class="cm">/* Shadowed, transient */</span>

		<span class="cm">/*</span>
<span class="cm">		 * New shadow val is bits we don&#39;t want to touch,</span>
<span class="cm">		 * ORed with bits we do, that are intended for shadow.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sval</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
			<span class="n">sval</span> <span class="o">|=</span> <span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SENDCTRL_SHADOWED</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">=</span> <span class="n">sval</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sval</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SENDCTRL_SHADOWED</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">tval</span> <span class="o">=</span> <span class="n">sval</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SENDCTRL_SHADOWED</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tval</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0Ull</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">only_32</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">diag_observer</span> <span class="n">sendctrl_0_observer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">sendctrl_hook</span><span class="p">,</span> <span class="n">KREG_IDX</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
	<span class="n">KREG_IDX</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">diag_observer</span> <span class="n">sendctrl_1_observer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">sendctrl_hook</span><span class="p">,</span> <span class="n">KREG_IDX</span><span class="p">(</span><span class="n">SendCtrl_1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
	<span class="n">KREG_IDX</span><span class="p">(</span><span class="n">SendCtrl_1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">sdma_fetch_prio</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">sdma_fetch_prio</span><span class="p">,</span> <span class="n">sdma_fetch_prio</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sdma_fetch_prio</span><span class="p">,</span> <span class="s">&quot;SDMA descriptor fetch priority&quot;</span><span class="p">);</span>

<span class="cm">/* Besides logging QSFP events, we set appropriate TxDDS values */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_txdds_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">override</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qsfp_7322_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_qsfp_data</span> <span class="o">*</span><span class="n">qd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pwrup</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">le2</span><span class="p">;</span>

	<span class="n">qd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qib_qsfp_data</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">ppd</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">ppd</span><span class="p">;</span>
	<span class="n">pwrup</span> <span class="o">=</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">t_insert</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">QSFP_PWR_LAG_MSEC</span> <span class="o">-</span> <span class="n">QSFP_MODPRS_LAG_MSEC</span><span class="p">);</span>

	<span class="cm">/* Delay for 20 msecs to allow ModPrs resistor to setup */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">QSFP_MODPRS_LAG_MSEC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_qsfp_mod_present</span><span class="p">(</span><span class="n">ppd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">.</span><span class="n">modpresent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Set the physical link to disabled */</span>
		<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_LINKV</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Some QSFP&#39;s not only do not respond until the full power-up</span>
<span class="cm">		 * time, but may behave badly if we try. So hold off responding</span>
<span class="cm">		 * to insertion.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_jiffies</span><span class="p">(</span><span class="n">pwrup</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_refresh_qsfp_cache</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Need to change LE2 back to defaults if we couldn&#39;t</span>
<span class="cm">		 * read the cable type (to handle cable swaps), so do this</span>
<span class="cm">		 * even on failure to read cable information.  We don&#39;t</span>
<span class="cm">		 * get here for QME, so IS_QME check not needed here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">QSFP_IS_ACTIVE_FAR</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">tech</span><span class="p">))</span>
				<span class="n">le2</span> <span class="o">=</span> <span class="n">LE2_QME</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">atten</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">qib_long_atten</span> <span class="o">&amp;&amp;</span>
				 <span class="n">QSFP_IS_CU</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">tech</span><span class="p">))</span>
				<span class="n">le2</span> <span class="o">=</span> <span class="n">LE2_5m</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">le2</span> <span class="o">=</span> <span class="n">LE2_DEFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">le2</span> <span class="o">=</span> <span class="n">LE2_DEFAULT</span><span class="p">;</span>
		<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="n">le2</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * We always change parameteters, since we can choose</span>
<span class="cm">		 * values for cables without eeproms, and the cable may have</span>
<span class="cm">		 * changed from a cable with full or partial eeprom content</span>
<span class="cm">		 * to one with partial or no content.</span>
<span class="cm">		 */</span>
		<span class="n">init_txdds_table</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* The physical link is being re-enabled only when the</span>
<span class="cm">		 * previous state was DISABLED and the VALID bit is not</span>
<span class="cm">		 * set. This should only happen when  the cable has been</span>
<span class="cm">		 * physically pulled. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">.</span><span class="n">modpresent</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_LINKV</span> <span class="o">|</span> <span class="n">QIBL_IB_LINK_DISABLED</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">.</span><span class="n">modpresent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SLEEP</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_LINKV</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * There is little we can do but complain to the user if QSFP</span>
<span class="cm"> * initialization fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_init_7322_qsfp</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_qsfp_data</span> <span class="o">*</span><span class="n">qd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mod_prs_bit</span> <span class="o">=</span> <span class="n">QSFP_GPIO_MOD_PRS_N</span><span class="p">;</span>

	<span class="n">mod_prs_bit</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">QSFP_GPIO_PORT2_SHIFT</span> <span class="o">*</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">);</span>
	<span class="n">qd</span><span class="o">-&gt;</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">ppd</span><span class="p">;</span>
	<span class="n">qib_qsfp_init</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="n">qsfp_7322_event</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mod_prs_bit</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">GPIOInvert</span><span class="p">));</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">|=</span> <span class="n">mod_prs_bit</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_mask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called at device initialization time, and also if the txselect</span>
<span class="cm"> * module parameter is changed.  This is used for cables that don&#39;t</span>
<span class="cm"> * have valid QSFP EEPROMs (not present, or attenuation is zero).</span>
<span class="cm"> * We initialize to the default, then if there is a specific</span>
<span class="cm"> * unit,port match, we use that (and set it immediately, for the</span>
<span class="cm"> * current speed, if the link is at INIT or better).</span>
<span class="cm"> * String format is &quot;default# unit#,port#=# ... u,p=#&quot;, separators must</span>
<span class="cm"> * be a SPACE character.  A newline terminates.  The u,p=# tuples may</span>
<span class="cm"> * optionally have &quot;u,p=#,#&quot;, where the final # is the H1 value</span>
<span class="cm"> * The last specific match is used (actually, all are used, but last</span>
<span class="cm"> * one is the one that winds up set); if none at all, fall back on default.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_no_qsfp_atten</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">nxt</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">deflt</span><span class="p">,</span> <span class="n">h1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">any</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seth1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txdds_size</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">txselect_list</span><span class="p">;</span>

	<span class="cm">/* default number is validated in setup_txselect() */</span>
	<span class="n">deflt</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">=</span> <span class="n">deflt</span><span class="p">;</span>

	<span class="n">txdds_size</span> <span class="o">=</span> <span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="n">TXDDS_EXTRA_SZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QME</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QMH</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
		<span class="n">txdds_size</span> <span class="o">+=</span> <span class="n">TXDDS_MFG_SZ</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nxt</span> <span class="o">&amp;&amp;</span> <span class="n">nxt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">str</span> <span class="o">=</span> <span class="o">++</span><span class="n">nxt</span><span class="p">;</span>
		<span class="n">unit</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nxt</span> <span class="o">==</span> <span class="n">str</span> <span class="o">||</span> <span class="o">!*</span><span class="n">nxt</span> <span class="o">||</span> <span class="o">*</span><span class="n">nxt</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nxt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">nxt</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="cm">/* skip to next, if any */</span>
				<span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">str</span> <span class="o">=</span> <span class="o">++</span><span class="n">nxt</span><span class="p">;</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nxt</span> <span class="o">==</span> <span class="n">str</span> <span class="o">||</span> <span class="o">*</span><span class="n">nxt</span> <span class="o">!=</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nxt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">nxt</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="cm">/* skip to next, if any */</span>
				<span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">str</span> <span class="o">=</span> <span class="o">++</span><span class="n">nxt</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nxt</span> <span class="o">==</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nxt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">nxt</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="cm">/* skip to next, if any */</span>
				<span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">txdds_size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">seth1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">h1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* gcc thinks it might be used uninitted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nxt</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">nxt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">str</span> <span class="o">=</span> <span class="o">++</span><span class="n">nxt</span><span class="p">;</span>
			<span class="n">h1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nxt</span> <span class="o">==</span> <span class="n">str</span><span class="p">)</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nxt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">nxt</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="cm">/* skip */</span>
					<span class="p">;</span>
			<span class="k">else</span>
				<span class="n">seth1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="n">unit</span> <span class="o">&amp;&amp;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>
		     <span class="o">++</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">port</span> <span class="o">||</span> <span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seth1</span><span class="p">)</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">h1_val</span> <span class="o">=</span> <span class="n">h1</span><span class="p">;</span>
			<span class="cm">/* now change the IBC and serdes, overriding generic */</span>
			<span class="n">init_txdds_table</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* Re-enable the physical state machine on mezz boards</span>
<span class="cm">			 * now that the correct settings have been set.</span>
<span class="cm">			 * QSFP boards are handles by the QSFP event handler */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QMH</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QME</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
				<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SLEEP</span><span class="p">);</span>
			<span class="n">any</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nxt</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* done */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">any</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no specific setting, use the default.</span>
<span class="cm">		 * Change the IBC and serdes, but since it&#39;s</span>
<span class="cm">		 * general, don&#39;t override specific settings.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">link_speed_supported</span><span class="p">)</span>
				<span class="n">init_txdds_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* handle the txselect parameter changing */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_txselect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_ATTEN_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span> <span class="s">&quot; txselect_values string &quot;</span>
		       <span class="s">&quot;too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">str</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="n">TXDDS_EXTRA_SZ</span> <span class="o">+</span>
				<span class="n">TXDDS_MFG_SZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span>
		       <span class="s">&quot;txselect_values must start with a number &lt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="n">TXDDS_EXTRA_SZ</span> <span class="o">+</span> <span class="n">TXDDS_MFG_SZ</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">txselect_list</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qib_dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">deviceid</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_IB_7322</span><span class="p">)</span>
			<span class="n">set_no_qsfp_atten</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write the final few registers that depend on some of the</span>
<span class="cm"> * init setup.  Done late in init, just before bringing up</span>
<span class="cm"> * the serdes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_late_7322_initreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrentsize</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrentsize</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrsize</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrsize</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrcnt</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrcnt</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpioavailaddr</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavailregs_phys</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpioavailaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavailregs_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Catastrophic software error, &quot;</span>
			    <span class="s">&quot;SendPIOAvailAddr written as %lx, &quot;</span>
			    <span class="s">&quot;read back as %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavailregs_phys</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">+</span> <span class="n">NUM_VL15_BUFS</span><span class="p">;</span>
	<span class="n">qib_7322_txchk_change</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">TXCHK_CHG_TYPE_KERN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* driver sends get pkey, lid, etc. checking also, to catch bugs */</span>
	<span class="n">qib_7322_txchk_change</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">TXCHK_CHG_TYPE_ENAB1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">qib_register_observer</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sendctrl_0_observer</span><span class="p">);</span>
	<span class="n">qib_register_observer</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sendctrl_1_observer</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLOGIC_IB_C_SDMAFETCHPRIOEN</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set SendDmaFetchPriority and init Tx params, including</span>
<span class="cm">	 * QSFP handler on boards that have QSFP.</span>
<span class="cm">	 * First set our default attenuation entry for cables that</span>
<span class="cm">	 * don&#39;t have valid attenuation.</span>
<span class="cm">	 */</span>
	<span class="n">set_no_qsfp_atten</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>

		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmaprioritythld</span><span class="p">,</span>
				    <span class="n">sdma_fetch_prio</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="cm">/* Initialize qsfp if present on board. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_QSFP</span><span class="p">)</span>
			<span class="n">qib_init_7322_qsfp</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">QLOGIC_IB_C_SDMAFETCHPRIOEN</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* per IB port errors.  */</span>
<span class="cp">#define SENDCTRL_PIBP (MASK_ACROSS(0, 1) | MASK_ACROSS(3, 3) | \</span>
<span class="cp">	MASK_ACROSS(8, 15))</span>
<span class="cp">#define RCVCTRL_PIBP (MASK_ACROSS(0, 17) | MASK_ACROSS(39, 41))</span>
<span class="cp">#define ERRS_PIBP (MASK_ACROSS(57, 58) | MASK_ACROSS(54, 54) | \</span>
<span class="cp">	MASK_ACROSS(36, 49) | MASK_ACROSS(29, 34) | MASK_ACROSS(14, 17) | \</span>
<span class="cp">	MASK_ACROSS(0, 11))</span>

<span class="cm">/*</span>
<span class="cm"> * Write the initialization per-port registers that need to be done at</span>
<span class="cm"> * driver load and after reset completes (i.e., that aren&#39;t done as part</span>
<span class="cm"> * of other init procedures called from qib_init.c).</span>
<span class="cm"> * Some of these should be redundant on reset, but play safe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_7322_init_portregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no buffer credits for this port */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rxcreditvl0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the number of supported virtual lanes in IBC,</span>
<span class="cm">	 * for flow control packet handling on unsupported VLs</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibsdtestiftx</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IB_SDTEST_IF_TX_0</span><span class="p">,</span> <span class="n">VL_CAP</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IB_SDTEST_IF_TX_0</span><span class="p">,</span> <span class="n">VL_CAP</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibsdtestiftx</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rcvbthqp</span><span class="p">,</span> <span class="n">QIB_KD_QP</span><span class="p">);</span>

	<span class="cm">/* enable tx header checking */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_sendcheckcontrol</span><span class="p">,</span> <span class="n">IBA7322_SENDCHK_PKEY</span> <span class="o">|</span>
			    <span class="n">IBA7322_SENDCHK_BTHQP</span> <span class="o">|</span> <span class="n">IBA7322_SENDCHK_SLID</span> <span class="o">|</span>
			    <span class="n">IBA7322_SENDCHK_RAW_IPV6</span> <span class="o">|</span> <span class="n">IBA7322_SENDCHK_MINSZ</span><span class="p">);</span>

	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ncmodectrl</span><span class="p">,</span>
		<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBNCModeCtrl_0</span><span class="p">,</span> <span class="n">ScrambleCapLocal</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unconditionally clear the bufmask bits.  If SDMA is</span>
<span class="cm">	 * enabled, we&#39;ll set them appropriately later.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmabufmask0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmabufmask1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmabufmask2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl_0</span><span class="p">,</span> <span class="n">ForceCreditUpToDate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write the initialization per-device registers that need to be done at</span>
<span class="cm"> * driver load and after reset completes (i.e., that aren&#39;t done as part</span>
<span class="cm"> * of other init procedures called from qib_init.c).  Also write per-port</span>
<span class="cm"> * registers that are affected by overall device config, such as QP mapping</span>
<span class="cm"> * Some of these should be redundant on reset, but play safe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_7322_initregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pidx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Set Multicast QPs received by port 2 to map to context one. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KREG_IDX</span><span class="p">(</span><span class="n">RcvQPMulticastContext_1</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">n</span><span class="p">,</span> <span class="n">regno</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">n_krcv_queues</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">].</span><span class="n">link_speed_supported</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">pidx</span><span class="p">];</span>

		<span class="cm">/* be paranoid against later code motion, etc. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">p_rcvctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">RcvCtrl_0</span><span class="p">,</span> <span class="n">RcvQPMapEnable</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Initialize QP to context mapping */</span>
		<span class="n">regno</span> <span class="o">=</span> <span class="n">krp_rcvqpmaptable</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">/</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">ctxt</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">ctxt</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
				<span class="n">ctxt</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ctxt</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">ctxt</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">6</span><span class="p">));</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">regno</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup up interrupt mitigation for kernel contexts, but</span>
<span class="cm">	 * not user contexts (user contexts use interrupts when</span>
<span class="cm">	 * stalled waiting for any packet, so want those interrupts</span>
<span class="cm">	 * right away).</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvavail_timeout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcv_int_timeout</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvavailtimeout</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">rcv_int_timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize  as (disabled) rcvflow tables.  Application code</span>
<span class="cm">	 * will setup each flow as it uses the flow.</span>
<span class="cm">	 * Doesn&#39;t clear any of the error bits that might be set.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">TIDFLOW_ERRBITS</span><span class="p">;</span> <span class="cm">/* these are W1C */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flow</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">flow</span> <span class="o">&lt;</span> <span class="n">NUM_TIDFLOWS_CTXT</span><span class="p">;</span> <span class="n">flow</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvflowtable</span><span class="o">+</span><span class="n">flow</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * dual cards init to dual port recovery, single port cards to</span>
<span class="cm">	 * the one port.  Dual port cards may later adjust to 1 port,</span>
<span class="cm">	 * and then back to dual port if both ports are connected</span>
<span class="cm">	 * */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span>
		<span class="n">setup_7322_link_recovery</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_init_7322_variables</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">features</span><span class="p">,</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">sbufcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sbufs</span><span class="p">,</span> <span class="n">updthresh</span><span class="p">;</span>

	<span class="cm">/* pport structs are contiguous, allocated after devdata */</span>
	<span class="n">ppd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">=</span> <span class="n">ppd</span><span class="p">;</span>
	<span class="n">ppd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dd</span><span class="p">;</span>
	<span class="n">ppd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dd</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_chip_specific</span> <span class="o">*</span><span class="p">)(</span><span class="n">ppd</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ppd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpspec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_chippport_specific</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cpspec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpspec</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ppd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* for autoneg_7322_work() */</span>
	<span class="n">ppd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* for autoneg_7322_work() */</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>

	<span class="cm">/* we haven&#39;t yet set QIB_PRESENT, so use read directly */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">kr_revision</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="mh">0xffffffffU</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffffffffU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Revision register read failure, &quot;</span>
			    <span class="s">&quot;giving up initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_PRESENT</span><span class="p">;</span>  <span class="cm">/* now register routines work */</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">majrev</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span> <span class="n">ChipRevMajor</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span> <span class="n">ChipRevMinor</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">get_7322_chip_params</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">features</span> <span class="o">=</span> <span class="n">qib_7322_boardname</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/* now that piobcnt2k and 4k set, we can allocate these */</span>
	<span class="n">sbufcnt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">+</span>
		<span class="n">NUM_VL15_BUFS</span> <span class="o">+</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sbufcnt</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendchkenable</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sbufcnt</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendchkenable</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendgrhchk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sbufcnt</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendgrhchk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendibchk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sbufcnt</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendibchk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendchkenable</span> <span class="o">||</span> <span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendgrhchk</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendibchk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed allocation for hdrchk bitmaps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ppd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * GPIO bits for TWSI data and clock,</span>
<span class="cm">	 * used for serial EEPROM.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">gpio_sda_num</span> <span class="o">=</span> <span class="n">_QIB_GPIO_SDA_NUM</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">gpio_scl_num</span> <span class="o">=</span> <span class="n">_QIB_GPIO_SCL_NUM</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">twsi_eeprom_dev</span> <span class="o">=</span> <span class="n">QIB_TWSI_EEPROM_DEV</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_HAS_INTX</span> <span class="o">|</span> <span class="n">QIB_HAS_LINK_LATENCY</span> <span class="o">|</span>
		<span class="n">QIB_NODMA_RTAIL</span> <span class="o">|</span> <span class="n">QIB_HAS_VLSUPP</span> <span class="o">|</span> <span class="n">QIB_HAS_HDRSUPP</span> <span class="o">|</span>
		<span class="n">QIB_HAS_THRESH_UPDATE</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">sdma_idle_cnt</span> <span class="o">?</span> <span class="n">QIB_HAS_SDMA_TIMEOUT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">qib_special_trigger</span> <span class="o">?</span>
		<span class="n">QIB_USE_SPCL_TRIG</span> <span class="o">:</span> <span class="n">QIB_HAS_SEND_DMA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup initial values.  These may change when PAT is enabled, but</span>
<span class="cm">	 * we need these to do initial chip register accesses.</span>
<span class="cm">	 */</span>
	<span class="n">qib_7322_set_baseaddrs</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">mtu</span> <span class="o">=</span> <span class="n">ib_mtu_enum_to_int</span><span class="p">(</span><span class="n">qib_ibmtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">QIB_DEFAULT_MTU</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">int_enable_mask</span> <span class="o">=</span> <span class="n">QIB_I_BITSEXTANT</span><span class="p">;</span>
	<span class="cm">/* all hwerrors become interrupts, unless special purposed */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
	<span class="cm">/*  link_recovery setup causes these errors, so ignore them,</span>
<span class="cm">	 *  other than clearing them when they occur */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;=</span>
		<span class="o">~</span><span class="p">(</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrMask</span><span class="p">,</span> <span class="n">IBSerdesPClkNotDetectMask_0</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrMask</span><span class="p">,</span> <span class="n">IBSerdesPClkNotDetectMask_1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">HWE_MASK</span><span class="p">(</span><span class="n">LATriggered</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pidx</span> <span class="o">&lt;</span> <span class="n">NUM_IB_PORTS</span><span class="p">;</span> <span class="o">++</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qib_chippport_specific</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span> <span class="o">=</span> <span class="n">features</span> <span class="o">&amp;</span> <span class="n">PORT_SPD_CAP</span><span class="p">;</span>
		<span class="n">features</span> <span class="o">&gt;&gt;=</span>  <span class="n">PORT_SPD_CAP_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* single port mode (7340, or configured) */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">skip_kctxt_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pidx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Make sure port is disabled. */</span>
				<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rcvctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">ppd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppd</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrMask</span><span class="p">,</span>
						  <span class="n">IBSerdesPClkNotDetectMask_0</span><span class="p">)</span>
						  <span class="o">|</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrMask</span><span class="p">,</span>
						  <span class="n">SDmaMemReadErrMask_0</span><span class="p">));</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">int_enable_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaCleanupDoneMask_0</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaIdleIntMask_0</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaProgressIntMask_0</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaIntMask_0</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">ErrIntMask_0</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SendDoneIntMask_0</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Make sure port is disabled. */</span>
				<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_rcvctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrMask</span><span class="p">,</span>
						  <span class="n">IBSerdesPClkNotDetectMask_1</span><span class="p">)</span>
						  <span class="o">|</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrMask</span><span class="p">,</span>
						  <span class="n">SDmaMemReadErrMask_1</span><span class="p">));</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">int_enable_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaCleanupDoneMask_1</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaIdleIntMask_1</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaProgressIntMask_1</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SDmaIntMask_1</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">ErrIntMask_1</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">SendDoneIntMask_1</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qib_init_pportdata</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">);</span>

		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_supported</span> <span class="o">=</span> <span class="n">IB_WIDTH_1X</span> <span class="o">|</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">=</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the initial values to reasonable default, will be set</span>
<span class="cm">		 * for real when link is up.</span>
<span class="cm">		 */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span> <span class="o">=</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">=</span> <span class="n">QIB_IB_SDR</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">delay_mult</span> <span class="o">=</span> <span class="n">ib_rate_to_delay</span><span class="p">[</span><span class="n">IB_RATE_10_GBPS</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">qib_num_cfg_vls</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span> <span class="o">=</span> <span class="n">IB_VL_VL0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span> <span class="o">=</span> <span class="n">IB_VL_VL0_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				    <span class="s">&quot;Invalid num_vls %u, using 4 VLs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">qib_num_cfg_vls</span><span class="p">);</span>
			<span class="n">qib_num_cfg_vls</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span> <span class="o">=</span> <span class="n">IB_VL_VL0_3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="mi">2048</span><span class="p">)</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span> <span class="o">=</span> <span class="n">IB_VL_VL0_7</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="s">&quot;Invalid num_vls %u for MTU %d &quot;</span>
					    <span class="s">&quot;, using 4 VLs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">qib_num_cfg_vls</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span> <span class="o">=</span> <span class="n">IB_VL_VL0_3</span><span class="p">;</span>
				<span class="n">qib_num_cfg_vls</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_operational</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span><span class="p">;</span>

		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">);</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">autoneg_work</span><span class="p">,</span>
				  <span class="n">autoneg_7322_work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
			<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">ipg_work</span><span class="p">,</span> <span class="n">ipg_7322_work</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * For Mez and similar cards, no qsfp info, so do</span>
<span class="cm">		 * the &quot;cable info&quot; setup here.  Can be overridden</span>
<span class="cm">		 * in adapter-specific routines.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_QSFP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QMH</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QME</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
				<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;IB%u:%u: &quot;</span>
					    <span class="s">&quot;Unknown mezzanine card type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="n">cp</span><span class="o">-&gt;</span><span class="n">h1_val</span> <span class="o">=</span> <span class="n">IS_QMH</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">?</span> <span class="n">H1_FORCE_QMH</span> <span class="o">:</span> <span class="n">H1_FORCE_QME</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Choose center value as default tx serdes setting</span>
<span class="cm">			 * until changed through module parameter.</span>
<span class="cm">			 */</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">=</span> <span class="n">IS_QMH</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cp</span><span class="o">-&gt;</span><span class="n">h1_val</span> <span class="o">=</span> <span class="n">H1_FORCE_VAL</span><span class="p">;</span>

		<span class="cm">/* Avoid writes to chip for mini_init */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_mini_init</span><span class="p">)</span>
			<span class="n">write_7322_init_portregs</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>

		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">reenable_chase</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ppd</span><span class="p">;</span>

		<span class="n">ppd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrentsize</span> <span class="o">=</span> <span class="n">qib_rcvhdrentsize</span> <span class="o">?</span>
		<span class="n">qib_rcvhdrentsize</span> <span class="o">:</span> <span class="n">QIB_RCVHDR_ENTSIZE</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrsize</span> <span class="o">=</span> <span class="n">qib_rcvhdrsize</span> <span class="o">?</span>
		<span class="n">qib_rcvhdrsize</span> <span class="o">:</span> <span class="n">QIB_DFLT_RCVHDRSIZE</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhf_offset</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrentsize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="cm">/* we always allocate at least 2048 bytes for eager buffers */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span><span class="p">));</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize_shift</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span><span class="p">);</span>

	<span class="n">qib_7322_tidtemplate</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can request a receive interrupt for 1 or</span>
<span class="cm">	 * more packets from current offset.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">rcv_int_count</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7322_HDRHEAD_PKTINT_SHIFT</span><span class="p">;</span>

	<span class="cm">/* setup the stats timer; the add_timer is done at end of init */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">qib_get_7322_faststats</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dd</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>  <span class="cm">/* 64KB alignment */</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2kmax_dwords</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2k</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">qib_7322_config_ctxts</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">qib_set_ctxtcnt</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_wc_pat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resource_size_t</span> <span class="n">vl15off</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We do not set WC on the VL15 buffers to avoid</span>
<span class="cm">		 * a rare problem with unaligned writes from</span>
<span class="cm">		 * interrupt-flushed store buffers, so we need</span>
<span class="cm">		 * to map those separately here.  We can&#39;t solve</span>
<span class="cm">		 * this for the rarely used mtrr case.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_chip_wc_pat</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

		<span class="cm">/* vl15 buffers start just after the 4k buffers */</span>
		<span class="n">vl15off</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">physaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobufbase</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">align4k</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piovl15base</span>	<span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">vl15off</span><span class="p">,</span>
						  <span class="n">NUM_VL15_BUFS</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">align4k</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piovl15base</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_7322_set_baseaddrs</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span> <span class="cm">/* set chip access pointers now */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_mini_init</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No ports enabled, giving up initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span> <span class="cm">/* no error, so can still figure out why err */</span>
	<span class="p">}</span>

	<span class="n">write_7322_initregs</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_create_ctxts</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">init_7322_cntrnames</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">updthresh</span> <span class="o">=</span> <span class="mi">8U</span><span class="p">;</span> <span class="cm">/* update threshold */</span>

	<span class="cm">/* use all of 4KB buffers for the kernel SDMA, zero if !SDMA.</span>
<span class="cm">	 * reserve the update threshold amount for other kernel use, such</span>
<span class="cm">	 * as sending SMI, MAD, and ACKs, or 3, whichever is greater,</span>
<span class="cm">	 * unless we aren&#39;t enabling SDMA, in which case we want to use</span>
<span class="cm">	 * all the 4k bufs for the kernel.</span>
<span class="cm">	 * if this was less than the update threshold, we could wait</span>
<span class="cm">	 * a long time for an update.  Coded this way because we</span>
<span class="cm">	 * sometimes change the update threshold for various reasons,</span>
<span class="cm">	 * and we want this to remain robust.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_SEND_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">;</span>
		<span class="n">sbufs</span> <span class="o">=</span> <span class="n">updthresh</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">?</span> <span class="n">updthresh</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sbufs</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">-</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lastctxt_piobuf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span> <span class="o">-</span> <span class="n">sbufs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* range is &lt;= , not &lt; */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">last_pio</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pbufsctxt</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span> <span class="o">&gt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lastctxt_piobuf</span> <span class="o">/</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span> <span class="o">-</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have 16 user contexts, we will have 7 sbufs</span>
<span class="cm">	 * per context, so reduce the update threshold to match.  We</span>
<span class="cm">	 * want to update before we actually run out, at low pbufs/ctxt</span>
<span class="cm">	 * so give ourselves some margin.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pbufsctxt</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pbufsctxt</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">updthresh</span><span class="p">)</span>
		<span class="n">updthresh</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pbufsctxt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span> <span class="o">=</span> <span class="n">updthresh</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">=</span> <span class="n">updthresh</span><span class="p">;</span>

	<span class="cm">/* before full enable, no interrupts, no locking needed */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="p">((</span><span class="n">updthresh</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">))</span>
			     <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">))</span> <span class="o">|</span>
			<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailPad64Byte</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">psxmitwait_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">psxmitwait_check_rate</span> <span class="o">=</span> <span class="n">QIB_7322_PSXMITWAIT_CHECK_RATE</span><span class="p">;</span>
<span class="nl">bail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for other initialization code */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">qib_7322_getsendbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pbc</span><span class="p">,</span>
					<span class="n">u32</span> <span class="o">*</span><span class="n">pbufnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">plen</span> <span class="o">=</span> <span class="n">pbc</span> <span class="o">&amp;</span> <span class="n">QIB_PBC_LENGTH_MASK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="cm">/* last is same for 2k and 4k, because we use 4k if all 2k busy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbc</span> <span class="o">&amp;</span> <span class="n">PBC_7322_VL15_SEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">+</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2kmax_dwords</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qib_getsendbuf_range</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pbufnum</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_set_cntr_7322_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intv</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_psinterval</span><span class="p">,</span> <span class="n">intv</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_psstart</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must be called with sdma_lock held, or before init finished.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_sdma_set_7322_desc_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmadesccnt</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdma_set_state_action</span> <span class="n">sdma_7322_action_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s00_hw_down</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">go_s99_running_tofalse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_drain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s10_hw_start_up_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_drain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s20_idle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_drain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s30_sw_clean_up_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_drain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s40_hw_clean_up_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_drain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s50_hw_halt_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_drain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s99_running</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_drain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">go_s99_running_totrue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_sdma_init_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">set_state_action</span> <span class="o">=</span> <span class="n">sdma_7322_action_table</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_sdma_7322_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lastbuf</span><span class="p">,</span> <span class="n">erstbuf</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmabase</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_phys</span><span class="p">);</span>
	<span class="n">qib_sdma_7322_setlengen</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="n">qib_sdma_update_7322_tail</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Set SendDmaTail */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmareloadcnt</span><span class="p">,</span> <span class="n">sdma_idle_cnt</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmadesccnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmaheadaddr</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_head_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span> <span class="o">/</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span> <span class="cm">/* no remainder */</span>
	<span class="k">else</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span><span class="p">;</span> <span class="cm">/* failsafe for init */</span>
	<span class="n">erstbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span><span class="p">);</span>
	<span class="n">lastbuf</span> <span class="o">=</span> <span class="n">erstbuf</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">first_sendbuf</span> <span class="o">=</span> <span class="n">erstbuf</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">last_sendbuf</span> <span class="o">=</span> <span class="n">lastbuf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">erstbuf</span> <span class="o">&lt;</span> <span class="n">lastbuf</span><span class="p">;</span> <span class="o">++</span><span class="n">erstbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">word</span> <span class="o">=</span> <span class="n">erstbuf</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">erstbuf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">word</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">senddmabufmask</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmabufmask0</span><span class="p">,</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmabufmask1</span><span class="p">,</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmabufmask2</span><span class="p">,</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sdma_lock must be held */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">qib_sdma_7322_gethead</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sane</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_dmahead</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">swhead</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">swtail</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hwhead</span><span class="p">;</span>

	<span class="n">use_dmahead</span> <span class="o">=</span> <span class="n">__qib_sdma_running</span><span class="p">(</span><span class="n">ppd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_SDMA_TIMEOUT</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">hwhead</span> <span class="o">=</span> <span class="n">use_dmahead</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_head_dma</span><span class="p">)</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmahead</span><span class="p">);</span>

	<span class="n">swhead</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_head</span><span class="p">;</span>
	<span class="n">swtail</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_tail</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">swhead</span> <span class="o">&lt;</span> <span class="n">swtail</span><span class="p">)</span>
		<span class="cm">/* not wrapped */</span>
		<span class="n">sane</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">&gt;=</span> <span class="n">swhead</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">&lt;=</span> <span class="n">swtail</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">swhead</span> <span class="o">&gt;</span> <span class="n">swtail</span><span class="p">)</span>
		<span class="cm">/* wrapped around */</span>
		<span class="n">sane</span> <span class="o">=</span> <span class="p">((</span><span class="n">hwhead</span> <span class="o">&gt;=</span> <span class="n">swhead</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">hwhead</span> <span class="o">&lt;=</span> <span class="n">swtail</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* empty */</span>
		<span class="n">sane</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">==</span> <span class="n">swhead</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sane</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_dmahead</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* try one more time, directly from the register */</span>
			<span class="n">use_dmahead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* proceed as if no progress */</span>
		<span class="n">hwhead</span> <span class="o">=</span> <span class="n">swhead</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hwhead</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_sdma_7322_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">hwstatus</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_senddmastatus</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus_0</span><span class="p">,</span> <span class="n">ScoreBoardDrainInProg</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus_0</span><span class="p">,</span> <span class="n">HaltInProg</span><span class="p">))</span> <span class="o">||</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus_0</span><span class="p">,</span> <span class="n">InternalSDmaHalt</span><span class="p">))</span> <span class="o">||</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus_0</span><span class="p">,</span> <span class="n">ScbEmpty</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute the amount of delay before sending the next packet if the</span>
<span class="cm"> * port&#39;s send rate differs from the static rate set for the QP.</span>
<span class="cm"> * The delay affects the next packet and the amount of the delay is</span>
<span class="cm"> * based on the length of the this packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_7322_setpbc_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">plen</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">srate</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">snd_mult</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">delay_mult</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rcv_mult</span> <span class="o">=</span> <span class="n">ib_rate_to_delay</span><span class="p">[</span><span class="n">srate</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rcv_mult</span> <span class="o">&gt;</span> <span class="n">snd_mult</span> <span class="o">?</span> <span class="p">((</span><span class="n">plen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">snd_mult</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Indicate VL15, else set the VL in the control word */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vl</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">PBC_7322_VL15_SEND_CTRL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">vl</span> <span class="o">&lt;&lt;</span> <span class="n">PBC_VL_NUM_LSB</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">PBC_PORT_SEL_LSB</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable the per-port VL15 send buffers for use.</span>
<span class="cm"> * They follow the rest of the buffers, without a config parameter.</span>
<span class="cm"> * This was in initregs, but that is done before the shadow</span>
<span class="cm"> * is set up, and this has to be done after the shadow is</span>
<span class="cm"> * set up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_initvl15_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">vl15bufs</span><span class="p">;</span>

	<span class="n">vl15bufs</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">;</span>
	<span class="n">qib_chg_pioavailkernel</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">vl15bufs</span><span class="p">,</span> <span class="n">NUM_VL15_BUFS</span><span class="p">,</span>
			       <span class="n">TXCHK_CHG_TYPE_KERN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_init_ctxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span> <span class="o">&lt;</span> <span class="n">NUM_IB_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">=</span> <span class="n">KCTXT0_EGRCNT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegr_tid_base</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span> <span class="o">?</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">=</span> <span class="n">KCTXT0_EGRCNT</span><span class="p">;</span>
			<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegr_tid_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">;</span>
		<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegr_tid_base</span> <span class="o">=</span> <span class="n">KCTXT0_EGRCNT</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span> <span class="o">-</span> <span class="n">NUM_IB_PORTS</span><span class="p">)</span> <span class="o">*</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define QTXSLEEPS 5000</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7322_txchk_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">which</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">lastr</span> <span class="o">=</span> <span class="n">last</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sleeps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="n">rcd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shadow</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cstart</span><span class="p">,</span> <span class="n">previ</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * when flipping from kernel to user, we can&#39;t change</span>
<span class="cm">		 * the checking type if the buffer is allocated to the</span>
<span class="cm">		 * driver.   It&#39;s OK the other direction, because it&#39;s</span>
<span class="cm">		 * from close, and we have just disarm&#39;ed all the</span>
<span class="cm">		 * buffers.  All the kernel to kernel changes are also</span>
<span class="cm">		 * OK.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cstart</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">cstart</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">cstart</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cstart</span><span class="p">)</span> <span class="o">+</span> <span class="n">QLOGIC_IB_SENDPIOAVAIL_BUSY_SHIFT</span><span class="p">)</span>
				<span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">previ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">shadow</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavailregs_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">previ</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cstart</span><span class="p">)</span> <span class="o">+</span>
				      <span class="n">QLOGIC_IB_SENDPIOAVAIL_BUSY_SHIFT</span><span class="p">)</span>
				     <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shadow</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cstart</span> <span class="o">&gt;</span> <span class="n">last</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sleeps</span> <span class="o">==</span> <span class="n">QTXSLEEPS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* make sure we see an updated copy next time around */</span>
		<span class="n">sendctrl_7322_mod</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">);</span>
		<span class="n">sleeps</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TXCHK_CHG_TYPE_DIS1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * disable checking on a range; used by diags; just</span>
<span class="cm">		 * one buffer, but still written generically</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendchkenable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TXCHK_CHG_TYPE_ENAB1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * (re)enable checking on a range; used by diags; just</span>
<span class="cm">		 * one buffer, but still written generically; read</span>
<span class="cm">		 * scratch to be sure buffer actually triggered, not</span>
<span class="cm">		 * just flushed from processor.</span>
<span class="cm">		 */</span>
		<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendchkenable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TXCHK_CHG_TYPE_KERN</span>:
		<span class="cm">/* usable by kernel */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendibchk</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendgrhchk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">uctxt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* see if we need to raise avail update threshold */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span>
		     <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span>
		     <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span> <span class="o">&amp;&amp;</span>
			   <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">piocnt</span> <span class="o">/</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			   <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">uctxt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">&amp;</span>
					 <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
					   <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">sendctrl_7322_mod</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TXCHK_CHG_TYPE_USER</span>:
		<span class="cm">/* for user process */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendibchk</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendgrhchk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span> <span class="o">&amp;&amp;</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">piocnt</span>
			<span class="o">/</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">piocnt</span> <span class="o">/</span>
						<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">&amp;</span>
					<span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">))</span>
					<span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">sendctrl_7322_mod</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span> <span class="n">which</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">lastr</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendcheckmask</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
			       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendchkenable</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span> <span class="n">which</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">lastr</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendgrhcheckmask</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
			       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendgrhchk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendibpktmask</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
			       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sendibchk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Be sure whatever we did was seen by the chip and acted upon,</span>
<span class="cm">	 * before we return.  Mostly important for which &gt;= 2.</span>
<span class="cm">	 */</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* useful for trigger analyzers, etc. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">writescratch</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Dummy for now, use chip regs soon */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7322_tempsense_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_init_iba7322_funcs - set up the chip-specific function pointers</span>
<span class="cm"> * @dev: the pci_dev for qlogic_ib device</span>
<span class="cm"> * @ent: pci_device_id struct for this dev</span>
<span class="cm"> *</span>
<span class="cm"> * Also allocates, inits, and returns the devdata struct for this</span>
<span class="cm"> * device instance</span>
<span class="cm"> *</span>
<span class="cm"> * This is global, and is called directly at init to set up the</span>
<span class="cm"> * chip-specific function pointers for later use.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="nf">qib_init_iba7322_funcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tabsize</span><span class="p">,</span> <span class="n">actual_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dd</span> <span class="o">=</span> <span class="n">qib_alloc_devdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">NUM_IB_PORTS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_chip_specific</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">NUM_IB_PORTS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_chippport_specific</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_bringup_serdes</span>    <span class="o">=</span> <span class="n">qib_7322_bringup_serdes</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_cleanup</span>           <span class="o">=</span> <span class="n">qib_setup_7322_cleanup</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_clear_tids</span>        <span class="o">=</span> <span class="n">qib_7322_clear_tids</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_free_irq</span>          <span class="o">=</span> <span class="n">qib_7322_free_irq</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_get_base_info</span>     <span class="o">=</span> <span class="n">qib_7322_get_base_info</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_get_msgheader</span>     <span class="o">=</span> <span class="n">qib_7322_get_msgheader</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_getsendbuf</span>        <span class="o">=</span> <span class="n">qib_7322_getsendbuf</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_gpio_mod</span>          <span class="o">=</span> <span class="n">gpio_7322_mod</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_eeprom_wen</span>        <span class="o">=</span> <span class="n">qib_7322_eeprom_wen</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_hdrqempty</span>         <span class="o">=</span> <span class="n">qib_7322_hdrqempty</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_ib_updown</span>         <span class="o">=</span> <span class="n">qib_7322_ib_updown</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_init_ctxt</span>         <span class="o">=</span> <span class="n">qib_7322_init_ctxt</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_initvl15_bufs</span>     <span class="o">=</span> <span class="n">qib_7322_initvl15_bufs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_intr_fallback</span>     <span class="o">=</span> <span class="n">qib_7322_intr_fallback</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_late_initreg</span>      <span class="o">=</span> <span class="n">qib_late_7322_initreg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_setpbc_control</span>    <span class="o">=</span> <span class="n">qib_7322_setpbc_control</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_portcntr</span>          <span class="o">=</span> <span class="n">qib_portcntr_7322</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_put_tid</span>           <span class="o">=</span> <span class="n">qib_7322_put_tid</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_quiet_serdes</span>      <span class="o">=</span> <span class="n">qib_7322_mini_quiet_serdes</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_rcvctrl</span>           <span class="o">=</span> <span class="n">rcvctrl_7322_mod</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_read_cntrs</span>        <span class="o">=</span> <span class="n">qib_read_7322cntrs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_read_portcntrs</span>    <span class="o">=</span> <span class="n">qib_read_7322portcntrs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_reset</span>             <span class="o">=</span> <span class="n">qib_do_7322_reset</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_init_sdma_regs</span>    <span class="o">=</span> <span class="n">init_sdma_7322_regs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_busy</span>         <span class="o">=</span> <span class="n">qib_sdma_7322_busy</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_gethead</span>      <span class="o">=</span> <span class="n">qib_sdma_7322_gethead</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_sendctrl</span>     <span class="o">=</span> <span class="n">qib_7322_sdma_sendctrl</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_set_desc_cnt</span> <span class="o">=</span> <span class="n">qib_sdma_set_7322_desc_cnt</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_update_tail</span>  <span class="o">=</span> <span class="n">qib_sdma_update_7322_tail</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sendctrl</span>          <span class="o">=</span> <span class="n">sendctrl_7322_mod</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_armlaunch</span>     <span class="o">=</span> <span class="n">qib_set_7322_armlaunch</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_cntr_sample</span>   <span class="o">=</span> <span class="n">qib_set_cntr_7322_sample</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_iblink_state</span>      <span class="o">=</span> <span class="n">qib_7322_iblink_state</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_ibphys_portstate</span>  <span class="o">=</span> <span class="n">qib_7322_phys_portstate</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_get_ib_cfg</span>        <span class="o">=</span> <span class="n">qib_7322_get_ib_cfg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_ib_cfg</span>        <span class="o">=</span> <span class="n">qib_7322_set_ib_cfg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_ib_loopback</span>   <span class="o">=</span> <span class="n">qib_7322_set_loopback</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_get_ib_table</span>      <span class="o">=</span> <span class="n">qib_7322_get_ib_table</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_ib_table</span>      <span class="o">=</span> <span class="n">qib_7322_set_ib_table</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_intr_state</span>    <span class="o">=</span> <span class="n">qib_7322_set_intr_state</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_setextled</span>         <span class="o">=</span> <span class="n">qib_setup_7322_setextled</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_txchk_change</span>      <span class="o">=</span> <span class="n">qib_7322_txchk_change</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_update_usrhead</span>    <span class="o">=</span> <span class="n">qib_update_7322_usrhead</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_wantpiobuf_intr</span>   <span class="o">=</span> <span class="n">qib_wantpiobuf_7322_intr</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_xgxs_reset</span>        <span class="o">=</span> <span class="n">qib_7322_mini_pcs_reset</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_hw_clean_up</span>  <span class="o">=</span> <span class="n">qib_7322_sdma_hw_clean_up</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_hw_start_up</span>  <span class="o">=</span> <span class="n">qib_7322_sdma_hw_start_up</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_init_early</span>   <span class="o">=</span> <span class="n">qib_7322_sdma_init_early</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_writescratch</span>      <span class="o">=</span> <span class="n">writescratch</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_tempsense_rd</span>	<span class="o">=</span> <span class="n">qib_7322_tempsense_rd</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do remaining PCIe setup and save PCIe values in dd.</span>
<span class="cm">	 * Any error printing is already done by the init code.</span>
<span class="cm">	 * On return, we have the chip mapped, but chip registers</span>
<span class="cm">	 * are not set up until start of qib_init_7322_variables.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_pcie_ddinit</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail_free</span><span class="p">;</span>

	<span class="cm">/* initialize chip-specific variables */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_init_7322_variables</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail_cleanup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_mini_init</span> <span class="o">||</span> <span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine number of vectors we want; depends on port count</span>
<span class="cm">	 * and number of configured kernel receive queues actually used.</span>
<span class="cm">	 * Should also depend on whether sdma is enabled or not, but</span>
<span class="cm">	 * that&#39;s such a rare testing case it&#39;s not worth worrying about.</span>
<span class="cm">	 */</span>
	<span class="n">tabsize</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">+</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_table</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tabsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_table</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span> <span class="o">&lt;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_table</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_table</span><span class="p">)]))</span>
			<span class="n">actual_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* reduce by ctxt&#39;s &lt; 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_krcvq01_no_msi</span><span class="p">)</span>
		<span class="n">actual_cnt</span> <span class="o">-=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>

	<span class="n">tabsize</span> <span class="o">=</span> <span class="n">actual_cnt</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">tabsize</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_msix_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No memory for MSIx table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tabsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tabsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msix</span><span class="p">.</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_pcie_params</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tabsize</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">))</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed to setup PCIe or interrupts; &quot;</span>
			    <span class="s">&quot;continuing anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* may be less than we wanted, if not enough available */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">num_msix_entries</span> <span class="o">=</span> <span class="n">tabsize</span><span class="p">;</span>

	<span class="cm">/* setup interrupt handler */</span>
	<span class="n">qib_setup_7322_interrupt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* clear diagctrl register, in case diags were running and crashed */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

<span class="nl">bail_cleanup:</span>
	<span class="n">qib_pcie_ddcleanup</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
<span class="nl">bail_free:</span>
	<span class="n">qib_free_devdata</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">dd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the table entry at the specified index from the table specifed.</span>
<span class="cm"> * There are 3 * TXDDS_TABLE_SZ entries in all per port, with the first</span>
<span class="cm"> * TXDDS_TABLE_SZ for SDR, the next for DDR, and the last for QDR.</span>
<span class="cm"> * &#39;idx&#39; below addresses the correct entry, while its 4 LSBs select the</span>
<span class="cm"> * corresponding entry (one of TXDDS_TABLE_SZ) from the selected table.</span>
<span class="cm"> */</span>
<span class="cp">#define DDS_ENT_AMP_LSB 14</span>
<span class="cp">#define DDS_ENT_MAIN_LSB 9</span>
<span class="cp">#define DDS_ENT_POST_LSB 5</span>
<span class="cp">#define DDS_ENT_PRE_XTRA_LSB 3</span>
<span class="cp">#define DDS_ENT_PRE_LSB 0</span>

<span class="cm">/*</span>
<span class="cm"> * Set one entry in the TxDDS table for spec&#39;d port</span>
<span class="cm"> * ridx picks one of the entries, while tp points</span>
<span class="cm"> * to the appropriate table entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_txdds</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ridx</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pack_ent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regidx</span><span class="p">;</span>

	<span class="cm">/* Get correct offset in chip-space, and in source table */</span>
	<span class="n">regidx</span> <span class="o">=</span> <span class="n">KREG_IBPORT_IDX</span><span class="p">(</span><span class="n">IBSD_DDS_MAP_TABLE</span><span class="p">)</span> <span class="o">+</span> <span class="n">ridx</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We do not use qib_write_kreg_port() because it was intended</span>
<span class="cm">	 * only for registers in the lower &quot;port specific&quot; pages.</span>
<span class="cm">	 * So do index calculation  by hand.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">)</span>
		<span class="n">regidx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="n">pack_ent</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">amp</span> <span class="o">&lt;&lt;</span> <span class="n">DDS_ENT_AMP_LSB</span><span class="p">;</span>
	<span class="n">pack_ent</span> <span class="o">|=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">&lt;&lt;</span> <span class="n">DDS_ENT_MAIN_LSB</span><span class="p">;</span>
	<span class="n">pack_ent</span> <span class="o">|=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pre</span> <span class="o">&lt;&lt;</span> <span class="n">DDS_ENT_PRE_LSB</span><span class="p">;</span>
	<span class="n">pack_ent</span> <span class="o">|=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">post</span> <span class="o">&lt;&lt;</span> <span class="n">DDS_ENT_POST_LSB</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">regidx</span><span class="p">,</span> <span class="n">pack_ent</span><span class="p">);</span>
	<span class="cm">/* Prevent back-to-back writes by hitting scratch */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vendor_txdds_ent</span> <span class="n">vendor_txdds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/* Amphenol 1m 30awg NoEq */</span>
		<span class="p">{</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span> <span class="s">&quot;584470002       &quot;</span><span class="p">,</span>
		<span class="p">{</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Amphenol 3m 28awg NoEq */</span>
		<span class="p">{</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span> <span class="s">&quot;584470004       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Finisar 3m OM2 Optical */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x65</span> <span class="p">},</span> <span class="s">&quot;FCBG410QB1C03-QL&quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Finisar 30m OM2 Optical */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x65</span> <span class="p">},</span> <span class="s">&quot;FCBG410QB1C30-QL&quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Finisar Default OM2 Optical */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x65</span> <span class="p">},</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 1m 30awg NoEq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN3300-1       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 2m 30awg NoEq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN3300-2       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 1m 28awg NoEq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN3800-1       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 3m 28awg NoEq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN3800-3       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 5m 24awg Eq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN7000-5       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 7m 24awg Eq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN7000-7       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 5m 26awg Eq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN7600-5       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Gore 7m 26awg Eq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="s">&quot;QSN7600-7       &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Intersil 12m 24awg Active */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xB4</span> <span class="p">},</span> <span class="s">&quot;QLX4000CQSFP1224&quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Intersil 10m 28awg Active */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xB4</span> <span class="p">},</span> <span class="s">&quot;QLX4000CQSFP1028&quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Intersil 7m 30awg Active */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xB4</span> <span class="p">},</span> <span class="s">&quot;QLX4000CQSFP0730&quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Intersil 5m 32awg Active */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xB4</span> <span class="p">},</span> <span class="s">&quot;QLX4000CQSFP0532&quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Intersil Default Active */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xB4</span> <span class="p">},</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Luxtera 20m Active Optical */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x63</span> <span class="p">},</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">12</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Molex 1M Cu loopback */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x3A</span> <span class="p">},</span> <span class="s">&quot;74763-0025      &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Molex 2m 28awg NoEq */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x3A</span> <span class="p">},</span> <span class="s">&quot;74757-2201      &quot;</span><span class="p">,</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">txdds_sdr</span><span class="p">[</span><span class="n">TXDDS_TABLE_SZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* amp, pre, main, post */</span>
	<span class="p">{</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span>	<span class="cm">/* Loopback */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">},</span>	<span class="cm">/*  2 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span> <span class="p">},</span>	<span class="cm">/*  3 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">},</span>	<span class="cm">/*  4 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">},</span>	<span class="cm">/*  5 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span>	<span class="cm">/*  6 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span>	<span class="cm">/*  7 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span>	<span class="cm">/*  8 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>	<span class="cm">/*  9 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span>	<span class="cm">/* 10 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>	<span class="cm">/* 11 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* 12 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>	<span class="cm">/* 13 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* 14 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>	<span class="cm">/* 15 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 16 dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">txdds_ddr</span><span class="p">[</span><span class="n">TXDDS_TABLE_SZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* amp, pre, main, post */</span>
	<span class="p">{</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span>	<span class="cm">/* Loopback */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>	<span class="cm">/*  2 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>	<span class="cm">/*  3 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span>	<span class="cm">/*  4 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span>	<span class="cm">/*  5 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>	<span class="cm">/*  6 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>	<span class="cm">/*  7 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/*  8 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/*  9 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>	<span class="cm">/* 10 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>	<span class="cm">/* 11 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* 12 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* 13 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>	<span class="cm">/* 14 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>	<span class="cm">/* 15 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 16 dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">txdds_qdr</span><span class="p">[</span><span class="n">TXDDS_TABLE_SZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* amp, pre, main, post */</span>
	<span class="p">{</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span>	<span class="cm">/* Loopback */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span>	<span class="cm">/*  2 dB (also QMH7342) */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span>	<span class="cm">/*  3 dB (also QMH7342) */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/*  4 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/*  5 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/*  6 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/*  7 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/*  8 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/*  9 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 10 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 11 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 12 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 13 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 14 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 15 dB */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* 16 dB */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * extra entries for use with txselect, for indices &gt;= TXDDS_TABLE_SZ.</span>
<span class="cm"> * These are mostly used for mez cards going through connectors</span>
<span class="cm"> * and backplane traces, but can be used to add other &quot;unusual&quot;</span>
<span class="cm"> * table values as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">txdds_extra_sdr</span><span class="p">[</span><span class="n">TXDDS_EXTRA_SZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* amp, pre, main, post */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">txdds_extra_ddr</span><span class="p">[</span><span class="n">TXDDS_EXTRA_SZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* amp, pre, main, post */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">txdds_extra_qdr</span><span class="p">[</span><span class="n">TXDDS_EXTRA_SZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* amp, pre, main, post */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane setting */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane setting */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane setting */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane setting */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane setting */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane setting */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>	<span class="cm">/* QME7342 backplane setting */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>	<span class="cm">/* QMH7342 backplane settings */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="n">txdds_extra_mfg</span><span class="p">[</span><span class="n">TXDDS_MFG_SZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* amp, pre, main, post */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>         <span class="cm">/* QME7342 mfg settings */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span>         <span class="cm">/* QME7342 P2 mfg settings */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="nf">get_atten_table</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="n">txdds</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="n">atten</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The attenuation table starts at 2dB for entry 1,</span>
<span class="cm">	 * with entry 0 being the loopback entry.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atten</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">atten</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atten</span> <span class="o">&gt;</span> <span class="n">TXDDS_TABLE_SZ</span><span class="p">)</span>
		<span class="n">atten</span> <span class="o">=</span> <span class="n">TXDDS_TABLE_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">atten</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">txdds</span> <span class="o">+</span> <span class="n">atten</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if override is set, the module parameter txselect has a value</span>
<span class="cm"> * for this specific port, so use it, rather than our normal mechanism.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">find_best_ent</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">**</span><span class="n">sdr_dds</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">**</span><span class="n">ddr_dds</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">**</span><span class="n">qdr_dds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_qsfp_cache</span> <span class="o">*</span><span class="n">qd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qsfp_data</span><span class="p">.</span><span class="n">cache</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* Search table of known cables */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">override</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vendor_txdds</span><span class="p">);</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">vendor_txdds_ent</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">vendor_txdds</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">,</span> <span class="n">QSFP_VOUI_LEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">partnum</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">partnum</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">partnum</span><span class="p">,</span> <span class="n">QSFP_PN_LEN</span><span class="p">)))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">sdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">sdr</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ddr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ddr</span><span class="p">;</span>
			<span class="o">*</span><span class="n">qdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">qdr</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Active cables don&#39;t have attenuation so we only set SERDES</span>
<span class="cm">	 * settings to account for the attenuation of the board traces. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">override</span> <span class="o">&amp;&amp;</span> <span class="n">QSFP_IS_ACTIVE</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">tech</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sdr_dds</span> <span class="o">=</span> <span class="n">txdds_sdr</span> <span class="o">+</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">board_atten</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ddr_dds</span> <span class="o">=</span> <span class="n">txdds_ddr</span> <span class="o">+</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">board_atten</span><span class="p">;</span>
		<span class="o">*</span><span class="n">qdr_dds</span> <span class="o">=</span> <span class="n">txdds_qdr</span> <span class="o">+</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">board_atten</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">override</span> <span class="o">&amp;&amp;</span> <span class="n">QSFP_HAS_ATTEN</span><span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">tech</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qd</span><span class="o">-&gt;</span><span class="n">atten</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
						      <span class="n">qd</span><span class="o">-&gt;</span><span class="n">atten</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sdr_dds</span> <span class="o">=</span> <span class="n">get_atten_table</span><span class="p">(</span><span class="n">txdds_sdr</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">atten</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">ddr_dds</span> <span class="o">=</span> <span class="n">get_atten_table</span><span class="p">(</span><span class="n">txdds_ddr</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">atten</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">qdr_dds</span> <span class="o">=</span> <span class="n">get_atten_table</span><span class="p">(</span><span class="n">txdds_qdr</span><span class="p">,</span> <span class="n">qd</span><span class="o">-&gt;</span><span class="n">atten</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">&lt;</span> <span class="n">TXDDS_TABLE_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we have no (or incomplete) data from the cable</span>
<span class="cm">		 * EEPROM, or no QSFP, or override is set, use the</span>
<span class="cm">		 * module parameter value to index into the attentuation</span>
<span class="cm">		 * table.</span>
<span class="cm">		 */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_sdr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">ddr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_ddr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">qdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_qdr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="n">TXDDS_EXTRA_SZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* similar to above, but index into the &quot;extra&quot; table. */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">-</span> <span class="n">TXDDS_TABLE_SZ</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_extra_sdr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">ddr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_extra_ddr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">qdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_extra_qdr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">IS_QME</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QMH</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="n">TXDDS_EXTRA_SZ</span> <span class="o">+</span>
					  <span class="n">TXDDS_MFG_SZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">no_eep</span> <span class="o">-</span> <span class="p">(</span><span class="n">TXDDS_TABLE_SZ</span> <span class="o">+</span> <span class="n">TXDDS_EXTRA_SZ</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span>
			<span class="s">&quot; IB%u:%u use idx %u into txdds_mfg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="o">*</span><span class="n">sdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_extra_mfg</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">ddr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_extra_mfg</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">qdr_dds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdds_extra_mfg</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* this shouldn&#39;t happen, it&#39;s range checked */</span>
		<span class="o">*</span><span class="n">sdr_dds</span> <span class="o">=</span> <span class="n">txdds_sdr</span> <span class="o">+</span> <span class="n">qib_long_atten</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ddr_dds</span> <span class="o">=</span> <span class="n">txdds_ddr</span> <span class="o">+</span> <span class="n">qib_long_atten</span><span class="p">;</span>
		<span class="o">*</span><span class="n">qdr_dds</span> <span class="o">=</span> <span class="n">txdds_qdr</span> <span class="o">+</span> <span class="n">qib_long_atten</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_txdds_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="n">sdr_dds</span><span class="p">,</span> <span class="o">*</span><span class="n">ddr_dds</span><span class="p">,</span> <span class="o">*</span><span class="n">qdr_dds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="n">dds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">single_ent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">find_best_ent</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdr_dds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddr_dds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdr_dds</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>

	<span class="cm">/* for mez cards or override, use the selected value for all entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_QSFP</span><span class="p">)</span> <span class="o">||</span> <span class="n">override</span><span class="p">)</span>
		<span class="n">single_ent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fill in the first entry with the best entry found. */</span>
	<span class="n">set_txdds</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdr_dds</span><span class="p">);</span>
	<span class="n">set_txdds</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">TXDDS_TABLE_SZ</span><span class="p">,</span> <span class="n">ddr_dds</span><span class="p">);</span>
	<span class="n">set_txdds</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">TXDDS_TABLE_SZ</span><span class="p">,</span> <span class="n">qdr_dds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_LINKINIT</span> <span class="o">|</span> <span class="n">QIBL_LINKARMED</span> <span class="o">|</span>
		<span class="n">QIBL_LINKACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="p">)(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span>
					   <span class="n">QIB_IB_QDR</span> <span class="o">?</span>  <span class="n">qdr_dds</span> <span class="o">:</span>
					   <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span>
					    <span class="n">QIB_IB_DDR</span> <span class="o">?</span> <span class="n">ddr_dds</span> <span class="o">:</span> <span class="n">sdr_dds</span><span class="p">));</span>
		<span class="n">write_tx_serdes_param</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">dds</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the remaining entries with the default table values. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">txdds_sdr</span><span class="p">);</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_txdds</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">single_ent</span> <span class="o">?</span> <span class="n">sdr_dds</span> <span class="o">:</span> <span class="n">txdds_sdr</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">set_txdds</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">TXDDS_TABLE_SZ</span><span class="p">,</span>
			  <span class="n">single_ent</span> <span class="o">?</span> <span class="n">ddr_dds</span> <span class="o">:</span> <span class="n">txdds_ddr</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">set_txdds</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">TXDDS_TABLE_SZ</span><span class="p">,</span>
			  <span class="n">single_ent</span> <span class="o">?</span> <span class="n">qdr_dds</span> <span class="o">:</span> <span class="n">txdds_qdr</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define KR_AHB_ACC KREG_IDX(ahb_access_ctrl)</span>
<span class="cp">#define KR_AHB_TRANS KREG_IDX(ahb_transaction_reg)</span>
<span class="cp">#define AHB_TRANS_RDY SYM_MASK(ahb_transaction_reg, ahb_rdy)</span>
<span class="cp">#define AHB_ADDR_LSB SYM_LSB(ahb_transaction_reg, ahb_address)</span>
<span class="cp">#define AHB_DATA_LSB SYM_LSB(ahb_transaction_reg, ahb_data)</span>
<span class="cp">#define AHB_WR SYM_MASK(ahb_transaction_reg, write_not_read)</span>
<span class="cp">#define AHB_TRANS_TRIES 10</span>

<span class="cm">/*</span>
<span class="cm"> * The chan argument is 0=chan0, 1=chan1, 2=pll, 3=chan2, 4=chan4,</span>
<span class="cm"> * 5=subsystem which is why most calls have &quot;chan + chan &gt;&gt; 1&quot;</span>
<span class="cm"> * for the channel argument.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ahb_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
		    <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rd_data</span><span class="p">,</span> <span class="n">wr_data</span><span class="p">,</span> <span class="n">sz_mask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">trans</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">prev_acc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mh">0xBAD0BAD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span><span class="p">;</span>

	<span class="n">prev_acc</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_ACC</span><span class="p">);</span>
	<span class="cm">/* From this point on, make sure we return access */</span>
	<span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">quad</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_ACC</span><span class="p">,</span> <span class="n">acc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">AHB_TRANS_TRIES</span><span class="p">;</span> <span class="o">++</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_TRANS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trans</span> <span class="o">&amp;</span> <span class="n">AHB_TRANS_RDY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&gt;=</span> <span class="n">AHB_TRANS_TRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No ahb_rdy in %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">AHB_TRANS_TRIES</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If mask is not all 1s, we need to read, but different SerDes</span>
<span class="cm">	 * entities have different sizes</span>
<span class="cm">	 */</span>
	<span class="n">sz_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">quad</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">16</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wr_data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">sz_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">sz_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AHB_ADDR_LSB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_TRANS</span><span class="p">,</span> <span class="n">trans</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">tries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">AHB_TRANS_TRIES</span><span class="p">;</span> <span class="o">++</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">trans</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_TRANS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">trans</span> <span class="o">&amp;</span> <span class="n">AHB_TRANS_RDY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&gt;=</span> <span class="n">AHB_TRANS_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No Rd ahb_rdy in %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">AHB_TRANS_TRIES</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Re-read in case host split reads and read data first */</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_TRANS</span><span class="p">);</span>
		<span class="n">rd_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">trans</span> <span class="o">&gt;&gt;</span> <span class="n">AHB_DATA_LSB</span><span class="p">);</span>
		<span class="n">wr_data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rd_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">sz_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If mask is not zero, we need to write. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">sz_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AHB_ADDR_LSB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">trans</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">wr_data</span> <span class="o">&lt;&lt;</span> <span class="n">AHB_DATA_LSB</span><span class="p">);</span>
		<span class="n">trans</span> <span class="o">|=</span> <span class="n">AHB_WR</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_TRANS</span><span class="p">,</span> <span class="n">trans</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">tries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">AHB_TRANS_TRIES</span><span class="p">;</span> <span class="o">++</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">trans</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_TRANS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">trans</span> <span class="o">&amp;</span> <span class="n">AHB_TRANS_RDY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&gt;=</span> <span class="n">AHB_TRANS_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No Wr ahb_rdy in %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">AHB_TRANS_TRIES</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wr_data</span><span class="p">;</span>
<span class="nl">bail:</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">KR_AHB_ACC</span><span class="p">,</span> <span class="n">prev_acc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ibsd_wr_allchans</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">data</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rbc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">SERDES_CHANS</span><span class="p">;</span> <span class="o">++</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahb_mod</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">addr</span><span class="p">,</span>
			<span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">rbc</span> <span class="o">=</span> <span class="n">ahb_mod</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
			      <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serdes_7322_los_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">data</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_serdesctrl</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">state</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">IBSerdesCtrl_0</span><span class="p">,</span> <span class="n">RXLOSEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span> <span class="s">&quot; IB%u:%u Turning LOS on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSerdesCtrl_0</span><span class="p">,</span> <span class="n">RXLOSEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span> <span class="s">&quot; IB%u:%u Turning LOS off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSerdesCtrl_0</span><span class="p">,</span> <span class="n">RXLOSEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_serdesctrl</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_7322_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">serdes_7322_init_old</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">serdes_7322_init_new</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_7322_init_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">le_val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the Tx DDS tables.  Also done every QSFP event,</span>
<span class="cm">	 * for adapters with QSFP</span>
<span class="cm">	 */</span>
	<span class="n">init_txdds_table</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* ensure no tx overrides from earlier driver loads */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_tx_deemph_override</span><span class="p">,</span>
		<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
		<span class="n">reset_tx_deemphasis_override</span><span class="p">));</span>

	<span class="cm">/* Patch some SerDes defaults to &quot;Better for IB&quot; */</span>
	<span class="cm">/* Timing Loop Bandwidth: cdr_timing[11:9] = 0 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">));</span>

	<span class="cm">/* Termination: rxtermctrl_r2d addr 11 bits [12:11] = 1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
	<span class="cm">/* Enable LE2: rxle2en_r2a addr 13 bit [6] = 1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>

	<span class="cm">/* May be overridden in qsfp_7322_event */</span>
	<span class="n">le_val</span> <span class="o">=</span> <span class="n">IS_QME</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">)</span> <span class="o">?</span> <span class="n">LE2_QME</span> <span class="o">:</span> <span class="n">LE2_DEFAULT</span><span class="p">;</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="n">le_val</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">));</span>

	<span class="cm">/* enable LE1 adaptation for all but QME, which is disabled */</span>
	<span class="n">le_val</span> <span class="o">=</span> <span class="n">IS_QME</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="n">le_val</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>

	<span class="cm">/* Clear cmode-override, may be set from older driver */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="cm">/* Timing Recovery: rxtapsel addr 5 bits [9:8] = 0 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* setup LoS params; these are subsystem, so chan == 5 */</span>
	<span class="cm">/* LoS filter threshold_count on, ch 0-3, set to 8 */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* LoS filter threshold_count off, ch 0-3, set to 4 */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* LoS filter select enabled */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>

	<span class="cm">/* LoS target data:  SDR=4, DDR=2, QDR=1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span> <span class="cm">/* QDR */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span> <span class="cm">/* DDR */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">));</span> <span class="cm">/* SDR */</span>

	<span class="n">serdes_7322_los_enable</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* rxbistena; set 0 to avoid effects of it switch later */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>

	<span class="cm">/* Configure 4 DFE taps, and only they adapt */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* gain hi stop 32 (22) (6:1) lo stop 7 (10:7) target 22 (13) (15:11) */</span>
	<span class="n">le_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">||</span> <span class="n">IS_QME</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0xb6c0</span> <span class="o">:</span> <span class="mh">0x6bac</span><span class="p">;</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">le_val</span><span class="p">,</span> <span class="mh">0xfffe</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set receive adaptation mode.  SDR and DDR adaptation are</span>
<span class="cm">	 * always on, and QDR is initially enabled; later disabled.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
			    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">?</span>
			    <span class="n">QDR_STATIC_ADAPT_DOWN_R1</span> <span class="o">:</span> <span class="n">QDR_STATIC_ADAPT_DOWN</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* FLoop LOS gate: PPM filter  enabled */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* rx offset center enabled */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set the frequency loop bandwidth to 15 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdes_7322_init_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tend</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">le_val</span><span class="p">,</span> <span class="n">rxcaldone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">chan_done</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SERDES_CHANS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Clear cmode-override, may be set from older driver */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="cm">/* ensure no tx overrides from earlier driver loads */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_tx_deemph_override</span><span class="p">,</span>
		<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
		<span class="n">reset_tx_deemphasis_override</span><span class="p">));</span>

	<span class="cm">/* START OF LSI SUGGESTED SERDES BRINGUP */</span>
	<span class="cm">/* Reset - Calibration Setup */</span>
	<span class="cm">/*       Stop DFE adaptaion */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="cm">/*       Disable LE1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
	<span class="cm">/*       Disable autoadapt for LE1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">));</span>
	<span class="cm">/*       Disable LE2 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
	<span class="cm">/*       Disable VGA */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="cm">/*       Disable AFE Offset Cancel */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">));</span>
	<span class="cm">/*       Disable Timing Loop */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="cm">/*       Disable Frequency Loop */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="cm">/*       Disable Baseline Wander Correction */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">));</span>
	<span class="cm">/*       Disable RX Calibration */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
	<span class="cm">/*       Disable RX Offset Calibration */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="cm">/*       Select BB CDR */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">));</span>
	<span class="cm">/*       CDR Step Size */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
	<span class="cm">/*       Enable phase Calibration */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
	<span class="cm">/*       DFE Bandwidth [2:14-12] */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">));</span>
	<span class="cm">/*       DFE Config (4 taps only) */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="cm">/*       Gain Loop Bandwidth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">));</span>
		<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/*       Baseline Wander Correction Gain [13:4-0] (leave as default) */</span>
	<span class="cm">/*       Baseline Wander Correction Gain [3:7-5] (leave as default) */</span>
	<span class="cm">/*       Data Rate Select [5:7-6] (leave as default) */</span>
	<span class="cm">/*       RX Parallel Word Width [3:10-8] (leave as default) */</span>

	<span class="cm">/* RX REST */</span>
	<span class="cm">/*       Single- or Multi-channel reset */</span>
	<span class="cm">/*       RX Analog reset */</span>
	<span class="cm">/*       RX Digital reset */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/*       RX Analog reset */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/*       RX Digital reset */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* setup LoS params; these are subsystem, so chan == 5 */</span>
	<span class="cm">/* LoS filter threshold_count on, ch 0-3, set to 8 */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* LoS filter threshold_count off, ch 0-3, set to 4 */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* LoS filter select enabled */</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>

	<span class="cm">/* LoS target data:  SDR=4, DDR=2, QDR=1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span> <span class="cm">/* QDR */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span> <span class="cm">/* DDR */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">));</span> <span class="cm">/* SDR */</span>

	<span class="cm">/* Turn on LOS on initial SERDES init */</span>
	<span class="n">serdes_7322_los_enable</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* FLoop LOS gate: PPM filter  enabled */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* RX LATCH CALIBRATION */</span>
	<span class="cm">/*       Enable Eyefinder Phase Calibration latch */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="cm">/*       Enable RX Offset Calibration latch */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/*       Start Calibration */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">tend</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">chan_done</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">time_is_before_jiffies</span><span class="p">(</span><span class="n">tend</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">SERDES_CHANS</span><span class="p">;</span> <span class="o">++</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxcaldone</span> <span class="o">=</span> <span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
					    <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="n">rxcaldone</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">~</span><span class="n">chan_done</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">chan_done</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span>
			 <span class="s">&quot; Serdes %d calibration not done after .5 sec: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="n">chan_done</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">SERDES_CHANS</span><span class="p">;</span> <span class="o">++</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxcaldone</span> <span class="o">=</span> <span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
					    <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="n">rxcaldone</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">BMASK</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">QIB_DRV_NAME</span>
					 <span class="s">&quot; Serdes %d chan %d calibration &quot;</span>
					 <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="n">chan</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*       Turn off Calibration */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* BRING RX UP */</span>
	<span class="cm">/*       Set LE2 value (May be overridden in qsfp_7322_event) */</span>
	<span class="n">le_val</span> <span class="o">=</span> <span class="n">IS_QME</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">)</span> <span class="o">?</span> <span class="n">LE2_QME</span> <span class="o">:</span> <span class="n">LE2_DEFAULT</span><span class="p">;</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="n">le_val</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">));</span>
	<span class="cm">/*       Set LE2 Loop bandwidth */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
	<span class="cm">/*       Enable LE2 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/*       Enable H0 only */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="cm">/* gain hi stop 32 (22) (6:1) lo stop 7 (10:7) target 22 (13) (15:11) */</span>
	<span class="n">le_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">||</span> <span class="n">IS_QME</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0xb6c0</span> <span class="o">:</span> <span class="mh">0x6bac</span><span class="p">;</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">le_val</span><span class="p">,</span> <span class="mh">0xfffe</span><span class="p">);</span>
	<span class="cm">/*       Enable VGA */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/*       Set Frequency Loop Bandwidth */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
	<span class="cm">/*       Enable Frequency Loop */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="cm">/*       Set Timing Loop Bandwidth */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">));</span>
	<span class="cm">/*       Enable Timing Loop */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="cm">/*       Enable DFE</span>
<span class="cm">	 *       Set receive adaptation mode.  SDR and DDR adaptation are</span>
<span class="cm">	 *       always on, and QDR is initially enabled; later disabled.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_static_adapt_dis</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
			    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">?</span>
			    <span class="n">QDR_STATIC_ADAPT_DOWN_R1</span> <span class="o">:</span> <span class="n">QDR_STATIC_ADAPT_DOWN</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_dfe_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*       Disable LE1  */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
	<span class="cm">/*       Disable auto adapt for LE1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/*       Enable AFE Offset Cancel */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">));</span>
	<span class="cm">/*       Enable Baseline Wander Correction */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">));</span>
	<span class="cm">/* Termination: rxtermctrl_r2d addr 11 bits [12:11] = 1 */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
	<span class="cm">/* VGA output common mode */</span>
	<span class="n">ibsd_wr_allchans</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">BMASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the Tx DDS tables.  Also done every QSFP event,</span>
<span class="cm">	 * for adapters with QSFP</span>
<span class="cm">	 */</span>
	<span class="n">init_txdds_table</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* start adjust QMH serdes parameters */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_man_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
		<span class="mi">9</span><span class="p">,</span> <span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x3f</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_man_mode_h1</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tapenable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
			<span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
			<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set clock to 1, 0, 1, 0 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clock_man</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">ahb_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">IBSD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">hw_pidx</span><span class="p">),</span> <span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write the current Tx serdes pre,post,main,amp settings into the serdes.</span>
<span class="cm"> * The caller must pass the settings appropriate for the current speed,</span>
<span class="cm"> * or not care if they are correct for the current speed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_tx_serdes_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="n">txdds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">deemph</span><span class="p">;</span>

	<span class="n">deemph</span> <span class="o">=</span> <span class="n">qib_read_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_tx_deemph_override</span><span class="p">);</span>
	<span class="cm">/* field names for amp, main, post, pre, respectively */</span>
	<span class="n">deemph</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span> <span class="n">txampcntl_d2a</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span> <span class="n">txc0_ena</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span> <span class="n">txcp1_ena</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span> <span class="n">txcn1_ena</span><span class="p">));</span>

	<span class="n">deemph</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
			   <span class="n">tx_override_deemphasis_select</span><span class="p">);</span>
	<span class="n">deemph</span> <span class="o">|=</span> <span class="p">(</span><span class="n">txdds</span><span class="o">-&gt;</span><span class="n">amp</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
		    <span class="n">txampcntl_d2a</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
				       <span class="n">txampcntl_d2a</span><span class="p">);</span>
	<span class="n">deemph</span> <span class="o">|=</span> <span class="p">(</span><span class="n">txdds</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
		     <span class="n">txc0_ena</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
				   <span class="n">txc0_ena</span><span class="p">);</span>
	<span class="n">deemph</span> <span class="o">|=</span> <span class="p">(</span><span class="n">txdds</span><span class="o">-&gt;</span><span class="n">post</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
		     <span class="n">txcp1_ena</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
				    <span class="n">txcp1_ena</span><span class="p">);</span>
	<span class="n">deemph</span> <span class="o">|=</span> <span class="p">(</span><span class="n">txdds</span><span class="o">-&gt;</span><span class="n">pre</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
		     <span class="n">txcn1_ena</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBSD_TX_DEEMPHASIS_OVERRIDE_0</span><span class="p">,</span>
				    <span class="n">txcn1_ena</span><span class="p">);</span>
	<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_tx_deemph_override</span><span class="p">,</span> <span class="n">deemph</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the parameters for mez cards on link bounce, so they are</span>
<span class="cm"> * always exactly what was requested.  Similar logic to init_txdds</span>
<span class="cm"> * but does just the serdes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adj_tx_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="n">sdr_dds</span><span class="p">,</span> <span class="o">*</span><span class="n">ddr_dds</span><span class="p">,</span> <span class="o">*</span><span class="n">qdr_dds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="n">dds</span><span class="p">;</span>

	<span class="n">find_best_ent</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdr_dds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddr_dds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdr_dds</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">txdds_ent</span> <span class="o">*</span><span class="p">)(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_QDR</span> <span class="o">?</span>
		<span class="n">qdr_dds</span> <span class="o">:</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span> <span class="o">?</span>
				<span class="n">ddr_dds</span> <span class="o">:</span> <span class="n">sdr_dds</span><span class="p">));</span>
	<span class="n">write_tx_serdes_param</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">dds</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set QDR forced value for H1, if needed */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">force_h1</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">qdr_reforce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">SERDES_CHANS</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_man_mode_h1</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_man_code</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">h1_val</span><span class="p">);</span>
		<span class="n">clock_man</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">set_man_mode_h1</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define SJA_EN SYM_MASK(SPC_JTAG_ACCESS_REG, SPC_JTAG_ACCESS_EN)</span>
<span class="cp">#define BISTEN_LSB SYM_LSB(SPC_JTAG_ACCESS_REG, bist_en)</span>

<span class="cp">#define R_OPCODE_LSB 3</span>
<span class="cp">#define R_OP_NOP 0</span>
<span class="cp">#define R_OP_SHIFT 2</span>
<span class="cp">#define R_OP_UPDATE 3</span>
<span class="cp">#define R_TDI_LSB 2</span>
<span class="cp">#define R_TDO_LSB 1</span>
<span class="cp">#define R_RDY 1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_r_grab</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SJA_EN</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_r_access</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* qib_r_wait_for_rdy() not only waits for the ready bit, it</span>
<span class="cm"> * returns the current state of R_TDO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_r_wait_for_rdy</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="p">;</span> <span class="o">++</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_r_access</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">R_RDY</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">R_TDO_LSB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_r_shift</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bisten</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">inp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">outp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">valbase</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">valbase</span> <span class="o">=</span> <span class="n">SJA_EN</span> <span class="o">|</span> <span class="p">(</span><span class="n">bisten</span> <span class="o">&lt;&lt;</span> <span class="n">BISTEN_LSB</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">R_OP_SHIFT</span> <span class="o">&lt;&lt;</span> <span class="n">R_OPCODE_LSB</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_r_wait_for_rdy</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">valbase</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">outp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outp</span><span class="p">[</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
			<span class="n">outp</span><span class="p">[</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tdi</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">tdi</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">R_TDI_LSB</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_r_access</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_r_wait_for_rdy</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Restore to NOP between operations. */</span>
	<span class="n">val</span> <span class="o">=</span>  <span class="n">SJA_EN</span> <span class="o">|</span> <span class="p">(</span><span class="n">bisten</span> <span class="o">&lt;&lt;</span> <span class="n">BISTEN_LSB</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_r_access</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_r_wait_for_rdy</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_r_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bisten</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">SJA_EN</span> <span class="o">|</span> <span class="p">(</span><span class="n">bisten</span> <span class="o">&lt;&lt;</span> <span class="n">BISTEN_LSB</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">R_OP_UPDATE</span> <span class="o">&lt;&lt;</span> <span class="n">R_OPCODE_LSB</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_r_wait_for_rdy</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_r_access</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BISTEN_PORT_SEL 15</span>
<span class="cp">#define LEN_PORT_SEL 625</span>
<span class="cp">#define BISTEN_AT 17</span>
<span class="cp">#define LEN_AT 156</span>
<span class="cp">#define BISTEN_ETM 16</span>
<span class="cp">#define LEN_ETM 632</span>

<span class="cp">#define BIT2BYTE(x) (((x) +  BITS_PER_BYTE - 1) / BITS_PER_BYTE)</span>

<span class="cm">/* these are common for all IB port use cases. */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">reset_at</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_AT</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">reset_atetm</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_ETM</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span>
	<span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">at</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_AT</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* used for IB1 or IB2, only one in use */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">atetm_1port</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_ETM</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* used when both IB1 and IB2 are in use */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">atetm_2port</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_ETM</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span>
	<span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* used when only IB1 is in use */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">portsel_port1</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_PORT_SEL</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* used when only IB2 is in use */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">portsel_port2</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_PORT_SEL</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span>
	<span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span>
	<span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span>
	<span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span>
	<span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span>
	<span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* used when both IB1 and IB2 are in use */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">portsel_2port</span><span class="p">[</span><span class="n">BIT2BYTE</span><span class="p">(</span><span class="n">LEN_PORT_SEL</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span>
	<span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Do setup to properly handle IB link recovery; if port is zero, we</span>
<span class="cm"> * are initializing to cover both ports; otherwise we are initializing</span>
<span class="cm"> * to cover a single port card, or the port has reached INIT and we may</span>
<span class="cm"> * need to switch coverage types.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_7322_link_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">both</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">portsel</span><span class="p">,</span> <span class="o">*</span><span class="n">etm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">both</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">recovery_ports_initted</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">recovery_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">both</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">recovery_ports_initted</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">portsel</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">portsel_port1</span> <span class="o">:</span> <span class="n">portsel_port2</span><span class="p">;</span>
		<span class="n">etm</span> <span class="o">=</span> <span class="n">atetm_1port</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">portsel</span> <span class="o">=</span> <span class="n">portsel_2port</span><span class="p">;</span>
		<span class="n">etm</span> <span class="o">=</span> <span class="n">atetm_2port</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_r_grab</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_shift</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_ETM</span><span class="p">,</span> <span class="n">LEN_ETM</span><span class="p">,</span> <span class="n">reset_atetm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_update</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_ETM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_shift</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_AT</span><span class="p">,</span> <span class="n">LEN_AT</span><span class="p">,</span> <span class="n">reset_at</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_update</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_AT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_shift</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_PORT_SEL</span><span class="p">,</span> <span class="n">LEN_PORT_SEL</span><span class="p">,</span>
			    <span class="n">portsel</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_update</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_PORT_SEL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_shift</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_AT</span><span class="p">,</span> <span class="n">LEN_AT</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_update</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_AT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_shift</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_ETM</span><span class="p">,</span> <span class="n">LEN_ETM</span><span class="p">,</span> <span class="n">etm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">qib_r_update</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">BISTEN_ETM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed IB link recovery setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_7322_rxe_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">recovery_ports_initted</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* rest doesn&#39;t apply to dualport */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|</span>
		       <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">Control</span><span class="p">,</span> <span class="n">FreezeMode</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="cm">/* ibcreset asserted 400ns, be sure that&#39;s over */</span>
	<span class="n">fmask</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_act_fmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * require a powercycle before we&#39;ll work again, and make</span>
<span class="cm">		 * sure we get no more interrupts, and don&#39;t turn off</span>
<span class="cm">		 * freeze.</span>
<span class="cm">		 */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">stay_in_freeze</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qib_7322_set_intr_state</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_fmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;HCA unusable until powercycled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* eventually reset */</span>
	<span class="p">}</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span>
	    <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwErrClear</span><span class="p">,</span> <span class="n">IBSerdesPClkNotDetectClear_1</span><span class="p">));</span>

	<span class="cm">/* don&#39;t do the full clear_freeze(), not needed for this */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="cm">/* take IBC out of reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrlA_0</span><span class="p">,</span> <span class="n">IBStatIntReductionEn</span><span class="p">);</span>
		<span class="n">qib_write_kreg_port</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">krp_ibcctrl_a</span><span class="p">,</span>
				    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl_a</span><span class="p">);</span>
		<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_LINK_DISABLED</span><span class="p">)</span>
			<span class="n">qib_set_ib_7322_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
