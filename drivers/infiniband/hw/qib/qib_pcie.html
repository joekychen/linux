<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › qib › qib_pcie.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>qib_pcie.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008, 2009 QLogic Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;qib.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * This file contains PCIe utility routines that are common to the</span>
<span class="cm"> * various QLogic InfiniPath adapters</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Code to adjust PCIe capabilities.</span>
<span class="cm"> * To minimize the change footprint, we call it</span>
<span class="cm"> * from qib_pcie_params, which every chip-specific</span>
<span class="cm"> * file calls, even though this violates some</span>
<span class="cm"> * expectations of harmlessness.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qib_tune_pcie_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qib_tune_pcie_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Do all the common PCIe setup and initialization.</span>
<span class="cm"> * devdata is not yet allocated, and is not allocated until after this</span>
<span class="cm"> * routine returns success.  Therefore qib_dev_err() can&#39;t be used for error</span>
<span class="cm"> * printing.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qib_pcie_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This can happen (in theory) iff:</span>
<span class="cm">		 * We did a chip reset, and then failed to reprogram the</span>
<span class="cm">		 * BAR, or the chip reset due to an internal error.  We then</span>
<span class="cm">		 * unloaded the driver and reloaded it.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Both reset cases set the BAR back to initial state.  For</span>
<span class="cm">		 * the latter case, the AER sticky error bit at offset 0x718</span>
<span class="cm">		 * should be set, but the Linux kernel doesn&#39;t yet know</span>
<span class="cm">		 * about that, it appears.  If the original BAR was retained</span>
<span class="cm">		 * in the kernel data structures, this may be OK.</span>
<span class="cm">		 */</span>
		<span class="n">qib_early_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci enable failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">QIB_DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;pci_request_regions fails: err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the 64 bit setup fails, try 32 bit.  Some systems</span>
<span class="cm">		 * do not setup 64 bit maps on systems with 2GB or less</span>
<span class="cm">		 * memory installed.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;Unable to set DMA mask: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_early_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;Unable to set DMA consistent mask: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_early_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;Unable to enable pcie error reporting: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">bail:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do remaining PCIe setup, once dd is allocated, and save away</span>
<span class="cm"> * fields required to re-initialize after a chip reset, or for</span>
<span class="cm"> * various other purposes</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qib_pcie_ddinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#if defined(__powerpc__)</span>
	<span class="cm">/* There isn&#39;t a generic way to specify writethrough mappings */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">=</span> <span class="n">__ioremap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">_PAGE_NO_CACHE</span> <span class="o">|</span> <span class="n">_PAGE_WRITETHRU</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregend</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">physaddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>        <span class="cm">/* used for io_remap, etc. */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save BARs to rewrite after device reset.  Save all 64 bits of</span>
<span class="cm">	 * BAR, just in case.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcibar0</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcibar1</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">deviceid</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span> <span class="cm">/* save for later use */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">vendorid</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do PCIe cleanup, after chip-specific cleanup, etc.  Just prior</span>
<span class="cm"> * to releasing the dd memory.</span>
<span class="cm"> * void because none of the core pcie cleanup returns are void</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qib_pcie_ddcleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piovl15base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piovl15base</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_msix_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">msixcnt</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">qib_msix_entry</span> <span class="o">*</span><span class="n">qib_msix_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tabsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">msix_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">msix_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We can&#39;t pass qib_msix_entry array to qib_msix_setup</span>
<span class="cm">	 * so use a dummy msix_entry array and copy the allocated</span>
<span class="cm">	 * irq back to the qib_msix_entry array. */</span>
	<span class="n">msix_entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="o">*</span><span class="n">msixcnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msix_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msix_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">do_intx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">msixcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">msix_entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_msix_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msix</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msix_flags</span><span class="p">);</span>
	<span class="n">tabsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">msix_flags</span> <span class="o">&amp;</span> <span class="n">PCI_MSIX_FLAGS_QSIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tabsize</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">msixcnt</span><span class="p">)</span>
		<span class="n">tabsize</span> <span class="o">=</span> <span class="o">*</span><span class="n">msixcnt</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">msix_entry</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tabsize</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">msix_entry</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">do_intx:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;pci_enable_msix %d vectors failed: %d, &quot;</span>
			    <span class="s">&quot;falling back to INTx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">tabsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tabsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qib_msix_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msix</span> <span class="o">=</span> <span class="n">msix_entry</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msix_entry</span><span class="p">);</span>
	<span class="o">*</span><span class="n">msixcnt</span> <span class="o">=</span> <span class="n">tabsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">qib_enable_intx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * We save the msi lo and hi values, so we can restore them after</span>
<span class="cm"> * chip reset (the kernel PCI infrastructure doesn&#39;t yet handle that</span>
<span class="cm"> * correctly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_msi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;pci_enable_msi failed: %d, &quot;</span>
			    <span class="s">&quot;interrupts may not work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="cm">/* continue even if it fails, we may still be OK... */</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_ADDRESS_LO</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_lo</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_ADDRESS_HI</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_hi</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="cm">/* now save the data (vector) info */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_MSI_FLAGS_64BIT</span><span class="p">)</span>
				    <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">8</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qib_pcie_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">minw</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">nent</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">qib_msix_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">linkstat</span><span class="p">,</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pose</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Can&#39;t find PCI Express capability!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* set up something... */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_speed</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">;</span> <span class="cm">/* Gen1, 2.5GHz */</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nent</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">nent</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_msix_setup</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* did it, either MSIx or INTx */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_msi_setup</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No PCI MSI or MSIx capability!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="n">qib_enable_intx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pose</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkstat</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * speed is bits 0-3, linkwidth is bits 4-8</span>
<span class="cm">	 * no defines for them in headers</span>
<span class="cm">	 */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">linkstat</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">linkstat</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">linkstat</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_width</span> <span class="o">=</span> <span class="n">linkstat</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_speed</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">;</span> <span class="cm">/* Gen1, 2.5GHz */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="cm">/* Gen1, 5GHz */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* not defined, assume gen1 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_speed</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check against expected pcie width and complain if &quot;wrong&quot;</span>
<span class="cm">	 * on first initialization, not afterwards (i.e., reset).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minw</span> <span class="o">&amp;&amp;</span> <span class="n">linkstat</span> <span class="o">&lt;</span> <span class="n">minw</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			    <span class="s">&quot;PCIe width %u (x%u HCA), performance reduced</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">linkstat</span><span class="p">,</span> <span class="n">minw</span><span class="p">);</span>

	<span class="n">qib_tune_pcie_caps</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">qib_tune_pcie_coalesce</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

<span class="nl">bail:</span>
	<span class="cm">/* fill in string, even on errors */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_info</span><span class="p">),</span>
		 <span class="s">&quot;PCIe,%uMHz,x%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_speed</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_width</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup pcie interrupt stuff again after a reset.  I&#39;d like to just call</span>
<span class="cm"> * pci_enable_msi() again for msi, but when I do that,</span>
<span class="cm"> * the MSI enable bit doesn&#39;t get set in the command word, and</span>
<span class="cm"> * we switch to to a different interrupt vector, which is confusing,</span>
<span class="cm"> * so I instead just do it all inline.  Perhaps somehow can tie this</span>
<span class="cm"> * into the PCIe hotplug support at some point</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qib_reinit_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we aren&#39;t using MSI, don&#39;t restore it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_lo</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Can&#39;t find MSI capability, &quot;</span>
			    <span class="s">&quot;can&#39;t restore MSI settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* nothing special for MSIx, just MSI */</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_ADDRESS_LO</span><span class="p">,</span>
			       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_lo</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_ADDRESS_HI</span><span class="p">,</span>
			       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_hi</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_MSI_FLAGS_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_MSI_FLAGS_ENABLE</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span>
				      <span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* now rewrite the data (vector) info */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span>
			      <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_MSI_FLAGS_64BIT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">8</span><span class="p">),</span>
			      <span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_data</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">bail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_INTX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_enable_intx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* and now set the pci master bit again */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable msi interrupt if enabled, and clear msi_lo.</span>
<span class="cm"> * This is used primarily for the fallback to INTx, but</span>
<span class="cm"> * is also used in reinit after reset, and during cleanup.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qib_nomsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Same as qib_nosmi, but for MSIx.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qib_nomsix</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Similar to pci_intx(pdev, 1), except that we make sure</span>
<span class="cm"> * msi(x) is off.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qib_enable_intx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cw</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="cm">/* first, turn on INTx */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cw</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">cw</span><span class="p">)</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* then turn off MSI */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cw</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_MSI_FLAGS_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">cw</span><span class="p">)</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* then turn off MSIx */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cw</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">cw</span><span class="p">)</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These two routines are helper routines for the device reset code</span>
<span class="cm"> * to move all the pcie code out of the chip-specific driver code.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qib_pcie_getcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">iline</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">iline</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">cline</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qib_pcie_reenable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">iline</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span>
				   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcibar0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;rewrite of BAR0 failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span>
				   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcibar1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;rewrite of BAR1 failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="cm">/* now re-enable memory access, and restore cosmetic settings */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">iline</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">cline</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;pci_enable_device failed after &quot;</span>
			    <span class="s">&quot;reset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* code to adjust PCIe capabilities. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fld2val</span><span class="p">(</span><span class="kt">int</span> <span class="n">wd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lsbmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wd</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">lsbmask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">^</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">wd</span> <span class="o">/=</span> <span class="n">lsbmask</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">val2fld</span><span class="p">(</span><span class="kt">int</span> <span class="n">wd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lsbmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lsbmask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">^</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">wd</span> <span class="o">*=</span> <span class="n">lsbmask</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qib_pcie_coalesce</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">pcie_coalesce</span><span class="p">,</span> <span class="n">qib_pcie_coalesce</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pcie_coalesce</span><span class="p">,</span> <span class="s">&quot;tune PCIe colescing on some Intel chipsets&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Enable PCIe completion and data coalescing, on Intel 5x00 and 7300</span>
<span class="cm"> * chipsets.   This is known to be unsafe for some revisions of some</span>
<span class="cm"> * of these chipsets, with some BIOS settings, and enabling it on those</span>
<span class="cm"> * systems may result in the system crashing, and/or data corruption.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_tune_pcie_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ppos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_pcie_coalesce</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Find out supported and configured values for parent (root) */</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Parent not root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ppos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="mh">0x8086</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  - bit 12: Max_rdcmp_Imt_EN: need to set to 1</span>
<span class="cm">	 *  - bit 11: COALESCE_FORCE: need to set to 0</span>
<span class="cm">	 *  - bit 10: COALESCE_EN: need to set to 1</span>
<span class="cm">	 *  (but limitations on some on some chipsets)</span>
<span class="cm">	 *</span>
<span class="cm">	 *  On the Intel 5000, 5100, and 7300 chipsets, there is</span>
<span class="cm">	 *  also: - bit 25:24: COALESCE_MODE, need to set to 0</span>
<span class="cm">	 */</span>
	<span class="n">devid</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&gt;=</span> <span class="mh">0x25e2</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">&lt;=</span> <span class="mh">0x25fa</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 5000 P/V/X/Z */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="mh">0xb2</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">7U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3U</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">7U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&gt;=</span> <span class="mh">0x65e2</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">&lt;=</span> <span class="mh">0x65fa</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 5100 */</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3U</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">7U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&gt;=</span> <span class="mh">0x4021</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">&lt;=</span> <span class="mh">0x402e</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 5400 */</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">7U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mi">7U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&gt;=</span> <span class="mh">0x3604</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">&lt;=</span> <span class="mh">0x360a</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 7300 */</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">7U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3U</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">7U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* not one of the chipsets that we know about */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BIOS may not set PCIe bus-utilization parameters for best performance.</span>
<span class="cm"> * Check and optionally adjust them to maximize our throughput.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qib_pcie_caps</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">pcie_caps</span><span class="p">,</span> <span class="n">qib_pcie_caps</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pcie_caps</span><span class="p">,</span> <span class="s">&quot;Max PCIe tuning: Payload (0..3), ReadReq (4..7)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_tune_pcie_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Assume the worst */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">epos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pcaps</span><span class="p">,</span> <span class="n">pctl</span><span class="p">,</span> <span class="n">ecaps</span><span class="p">,</span> <span class="n">ectl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_sup</span><span class="p">,</span> <span class="n">ep_sup</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_cur</span><span class="p">,</span> <span class="n">ep_cur</span><span class="p">;</span>

	<span class="cm">/* Find out supported and configured values for parent (root) */</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Parent not root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ppos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ppos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcaps</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ppos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="cm">/* Find out supported and configured values for endpoint (us) */</span>
	<span class="n">epos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">epos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecaps</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">epos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ectl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Find max payload supported by root, endpoint */</span>
	<span class="n">rc_sup</span> <span class="o">=</span> <span class="n">fld2val</span><span class="p">(</span><span class="n">pcaps</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCAP_PAYLOAD</span><span class="p">);</span>
	<span class="n">ep_sup</span> <span class="o">=</span> <span class="n">fld2val</span><span class="p">(</span><span class="n">ecaps</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCAP_PAYLOAD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_sup</span> <span class="o">&gt;</span> <span class="n">ep_sup</span><span class="p">)</span>
		<span class="n">rc_sup</span> <span class="o">=</span> <span class="n">ep_sup</span><span class="p">;</span>

	<span class="n">rc_cur</span> <span class="o">=</span> <span class="n">fld2val</span><span class="p">(</span><span class="n">pctl</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">);</span>
	<span class="n">ep_cur</span> <span class="o">=</span> <span class="n">fld2val</span><span class="p">(</span><span class="n">ectl</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">);</span>

	<span class="cm">/* If Supported greater than limit in module param, limit it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_sup</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">qib_pcie_caps</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="n">rc_sup</span> <span class="o">=</span> <span class="n">qib_pcie_caps</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="cm">/* If less than (allowed, supported), bump root payload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_sup</span> <span class="o">&gt;</span> <span class="n">rc_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc_cur</span> <span class="o">=</span> <span class="n">rc_sup</span><span class="p">;</span>
		<span class="n">pctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">pctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">val2fld</span><span class="p">(</span><span class="n">rc_cur</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ppos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">pctl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* If less than (allowed, supported), bump endpoint payload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_sup</span> <span class="o">&gt;</span> <span class="n">ep_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep_cur</span> <span class="o">=</span> <span class="n">rc_sup</span><span class="p">;</span>
		<span class="n">ectl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ectl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">val2fld</span><span class="p">(</span><span class="n">ep_cur</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">epos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">ectl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now the Read Request size.</span>
<span class="cm">	 * No field for max supported, but PCIe spec limits it to 4096,</span>
<span class="cm">	 * which is code &#39;5&#39; (log2(4096) - 7)</span>
<span class="cm">	 */</span>
	<span class="n">rc_sup</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_sup</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">qib_pcie_caps</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="n">rc_sup</span> <span class="o">=</span> <span class="p">(</span><span class="n">qib_pcie_caps</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">rc_cur</span> <span class="o">=</span> <span class="n">fld2val</span><span class="p">(</span><span class="n">pctl</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">);</span>
	<span class="n">ep_cur</span> <span class="o">=</span> <span class="n">fld2val</span><span class="p">(</span><span class="n">ectl</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc_sup</span> <span class="o">&gt;</span> <span class="n">rc_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc_cur</span> <span class="o">=</span> <span class="n">rc_sup</span><span class="p">;</span>
		<span class="n">pctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">pctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">val2fld</span><span class="p">(</span><span class="n">rc_cur</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ppos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">pctl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_sup</span> <span class="o">&gt;</span> <span class="n">ep_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep_cur</span> <span class="o">=</span> <span class="n">rc_sup</span><span class="p">;</span>
		<span class="n">ectl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ectl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">val2fld</span><span class="p">(</span><span class="n">ep_cur</span><span class="p">,</span> <span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">epos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">ectl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* End of PCIe capability tuning */</span>

<span class="cm">/*</span>
<span class="cm"> * From here through qib_pci_err_handler definition is invoked via</span>
<span class="cm"> * PCI error infrastructure, registered via pci</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qib_pci_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_ers_result_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pci_channel_io_normal</span>:
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;State Normal, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">pci_channel_io_frozen</span>:
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;State Frozen, requesting reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">pci_channel_io_perm_failure</span>:
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;State Permanent Failure, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no more register accesses! */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_PRESENT</span><span class="p">;</span>
			<span class="n">qib_disable_after_error</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="p">}</span>
		 <span class="cm">/* else early, or other problem */</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="cm">/* shouldn&#39;t happen */</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;QIB PCI errors detected (state %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qib_pci_mmio_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">words</span> <span class="o">=</span> <span class="mi">0U</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_ers_result_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">words</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_portcntr</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIBPORTCNTR_WORDRCV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;QIB mmio_enabled function called, &quot;</span>
		 <span class="s">&quot;read wordscntr %Lx, returning %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span>  <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qib_pci_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;QIB link_reset function called, ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_CAN_RECOVER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qib_pci_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;QIB link_reset function called, ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_CAN_RECOVER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qib_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;QIB resume function called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Running jobs will fail, since it&#39;s asynchronous</span>
<span class="cm">	 * unlike sysfs-requested reset.   Better than</span>
<span class="cm">	 * doing nothing.</span>
<span class="cm">	 */</span>
	<span class="n">qib_init</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* same as re-init after reset */</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">qib_pci_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">qib_pci_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmio_enabled</span> <span class="o">=</span> <span class="n">qib_pci_mmio_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span> <span class="o">=</span> <span class="n">qib_pci_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">qib_pci_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">qib_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
