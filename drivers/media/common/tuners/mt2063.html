<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › common › tuners › mt2063.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mt2063.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for mt2063 Micronas tuner</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011 Mauro Carvalho Chehab &lt;mchehab@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This driver came from a driver originally written by:</span>
<span class="cm"> *		Henry Wang &lt;Henry.wang@AzureWave.com&gt;</span>
<span class="cm"> * Made publicly available by Terratec, at:</span>
<span class="cm"> *	http://linux.terratec.de/files/TERRATEC_H7/20110323_TERRATEC_H7_Linux.tar.gz</span>
<span class="cm"> * The original driver&#39;s license is GPL, as declared with MODULE_LICENSE()</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation under version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>

<span class="cp">#include &quot;mt2063.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Set Verbosity level&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(level, fmt, arg...) do {				\</span>
<span class="cp">if (debug &gt;= level)							\</span>
<span class="cp">	printk(KERN_DEBUG &quot;mt2063 %s: &quot; fmt, __func__, ## arg);	\</span>
<span class="cp">} while (0)</span>


<span class="cm">/* positive error codes used internally */</span>

<span class="cm">/*  Info: Unavoidable LO-related spur may be present in the output  */</span>
<span class="cp">#define MT2063_SPUR_PRESENT_ERR             (0x00800000)</span>

<span class="cm">/*  Info: Mask of bits used for # of LO-related spurs that were avoided during tuning  */</span>
<span class="cp">#define MT2063_SPUR_CNT_MASK                (0x001f0000)</span>
<span class="cp">#define MT2063_SPUR_SHIFT                   (16)</span>

<span class="cm">/*  Info: Upconverter frequency is out of range (may be reason for MT_UPC_UNLOCK) */</span>
<span class="cp">#define MT2063_UPC_RANGE                    (0x04000000)</span>

<span class="cm">/*  Info: Downconverter frequency is out of range (may be reason for MT_DPC_UNLOCK) */</span>
<span class="cp">#define MT2063_DNC_RANGE                    (0x08000000)</span>

<span class="cm">/*</span>
<span class="cm"> *  Constant defining the version of the following structure</span>
<span class="cm"> *  and therefore the API for this code.</span>
<span class="cm"> *</span>
<span class="cm"> *  When compiling the tuner driver, the preprocessor will</span>
<span class="cm"> *  check against this version number to make sure that</span>
<span class="cm"> *  it matches the version that the tuner driver knows about.</span>
<span class="cm"> */</span>

<span class="cm">/* DECT Frequency Avoidance */</span>
<span class="cp">#define MT2063_DECT_AVOID_US_FREQS      0x00000001</span>

<span class="cp">#define MT2063_DECT_AVOID_EURO_FREQS    0x00000002</span>

<span class="cp">#define MT2063_EXCLUDE_US_DECT_FREQUENCIES(s) (((s) &amp; MT2063_DECT_AVOID_US_FREQS) != 0)</span>

<span class="cp">#define MT2063_EXCLUDE_EURO_DECT_FREQUENCIES(s) (((s) &amp; MT2063_DECT_AVOID_EURO_FREQS) != 0)</span>

<span class="k">enum</span> <span class="n">MT2063_DECT_Avoid_Type</span> <span class="p">{</span>
	<span class="n">MT2063_NO_DECT_AVOIDANCE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>				<span class="cm">/* Do not create DECT exclusion zones.     */</span>
	<span class="n">MT2063_AVOID_US_DECT</span> <span class="o">=</span> <span class="n">MT2063_DECT_AVOID_US_FREQS</span><span class="p">,</span>	<span class="cm">/* Avoid US DECT frequencies.              */</span>
	<span class="n">MT2063_AVOID_EURO_DECT</span> <span class="o">=</span> <span class="n">MT2063_DECT_AVOID_EURO_FREQS</span><span class="p">,</span>	<span class="cm">/* Avoid European DECT frequencies.        */</span>
	<span class="n">MT2063_AVOID_BOTH</span>					<span class="cm">/* Avoid both regions. Not typically used. */</span>
<span class="p">};</span>

<span class="cp">#define MT2063_MAX_ZONES 48</span>

<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">min_</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Structure of data needed for Spur Avoidance</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">f_ref</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_in</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_LO1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_if1_Center</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_if1_Request</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_if1_bw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_LO2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_out</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_out_bw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_LO1_Step</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_LO2_Step</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_LO1_FracN_Avoid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_LO2_FracN_Avoid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_zif_bw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_min_LO_Separation</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maxH1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maxH2</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">MT2063_DECT_Avoid_Type</span> <span class="n">avoidDECT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bSpurPresent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bSpurAvoided</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nSpursFound</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nZones</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">freeZones</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">usedZones</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="n">MT2063_ExclZones</span><span class="p">[</span><span class="n">MT2063_MAX_ZONES</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Parameter for function MT2063_SetPowerMask that specifies the power down</span>
<span class="cm"> * of various sections of the MT2063.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">MT2063_Mask_Bits</span> <span class="p">{</span>
	<span class="n">MT2063_REG_SD</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span>		<span class="cm">/* Shutdown regulator                 */</span>
	<span class="n">MT2063_SRO_SD</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>		<span class="cm">/* Shutdown SRO                       */</span>
	<span class="n">MT2063_AFC_SD</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>		<span class="cm">/* Shutdown AFC A/D                   */</span>
	<span class="n">MT2063_PD_SD</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>		<span class="cm">/* Enable power detector shutdown     */</span>
	<span class="n">MT2063_PDADC_SD</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>	<span class="cm">/* Enable power detector A/D shutdown */</span>
	<span class="n">MT2063_VCO_SD</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>		<span class="cm">/* Enable VCO shutdown                */</span>
	<span class="n">MT2063_LTX_SD</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>		<span class="cm">/* Enable LTX shutdown                */</span>
	<span class="n">MT2063_LT1_SD</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>		<span class="cm">/* Enable LT1 shutdown                */</span>
	<span class="n">MT2063_LNA_SD</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>		<span class="cm">/* Enable LNA shutdown                */</span>
	<span class="n">MT2063_UPC_SD</span> <span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>		<span class="cm">/* Enable upconverter shutdown        */</span>
	<span class="n">MT2063_DNC_SD</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>		<span class="cm">/* Enable downconverter shutdown      */</span>
	<span class="n">MT2063_VGA_SD</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>		<span class="cm">/* Enable VGA shutdown                */</span>
	<span class="n">MT2063_AMP_SD</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>		<span class="cm">/* Enable AMP shutdown                */</span>
	<span class="n">MT2063_ALL_SD</span> <span class="o">=</span> <span class="mh">0xFF73</span><span class="p">,</span>		<span class="cm">/* All shutdown bits for this tuner   */</span>
	<span class="n">MT2063_NONE_SD</span> <span class="o">=</span> <span class="mh">0x0000</span>		<span class="cm">/* No shutdown bits                   */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Possible values for MT2063_DNC_OUTPUT</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">MT2063_DNC_Output_Enable</span> <span class="p">{</span>
	<span class="n">MT2063_DNC_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MT2063_DNC_1</span><span class="p">,</span>
	<span class="n">MT2063_DNC_2</span><span class="p">,</span>
	<span class="n">MT2063_DNC_BOTH</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Two-wire serial bus subaddresses of the tuner registers.</span>
<span class="cm"> *  Also known as the tuner&#39;s register addresses.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">MT2063_Register_Offsets</span> <span class="p">{</span>
	<span class="n">MT2063_REG_PART_REV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/*  0x00: Part/Rev Code         */</span>
	<span class="n">MT2063_REG_LO1CQ_1</span><span class="p">,</span>		<span class="cm">/*  0x01: LO1C Queued Byte 1    */</span>
	<span class="n">MT2063_REG_LO1CQ_2</span><span class="p">,</span>		<span class="cm">/*  0x02: LO1C Queued Byte 2    */</span>
	<span class="n">MT2063_REG_LO2CQ_1</span><span class="p">,</span>		<span class="cm">/*  0x03: LO2C Queued Byte 1    */</span>
	<span class="n">MT2063_REG_LO2CQ_2</span><span class="p">,</span>		<span class="cm">/*  0x04: LO2C Queued Byte 2    */</span>
	<span class="n">MT2063_REG_LO2CQ_3</span><span class="p">,</span>		<span class="cm">/*  0x05: LO2C Queued Byte 3    */</span>
	<span class="n">MT2063_REG_RSVD_06</span><span class="p">,</span>		<span class="cm">/*  0x06: Reserved              */</span>
	<span class="n">MT2063_REG_LO_STATUS</span><span class="p">,</span>		<span class="cm">/*  0x07: LO Status             */</span>
	<span class="n">MT2063_REG_FIFFC</span><span class="p">,</span>		<span class="cm">/*  0x08: FIFF Center           */</span>
	<span class="n">MT2063_REG_CLEARTUNE</span><span class="p">,</span>		<span class="cm">/*  0x09: ClearTune Filter      */</span>
	<span class="n">MT2063_REG_ADC_OUT</span><span class="p">,</span>		<span class="cm">/*  0x0A: ADC_OUT               */</span>
	<span class="n">MT2063_REG_LO1C_1</span><span class="p">,</span>		<span class="cm">/*  0x0B: LO1C Byte 1           */</span>
	<span class="n">MT2063_REG_LO1C_2</span><span class="p">,</span>		<span class="cm">/*  0x0C: LO1C Byte 2           */</span>
	<span class="n">MT2063_REG_LO2C_1</span><span class="p">,</span>		<span class="cm">/*  0x0D: LO2C Byte 1           */</span>
	<span class="n">MT2063_REG_LO2C_2</span><span class="p">,</span>		<span class="cm">/*  0x0E: LO2C Byte 2           */</span>
	<span class="n">MT2063_REG_LO2C_3</span><span class="p">,</span>		<span class="cm">/*  0x0F: LO2C Byte 3           */</span>
	<span class="n">MT2063_REG_RSVD_10</span><span class="p">,</span>		<span class="cm">/*  0x10: Reserved              */</span>
	<span class="n">MT2063_REG_PWR_1</span><span class="p">,</span>		<span class="cm">/*  0x11: PWR Byte 1            */</span>
	<span class="n">MT2063_REG_PWR_2</span><span class="p">,</span>		<span class="cm">/*  0x12: PWR Byte 2            */</span>
	<span class="n">MT2063_REG_TEMP_STATUS</span><span class="p">,</span>		<span class="cm">/*  0x13: Temp Status           */</span>
	<span class="n">MT2063_REG_XO_STATUS</span><span class="p">,</span>		<span class="cm">/*  0x14: Crystal Status        */</span>
	<span class="n">MT2063_REG_RF_STATUS</span><span class="p">,</span>		<span class="cm">/*  0x15: RF Attn Status        */</span>
	<span class="n">MT2063_REG_FIF_STATUS</span><span class="p">,</span>		<span class="cm">/*  0x16: FIF Attn Status       */</span>
	<span class="n">MT2063_REG_LNA_OV</span><span class="p">,</span>		<span class="cm">/*  0x17: LNA Attn Override     */</span>
	<span class="n">MT2063_REG_RF_OV</span><span class="p">,</span>		<span class="cm">/*  0x18: RF Attn Override      */</span>
	<span class="n">MT2063_REG_FIF_OV</span><span class="p">,</span>		<span class="cm">/*  0x19: FIF Attn Override     */</span>
	<span class="n">MT2063_REG_LNA_TGT</span><span class="p">,</span>		<span class="cm">/*  0x1A: Reserved              */</span>
	<span class="n">MT2063_REG_PD1_TGT</span><span class="p">,</span>		<span class="cm">/*  0x1B: Pwr Det 1 Target      */</span>
	<span class="n">MT2063_REG_PD2_TGT</span><span class="p">,</span>		<span class="cm">/*  0x1C: Pwr Det 2 Target      */</span>
	<span class="n">MT2063_REG_RSVD_1D</span><span class="p">,</span>		<span class="cm">/*  0x1D: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_1E</span><span class="p">,</span>		<span class="cm">/*  0x1E: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_1F</span><span class="p">,</span>		<span class="cm">/*  0x1F: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_20</span><span class="p">,</span>		<span class="cm">/*  0x20: Reserved              */</span>
	<span class="n">MT2063_REG_BYP_CTRL</span><span class="p">,</span>		<span class="cm">/*  0x21: Bypass Control        */</span>
	<span class="n">MT2063_REG_RSVD_22</span><span class="p">,</span>		<span class="cm">/*  0x22: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_23</span><span class="p">,</span>		<span class="cm">/*  0x23: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_24</span><span class="p">,</span>		<span class="cm">/*  0x24: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_25</span><span class="p">,</span>		<span class="cm">/*  0x25: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_26</span><span class="p">,</span>		<span class="cm">/*  0x26: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_27</span><span class="p">,</span>		<span class="cm">/*  0x27: Reserved              */</span>
	<span class="n">MT2063_REG_FIFF_CTRL</span><span class="p">,</span>		<span class="cm">/*  0x28: FIFF Control          */</span>
	<span class="n">MT2063_REG_FIFF_OFFSET</span><span class="p">,</span>		<span class="cm">/*  0x29: FIFF Offset           */</span>
	<span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">,</span>		<span class="cm">/*  0x2A: Reserved              */</span>
	<span class="n">MT2063_REG_CTUNE_OV</span><span class="p">,</span>		<span class="cm">/*  0x2B: Reserved              */</span>
	<span class="n">MT2063_REG_CTRL_2C</span><span class="p">,</span>		<span class="cm">/*  0x2C: Reserved              */</span>
	<span class="n">MT2063_REG_FIFF_CTRL2</span><span class="p">,</span>		<span class="cm">/*  0x2D: Fiff Control          */</span>
	<span class="n">MT2063_REG_RSVD_2E</span><span class="p">,</span>		<span class="cm">/*  0x2E: Reserved              */</span>
	<span class="n">MT2063_REG_DNC_GAIN</span><span class="p">,</span>		<span class="cm">/*  0x2F: DNC Control           */</span>
	<span class="n">MT2063_REG_VGA_GAIN</span><span class="p">,</span>		<span class="cm">/*  0x30: VGA Gain Ctrl         */</span>
	<span class="n">MT2063_REG_RSVD_31</span><span class="p">,</span>		<span class="cm">/*  0x31: Reserved              */</span>
	<span class="n">MT2063_REG_TEMP_SEL</span><span class="p">,</span>		<span class="cm">/*  0x32: Temperature Selection */</span>
	<span class="n">MT2063_REG_RSVD_33</span><span class="p">,</span>		<span class="cm">/*  0x33: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_34</span><span class="p">,</span>		<span class="cm">/*  0x34: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_35</span><span class="p">,</span>		<span class="cm">/*  0x35: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_36</span><span class="p">,</span>		<span class="cm">/*  0x36: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_37</span><span class="p">,</span>		<span class="cm">/*  0x37: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_38</span><span class="p">,</span>		<span class="cm">/*  0x38: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_39</span><span class="p">,</span>		<span class="cm">/*  0x39: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_3A</span><span class="p">,</span>		<span class="cm">/*  0x3A: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_3B</span><span class="p">,</span>		<span class="cm">/*  0x3B: Reserved              */</span>
	<span class="n">MT2063_REG_RSVD_3C</span><span class="p">,</span>		<span class="cm">/*  0x3C: Reserved              */</span>
	<span class="n">MT2063_REG_END_REGS</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">init</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">mt2063_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">frontend</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner_state</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reference</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">tuner_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span> <span class="n">AS_Data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_IF1_actual</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcvr_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctfilt_sw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">num_regs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_END_REGS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * mt2063_write - Write data into the I2C bus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">mt2063_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s error ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mt2063_write - Write register data into the I2C bus, caching the value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">mt2063_setreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">MT2063_REG_END_REGS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mt2063_read - Read data from the I2C bus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">mt2063_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">subAddress</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pData</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Status to be returned        */</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addr 0x%02x, cnt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subAddress</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">subAddress</span> <span class="o">+</span> <span class="n">i</span> <span class="p">};</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_address</span><span class="p">,</span>
				<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
				<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_address</span><span class="p">,</span>
				<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
				<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">pData</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="p">}</span>
		<span class="p">};</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addr 0x%02x, ret = %d, val = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">subAddress</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pData</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t read from address 0x%02x,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">subAddress</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: Is this really needed?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">MT2063_Sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  ToDo:  Add code here to implement a OS blocking</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Microtune spur avoidance</span>
<span class="cm"> */</span>

<span class="cm">/*  Implement ceiling, floor functions.  */</span>
<span class="cp">#define ceil(n, d) (((n) &lt; 0) ? (-((-(n))/(d))) : (n)/(d) + ((n)%(d) != 0))</span>
<span class="cp">#define floor(n, d) (((n) &lt; 0) ? (-((-(n))/(d))) - ((n)%(d) != 0) : (n)/(d))</span>

<span class="k">struct</span> <span class="n">MT2063_FIFZone_t</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">min_</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">max_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="nf">InsertNode</span><span class="p">(</span><span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span>
					    <span class="o">*</span><span class="n">pAS_Info</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pPrevNode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pNode</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*  Check for a node in the free list  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">freeZones</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Use one from the free list  */</span>
		<span class="n">pNode</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">freeZones</span><span class="p">;</span>
		<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">freeZones</span> <span class="o">=</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*  Grab a node from the array  */</span>
		<span class="n">pNode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">MT2063_ExclZones</span><span class="p">[</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">nZones</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pPrevNode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pNode</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">pPrevNode</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
		<span class="n">pPrevNode</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">pNode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/*  insert at the beginning of the list  */</span>

		<span class="n">pNode</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">usedZones</span><span class="p">;</span>
		<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">usedZones</span> <span class="o">=</span> <span class="n">pNode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">nZones</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pNode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="nf">RemoveNode</span><span class="p">(</span><span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span>
					    <span class="o">*</span><span class="n">pAS_Info</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pPrevNode</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span>
					    <span class="o">*</span><span class="n">pNodeToRemove</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pNext</span> <span class="o">=</span> <span class="n">pNodeToRemove</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*  Make previous node point to the subsequent node  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pPrevNode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pPrevNode</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">pNext</span><span class="p">;</span>

	<span class="cm">/*  Add pNodeToRemove to the beginning of the freeZones  */</span>
	<span class="n">pNodeToRemove</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">freeZones</span><span class="p">;</span>
	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">freeZones</span> <span class="o">=</span> <span class="n">pNodeToRemove</span><span class="p">;</span>

	<span class="cm">/*  Decrement node count  */</span>
	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">nZones</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pNext</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MT_AddExclZone()</span>
<span class="cm"> *</span>
<span class="cm"> * Add (and merge) an exclusion zone into the list.</span>
<span class="cm"> * If the range (f_min, f_max) is totally outside the</span>
<span class="cm"> * 1st IF BW, ignore the entry.</span>
<span class="cm"> * If the range (f_min, f_max) is negative, ignore the entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">MT2063_AddExclZone</span><span class="p">(</span><span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span> <span class="o">*</span><span class="n">pAS_Info</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">u32</span> <span class="n">f_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pNode</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">usedZones</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pPrev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pNext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*  Check to see if this overlaps the 1st IF filter  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">f_max</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">-</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f_min</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">+</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f_min</span> <span class="o">&lt;</span> <span class="n">f_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *                1        2         3      4       5        6</span>
<span class="cm">		 *</span>
<span class="cm">		 *   New entry:  |---|    |--|      |--|    |-|    |---|    |--|</span>
<span class="cm">		 *                or       or        or     or      or</span>
<span class="cm">		 *   Existing:  |--|      |--|      |--|    |---|  |-|      |--|</span>
<span class="cm">		 */</span>

		<span class="cm">/*  Check for our place in the list  */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">pNode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span> <span class="o">&lt;</span> <span class="n">f_min</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pPrev</span> <span class="o">=</span> <span class="n">pNode</span><span class="p">;</span>
			<span class="n">pNode</span> <span class="o">=</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pNode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pNode</span><span class="o">-&gt;</span><span class="n">min_</span> <span class="o">&lt;</span> <span class="n">f_max</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*  Combine me with pNode  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_min</span> <span class="o">&lt;</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">min_</span><span class="p">)</span>
				<span class="n">pNode</span><span class="o">-&gt;</span><span class="n">min_</span> <span class="o">=</span> <span class="n">f_min</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_max</span> <span class="o">&gt;</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span><span class="p">)</span>
				<span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span> <span class="o">=</span> <span class="n">f_max</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pNode</span> <span class="o">=</span> <span class="n">InsertNode</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="n">pPrev</span><span class="p">);</span>
			<span class="n">pNode</span><span class="o">-&gt;</span><span class="n">min_</span> <span class="o">=</span> <span class="n">f_min</span><span class="p">;</span>
			<span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span> <span class="o">=</span> <span class="n">f_max</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*  Look for merging possibilities  */</span>
		<span class="n">pNext</span> <span class="o">=</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">pNext</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pNext</span><span class="o">-&gt;</span><span class="n">min_</span> <span class="o">&lt;</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pNext</span><span class="o">-&gt;</span><span class="n">max_</span> <span class="o">&gt;</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span><span class="p">)</span>
				<span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span> <span class="o">=</span> <span class="n">pNext</span><span class="o">-&gt;</span><span class="n">max_</span><span class="p">;</span>
			<span class="cm">/*  Remove pNext, return ptr to pNext-&gt;next  */</span>
			<span class="n">pNext</span> <span class="o">=</span> <span class="n">RemoveNode</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="n">pNode</span><span class="p">,</span> <span class="n">pNext</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Reset all exclusion zones.</span>
<span class="cm"> *  Add zones to protect the PLL FracN regions near zero</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">MT2063_ResetExclZones</span><span class="p">(</span><span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span> <span class="o">*</span><span class="n">pAS_Info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">center</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">nZones</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  this clears the used list  */</span>
	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">usedZones</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/*  reset ptr                  */</span>
	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">freeZones</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/*  reset ptr                  */</span>

	<span class="n">center</span> <span class="o">=</span>
	    <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_ref</span> <span class="o">*</span>
	    <span class="p">((</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_bw</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
	      <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">)</span> <span class="o">/</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_ref</span><span class="p">)</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">center</span> <span class="o">&lt;</span>
	       <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_bw</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
	       <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_FracN_Avoid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Exclude LO1 FracN  */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span>
				   <span class="n">center</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_FracN_Avoid</span><span class="p">,</span>
				   <span class="n">center</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="n">center</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">center</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_FracN_Avoid</span><span class="p">);</span>
		<span class="n">center</span> <span class="o">+=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_ref</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">center</span> <span class="o">=</span>
	    <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_ref</span> <span class="o">*</span>
	    <span class="p">((</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_bw</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span>
	      <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_out</span><span class="p">)</span> <span class="o">/</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_ref</span><span class="p">)</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_out</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">center</span> <span class="o">&lt;</span>
	       <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_bw</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
	       <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2_FracN_Avoid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Exclude LO2 FracN  */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span>
				   <span class="n">center</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2_FracN_Avoid</span><span class="p">,</span>
				   <span class="n">center</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="n">center</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">center</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2_FracN_Avoid</span><span class="p">);</span>
		<span class="n">center</span> <span class="o">+=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_ref</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MT2063_EXCLUDE_US_DECT_FREQUENCIES</span><span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">avoidDECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  Exclude LO1 values that conflict with DECT channels */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1920836000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1922236000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1921.536 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1922564000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1923964000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1923.264 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1924292000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1925692000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1924.992 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1926020000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1927420000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1926.720 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1927748000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1929148000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1928.448 */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MT2063_EXCLUDE_EURO_DECT_FREQUENCIES</span><span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">avoidDECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1896644000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1898044000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1897.344 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1894916000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1896316000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1895.616 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1893188000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1894588000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1893.888 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1891460000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1892860000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1892.16  */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1889732000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1891132000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1890.432 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1888004000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1889404000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1888.704 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1886276000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1887676000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1886.976 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1884548000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1885948000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1885.248 */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1882820000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1884220000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1883.52  */</span>
		<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="mi">1881092000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">,</span> <span class="mi">1882492000</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">);</span>	<span class="cm">/* Ctr = 1881.792 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MT_ChooseFirstIF - Choose the best available 1st IF</span>
<span class="cm"> *                    If f_Desired is not excluded, choose that first.</span>
<span class="cm"> *                    Otherwise, return the value closest to f_Center that is</span>
<span class="cm"> *                    not excluded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_ChooseFirstIF</span><span class="p">(</span><span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span> <span class="o">*</span><span class="n">pAS_Info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Update &quot;f_Desired&quot; to be the nearest &quot;combinational-multiple&quot; of</span>
<span class="cm">	 * &quot;f_LO1_Step&quot;.</span>
<span class="cm">	 * The resulting number, F_LO1 must be a multiple of f_LO1_Step.</span>
<span class="cm">	 * And F_LO1 is the arithmetic sum of f_in + f_Center.</span>
<span class="cm">	 * Neither f_in, nor f_Center must be a multiple of f_LO1_Step.</span>
<span class="cm">	 * However, the sum must be.</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">f_Desired</span> <span class="o">=</span>
	    <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_Step</span> <span class="o">*</span>
	    <span class="p">((</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Request</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span> <span class="o">+</span>
	      <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_Step</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">f_Step</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_Step</span> <span class="o">&gt;</span>
	     <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2_Step</span><span class="p">)</span> <span class="o">?</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1_Step</span> <span class="o">:</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span>
	    <span class="n">f_LO2_Step</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_Center</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bDesiredExcluded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bZeroExcluded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmpMin</span><span class="p">,</span> <span class="n">tmpMax</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">bestDiff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_ExclZone_t</span> <span class="o">*</span><span class="n">pNode</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">usedZones</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MT2063_FIFZone_t</span> <span class="n">zones</span><span class="p">[</span><span class="n">MT2063_MAX_ZONES</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">nZones</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">f_Desired</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  f_Center needs to be an integer multiple of f_Step away</span>
<span class="cm">	 *  from f_Desired</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">&gt;</span> <span class="n">f_Desired</span><span class="p">)</span>
		<span class="n">f_Center</span> <span class="o">=</span>
		    <span class="n">f_Desired</span> <span class="o">+</span>
		    <span class="n">f_Step</span> <span class="o">*</span>
		    <span class="p">((</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">-</span> <span class="n">f_Desired</span> <span class="o">+</span>
		      <span class="n">f_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">f_Step</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">f_Center</span> <span class="o">=</span>
		    <span class="n">f_Desired</span> <span class="o">-</span>
		    <span class="n">f_Step</span> <span class="o">*</span>
		    <span class="p">((</span><span class="n">f_Desired</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">+</span>
		      <span class="n">f_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">f_Step</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take MT_ExclZones, center around f_Center and change the</span>
<span class="cm">	 * resolution to f_Step</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pNode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  floor function  */</span>
		<span class="n">tmpMin</span> <span class="o">=</span>
		    <span class="n">floor</span><span class="p">((</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">pNode</span><span class="o">-&gt;</span><span class="n">min_</span> <span class="o">-</span> <span class="n">f_Center</span><span class="p">),</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">f_Step</span><span class="p">);</span>

		<span class="cm">/*  ceil function  */</span>
		<span class="n">tmpMax</span> <span class="o">=</span>
		    <span class="n">ceil</span><span class="p">((</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span> <span class="o">-</span> <span class="n">f_Center</span><span class="p">),</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">f_Step</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pNode</span><span class="o">-&gt;</span><span class="n">min_</span> <span class="o">&lt;</span> <span class="n">f_Desired</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pNode</span><span class="o">-&gt;</span><span class="n">max_</span> <span class="o">&gt;</span> <span class="n">f_Desired</span><span class="p">))</span>
			<span class="n">bDesiredExcluded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tmpMin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmpMax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">bZeroExcluded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*  See if this zone overlaps the previous  */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmpMin</span> <span class="o">&lt;</span> <span class="n">zones</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">max_</span><span class="p">))</span>
			<span class="n">zones</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">max_</span> <span class="o">=</span> <span class="n">tmpMax</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*  Add new zone  */</span>
			<span class="n">zones</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">min_</span> <span class="o">=</span> <span class="n">tmpMin</span><span class="p">;</span>
			<span class="n">zones</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max_</span> <span class="o">=</span> <span class="n">tmpMax</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pNode</span> <span class="o">=</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If the desired is okay, return with it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bDesiredExcluded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">f_Desired</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If the desired is excluded and the center is okay, return with it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bZeroExcluded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">f_Center</span><span class="p">;</span>

	<span class="cm">/*  Find the value closest to 0 (f_Center)  */</span>
	<span class="n">bestDiff</span> <span class="o">=</span> <span class="n">zones</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">min_</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">zones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">bestDiff</span><span class="p">))</span>
			<span class="n">bestDiff</span> <span class="o">=</span> <span class="n">zones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">zones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">bestDiff</span><span class="p">))</span>
			<span class="n">bestDiff</span> <span class="o">=</span> <span class="n">zones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bestDiff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">f_Center</span> <span class="o">-</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="o">-</span><span class="n">bestDiff</span><span class="p">)</span> <span class="o">*</span> <span class="n">f_Step</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">f_Center</span> <span class="o">+</span> <span class="p">(</span><span class="n">bestDiff</span> <span class="o">*</span> <span class="n">f_Step</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gcd() - Uses Euclid&#39;s algorithm</span>
<span class="cm"> *</span>
<span class="cm"> * @u, @v:	Unsigned values whose GCD is desired.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns THE greatest common divisor of u and v, if either value is 0,</span>
<span class="cm"> * the other value is returned as the result.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_gcd</span><span class="p">(</span><span class="n">u32</span> <span class="n">u</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">u</span> <span class="o">%</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IsSpurInBand() - Checks to see if a spur will be present within the IF&#39;s</span>
<span class="cm"> *                  bandwidth. (fIFOut +/- fIFBW, -fIFOut +/- fIFBW)</span>
<span class="cm"> *</span>
<span class="cm"> *                    ma   mb                                     mc   md</span>
<span class="cm"> *                  &lt;--+-+-+-------------------+-------------------+-+-+--&gt;</span>
<span class="cm"> *                     |   ^                   0                   ^   |</span>
<span class="cm"> *                     ^   b=-fIFOut+fIFBW/2      -b=+fIFOut-fIFBW/2   ^</span>
<span class="cm"> *                     a=-fIFOut-fIFBW/2              -a=+fIFOut+fIFBW/2</span>
<span class="cm"> *</span>
<span class="cm"> *                  Note that some equations are doubled to prevent round-off</span>
<span class="cm"> *                  problems when calculating fIFBW/2</span>
<span class="cm"> *</span>
<span class="cm"> * @pAS_Info:	Avoid Spurs information block</span>
<span class="cm"> * @fm:		If spur, amount f_IF1 has to move negative</span>
<span class="cm"> * @fp:		If spur, amount f_IF1 has to move positive</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns 1 if an LO spur would be present, otherwise 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">IsSpurInBand</span><span class="p">(</span><span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span> <span class="o">*</span><span class="n">pAS_Info</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">fm</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 **  Calculate LO frequency settings.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">,</span> <span class="n">n0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">f_LO1</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">f_LO2</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_out</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_out_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">c</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_out_bw</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">f</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_zif_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">f_Scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_LO1</span> <span class="o">/</span> <span class="p">(</span><span class="n">UINT_MAX</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">maxH1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">f_nsLO1</span><span class="p">,</span> <span class="n">f_nsLO2</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">f_Spur</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lo_gcd</span><span class="p">,</span> <span class="n">gd_Scale</span><span class="p">,</span> <span class="n">gc_Scale</span><span class="p">,</span> <span class="n">gf_Scale</span><span class="p">,</span> <span class="n">hgds</span><span class="p">,</span> <span class="n">hgfs</span><span class="p">,</span> <span class="n">hgcs</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">fm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 ** For each edge (d, c &amp; f), calculate a scale, based on the gcd</span>
<span class="cm">	 ** of f_LO1, f_LO2 and the edge value.  Use the larger of this</span>
<span class="cm">	 ** gcd-based scale factor or f_Scale.</span>
<span class="cm">	 */</span>
	<span class="n">lo_gcd</span> <span class="o">=</span> <span class="n">MT2063_gcd</span><span class="p">(</span><span class="n">f_LO1</span><span class="p">,</span> <span class="n">f_LO2</span><span class="p">);</span>
	<span class="n">gd_Scale</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">MT2063_gcd</span><span class="p">(</span><span class="n">lo_gcd</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">f_Scale</span><span class="p">);</span>
	<span class="n">hgds</span> <span class="o">=</span> <span class="n">gd_Scale</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">gc_Scale</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">MT2063_gcd</span><span class="p">(</span><span class="n">lo_gcd</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">f_Scale</span><span class="p">);</span>
	<span class="n">hgcs</span> <span class="o">=</span> <span class="n">gc_Scale</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">gf_Scale</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">MT2063_gcd</span><span class="p">(</span><span class="n">lo_gcd</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">f_Scale</span><span class="p">);</span>
	<span class="n">hgfs</span> <span class="o">=</span> <span class="n">gf_Scale</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">n0</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">f_LO2</span> <span class="o">-</span> <span class="n">d</span><span class="p">,</span> <span class="n">f_LO1</span> <span class="o">-</span> <span class="n">f_LO2</span><span class="p">);</span>

	<span class="cm">/*  Check out all multiples of LO1 from n0 to m_maxLOSpurHarmonic  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">n0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">maxH1</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">((</span><span class="n">f_LO1</span> <span class="o">+</span> <span class="n">hgds</span><span class="p">)</span> <span class="o">/</span> <span class="n">gd_Scale</span><span class="p">)</span> <span class="o">-</span>
		      <span class="p">((</span><span class="n">d</span> <span class="o">+</span> <span class="n">hgds</span><span class="p">)</span> <span class="o">/</span> <span class="n">gd_Scale</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">f_LO2</span> <span class="o">+</span> <span class="n">hgds</span><span class="p">)</span> <span class="o">/</span> <span class="n">gd_Scale</span><span class="p">);</span>

		<span class="cm">/*  If # fLO2 harmonics &gt; m_maxLOSpurHarmonic, then no spurs present  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">md</span> <span class="o">&gt;=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">maxH1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ma</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">((</span><span class="n">f_LO1</span> <span class="o">+</span> <span class="n">hgds</span><span class="p">)</span> <span class="o">/</span> <span class="n">gd_Scale</span><span class="p">)</span> <span class="o">+</span>
		      <span class="p">((</span><span class="n">d</span> <span class="o">+</span> <span class="n">hgds</span><span class="p">)</span> <span class="o">/</span> <span class="n">gd_Scale</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">f_LO2</span> <span class="o">+</span> <span class="n">hgds</span><span class="p">)</span> <span class="o">/</span> <span class="n">gd_Scale</span><span class="p">);</span>

		<span class="cm">/*  If no spurs between +/- (f_out + f_IFBW/2), then try next harmonic  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">md</span> <span class="o">==</span> <span class="n">ma</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mc</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">((</span><span class="n">f_LO1</span> <span class="o">+</span> <span class="n">hgcs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">)</span> <span class="o">-</span>
		      <span class="p">((</span><span class="n">c</span> <span class="o">+</span> <span class="n">hgcs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">f_LO2</span> <span class="o">+</span> <span class="n">hgcs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc</span> <span class="o">!=</span> <span class="n">md</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f_nsLO1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO1</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">));</span>
			<span class="n">f_nsLO2</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">mc</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO2</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">));</span>
			<span class="n">f_Spur</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">gc_Scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_nsLO1</span> <span class="o">-</span> <span class="n">f_nsLO2</span><span class="p">))</span> <span class="o">+</span>
			    <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO1</span> <span class="o">%</span> <span class="n">gc_Scale</span><span class="p">)</span> <span class="o">-</span> <span class="n">mc</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO2</span> <span class="o">%</span> <span class="n">gc_Scale</span><span class="p">);</span>

			<span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">((</span><span class="n">f_Spur</span> <span class="o">-</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mc</span> <span class="o">-</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">fm</span> <span class="o">=</span> <span class="p">(((</span><span class="n">s32</span><span class="p">)</span> <span class="n">d</span> <span class="o">-</span> <span class="n">f_Spur</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mc</span> <span class="o">-</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*  Location of Zero-IF-spur to be checked  */</span>
		<span class="n">me</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">((</span><span class="n">f_LO1</span> <span class="o">+</span> <span class="n">hgfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">)</span> <span class="o">+</span>
		      <span class="p">((</span><span class="n">f</span> <span class="o">+</span> <span class="n">hgfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">f_LO2</span> <span class="o">+</span> <span class="n">hgfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">);</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">((</span><span class="n">f_LO1</span> <span class="o">+</span> <span class="n">hgfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">)</span> <span class="o">-</span>
		      <span class="p">((</span><span class="n">f</span> <span class="o">+</span> <span class="n">hgfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">f_LO2</span> <span class="o">+</span> <span class="n">hgfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">me</span> <span class="o">!=</span> <span class="n">mf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f_nsLO1</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO1</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">);</span>
			<span class="n">f_nsLO2</span> <span class="o">=</span> <span class="n">me</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO2</span> <span class="o">/</span> <span class="n">gf_Scale</span><span class="p">);</span>
			<span class="n">f_Spur</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">gf_Scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_nsLO1</span> <span class="o">-</span> <span class="n">f_nsLO2</span><span class="p">))</span> <span class="o">+</span>
			    <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO1</span> <span class="o">%</span> <span class="n">gf_Scale</span><span class="p">)</span> <span class="o">-</span> <span class="n">me</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO2</span> <span class="o">%</span> <span class="n">gf_Scale</span><span class="p">);</span>

			<span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">((</span><span class="n">f_Spur</span> <span class="o">+</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">me</span> <span class="o">-</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">fm</span> <span class="o">=</span> <span class="p">(((</span><span class="n">s32</span><span class="p">)</span> <span class="n">f</span> <span class="o">-</span> <span class="n">f_Spur</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">me</span> <span class="o">-</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mb</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">((</span><span class="n">f_LO1</span> <span class="o">+</span> <span class="n">hgcs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">)</span> <span class="o">+</span>
		      <span class="p">((</span><span class="n">c</span> <span class="o">+</span> <span class="n">hgcs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">f_LO2</span> <span class="o">+</span> <span class="n">hgcs</span><span class="p">)</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ma</span> <span class="o">!=</span> <span class="n">mb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f_nsLO1</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO1</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">);</span>
			<span class="n">f_nsLO2</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO2</span> <span class="o">/</span> <span class="n">gc_Scale</span><span class="p">);</span>
			<span class="n">f_Spur</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">gc_Scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_nsLO1</span> <span class="o">-</span> <span class="n">f_nsLO2</span><span class="p">))</span> <span class="o">+</span>
			    <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO1</span> <span class="o">%</span> <span class="n">gc_Scale</span><span class="p">)</span> <span class="o">-</span> <span class="n">ma</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO2</span> <span class="o">%</span> <span class="n">gc_Scale</span><span class="p">);</span>

			<span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(((</span><span class="n">s32</span><span class="p">)</span> <span class="n">d</span> <span class="o">+</span> <span class="n">f_Spur</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">fm</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">f_Spur</span> <span class="o">+</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  No spurs found  */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MT_AvoidSpurs() - Main entry point to avoid spurs.</span>
<span class="cm"> *                   Checks for existing spurs in present LO1, LO2 freqs</span>
<span class="cm"> *                   and if present, chooses spur-free LO1, LO2 combination</span>
<span class="cm"> *                   that tunes the same input/output frequencies.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_AvoidSpurs</span><span class="p">(</span><span class="k">struct</span> <span class="n">MT2063_AvoidSpursData_t</span> <span class="o">*</span><span class="n">pAS_Info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fm</span><span class="p">,</span> <span class="n">fp</span><span class="p">;</span>		<span class="cm">/*  restricted range on LO&#39;s        */</span>
	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">bSpurAvoided</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">nSpursFound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">maxH1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Avoid LO Generated Spurs</span>
<span class="cm">	 *</span>
<span class="cm">	 * Make sure that have no LO-related spurs within the IF output</span>
<span class="cm">	 * bandwidth.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If there is an LO spur in this band, start at the current IF1 frequency</span>
<span class="cm">	 * and work out until we find a spur-free frequency or run up against the</span>
<span class="cm">	 * 1st IF SAW band edge.  Use temporary copies of fLO1 and fLO2 so that they</span>
<span class="cm">	 * will be unchanged if a spur-free setting is not found.</span>
<span class="cm">	 */</span>
	<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">bSpurPresent</span> <span class="o">=</span> <span class="n">IsSpurInBand</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">bSpurPresent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">zfIF1</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_in</span><span class="p">;</span>	<span class="cm">/*  current attempt at a 1st IF  */</span>
		<span class="n">u32</span> <span class="n">zfLO1</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1</span><span class="p">;</span>	<span class="cm">/*  current attempt at an LO1 freq  */</span>
		<span class="n">u32</span> <span class="n">zfLO2</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2</span><span class="p">;</span>	<span class="cm">/*  current attempt at an LO2 freq  */</span>
		<span class="n">u32</span> <span class="n">delta_IF1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">new_IF1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 **  Spur was found, attempt to find a spur-free 1st IF</span>
<span class="cm">		 */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">nSpursFound</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*  Raise f_IF1_upper, if needed  */</span>
			<span class="n">MT2063_AddExclZone</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="n">zfIF1</span> <span class="o">-</span> <span class="n">fm</span><span class="p">,</span> <span class="n">zfIF1</span> <span class="o">+</span> <span class="n">fp</span><span class="p">);</span>

			<span class="cm">/*  Choose next IF1 that is closest to f_IF1_CENTER              */</span>
			<span class="n">new_IF1</span> <span class="o">=</span> <span class="n">MT2063_ChooseFirstIF</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">new_IF1</span> <span class="o">&gt;</span> <span class="n">zfIF1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1</span> <span class="o">+=</span> <span class="p">(</span><span class="n">new_IF1</span> <span class="o">-</span> <span class="n">zfIF1</span><span class="p">);</span>
				<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">new_IF1</span> <span class="o">-</span> <span class="n">zfIF1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1</span> <span class="o">-=</span> <span class="p">(</span><span class="n">zfIF1</span> <span class="o">-</span> <span class="n">new_IF1</span><span class="p">);</span>
				<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2</span> <span class="o">-=</span> <span class="p">(</span><span class="n">zfIF1</span> <span class="o">-</span> <span class="n">new_IF1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">zfIF1</span> <span class="o">=</span> <span class="n">new_IF1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">zfIF1</span> <span class="o">&gt;</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span><span class="p">)</span>
				<span class="n">delta_IF1</span> <span class="o">=</span> <span class="n">zfIF1</span> <span class="o">-</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">delta_IF1</span> <span class="o">=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_Center</span> <span class="o">-</span> <span class="n">zfIF1</span><span class="p">;</span>

			<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">bSpurPresent</span> <span class="o">=</span> <span class="n">IsSpurInBand</span><span class="p">(</span><span class="n">pAS_Info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Continue while the new 1st IF is still within the 1st IF bandwidth</span>
<span class="cm">		 *  and there is a spur in the band (again)</span>
<span class="cm">		 */</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">delta_IF1</span> <span class="o">+</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_out_bw</span> <span class="o">&lt;=</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_if1_bw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">bSpurPresent</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use the LO-spur free values found.  If the search went all</span>
<span class="cm">		 * the way to the 1st IF band edge and always found spurs, just</span>
<span class="cm">		 * leave the original choice.  It&#39;s as &quot;good&quot; as any other.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">bSpurPresent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">MT2063_SPUR_PRESENT_ERR</span><span class="p">;</span>
			<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO1</span> <span class="o">=</span> <span class="n">zfLO1</span><span class="p">;</span>
			<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">f_LO2</span> <span class="o">=</span> <span class="n">zfLO2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pAS_Info</span><span class="o">-&gt;</span><span class="n">bSpurAvoided</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">pAS_Info</span><span class="o">-&gt;</span>
	      <span class="n">nSpursFound</span> <span class="o">&lt;&lt;</span> <span class="n">MT2063_SPUR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MT2063_SPUR_CNT_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Constants used by the tuning algorithm</span>
<span class="cm"> */</span>
<span class="cp">#define MT2063_REF_FREQ          (16000000UL)	</span><span class="cm">/* Reference oscillator Frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_IF1_BW            (22000000UL)	</span><span class="cm">/* The IF1 filter bandwidth (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_TUNE_STEP_SIZE       (50000UL)	</span><span class="cm">/* Tune in steps of 50 kHz */</span><span class="cp"></span>
<span class="cp">#define MT2063_SPUR_STEP_HZ        (250000UL)	</span><span class="cm">/* Step size (in Hz) to move IF1 when avoiding spurs */</span><span class="cp"></span>
<span class="cp">#define MT2063_ZIF_BW             (2000000UL)	</span><span class="cm">/* Zero-IF spur-free bandwidth (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MAX_HARMONICS_1         (15UL)	</span><span class="cm">/* Highest intra-tuner LO Spur Harmonic to be avoided */</span><span class="cp"></span>
<span class="cp">#define MT2063_MAX_HARMONICS_2          (5UL)	</span><span class="cm">/* Highest inter-tuner LO Spur Harmonic to be avoided */</span><span class="cp"></span>
<span class="cp">#define MT2063_MIN_LO_SEP         (1000000UL)	</span><span class="cm">/* Minimum inter-tuner LO frequency separation */</span><span class="cp"></span>
<span class="cp">#define MT2063_LO1_FRACN_AVOID          (0UL)	</span><span class="cm">/* LO1 FracN numerator avoid region (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_LO2_FRACN_AVOID     (199999UL)	</span><span class="cm">/* LO2 FracN numerator avoid region (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MIN_FIN_FREQ      (44000000UL)	</span><span class="cm">/* Minimum input frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MAX_FIN_FREQ    (1100000000UL)	</span><span class="cm">/* Maximum input frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MIN_FOUT_FREQ     (36000000UL)	</span><span class="cm">/* Minimum output frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MAX_FOUT_FREQ     (57000000UL)	</span><span class="cm">/* Maximum output frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MIN_DNC_FREQ    (1293000000UL)	</span><span class="cm">/* Minimum LO2 frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MAX_DNC_FREQ    (1614000000UL)	</span><span class="cm">/* Maximum LO2 frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MIN_UPC_FREQ    (1396000000UL)	</span><span class="cm">/* Minimum LO1 frequency (in Hz) */</span><span class="cp"></span>
<span class="cp">#define MT2063_MAX_UPC_FREQ    (2750000000UL)	</span><span class="cm">/* Maximum LO1 frequency (in Hz) */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  Define the supported Part/Rev codes for the MT2063</span>
<span class="cm"> */</span>
<span class="cp">#define MT2063_B0       (0x9B)</span>
<span class="cp">#define MT2063_B1       (0x9C)</span>
<span class="cp">#define MT2063_B2       (0x9D)</span>
<span class="cp">#define MT2063_B3       (0x9E)</span>

<span class="cm">/**</span>
<span class="cm"> * mt2063_lockStatus - Checks to see if LO1 and LO2 are locked</span>
<span class="cm"> *</span>
<span class="cm"> * @state:	struct mt2063_state pointer</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns 0, if no lock, 1 if locked and a value &lt; 1 if error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mt2063_lockStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">nMaxWait</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/*  wait a maximum of 100 msec   */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">nPollRate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/*  poll status bits every 2 ms */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">nMaxLoops</span> <span class="o">=</span> <span class="n">nMaxWait</span> <span class="o">/</span> <span class="n">nPollRate</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">LO1LK</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">LO2LK</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nDelays</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*  LO2 Lock bit was in a different place for B0 version  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_id</span> <span class="o">==</span> <span class="n">MT2063_B0</span><span class="p">)</span>
		<span class="n">LO2LK</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_LO_STATUS</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO_STATUS</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO_STATUS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LO1LK</span> <span class="o">|</span> <span class="n">LO2LK</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">LO1LK</span> <span class="o">|</span> <span class="n">LO2LK</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">TUNER_STATUS_LOCKED</span> <span class="o">|</span> <span class="n">TUNER_STATUS_STEREO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">nPollRate</span><span class="p">);</span>	<span class="cm">/*  Wait between retries  */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">nDelays</span> <span class="o">&lt;</span> <span class="n">nMaxLoops</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Got no lock or partial lock</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Constants for setting receiver modes.</span>
<span class="cm"> *  (6 modes defined at this time, enumerated by mt2063_delivery_sys)</span>
<span class="cm"> *  (DNC1GC &amp; DNC2GC are the values, which are used, when the specific</span>
<span class="cm"> *   DNC Output is selected, the other is always off)</span>
<span class="cm"> *</span>
<span class="cm"> *                enum mt2063_delivery_sys</span>
<span class="cm"> * -------------+----------------------------------------------</span>
<span class="cm"> * Mode 0 :     | MT2063_CABLE_QAM</span>
<span class="cm"> * Mode 1 :     | MT2063_CABLE_ANALOG</span>
<span class="cm"> * Mode 2 :     | MT2063_OFFAIR_COFDM</span>
<span class="cm"> * Mode 3 :     | MT2063_OFFAIR_COFDM_SAWLESS</span>
<span class="cm"> * Mode 4 :     | MT2063_OFFAIR_ANALOG</span>
<span class="cm"> * Mode 5 :     | MT2063_OFFAIR_8VSB</span>
<span class="cm"> * --------------+----------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *                |&lt;----------   Mode  --------------&gt;|</span>
<span class="cm"> *    Reg Field   |  0  |  1  |  2  |  3  |  4  |  5  |</span>
<span class="cm"> *    ------------+-----+-----+-----+-----+-----+-----+</span>
<span class="cm"> *    RFAGCen     | OFF | OFF | OFF | OFF | OFF | OFF</span>
<span class="cm"> *    LNARin      |   0 |   0 |   3 |   3 |  3  |  3</span>
<span class="cm"> *    FIFFQen     |   1 |   1 |   1 |   1 |  1  |  1</span>
<span class="cm"> *    FIFFq       |   0 |   0 |   0 |   0 |  0  |  0</span>
<span class="cm"> *    DNC1gc      |   0 |   0 |   0 |   0 |  0  |  0</span>
<span class="cm"> *    DNC2gc      |   0 |   0 |   0 |   0 |  0  |  0</span>
<span class="cm"> *    GCU Auto    |   1 |   1 |   1 |   1 |  1  |  1</span>
<span class="cm"> *    LNA max Atn |  31 |  31 |  31 |  31 | 31  | 31</span>
<span class="cm"> *    LNA Target  |  44 |  43 |  43 |  43 | 43  | 43</span>
<span class="cm"> *    ign  RF Ovl |   0 |   0 |   0 |   0 |  0  |  0</span>
<span class="cm"> *    RF  max Atn |  31 |  31 |  31 |  31 | 31  | 31</span>
<span class="cm"> *    PD1 Target  |  36 |  36 |  38 |  38 | 36  | 38</span>
<span class="cm"> *    ign FIF Ovl |   0 |   0 |   0 |   0 |  0  |  0</span>
<span class="cm"> *    FIF max Atn |   5 |   5 |   5 |   5 |  5  |  5</span>
<span class="cm"> *    PD2 Target  |  40 |  33 |  42 |  42 | 33  | 42</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">mt2063_delivery_sys</span> <span class="p">{</span>
	<span class="n">MT2063_CABLE_QAM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MT2063_CABLE_ANALOG</span><span class="p">,</span>
	<span class="n">MT2063_OFFAIR_COFDM</span><span class="p">,</span>
	<span class="n">MT2063_OFFAIR_COFDM_SAWLESS</span><span class="p">,</span>
	<span class="n">MT2063_OFFAIR_ANALOG</span><span class="p">,</span>
	<span class="n">MT2063_OFFAIR_8VSB</span><span class="p">,</span>
	<span class="n">MT2063_NUM_RCVR_MODES</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mt2063_mode_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MT2063_CABLE_QAM</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;digital cable&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MT2063_CABLE_ANALOG</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;analog cable&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MT2063_OFFAIR_COFDM</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;digital offair&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MT2063_OFFAIR_COFDM_SAWLESS</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;digital offair without SAW&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MT2063_OFFAIR_ANALOG</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;analog offair&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MT2063_OFFAIR_8VSB</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;analog offair 8vsb&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">RFAGCEN</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">LNARIN</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FIFFQEN</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FIFFQ</span><span class="p">[]</span>		<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DNC1GC</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DNC2GC</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ACLNAMAX</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">LNATGT</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">RFOVDIS</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ACRFMAX</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">PD1TGT</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FIFOVDIS</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ACFIFMAX</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">PD2TGT</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">38</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * mt2063_set_dnc_output_enable()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">mt2063_get_dnc_output_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">MT2063_DNC_Output_Enable</span> <span class="o">*</span><span class="n">pValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* if DNC1 is off */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>	<span class="cm">/* if DNC2 is off */</span>
			<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="n">MT2063_DNC_NONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="n">MT2063_DNC_2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* DNC1 is on */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>	<span class="cm">/* if DNC2 is off */</span>
			<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="n">MT2063_DNC_1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="n">MT2063_DNC_BOTH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mt2063_set_dnc_output_enable()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">mt2063_set_dnc_output_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">MT2063_DNC_Output_Enable</span> <span class="n">nValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Status to be returned        */</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* selects, which DNC output is used */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nValue</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MT2063_DNC_NONE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* Set DNC1GC=3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_DNC_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* Set DNC2GC=3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_VGA_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Set PD2MUX=0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_RSVD_20</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MT2063_DNC_1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DNC1GC</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rcvr_mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* Set DNC1GC=x */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_DNC_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* Set DNC2GC=3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_VGA_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Set PD2MUX=0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_RSVD_20</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MT2063_DNC_2</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* Set DNC1GC=3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_DNC_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DNC2GC</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rcvr_mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* Set DNC2GC=x */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_VGA_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Set PD2MUX=1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_RSVD_20</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MT2063_DNC_BOTH</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DNC1GC</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rcvr_mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* Set DNC1GC=x */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_DNC_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_DNC_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DNC2GC</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rcvr_mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* Set DNC2GC=x */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_VGA_GAIN</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_VGA_GAIN</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Set PD2MUX=1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_20</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					  <span class="n">MT2063_REG_RSVD_20</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MT2063_SetReceiverMode() - Set the MT2063 receiver mode, according with</span>
<span class="cm"> * 			      the selected enum mt2063_delivery_sys type.</span>
<span class="cm"> *</span>
<span class="cm"> *  (DNC1GC &amp; DNC2GC are the values, which are used, when the specific</span>
<span class="cm"> *   DNC Output is selected, the other is always off)</span>
<span class="cm"> *</span>
<span class="cm"> * @state:	ptr to mt2063_state structure</span>
<span class="cm"> * @Mode:	desired reciever delivery system</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Register cache must be valid for it to work</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_SetReceiverMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">mt2063_delivery_sys</span> <span class="n">Mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Status to be returned        */</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">longval</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Mode</span> <span class="o">&gt;=</span> <span class="n">MT2063_NUM_RCVR_MODES</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="cm">/* RFAGCen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span>
		     <span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD1_TGT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">RFAGCEN</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span>
								   <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span>
								   <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD1_TGT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_PD1_TGT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* LNARin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTRL_2C</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">LNARIN</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTRL_2C</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_CTRL_2C</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIFFQEN and FIFFQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span>
		     <span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFF_CTRL2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">FIFFQEN</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">FIFFQ</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFF_CTRL2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_FIFF_CTRL2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="cm">/* trigger FIFF calibration, needed after changing FIFFQ */</span>
			<span class="n">val</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFF_CTRL</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_FIFF_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span>
			     <span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFF_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_FIFF_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* DNC1GC &amp; DNC2GC */</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_get_dnc_output_enable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">longval</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_set_dnc_output_enable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">longval</span><span class="p">);</span>

	<span class="cm">/* acLNAmax */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LNA_OV</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">ACLNAMAX</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LNA_OV</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_LNA_OV</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* LNATGT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LNA_TGT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">LNATGT</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LNA_TGT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_LNA_TGT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ACRF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RF_OV</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">ACRFMAX</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RF_OV</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_RF_OV</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PD1TGT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD1_TGT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">PD1TGT</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD1_TGT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_PD1_TGT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIFATN */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ACFIFMAX</span><span class="p">[</span><span class="n">Mode</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PART_REV</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MT2063_B3</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIF_OV</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIF_OV</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_FIF_OV</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PD2TGT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD2_TGT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">PD2TGT</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD2_TGT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_PD2_TGT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Ignore ATN Overload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LNA_TGT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">RFOVDIS</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LNA_TGT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_LNA_TGT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Ignore FIF Overload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD1_TGT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">FIFOVDIS</span><span class="p">[</span><span class="n">Mode</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PD1_TGT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_PD1_TGT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rcvr_mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mt2063 mode changed to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mt2063_mode_name</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rcvr_mode</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MT2063_ClearPowerMaskBits () - Clears the power-down mask bits for various</span>
<span class="cm"> *				  sections of the MT2063</span>
<span class="cm"> *</span>
<span class="cm"> * @Bits:		Mask bits to be cleared.</span>
<span class="cm"> *</span>
<span class="cm"> * See definition of MT2063_Mask_Bits type for description</span>
<span class="cm"> * of each of the power bits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_ClearPowerMaskBits</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">MT2063_Mask_Bits</span> <span class="n">Bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">Bits</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">MT2063_Mask_Bits</span><span class="p">)(</span><span class="n">Bits</span> <span class="o">&amp;</span> <span class="n">MT2063_ALL_SD</span><span class="p">);</span>	<span class="cm">/* Only valid bits for this tuner */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">Bits</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PWR_2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">Bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">|=</span>
		    <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				    <span class="n">MT2063_REG_PWR_2</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PWR_2</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">Bits</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PWR_1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">Bits</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">|=</span>
		    <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				    <span class="n">MT2063_REG_PWR_1</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PWR_1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MT2063_SoftwareShutdown() - Enables or disables software shutdown function.</span>
<span class="cm"> *			       When Shutdown is 1, any section whose power</span>
<span class="cm"> *			       mask is set will be shutdown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_SoftwareShutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">Shutdown</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Shutdown</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PWR_1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PWR_1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
			    <span class="n">MT2063_REG_PWR_1</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PWR_1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Shutdown</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_BYP_CTRL</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_BYP_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x9F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">|=</span>
		    <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				    <span class="n">MT2063_REG_BYP_CTRL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_BYP_CTRL</span><span class="p">],</span>
				    <span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_BYP_CTRL</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_BYP_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x9F</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">|=</span>
		    <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				    <span class="n">MT2063_REG_BYP_CTRL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_BYP_CTRL</span><span class="p">],</span>
				    <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_Round_fLO</span><span class="p">(</span><span class="n">u32</span> <span class="n">f_LO</span><span class="p">,</span> <span class="n">u32</span> <span class="n">f_LO_Step</span><span class="p">,</span> <span class="n">u32</span> <span class="n">f_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">f_ref</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_LO</span> <span class="o">/</span> <span class="n">f_ref</span><span class="p">)</span>
	    <span class="o">+</span> <span class="n">f_LO_Step</span> <span class="o">*</span> <span class="p">(((</span><span class="n">f_LO</span> <span class="o">%</span> <span class="n">f_ref</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_LO_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">f_LO_Step</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fLO_FractionalTerm() - Calculates the portion contributed by FracN / denom.</span>
<span class="cm"> *                        This function preserves maximum precision without</span>
<span class="cm"> *                        risk of overflow.  It accurately calculates</span>
<span class="cm"> *                        f_ref * num / denom to within 1 HZ with fixed math.</span>
<span class="cm"> *</span>
<span class="cm"> * @num :	Fractional portion of the multiplier</span>
<span class="cm"> * @denom:	denominator portion of the ratio</span>
<span class="cm"> * @f_Ref:	SRO frequency.</span>
<span class="cm"> *</span>
<span class="cm"> * This calculation handles f_ref as two separate 14-bit fields.</span>
<span class="cm"> * Therefore, a maximum value of 2^28-1 may safely be used for f_ref.</span>
<span class="cm"> * This is the genesis of the magic number &quot;14&quot; and the magic mask value of</span>
<span class="cm"> * 0x03FFF.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine successfully handles denom values up to and including 2^18.</span>
<span class="cm"> *  Returns:        f_ref * num / denom</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_fLO_FractionalTerm</span><span class="p">(</span><span class="n">u32</span> <span class="n">f_ref</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num</span><span class="p">,</span> <span class="n">u32</span> <span class="n">denom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_ref</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">term1</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">/</span> <span class="n">denom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">%</span> <span class="n">denom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">term2</span> <span class="o">=</span>
	    <span class="p">(((</span><span class="n">f_ref</span> <span class="o">&amp;</span> <span class="mh">0x00003FFF</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span> <span class="o">+</span> <span class="p">(</span><span class="n">loss</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">denom</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">denom</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">term1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">+</span> <span class="n">term2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CalcLO1Mult()- Calculates Integer divider value and the numerator</span>
<span class="cm"> *                value for a FracN PLL.</span>
<span class="cm"> *</span>
<span class="cm"> *                This function assumes that the f_LO and f_Ref are</span>
<span class="cm"> *                evenly divisible by f_LO_Step.</span>
<span class="cm"> *</span>
<span class="cm"> * @Div:	OUTPUT: Whole number portion of the multiplier</span>
<span class="cm"> * @FracN:	OUTPUT: Fractional portion of the multiplier</span>
<span class="cm"> * @f_LO:	desired LO frequency.</span>
<span class="cm"> * @f_LO_Step:	Minimum step size for the LO (in Hz).</span>
<span class="cm"> * @f_Ref:	SRO frequency.</span>
<span class="cm"> * @f_Avoid:	Range of PLL frequencies to avoid near integer multiples</span>
<span class="cm"> *		of f_Ref (in Hz).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:        Recalculated LO frequency.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_CalcLO1Mult</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">Div</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="o">*</span><span class="n">FracN</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">f_LO</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">f_LO_Step</span><span class="p">,</span> <span class="n">u32</span> <span class="n">f_Ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  Calculate the whole number portion of the divider */</span>
	<span class="o">*</span><span class="n">Div</span> <span class="o">=</span> <span class="n">f_LO</span> <span class="o">/</span> <span class="n">f_Ref</span><span class="p">;</span>

	<span class="cm">/*  Calculate the numerator value (round to nearest f_LO_Step) */</span>
	<span class="o">*</span><span class="n">FracN</span> <span class="o">=</span>
	    <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="p">(((</span><span class="n">f_LO</span> <span class="o">%</span> <span class="n">f_Ref</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_LO_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">f_LO_Step</span><span class="p">)</span> <span class="o">+</span>
	     <span class="p">(</span><span class="n">f_Ref</span> <span class="o">/</span> <span class="n">f_LO_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">f_Ref</span> <span class="o">/</span> <span class="n">f_LO_Step</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">f_Ref</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">Div</span><span class="p">))</span> <span class="o">+</span> <span class="n">MT2063_fLO_FractionalTerm</span><span class="p">(</span><span class="n">f_Ref</span><span class="p">,</span> <span class="o">*</span><span class="n">FracN</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * CalcLO2Mult() - Calculates Integer divider value and the numerator</span>
<span class="cm"> *                 value for a FracN PLL.</span>
<span class="cm"> *</span>
<span class="cm"> *                  This function assumes that the f_LO and f_Ref are</span>
<span class="cm"> *                  evenly divisible by f_LO_Step.</span>
<span class="cm"> *</span>
<span class="cm"> * @Div:	OUTPUT: Whole number portion of the multiplier</span>
<span class="cm"> * @FracN:	OUTPUT: Fractional portion of the multiplier</span>
<span class="cm"> * @f_LO:	desired LO frequency.</span>
<span class="cm"> * @f_LO_Step:	Minimum step size for the LO (in Hz).</span>
<span class="cm"> * @f_Ref:	SRO frequency.</span>
<span class="cm"> * @f_Avoid:	Range of PLL frequencies to avoid near</span>
<span class="cm"> *		integer multiples of f_Ref (in Hz).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: Recalculated LO frequency.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_CalcLO2Mult</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">Div</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="o">*</span><span class="n">FracN</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">f_LO</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">f_LO_Step</span><span class="p">,</span> <span class="n">u32</span> <span class="n">f_Ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  Calculate the whole number portion of the divider */</span>
	<span class="o">*</span><span class="n">Div</span> <span class="o">=</span> <span class="n">f_LO</span> <span class="o">/</span> <span class="n">f_Ref</span><span class="p">;</span>

	<span class="cm">/*  Calculate the numerator value (round to nearest f_LO_Step) */</span>
	<span class="o">*</span><span class="n">FracN</span> <span class="o">=</span>
	    <span class="p">(</span><span class="mi">8191</span> <span class="o">*</span> <span class="p">(((</span><span class="n">f_LO</span> <span class="o">%</span> <span class="n">f_Ref</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_LO_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">f_LO_Step</span><span class="p">)</span> <span class="o">+</span>
	     <span class="p">(</span><span class="n">f_Ref</span> <span class="o">/</span> <span class="n">f_LO_Step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">f_Ref</span> <span class="o">/</span> <span class="n">f_LO_Step</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">f_Ref</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">Div</span><span class="p">))</span> <span class="o">+</span> <span class="n">MT2063_fLO_FractionalTerm</span><span class="p">(</span><span class="n">f_Ref</span><span class="p">,</span> <span class="o">*</span><span class="n">FracN</span><span class="p">,</span>
							    <span class="mi">8191</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FindClearTuneFilter() - Calculate the corrrect ClearTune filter to be</span>
<span class="cm"> *			   used for a given input frequency.</span>
<span class="cm"> *</span>
<span class="cm"> * @state:	ptr to tuner data structure</span>
<span class="cm"> * @f_in:	RF input center frequency (in Hz).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: ClearTune filter number (0-31)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">FindClearTuneFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">f_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">RFBand</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>		<span class="cm">/*  index loop                      */</span>

	<span class="cm">/*</span>
<span class="cm">	 **  Find RF Band setting</span>
<span class="cm">	 */</span>
	<span class="n">RFBand</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>		<span class="cm">/*  def when f_in &gt; all    */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">f_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RFBand</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RFBand</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MT2063_Tune() - Change the tuner&#39;s tuned frequency to RFin.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">MT2063_Tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">f_in</span><span class="p">)</span>
<span class="p">{</span>				<span class="cm">/* RF input center frequency   */</span>

	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">LO1</span><span class="p">;</span>		<span class="cm">/*  1st LO register value           */</span>
	<span class="n">u32</span> <span class="n">Num1</span><span class="p">;</span>		<span class="cm">/*  Numerator for LO1 reg. value    */</span>
	<span class="n">u32</span> <span class="n">f_IF1</span><span class="p">;</span>		<span class="cm">/*  1st IF requested                */</span>
	<span class="n">u32</span> <span class="n">LO2</span><span class="p">;</span>		<span class="cm">/*  2nd LO register value           */</span>
	<span class="n">u32</span> <span class="n">Num2</span><span class="p">;</span>		<span class="cm">/*  Numerator for LO2 reg. value    */</span>
	<span class="n">u32</span> <span class="n">ofLO1</span><span class="p">,</span> <span class="n">ofLO2</span><span class="p">;</span>	<span class="cm">/*  last time&#39;s LO frequencies      */</span>
	<span class="n">u8</span> <span class="n">fiffc</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/*  FIFF center freq from tuner     */</span>
	<span class="n">u32</span> <span class="n">fiffof</span><span class="p">;</span>		<span class="cm">/*  Offset from FIFF center freq    */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">LO1LK</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/*  Mask for LO1 Lock bit           */</span>
	<span class="n">u8</span> <span class="n">LO2LK</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/*  Mask for LO2 Lock bit           */</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">RFBand</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*  Check the input and output frequency ranges                   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">f_in</span> <span class="o">&lt;</span> <span class="n">MT2063_MIN_FIN_FREQ</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">f_in</span> <span class="o">&gt;</span> <span class="n">MT2063_MAX_FIN_FREQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span> <span class="o">&lt;</span> <span class="n">MT2063_MIN_FOUT_FREQ</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span> <span class="o">&gt;</span> <span class="n">MT2063_MAX_FOUT_FREQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save original LO1 and LO2 register values</span>
<span class="cm">	 */</span>
	<span class="n">ofLO1</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span><span class="p">;</span>
	<span class="n">ofLO2</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span><span class="p">;</span> 

	<span class="cm">/*</span>
<span class="cm">	 * Find and set RF Band setting</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ctfilt_sw</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_OV</span><span class="p">];</span>
		<span class="n">RFBand</span> <span class="o">=</span> <span class="n">FindClearTuneFilter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">f_in</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_OV</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_OV</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span>
			      <span class="o">|</span> <span class="n">RFBand</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_OV</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">|=</span>
			    <span class="n">mt2063_setreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_CTUNE_OV</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the FIFF Center Frequency from the tuner</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">|=</span>
		    <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				   <span class="n">MT2063_REG_FIFFC</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFFC</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fiffc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFFC</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Assign in the requested values</span>
<span class="cm">	 */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_in</span> <span class="o">=</span> <span class="n">f_in</span><span class="p">;</span>
	<span class="cm">/*  Request a 1st IF such that LO1 is on a step size */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_if1_Request</span> <span class="o">=</span>
	    <span class="n">MT2063_Round_fLO</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_if1_Request</span> <span class="o">+</span> <span class="n">f_in</span><span class="p">,</span>
			     <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1_Step</span><span class="p">,</span>
			     <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span><span class="p">)</span> <span class="o">-</span> <span class="n">f_in</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate frequency settings.  f_IF1_FREQ + f_in is the</span>
<span class="cm">	 * desired LO1 frequency</span>
<span class="cm">	 */</span>
	<span class="n">MT2063_ResetExclZones</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">);</span>

	<span class="n">f_IF1</span> <span class="o">=</span> <span class="n">MT2063_ChooseFirstIF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">=</span>
	    <span class="n">MT2063_Round_fLO</span><span class="p">(</span><span class="n">f_IF1</span> <span class="o">+</span> <span class="n">f_in</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1_Step</span><span class="p">,</span>
			     <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span> <span class="o">=</span>
	    <span class="n">MT2063_Round_fLO</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span> <span class="o">-</span> <span class="n">f_in</span><span class="p">,</span>
			     <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2_Step</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for any LO spurs in the output bandwidth and adjust</span>
<span class="cm">	 * the LO settings to avoid them if needed</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">MT2063_AvoidSpurs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * MT_AvoidSpurs spurs may have changed the LO1 &amp; LO2 values.</span>
<span class="cm">	 * Recalculate the LO frequencies and the values to be placed</span>
<span class="cm">	 * in the tuning registers.</span>
<span class="cm">	 */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">=</span>
	    <span class="n">MT2063_CalcLO1Mult</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LO1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Num1</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span><span class="p">,</span>
			       <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1_Step</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span> <span class="o">=</span>
	    <span class="n">MT2063_Round_fLO</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span> <span class="o">-</span> <span class="n">f_in</span><span class="p">,</span>
			     <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2_Step</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span> <span class="o">=</span>
	    <span class="n">MT2063_CalcLO2Mult</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LO2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Num2</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span><span class="p">,</span>
			       <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2_Step</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Check the upconverter and downconverter frequency ranges</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">&lt;</span> <span class="n">MT2063_MIN_UPC_FREQ</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">&gt;</span> <span class="n">MT2063_MAX_UPC_FREQ</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">MT2063_UPC_RANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span> <span class="o">&lt;</span> <span class="n">MT2063_MIN_DNC_FREQ</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span> <span class="o">&gt;</span> <span class="n">MT2063_MAX_DNC_FREQ</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">MT2063_DNC_RANGE</span><span class="p">;</span>
	<span class="cm">/*  LO2 Lock bit was in a different place for B0 version  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_id</span> <span class="o">==</span> <span class="n">MT2063_B0</span><span class="p">)</span>
		<span class="n">LO2LK</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If we have the same LO frequencies and we&#39;re already locked,</span>
<span class="cm">	 *  then skip re-programming the LO registers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ofLO1</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ofLO2</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO_STATUS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LO1LK</span> <span class="o">|</span> <span class="n">LO2LK</span><span class="p">))</span> <span class="o">!=</span>
		<span class="p">(</span><span class="n">LO1LK</span> <span class="o">|</span> <span class="n">LO2LK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Calculate the FIFFOF register value</span>
<span class="cm">		 *</span>
<span class="cm">		 *           IF1_Actual</span>
<span class="cm">		 * FIFFOF = ------------ - 8 * FIFFC - 4992</span>
<span class="cm">		 *            f_ref/64</span>
<span class="cm">		 */</span>
		<span class="n">fiffof</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">-</span>
		     <span class="n">f_in</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">fiffc</span> <span class="o">-</span>
		    <span class="mi">4992</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fiffof</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="n">fiffof</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Place all of the calculated values into the local tuner</span>
<span class="cm">		 * register fields.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO1CQ_1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">LO1</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>	<span class="cm">/* DIV1q */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO1CQ_2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">Num1</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>	<span class="cm">/* NUM1q */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO2CQ_1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">LO2</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* DIV2q */</span>
								   <span class="o">|</span><span class="p">(</span><span class="n">Num2</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>	<span class="cm">/* NUM2q (hi) */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO2CQ_2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">Num2</span> <span class="o">&amp;</span> <span class="mh">0x0FF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* NUM2q (mid) */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO2CQ_3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="mh">0xE0</span> <span class="o">|</span> <span class="p">(</span><span class="n">Num2</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>	<span class="cm">/* NUM2q (lo) */</span>

			<span class="cm">/*</span>
<span class="cm">			 * Now write out the computed register values</span>
<span class="cm">			 * IMPORTANT: There is a required order for writing</span>
<span class="cm">			 *            (0x05 must follow all the others).</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_LO1CQ_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO1CQ_1</span><span class="p">],</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* 0x01 - 0x05 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_id</span> <span class="o">==</span> <span class="n">MT2063_B0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Re-write the one-shot bits to trigger the tune operation */</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_LO2CQ_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_LO2CQ_3</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* 0x05 */</span>
			<span class="p">}</span>
			<span class="cm">/* Write out the FIFF offset only if it&#39;s changing */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFF_OFFSET</span><span class="p">]</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">fiffof</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFF_OFFSET</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">fiffof</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">|=</span>
				    <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						    <span class="n">MT2063_REG_FIFF_OFFSET</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span>
						    <span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFF_OFFSET</span><span class="p">],</span>
						    <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check for LO&#39;s locking</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_lockStatus</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* Couldn&#39;t lock */</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we locked OK, assign calculated data to mt2063_state structure</span>
<span class="cm">		 */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">f_IF1_actual</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">-</span> <span class="n">f_in</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">MT2063B0_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Reg,  Value */</span>
	<span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span>
	<span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span>
	<span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
	<span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span>
	<span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span>
	<span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span>
	<span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span>
	<span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span>	<span class="cm">/*  bit at 0x20 is cleared below  */</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>	<span class="cm">/*  bit at 0x20 is cleared here   */</span>
	<span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span>
	<span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span>	<span class="cm">/*  Set the FIFCrst bit here      */</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span>	<span class="cm">/*  Clear the FIFCrst bit here    */</span>
	<span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/* writing 0x05 0xf0 sw-resets all registers, so we write only needed changes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">MT2063B1_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Reg,  Value */</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* New Enable AFCsd */</span>
	<span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span>
	<span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span>
	<span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span>	<span class="cm">/* New - ver 1.03 */</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span>	<span class="cm">/* New - ver 1.10 */</span>
	<span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>	<span class="cm">/* New - ver 1.03 */</span>
	<span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>	<span class="cm">/*  bit at 0x20 is cleared below  */</span>
	<span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span>	<span class="cm">/*  FIFFQ=0  */</span>
	<span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span>	<span class="cm">/* New - ver 1.11 */</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span>	<span class="cm">/* New - ver 1.11 */</span>
	<span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/*  bit at 0x20 is cleared here  */</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span>	<span class="cm">/*  Set the FIFCrst bit here      */</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span>	<span class="cm">/*  Clear the FIFCrst bit here    */</span>
	<span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/* writing 0x05 0xf0 sw-resets all registers, so we write only needed changes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">MT2063B3_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Reg,  Value */</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span>
	<span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span>
	<span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>	<span class="cm">/*  bit at 0x20 is cleared below  */</span>
	<span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/*  bit at 0x20 is cleared here  */</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span>	<span class="cm">/*  Set the FIFCrst bit here      */</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span>	<span class="cm">/*  Clear the FIFCrst bit here    */</span>
	<span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt2063_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">all_resets</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>	<span class="cm">/* reset/load bits */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">step</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">FCRUN</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">maxReads</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcu_osc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rcvr_mode</span> <span class="o">=</span> <span class="n">MT2063_CABLE_QAM</span><span class="p">;</span>

	<span class="cm">/*  Read the Part/Rev code from the tuner */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_PART_REV</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PART_REV</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t read mt2063 part ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the part/rev code */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PART_REV</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MT2063_B0</span>:
		<span class="n">step</span> <span class="o">=</span> <span class="s">&quot;B0&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MT2063_B1</span>:
		<span class="n">step</span> <span class="o">=</span> <span class="s">&quot;B1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MT2063_B2</span>:
		<span class="n">step</span> <span class="o">=</span> <span class="s">&quot;B2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MT2063_B3</span>:
		<span class="n">step</span> <span class="o">=</span> <span class="s">&quot;B3&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mt2063: Unknown mt2063 device ID (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PART_REV</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	<span class="cm">/*  Wrong tuner Part/Rev code */</span>
	<span class="p">}</span>

	<span class="cm">/*  Check the 2nd byte of the Part/Rev code from the tuner */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_RSVD_3B</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_3B</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* b7 != 0 ==&gt; NOT MT2063 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_3B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mt2063: Unknown part ID (0x%02x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PART_REV</span><span class="p">],</span>
		       <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_RSVD_3B</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	<span class="cm">/*  Wrong tuner Part/Rev code */</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mt2063: detected a mt2063 %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>

	<span class="cm">/*  Reset the tuner  */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_LO2CQ_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_resets</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* change all of the default values that vary from the HW reset values */</span>
	<span class="cm">/*  def = (state-&gt;reg[PART_REV] == MT2063_B0) ? MT2063B0_defaults : MT2063B1_defaults; */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PART_REV</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MT2063_B3</span>:
		<span class="n">def</span> <span class="o">=</span> <span class="n">MT2063B3_defaults</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MT2063_B1</span>:
		<span class="n">def</span> <span class="o">=</span> <span class="n">MT2063B1_defaults</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MT2063_B0</span>:
		<span class="n">def</span> <span class="o">=</span> <span class="n">MT2063B0_defaults</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">def</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="o">*</span><span class="n">def</span><span class="o">++</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">def</span><span class="o">++</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*  Wait for FIFF location to complete.  */</span>
	<span class="n">FCRUN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">maxReads</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">FCRUN</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">maxReads</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					 <span class="n">MT2063_REG_XO_STATUS</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span>
					 <span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_XO_STATUS</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">FCRUN</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_XO_STATUS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FCRUN</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
			   <span class="n">MT2063_REG_FIFFC</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFFC</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Read back all the registers from the tuner */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				<span class="n">MT2063_REG_PART_REV</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MT2063_REG_END_REGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*  Initialize the tuner state.  */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_PART_REV</span><span class="p">];</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span> <span class="o">=</span> <span class="n">MT2063_REF_FREQ</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_if1_Center</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span>
				      <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFFC</span><span class="p">]</span> <span class="o">+</span> <span class="mi">640</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_if1_bw</span> <span class="o">=</span> <span class="n">MT2063_IF1_BW</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span> <span class="o">=</span> <span class="mi">43750000UL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out_bw</span> <span class="o">=</span> <span class="mi">6750000UL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_zif_bw</span> <span class="o">=</span> <span class="n">MT2063_ZIF_BW</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1_Step</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_ref</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2_Step</span> <span class="o">=</span> <span class="n">MT2063_TUNE_STEP_SIZE</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">maxH1</span> <span class="o">=</span> <span class="n">MT2063_MAX_HARMONICS_1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">maxH2</span> <span class="o">=</span> <span class="n">MT2063_MAX_HARMONICS_2</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_min_LO_Separation</span> <span class="o">=</span> <span class="n">MT2063_MIN_LO_SEP</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_if1_Request</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_if1_Center</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">=</span> <span class="mi">2181000000UL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2</span> <span class="o">=</span> <span class="mi">1486249786UL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">f_IF1_actual</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_if1_Center</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_in</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">f_IF1_actual</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO1_FracN_Avoid</span> <span class="o">=</span> <span class="n">MT2063_LO1_FRACN_AVOID</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2_FracN_Avoid</span> <span class="o">=</span> <span class="n">MT2063_LO2_FRACN_AVOID</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">num_regs</span> <span class="o">=</span> <span class="n">MT2063_REG_END_REGS</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">avoidDECT</span> <span class="o">=</span> <span class="n">MT2063_AVOID_BOTH</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ctfilt_sw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">69230000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">105770000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">140350000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">177110000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">212860000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">241130000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">274370000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">309820000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">342450000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">378870000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">416210000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">456500000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">495790000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">534530000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">572610000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">598970000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">635910000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">672130000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">714840000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">739660000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">770410000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">814660000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mi">846950000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">867820000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mi">915980000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">947450000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mi">983110000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1021630000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1061870000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1098330000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1138990000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 **   Fetch the FCU osc value and use it and the fRef value to</span>
<span class="cm">	 **   scale all of the Band Max values</span>
<span class="cm">	 */</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*  Read the ClearTune filter calibration value  */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_FIFFC</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFFC</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">fcu_osc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_FIFFC</span><span class="p">];</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">MT2063_REG_CTUNE_CTRL</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*  Adjust each of the values in the ClearTune filter cross-over table  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">CTFiltMax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">768</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fcu_osc</span> <span class="o">+</span> <span class="mi">640</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">MT2063_SoftwareShutdown</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">MT2063_ClearPowerMaskBits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_ALL_SD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt2063_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tuner_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tuner_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_lockStatus</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tuner_status</span> <span class="o">=</span> <span class="n">TUNER_STATUS_LOCKED</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner status: %d&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">tuner_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt2063_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt2063_set_analog_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">pict_car</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">pict2chanb_vsb</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ch_bw</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">if_mid</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rcvr_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_RADIO</span>:
		<span class="n">pict_car</span> <span class="o">=</span> <span class="mi">38900000</span><span class="p">;</span>
		<span class="n">ch_bw</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
		<span class="n">pict2chanb_vsb</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ch_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">rcvr_mode</span> <span class="o">=</span> <span class="n">MT2063_OFFAIR_ANALOG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_ANALOG_TV</span>:
		<span class="n">rcvr_mode</span> <span class="o">=</span> <span class="n">MT2063_CABLE_ANALOG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">V4L2_STD_MN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pict_car</span> <span class="o">=</span> <span class="mi">38900000</span><span class="p">;</span>
			<span class="n">ch_bw</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
			<span class="n">pict2chanb_vsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1250000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pict_car</span> <span class="o">=</span> <span class="mi">38900000</span><span class="p">;</span>
			<span class="n">ch_bw</span> <span class="o">=</span> <span class="mi">7000000</span><span class="p">;</span>
			<span class="n">pict2chanb_vsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1250000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* PAL/SECAM standards */</span>
			<span class="n">pict_car</span> <span class="o">=</span> <span class="mi">38900000</span><span class="p">;</span>
			<span class="n">ch_bw</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
			<span class="n">pict2chanb_vsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1250000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">if_mid</span> <span class="o">=</span> <span class="n">pict_car</span> <span class="o">-</span> <span class="p">(</span><span class="n">pict2chanb_vsb</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2_Step</span> <span class="o">=</span> <span class="mi">125000</span><span class="p">;</span>	<span class="cm">/* FIXME: probably 5000 for FM */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span> <span class="o">=</span> <span class="n">if_mid</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out_bw</span> <span class="o">=</span> <span class="n">ch_bw</span> <span class="o">+</span> <span class="mi">750000</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">MT2063_SetReceiverMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rcvr_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuning to frequency: %d, bandwidth %d, foffset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">ch_bw</span><span class="p">,</span> <span class="n">pict2chanb_vsb</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">MT2063_Tune</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="p">(</span><span class="n">pict2chanb_vsb</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * As defined on EN 300 429, the DVB-C roll-off factor is 0.15.</span>
<span class="cm"> * So, the amount of the needed bandwith is given by:</span>
<span class="cm"> *	Bw = Symbol_rate * (1 + 0.15)</span>
<span class="cm"> * As such, the maximum symbol rate supported by 6 MHz is given by:</span>
<span class="cm"> *	max_symbol_rate = 6 MHz / 1.15 = 5217391 Bauds</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_SYMBOL_RATE_6MHz	5217391</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt2063_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">pict_car</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">pict2chanb_vsb</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ch_bw</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">if_mid</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rcvr_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mt2063_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">&lt;=</span> <span class="mi">6000000</span><span class="p">)</span>
		<span class="n">ch_bw</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
		<span class="n">ch_bw</span> <span class="o">=</span> <span class="mi">7000000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ch_bw</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBT</span>:
		<span class="n">rcvr_mode</span> <span class="o">=</span> <span class="n">MT2063_OFFAIR_COFDM</span><span class="p">;</span>
		<span class="n">pict_car</span> <span class="o">=</span> <span class="mi">36125000</span><span class="p">;</span>
		<span class="n">pict2chanb_vsb</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ch_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_A</span>:
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_C</span>:
		<span class="n">rcvr_mode</span> <span class="o">=</span> <span class="n">MT2063_CABLE_QAM</span><span class="p">;</span>
		<span class="n">pict_car</span> <span class="o">=</span> <span class="mi">36125000</span><span class="p">;</span>
		<span class="n">pict2chanb_vsb</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ch_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">if_mid</span> <span class="o">=</span> <span class="n">pict_car</span> <span class="o">-</span> <span class="p">(</span><span class="n">pict2chanb_vsb</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_LO2_Step</span> <span class="o">=</span> <span class="mi">125000</span><span class="p">;</span>	<span class="cm">/* FIXME: probably 5000 for FM */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span> <span class="o">=</span> <span class="n">if_mid</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out_bw</span> <span class="o">=</span> <span class="n">ch_bw</span> <span class="o">+</span> <span class="mi">750000</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">MT2063_SetReceiverMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rcvr_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuning to frequency: %d, bandwidth %d, foffset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">ch_bw</span><span class="p">,</span> <span class="n">pict2chanb_vsb</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">MT2063_Tune</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="p">(</span><span class="n">pict2chanb_vsb</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch_bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt2063_get_if_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="o">*</span><span class="n">freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;IF frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">freq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt2063_get_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">AS_Data</span><span class="p">.</span><span class="n">f_out_bw</span> <span class="o">-</span> <span class="mi">750000</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bandwidth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">bw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">mt2063_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MT2063 Silicon Tuner&quot;</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">45000000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">865000000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="p">},</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">mt2063_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">MT2063_Sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span> <span class="o">=</span> <span class="n">mt2063_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_analog_params</span> <span class="o">=</span> <span class="n">mt2063_set_analog_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_params</span>    <span class="o">=</span> <span class="n">mt2063_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_if_frequency</span> <span class="o">=</span> <span class="n">mt2063_get_if_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bandwidth</span> <span class="o">=</span> <span class="n">mt2063_get_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">mt2063_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">mt2063_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">mt2063_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mt2063_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span> <span class="o">=</span> <span class="n">fe</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">reference</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">refclock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* kHz */</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span> <span class="o">=</span> <span class="n">mt2063_ops</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Attaching MT2063</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mt2063_attach</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Ancillary routines visible outside mt2063</span>
<span class="cm"> * FIXME: Remove them in favor of using standard tuner callbacks</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tuner_MT2063_SoftwareShutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">MT2063_SoftwareShutdown</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Couldn&#39;t shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tuner_MT2063_SoftwareShutdown</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tuner_MT2063_ClearPowerMaskBits</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mt2063_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">MT2063_ClearPowerMaskBits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MT2063_ALL_SD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tuner_MT2063_ClearPowerMaskBits</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mauro Carvalho Chehab &lt;mchehab@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MT2063 Silicon tuner&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
