<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › common › tuners › tuner-simple.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tuner-simple.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * i2c tv tuner chip device driver</span>
<span class="cm"> * controls all those simple 4-control-bytes style tuners.</span>
<span class="cm"> *</span>
<span class="cm"> * This &quot;tuner-simple&quot; module was split apart from the original &quot;tuner&quot; module.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/tuner-types.h&gt;</span>
<span class="cp">#include &quot;tuner-i2c.h&quot;</span>
<span class="cp">#include &quot;tuner-simple.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable verbose debug messages&quot;</span><span class="p">);</span>

<span class="cp">#define TUNER_SIMPLE_MAX 64</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">simple_devcount</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="s">&quot;Allows to specify an offset for tuner&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atv_input</span><span class="p">[</span><span class="n">TUNER_SIMPLE_MAX</span><span class="p">]</span> <span class="o">=</span> \
			<span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">TUNER_SIMPLE_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dtv_input</span><span class="p">[</span><span class="n">TUNER_SIMPLE_MAX</span><span class="p">]</span> <span class="o">=</span> \
			<span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">TUNER_SIMPLE_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">atv_input</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dtv_input</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">atv_input</span><span class="p">,</span> <span class="s">&quot;specify atv rf input, 0 for autoselect&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dtv_input</span><span class="p">,</span> <span class="s">&quot;specify dtv rf input, 0 for autoselect&quot;</span><span class="p">);</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="cm">/* tv standard selection for Temic 4046 FM5</span>
<span class="cm">   this value takes the low bits of control byte 2</span>
<span class="cm">   from datasheet Rev.01, Feb.00</span>
<span class="cm">     standard     BG      I       L       L2      D</span>
<span class="cm">     picture IF   38.9    38.9    38.9    33.95   38.9</span>
<span class="cm">     sound 1      33.4    32.9    32.4    40.45   32.4</span>
<span class="cm">     sound 2      33.16</span>
<span class="cm">     NICAM        33.05   32.348  33.05           33.05</span>
<span class="cm"> */</span>
<span class="cp">#define TEMIC_SET_PAL_I         0x05</span>
<span class="cp">#define TEMIC_SET_PAL_DK        0x09</span>
<span class="cp">#define TEMIC_SET_PAL_L         0x0a </span><span class="cm">/* SECAM ? */</span><span class="cp"></span>
<span class="cp">#define TEMIC_SET_PAL_L2        0x0b </span><span class="cm">/* change IF ! */</span><span class="cp"></span>
<span class="cp">#define TEMIC_SET_PAL_BG        0x0c</span>

<span class="cm">/* tv tuner system standard selection for Philips FQ1216ME</span>
<span class="cm">   this value takes the low bits of control byte 2</span>
<span class="cm">   from datasheet &quot;1999 Nov 16&quot; (supersedes &quot;1999 Mar 23&quot;)</span>
<span class="cm">     standard 		BG	DK	I	L	L`</span>
<span class="cm">     picture carrier	38.90	38.90	38.90	38.90	33.95</span>
<span class="cm">     colour		34.47	34.47	34.47	34.47	38.38</span>
<span class="cm">     sound 1		33.40	32.40	32.90	32.40	40.45</span>
<span class="cm">     sound 2		33.16	-	-	-	-</span>
<span class="cm">     NICAM		33.05	33.05	32.35	33.05	39.80</span>
<span class="cm"> */</span>
<span class="cp">#define PHILIPS_SET_PAL_I	0x01 </span><span class="cm">/* Bit 2 always zero !*/</span><span class="cp"></span>
<span class="cp">#define PHILIPS_SET_PAL_BGDK	0x09</span>
<span class="cp">#define PHILIPS_SET_PAL_L2	0x0a</span>
<span class="cp">#define PHILIPS_SET_PAL_L	0x0b</span>

<span class="cm">/* system switching for Philips FI1216MF MK2</span>
<span class="cm">   from datasheet &quot;1996 Jul 09&quot;,</span>
<span class="cm">    standard         BG     L      L&#39;</span>
<span class="cm">    picture carrier  38.90  38.90  33.95</span>
<span class="cm">    colour	     34.47  34.37  38.38</span>
<span class="cm">    sound 1          33.40  32.40  40.45</span>
<span class="cm">    sound 2          33.16  -      -</span>
<span class="cm">    NICAM            33.05  33.05  39.80</span>
<span class="cm"> */</span>
<span class="cp">#define PHILIPS_MF_SET_STD_BG	0x01 </span><span class="cm">/* Bit 2 must be zero, Bit 3 is system output */</span><span class="cp"></span>
<span class="cp">#define PHILIPS_MF_SET_STD_L	0x03 </span><span class="cm">/* Used on Secam France */</span><span class="cp"></span>
<span class="cp">#define PHILIPS_MF_SET_STD_LC	0x02 </span><span class="cm">/* Used on SECAM L&#39; */</span><span class="cp"></span>

<span class="cm">/* Control byte */</span>

<span class="cp">#define TUNER_RATIO_MASK        0x06 </span><span class="cm">/* Bit cb1:cb2 */</span><span class="cp"></span>
<span class="cp">#define TUNER_RATIO_SELECT_50   0x00</span>
<span class="cp">#define TUNER_RATIO_SELECT_32   0x02</span>
<span class="cp">#define TUNER_RATIO_SELECT_166  0x04</span>
<span class="cp">#define TUNER_RATIO_SELECT_62   0x06</span>

<span class="cp">#define TUNER_CHARGE_PUMP       0x40  </span><span class="cm">/* Bit cb6 */</span><span class="cp"></span>

<span class="cm">/* Status byte */</span>

<span class="cp">#define TUNER_POR	  0x80</span>
<span class="cp">#define TUNER_FL          0x40</span>
<span class="cp">#define TUNER_MODE        0x38</span>
<span class="cp">#define TUNER_AFC         0x07</span>
<span class="cp">#define TUNER_SIGNAL      0x07</span>
<span class="cp">#define TUNER_STEREO      0x10</span>

<span class="cp">#define TUNER_PLL_LOCKED   0x40</span>
<span class="cp">#define TUNER_STEREO_MK3   0x04</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">tuner_simple_list_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">hybrid_tuner_instance_list</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">last_div</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tuner_i2c_props</span> <span class="n">i2c_props</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">hybrid_tuner_instance_list</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tunertype</span> <span class="o">*</span><span class="n">tun</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">tuner_i2c_xfer_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">byte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tuner_signal</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TUNER_SIGNAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tuner_stereo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1216ME_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1236_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1256_IH3</span>:
	<span class="k">case</span> <span class="n">TUNER_LG_NTSC_TAPE</span>:
	<span class="k">case</span> <span class="n">TUNER_TCL_MF02GIP_5N</span>:
		<span class="k">return</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TUNER_SIGNAL</span><span class="p">)</span> <span class="o">==</span> <span class="n">TUNER_STEREO_MK3</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1216MK5</span>:
		<span class="k">return</span> <span class="n">status</span> <span class="o">|</span> <span class="n">TUNER_STEREO</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">TUNER_STEREO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tuner_islocked</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TUNER_FL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tuner_afcstatus</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TUNER_AFC</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tuner_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tuner_status</span> <span class="o">=</span> <span class="n">tuner_read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_islocked</span><span class="p">(</span><span class="n">tuner_status</span><span class="p">))</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">TUNER_STATUS_LOCKED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_stereo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">tuner_status</span><span class="p">))</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TUNER_STATUS_STEREO</span><span class="p">;</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;AFC Status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner_afcstatus</span><span class="p">(</span><span class="n">tuner_status</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_get_rf_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">signal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">signal</span> <span class="o">=</span> <span class="n">tuner_signal</span><span class="p">(</span><span class="n">tuner_read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">));</span>

	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="n">signal</span><span class="p">;</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Signal strength: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tuner_param_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">param_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_PARAM_TYPE_RADIO</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;radio&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PARAM_TYPE_PAL</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pal&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PARAM_TYPE_SECAM</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;secam&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PARAM_TYPE_NTSC</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ntsc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PARAM_TYPE_DIGITAL</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;digital&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tuner_params</span> <span class="o">*</span><span class="nf">simple_tuner_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">param_type</span> <span class="n">desired_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tunertype</span> <span class="o">*</span><span class="n">tun</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desired_type</span> <span class="o">==</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* use default tuner params if desired_type not available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;desired params (%s) undefined for tuner %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tuner_param_name</span><span class="p">(</span><span class="n">desired_type</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;using tuner params #%d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		  <span class="n">tuner_param_name</span><span class="p">(</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_config_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tuner_params</span> <span class="o">*</span><span class="n">t_params</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="o">*</span><span class="n">frequency</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">limit</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;frequency out of range (%d &gt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="o">*</span><span class="n">frequency</span><span class="p">,</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">limit</span><span class="p">);</span>
		<span class="o">*</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="o">--</span><span class="n">i</span><span class="p">].</span><span class="n">limit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cb</span>     <span class="o">=</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;freq = %d.%02d (%d), range = %d, &quot;</span>
		  <span class="s">&quot;config = 0x%02x, cb = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="o">*</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="o">*</span><span class="n">frequency</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="o">*</span><span class="n">frequency</span><span class="p">,</span>
		  <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">cb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">simple_set_rf_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_TUV1236D</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">rf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FCV1236D</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">rf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_std_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* tv norm specific stuff for multi-norm tuners */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_SECAM</span>: <span class="cm">/* FI1216MF */</span>
		<span class="cm">/* 0x01 -&gt; ??? no change ??? */</span>
		<span class="cm">/* 0x02 -&gt; PAL BDGHI / SECAM L */</span>
		<span class="cm">/* 0x04 -&gt; ??? PAL others / SECAM others ??? */</span>
		<span class="o">*</span><span class="n">cb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span>
			<span class="cm">/* also valid for V4L2_STD_SECAM */</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">PHILIPS_MF_SET_STD_L</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">)</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">PHILIPS_MF_SET_STD_LC</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* V4L2_STD_B|V4L2_STD_GH */</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">PHILIPS_MF_SET_STD_BG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TUNER_TEMIC_4046FM5</span>:
		<span class="o">*</span><span class="n">cb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">TEMIC_SET_PAL_BG</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">TEMIC_SET_PAL_I</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">TEMIC_SET_PAL_DK</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">TEMIC_SET_PAL_L</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FQ1216ME</span>:
		<span class="o">*</span><span class="n">cb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_BG</span><span class="o">|</span><span class="n">V4L2_STD_PAL_DK</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">PHILIPS_SET_PAL_BGDK</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">PHILIPS_SET_PAL_I</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="n">PHILIPS_SET_PAL_L</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FCV1236D</span>:
		<span class="cm">/* 0x00 -&gt; ATSC antenna input 1 */</span>
		<span class="cm">/* 0x01 -&gt; ATSC antenna input 2 */</span>
		<span class="cm">/* 0x02 -&gt; NTSC antenna input 1 */</span>
		<span class="cm">/* 0x03 -&gt; NTSC antenna input 2 */</span>
		<span class="o">*</span><span class="n">cb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_ATSC</span><span class="p">))</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TUNER_MICROTUNE_4042FI5</span>:
		<span class="cm">/* Set the charge pump for fast tuning */</span>
		<span class="o">*</span><span class="n">config</span> <span class="o">|=</span> <span class="n">TUNER_CHARGE_PUMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TUNER_PHILIPS_TUV1236D</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">tuner_i2c_props</span> <span class="n">i2c</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">;</span>
		<span class="cm">/* 0x40 -&gt; ATSC antenna input 1 */</span>
		<span class="cm">/* 0x48 -&gt; ATSC antenna input 2 */</span>
		<span class="cm">/* 0x00 -&gt; NTSC antenna input 1 */</span>
		<span class="cm">/* 0x08 -&gt; NTSC antenna input 2 */</span>
		<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
		<span class="o">*</span><span class="n">cb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_ATSC</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cb</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* set to the correct mode (analog or digital) */</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
			<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d &quot;</span>
				   <span class="s">&quot;(should be 2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
			<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d &quot;</span>
				   <span class="s">&quot;(should be 2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">])</span>
		<span class="n">simple_set_rf_input</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">atv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_set_aux_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">config</span><span class="p">,</span> <span class="n">u8</span> <span class="n">aux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x38</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;setting aux byte: 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d (should be 2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_post_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">div</span><span class="p">,</span> <span class="n">u8</span> <span class="n">config</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_LG_TDVS_H06XF</span>:
		<span class="n">simple_set_aux_byte</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FQ1216LME_MK3</span>:
		<span class="n">simple_set_aux_byte</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span> <span class="cm">/* External AGC */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_MICROTUNE_4042FI5</span>:
	<span class="p">{</span>
		<span class="cm">/* FIXME - this may also work for other tuners */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">status_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Wait until the PLL locks */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">status_byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o read error: rc == %d &quot;</span>
					   <span class="s">&quot;(should be 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status_byte</span> <span class="o">&amp;</span> <span class="n">TUNER_PLL_LOCKED</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Set the charge pump for optimized phase noise figure */</span>
		<span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TUNER_CHARGE_PUMP</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span>      <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;tv 0x%02x 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
			<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d &quot;</span>
				   <span class="s">&quot;(should be 4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_radio_bandswitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_TENA_9533_DI</span>:
	<span class="k">case</span> <span class="n">TUNER_YMEC_TVF_5533MF</span>:
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;This tuner doesn&#39;t have FM. &quot;</span>
			  <span class="s">&quot;Most cards have a TEA5767 for FM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1216ME_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1236_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FMD1216ME_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FMD1216MEX_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_LG_NTSC_TAPE</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1256_IH3</span>:
	<span class="k">case</span> <span class="n">TUNER_TCL_MF02GIP_5N</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1216MK5</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_TNF_5335MF</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_LG_PAL_FM</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_THOMSON_DTT761X</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x39</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FQ1216LME_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FQ1236_MK5</span>:
		<span class="n">tuner_err</span><span class="p">(</span><span class="s">&quot;This tuner doesn&#39;t have FM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Set the low band for sanity, since it covers 88-108 MHz */</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_MICROTUNE_4049FM5</span>:
	<span class="nl">default:</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_set_tv_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">,</span> <span class="n">cb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">IFPCoff</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">param_type</span> <span class="n">desired_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner_params</span> <span class="o">*</span><span class="n">t_params</span><span class="p">;</span>

	<span class="cm">/* IFPCoff = Video Intermediate Frequency - Vif:</span>
<span class="cm">		940  =16*58.75  NTSC/J (Japan)</span>
<span class="cm">		732  =16*45.75  M/N STD</span>
<span class="cm">		704  =16*44     ATSC (at DVB code)</span>
<span class="cm">		632  =16*39.50  I U.K.</span>
<span class="cm">		622.4=16*38.90  B/G D/K I, L STD</span>
<span class="cm">		592  =16*37.00  D China</span>
<span class="cm">		590  =16.36.875 B Australia</span>
<span class="cm">		543.2=16*33.95  L&#39; STD</span>
<span class="cm">		171.2=16*10.70  FM Radio (at set_radio_freq)</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IFPCoff</span>      <span class="o">=</span> <span class="mi">940</span><span class="p">;</span>
		<span class="n">desired_type</span> <span class="o">=</span> <span class="n">TUNER_PARAM_TYPE_NTSC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_MN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">V4L2_STD_MN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IFPCoff</span>      <span class="o">=</span> <span class="mi">732</span><span class="p">;</span>
		<span class="n">desired_type</span> <span class="o">=</span> <span class="n">TUNER_PARAM_TYPE_NTSC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IFPCoff</span>      <span class="o">=</span> <span class="mi">543</span><span class="p">;</span>
		<span class="n">desired_type</span> <span class="o">=</span> <span class="n">TUNER_PARAM_TYPE_SECAM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IFPCoff</span>      <span class="o">=</span> <span class="mi">623</span><span class="p">;</span>
		<span class="n">desired_type</span> <span class="o">=</span> <span class="n">TUNER_PARAM_TYPE_PAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t_params</span> <span class="o">=</span> <span class="n">simple_tuner_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">desired_type</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">simple_config_lookup</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">t_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="n">IFPCoff</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Freq= %d.%02d MHz, V_IF=%d.%02d MHz, &quot;</span>
		  <span class="s">&quot;Offset=%d.%02d MHz, div=%0d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span>
		  <span class="n">IFPCoff</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">IFPCoff</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span>
		  <span class="n">offset</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">offset</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="cm">/* tv norm specific stuff for multi-norm tuners */</span>
	<span class="n">simple_std_setup</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">cb_first_if_lower_freq</span> <span class="o">&amp;&amp;</span> <span class="n">div</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_div</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span>      <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span>      <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">has_tda9887</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_priv_tun_config</span> <span class="n">tda9887_cfg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tda_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">is_secam_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_SECAM_L</span> <span class="o">|</span>
						 <span class="n">V4L2_STD_SECAM_LC</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">V4L2_STD_SECAM_L</span> <span class="o">|</span>
					  <span class="n">V4L2_STD_SECAM_LC</span><span class="p">));</span>

		<span class="n">tda9887_cfg</span><span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">TUNER_TDA9887</span><span class="p">;</span>
		<span class="n">tda9887_cfg</span><span class="p">.</span><span class="n">priv</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda_config</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port1_active</span> <span class="o">^</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port1_invert_for_secam_lc</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_PORT1_ACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port2_active</span> <span class="o">^</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port2_invert_for_secam_lc</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_PORT2_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port1_active</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_PORT1_ACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port2_active</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_PORT2_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">intercarrier_mode</span><span class="p">)</span>
			<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_INTERCARRIER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_secam_l</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_secam_low</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_TOP</span><span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_secam_low</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_secam_mid</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_TOP</span><span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_secam_mid</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_secam_high</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_TOP</span><span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_secam_high</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_low</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_TOP</span><span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_low</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_mid</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_TOP</span><span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_mid</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_high</span><span class="p">)</span>
				<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_TOP</span><span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_top_high</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">default_pll_gating_18</span><span class="p">)</span>
			<span class="n">tda_config</span> <span class="o">|=</span> <span class="n">TDA9887_GATING_18</span><span class="p">;</span>
		<span class="n">i2c_clients_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span><span class="p">,</span> <span class="n">TUNER_SET_CONFIG</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">tda9887_cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;tv 0x%02x 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d (should be 4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">simple_post_tune</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">div</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_set_radio_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tunertype</span> <span class="o">*</span><span class="n">tun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner_params</span> <span class="o">*</span><span class="n">t_params</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>

	<span class="n">tun</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">TUNER_PARAM_TYPE_RADIO</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* default t_params (j=0) will be used if desired type wasn&#39;t found */</span>
	<span class="n">t_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

	<span class="cm">/* Select Radio 1st IF used */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">radio_if</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* 10.7 MHz */</span>
		<span class="n">freq</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="mf">10.7</span><span class="o">*</span><span class="mi">16000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 33.3 MHz */</span>
		<span class="n">freq</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="mf">33.3</span><span class="o">*</span><span class="mi">16000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* 41.3 MHz */</span>
		<span class="n">freq</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="mf">41.3</span><span class="o">*</span><span class="mi">16000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;Unsupported radio_if value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">radio_if</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TUNER_RATIO_MASK</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">TUNER_RATIO_SELECT_50</span><span class="p">;</span> <span class="cm">/* 50 kHz step */</span>

	<span class="cm">/* Bandswitch byte */</span>
	<span class="n">simple_radio_bandswitch</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Convert from 1/16 kHz V4L steps to 1/20 MHz (=50 kHz) PLL steps</span>
<span class="cm">	   freq * (1 Mhz / 16000 V4L steps) * (20 PLL steps / 1 MHz) =</span>
<span class="cm">	   freq * (1/800) */</span>
	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">+</span> <span class="mi">400</span><span class="p">)</span> <span class="o">/</span> <span class="mi">800</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">cb_first_if_lower_freq</span> <span class="o">&amp;&amp;</span> <span class="n">div</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_div</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span>      <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span>      <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;radio 0x%02x 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">has_tda9887</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_priv_tun_config</span> <span class="n">tda9887_cfg</span><span class="p">;</span>

		<span class="n">tda9887_cfg</span><span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">TUNER_TDA9887</span><span class="p">;</span>
		<span class="n">tda9887_cfg</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port1_active</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port1_fm_high_sensitivity</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">|=</span> <span class="n">TDA9887_PORT1_ACTIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port2_active</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">port2_fm_high_sensitivity</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">|=</span> <span class="n">TDA9887_PORT2_ACTIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">intercarrier_mode</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">|=</span> <span class="n">TDA9887_INTERCARRIER</span><span class="p">;</span>
<span class="cm">/*		if (t_params-&gt;port1_set_for_fm_mono)</span>
<span class="cm">			config &amp;= ~TDA9887_PORT1_ACTIVE;*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">fm_gain_normal</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">|=</span> <span class="n">TDA9887_GAIN_NORMAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_params</span><span class="o">-&gt;</span><span class="n">radio_if</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">|=</span> <span class="n">TDA9887_RIF_41_3</span><span class="p">;</span>
		<span class="n">i2c_clients_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span><span class="p">,</span> <span class="n">TUNER_SET_CONFIG</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">tda9887_cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d (should be 4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Write AUX byte */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FM1216ME_MK3</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x98</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* set TOP AGC */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
			<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d (should be 4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_RADIO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_set_radio_freq</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">*</span> <span class="mi">125</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_ANALOG_TV</span>:
	<span class="k">case</span> <span class="n">V4L2_TUNER_DIGITAL_TV</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_set_tv_freq</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">*</span> <span class="mi">62500</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">simple_set_dvb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="k">const</span> <span class="n">u32</span> <span class="n">delsys</span><span class="p">,</span>
			   <span class="k">const</span> <span class="n">u32</span> <span class="n">frequency</span><span class="p">,</span>
			   <span class="k">const</span> <span class="n">u32</span> <span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FMD1216ME_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FMD1216MEX_MK3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">==</span> <span class="mi">8000000</span> <span class="o">&amp;&amp;</span>
		    <span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mi">158870000</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_TD1316</span>:
		<span class="cm">/* determine band */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">161000000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
			  <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">444000000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* setup PLL filter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">==</span> <span class="mi">8000000</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_TUV1236D</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FCV1236D</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_rf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dtv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">])</span>
			<span class="n">new_rf</span> <span class="o">=</span> <span class="n">dtv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_B</span>:
				<span class="n">new_rf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SYS_ATSC</span>:
			<span class="nl">default:</span>
				<span class="n">new_rf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">simple_set_rf_input</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">new_rf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">simple_dvb_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u32</span> <span class="n">delsys</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This function returns the tuned frequency on success, 0 on error */</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tunertype</span> <span class="o">*</span><span class="n">tun</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">tuner_params</span> <span class="o">*</span><span class="n">t_params</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">,</span> <span class="n">cb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">/</span> <span class="mi">62500</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">stepsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* tuner-core was loaded before the digital tuner was</span>
<span class="cm">		 * configured and somehow picked the wrong tuner type */</span>
		<span class="n">tuner_err</span><span class="p">(</span><span class="s">&quot;attempt to treat tuner %d (%s) as digital tuner &quot;</span>
			  <span class="s">&quot;without stepsize defined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* failure */</span>
	<span class="p">}</span>

	<span class="n">t_params</span> <span class="o">=</span> <span class="n">simple_tuner_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">TUNER_PARAM_TYPE_DIGITAL</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_config_lookup</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">t_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frequency</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* failure */</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">((</span><span class="n">frequency</span> <span class="o">+</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">iffreq</span><span class="p">)</span> <span class="o">*</span> <span class="mi">62500</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span>
	       <span class="n">tun</span><span class="o">-&gt;</span><span class="n">stepsize</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">stepsize</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>

	<span class="n">simple_set_dvb</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">delsys</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;%s: div=%d | buf=0x%02x,0x%02x,0x%02x,0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tun</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="cm">/* calculate the frequency we set it to */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">div</span> <span class="o">*</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">stepsize</span><span class="p">)</span> <span class="o">-</span> <span class="n">t_params</span><span class="o">-&gt;</span><span class="n">iffreq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_dvb_calc_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delsys</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frequency</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">frequency</span> <span class="o">=</span> <span class="n">simple_dvb_configure</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">delsys</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_dvb_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delsys</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prev_freq</span><span class="p">,</span> <span class="n">prev_bw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">prev_freq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">prev_bw</span>   <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">;</span>

	<span class="n">frequency</span> <span class="o">=</span> <span class="n">simple_dvb_configure</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">delsys</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bw</span><span class="p">;</span>

	<span class="cm">/* put analog demod in standby when tuning digital */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">standby</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">standby</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* buf[0] contains the i2c address, but *</span>
<span class="cm">	 * we already have it in i2c_props.addr */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="cm">/* calc_regs sets frequency and bandwidth. if we failed, unset them */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">prev_freq</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">prev_bw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">initdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span>
					  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">initdata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">initdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">initdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">sleepdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span>
					  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">sleepdata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">sleepdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">sleepdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuner_simple_list_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">hybrid_tuner_release_state</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuner_simple_list_mutex</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_get_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_get_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">simple_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>              <span class="o">=</span> <span class="n">simple_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span>             <span class="o">=</span> <span class="n">simple_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_analog_params</span> <span class="o">=</span> <span class="n">simple_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_params</span>        <span class="o">=</span> <span class="n">simple_dvb_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_regs</span>         <span class="o">=</span> <span class="n">simple_dvb_calc_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>           <span class="o">=</span> <span class="n">simple_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frequency</span>     <span class="o">=</span> <span class="n">simple_get_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bandwidth</span>     <span class="o">=</span> <span class="n">simple_get_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span>        <span class="o">=</span> <span class="n">simple_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rf_strength</span>   <span class="o">=</span> <span class="n">simple_get_rf_strength</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">simple_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_simple_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">tuner_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: invalid tuner type: %d (max: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">tuner_count</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If i2c_adap is set, check that the tuner is at the correct address.</span>
<span class="cm">	 * Otherwise, if i2c_adap is NULL, the tuner will be programmed directly</span>
<span class="cm">	 * by the digital demod via calc_regs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_adap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c_addr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;tuner-simple %d-%04x: &quot;</span>
			       <span class="s">&quot;unable to probe %s, proceeding anyway.&quot;</span><span class="p">,</span>
			       <span class="n">i2c_adapter_id</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">),</span> <span class="n">i2c_addr</span><span class="p">,</span>
			       <span class="n">tuners</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuner_simple_list_mutex</span><span class="p">);</span>

	<span class="n">instance</span> <span class="o">=</span> <span class="n">hybrid_tuner_request_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">tuner_simple_priv</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span>
					      <span class="n">hybrid_tuner_instance_list</span><span class="p">,</span>
					      <span class="n">i2c_adap</span><span class="p">,</span> <span class="n">i2c_addr</span><span class="p">,</span>
					      <span class="s">&quot;tuner-simple&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuner_simple_list_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tuners</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span>   <span class="o">=</span> <span class="n">simple_devcount</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuner_simple_list_mutex</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">simple_tuner_ops</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_tuner_ops</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;couldn&#39;t set type to %d. Using %d (%s) instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">type</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;type set to %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">debug</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">atv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dtv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">atv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">])</span>
			<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;tuner %d atv rf input will be &quot;</span>
				   <span class="s">&quot;autoselected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;tuner %d atv rf input will be &quot;</span>
				   <span class="s">&quot;set to input %d (insmod option)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">atv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">dtv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">])</span>
			<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;tuner %d dtv rf input will be &quot;</span>
				   <span class="s">&quot;autoselected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;tuner %d dtv rf input will be &quot;</span>
				   <span class="s">&quot;set to input %d (insmod option)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">dtv_input</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Simple 4-control-bytes style tuner driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralph Metzler, Gerd Knorr, Gunther Mayer&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we follow Linus&#39;s tabbing style.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
