<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › common › tuners › tda9887.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tda9887.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &quot;tuner-i2c.h&quot;</span>
<span class="cp">#include &quot;tda9887.h&quot;</span>


<span class="cm">/* Chips:</span>
<span class="cm">   TDA9885 (PAL, NTSC)</span>
<span class="cm">   TDA9886 (PAL, SECAM, NTSC)</span>
<span class="cm">   TDA9887 (PAL, SECAM, NTSC, FM Radio)</span>

<span class="cm">   Used as part of several tuners</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable verbose debug messages&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">tda9887_list_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">hybrid_tuner_instance_list</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_i2c_props</span> <span class="n">i2c_props</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">hybrid_tuner_instance_list</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> 	   <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>       <span class="n">config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>       <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>       <span class="n">audmode</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span>        <span class="n">std</span><span class="p">;</span>

	<span class="n">bool</span>               <span class="n">standby</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="cp">#define UNSET       (-1U)</span>

<span class="k">struct</span> <span class="n">tvnorm</span> <span class="p">{</span>
	<span class="n">v4l2_std_id</span>       <span class="n">std</span><span class="p">;</span>
	<span class="kt">char</span>              <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>     <span class="n">b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>     <span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>     <span class="n">e</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>TDA defines</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>// first reg (b)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define cVideoTrapBypassOFF     0x00    </span><span class="c1">// bit b0</span>
<span class="cp">#define cVideoTrapBypassON      0x01    </span><span class="c1">// bit b0</span>

<span class="cp">#define cAutoMuteFmInactive     0x00    </span><span class="c1">// bit b1</span>
<span class="cp">#define cAutoMuteFmActive       0x02    </span><span class="c1">// bit b1</span>

<span class="cp">#define cIntercarrier           0x00    </span><span class="c1">// bit b2</span>
<span class="cp">#define cQSS                    0x04    </span><span class="c1">// bit b2</span>

<span class="cp">#define cPositiveAmTV           0x00    </span><span class="c1">// bit b3:4</span>
<span class="cp">#define cFmRadio                0x08    </span><span class="c1">// bit b3:4</span>
<span class="cp">#define cNegativeFmTV           0x10    </span><span class="c1">// bit b3:4</span>


<span class="cp">#define cForcedMuteAudioON      0x20    </span><span class="c1">// bit b5</span>
<span class="cp">#define cForcedMuteAudioOFF     0x00    </span><span class="c1">// bit b5</span>

<span class="cp">#define cOutputPort1Active      0x00    </span><span class="c1">// bit b6</span>
<span class="cp">#define cOutputPort1Inactive    0x40    </span><span class="c1">// bit b6</span>

<span class="cp">#define cOutputPort2Active      0x00    </span><span class="c1">// bit b7</span>
<span class="cp">#define cOutputPort2Inactive    0x80    </span><span class="c1">// bit b7</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>// second reg (c)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define cDeemphasisOFF          0x00    </span><span class="c1">// bit c5</span>
<span class="cp">#define cDeemphasisON           0x20    </span><span class="c1">// bit c5</span>

<span class="cp">#define cDeemphasis75           0x00    </span><span class="c1">// bit c6</span>
<span class="cp">#define cDeemphasis50           0x40    </span><span class="c1">// bit c6</span>

<span class="cp">#define cAudioGain0             0x00    </span><span class="c1">// bit c7</span>
<span class="cp">#define cAudioGain6             0x80    </span><span class="c1">// bit c7</span>

<span class="cp">#define cTopMask                0x1f    </span><span class="c1">// bit c0:4</span>
<span class="cp">#define cTopDefault		0x10 	</span><span class="c1">// bit c0:4</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>// third reg (e)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define cAudioIF_4_5             0x00    </span><span class="c1">// bit e0:1</span>
<span class="cp">#define cAudioIF_5_5             0x01    </span><span class="c1">// bit e0:1</span>
<span class="cp">#define cAudioIF_6_0             0x02    </span><span class="c1">// bit e0:1</span>
<span class="cp">#define cAudioIF_6_5             0x03    </span><span class="c1">// bit e0:1</span>


<span class="cp">#define cVideoIFMask		0x1c	</span><span class="c1">// bit e2:4</span>
<span class="cm">/* Video IF selection in TV Mode (bit B3=0) */</span>
<span class="cp">#define cVideoIF_58_75           0x00    </span><span class="c1">// bit e2:4</span>
<span class="cp">#define cVideoIF_45_75           0x04    </span><span class="c1">// bit e2:4</span>
<span class="cp">#define cVideoIF_38_90           0x08    </span><span class="c1">// bit e2:4</span>
<span class="cp">#define cVideoIF_38_00           0x0C    </span><span class="c1">// bit e2:4</span>
<span class="cp">#define cVideoIF_33_90           0x10    </span><span class="c1">// bit e2:4</span>
<span class="cp">#define cVideoIF_33_40           0x14    </span><span class="c1">// bit e2:4</span>
<span class="cp">#define cRadioIF_45_75           0x18    </span><span class="c1">// bit e2:4</span>
<span class="cp">#define cRadioIF_38_90           0x1C    </span><span class="c1">// bit e2:4</span>

<span class="cm">/* IF1 selection in Radio Mode (bit B3=1) */</span>
<span class="cp">#define cRadioIF_33_30		0x00	</span><span class="c1">// bit e2,4 (also 0x10,0x14)</span>
<span class="cp">#define cRadioIF_41_30		0x04	</span><span class="c1">// bit e2,4</span>

<span class="cm">/* Output of AFC pin in radio mode when bit E7=1 */</span>
<span class="cp">#define cRadioAGC_SIF		0x00	</span><span class="c1">// bit e3</span>
<span class="cp">#define cRadioAGC_FM		0x08	</span><span class="c1">// bit e3</span>

<span class="cp">#define cTunerGainNormal         0x00    </span><span class="c1">// bit e5</span>
<span class="cp">#define cTunerGainLow            0x20    </span><span class="c1">// bit e5</span>

<span class="cp">#define cGating_18               0x00    </span><span class="c1">// bit e6</span>
<span class="cp">#define cGating_36               0x40    </span><span class="c1">// bit e6</span>

<span class="cp">#define cAgcOutON                0x80    </span><span class="c1">// bit e7</span>
<span class="cp">#define cAgcOutOFF               0x00    </span><span class="c1">// bit e7</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">tvnorms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_H</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_N</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;PAL-BGHN&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
			   <span class="n">cDeemphasis50</span>  <span class="o">|</span>
			   <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>     <span class="o">|</span>
			   <span class="n">cAudioIF_5_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_38_90</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;PAL-I&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
			   <span class="n">cDeemphasis50</span>  <span class="o">|</span>
			   <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>     <span class="o">|</span>
			   <span class="n">cAudioIF_6_0</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_38_90</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;PAL-DK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
			   <span class="n">cDeemphasis50</span>  <span class="o">|</span>
			   <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>     <span class="o">|</span>
			   <span class="n">cAudioIF_6_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_38_90</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_PAL_M</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;PAL-M/Nc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
			   <span class="n">cDeemphasis75</span>  <span class="o">|</span>
			   <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>     <span class="o">|</span>
			   <span class="n">cAudioIF_4_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_45_75</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_SECAM_B</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_G</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_H</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;SECAM-BGH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cAudioIF_5_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_38_90</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;SECAM-L&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cPositiveAmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>	  <span class="o">|</span>
			   <span class="n">cAudioIF_6_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_38_90</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;SECAM-L&#39;&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cOutputPort2Inactive</span> <span class="o">|</span>
			   <span class="n">cPositiveAmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>	  <span class="o">|</span>
			   <span class="n">cAudioIF_6_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_33_90</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_SECAM_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;SECAM-DK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
			   <span class="n">cDeemphasis50</span>  <span class="o">|</span>
			   <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>     <span class="o">|</span>
			   <span class="n">cAudioIF_6_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_38_90</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M</span> <span class="o">|</span> <span class="n">V4L2_STD_NTSC_M_KR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;NTSC-M&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
			   <span class="n">cDeemphasis75</span>  <span class="o">|</span>
			   <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>     <span class="o">|</span>
			   <span class="n">cAudioIF_4_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_45_75</span> <span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">std</span>   <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;NTSC-M-JP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">b</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cNegativeFmTV</span>  <span class="o">|</span>
			   <span class="n">cQSS</span>           <span class="p">),</span>
		<span class="p">.</span><span class="n">c</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
			   <span class="n">cDeemphasis50</span>  <span class="o">|</span>
			   <span class="n">cTopDefault</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e</span>     <span class="o">=</span> <span class="p">(</span> <span class="n">cGating_36</span>     <span class="o">|</span>
			   <span class="n">cAudioIF_4_5</span>   <span class="o">|</span>
			   <span class="n">cVideoIF_58_75</span> <span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">radio_stereo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Radio Stereo&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">b</span>    <span class="o">=</span> <span class="p">(</span> <span class="n">cFmRadio</span>       <span class="o">|</span>
		  <span class="n">cQSS</span>           <span class="p">),</span>
	<span class="p">.</span><span class="n">c</span>    <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisOFF</span> <span class="o">|</span>
		  <span class="n">cAudioGain6</span>    <span class="o">|</span>
		  <span class="n">cTopDefault</span><span class="p">),</span>
	<span class="p">.</span><span class="n">e</span>    <span class="o">=</span> <span class="p">(</span> <span class="n">cTunerGainLow</span>  <span class="o">|</span>
		  <span class="n">cAudioIF_5_5</span>   <span class="o">|</span>
		  <span class="n">cRadioIF_38_90</span> <span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">radio_mono</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Radio Mono&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">b</span>    <span class="o">=</span> <span class="p">(</span> <span class="n">cFmRadio</span>       <span class="o">|</span>
		  <span class="n">cQSS</span>           <span class="p">),</span>
	<span class="p">.</span><span class="n">c</span>    <span class="o">=</span> <span class="p">(</span> <span class="n">cDeemphasisON</span>  <span class="o">|</span>
		  <span class="n">cDeemphasis75</span>  <span class="o">|</span>
		  <span class="n">cTopDefault</span><span class="p">),</span>
	<span class="p">.</span><span class="n">e</span>    <span class="o">=</span> <span class="p">(</span> <span class="n">cTunerGainLow</span>  <span class="o">|</span>
		  <span class="n">cAudioIF_5_5</span>   <span class="o">|</span>
		  <span class="n">cRadioIF_38_90</span> <span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_read_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">afc</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;- 12.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;- 37.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;- 62.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;- 87.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;-112.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;-137.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;-162.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;-187.5 kHz [min]&quot;</span><span class="p">,</span>
		<span class="s">&quot;+187.5 kHz [max]&quot;</span><span class="p">,</span>
		<span class="s">&quot;+162.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;+137.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;+112.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;+ 87.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;+ 62.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;+ 37.5 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;+ 12.5 kHz&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;read: 0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  after power on : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  afc            : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">afc</span><span class="p">[(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  fmif level     : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;high&quot;</span> <span class="o">:</span> <span class="s">&quot;low&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  afc window     : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  vfi level      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;high&quot;</span> <span class="o">:</span> <span class="s">&quot;low&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_write_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sound</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;AM/TV&quot;</span><span class="p">,</span>
		<span class="s">&quot;FM/radio&quot;</span><span class="p">,</span>
		<span class="s">&quot;FM/TV&quot;</span><span class="p">,</span>
		<span class="s">&quot;FM/radio&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">adjust</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;-16&quot;</span><span class="p">,</span> <span class="s">&quot;-15&quot;</span><span class="p">,</span> <span class="s">&quot;-14&quot;</span><span class="p">,</span> <span class="s">&quot;-13&quot;</span><span class="p">,</span> <span class="s">&quot;-12&quot;</span><span class="p">,</span> <span class="s">&quot;-11&quot;</span><span class="p">,</span> <span class="s">&quot;-10&quot;</span><span class="p">,</span> <span class="s">&quot;-9&quot;</span><span class="p">,</span>
		<span class="s">&quot;-8&quot;</span><span class="p">,</span>  <span class="s">&quot;-7&quot;</span><span class="p">,</span>  <span class="s">&quot;-6&quot;</span><span class="p">,</span>  <span class="s">&quot;-5&quot;</span><span class="p">,</span>  <span class="s">&quot;-4&quot;</span><span class="p">,</span>  <span class="s">&quot;-3&quot;</span><span class="p">,</span>  <span class="s">&quot;-2&quot;</span><span class="p">,</span>  <span class="s">&quot;-1&quot;</span><span class="p">,</span>
		<span class="s">&quot;0&quot;</span><span class="p">,</span>   <span class="s">&quot;+1&quot;</span><span class="p">,</span>  <span class="s">&quot;+2&quot;</span><span class="p">,</span>  <span class="s">&quot;+3&quot;</span><span class="p">,</span>  <span class="s">&quot;+4&quot;</span><span class="p">,</span>  <span class="s">&quot;+5&quot;</span><span class="p">,</span>  <span class="s">&quot;+6&quot;</span><span class="p">,</span>  <span class="s">&quot;+7&quot;</span><span class="p">,</span>
		<span class="s">&quot;+8&quot;</span><span class="p">,</span>  <span class="s">&quot;+9&quot;</span><span class="p">,</span>  <span class="s">&quot;+10&quot;</span><span class="p">,</span> <span class="s">&quot;+11&quot;</span><span class="p">,</span> <span class="s">&quot;+12&quot;</span><span class="p">,</span> <span class="s">&quot;+13&quot;</span><span class="p">,</span> <span class="s">&quot;+14&quot;</span><span class="p">,</span> <span class="s">&quot;+15&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">deemph</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="s">&quot;75&quot;</span><span class="p">,</span> <span class="s">&quot;50&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">carrier</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;4.5 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;5.5 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;6.0 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;6.5 MHz / AM&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vif</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;58.75 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;45.75 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;38.9 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;38.0 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;33.9 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;33.4 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;45.75 MHz + pin13&quot;</span><span class="p">,</span>
		<span class="s">&quot;38.9 MHz + pin13&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rif</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;44 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;52 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;52 MHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;44 MHz&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;write: byte B 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  B0   video mode      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;video trap&quot;</span> <span class="o">:</span> <span class="s">&quot;sound trap&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  B1   auto mute fm    : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  B2   carrier mode    : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;QSS&quot;</span> <span class="o">:</span> <span class="s">&quot;Intercarrier&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  B3-4 tv sound/radio  : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sound</span><span class="p">[(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  B5   force mute audio: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  B6   output port 1   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;high (inactive)&quot;</span> <span class="o">:</span> <span class="s">&quot;low (active)&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  B7   output port 2   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;high (inactive)&quot;</span> <span class="o">:</span> <span class="s">&quot;low (active)&quot;</span><span class="p">);</span>

	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;write: byte C 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  C0-4 top adjustment  : %s dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">adjust</span><span class="p">[</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  C5-6 de-emphasis     : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">deemph</span><span class="p">[(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  C7   audio gain      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;-6&quot;</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>

	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;write: byte E 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  E0-1 sound carrier   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">carrier</span><span class="p">[(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)]);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  E6   l pll gating   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;36&quot;</span> <span class="o">:</span> <span class="s">&quot;13&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* radio */</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  E2-4 video if        : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rif</span><span class="p">[(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  E7   vif agc output  : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			   <span class="o">?</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;fm-agc radio&quot;</span> <span class="o">:</span>
						<span class="s">&quot;sif-agc radio&quot;</span><span class="p">)</span>
			   <span class="o">:</span> <span class="s">&quot;fm radio carrier afc&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* video */</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  E2-4 video if        : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">vif</span><span class="p">[(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  E5   tuner gain      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			   <span class="o">?</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;external&quot;</span> <span class="o">:</span> <span class="s">&quot;normal&quot;</span><span class="p">)</span>
			   <span class="o">:</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;minimum&quot;</span>  <span class="o">:</span> <span class="s">&quot;normal&quot;</span><span class="p">));</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;  E7   vif agc output  : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="o">?</span> <span class="s">&quot;pin3 port, pin22 vif agc out&quot;</span>
				<span class="o">:</span> <span class="s">&quot;pin22 port, pin3 vif acg ext in&quot;</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;pin3+pin22 port&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9887_set_tvnorm</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvnorm</span> <span class="o">*</span><span class="n">norm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio_mono</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio_stereo</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tvnorms</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">tvnorms</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Unsupported tvnorm entry - audio muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;configure for: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port1</span>  <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port2</span>  <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qss</span>    <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adjust</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">port2</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qss</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">adjust</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9887_set_insmod</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">port1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port1</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cOutputPort1Inactive</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cOutputPort1Inactive</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">port2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port2</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cOutputPort2Inactive</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cOutputPort2Inactive</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">qss</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qss</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cQSS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cQSS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cTopMask</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">adjust</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9887_do_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_PORT1_ACTIVE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cOutputPort1Inactive</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_PORT1_INACTIVE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cOutputPort1Inactive</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_PORT2_ACTIVE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cOutputPort2Inactive</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_PORT2_INACTIVE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cOutputPort2Inactive</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_QSS</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cQSS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_INTERCARRIER</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cQSS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_AUTOMUTE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cAutoMuteFmActive</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_DEEMPHASIS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x60</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_DEEMPHASIS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TDA9887_DEEMPHASIS_NONE</span>:
			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cDeemphasisOFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TDA9887_DEEMPHASIS_50</span>:
			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cDeemphasisON</span> <span class="o">|</span> <span class="n">cDeemphasis50</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TDA9887_DEEMPHASIS_75</span>:
			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cDeemphasisON</span> <span class="o">|</span> <span class="n">cDeemphasis75</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_TOP_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cTopMask</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cTopMask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_INTERCARRIER_NTSC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cQSS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_GATING_18</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cGating_36</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_RIF_41_3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cVideoIFMask</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cRadioIF_41_30</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TDA9887_GAIN_NORMAL</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cTunerGainLow</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9887_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d (should be 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">dump_read_message</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9887_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="n">tda9887_set_tvnorm</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* A note on the port settings:</span>
<span class="cm">	   These settings tend to depend on the specifics of the board.</span>
<span class="cm">	   By default they are set to inactive (bit value 1) by this driver,</span>
<span class="cm">	   overwriting any changes made by the tvnorm. This means that it</span>
<span class="cm">	   is the responsibility of the module using the tda9887 to set</span>
<span class="cm">	   these values in case of changes in the tvnorm.</span>
<span class="cm">	   In many cases port 2 should be made active (0) when selecting</span>
<span class="cm">	   SECAM-L, and port 2 should remain inactive (1) for SECAM-L&#39;.</span>

<span class="cm">	   For the other standards the tda9887 application note says that</span>
<span class="cm">	   the ports should be set to active (0), but, again, that may</span>
<span class="cm">	   differ depending on the precise hardware configuration.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cOutputPort1Inactive</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cOutputPort2Inactive</span><span class="p">;</span>

	<span class="n">tda9887_do_config</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="n">tda9887_set_insmod</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cForcedMuteAudioON</span><span class="p">;</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;writing: b=0x%02x c=0x%02x e=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dump_write_message</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tuner_i2c_xfer_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="mi">4</span><span class="p">)))</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;i2c i/o error: rc == %d (should be 4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">tda9887_status</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9887_tuner_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Data bytes: b=0x%02x c=0x%02x e=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9887_get_afc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">AFC_BITS_2_kHz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="o">-</span><span class="mi">12500</span><span class="p">,</span>  <span class="o">-</span><span class="mi">37500</span><span class="p">,</span>  <span class="o">-</span><span class="mi">62500</span><span class="p">,</span>  <span class="o">-</span><span class="mi">97500</span><span class="p">,</span>
		<span class="o">-</span><span class="mi">112500</span><span class="p">,</span> <span class="o">-</span><span class="mi">137500</span><span class="p">,</span> <span class="o">-</span><span class="mi">162500</span><span class="p">,</span> <span class="o">-</span><span class="mi">187500</span><span class="p">,</span>
		<span class="mi">187500</span><span class="p">,</span>  <span class="mi">162500</span><span class="p">,</span>  <span class="mi">137500</span><span class="p">,</span>  <span class="mi">112500</span><span class="p">,</span>
		<span class="mi">97500</span> <span class="p">,</span>  <span class="mi">62500</span><span class="p">,</span>   <span class="mi">37500</span> <span class="p">,</span>  <span class="mi">12500</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">afc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">tuner_i2c_xfer_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">,</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">afc</span> <span class="o">=</span> <span class="n">AFC_BITS_2_kHz</span><span class="p">[(</span><span class="n">reg</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">afc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9887_standby</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">tda9887_configure</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9887_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span>    <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">std</span>     <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>
	<span class="n">tda9887_configure</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9887_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">priv_cfg</span><span class="p">;</span>
	<span class="n">tda9887_configure</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9887_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tda9887_list_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">hybrid_tuner_release_state</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tda9887_list_mutex</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="n">tda9887_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;tda9887&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">set_params</span>     <span class="o">=</span> <span class="n">tda9887_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">standby</span>        <span class="o">=</span> <span class="n">tda9887_standby</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_status</span>   <span class="o">=</span> <span class="n">tda9887_tuner_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_afc</span>        <span class="o">=</span> <span class="n">tda9887_get_afc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>        <span class="o">=</span> <span class="n">tda9887_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_config</span>     <span class="o">=</span> <span class="n">tda9887_set_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">tda9887_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda9887_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">instance</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tda9887_list_mutex</span><span class="p">);</span>

	<span class="n">instance</span> <span class="o">=</span> <span class="n">hybrid_tuner_request_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda9887_priv</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span>
					      <span class="n">hybrid_tuner_instance_list</span><span class="p">,</span>
					      <span class="n">i2c_adap</span><span class="p">,</span> <span class="n">i2c_addr</span><span class="p">,</span> <span class="s">&quot;tda9887&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tda9887_list_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;tda988[5/6/7] found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tda9887_list_mutex</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tda9887_ops</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">analog_demod_ops</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tda9887_attach</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we follow Linus&#39;s tabbing style.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
