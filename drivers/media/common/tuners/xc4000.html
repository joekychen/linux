<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › common › tuners › xc4000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>xc4000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for Xceive XC4000 &quot;QAM/8VSB single chip tuner&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2007 Xceive Corporation</span>
<span class="cm"> *  Copyright (c) 2007 Steven Toth &lt;stoth@linuxtv.org&gt;</span>
<span class="cm"> *  Copyright (c) 2009 Devin Heitmueller &lt;dheitmueller@kernellabs.com&gt;</span>
<span class="cm"> *  Copyright (c) 2009 Davide Ferri &lt;d.ferri@zero11.it&gt;</span>
<span class="cm"> *  Copyright (c) 2010 Istvan Varga &lt;istvan_v@mailbox.hu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dvb/frontend.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;xc4000.h&quot;</span>
<span class="cp">#include &quot;tuner-i2c.h&quot;</span>
<span class="cp">#include &quot;tuner-xc2028-types.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debugging level (0 to 2, default: 0 (off)).&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">no_poweroff</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_poweroff</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_poweroff</span><span class="p">,</span> <span class="s">&quot;Power management (1: disabled, 2: enabled, &quot;</span>
	<span class="s">&quot;0 (default): use device-specific default mode).&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">audio_std</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">audio_std</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">audio_std</span><span class="p">,</span> <span class="s">&quot;Audio standard. XC4000 audio decoder explicitly &quot;</span>
	<span class="s">&quot;needs to know what audio standard is needed for some video standards &quot;</span>
	<span class="s">&quot;with audio A2 or NICAM. The valid settings are a sum of:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot; 1: use NICAM/B or A2/B instead of NICAM/A or A2/A</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot; 2: use A2 instead of NICAM or BTSC</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot; 4: use SECAM/K3 instead of K1</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot; 8: use PAL-D/K audio for SECAM-D/K</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;16: use FM radio input 1 instead of input 2</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;32: use mono audio (the lower three bits are ignored)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">firmware_name</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">firmware_name</span><span class="p">,</span> <span class="n">firmware_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">firmware_name</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">firmware_name</span><span class="p">,</span> <span class="s">&quot;Firmware file name. Allows overriding the &quot;</span>
	<span class="s">&quot;default firmware name.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">xc4000_list_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">hybrid_tuner_instance_list</span><span class="p">);</span>

<span class="cp">#define dprintk(level, fmt, arg...) if (debug &gt;= level) \</span>
<span class="cp">	printk(KERN_INFO &quot;%s: &quot; fmt, &quot;xc4000&quot;, ## arg)</span>

<span class="cm">/* struct for storing firmware table */</span>
<span class="k">struct</span> <span class="n">firmware_description</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">type</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span>   <span class="n">id</span><span class="p">;</span>
	<span class="n">__u16</span>         <span class="n">int_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">firmware_properties</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">type</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span>	<span class="n">id</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span>	<span class="n">std_req</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">int_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">scode_table</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">scode_nr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner_i2c_props</span> <span class="n">i2c_props</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">hybrid_tuner_instance_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">firmware_description</span> <span class="o">*</span><span class="n">firm</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">firm_size</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">if_khz</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">freq_hz</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">bandwidth</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">video_standard</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rf_mode</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">default_pm</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">dvb_amplitude</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">set_smoothedcvbs</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">ignore_i2c_write_errors</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">firm_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">firmware_properties</span> <span class="n">cur_fw</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">hwmodel</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">hwvers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>	<span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define XC4000_AUDIO_STD_B		 1</span>
<span class="cp">#define XC4000_AUDIO_STD_A2		 2</span>
<span class="cp">#define XC4000_AUDIO_STD_K3		 4</span>
<span class="cp">#define XC4000_AUDIO_STD_L		 8</span>
<span class="cp">#define XC4000_AUDIO_STD_INPUT1		16</span>
<span class="cp">#define XC4000_AUDIO_STD_MONO		32</span>

<span class="cp">#define XC4000_DEFAULT_FIRMWARE &quot;dvb-fe-xc4000-1.4.fw&quot;</span>

<span class="cm">/* Misc Defines */</span>
<span class="cp">#define MAX_TV_STANDARD			24</span>
<span class="cp">#define XC_MAX_I2C_WRITE_LENGTH		64</span>
<span class="cp">#define XC_POWERED_DOWN			0x80000000U</span>

<span class="cm">/* Signal Types */</span>
<span class="cp">#define XC_RF_MODE_AIR			0</span>
<span class="cp">#define XC_RF_MODE_CABLE		1</span>

<span class="cm">/* Product id */</span>
<span class="cp">#define XC_PRODUCT_ID_FW_NOT_LOADED	0x2000</span>
<span class="cp">#define XC_PRODUCT_ID_XC4000		0x0FA0</span>
<span class="cp">#define XC_PRODUCT_ID_XC4100		0x1004</span>

<span class="cm">/* Registers (Write-only) */</span>
<span class="cp">#define XREG_INIT         0x00</span>
<span class="cp">#define XREG_VIDEO_MODE   0x01</span>
<span class="cp">#define XREG_AUDIO_MODE   0x02</span>
<span class="cp">#define XREG_RF_FREQ      0x03</span>
<span class="cp">#define XREG_D_CODE       0x04</span>
<span class="cp">#define XREG_DIRECTSITTING_MODE 0x05</span>
<span class="cp">#define XREG_SEEK_MODE    0x06</span>
<span class="cp">#define XREG_POWER_DOWN   0x08</span>
<span class="cp">#define XREG_SIGNALSOURCE 0x0A</span>
<span class="cp">#define XREG_SMOOTHEDCVBS 0x0E</span>
<span class="cp">#define XREG_AMPLITUDE    0x10</span>

<span class="cm">/* Registers (Read-only) */</span>
<span class="cp">#define XREG_ADC_ENV      0x00</span>
<span class="cp">#define XREG_QUALITY      0x01</span>
<span class="cp">#define XREG_FRAME_LINES  0x02</span>
<span class="cp">#define XREG_HSYNC_FREQ   0x03</span>
<span class="cp">#define XREG_LOCK         0x04</span>
<span class="cp">#define XREG_FREQ_ERROR   0x05</span>
<span class="cp">#define XREG_SNR          0x06</span>
<span class="cp">#define XREG_VERSION      0x07</span>
<span class="cp">#define XREG_PRODUCT_ID   0x08</span>
<span class="cp">#define XREG_SIGNAL_LEVEL 0x0A</span>
<span class="cp">#define XREG_NOISE_LEVEL  0x0B</span>

<span class="cm">/*</span>
<span class="cm">   Basic firmware description. This will remain with</span>
<span class="cm">   the driver for documentation purposes.</span>

<span class="cm">   This represents an I2C firmware file encoded as a</span>
<span class="cm">   string of unsigned char. Format is as follows:</span>

<span class="cm">   char[0  ]=len0_MSB  -&gt; len = len_MSB * 256 + len_LSB</span>
<span class="cm">   char[1  ]=len0_LSB  -&gt; length of first write transaction</span>
<span class="cm">   char[2  ]=data0 -&gt; first byte to be sent</span>
<span class="cm">   char[3  ]=data1</span>
<span class="cm">   char[4  ]=data2</span>
<span class="cm">   char[   ]=...</span>
<span class="cm">   char[M  ]=dataN  -&gt; last byte to be sent</span>
<span class="cm">   char[M+1]=len1_MSB  -&gt; len = len_MSB * 256 + len_LSB</span>
<span class="cm">   char[M+2]=len1_LSB  -&gt; length of second write transaction</span>
<span class="cm">   char[M+3]=data0</span>
<span class="cm">   char[M+4]=data1</span>
<span class="cm">   ...</span>
<span class="cm">   etc.</span>

<span class="cm">   The [len] value should be interpreted as follows:</span>

<span class="cm">   len= len_MSB _ len_LSB</span>
<span class="cm">   len=1111_1111_1111_1111   : End of I2C_SEQUENCE</span>
<span class="cm">   len=0000_0000_0000_0000   : Reset command: Do hardware reset</span>
<span class="cm">   len=0NNN_NNNN_NNNN_NNNN   : Normal transaction: number of bytes = {1:32767)</span>
<span class="cm">   len=1WWW_WWWW_WWWW_WWWW   : Wait command: wait for {1:32767} ms</span>

<span class="cm">   For the RESET and WAIT commands, the two following bytes will contain</span>
<span class="cm">   immediately the length of the following transaction.</span>
<span class="cm">*/</span>

<span class="k">struct</span> <span class="n">XC_TV_STANDARD</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">Name</span><span class="p">;</span>
	<span class="n">u16</span>	    <span class="n">audio_mode</span><span class="p">;</span>
	<span class="n">u16</span>	    <span class="n">video_mode</span><span class="p">;</span>
	<span class="n">u16</span>	    <span class="n">int_freq</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Tuner standards */</span>
<span class="cp">#define XC4000_MN_NTSC_PAL_BTSC		0</span>
<span class="cp">#define XC4000_MN_NTSC_PAL_A2		1</span>
<span class="cp">#define XC4000_MN_NTSC_PAL_EIAJ		2</span>
<span class="cp">#define XC4000_MN_NTSC_PAL_Mono		3</span>
<span class="cp">#define XC4000_BG_PAL_A2		4</span>
<span class="cp">#define XC4000_BG_PAL_NICAM		5</span>
<span class="cp">#define XC4000_BG_PAL_MONO		6</span>
<span class="cp">#define XC4000_I_PAL_NICAM		7</span>
<span class="cp">#define XC4000_I_PAL_NICAM_MONO		8</span>
<span class="cp">#define XC4000_DK_PAL_A2		9</span>
<span class="cp">#define XC4000_DK_PAL_NICAM		10</span>
<span class="cp">#define XC4000_DK_PAL_MONO		11</span>
<span class="cp">#define XC4000_DK_SECAM_A2DK1		12</span>
<span class="cp">#define XC4000_DK_SECAM_A2LDK3		13</span>
<span class="cp">#define XC4000_DK_SECAM_A2MONO		14</span>
<span class="cp">#define XC4000_DK_SECAM_NICAM		15</span>
<span class="cp">#define XC4000_L_SECAM_NICAM		16</span>
<span class="cp">#define XC4000_LC_SECAM_NICAM		17</span>
<span class="cp">#define XC4000_DTV6			18</span>
<span class="cp">#define XC4000_DTV8			19</span>
<span class="cp">#define XC4000_DTV7_8			20</span>
<span class="cp">#define XC4000_DTV7			21</span>
<span class="cp">#define XC4000_FM_Radio_INPUT2		22</span>
<span class="cp">#define XC4000_FM_Radio_INPUT1		23</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">XC_TV_STANDARD</span> <span class="n">xc4000_standard</span><span class="p">[</span><span class="n">MAX_TV_STANDARD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;M/N-NTSC/PAL-BTSC&quot;</span><span class="p">,</span>	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x80A0</span><span class="p">,</span> <span class="mi">4500</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;M/N-NTSC/PAL-A2&quot;</span><span class="p">,</span>	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x80A0</span><span class="p">,</span> <span class="mi">4600</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;M/N-NTSC/PAL-EIAJ&quot;</span><span class="p">,</span>	<span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x80A0</span><span class="p">,</span> <span class="mi">4500</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;M/N-NTSC/PAL-Mono&quot;</span><span class="p">,</span>	<span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x80A0</span><span class="p">,</span> <span class="mi">4500</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;B/G-PAL-A2&quot;</span><span class="p">,</span>		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8159</span><span class="p">,</span> <span class="mi">5640</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;B/G-PAL-NICAM&quot;</span><span class="p">,</span>	<span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x8159</span><span class="p">,</span> <span class="mi">5740</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;B/G-PAL-MONO&quot;</span><span class="p">,</span>	<span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x8159</span><span class="p">,</span> <span class="mi">5500</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;I-PAL-NICAM&quot;</span><span class="p">,</span>		<span class="mh">0x0080</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6240</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;I-PAL-NICAM-MONO&quot;</span><span class="p">,</span>	<span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6000</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;D/K-PAL-A2&quot;</span><span class="p">,</span>		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6380</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;D/K-PAL-NICAM&quot;</span><span class="p">,</span>	<span class="mh">0x0080</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6200</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;D/K-PAL-MONO&quot;</span><span class="p">,</span>	<span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6500</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;D/K-SECAM-A2 DK1&quot;</span><span class="p">,</span>	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6340</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;D/K-SECAM-A2 L/DK3&quot;</span><span class="p">,</span>	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6000</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;D/K-SECAM-A2 MONO&quot;</span><span class="p">,</span>	<span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6500</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;D/K-SECAM-NICAM&quot;</span><span class="p">,</span>	<span class="mh">0x0080</span><span class="p">,</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="mi">6200</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;L-SECAM-NICAM&quot;</span><span class="p">,</span>	<span class="mh">0x8080</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mi">6200</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;L&#39;-SECAM-NICAM&quot;</span><span class="p">,</span>	<span class="mh">0x8080</span><span class="p">,</span> <span class="mh">0x4009</span><span class="p">,</span> <span class="mi">6200</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DTV6&quot;</span><span class="p">,</span>		<span class="mh">0x00C0</span><span class="p">,</span> <span class="mh">0x8002</span><span class="p">,</span>    <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DTV8&quot;</span><span class="p">,</span>		<span class="mh">0x00C0</span><span class="p">,</span> <span class="mh">0x800B</span><span class="p">,</span>    <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DTV7/8&quot;</span><span class="p">,</span>		<span class="mh">0x00C0</span><span class="p">,</span> <span class="mh">0x801B</span><span class="p">,</span>    <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DTV7&quot;</span><span class="p">,</span>		<span class="mh">0x00C0</span><span class="p">,</span> <span class="mh">0x8007</span><span class="p">,</span>    <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;FM Radio-INPUT2&quot;</span><span class="p">,</span>	<span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x9800</span><span class="p">,</span> <span class="mi">10700</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;FM Radio-INPUT1&quot;</span><span class="p">,</span>	<span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x9000</span><span class="p">,</span> <span class="mi">10700</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xc4000_tuner_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">xc_debug_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_send_i2c_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			       <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ignore_i2c_write_errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: I2C write failed (len=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bytes %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_tuner_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(((</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">))</span> <span class="o">?</span>
					   <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">:</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">,</span>
					   <span class="n">DVB_FRONTEND_COMPONENT_TUNER</span><span class="p">,</span>
					   <span class="n">XC4000_TUNER_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: no tuner reset callback function, &quot;</span>
				<span class="s">&quot;fatal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">i2cData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regAddr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i2cData</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2cData</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">xc_send_i2c_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_load_i2c_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">i2c_sequence</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nbytes_to_send</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">XC_MAX_I2C_WRITE_LENGTH</span><span class="p">];</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i2c_sequence</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">i2c_sequence</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">i2c_sequence</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">i2c_sequence</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* RESET command */</span>
			<span class="cm">/* NOTE: this is ignored, as the reset callback was */</span>
			<span class="cm">/* already called by check_firmware() */</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* WAIT command */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Send i2c data whilst ensuring individual transactions</span>
<span class="cm">			 * do not exceed XC_MAX_I2C_WRITE_LENGTH bytes.</span>
<span class="cm">			 */</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_sequence</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_sequence</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">XC_MAX_I2C_WRITE_LENGTH</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">nbytes_to_send</span> <span class="o">=</span>
						<span class="n">XC_MAX_I2C_WRITE_LENGTH</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">nbytes_to_send</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbytes_to_send</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_sequence</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span>
						<span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">xc_send_i2c_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
					<span class="n">nbytes_to_send</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

				<span class="n">pos</span> <span class="o">+=</span> <span class="n">nbytes_to_send</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_set_tv_standard</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">video_mode</span><span class="p">,</span> <span class="n">u16</span> <span class="n">audio_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(0x%04x,0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">video_mode</span><span class="p">,</span> <span class="n">audio_mode</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() Standard = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">xc4000_standard</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span><span class="p">].</span><span class="n">Name</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t complain when the request fails because of i2c stretching */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ignore_i2c_write_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_VIDEO_MODE</span><span class="p">,</span> <span class="n">video_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_AUDIO_MODE</span><span class="p">,</span> <span class="n">audio_mode</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ignore_i2c_write_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_set_signal_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rf_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(%d) Source = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rf_mode</span><span class="p">,</span>
		<span class="n">rf_mode</span> <span class="o">==</span> <span class="n">XC_RF_MODE_AIR</span> <span class="o">?</span> <span class="s">&quot;ANTENNA&quot;</span> <span class="o">:</span> <span class="s">&quot;CABLE&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rf_mode</span> <span class="o">!=</span> <span class="n">XC_RF_MODE_AIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rf_mode</span> <span class="o">!=</span> <span class="n">XC_RF_MODE_CABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rf_mode</span> <span class="o">=</span> <span class="n">XC_RF_MODE_CABLE</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s(), Invalid mode, defaulting to CABLE&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_SIGNALSOURCE</span><span class="p">,</span> <span class="n">rf_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">xc4000_tuner_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_set_rf_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">freq_code</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">freq_hz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">freq_hz</span> <span class="o">&gt;</span> <span class="n">xc4000_tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">freq_hz</span> <span class="o">&lt;</span> <span class="n">xc4000_tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_min</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">freq_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">freq_hz</span> <span class="o">/</span> <span class="mi">15625</span><span class="p">);</span>

	<span class="cm">/* WAS: Starting in firmware version 1.1.44, Xceive recommends using the</span>
<span class="cm">	   FINERFREQ for all normal tuning (the doc indicates reg 0x03 should</span>
<span class="cm">	   only be used for fast scanning for channel lock) */</span>
	<span class="cm">/* WAS: XREG_FINERFREQ */</span>
	<span class="k">return</span> <span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_RF_FREQ</span><span class="p">,</span> <span class="n">freq_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_adc_envelope</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">adc_envelope</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_ADC_ENV</span><span class="p">,</span> <span class="n">adc_envelope</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_frequency_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">freq_error_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">regData</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_FREQ_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regData</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">regData</span> <span class="o">&amp;</span> <span class="mh">0xFFFFU</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mh">0x8000U</span> <span class="o">?</span> <span class="n">tmp</span> <span class="o">:</span> <span class="mh">0x10000U</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">freq_error_hz</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="mi">15625</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_lock_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">lock_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_LOCK</span><span class="p">,</span> <span class="n">lock_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">hw_majorversion</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hw_minorversion</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fw_majorversion</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fw_minorversion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">hw_majorversion</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">hw_minorversion</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fw_majorversion</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fw_minorversion</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_hsync_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hsync_freq_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">regData</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_HSYNC_FREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regData</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">hsync_freq_hz</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="n">regData</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">763</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_frame_lines</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">frame_lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_FRAME_LINES</span><span class="p">,</span> <span class="n">frame_lines</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_quality</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">quality</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_QUALITY</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_signal_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">signal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_SIGNAL_LEVEL</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_get_noise_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">noise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_NOISE_LEVEL</span><span class="p">,</span> <span class="n">noise</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">xc_wait_for_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">lock_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">watchdog_count</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">lock_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">watchdog_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xc_get_lock_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_state</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">watchdog_count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lock_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc_tune_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">result</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">freq_hz</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t complain when the request fails because of i2c stretching */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ignore_i2c_write_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">xc_set_rf_frequency</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">freq_hz</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ignore_i2c_write_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* wait for lock only in analog TV mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FM</span> <span class="o">|</span> <span class="n">DTV6</span> <span class="o">|</span> <span class="n">DTV7</span> <span class="o">|</span> <span class="n">DTV78</span> <span class="o">|</span> <span class="n">DTV8</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xc_wait_for_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for stats to stabilize.</span>
<span class="cm">	 * Frame Lines needs two frame times after initial lock</span>
<span class="cm">	 * before it is valid.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">debug</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">xc_debug_dump</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">bval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: I2C read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">bval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">bval</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define dump_firm_type(t)	dump_firm_type_and_int_freq(t, 0)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_firm_type_and_int_freq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">int_freq</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BASE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;BASE &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">INIT1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;INIT1 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">F8MHZ</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;F8MHZ &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">MTS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;MTS &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">D2620</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;D2620 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">D2633</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;D2633 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DTV6</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;DTV6 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">QAM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;QAM &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DTV7</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;DTV7 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DTV78</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;DTV78 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DTV8</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;DTV8 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">FM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;FM &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">INPUT1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;INPUT1 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">LCD</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;LCD &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">NOGD</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;NOGD &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">MONO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;MONO &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">ATSC</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;ATSC &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IF</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;IF &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">LG60</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;LG60 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">ATI638</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;ATI638 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">OREN538</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;OREN538 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">OREN36</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;OREN36 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">TOYOTA388</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;TOYOTA388 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">TOYOTA794</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;TOYOTA794 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DIBCOM52</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;DIBCOM52 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">ZARLINK456</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;ZARLINK456 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">CHINA</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;CHINA &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">F6MHZ</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;F6MHZ &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">INPUT2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;INPUT2 &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCODE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;SCODE &quot;</span><span class="p">);</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">HAS_IF</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;HAS_IF_%d &quot;</span><span class="p">,</span> <span class="n">int_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">seek_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			 <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">best_nr_diffs</span> <span class="o">=</span> <span class="mi">255U</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error! firmware not loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCODE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>

	<span class="cm">/* Seek for generic video standard match */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_std_id</span>	<span class="n">id_diff_mask</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">^</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">type_diff_mask</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">^</span> <span class="n">type</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="p">(</span><span class="n">BASE_TYPES</span> <span class="o">|</span> <span class="n">DTV_TYPES</span> <span class="o">|</span> <span class="n">LCD</span> <span class="o">|</span> <span class="n">NOGD</span> <span class="o">|</span> <span class="n">MONO</span> <span class="o">|</span> <span class="n">SCODE</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">nr_diffs</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type_diff_mask</span>
		    <span class="o">&amp;</span> <span class="p">(</span><span class="n">BASE</span> <span class="o">|</span> <span class="n">INIT1</span> <span class="o">|</span> <span class="n">FM</span> <span class="o">|</span> <span class="n">DTV6</span> <span class="o">|</span> <span class="n">DTV7</span> <span class="o">|</span> <span class="n">DTV78</span> <span class="o">|</span> <span class="n">DTV8</span> <span class="o">|</span> <span class="n">SCODE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">nr_diffs</span> <span class="o">=</span> <span class="n">hweight64</span><span class="p">(</span><span class="n">id_diff_mask</span><span class="p">)</span> <span class="o">+</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">type_diff_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_diffs</span><span class="p">)</span>	<span class="cm">/* Supports all the requested standards */</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nr_diffs</span> <span class="o">&lt;</span> <span class="n">best_nr_diffs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_nr_diffs</span> <span class="o">=</span> <span class="n">nr_diffs</span><span class="p">;</span>
			<span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: Would make sense to seek for type &quot;hint&quot; match ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best_i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">best_nr_diffs</span> <span class="o">&gt;</span> <span class="mi">0U</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Selecting best matching firmware (%u bits differ) for &quot;</span>
		       <span class="s">&quot;type=(%x), id %016llx:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">best_nr_diffs</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">id</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">best_i</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">found:</span>
	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>

<span class="nl">ret:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s firmware for type=&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Can&#39;t find&quot;</span> <span class="o">:</span> <span class="s">&quot;Found&quot;</span><span class="p">);</span>
		<span class="n">dump_firm_type</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(%x), id %016llx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			 <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span>                <span class="n">pos</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">seek_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t complain when the request fails because of i2c stretching */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ignore_i2c_write_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">xc_load_i2c_sequence</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ignore_i2c_write_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_fwupload</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span>   <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">n</span><span class="p">,</span> <span class="n">n_array</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="n">name</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span>	      <span class="o">*</span><span class="n">fname</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">firmware_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">firmware_name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">XC4000_DEFAULT_FIRMWARE</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reading firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c_props</span><span class="p">.</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error: firmware %s not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error %d while requesting firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rc</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">endp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error: firmware file %s has invalid size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fname</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_version</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">n_array</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Loading %d firmware images from %s, type: %s, ver %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">n_array</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_version</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">n_array</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Not enough memory to load firmware file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_size</span> <span class="o">=</span> <span class="n">n_array</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">endp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">type</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">v4l2_std_id</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">__u16</span> <span class="n">int_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">n_array</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;More firmware images in file than &quot;</span>
			       <span class="s">&quot;were expected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Checks if there&#39;s enough bytes to read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">endp</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">header</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

		<span class="n">id</span> <span class="o">=</span> <span class="n">get_unaligned_le64</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">HAS_IF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">int_freq</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">int_freq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">endp</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">header</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">endp</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Firmware type (%x), id %llx is corrupted (size=%d, expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">id</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">endp</span> <span class="o">-</span> <span class="n">p</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Not enough memory to load firmware file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Reading firmware type &quot;</span><span class="p">);</span>
			<span class="n">dump_firm_type_and_int_freq</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">int_freq</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(%x), id %llx, size=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">ptr</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">id</span>   <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">int_freq</span> <span class="o">=</span> <span class="n">int_freq</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Firmware file is incomplete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">header:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Firmware header is incomplete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">corrupt:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error: firmware file is corrupted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Firmware files loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_scode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			 <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">int_freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pos</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">scode_buf</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">u8</span>		<span class="n">indirect_mode</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s called int_freq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">int_freq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">seek_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_size</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">int_freq</span> <span class="o">==</span> <span class="n">int_freq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">HAS_IF</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">scode</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">scode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Loading SCODE for type=&quot;</span><span class="p">);</span>
		<span class="n">dump_firm_type_and_int_freq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">int_freq</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;(%x), id %016llx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scode_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scode_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* Enter direct-mode */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_DIRECTSITTING_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to put device into direct mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">xc_send_i2c_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">scode_buf</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Even if the send failed, make sure we set back to indirect</span>
<span class="cm">		   mode */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to set scode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Switch back to indirect-mode */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">indirect_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">indirect_mode</span><span class="p">));</span>
	<span class="n">indirect_mode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="n">xc_send_i2c_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">indirect_mode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">indirect_mode</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			  <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">int_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span>         <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">firmware_properties</span> <span class="n">new_fw</span><span class="p">;</span>
	<span class="kt">int</span>			   <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>			   <span class="n">hwmodel</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span>		   <span class="n">std0</span><span class="p">;</span>
	<span class="n">u8</span>			   <span class="n">hw_major</span><span class="p">,</span> <span class="n">hw_minor</span><span class="p">,</span> <span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">xc4000_fwupload</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">retry:</span>
	<span class="n">new_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">new_fw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">std</span><span class="p">;</span>
	<span class="n">new_fw</span><span class="p">.</span><span class="n">std_req</span> <span class="o">=</span> <span class="n">std</span><span class="p">;</span>
	<span class="n">new_fw</span><span class="p">.</span><span class="n">scode_table</span> <span class="o">=</span> <span class="n">SCODE</span><span class="p">;</span>
	<span class="n">new_fw</span><span class="p">.</span><span class="n">scode_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new_fw</span><span class="p">.</span><span class="n">int_freq</span> <span class="o">=</span> <span class="n">int_freq</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;checking firmware, user requested type=&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_firm_type</span><span class="p">(</span><span class="n">new_fw</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;(%x), id %016llx, &quot;</span><span class="p">,</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_fw</span><span class="p">.</span><span class="n">std_req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_freq</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;scode_tbl &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;int_freq %d, &quot;</span><span class="p">,</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">int_freq</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;scode_nr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">scode_nr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* No need to reload base firmware if it matches */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;BASE firmware not changed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_base</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Updating BASE - forget about all currently loaded firmware */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">));</span>

	<span class="cm">/* Reset is needed before loading firmware */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">xc4000_tuner_reset</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* BASE firmwares are all std0 */</span>
	<span class="n">std0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">std0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error %d while loading base firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load INIT1, if needed */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Load init1 firmware, if exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">BASE</span> <span class="o">|</span> <span class="n">INIT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">std0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">load_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">BASE</span> <span class="o">|</span> <span class="n">INIT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">std0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_err</span><span class="p">(</span><span class="s">&quot;Error %d while loading init1 firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">skip_base:</span>
	<span class="cm">/*</span>
<span class="cm">	 * No need to reload standard specific firmware if base firmware</span>
<span class="cm">	 * was not reloaded and requested video standards have not changed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="p">(</span><span class="n">BASE</span> <span class="o">|</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">std_req</span> <span class="o">==</span> <span class="n">std</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Std-specific firmware already loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_std_specific</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reloading std-specific firmware forces a SCODE update */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">scode_table</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Load the standard firmware */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_fw</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

<span class="nl">skip_std_specific:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">scode_table</span> <span class="o">==</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">scode_table</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">scode_nr</span> <span class="o">==</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">scode_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SCODE firmware already loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">check_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load SCODE firmware, if exists */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_scode</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">|</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">scode_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_fw</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">new_fw</span><span class="p">.</span><span class="n">int_freq</span><span class="p">,</span> <span class="n">new_fw</span><span class="p">.</span><span class="n">scode_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;load scode failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

<span class="nl">check_device:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_PRODUCT_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwmodel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xc_get_version</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_major</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_minor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_major</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">fw_minor</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to read tuner registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Device is Xceive %d version %d.%d, &quot;</span>
		<span class="s">&quot;firmware version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hwmodel</span><span class="p">,</span> <span class="n">hw_major</span><span class="p">,</span> <span class="n">hw_minor</span><span class="p">,</span> <span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">);</span>

	<span class="cm">/* Check firmware version against what we downloaded. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_version</span> <span class="o">!=</span> <span class="p">((</span><span class="n">fw_major</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">fw_minor</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Incorrect readback of firmware version %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check that the tuner hardware model remains consistent over time. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwmodel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hwmodel</span> <span class="o">==</span> <span class="n">XC_PRODUCT_ID_XC4000</span> <span class="o">||</span>
	     <span class="n">hwmodel</span> <span class="o">==</span> <span class="n">XC_PRODUCT_ID_XC4100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwmodel</span> <span class="o">=</span> <span class="n">hwmodel</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwvers</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw_major</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw_minor</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwmodel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwmodel</span> <span class="o">!=</span> <span class="n">hwmodel</span> <span class="o">||</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwvers</span> <span class="o">!=</span> <span class="p">((</span><span class="n">hw_major</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw_minor</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Read invalid device hardware information - tuner &quot;</span>
		       <span class="s">&quot;hung?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_fw</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * By setting BASE in cur_fw.type only after successfully loading all</span>
<span class="cm">	 * firmwares, we can:</span>
<span class="cm">	 * 1. Identify that BASE firmware with type=0 has been loaded;</span>
<span class="cm">	 * 2. Tell whether BASE firmware was just changed the next time through.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">|=</span> <span class="n">BASE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_retry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">is_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Retrying firmware load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xc_debug_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">adc_envelope</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">freq_error_hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">lock_status</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hsync_freq_hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">frame_lines</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">quality</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">hw_majorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hw_minorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">fw_majorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fw_minorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xc_get_adc_envelope</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adc_envelope</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** ADC envelope (0-1023) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adc_envelope</span><span class="p">);</span>

	<span class="n">xc_get_frequency_error</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq_error_hz</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** Frequency error = %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq_error_hz</span><span class="p">);</span>

	<span class="n">xc_get_lock_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock_status</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** Lock status (0-Wait, 1-Locked, 2-No-signal) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lock_status</span><span class="p">);</span>

	<span class="n">xc_get_version</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_majorversion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_minorversion</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">fw_majorversion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_minorversion</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** HW: V%02x.%02x, FW: V%02x.%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hw_majorversion</span><span class="p">,</span> <span class="n">hw_minorversion</span><span class="p">,</span>
		<span class="n">fw_majorversion</span><span class="p">,</span> <span class="n">fw_minorversion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">&lt;</span> <span class="n">XC4000_DTV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xc_get_hsync_freq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsync_freq_hz</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** Horizontal sync frequency = %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hsync_freq_hz</span><span class="p">);</span>

		<span class="n">xc_get_frame_lines</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame_lines</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** Frame lines = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frame_lines</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xc_get_quality</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quality</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** Quality (0:&lt;8dB, 7:&gt;56dB) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>

	<span class="n">xc_get_signal_level</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">signal</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** Signal level = -%ddB (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signal</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>

	<span class="n">xc_get_noise_level</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">noise</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;*** Noise level = %ddB (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">noise</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">noise</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delsys</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() frequency=%d (Hz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_ATSC</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() VSB modulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span> <span class="o">=</span> <span class="n">XC_RF_MODE_AIR</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">1750000</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DTV6</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">DTV6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_B</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() QAM modulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span> <span class="o">=</span> <span class="n">XC_RF_MODE_CABLE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">1750000</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DTV6</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">DTV6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBT</span>:
	<span class="k">case</span> <span class="n">SYS_DVBT2</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() OFDM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">400000000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">2250000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">2750000</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DTV7_8</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">DTV78</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">&lt;=</span> <span class="mi">6000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DTV6</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">1750000</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">DTV6</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DTV7</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">2250000</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">DTV7</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DTV8</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">2750000</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">DTV8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span> <span class="o">=</span> <span class="n">XC_RF_MODE_AIR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000 delivery system not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() frequency=%d (compensated)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span><span class="p">);</span>

	<span class="cm">/* Make sure the correct firmware type is loaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">if_khz</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xc_set_signal_source</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: xc_set_signal_source(%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span>	<span class="n">video_mode</span><span class="p">,</span> <span class="n">audio_mode</span><span class="p">;</span>
		<span class="n">video_mode</span> <span class="o">=</span> <span class="n">xc4000_standard</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span><span class="p">].</span><span class="n">video_mode</span><span class="p">;</span>
		<span class="n">audio_mode</span> <span class="o">=</span> <span class="n">xc4000_standard</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span><span class="p">].</span><span class="n">audio_mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DTV6</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_version</span> <span class="o">!=</span> <span class="mh">0x0102</span><span class="p">)</span>
			<span class="n">video_mode</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xc_set_tv_standard</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">video_mode</span><span class="p">,</span> <span class="n">audio_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: xc_set_tv_standard failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* DJH - do not return when it fails... */</span>
			<span class="cm">/* goto fail; */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_D_CODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dvb_amplitude</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_AMPLITUDE</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_version</span> <span class="o">!=</span> <span class="mh">0x0102</span> <span class="o">||</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dvb_amplitude</span> <span class="o">!=</span> <span class="mi">134</span> <span class="o">?</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dvb_amplitude</span> <span class="o">:</span> <span class="mi">132</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">set_smoothedcvbs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_SMOOTHEDCVBS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: setting registers failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* goto fail; */</span>
	<span class="p">}</span>

	<span class="n">xc_tune_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_set_analog_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() frequency=%d (in units of 62.5Hz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">*</span> <span class="mi">125L</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_INPUT1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_FM_Radio_INPUT1</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">FM</span> <span class="o">|</span> <span class="n">INPUT1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_FM_Radio_INPUT2</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">FM</span> <span class="o">|</span> <span class="n">INPUT2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() frequency=%d (in units of 62.5khz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* params-&gt;frequency is in units of 62.5khz */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">*</span> <span class="mi">62500</span><span class="p">;</span>

	<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>
	<span class="cm">/* if std is not defined, choose one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">)</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_MONO</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">MONO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_MN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_MN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_MONO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_MN_NTSC_PAL_Mono</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_A2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_A2</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_MN_NTSC_PAL_A2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_BTSC</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_MN_NTSC_PAL_BTSC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_MONO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_BG_PAL_MONO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_A2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_B</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_NICAM_A</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_BG_PAL_NICAM</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_NICAM_B</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_BG_PAL_NICAM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_B</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_A2_A</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_BG_PAL_A2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_A2_B</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_BG_PAL_A2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* default to NICAM audio standard */</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span> <span class="o">|</span> <span class="n">V4L2_STD_NICAM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_MONO</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_I_PAL_NICAM_MONO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_I_PAL_NICAM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_MONO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DK_PAL_MONO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_A2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_A2</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DK_PAL_A2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_NICAM</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DK_PAL_NICAM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_DK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* default to A2 audio standard */</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_DK</span> <span class="o">|</span> <span class="n">V4L2_STD_A2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_L</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DK_SECAM_NICAM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_MONO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DK_SECAM_A2MONO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_K3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">|=</span> <span class="n">V4L2_STD_SECAM_K3</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DK_SECAM_A2LDK3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_DK_SECAM_A2DK1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* default to NICAM audio standard */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span> <span class="o">|</span> <span class="n">V4L2_STD_NICAM</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_L_SECAM_NICAM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* default to NICAM audio standard */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_LC</span> <span class="o">|</span> <span class="n">V4L2_STD_NICAM</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">=</span> <span class="n">XC4000_LC_SECAM_NICAM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">tune_channel</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">tune_channel:</span>
	<span class="cm">/* FIXME: it could be air. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span> <span class="o">=</span> <span class="n">XC_RF_MODE_CABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span>
			   <span class="n">xc4000_standard</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span><span class="p">].</span><span class="n">int_freq</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xc_set_signal_source</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;xc4000: xc_set_signal_source(%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_mode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span>	<span class="n">video_mode</span><span class="p">,</span> <span class="n">audio_mode</span><span class="p">;</span>
		<span class="n">video_mode</span> <span class="o">=</span> <span class="n">xc4000_standard</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span><span class="p">].</span><span class="n">video_mode</span><span class="p">;</span>
		<span class="n">audio_mode</span> <span class="o">=</span> <span class="n">xc4000_standard</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span><span class="p">].</span><span class="n">audio_mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">&lt;</span> <span class="n">XC4000_BG_PAL_A2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">NOGD</span><span class="p">)</span>
				<span class="n">video_mode</span> <span class="o">&amp;=</span> <span class="mh">0xFF7F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">&lt;</span> <span class="n">XC4000_I_PAL_NICAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firm_version</span> <span class="o">==</span> <span class="mh">0x0102</span><span class="p">)</span>
				<span class="n">video_mode</span> <span class="o">&amp;=</span> <span class="mh">0xFEFF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_std</span> <span class="o">&amp;</span> <span class="n">XC4000_AUDIO_STD_B</span><span class="p">)</span>
				<span class="n">video_mode</span> <span class="o">|=</span> <span class="mh">0x0080</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xc_set_tv_standard</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">video_mode</span><span class="p">,</span> <span class="n">audio_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: xc_set_tv_standard failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_D_CODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_AMPLITUDE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">set_smoothedcvbs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_SMOOTHEDCVBS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc4000: setting registers failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xc_tune_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_get_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_SIGNAL_LEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Informations from real testing of DVB-T and radio part,</span>
<span class="cm">	   coeficient for one dB is 0xff.</span>
<span class="cm">	 */</span>
	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Signal strength: -%ddB (%05d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* all known digital modes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">==</span> <span class="n">XC4000_DTV6</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">==</span> <span class="n">XC4000_DTV7</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">==</span> <span class="n">XC4000_DTV7_8</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">video_standard</span> <span class="o">==</span> <span class="n">XC4000_DTV8</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">digital</span><span class="p">;</span>

	<span class="cm">/* Analog mode has NOISE LEVEL important, signal</span>
<span class="cm">	   depends only on gain of antenna and amplifiers,</span>
<span class="cm">	   but it doesn&#39;t tell anything about real quality</span>
<span class="cm">	   of reception.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_NOISE_LEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Noise level: %ddB (%05d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* highest noise level: 32dB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">~</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Digital mode has SIGNAL LEVEL important and real</span>
<span class="cm">	   noise level is stored in demodulator registers.</span>
<span class="cm">	 */</span>
<span class="nl">digital:</span>
	<span class="cm">/* best signal: -50dB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mh">0x3200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="cm">/* minimum: -114dB - should be 0x7200 but real zero is 0x713A */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mh">0x713A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mh">0x3200</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">ret:</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_get_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">freq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">freq_hz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span>
		     <span class="o">&amp;</span> <span class="p">(</span><span class="n">BASE</span> <span class="o">|</span> <span class="n">FM</span> <span class="o">|</span> <span class="n">DTV6</span> <span class="o">|</span> <span class="n">DTV7</span> <span class="o">|</span> <span class="n">DTV78</span> <span class="o">|</span> <span class="n">DTV8</span><span class="p">))</span> <span class="o">==</span> <span class="n">BASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span>	<span class="n">snr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_SNR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() freq = %u, SNR = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">freq</span><span class="p">,</span> <span class="n">snr</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_get_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">lock_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BASE</span><span class="p">)</span>
		<span class="n">xc_get_lock_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock_status</span><span class="p">);</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">lock_status</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
		   <span class="n">TUNER_STATUS_LOCKED</span> <span class="o">|</span> <span class="n">TUNER_STATUS_STEREO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DTV6</span> <span class="o">|</span> <span class="n">DTV7</span> <span class="o">|</span> <span class="n">DTV78</span> <span class="o">|</span> <span class="n">DTV8</span><span class="p">))</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TUNER_STATUS_STEREO</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s() lock_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lock_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Avoid firmware reload on slow devices */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">no_poweroff</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">no_poweroff</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_pm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BASE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* force reset and firmware reload */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XC_POWERED_DOWN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xc_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_POWER_DOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;xc4000: %s() unable to shutdown tuner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xc4000_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xc4000_list_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">hybrid_tuner_release_state</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xc4000_list_mutex</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">xc4000_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;Xceive XC4000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>  <span class="o">=</span>    <span class="mi">1000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span>  <span class="o">=</span> <span class="mi">1023000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_step</span> <span class="o">=</span>      <span class="mi">50000</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span>	   <span class="o">=</span> <span class="n">xc4000_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		   <span class="o">=</span> <span class="n">xc4000_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span>		   <span class="o">=</span> <span class="n">xc4000_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_params</span>	   <span class="o">=</span> <span class="n">xc4000_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_analog_params</span> <span class="o">=</span> <span class="n">xc4000_set_analog_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frequency</span>	   <span class="o">=</span> <span class="n">xc4000_get_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rf_strength</span>   <span class="o">=</span> <span class="n">xc4000_get_signal</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bandwidth</span>	   <span class="o">=</span> <span class="n">xc4000_get_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span>	   <span class="o">=</span> <span class="n">xc4000_get_status</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">xc4000_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">xc4000_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xc4000_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">instance</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(%d-%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">i2c</span> <span class="o">?</span> <span class="n">i2c_adapter_id</span><span class="p">(</span><span class="n">i2c</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">cfg</span> <span class="o">?</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2c_address</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xc4000_list_mutex</span><span class="p">);</span>

	<span class="n">instance</span> <span class="o">=</span> <span class="n">hybrid_tuner_request_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">xc4000_priv</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span>
					      <span class="n">hybrid_tuner_instance_list</span><span class="p">,</span>
					      <span class="n">i2c</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2c_address</span><span class="p">,</span> <span class="s">&quot;xc4000&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* new tuner instance */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
		<span class="cm">/* set default configuration */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">if_khz</span> <span class="o">=</span> <span class="mi">4560</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_pm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dvb_amplitude</span> <span class="o">=</span> <span class="mi">134</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">set_smoothedcvbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* existing tuner instance */</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">if_khz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* copy configuration if provided by the caller */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">if_khz</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">if_khz</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_pm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">default_pm</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dvb_amplitude</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dvb_amplitude</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">set_smoothedcvbs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">set_smoothedcvbs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if firmware has been loaded. It is possible that another</span>
<span class="cm">	   instance of the driver has loaded the firmware.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xc4000_readreg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">XREG_PRODUCT_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_fw</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">BASE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwmodel</span> <span class="o">:</span> <span class="n">XC_PRODUCT_ID_FW_NOT_LOADED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XC_PRODUCT_ID_XC4000</span>:
	<span class="k">case</span> <span class="n">XC_PRODUCT_ID_XC4100</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;xc4000: Successfully identified at address 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2c_address</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;xc4000: Firmware has been loaded previously</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XC_PRODUCT_ID_FW_NOT_LOADED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;xc4000: Successfully identified at address 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2c_address</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;xc4000: Firmware has not been loaded previously</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;xc4000: Device not found at addr 0x%02x (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2c_address</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xc4000_list_mutex</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xc4000_tuner_ops</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_tuner_ops</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xc4000_fwupload</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xc4000_list_mutex</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">xc4000_release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">xc4000_attach</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steven Toth, Davide Ferri&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Xceive xc4000 silicon tuner driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
