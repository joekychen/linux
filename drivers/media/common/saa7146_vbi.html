<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › common › saa7146_vbi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>saa7146_vbi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;media/saa7146_vv.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vbi_pixel_to_capture</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vbi_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>

	<span class="n">u32</span>          <span class="o">*</span><span class="n">cpu</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>   <span class="n">dma_addr</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* once again, a bug in the saa7146: the brs acquisition</span>
<span class="cm">	   is buggy and especially the BXO-counter does not work</span>
<span class="cm">	   as specified. there is this workaround, but please</span>
<span class="cm">	   don&#39;t let me explain it. ;-) */</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* setup some basic programming, just for the workaround */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_EVEN3</span><span class="p">,</span>	<span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_ODD3</span><span class="p">,</span>	<span class="n">dma_addr</span><span class="o">+</span><span class="n">vbi_pixel_to_capture</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PROT_ADDR3</span><span class="p">,</span>	<span class="n">dma_addr</span><span class="o">+</span><span class="mi">4096</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PITCH3</span><span class="p">,</span>	<span class="n">vbi_pixel_to_capture</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_PAGE3</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NUM_LINE_BYTE3</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">((</span><span class="n">vbi_pixel_to_capture</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="n">MASK_04</span><span class="o">|</span><span class="n">MASK_20</span><span class="p">);</span>

	<span class="cm">/* load brs-control register */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BRS_CTRL</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="cm">/* BXO = 1h, BRS to outbound */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="mh">0xc000008c</span><span class="p">);</span>
	<span class="cm">/* wait for vbi_a or vbi_b*/</span>
	<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SAA7146_USE_PORT_B_FOR_VBI</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_vv_data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEB_D</span><span class="p">(</span><span class="s">&quot;...using port b</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">CMD_OAN</span> <span class="o">|</span> <span class="n">CMD_SIG1</span> <span class="o">|</span> <span class="n">CMD_E_FID_B</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">CMD_OAN</span> <span class="o">|</span> <span class="n">CMD_SIG1</span> <span class="o">|</span> <span class="n">CMD_O_FID_B</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">		WRITE_RPS1(CMD_PAUSE | MASK_09);</span>
<span class="cm">*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEB_D</span><span class="p">(</span><span class="s">&quot;...using port a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">MASK_10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* upload brs */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_UPLOAD</span> <span class="o">|</span> <span class="n">MASK_08</span><span class="p">);</span>
	<span class="cm">/* load brs-control register */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BRS_CTRL</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="cm">/* BYO = 1, BXO = NQBIL (=1728 for PAL, for NTSC this is 858*2) - NumByte3 (=1440) = 288 */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(((</span><span class="mi">1728</span><span class="o">-</span><span class="p">(</span><span class="n">vbi_pixel_to_capture</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">MASK_19</span><span class="p">);</span>
	<span class="cm">/* wait for brs_done */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">MASK_08</span><span class="p">);</span>
	<span class="cm">/* upload brs */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_UPLOAD</span> <span class="o">|</span> <span class="n">MASK_08</span><span class="p">);</span>
	<span class="cm">/* load video-dma3 NumLines3 and NumBytes3 */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">NUM_LINE_BYTE3</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="cm">/* dev-&gt;vbi_count*2 lines, 720 pixel (= 1440 Bytes) */</span>
	<span class="n">WRITE_RPS1</span><span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vbi_pixel_to_capture</span><span class="p">));</span>
	<span class="cm">/* load brs-control register */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BRS_CTRL</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="cm">/* Set BRS right: note: this is an experimental value for BXO (=&gt; PAL!) */</span>
	<span class="n">WRITE_RPS1</span><span class="p">((</span><span class="mi">540</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">));</span>  <span class="c1">// 5 == vbi_start</span>
	<span class="cm">/* wait for brs_done */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">MASK_08</span><span class="p">);</span>
	<span class="cm">/* upload brs and video-dma3*/</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_UPLOAD</span> <span class="o">|</span> <span class="n">MASK_08</span> <span class="o">|</span> <span class="n">MASK_04</span><span class="p">);</span>
	<span class="cm">/* load mc2 register: enable dma3 */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MC1</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">MASK_20</span> <span class="o">|</span> <span class="n">MASK_04</span><span class="p">);</span>
	<span class="cm">/* generate interrupt */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
	<span class="cm">/* stop rps1 */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_STOP</span><span class="p">);</span>

	<span class="cm">/* we have to do the workaround twice to be sure that</span>
<span class="cm">	   everything is ok */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* indicate to the irq handler that we do the workaround */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="n">MASK_31</span><span class="o">|</span><span class="n">MASK_15</span><span class="p">);</span>

		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NUM_LINE_BYTE3</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="n">MASK_04</span><span class="o">|</span><span class="n">MASK_20</span><span class="p">);</span>

		<span class="cm">/* enable rps1 irqs */</span>
		<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">MASK_28</span><span class="p">);</span>

		<span class="cm">/* prepare to wait to be woken up by the irq-handler */</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">;</span>

		<span class="cm">/* start rps1 to enable workaround */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_ADDR1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_13</span> <span class="o">|</span> <span class="n">MASK_29</span><span class="p">));</span>

		<span class="n">schedule</span><span class="p">();</span>

		<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;brs bug workaround %d/1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_RUNNING</span><span class="p">;</span>

		<span class="cm">/* disable rps1 irqs */</span>
		<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">MASK_28</span><span class="p">);</span>

		<span class="cm">/* stop video-dma3 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_20</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;aborted (rps:0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_ADDR1</span><span class="p">));</span>

			<span class="cm">/* stop rps1 for sure */</span>
			<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_29</span><span class="p">);</span>

			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7146_set_vbi_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">saa7146_video_dma</span> <span class="n">vdma3</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">e_wait</span> <span class="o">=</span> <span class="n">vv</span><span class="o">-&gt;</span><span class="n">current_hps_sync</span> <span class="o">==</span> <span class="n">SAA7146_HPS_SYNC_PORT_A</span> <span class="o">?</span> <span class="n">CMD_E_FID_A</span> <span class="o">:</span> <span class="n">CMD_E_FID_B</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">o_wait</span> <span class="o">=</span> <span class="n">vv</span><span class="o">-&gt;</span><span class="n">current_hps_sync</span> <span class="o">==</span> <span class="n">SAA7146_HPS_SYNC_PORT_A</span> <span class="o">?</span> <span class="n">CMD_O_FID_A</span> <span class="o">:</span> <span class="n">CMD_O_FID_B</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">	vdma3.base_even	= 0xc8000000+2560*70;</span>
<span class="cm">	vdma3.base_odd	= 0xc8000000;</span>
<span class="cm">	vdma3.prot_addr	= 0xc8000000+2560*164;</span>
<span class="cm">	vdma3.pitch	= 2560;</span>
<span class="cm">	vdma3.base_page	= 0;</span>
<span class="cm">	vdma3.num_line_byte = (64&lt;&lt;16)|((vbi_pixel_to_capture)&lt;&lt;0); // set above!</span>
<span class="cm">*/</span>
	<span class="n">vdma3</span><span class="p">.</span><span class="n">base_even</span>	<span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">vdma3</span><span class="p">.</span><span class="n">base_odd</span>	<span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">vbi_pixel_to_capture</span><span class="p">;</span>
	<span class="n">vdma3</span><span class="p">.</span><span class="n">prot_addr</span>	<span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vbi_pixel_to_capture</span><span class="p">;</span>
	<span class="n">vdma3</span><span class="p">.</span><span class="n">pitch</span>	<span class="o">=</span> <span class="n">vbi_pixel_to_capture</span><span class="p">;</span>
	<span class="n">vdma3</span><span class="p">.</span><span class="n">base_page</span>	<span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dma</span> <span class="o">|</span> <span class="n">ME1</span><span class="p">;</span>
	<span class="n">vdma3</span><span class="p">.</span><span class="n">num_line_byte</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">vbi_pixel_to_capture</span><span class="p">;</span>

	<span class="n">saa7146_write_out_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdma3</span><span class="p">);</span>

	<span class="cm">/* write beginning of rps-program */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* wait for o_fid_a/b / e_fid_a/b toggle only if bit 1 is not set */</span>

	<span class="cm">/* we don&#39;t wait here for the first field anymore. this is different from the video</span>
<span class="cm">	   capture and might cause that the first buffer is only half filled (with only</span>
<span class="cm">	   one field). but since this is some sort of streaming data, this is not that negative.</span>
<span class="cm">	   but by doing this, we can use the whole engine from videobuf-dma-sg.c... */</span>

<span class="cm">/*</span>
<span class="cm">	WRITE_RPS1(CMD_PAUSE | CMD_OAN | CMD_SIG1 | e_wait);</span>
<span class="cm">	WRITE_RPS1(CMD_PAUSE | CMD_OAN | CMD_SIG1 | o_wait);</span>
<span class="cm">*/</span>
	<span class="cm">/* set bit 1 */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MC2</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">MASK_28</span> <span class="o">|</span> <span class="n">MASK_12</span><span class="p">);</span>

	<span class="cm">/* turn on video-dma3 */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">MC1</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">MASK_04</span> <span class="o">|</span> <span class="n">MASK_20</span><span class="p">);</span>			<span class="cm">/* =&gt; mask */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">MASK_04</span> <span class="o">|</span> <span class="n">MASK_20</span><span class="p">);</span>			<span class="cm">/* =&gt; values */</span>

	<span class="cm">/* wait for o_fid_a/b / e_fid_a/b toggle */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">o_wait</span><span class="p">);</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">e_wait</span><span class="p">);</span>

	<span class="cm">/* generate interrupt */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>

	<span class="cm">/* stop */</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_STOP</span><span class="p">);</span>

	<span class="cm">/* enable rps1 irqs */</span>
	<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_28</span><span class="p">);</span>

	<span class="cm">/* write the address of the rps-program */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_ADDR1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="cm">/* turn on rps */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_13</span> <span class="o">|</span> <span class="n">MASK_29</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p, buf:%p, next:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="n">saa7146_set_vbi_capture</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">next</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span><span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="p">)</span><span class="n">vb</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lines</span><span class="p">,</span> <span class="n">llength</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">lines</span>   <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">;</span> <span class="cm">/* 2 fields */</span>
	<span class="n">llength</span> <span class="o">=</span> <span class="n">vbi_pixel_to_capture</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">lines</span> <span class="o">*</span> <span class="n">llength</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;vb:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">baddr</span>  <span class="o">&amp;&amp;</span>  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;size mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">saa7146_dma_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span><span class="o">=</span><span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">llength</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span>   <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span>  <span class="o">=</span> <span class="n">field</span><span class="p">;</span>	<span class="c1">// FIXME: check this</span>

		<span class="n">saa7146_pgtable_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">saa7146_pgtable_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">oops</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">saa7146_pgtable_build_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
						 <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="n">buffer_activate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">oops:</span>
	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;error out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">saa7146_dma_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">llength</span><span class="p">,</span><span class="n">lines</span><span class="p">;</span>

	<span class="n">lines</span>   <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">;</span> <span class="cm">/* 2 fields */</span>
	<span class="n">llength</span> <span class="o">=</span> <span class="n">vbi_pixel_to_capture</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">lines</span> <span class="o">*</span> <span class="n">llength</span><span class="p">;</span>
	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;count:%d, size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="p">)</span><span class="n">vb</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;vb:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="n">saa7146_buffer_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span>   <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_buf</span> <span class="o">*</span><span class="p">)</span><span class="n">vb</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;vb:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="n">saa7146_dma_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">vbi_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span>    <span class="o">=</span> <span class="n">buffer_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>  <span class="o">=</span> <span class="n">buffer_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>    <span class="o">=</span> <span class="n">buffer_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span>  <span class="o">=</span> <span class="n">buffer_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vbi_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p, fh:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* disable rps1  */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_29</span><span class="p">);</span>

	<span class="cm">/* disable rps1 irqs */</span>
	<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_28</span><span class="p">);</span>

	<span class="cm">/* shut down dma 3 transfers */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">curr</span><span class="p">)</span>
		<span class="n">saa7146_buffer_finish</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">,</span> <span class="n">VIDEOBUF_DONE</span><span class="p">);</span>

	<span class="n">videobuf_queue_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi_q</span><span class="p">);</span>

	<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_streaming</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_read_timeout</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vbi_read_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p, fh:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>

	<span class="n">vbi_stop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vbi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">saa7146_buffer_timeout</span><span class="p">;</span>
	<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="n">data</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">);</span>
	<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">dev</span>              <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vbi_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">arbtr_ctrl</span>	<span class="o">=</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BT_V1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p, fh:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7146_res_get</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_DMA3_BRS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB_S</span><span class="p">(</span><span class="s">&quot;cannot get vbi RESOURCE_DMA3_BRS resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* adjust arbitrition control for video dma 3 */</span>
	<span class="n">arbtr_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1f0000</span><span class="p">;</span>
	<span class="n">arbtr_ctrl</span> <span class="o">|=</span>  <span class="mh">0x1d0000</span><span class="p">;</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BT_V1</span><span class="p">,</span> <span class="n">arbtr_ctrl</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_04</span><span class="o">|</span><span class="n">MASK_20</span><span class="p">));</span>

	<span class="n">videobuf_queue_sg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vbi_qops</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span>
			    <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span><span class="p">,</span>
			    <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">,</span> <span class="c1">// FIXME: does this really work?</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_buf</span><span class="p">),</span>
			    <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

	<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_read_timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">vbi_read_timeout</span><span class="p">;</span>
	<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_read_timeout</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">file</span><span class="p">;</span>

	<span class="cm">/* initialize the brs */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SAA7146_USE_PORT_B_FOR_VBI</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_vv_data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRS_CTRL</span><span class="p">,</span> <span class="n">MASK_30</span><span class="o">|</span><span class="n">MASK_29</span> <span class="o">|</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRS_CTRL</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">vbi_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;vbi workaround failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* return ret;*/</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* upload brs register */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_08</span><span class="o">|</span><span class="n">MASK_24</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vbi_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>
	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p, fh:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">fh</span> <span class="o">==</span> <span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_streaming</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">vbi_stop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">saa7146_res_free</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_DMA3_BRS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vbi_irq_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p, curr:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">curr</span><span class="p">);</span>
		<span class="cm">/* this must be += 2, one count for each field */</span>
		<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_fieldcount</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">.</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_fieldcount</span><span class="p">;</span>
		<span class="n">saa7146_buffer_finish</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">,</span> <span class="n">VIDEOBUF_DONE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">saa7146_buffer_next</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_dmaq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">vbi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_vv</span> <span class="o">*</span><span class="n">vv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vv_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;dev:%p, fh:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="nb">NULL</span> <span class="o">==</span> <span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_streaming</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>fixme: check if dma3 is available
fixme: activate vbi engine here if necessary. (really?)</p></td><td class="code"><div class="highlight"><pre>		<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_streaming</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">fh</span> <span class="o">!=</span> <span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_streaming</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB_VBI</span><span class="p">(</span><span class="s">&quot;open %p is already using vbi capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_streaming</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vv</span><span class="o">-&gt;</span><span class="n">vbi_read_timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_read_stream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi_q</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">	printk(&quot;BASE_ODD3:      0x%08x\n&quot;, saa7146_read(dev, BASE_ODD3));</span>
<span class="cm">	printk(&quot;BASE_EVEN3:     0x%08x\n&quot;, saa7146_read(dev, BASE_EVEN3));</span>
<span class="cm">	printk(&quot;PROT_ADDR3:     0x%08x\n&quot;, saa7146_read(dev, PROT_ADDR3));</span>
<span class="cm">	printk(&quot;PITCH3:         0x%08x\n&quot;, saa7146_read(dev, PITCH3));</span>
<span class="cm">	printk(&quot;BASE_PAGE3:     0x%08x\n&quot;, saa7146_read(dev, BASE_PAGE3));</span>
<span class="cm">	printk(&quot;NUM_LINE_BYTE3: 0x%08x\n&quot;, saa7146_read(dev, NUM_LINE_BYTE3));</span>
<span class="cm">	printk(&quot;BRS_CTRL:       0x%08x\n&quot;, saa7146_read(dev, BRS_CTRL));</span>
<span class="cm">*/</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">saa7146_use_ops</span> <span class="n">saa7146_vbi_uops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">vbi_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">vbi_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">vbi_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_done</span>	<span class="o">=</span> <span class="n">vbi_irq_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">vbi_read</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
