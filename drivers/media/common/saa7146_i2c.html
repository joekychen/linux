<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › common › saa7146_i2c.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>saa7146_i2c.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;media/saa7146_vv.h&gt;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">saa7146_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* DEB_I2C(&quot;&#39;%s&#39;\n&quot;, adapter-&gt;name); */</span>

	<span class="k">return</span>	  <span class="n">I2C_FUNC_I2C</span>
		<span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_QUICK</span>
		<span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_READ_BYTE</span>	<span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_WRITE_BYTE</span>
		<span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_READ_BYTE_DATA</span> <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_WRITE_BYTE_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function returns the status-register of our i2c-device */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">saa7146_i2c_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">iicsta</span> <span class="o">=</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">);</span>
	<span class="cm">/* DEB_I2C(&quot;status: 0x%08x\n&quot;, iicsta); */</span>
	<span class="k">return</span> <span class="n">iicsta</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function runs through the i2c-messages and prepares the data to be</span>
<span class="cm">   sent through the saa7146. have a look at the specifications p. 122 ff</span>
<span class="cm">   to understand this. it returns the number of u32s to send, or -1</span>
<span class="cm">   in case of an error. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7146_i2c_msg_prepare</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">op_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first determine size of needed memory */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* worst case: we need one u32 for three bytes to be send</span>
<span class="cm">	   plus one extra byte to address the device */</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">mem</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* we assume that op points to a memory of at least</span>
<span class="cm">	 * SAA7146_I2C_MEM bytes size. if we exceed this limit...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">mem</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SAA7146_I2C_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DEB_I2C(&quot;cannot prepare i2c-message\n&quot;); */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* be careful: clear out the i2c-mem first */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">)</span><span class="o">*</span><span class="n">mem</span><span class="p">);</span>

	<span class="cm">/* loop through all messages */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* insert the address of the i2c-slave.</span>
<span class="cm">		   note: we get 7 bit i2c-addresses,</span>
<span class="cm">		   so we have to perform a translation */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">h1</span> <span class="o">=</span> <span class="n">op_count</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">op_count</span><span class="o">%</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">op</span><span class="p">[</span><span class="n">h1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>	    <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
		<span class="n">op</span><span class="p">[</span><span class="n">h1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SAA7146_I2C_START</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">op_count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* loop through all bytes of message i */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* insert the data bytes */</span>
			<span class="n">h1</span> <span class="o">=</span> <span class="n">op_count</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">op_count</span><span class="o">%</span><span class="mi">3</span><span class="p">;</span>
			<span class="n">op</span><span class="p">[</span><span class="n">h1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u8</span><span class="p">)</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
			<span class="n">op</span><span class="p">[</span><span class="n">h1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>       <span class="n">SAA7146_I2C_CONT</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span>
			<span class="n">op_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* have a look at the last byte inserted:</span>
<span class="cm">	  if it was: ...CONT change it to ...STOP */</span>
	<span class="n">h1</span> <span class="o">=</span> <span class="p">(</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span> <span class="n">h2</span> <span class="o">=</span> <span class="p">(</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">SAA7146_I2C_CONT</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="n">h1</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span><span class="p">[</span><span class="n">h1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">op</span><span class="p">[</span><span class="n">h1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SAA7146_I2C_STOP</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* return the number of u32s to send */</span>
	<span class="k">return</span> <span class="n">mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this functions loops through all i2c-messages. normally, it should determine</span>
<span class="cm">   which bytes were read through the adapter and write them back to the corresponding</span>
<span class="cm">   i2c-message. but instead, we simply write back all bytes.</span>
<span class="cm">   fixme: this could be improved. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7146_i2c_msg_cleanup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* loop through all messages */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">op_count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* loop through all bytes of message i */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* write back all bytes that could have been read */</span>
			<span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="p">(</span><span class="n">op_count</span><span class="o">%</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
			<span class="n">op_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this functions resets the i2c-device and returns 0 if everything was fine, otherwise -1 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7146_i2c_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* get current status */</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">saa7146_i2c_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* clear registers for sure */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_TRANSFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* check if any operation is still in progress */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_BUSY</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* yes, kill ongoing operation */</span>
		<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;busy_state detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* set &quot;ABORT-OPERATION&quot;-bit (bit 7)*/</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">|</span> <span class="n">MASK_07</span><span class="p">));</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_00</span> <span class="o">|</span> <span class="n">MASK_16</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SAA7146_I2C_DELAY</span><span class="p">);</span>

		<span class="cm">/* clear all error-bits pending; this is needed because p.123, note 1 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_00</span> <span class="o">|</span> <span class="n">MASK_16</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SAA7146_I2C_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check if any error is (still) present. (this can be necessary because p.123, note 1) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">saa7146_i2c_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">!=</span> <span class="n">status</span> <span class="p">)</span> <span class="p">{</span>

		<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;error_state detected. status:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* Repeat the abort operation. This seems to be necessary</span>
<span class="cm">		   after serious protocol errors caused by e.g. the SAA7740 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">|</span> <span class="n">MASK_07</span><span class="p">));</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_00</span> <span class="o">|</span> <span class="n">MASK_16</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SAA7146_I2C_DELAY</span><span class="p">);</span>

		<span class="cm">/* clear all error-bits pending */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_00</span> <span class="o">|</span> <span class="n">MASK_16</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SAA7146_I2C_DELAY</span><span class="p">);</span>

		<span class="cm">/* the data sheet says it might be necessary to clear the status</span>
<span class="cm">		   twice after an abort */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_00</span> <span class="o">|</span> <span class="n">MASK_16</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SAA7146_I2C_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if any error is still present, a fatal error has occurred ... */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">saa7146_i2c_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">!=</span> <span class="n">status</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;fatal error. status:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this functions writes out the data-byte &#39;dword&#39; to the i2c-device.</span>
<span class="cm">   it returns 0 if ok, -1 if the transfer failed, -2 if the transfer</span>
<span class="cm">   failed badly (e.g. address error) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7146_i2c_writeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">dword</span><span class="p">,</span> <span class="kt">int</span> <span class="n">short_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* write out i2c-command */</span>
	<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;before: 0x%08x (status: 0x%08x), %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">dword</span><span class="p">,</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_op</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SAA7146_USE_I2C_IRQ</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span>	 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_TRANSFER</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dword</span><span class="p">));</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_16</span><span class="o">|</span><span class="n">MASK_17</span><span class="p">);</span>
		<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_16</span><span class="o">|</span><span class="n">MASK_17</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_00</span> <span class="o">|</span> <span class="n">MASK_16</span><span class="p">));</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 10ms */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_wq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_op</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_op</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_16</span><span class="o">|</span><span class="n">MASK_17</span><span class="p">);</span>
			<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_16</span><span class="o">|</span><span class="n">MASK_17</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
				<span class="cm">/* a signal arrived */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s %s [irq]: timed out waiting for end of xfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_STATUS</span><span class="p">,</span>	 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_TRANSFER</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dword</span><span class="p">));</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_00</span> <span class="o">|</span> <span class="n">MASK_16</span><span class="p">));</span>

		<span class="cm">/* do not poll for i2c-status before upload is complete */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 10ms */</span>
		<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mc2</span> <span class="o">=</span> <span class="p">(</span><span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">mc2</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s %s: timed out waiting for MC2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* wait until we get a transfer done or error */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 10ms */</span>
		<span class="cm">/* first read usually delivers bogus results... */</span>
		<span class="n">saa7146_i2c_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">saa7146_i2c_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* this is normal when probing the bus</span>
<span class="cm">				 * (no answer from nonexisistant device...)</span>
<span class="cm">				 */</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s %s [poll]: timed out waiting for end of xfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">trial</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="o">&amp;&amp;</span> <span class="n">short_delay</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* give a detailed status report */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SAA7146_I2C_SPERR</span> <span class="o">|</span> <span class="n">SAA7146_I2C_APERR</span> <span class="o">|</span>
			     <span class="n">SAA7146_I2C_DTERR</span> <span class="o">|</span> <span class="n">SAA7146_I2C_DRERR</span> <span class="o">|</span>
			     <span class="n">SAA7146_I2C_AL</span>    <span class="o">|</span> <span class="n">SAA7146_I2C_ERR</span>   <span class="o">|</span>
			     <span class="n">SAA7146_I2C_BUSY</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_ERR</span><span class="p">)</span> <span class="o">||</span>
		     <span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_BUSY</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* it may take some time until ERR goes high - ignore */</span>
			<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;unexpected i2c status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_SPERR</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;error due to invalid start/stop condition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_DTERR</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;error in data transmission</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_DRERR</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;error when receiving data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_AL</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;error because arbitration lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* we handle address-errors here */</span>
		<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SAA7146_I2C_APERR</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;error in address phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read back data, just in case we were reading ... */</span>
	<span class="o">*</span><span class="n">dword</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2C_TRANSFER</span><span class="p">));</span>

	<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;after: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">dword</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7146_i2c_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_i2c</span><span class="p">.</span><span class="n">cpu_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">short_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">num</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;msg:%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* prepare the message(s), get number of u32s to transfer */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">saa7146_i2c_msg_prepare</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">count</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SAA7146_I2C_SHORT_DELAY</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">short_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* reset the i2c-device if necessary */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">saa7146_i2c_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">err</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;could not reset i2c-device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* write out the u32s one after another */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">saa7146_i2c_writeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">short_delay</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* this one is unsatisfying: some i2c slaves on some</span>
<span class="cm">				   dvb cards don&#39;t acknowledge correctly, so the saa7146</span>
<span class="cm">				   thinks that an address error occurred. in that case, the</span>
<span class="cm">				   transaction should be retrying, even if an address error</span>
<span class="cm">				   occurred. analog saa7146 based cards extensively rely on</span>
<span class="cm">				   i2c address probing, however, and address errors indicate that a</span>
<span class="cm">				   device is really *not* there. retrying in that case</span>
<span class="cm">				   increases the time the device needs to probe greatly, so</span>
<span class="cm">				   it should be avoided. So we bail out in irq mode after an</span>
<span class="cm">				   address error and trust the saa7146 address error detection. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">==</span> <span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SAA7146_USE_I2C_IRQ</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;error while sending message(s). starting again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">err</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* delay a bit before retrying */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">retries</span><span class="o">--</span><span class="p">);</span>

	<span class="cm">/* quit if any error occurred */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">num</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* if any things had to be read, get the results */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">saa7146_i2c_msg_cleanup</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;could not cleanup i2c-message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return the number of delivered messages */</span>
	<span class="n">DEB_I2C</span><span class="p">(</span><span class="s">&quot;transmission successful. (msg:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="cm">/* another bug in revision 0: the i2c-registers get uploaded randomly by other</span>
<span class="cm">	   uploads, so we better clear them out before continuing */</span>
	<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">saa7146_i2c_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">saa7146_i2c_writeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">short_delay</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;revision 0 error. this should never happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* utility functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7146_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span><span class="o">*</span> <span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_saa7146_dev</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="cm">/* use helper function to transfer data */</span>
	<span class="k">return</span> <span class="n">saa7146_i2c_transfer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* i2c-adapter helper functions                                              */</span>

<span class="cm">/* exported algorithm data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">saa7146_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>	<span class="o">=</span> <span class="n">saa7146_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span>	<span class="o">=</span> <span class="n">saa7146_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">saa7146_i2c_adapter_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEB_EE</span><span class="p">(</span><span class="s">&quot;bitrate: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">);</span>

	<span class="cm">/* enable i2c-port pins */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_08</span> <span class="o">|</span> <span class="n">MASK_24</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">;</span>
	<span class="n">saa7146_i2c_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
		<span class="n">i2c_adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">i2c_adapter</span><span class="o">-&gt;</span><span class="n">algo</span>	   <span class="o">=</span> <span class="o">&amp;</span><span class="n">saa7146_algo</span><span class="p">;</span>
		<span class="n">i2c_adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span>     <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">i2c_adapter</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAA7146_I2C_TIMEOUT</span><span class="p">;</span>
		<span class="n">i2c_adapter</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">SAA7146_I2C_RETRIES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
