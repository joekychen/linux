<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › v4l2-common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>v4l2-common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Video for Linux Two</span>
<span class="cm"> *</span>
<span class="cm"> *	A generic video device interface for the LINUX operating system</span>
<span class="cm"> *	using a set of device structures/vectors for low level operations.</span>
<span class="cm"> *</span>
<span class="cm"> *	This file replaces the videodev.c file that comes with the</span>
<span class="cm"> *	regular kernel distribution.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License</span>
<span class="cm"> *	as published by the Free Software Foundation; either version</span>
<span class="cm"> *	2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Bill Dirks &lt;bill@thedirks.org&gt;</span>
<span class="cm"> *		based on code by Alan Cox, &lt;alan@cymru.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Video capture interface for Linux</span>
<span class="cm"> *</span>
<span class="cm"> *	A generic video device interface for the LINUX operating system</span>
<span class="cm"> *	using a set of device structures/vectors for low level operations.</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Alan Cox, &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixes:</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Video4linux 1/2 integration by Justin Schoeman</span>
<span class="cm"> * &lt;justin@suntiger.ee.up.ac.za&gt;</span>
<span class="cm"> * 2.4 PROCFS support ported from 2.4 kernels by</span>
<span class="cm"> *  Iñaki García Etxebarria &lt;garetxe@euskalnet.net&gt;</span>
<span class="cm"> * Makefile fix by &quot;W. Michael Petullo&quot; &lt;mike@flyn.org&gt;</span>
<span class="cm"> * 2.4 devfs support ported from 2.4 kernels by</span>
<span class="cm"> *  Dan Merillat &lt;dan@merillat.org&gt;</span>
<span class="cm"> * Added Gerd Knorrs v4l1 enhancements (Justin Schoeman)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#if defined(CONFIG_SPI)</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>

<span class="cp">#include &lt;linux/videodev2.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Bill Dirks, Justin Schoeman, Gerd Knorr&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;misc helper functions for v4l2 device drivers&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *	V 4 L 2   D R I V E R   H E L P E R   A P I</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Video Standard Operations (contributed by Michael Schimek)</span>
<span class="cm"> */</span>

<span class="cm">/* Helper functions for control handling			     */</span>

<span class="cm">/* Check for correctness of the ctrl&#39;s value based on the data from</span>
<span class="cm">   struct v4l2_queryctrl and the available menu items. Note that</span>
<span class="cm">   menu_items may be NULL, in that case it is ignored. */</span>
<span class="kt">int</span> <span class="nf">v4l2_ctrl_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qctrl</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">menu_items</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_DISABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_GRABBED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_STRING</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span> <span class="o">||</span>
	    <span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span> <span class="o">||</span>
	    <span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span> <span class="o">&amp;&amp;</span> <span class="n">menu_items</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">menu_items</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">menu_items</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_check</span><span class="p">);</span>

<span class="cm">/* Fill in a struct v4l2_queryctrl */</span>
<span class="kt">int</span> <span class="nf">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qctrl</span><span class="p">,</span> <span class="n">s32</span> <span class="n">min</span><span class="p">,</span> <span class="n">s32</span> <span class="n">max</span><span class="p">,</span> <span class="n">s32</span> <span class="n">step</span><span class="p">,</span> <span class="n">s32</span> <span class="n">def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_fill</span><span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">def</span><span class="p">;</span>
	<span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_query_fill</span><span class="p">);</span>

<span class="cm">/* Fill in a struct v4l2_querymenu based on the struct v4l2_queryctrl and</span>
<span class="cm">   the menu. The qctrl pointer may be NULL, in which case it is ignored.</span>
<span class="cm">   If menu_items is NULL, then the menu items are retrieved using</span>
<span class="cm">   v4l2_ctrl_get_menu. */</span>
<span class="kt">int</span> <span class="nf">v4l2_ctrl_query_menu</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">qmenu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qctrl</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">menu_items</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menu_items</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">menu_items</span> <span class="o">=</span> <span class="n">v4l2_ctrl_get_menu</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menu_items</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">qctrl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">||</span> <span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">qctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;&amp;</span> <span class="n">menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">menu_items</span><span class="p">[</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_query_menu</span><span class="p">);</span>

<span class="cm">/* Fill in a struct v4l2_querymenu based on the specified array of valid</span>
<span class="cm">   menu items (terminated by V4L2_CTRL_MENU_IDS_END).</span>
<span class="cm">   Use this if there are &#39;holes&#39; in the list of valid menu items. */</span>
<span class="kt">int</span> <span class="nf">v4l2_ctrl_query_menu_valid_items</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">qmenu</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">menu_items</span> <span class="o">=</span> <span class="n">v4l2_ctrl_get_menu</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menu_items</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ids</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ids</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_MENU_IDS_END</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ids</span><span class="o">++</span> <span class="o">==</span> <span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">menu_items</span><span class="p">[</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_query_menu_valid_items</span><span class="p">);</span>

<span class="cm">/* ctrl_classes points to an array of u32 pointers, the last element is</span>
<span class="cm">   a NULL pointer. Each u32 array is a 0-terminated array of control IDs.</span>
<span class="cm">   Each array must be sorted low to high and belong to the same control</span>
<span class="cm">   class. The array of u32 pointers must also be sorted, from low class IDs</span>
<span class="cm">   to high class IDs.</span>

<span class="cm">   This function returns the first ID that follows after the given ID.</span>
<span class="cm">   When no more controls are available 0 is returned. */</span>
<span class="n">u32</span> <span class="nf">v4l2_ctrl_next</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">ctrl_classes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl_class</span> <span class="o">=</span> <span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_classes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if no query is desired, then check if the ID is part of ctrl_classes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_NEXT_CTRL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* find class */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl_classes</span> <span class="o">&amp;&amp;</span> <span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="o">**</span><span class="n">ctrl_classes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ctrl_class</span><span class="p">)</span>
			<span class="n">ctrl_classes</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl_classes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pctrl</span> <span class="o">=</span> <span class="o">*</span><span class="n">ctrl_classes</span><span class="p">;</span>
		<span class="cm">/* find control ID */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">pctrl</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pctrl</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span> <span class="n">pctrl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">*</span><span class="n">pctrl</span> <span class="o">?</span> <span class="n">id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">id</span> <span class="o">&amp;=</span> <span class="n">V4L2_CTRL_ID_MASK</span><span class="p">;</span>
	<span class="n">id</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* select next control */</span>
	<span class="cm">/* find first class that matches (or is greater than) the class of</span>
<span class="cm">	   the ID */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl_classes</span> <span class="o">&amp;&amp;</span> <span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="o">**</span><span class="n">ctrl_classes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ctrl_class</span><span class="p">)</span>
		<span class="n">ctrl_classes</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* no more classes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl_classes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pctrl</span> <span class="o">=</span> <span class="o">*</span><span class="n">ctrl_classes</span><span class="p">;</span>
	<span class="cm">/* find first ctrl within the class that is &gt;= ID */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">pctrl</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pctrl</span> <span class="o">&lt;</span> <span class="n">id</span><span class="p">)</span> <span class="n">pctrl</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pctrl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">*</span><span class="n">pctrl</span><span class="p">;</span>
	<span class="cm">/* we are at the end of the controls of the current class. */</span>
	<span class="cm">/* continue with next class if available */</span>
	<span class="n">ctrl_classes</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl_classes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">**</span><span class="n">ctrl_classes</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_next</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_chip_match_host</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_dbg_match</span> <span class="o">*</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CHIP_MATCH_HOST</span>:
		<span class="k">return</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_chip_match_host</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_I2C) || (defined(CONFIG_I2C_MODULE) &amp;&amp; defined(MODULE))</span>
<span class="kt">int</span> <span class="nf">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_dbg_match</span> <span class="o">*</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">match</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CHIP_MATCH_I2C_DRIVER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* legacy drivers have a &#39; suffix, don&#39;t try to match that */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CHIP_MATCH_I2C_ADDR</span>:
		<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_chip_ident_i2c_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">ident</span><span class="p">,</span> <span class="n">u32</span> <span class="n">revision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">V4L2_IDENT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">ident</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">revision</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_AMBIGUOUS</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_chip_ident_i2c_client</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------------- */</span>

<span class="cm">/* I2C Helper functions */</span>


<span class="kt">void</span> <span class="nf">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_IS_I2C</span><span class="p">;</span>
	<span class="cm">/* the owner is the same as the i2c_client&#39;s driver owner */</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
	<span class="cm">/* i2c_client and v4l2_subdev point to one another */</span>
	<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="cm">/* initialize name */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s %d-%04x&quot;</span><span class="p">,</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i2c_adapter_id</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">),</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_i2c_subdev_init</span><span class="p">);</span>



<span class="cm">/* Load an i2c sub-device. */</span>
<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">v4l2_i2c_new_subdev_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">probe_addrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">request_module</span><span class="p">(</span><span class="n">I2C_MODULE_PREFIX</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="cm">/* Create the i2c client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">probe_addrs</span><span class="p">)</span>
		<span class="n">client</span> <span class="o">=</span> <span class="n">i2c_new_probed_device</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">probe_addrs</span><span class="p">,</span>
					       <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">client</span> <span class="o">=</span> <span class="n">i2c_new_device</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Note: by loading the module first we are certain that c-&gt;driver</span>
<span class="cm">	   will be set if the driver was found. If the module was not loaded</span>
<span class="cm">	   first, then the i2c core tries to delay-load the module for us,</span>
<span class="cm">	   and then c-&gt;driver is still NULL until the module is finally</span>
<span class="cm">	   loaded. This delay-load mechanism doesn&#39;t work if other drivers</span>
<span class="cm">	   want to use the i2c device, so explicitly loading the module</span>
<span class="cm">	   is the best alternative. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Lock the module so we can safely get the v4l2_subdev pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* Register with the v4l2_device which increases the module&#39;s</span>
<span class="cm">	   use count as well. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">sd</span><span class="p">))</span>
		<span class="n">sd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Decrease the module use count to match the first try_module_get. */</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="cm">/* If we have a client but no subdev, then something went wrong and</span>
<span class="cm">	   we must unregister the client. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="n">sd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_i2c_new_subdev_board</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">client_type</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">probe_addrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="cm">/* Setup the i2c board info with the device type and</span>
<span class="cm">	   the device address. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">client_type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_i2c_new_subdev_board</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">probe_addrs</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_i2c_new_subdev</span><span class="p">);</span>

<span class="cm">/* Return i2c client address of v4l2_subdev. */</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">v4l2_i2c_subdev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">client</span> <span class="o">?</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">:</span> <span class="n">I2C_CLIENT_END</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_i2c_subdev_addr</span><span class="p">);</span>

<span class="cm">/* Return a list of I2C tuner addresses to probe. Use only if the tuner</span>
<span class="cm">   addresses are unknown. */</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="nf">v4l2_i2c_tuner_addrs</span><span class="p">(</span><span class="k">enum</span> <span class="n">v4l2_i2c_tuner_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">radio_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_MEDIA_TUNER_TEA5761) || defined(CONFIG_MEDIA_TUNER_TEA5761_MODULE)</span>
		<span class="mh">0x10</span><span class="p">,</span>
<span class="cp">#endif</span>
		<span class="mh">0x60</span><span class="p">,</span>
		<span class="n">I2C_CLIENT_END</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">demod_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
		<span class="n">I2C_CLIENT_END</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tv_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>		<span class="cm">/* tda8290 */</span>
		<span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span>
		<span class="n">I2C_CLIENT_END</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADDRS_RADIO</span>:
		<span class="k">return</span> <span class="n">radio_addrs</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADDRS_DEMOD</span>:
		<span class="k">return</span> <span class="n">demod_addrs</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADDRS_TV</span>:
		<span class="k">return</span> <span class="n">tv_addrs</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADDRS_TV_WITH_DEMOD</span>:
		<span class="k">return</span> <span class="n">tv_addrs</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_i2c_tuner_addrs</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_I2C) */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_SPI)</span>

<span class="cm">/* Load a spi sub-device. */</span>

<span class="kt">void</span> <span class="nf">v4l2_spi_subdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_IS_SPI</span><span class="p">;</span>
	<span class="cm">/* the owner is the same as the spi_device&#39;s driver owner */</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="cm">/* spi_device and v4l2_subdev point to one another */</span>
	<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">spi</span><span class="p">);</span>
	<span class="n">spi_set_drvdata</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="cm">/* initialize name */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_spi_subdev_init</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">v4l2_spi_new_subdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modalias</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modalias</span><span class="p">);</span>

	<span class="n">spi</span> <span class="o">=</span> <span class="n">spi_new_device</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="n">spi_get_drvdata</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>

	<span class="cm">/* Register with the v4l2_device which increases the module&#39;s</span>
<span class="cm">	   use count as well. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">sd</span><span class="p">))</span>
		<span class="n">sd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Decrease the module use count to match the first try_module_get. */</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="cm">/* If we have a client but no subdev, then something went wrong and</span>
<span class="cm">	   we must unregister the client. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span> <span class="o">&amp;&amp;</span> <span class="n">sd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">spi_unregister_device</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_spi_new_subdev</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_SPI) */</span><span class="cp"></span>

<span class="cm">/* Clamp x to be between min and max, aligned to a multiple of 2^align.  min</span>
<span class="cm"> * and max don&#39;t have to be aligned, but there must be at least one valid</span>
<span class="cm"> * value.  E.g., min=17,max=31,align=4 is not allowed as there are no multiples</span>
<span class="cm"> * of 16 between 17 and 31.  */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">clamp_align</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Bits that must be zero to be aligned */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">align</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Round to nearest aligned value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">align</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Clamp to aligned value of min and max */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span> <span class="o">+</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">max</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Bound an image to have a width between wmin and wmax, and height between</span>
<span class="cm"> * hmin and hmax, inclusive.  Additionally, the width will be a multiple of</span>
<span class="cm"> * 2^walign, the height will be a multiple of 2^halign, and the overall size</span>
<span class="cm"> * (width*height) will be a multiple of 2^salign.  The image may be shrunk</span>
<span class="cm"> * or enlarged to fit the alignment constraints.</span>
<span class="cm"> *</span>
<span class="cm"> * The width or height maximum must not be smaller than the corresponding</span>
<span class="cm"> * minimum.  The alignments must not be so high there are no possible image</span>
<span class="cm"> * sizes within the allowed bounds.  wmin and hmin must be at least 1</span>
<span class="cm"> * (don&#39;t use 0).  If you don&#39;t care about a certain alignment, specify 0,</span>
<span class="cm"> * as 2^0 is 1 and one byte alignment is equivalent to no alignment.  If</span>
<span class="cm"> * you only want to adjust downward, specify a maximum that&#39;s the same as</span>
<span class="cm"> * the initial value.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">v4l_bound_align_image</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wmin</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wmax</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">walign</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hmin</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hmax</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">halign</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">salign</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">clamp_align</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">wmin</span><span class="p">,</span> <span class="n">wmax</span><span class="p">,</span> <span class="n">walign</span><span class="p">);</span>
	<span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">clamp_align</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">hmin</span><span class="p">,</span> <span class="n">hmax</span><span class="p">,</span> <span class="n">halign</span><span class="p">);</span>

	<span class="cm">/* Usually we don&#39;t need to align the size and are done now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">salign</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* How much alignment do we have? */</span>
	<span class="n">walign</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
	<span class="n">halign</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">);</span>
	<span class="cm">/* Enough to satisfy the image alignment? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">walign</span> <span class="o">+</span> <span class="n">halign</span> <span class="o">&lt;</span> <span class="n">salign</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Max walign where there is still a valid width */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wmaxa</span> <span class="o">=</span> <span class="n">__fls</span><span class="p">(</span><span class="n">wmax</span> <span class="o">^</span> <span class="p">(</span><span class="n">wmin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="cm">/* Max halign where there is still a valid height */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hmaxa</span> <span class="o">=</span> <span class="n">__fls</span><span class="p">(</span><span class="n">hmax</span> <span class="o">^</span> <span class="p">(</span><span class="n">hmin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="cm">/* up the smaller alignment until we have enough */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">halign</span> <span class="o">&gt;=</span> <span class="n">hmaxa</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">walign</span> <span class="o">&lt;=</span> <span class="n">halign</span> <span class="o">&amp;&amp;</span> <span class="n">walign</span> <span class="o">&lt;</span> <span class="n">wmaxa</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">clamp_align</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">wmin</span><span class="p">,</span> <span class="n">wmax</span><span class="p">,</span> <span class="n">walign</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">walign</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">clamp_align</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">hmin</span><span class="p">,</span> <span class="n">hmax</span><span class="p">,</span> <span class="n">halign</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">halign</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">halign</span> <span class="o">+</span> <span class="n">walign</span> <span class="o">&lt;</span> <span class="n">salign</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l_bound_align_image</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * v4l_fill_dv_preset_info - fill description of a digital video preset</span>
<span class="cm"> * @preset - preset value</span>
<span class="cm"> * @info - pointer to struct v4l2_dv_enum_preset</span>
<span class="cm"> *</span>
<span class="cm"> * drivers can use this helper function to fill description of dv preset</span>
<span class="cm"> * in info.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">v4l_fill_dv_preset_info</span><span class="p">(</span><span class="n">u32</span> <span class="n">preset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dv_enum_preset</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_dv_preset_info</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">height</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">dv_presets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Invalid&quot;</span> <span class="p">},</span>		<span class="cm">/* V4L2_DV_INVALID */</span>
		<span class="p">{</span> <span class="mi">720</span><span class="p">,</span>  <span class="mi">480</span><span class="p">,</span> <span class="s">&quot;480p@59.94&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_480P59_94 */</span>
		<span class="p">{</span> <span class="mi">720</span><span class="p">,</span>  <span class="mi">576</span><span class="p">,</span> <span class="s">&quot;576p@50&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_576P50 */</span>
		<span class="p">{</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="s">&quot;720p@24&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_720P24 */</span>
		<span class="p">{</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="s">&quot;720p@25&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_720P25 */</span>
		<span class="p">{</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="s">&quot;720p@30&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_720P30 */</span>
		<span class="p">{</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="s">&quot;720p@50&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_720P50 */</span>
		<span class="p">{</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="s">&quot;720p@59.94&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_720P59_94 */</span>
		<span class="p">{</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="s">&quot;720p@60&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_720P60 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080i@29.97&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080I29_97 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080i@30&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080I30 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080i@25&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080I25 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080i@50&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080I50 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080i@60&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080I60 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080p@24&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080P24 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080p@25&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080P25 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080p@30&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080P30 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080p@50&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080P50 */</span>
		<span class="p">{</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="s">&quot;1080p@60&quot;</span> <span class="p">},</span>	<span class="cm">/* V4L2_DV_1080P60 */</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">preset</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dv_presets</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">=</span> <span class="n">preset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">dv_presets</span><span class="p">[</span><span class="n">preset</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">dv_presets</span><span class="p">[</span><span class="n">preset</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dv_presets</span><span class="p">[</span><span class="n">preset</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l_fill_dv_preset_info</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_frmsize_discrete</span> <span class="o">*</span><span class="nf">v4l2_find_nearest_format</span><span class="p">(</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_discrete_probe</span> <span class="o">*</span><span class="n">probe</span><span class="p">,</span>
		<span class="n">s32</span> <span class="n">width</span><span class="p">,</span> <span class="n">s32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error</span><span class="p">,</span> <span class="n">min_error</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_frmsize_discrete</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="n">best</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">best</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">probe</span><span class="o">-&gt;</span><span class="n">sizes</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">probe</span><span class="o">-&gt;</span><span class="n">num_sizes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">size</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">size</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="n">abs</span><span class="p">(</span><span class="n">size</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="n">min_error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">min_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">best</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_find_nearest_format</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
