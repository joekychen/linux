<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › zoran › videocodec.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>videocodec.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * VIDEO MOTION CODECs internal API for video devices</span>
<span class="cm"> *</span>
<span class="cm"> * Interface for MJPEG (and maybe later MPEG/WAVELETS) codec&#39;s</span>
<span class="cm"> * bound to a master device.</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2002 Wolfgang Scherr &lt;scherr@net4you.at&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: videocodec.c,v 1.1.2.8 2003/03/29 07:16:04 rbultje Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * ------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * ------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cp">#define VIDEOCODEC_VERSION &quot;v0.2&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>kernel config is here (procfs flag)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;videocodec.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-4)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(num, format, args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug &gt;= num) \</span>
<span class="cp">			printk(format, ##args); \</span>
<span class="cp">	} while (0)</span>

<span class="k">struct</span> <span class="n">attached_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attached_list</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">codec_list</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attached</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attached_list</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">codec_list</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">codec_list</span> <span class="o">*</span><span class="n">codeclist_top</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/* ================================================= */</span>
<span class="cm">/* function prototypes of the master/slave interface */</span>
<span class="cm">/* ================================================= */</span>

<span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span>
<span class="nf">videocodec_attach</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_list</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">codeclist_top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attached_list</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_attach: no data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		<span class="s">&quot;videocodec_attach: &#39;%s&#39;, flags %lx, magic %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;videocodec_attach: no device available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>attach only if the slave has at least the flags
expected by the master</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;videocodec_attach: try &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">codec</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">KERN_ERR</span>
					<span class="s">&quot;videocodec_attach: no mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_module_put</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">snprintf</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
				 <span class="s">&quot;%s[%d]&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">);</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;videocodec_attach &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attached_list</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
						<span class="n">KERN_ERR</span>
						<span class="s">&quot;videocodec_attach: no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

				<span class="n">a</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;videocodec: first element</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
						<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>	<span class="c1">// find end</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;videocodec: in after &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">h</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">codec</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_attach: no codec found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

 <span class="nl">out_module_put:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
 <span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">videocodec_detach</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_list</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">codeclist_top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attached_list</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_detach: no data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		<span class="s">&quot;videocodec_detach: &#39;%s&#39;, type: %x, flags %lx, magic %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_detach: no device left...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">unset</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
						<span class="s">&quot;videocodec_detach: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
						<span class="n">KERN_ERR</span>
						<span class="s">&quot;videocodec_detach: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;videocodec: delete first</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;videocodec: delete middle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">module_put</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_detach: given codec not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">videocodec_register</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_list</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">codeclist_top</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_register: no data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		<span class="s">&quot;videocodec: register &#39;%s&#39;, type: %x, flags %lx, magic %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_list</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_register: no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codeclist_top</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;videocodec: hooked in as first element</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>	<span class="c1">// find the end</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;videocodec: hooked in after &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">videocodec_unregister</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_list</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">codeclist_top</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec_unregister: no data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		<span class="s">&quot;videocodec: unregister &#39;%s&#39;, type: %x, flags %lx, magic %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;videocodec_unregister: no device left...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">KERN_ERR</span>
					<span class="s">&quot;videocodec: &#39;%s&#39; is used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;videocodec: unregister &#39;%s&#39; is ok.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">codeclist_top</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
					<span class="s">&quot;videocodec: delete first element</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
					<span class="s">&quot;videocodec: delete middle element</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">KERN_ERR</span>
		<span class="s">&quot;videocodec_unregister: given codec not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_videocodecs_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_list</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">codeclist_top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attached_list</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;&lt;S&gt;lave or attached &lt;M&gt;aster name  type flags    magic    &quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;(connected as)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">codeclist_top</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;S %32s %04x %08lx %08lx (TEMPLATE)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			      <span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;M %32s %04x %08lx %08lx (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				      <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				      <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				      <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span>
				      <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_videocodecs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proc_videocodecs_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">videocodecs_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_videocodecs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* ===================== */</span>
<span class="cm">/* hook in driver module */</span>
<span class="cm">/* ===================== */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">videocodec_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">videocodec_proc_entry</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Linux video codec intermediate layer: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">VIDEOCODEC_VERSION</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">videocodec_proc_entry</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;videocodecs&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">videocodecs_proc_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">videocodec_proc_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;videocodec: can&#39;t init procfs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">videocodec_exit</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;videocodecs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">videocodec_attach</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">videocodec_detach</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">videocodec_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">videocodec_unregister</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">videocodec_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">videocodec_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Wolfgang Scherr &lt;scherr@net4you.at&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intermediate API module for video codecs &quot;</span>
		   <span class="n">VIDEOCODEC_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
