<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › zoran › zoran_card.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>zoran_card.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Zoran zr36057/zr36067 PCI controller driver, for the</span>
<span class="cm"> * Pinnacle/Miro DC10/DC10+/DC30/DC30+, Iomega Buz, Linux</span>
<span class="cm"> * Media Labs LML33/LML33R10.</span>
<span class="cm"> *</span>
<span class="cm"> * This part handles card-specific data and detection</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000 Serguei Miridonov &lt;mirsev@cicese.mx&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Currently maintained by:</span>
<span class="cm"> *   Ronald Bultje    &lt;rbultje@ronald.bitfreak.net&gt;</span>
<span class="cm"> *   Laurent Pinchart &lt;laurent.pinchart@skynet.be&gt;</span>
<span class="cm"> *   Mailinglist      &lt;mjpeg-users@lists.sf.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-algo-bit.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/sem.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/bt819.h&gt;</span>

<span class="cp">#include &quot;videocodec.h&quot;</span>
<span class="cp">#include &quot;zoran.h&quot;</span>
<span class="cp">#include &quot;zoran_card.h&quot;</span>
<span class="cp">#include &quot;zoran_device.h&quot;</span>
<span class="cp">#include &quot;zoran_procfs.h&quot;</span>

<span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zoran_format</span> <span class="n">zoran_formats</span><span class="p">[];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">card</span><span class="p">[</span><span class="n">BUZ_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">BUZ_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Card type&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   The video mem address of the video card.</span>
<span class="cm">   The driver has a little database for some videocards</span>
<span class="cm">   to determine it from there. If your video card is not in there</span>
<span class="cm">   you have either to give it to the driver as a parameter</span>
<span class="cm">   or set in in a VIDIOCSFBUF ioctl</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vidmem</span><span class="p">;</span>	<span class="cm">/* default = 0 - Video memory base address */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vidmem</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vidmem</span><span class="p">,</span> <span class="s">&quot;Default video memory base address&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   Default input and video norm at startup of the driver.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">default_input</span><span class="p">;</span>	<span class="cm">/* default 0 = Composite, 1 = S-Video */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_input</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_input</span><span class="p">,</span>
		 <span class="s">&quot;Default input (0=Composite, 1=S-Video, 2=Internal)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">default_mux</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 6 Eyes input selection */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_mux</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_mux</span><span class="p">,</span>
		 <span class="s">&quot;Default 6 Eyes mux setting (Input selection)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">default_norm</span><span class="p">;</span>	<span class="cm">/* default 0 = PAL, 1 = NTSC 2 = SECAM */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_norm</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_norm</span><span class="p">,</span> <span class="s">&quot;Default norm (0=PAL, 1=NTSC, 2=SECAM)&quot;</span><span class="p">);</span>

<span class="cm">/* /dev/videoN, -1 for autodetect */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span><span class="p">[</span><span class="n">BUZ_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">BUZ_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="s">&quot;Video device number (-1=Auto)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">v4l_nbufs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">v4l_bufsize</span> <span class="o">=</span> <span class="mi">864</span><span class="p">;</span>		<span class="cm">/* Everybody should be able to work with this setting */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">v4l_nbufs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">v4l_nbufs</span><span class="p">,</span> <span class="s">&quot;Maximum number of V4L buffers to use&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">v4l_bufsize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">v4l_bufsize</span><span class="p">,</span> <span class="s">&quot;Maximum size per V4L buffer (in kB)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">jpg_nbufs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">jpg_bufsize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>		<span class="cm">/* max size for 100% quality full-PAL frame */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">jpg_nbufs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">jpg_nbufs</span><span class="p">,</span> <span class="s">&quot;Maximum number of JPG buffers to use&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">jpg_bufsize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">jpg_bufsize</span><span class="p">,</span> <span class="s">&quot;Maximum size per JPG buffer (in kB)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">pass_through</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* 1=Pass through TV signal when device is not used */</span>
				<span class="cm">/* 0=Show color bar when device is not used (LML33: only if lml33dpath=1) */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pass_through</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pass_through</span><span class="p">,</span>
		 <span class="s">&quot;Pass TV signal through to TV-out when idling&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">zr36067_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">zr36067_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-5)&quot;</span><span class="p">);</span>

<span class="cp">#define ZORAN_VERSION &quot;0.10.1&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Zoran-36057/36067 JPEG codec driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Serguei Miridonov&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">ZORAN_VERSION</span><span class="p">);</span>

<span class="cp">#define ZR_DEVICE(subven, subdev, data)	{ \</span>
<span class="cp">	.vendor = PCI_VENDOR_ID_ZORAN, .device = PCI_DEVICE_ID_ZORAN_36057, \</span>
<span class="cp">	.subvendor = (subven), .subdevice = (subdev), .driver_data = (data) }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">zr36067_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ZR_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MIRO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MIRO_DC10PLUS</span><span class="p">,</span> <span class="n">DC10plus</span><span class="p">),</span>
	<span class="n">ZR_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MIRO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MIRO_DC30PLUS</span><span class="p">,</span> <span class="n">DC30plus</span><span class="p">),</span>
	<span class="n">ZR_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ELECTRONICDESIGNGMBH</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_LML_33R10</span><span class="p">,</span> <span class="n">LML33R10</span><span class="p">),</span>
	<span class="n">ZR_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_IOMEGA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IOMEGA_BUZ</span><span class="p">,</span> <span class="n">BUZ</span><span class="p">),</span>
	<span class="n">ZR_DEVICE</span><span class="p">(</span><span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">NUM_CARDS</span><span class="p">),</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">zr36067_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">zoran_num</span><span class="p">;</span>		<span class="cm">/* number of cards found */</span>

<span class="cm">/* videocodec bus functions ZR36060 */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">zr36060_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	      <span class="n">u16</span>                <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post_office_wait</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">post_office_read</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zr36060_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	       <span class="n">u16</span>                <span class="n">reg</span><span class="p">,</span>
	       <span class="n">u32</span>                <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post_office_wait</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* videocodec bus functions ZR36050 */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">zr36050_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	      <span class="n">u16</span>                <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post_office_wait</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">// reg. HIGHBYTES</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">post_office_read</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="c1">// reg. LOWBYTES + read</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zr36050_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	       <span class="n">u16</span>                <span class="n">reg</span><span class="p">,</span>
	       <span class="n">u32</span>                <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post_office_wait</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">// reg. HIGHBYTES</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="c1">// reg. LOWBYTES + wr. data</span>
<span class="p">}</span>

<span class="cm">/* videocodec bus functions ZR36016 */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">zr36016_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	      <span class="n">u16</span>                <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post_office_wait</span><span class="p">(</span><span class="n">zr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">post_office_read</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="c1">// read</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hack for in zoran_device.c */</span>
<span class="kt">void</span>
<span class="nf">zr36016_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	       <span class="n">u16</span>                <span class="n">reg</span><span class="p">,</span>
	       <span class="n">u32</span>                <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post_office_wait</span><span class="p">(</span><span class="n">zr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">post_office_write</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">);</span>	<span class="c1">// wr. data</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Board specific information</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc10_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Pixel clock selection */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Enable the video bus sync signals */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc10plus_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">buz_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* some stuff from Iomega */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x90680f15</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00012020</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xc0200000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lml33_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="c1">// Set Composite input/output</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">avs6eyes_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>AverMedia 6-Eyes original driver by Christer Weinigel</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Lifted straight from Christer's old driver and
modified slightly by Martin Samuelsson.</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">mux</span> <span class="o">=</span> <span class="n">default_mux</span><span class="p">;</span> <span class="cm">/* 1 = BT866, 7 = VID1 */</span>

	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Bt866 SLEEP on */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* ZR36060 /RESET on */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* ZR36060 /SLEEP on */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mux</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>   <span class="cm">/* MUX S0 */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* /FRAME on */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Bt866 SLEEP off */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">mux</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>   <span class="cm">/* MUX S1 */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* ? */</span>
	<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">mux</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">);</span>   <span class="cm">/* MUX S2 */</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">codecid_to_modulename</span> <span class="p">(</span><span class="n">u16</span> <span class="n">codecid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">codecid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CODEC_TYPE_ZR36060</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zr36060&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CODEC_TYPE_ZR36050</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zr36050&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CODEC_TYPE_ZR36016</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zr36016&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>struct tvnorm {
     u16 Wt, Wa, HStart, HSyncStart, Ht, Ha, VStart;
};</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f50sqpixel</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">944</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">880</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f60sqpixel</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">780</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">716</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">12</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f50ccir601</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">864</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">804</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">18</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f60ccir601</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">858</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">788</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f50ccir601_lml33</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">864</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">75</span><span class="o">+</span><span class="mi">34</span><span class="p">,</span> <span class="mi">804</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">18</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f60ccir601_lml33</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">858</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">57</span><span class="o">+</span><span class="mi">34</span><span class="p">,</span> <span class="mi">788</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>

<span class="cm">/* The DC10 (57/16/50) uses VActive as HSync, so HStart must be 0 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f50sqpixel_dc10</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">944</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">880</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f60sqpixel_dc10</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">780</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">716</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">12</span> <span class="p">};</span>

<span class="cm">/* FIXME: I cannot swap U and V in saa7114, so i do one</span>
<span class="cm"> * pixel left shift in zoran (75 -&gt; 74)</span>
<span class="cm"> * (Maxim Yevtyushkin &lt;max@linuxmedialabs.com&gt;) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f50ccir601_lm33r10</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">864</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">74</span><span class="o">+</span><span class="mi">54</span><span class="p">,</span> <span class="mi">804</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">18</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f60ccir601_lm33r10</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">858</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">56</span><span class="o">+</span><span class="mi">54</span><span class="p">,</span> <span class="mi">788</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>

<span class="cm">/* FIXME: The ks0127 seem incapable of swapping U and V, too, which is why I</span>
<span class="cm"> * copy Maxim&#39;s left shift hack for the 6 Eyes.</span>
<span class="cm"> *</span>
<span class="cm"> * Christer&#39;s driver used the unshifted norms, though...</span>
<span class="cm"> * /Sam  */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f50ccir601_avs6eyes</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">864</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">804</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">18</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tvnorm</span> <span class="n">f60ccir601_avs6eyes</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">858</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">788</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vpx3220_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">saa7110_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">saa7111_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">saa7114_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">adv717x_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ks0127_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">saa7185_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">bt819_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">bt856_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">bt866_addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">card_info</span> <span class="n">zoran_cards</span><span class="p">[</span><span class="n">NUM_CARDS</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DC10_old</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DC10(old)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;vpx3220a&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">vpx3220_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36050</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_vfe</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36016</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Internal/comp&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="o">|</span><span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel_dc10</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60sqpixel_dc10</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel_dc10</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dc10_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DC10_new</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DC10(new)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;saa7110&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">saa7110_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;adv7175&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">adv717x_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36060</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
				<span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">},</span>
				<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Internal/comp&quot;</span> <span class="p">}</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="o">|</span><span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
				<span class="o">&amp;</span><span class="n">f50sqpixel</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">f60sqpixel</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">f50sqpixel</span><span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dc10plus_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DC10plus</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DC10plus&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;saa7110&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">saa7110_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;adv7175&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">adv717x_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36060</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Internal/comp&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="o">|</span><span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60sqpixel</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dc10plus_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DC30</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DC30&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;vpx3220a&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">vpx3220_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;adv7175&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">adv717x_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36050</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_vfe</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36016</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Internal/comp&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="o">|</span><span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel_dc10</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60sqpixel_dc10</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel_dc10</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dc10_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DC30plus</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DC30plus&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;vpx3220a&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">vpx3220_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;adv7175&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">adv717x_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36050</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_vfe</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36016</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Internal/comp&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="o">|</span><span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel_dc10</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60sqpixel_dc10</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f50sqpixel_dc10</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dc10_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">LML33</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;LML33&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;bt819a&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">bt819_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;bt856&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">bt856_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36060</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50ccir601_lml33</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60ccir601_lml33</span><span class="p">,</span>
			<span class="nb">NULL</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lml33_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">LML33R10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;LML33R10&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;saa7114&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">saa7114_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;adv7170&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">adv717x_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36060</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50ccir601_lm33r10</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60ccir601_lm33r10</span><span class="p">,</span>
			<span class="nb">NULL</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lml33_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BUZ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Buz&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;saa7111&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">saa7111_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;saa7185&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">saa7185_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36060</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="o">|</span><span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50ccir601</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60ccir601</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f50ccir601</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buz_init</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AVS6EYES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;6-Eyes&quot;</span><span class="p">,</span>
		<span class="cm">/* AverMedia chose not to brand the 6-Eyes. Thus it</span>
<span class="cm">		   can&#39;t be autodetected, and requires card=x. */</span>
		<span class="p">.</span><span class="n">i2c_decoder</span> <span class="o">=</span> <span class="s">&quot;ks0127&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_decoder</span> <span class="o">=</span> <span class="n">ks0127_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i2c_encoder</span> <span class="o">=</span> <span class="s">&quot;bt866&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrs_encoder</span> <span class="o">=</span> <span class="n">bt866_addrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_codec</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36060</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Composite 1&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Composite 2&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Composite 3&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Composite 4&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Composite 5&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Composite 6&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;S-Video 1&quot;</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&quot;S-Video 2&quot;</span> <span class="p">},</span>
			<span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="s">&quot;S-Video 3&quot;</span> <span class="p">},</span>
			<span class="p">{</span><span class="mi">15</span><span class="p">,</span> <span class="s">&quot;YCbCr&quot;</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">norms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="o">|</span><span class="n">V4L2_STD_PAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tvn</span> <span class="o">=</span> <span class="p">{</span>
			<span class="o">&amp;</span><span class="n">f50ccir601_avs6eyes</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">f60ccir601_avs6eyes</span><span class="p">,</span>
			<span class="nb">NULL</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">jpeg_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_int</span> <span class="o">=</span> <span class="n">ZR36057_ISR_GIRQ0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span><span class="c1">// Validity unknown /Sam</span>
		<span class="p">.</span><span class="n">gpio_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="c1">// Validity unknown /Sam</span>
		<span class="p">.</span><span class="n">gpcs</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>			<span class="c1">// Validity unknown /Sam</span>
		<span class="p">.</span><span class="n">vfe_pol</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>  <span class="c1">// Validity unknown /Sam</span>
		<span class="p">.</span><span class="n">gws_not_connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_mux</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">avs6eyes_init</span><span class="p">,</span>
	<span class="p">}</span>

<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * I2C functions</span>
<span class="cm"> */</span>
<span class="cm">/* software I2C functions */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_i2c_getsda</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">btread</span><span class="p">(</span><span class="n">ZR36057_I2CBR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_i2c_getscl</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">btread</span><span class="p">(</span><span class="n">ZR36057_I2CBR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zoran_i2c_setsda</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		  <span class="kt">int</span>   <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2cbr</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2cbr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2cbr</span><span class="p">,</span> <span class="n">ZR36057_I2CBR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zoran_i2c_setscl</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		  <span class="kt">int</span>   <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2cbr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2cbr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2cbr</span><span class="p">,</span> <span class="n">ZR36057_I2CBR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_algo_bit_data</span> <span class="n">zoran_i2c_bit_data_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">setsda</span> <span class="o">=</span> <span class="n">zoran_i2c_setsda</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setscl</span> <span class="o">=</span> <span class="n">zoran_i2c_setscl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsda</span> <span class="o">=</span> <span class="n">zoran_i2c_getsda</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getscl</span> <span class="o">=</span> <span class="n">zoran_i2c_getscl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udelay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_register_i2c</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_algo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zoran_i2c_bit_data_template</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_bit_data</span><span class="p">));</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_algo</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">zr</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_algo</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2c_bit_add_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zoran_unregister_i2c</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Check a zoran_params struct for correctness, insert default params */</span>

<span class="kt">int</span>
<span class="nf">zoran_check_jpg_settings</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span>              <span class="o">*</span><span class="n">zr</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="o">*</span><span class="n">settings</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">try</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">KERN_DEBUG</span>
		<span class="s">&quot;%s: %s - dec: %d, Hdcm: %d, Vdcm: %d, Tdcm: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span><span class="p">,</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">KERN_DEBUG</span>
		<span class="s">&quot;%s: %s - x: %d, y: %d, w: %d, y: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">,</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">);</span>
	<span class="cm">/* Check decimation, set default values for decimation = 1, 2, 4 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:

		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:

		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">704</span> <span class="o">:</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DC10_new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_DEBUG</span>
				<span class="s">&quot;%s: %s - HDec by 4 is not supported on the DC10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">704</span> <span class="o">:</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:

		<span class="cm">/* We have to check the data the user has set */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DC10_new</span> <span class="o">||</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">field_per_buff</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">settings</span><span class="o">-&gt;</span><span class="n">field_per_buff</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">field_per_buff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">BUZ_MAX_WIDTH</span><span class="p">);</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">+</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span> <span class="o">-</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">;</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">+</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">;</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">%</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">-=</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">%</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span><span class="p">;</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">-=</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">settings</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span><span class="p">;</span>
			<span class="n">err0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try</span> <span class="o">&amp;&amp;</span> <span class="n">err0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - error in params for decimation = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - decimation = %d, must be 0, 1, 2 or 4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">);</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APPn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APPn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APPn</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APPn</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_len</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_len</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_len</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">settings</span><span class="o">-&gt;</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_len</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">zoran_open_init_params</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* User must explicitly set a window */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_mask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_overlay_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_grab_frame</span> <span class="o">=</span> <span class="n">NO_GRAB_ACTIVE</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_grab_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">144</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zoran_formats</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* YUY2 - YUV-4:2:2 packed */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span>
	    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span>
	    <span class="p">((</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* DMA ring stuff for V4L */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_sync_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VIDEO_MAX_FRAME</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_USER</span><span class="p">;</span>	<span class="cm">/* nothing going on */</span>
	<span class="p">}</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BUZ_MAX_FRAME</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_USER</span><span class="p">;</span>	<span class="cm">/* nothing going on */</span>
	<span class="p">}</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Set necessary params and call zoran_check_jpg_settings to set the defaults */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">decimation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* default compression factor 8 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">BUZ</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APPn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No APPn marker */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_data</span><span class="p">));</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No COM marker */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_data</span><span class="p">));</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">jpeg_markers</span> <span class="o">=</span>
	    <span class="n">V4L2_JPEG_MARKER_DHT</span> <span class="o">|</span> <span class="n">V4L2_JPEG_MARKER_DQT</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">zoran_check_jpg_settings</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s internal error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">clear_interrupt_counters</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">testing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">test_interrupts</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">icr</span><span class="p">;</span>

	<span class="n">clear_interrupt_counters</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">testing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">icr</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">ZR36057_ICR</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x78000000</span> <span class="o">|</span> <span class="n">ZR36057_ICR_IntPinEn</span><span class="p">,</span> <span class="n">ZR36057_ICR</span><span class="p">);</span>
	<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">test_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">test_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ZR36057_ICR</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x78000000</span><span class="p">,</span> <span class="n">ZR36057_ISR</span><span class="p">);</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">testing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: Testing interrupts...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;: time spent: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">-</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr36067_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">print_interrupts</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">ZR36057_ICR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">zr36057_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">KERN_INFO</span>
		<span class="s">&quot;%s: %s - initializing card[%d], zr=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">zr</span><span class="p">);</span>

	<span class="cm">/* default setup of all parameters which will persist between opens */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_capq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_capq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">test_q</span><span class="p">);</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">vidmem</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Avoid nonsense settings from user for default input/norm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_norm</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">default_norm</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">default_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">tvn</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">default_norm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">tvn</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">tvn</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s: %s - default TV standard not supported by hardware. PAL will be used.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">tvn</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">default_input</span> <span class="o">&gt;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">inputs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s: default_input value %d out of range (0-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">default_input</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">inputs</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">default_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">default_input</span><span class="p">;</span>

	<span class="cm">/* default setup (will be repeated at every open) */</span>
	<span class="n">zoran_open_init_params</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>

	<span class="cm">/* allocate memory *before* doing anything to the hardware</span>
<span class="cm">	 * in case allocation fails */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">stat_com</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">BUZ_NUM_STAT_COM</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">stat_com</span> <span class="o">||</span> <span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - kmalloc (STAT_COM) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BUZ_NUM_STAT_COM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">stat_com</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* mark as unavailable to zr36057 */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *   Now add the template and register the device unit.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zoran_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zoran_template</span><span class="p">));</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="n">video_nr</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">zr</span><span class="p">);</span>

	<span class="n">zoran_init_hardware</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr36067_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">detect_guest_activity</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="n">test_interrupts</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pass_through</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">encoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">zoran_proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">stat_com</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">zoran_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">to_zoran</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>

	<span class="cm">/* unregister videocodec bus */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">videocodec_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="p">;</span>

		<span class="n">videocodec_detach</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vfe</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">videocodec_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">vfe</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="p">;</span>

		<span class="n">videocodec_detach</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vfe</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* unregister i2c bus */</span>
	<span class="n">zoran_unregister_i2c</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="cm">/* disable PCI bus-mastering */</span>
	<span class="n">zoran_set_pci_master</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* put chip into reset */</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ZR36057_SPGPPCR</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">zr</span><span class="p">);</span>
	<span class="cm">/* unmap and free memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">stat_com</span><span class="p">);</span>
	<span class="n">zoran_proc_cleanup</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">zr36057_mem</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
<span class="nl">exit_free:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">zoran_vdev_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videocodec_master</span> <span class="o">*</span> <span class="n">__devinit</span>
<span class="nf">zoran_setup_videocodec</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">,</span>
			<span class="kt">int</span>           <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videocodec_master</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">videocodec_master</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* magic and type are unused for master struct. Makes sense only at</span>
<span class="cm">	   codec structs.</span>
<span class="cm">	   In the past, .type were initialized to the old V4L1 .hardware</span>
<span class="cm">	   value, as VID_HARDWARE_ZR36067</span>
<span class="cm">	 */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CODEC_FLAG_ENCODER</span> <span class="o">|</span> <span class="n">CODEC_FLAG_DECODER</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">zr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">CODEC_TYPE_ZR36060</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">readreg</span> <span class="o">=</span> <span class="n">zr36060_read</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">writereg</span> <span class="o">=</span> <span class="n">zr36060_write</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CODEC_FLAG_JPEG</span> <span class="o">|</span> <span class="n">CODEC_FLAG_VFE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CODEC_TYPE_ZR36050</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">readreg</span> <span class="o">=</span> <span class="n">zr36050_read</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">writereg</span> <span class="o">=</span> <span class="n">zr36050_write</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CODEC_FLAG_JPEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CODEC_TYPE_ZR36016</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">readreg</span> <span class="o">=</span> <span class="n">zr36016_read</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">writereg</span> <span class="o">=</span> <span class="n">zr36016_write</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CODEC_FLAG_VFE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zoran_subdev_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">to_zoran</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="cm">/* Bt819 needs to reset its FIFO buffer using #FRST pin and</span>
<span class="cm">	   LML33 card uses GPIO(7) for that. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BT819_FIFO_RESET_LOW</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BT819_FIFO_RESET_HIGH</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Scan for a Buz card (actually for the PCI controller ZR36057),</span>
<span class="cm"> *   request the irq and map the io memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">zoran_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">latency</span><span class="p">,</span> <span class="n">need_latency</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videocodec_master</span> <span class="o">*</span><span class="n">master_vfe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videocodec_master</span> <span class="o">*</span><span class="n">master_codec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">card_num</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">codec_name</span><span class="p">,</span> <span class="o">*</span><span class="n">vfe_name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>


	<span class="n">nr</span> <span class="o">=</span> <span class="n">zoran_num</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;=</span> <span class="n">BUZ_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: driver limited to %d card(s) maximum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZORAN_NAME</span><span class="p">,</span> <span class="n">BUZ_MAX</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - kzalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZORAN_NAME</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">zoran_subdev_notify</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">zr_free_mem</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">)),</span> <span class="s">&quot;MJPEG[%u]&quot;</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">zr_unreg</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">KERN_INFO</span>
		<span class="s">&quot;%s: Zoran ZR360%c7 (rev %d), irq: %d, memory: 0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="sc">&#39;5&#39;</span> <span class="o">:</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_INFO</span>
			<span class="s">&quot;%s: Subsystem vendor=0x%04x id=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Use auto-detected card type? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: No card type specified, please use the card=X module parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: It is not possible to auto-detect ZR36057 based cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">zr_unreg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">card_num</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card_num</span> <span class="o">&gt;=</span> <span class="n">NUM_CARDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: Unknown card, try specifying card=X module parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">zr_unreg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
			<span class="n">KERN_DEBUG</span>
			<span class="s">&quot;%s: %s() - card %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">zoran_cards</span><span class="p">[</span><span class="n">card_num</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card_num</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card_num</span> <span class="o">&gt;=</span> <span class="n">NUM_CARDS</span> <span class="o">||</span> <span class="n">card_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: User specified card type %d out of range (0 .. %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">card_num</span><span class="p">,</span> <span class="n">NUM_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">zr_unreg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* even though we make this a non pointer and thus</span>
<span class="cm">	 * theoretically allow for making changes to this struct</span>
<span class="cm">	 * on a per-individual card basis at runtime, this is</span>
<span class="cm">	 * strongly discouraged. This structure is intended to</span>
<span class="cm">	 * keep general card information, no settings or anything */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">zoran_cards</span><span class="p">[</span><span class="n">card_num</span><span class="p">];</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">)),</span>
		 <span class="s">&quot;%s[%u]&quot;</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">zr36057_mem</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">zr36057_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s() - ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">zr_unreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">zoran_irq</span><span class="p">,</span>
			     <span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">zr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - bad irq number or handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - IRQ %d busy, change your PnP config in BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - can&#39;t assign irq, error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">zr_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set PCI latency timer */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">latency</span><span class="p">);</span>
	<span class="n">need_latency</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">48</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">latency</span> <span class="o">!=</span> <span class="n">need_latency</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: Changing PCI latency from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">latency</span><span class="p">,</span> <span class="n">need_latency</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>
				      <span class="n">need_latency</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">zr36057_restart</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="cm">/* i2c */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: Initializing i2c bus...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zoran_register_i2c</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - can&#39;t initialize i2c bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">zr_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">i2c_decoder</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">addrs_decoder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">i2c_encoder</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">i2c_encoder</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">addrs_encoder</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		<span class="n">KERN_INFO</span> <span class="s">&quot;%s: Initializing videocodec bus...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec_name</span> <span class="o">=</span> <span class="n">codecid_to_modulename</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">request_module</span><span class="p">(</span><span class="n">codec_name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">KERN_ERR</span>
					<span class="s">&quot;%s: failed to load modules %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">codec_name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_vfe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfe_name</span> <span class="o">=</span> <span class="n">codecid_to_modulename</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_vfe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vfe_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">request_module</span><span class="p">(</span><span class="n">vfe_name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">KERN_ERR</span>
					<span class="s">&quot;%s: failed to load modules %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">vfe_name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* reset JPEG codec */</span>
	<span class="n">jpeg_codec_sleep</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">jpeg_codec_reset</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
	<span class="cm">/* video bus enabled */</span>
	<span class="cm">/* display codec revision */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_codec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_codec</span> <span class="o">=</span> <span class="n">zoran_setup_videocodec</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_codec</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">zr_unreg_i2c</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">videocodec_attach</span><span class="p">(</span><span class="n">master_codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - no codec found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">zr_free_codec</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_codec</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - wrong codec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">zr_detach_codec</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_vfe</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_vfe</span> <span class="o">=</span> <span class="n">zoran_setup_videocodec</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_vfe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_vfe</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">zr_detach_codec</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vfe</span> <span class="o">=</span> <span class="n">videocodec_attach</span><span class="p">(</span><span class="n">master_vfe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vfe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - no VFE found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">zr_free_vfe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vfe</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">video_vfe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s = wrong VFE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">zr_detach_vfe</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* take care of Natoma chipset and a revision 1 zr36057 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="n">PCIPCI_NATOMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">need_contiguous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span>
			<span class="s">&quot;%s: ZR36057/Natoma bug, max. buffer size is 128K</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr36057_init</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">zr_detach_vfe</span><span class="p">;</span>

	<span class="n">zoran_proc_init</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">zr_detach_vfe:</span>
	<span class="n">videocodec_detach</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vfe</span><span class="p">);</span>
<span class="nl">zr_free_vfe:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">master_vfe</span><span class="p">);</span>
<span class="nl">zr_detach_codec:</span>
	<span class="n">videocodec_detach</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
<span class="nl">zr_free_codec:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">master_codec</span><span class="p">);</span>
<span class="nl">zr_unreg_i2c:</span>
	<span class="n">zoran_unregister_i2c</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
<span class="nl">zr_free_irq:</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ZR36057_SPGPPCR</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">zr</span><span class="p">);</span>
<span class="nl">zr_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">zr36057_mem</span><span class="p">);</span>
<span class="nl">zr_unreg:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">zr_free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">zoran_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zr36067&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">zr36067_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">zoran_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">zoran_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">zoran_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Zoran MJPEG board driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ZORAN_VERSION</span><span class="p">);</span>

	<span class="cm">/* check the parameters we have been given, adjust if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l_nbufs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">v4l_nbufs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l_nbufs</span> <span class="o">&gt;</span> <span class="n">VIDEO_MAX_FRAME</span><span class="p">)</span>
		<span class="n">v4l_nbufs</span> <span class="o">=</span> <span class="n">VIDEO_MAX_FRAME</span><span class="p">;</span>
	<span class="cm">/* The user specfies the in KB, we want them in byte</span>
<span class="cm">	 * (and page aligned) */</span>
	<span class="n">v4l_bufsize</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">v4l_bufsize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l_bufsize</span> <span class="o">&lt;</span> <span class="mi">32768</span><span class="p">)</span>
		<span class="n">v4l_bufsize</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>
	<span class="cm">/* 2 MB is arbitrary but sufficient for the maximum possible images */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l_bufsize</span> <span class="o">&gt;</span> <span class="mi">2048</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">v4l_bufsize</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jpg_nbufs</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">jpg_nbufs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jpg_nbufs</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_FRAME</span><span class="p">)</span>
		<span class="n">jpg_nbufs</span> <span class="o">=</span> <span class="n">BUZ_MAX_FRAME</span><span class="p">;</span>
	<span class="n">jpg_bufsize</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">jpg_bufsize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jpg_bufsize</span> <span class="o">&lt;</span> <span class="mi">8192</span><span class="p">)</span>
		<span class="n">jpg_bufsize</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jpg_bufsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
		<span class="n">jpg_bufsize</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="cm">/* Use parameter for vidmem or try to find a video card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vidmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_INFO</span>
			<span class="s">&quot;%s: Using supplied video memory base address @ 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZORAN_NAME</span><span class="p">,</span> <span class="n">vidmem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* some mainboards might not do PCI-PCI data transfer well */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCIPCI_FAIL</span><span class="o">|</span><span class="n">PCIAGP_FAIL</span><span class="o">|</span><span class="n">PCIPCI_ALIMAGIK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s: chipset does not support reliable PCI-PCI DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZORAN_NAME</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zoran_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: Unable to register ZR36057 driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZORAN_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">zoran_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zoran_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">zoran_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">zoran_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
