<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › zoran › zoran_driver.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>zoran_driver.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Zoran zr36057/zr36067 PCI controller driver, for the</span>
<span class="cm"> * Pinnacle/Miro DC10/DC10+/DC30/DC30+, Iomega Buz, Linux</span>
<span class="cm"> * Media Labs LML33/LML33R10.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000 Serguei Miridonov &lt;mirsev@cicese.mx&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Changes for BUZ by Wolfgang Scherr &lt;scherr@net4you.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Changes for DC10/DC30 by Laurent Pinchart &lt;laurent.pinchart@skynet.be&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Changes for LML33R10 by Maxim Yevtyushkin &lt;max@linuxmedialabs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Changes for videodev2/v4l2 by Ronald Bultje &lt;rbultje@ronald.bitfreak.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on</span>
<span class="cm"> *</span>
<span class="cm"> * Miro DC10 driver</span>
<span class="cm"> * Copyright (C) 1999 Wolfgang Scherr &lt;scherr@net4you.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Iomega Buz driver version 1.0</span>
<span class="cm"> * Copyright (C) 1999 Rainer Johanni &lt;Rainer@Johanni.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * buz.0.0.3</span>
<span class="cm"> * Copyright (C) 1998 Dave Perks &lt;dperks@ibm.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * bttv - Bt848 frame grabber driver</span>
<span class="cm"> * Copyright (C) 1996,97,98 Ralph  Metzler (rjkm@thp.uni-koeln.de)</span>
<span class="cm"> *                        &amp; Marcus Metzler (mocm@thp.uni-koeln.de)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-algo-bit.h&gt;</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &quot;videocodec.h&quot;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>

<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &quot;zoran.h&quot;</span>
<span class="cp">#include &quot;zoran_device.h&quot;</span>
<span class="cp">#include &quot;zoran_card.h&quot;</span>


<span class="k">const</span> <span class="k">struct</span> <span class="n">zoran_format</span> <span class="n">zoran_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;15-bit RGB LE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_RGB555</span><span class="o">|</span><span class="n">ZR36057_VFESPFR_ErrDif</span><span class="o">|</span>
			   <span class="n">ZR36057_VFESPFR_LittleEndian</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;15-bit RGB BE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB555X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_RGB555</span><span class="o">|</span><span class="n">ZR36057_VFESPFR_ErrDif</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;16-bit RGB LE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_RGB565</span><span class="o">|</span><span class="n">ZR36057_VFESPFR_ErrDif</span><span class="o">|</span>
			   <span class="n">ZR36057_VFESPFR_LittleEndian</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;16-bit RGB BE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_RGB565</span><span class="o">|</span><span class="n">ZR36057_VFESPFR_ErrDif</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;24-bit RGB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_BGR24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_RGB888</span><span class="o">|</span><span class="n">ZR36057_VFESPFR_Pack24</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;32-bit RGB LE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_BGR32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_RGB888</span><span class="o">|</span><span class="n">ZR36057_VFESPFR_LittleEndian</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;32-bit RGB BE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_RGB888</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4:2:2, packed, YUYV&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_YUV422</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4:2:2, packed, UYVY&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfespfr</span> <span class="o">=</span> <span class="n">ZR36057_VFESPFR_YUV422</span><span class="o">|</span><span class="n">ZR36057_VFESPFR_LittleEndian</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hardware-encoded Motion-JPEG&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ZORAN_FORMAT_CAPTURE</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_PLAYBACK</span> <span class="o">|</span>
			 <span class="n">ZORAN_FORMAT_COMPRESSED</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#define NUM_FORMATS ARRAY_SIZE(zoran_formats)</span>

	<span class="cm">/* small helper function for calculating buffersizes for v4l2</span>
<span class="cm">	 * we calculate the nearest higher power-of-two, which</span>
<span class="cm">	 * will be the recommended buffersize */</span>
<span class="k">static</span> <span class="n">__u32</span>
<span class="nf">zoran_v4l2_calc_bufsize</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="o">*</span><span class="n">settings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">div</span> <span class="o">=</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">VerDcm</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">HorDcm</span> <span class="o">*</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">TmpDcm</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">div</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">num</span><span class="o">--</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">jpg_bufsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">jpg_bufsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">8192</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* forward references */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">v4l_fbuffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">jpg_fbuffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">);</span>

<span class="cm">/* Set mapping mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">map_mode_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">=</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">v4l_bufsize</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">=</span> <span class="n">v4l_nbufs</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">map_mode_jpg</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">play</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">=</span> <span class="n">play</span> <span class="o">?</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span> <span class="o">:</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">jpg_bufsize</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">=</span> <span class="n">jpg_nbufs</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mode_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">zoran_map_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span> <span class="o">?</span> <span class="s">&quot;V4L&quot;</span> <span class="o">:</span> <span class="s">&quot;JPG&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Allocate the V4L grab buffers</span>
<span class="cm"> *</span>
<span class="cm"> *   These have to be pysically contiguous.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">v4l_fbuffer_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">KERN_WARNING</span>
				<span class="s">&quot;%s: %s - buffer %d already allocated!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>udelay(20);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">,</span>
			      <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - kmalloc for V4L buf %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">v4l_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer_phys</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer_bus</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
		     <span class="n">off</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">mem</span> <span class="o">+</span> <span class="n">off</span><span class="p">));</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
			<span class="n">KERN_INFO</span>
			<span class="s">&quot;%s: %s - V4L frame %d mem 0x%lx (bus: 0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* free the V4L grab buffers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">v4l_fbuffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mem</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
		     <span class="n">off</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">mem</span> <span class="o">+</span> <span class="n">off</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer</span><span class="p">);</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Allocate the MJPEG grab buffers.</span>
<span class="cm"> *</span>
<span class="cm"> *   If a Natoma chipset is present and this is a revision 1 zr36057,</span>
<span class="cm"> *   each MJPEG buffer needs to be physically contiguous.</span>
<span class="cm"> *   (RJ: This statement is from Dave Perks&#39; original driver,</span>
<span class="cm"> *   I could never check it because I have a zr36067)</span>
<span class="cm"> *</span>
<span class="cm"> *   RJ: The contents grab buffers needs never be accessed in the driver.</span>
<span class="cm"> *       Therefore there is no need to allocate them with vmalloc in order</span>
<span class="cm"> *       to get a contiguous virtual memory space.</span>
<span class="cm"> *       I don&#39;t understand why many other drivers first allocate them with</span>
<span class="cm"> *       vmalloc (which uses internally also get_zeroed_page, but delivers you</span>
<span class="cm"> *       virtual addresses) and then again have to make a lot of efforts</span>
<span class="cm"> *       to get the physical address.</span>
<span class="cm"> *</span>
<span class="cm"> *   Ben Capper:</span>
<span class="cm"> *       On big-endian architectures (such as ppc) some extra steps</span>
<span class="cm"> *       are needed. When reading and writing to the stat_com array</span>
<span class="cm"> *       and fragment buffers, the device expects to see little-</span>
<span class="cm"> *       endian values. The use of cpu_to_le32() and le32_to_cpu()</span>
<span class="cm"> *       in this function (and one or two others in zoran_device.c)</span>
<span class="cm"> *       ensure that these values are always stored in little-endian</span>
<span class="cm"> *       form, regardless of architecture. The zr36057 does Very Bad</span>
<span class="cm"> *       Things on big endian architectures if the stat_com array</span>
<span class="cm"> *       and fragment buffers are not little-endian.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jpg_fbuffer_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">KERN_WARNING</span>
				<span class="s">&quot;%s: %s - buffer %d already allocated!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* Allocate fragment table for this buffer */</span>

		<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - get_zeroed_page (frag_tab) failed for buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">jpg_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">mem</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab_bus</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">need_contiguous</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">KERN_ERR</span>
					<span class="s">&quot;%s: %s - kmalloc failed for buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">jpg_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span> <span class="n">off</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
				<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">mem</span> <span class="o">+</span> <span class="n">off</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* jpg_bufsize is already page aligned */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
						<span class="n">KERN_ERR</span>
						<span class="s">&quot;%s: %s - get_zeroed_page failed for buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">jpg_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
				<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s - %d KB allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* free the MJPEG grab buffers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">jpg_fbuffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">frag_tab</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buffer</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">need_contiguous</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frag_tab</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frag_tab</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mem</span> <span class="o">=</span> <span class="n">bus_to_virt</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">frag_tab</span><span class="p">));</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span> <span class="n">off</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
					<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">mem</span> <span class="o">+</span> <span class="n">off</span><span class="p">));</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frag_tab</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag_tab</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">bus_to_virt</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">frag_tab</span><span class="p">))));</span>
				<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bus_to_virt</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">frag_tab</span><span class="p">)));</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">);</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   V4L Buffer grabbing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_v4l_set_format</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span>           <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		      <span class="kt">int</span>                        <span class="n">width</span><span class="p">,</span>
		      <span class="kt">int</span>                        <span class="n">height</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">zoran_format</span> <span class="o">*</span><span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="cm">/* Check size and format of the grab wanted */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">BUZ_MIN_HEIGHT</span> <span class="o">||</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">BUZ_MIN_WIDTH</span> <span class="o">||</span>
	    <span class="n">height</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">||</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - wrong frame size (%dx%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Check against available buffer size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">&gt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - video buffer size (%d kB) is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The video front end needs 4-byte alinged line sizes */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - wrong frame alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_v4l_queue_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - buffers not yet allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No grabbing outside the buffer range! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">||</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - buffer %d is out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - another session is already capturing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* make sure a grab isn&#39;t going on currently with this buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">BUZ_STATE_PEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
				<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* what are you doing? */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BUZ_STATE_DONE</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">KERN_WARNING</span>
				<span class="s">&quot;%s: %s - queueing buffer %d in state DONE!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">BUZ_STATE_USER</span>:
			<span class="cm">/* since there is at least one unused buffer there&#39;s room for at least</span>
<span class="cm">			 * one more pend[] entry */</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_head</span><span class="o">++</span> <span class="o">&amp;</span> <span class="n">V4L_MASK_FRAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_PEND</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
			    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*</span>
			    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sync on a V4L buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">v4l_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - no grab active for this session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check passed-in frame number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">||</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - frame %d is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if is buffer was queued at all */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUZ_STATE_USER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - attempt to sync on a buffer which was not queued?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait on this buffer to get ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_capq</span><span class="p">,</span>
		<span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUZ_STATE_PEND</span><span class="p">),</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="cm">/* buffer should now be in BUZ_STATE_DONE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUZ_STATE_DONE</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - internal state error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_USER</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check if streaming capture has finished */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_tail</span> <span class="o">==</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr36057_set_memgrab</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Queue a MJPEG buffer for capture/playback</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_jpg_queue_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">zoran_codec_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check if buffers are allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - buffers not yet allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No grabbing outside the buffer range! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">||</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - buffer %d out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* what is the codec mode right now? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">BUZ_MODE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wrong codec mode active - invalid */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - codec in wrong mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - another session is already capturing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">BUZ_MODE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ok load up the jpeg codec */</span>
		<span class="n">zr36057_enable_jpg</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BUZ_STATE_DONE</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">KERN_WARNING</span>
				<span class="s">&quot;%s: %s - queing frame in BUZ_STATE_DONE state!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">BUZ_STATE_USER</span>:
			<span class="cm">/* since there is at least one unused buffer there&#39;s room for at</span>
<span class="cm">			 *least one more pend[] entry */</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_head</span><span class="o">++</span> <span class="o">&amp;</span> <span class="n">BUZ_MASK_FRAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_PEND</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
			<span class="n">zoran_feed_stat_com</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">BUZ_STATE_DMA</span>:
		<span class="k">case</span> <span class="n">BUZ_STATE_PEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
				<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* what are you doing? */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jpg_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame</span><span class="p">,</span> <span class="k">enum</span> <span class="n">zoran_codec_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Does the user want to stop streaming? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">KERN_ERR</span>
					<span class="s">&quot;%s: %s(-1) - session not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">zr36057_enable_jpg</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">BUZ_MODE_IDLE</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - stop streaming but not in streaming mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">zoran_jpg_queue_frame</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">mode</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* Start the jpeg codec when the first frame is queued  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_head</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">jpeg_start</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Sync on a MJPEG buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jpg_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zoran_sync</span> <span class="o">*</span><span class="n">bs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - capture is not currently active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">!=</span> <span class="n">BUZ_MODE_MOTION_DECOMPRESS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">!=</span> <span class="n">BUZ_MODE_MOTION_COMPRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - codec not in streaming mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_capq</span><span class="p">,</span>
			<span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_tail</span> <span class="o">!=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_dma_tail</span> <span class="o">||</span>
			 <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_dma_tail</span> <span class="o">==</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_dma_head</span><span class="p">),</span>
			<span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">isr</span><span class="p">;</span>

		<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">ZR36057_JMC_Go_en</span><span class="p">,</span> <span class="n">ZR36057_JMC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">CODEC_G_STATUS</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">isr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">isr</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - timeout: codec isr=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_dma_tail</span> <span class="o">!=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_dma_head</span><span class="p">)</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_tail</span><span class="o">++</span> <span class="o">&amp;</span> <span class="n">BUZ_MASK_FRAME</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_tail</span> <span class="o">&amp;</span> <span class="n">BUZ_MASK_FRAME</span><span class="p">];</span>

	<span class="cm">/* buffer should now be in BUZ_STATE_DONE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUZ_STATE_DONE</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - internal state error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bs</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">bs</span><span class="p">;</span>
	<span class="n">bs</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_USER</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">];</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zoran_open_init_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="cm">/* Per default, map the V4L Buffers */</span>
	<span class="n">map_mode_raw</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="cm">/* take over the card&#39;s current settings */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>

	<span class="cm">/* v4l settings */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">;</span>
	<span class="cm">/* jpg settings */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">;</span>

	<span class="cm">/* buffers */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FRAME</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_USER</span><span class="p">;</span>	<span class="cm">/* nothing going on */</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zoran_close_end_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="cm">/* overlay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_overlay_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span><span class="p">)</span>
			<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_mask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* v4l capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">zr36057_set_memgrab</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* v4l buffers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span>
			<span class="n">v4l_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* jpg capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zr36057_enable_jpg</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">BUZ_MODE_IDLE</span><span class="p">);</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* jpg buffers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span>
			<span class="n">jpg_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Open a zoran card. Right now the flags stuff is just playing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">first_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s(%s, pid=[%d]), users(-)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: too many users (%d) on device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now, create the open()-specific file_ops struct */</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - allocation of zoran_fh failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* used to be BUZ_MAX_WIDTH/HEIGHT, but that gives overflows</span>
<span class="cm">	 * on norm-change! */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_mask</span> <span class="o">=</span>
	    <span class="n">kmalloc</span><span class="p">(((</span><span class="mi">768</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">576</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - allocation of overlay_mask failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_fh</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">first_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*mutex_unlock(&amp;zr-&gt;resource_lock);*/</span>

	<span class="cm">/* default setup - TODO: look at flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_open</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* First device open */</span>
		<span class="n">zr36057_restart</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
		<span class="n">zoran_open_init_params</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
		<span class="n">zoran_init_hardware</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>

		<span class="n">btor</span><span class="p">(</span><span class="n">ZR36057_ICR_IntPinEn</span><span class="p">,</span> <span class="n">ZR36057_ICR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set file_ops stuff */</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span> <span class="o">=</span> <span class="n">zr</span><span class="p">;</span>
	<span class="n">zoran_open_init_session</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_fh:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
<span class="nl">fail_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: open failed (%d), users(-)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">res</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span>  <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s(%s, pid=[%d]), users(+)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* kernel locks (fs/device.c), so don&#39;t do that ourselves</span>
<span class="cm">	 * (prevents deadlocks) */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>

	<span class="n">zoran_close_end_session</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">--</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Last process */</span>
		<span class="cm">/* Clean up JPEG process */</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_capq</span><span class="p">);</span>
		<span class="n">zr36057_enable_jpg</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">BUZ_MODE_IDLE</span><span class="p">);</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>

		<span class="cm">/* disable interrupts */</span>
		<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">ZR36057_ICR_IntPinEn</span><span class="p">,</span> <span class="n">ZR36057_ICR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zr36067_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">print_interrupts</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>

		<span class="cm">/* Overlay off */</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_overlay_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_mask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* capture off */</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_capq</span><span class="p">);</span>
		<span class="n">zr36057_set_memgrab</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
		<span class="n">zoran_set_pci_master</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pass_through</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Switch to color bar */</span>
			<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">encoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_mask</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">zoran_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	    <span class="kt">char</span>        <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	    <span class="kt">size_t</span>       <span class="n">count</span><span class="p">,</span>
	    <span class="n">loff_t</span>      <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* we simply don&#39;t support read() (yet)... */</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">zoran_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	     <span class="k">const</span> <span class="kt">char</span>  <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	     <span class="kt">size_t</span>       <span class="n">count</span><span class="p">,</span>
	     <span class="n">loff_t</span>      <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ...and the same goes for write() */</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_fbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
	       <span class="kt">void</span>                      <span class="o">*</span><span class="n">base</span><span class="p">,</span>
	       <span class="k">const</span> <span class="k">struct</span> <span class="n">zoran_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
	       <span class="kt">int</span>                        <span class="n">width</span><span class="p">,</span>
	       <span class="kt">int</span>                        <span class="n">height</span><span class="p">,</span>
	       <span class="kt">int</span>                        <span class="n">bytesperline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="cm">/* (Ronald) v4l/v4l2 guidelines */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t allow frame buffer overlay if PCI or AGP is buggy, or on</span>
<span class="cm">	   ALi Magik (that needs very low latency while the card needs a</span>
<span class="cm">	   higher value always) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCIPCI_FAIL</span> <span class="o">|</span> <span class="n">PCIAGP_FAIL</span> <span class="o">|</span> <span class="n">PCIPCI_ALIMAGIK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* we need a bytesperline value, even if not given */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bytesperline</span><span class="p">)</span>
		<span class="n">bytesperline</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="p">((</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (zr-&gt;overlay_active) {</span>
<span class="c">		/* dzjee... stupid users... don&#39;t even bother to turn off</span>
<span class="c">		 * overlay before changing the memory location...</span>
<span class="c">		 * normally, we would return errors here. However, one of</span>
<span class="c">		 * the tools that does this is... xawtv! and since xawtv</span>
<span class="c">		 * is used by +/- 99% of the users, we&#39;d rather be user-</span>
<span class="c">		 * friendly and silently do as if nothing went wrong */</span>
<span class="c">		dprintk(3,</span>
<span class="c">			KERN_ERR</span>
<span class="c">			&quot;%s: %s - forced overlay turnoff because framebuffer changed\n&quot;,</span>
<span class="c">			ZR_DEVNAME(zr), __func__);</span>
<span class="c">		zr36057_overlay(zr, 0);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - no valid overlay format given</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bytesperline</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - invalid height/width/bpl value (%d|%d|%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">bytesperline</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytesperline</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - bytesperline (%d) must be 4-byte aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bytesperline</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_depth</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_bytesperline</span> <span class="o">=</span> <span class="n">bytesperline</span><span class="p">;</span>

	<span class="cm">/* The user should set new window parameters */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_clip</span> <span class="n">__user</span> <span class="o">*</span><span class="n">clips</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clipcount</span><span class="p">,</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_clip</span> <span class="o">*</span><span class="n">vcp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">on</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - frame buffer has to be set first</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - no overlay format set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clipcount</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - invalid clipcount</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The video front end needs 4-byte alinged line sizes, we correct that</span>
<span class="cm">	 * silently here if necessary</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_depth</span> <span class="o">==</span> <span class="mi">15</span> <span class="o">||</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* round down */</span>
		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* round up */</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_depth</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>	<span class="cm">/* round down */</span>
		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>	<span class="cm">/* round up */</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">;</span>

	<span class="cm">/* Check for invalid parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">BUZ_MIN_WIDTH</span> <span class="o">||</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">BUZ_MIN_HEIGHT</span> <span class="o">||</span>
	    <span class="n">width</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_WIDTH</span> <span class="o">||</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - width = %d or height = %d invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">clipcount</span> <span class="o">=</span> <span class="n">clipcount</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If an overlay is running, we have to switch it off</span>
<span class="cm">	 * and switch it on again in order to get the new settings in effect.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We also want to avoid that the overlay mask is written</span>
<span class="cm">	 * when an overlay is running.</span>
<span class="cm">	 */</span>

	<span class="n">on</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_overlay_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span> <span class="o">&amp;&amp;</span>
	    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *   Write the overlay mask if clips are wanted.</span>
<span class="cm">	 *   We prefer a bitmap.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fake value - it just means we want clips */</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">clipcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_mask</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clipcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write our own bitmap from the clips */</span>
		<span class="n">vcp</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_clip</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">clipcount</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - Alloc of clip mask failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span>
		    <span class="p">(</span><span class="n">vcp</span><span class="p">,</span> <span class="n">clips</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_clip</span><span class="p">)</span> <span class="o">*</span> <span class="n">clipcount</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">vcp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">write_overlay_mask</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">vcp</span><span class="p">,</span> <span class="n">clipcount</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">vcp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Make sure the changes come into effect */</span>
	<span class="k">return</span> <span class="n">wait_grab_pending</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="cm">/* If there is nothing to do, return immediately */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check whether we&#39;re touching someone else&#39;s overlay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - overlay is already active for another session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - you cannot cancel someone else&#39;s session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_overlay_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* When a grab is running, the video simply</span>
<span class="cm">		 * won&#39;t be switched on any more */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span><span class="p">)</span>
			<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_mask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_base</span> <span class="o">||</span> <span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">is_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - buffer or window not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - no overlay format set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">=</span> <span class="n">ZORAN_LOCKED</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_overlay_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_mask</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_mask</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span><span class="p">)</span>
			<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* When a grab is running, the video will be</span>
<span class="cm">		 * switched on when grab is finished */</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure the changes come into effect */</span>
	<span class="k">return</span> <span class="n">wait_grab_pending</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* get the status of a buffer in the clients buffer queue */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_v4l2_buffer_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_RAW</span>:
		<span class="cm">/* check range */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - wrong number or buffers not allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
			<span class="n">KERN_DEBUG</span>
			<span class="s">&quot;%s: %s() - raw active=%c, buffer %d: state=%c, map=%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="s">&quot;FAL&quot;</span><span class="p">[</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span><span class="p">],</span> <span class="n">num</span><span class="p">,</span>
			<span class="s">&quot;UPMD&quot;</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span><span class="p">],</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">map</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>

		<span class="cm">/* get buffer */</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUZ_STATE_DONE</span> <span class="o">||</span>
		    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUZ_STATE_USER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">seq</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="n">BUZ_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span>:
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span>:

		<span class="cm">/* check range */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - wrong number or buffers not allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span><span class="p">)</span> <span class="o">?</span>
			      <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">:</span>
			      <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>

		<span class="cm">/* these variables are only written after frame has been captured */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUZ_STATE_DONE</span> <span class="o">||</span>
		    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUZ_STATE_USER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">seq</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bs</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* which fields are these? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_TOP</span> <span class="o">:</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_SEQ_TB</span> <span class="o">:</span> <span class="n">V4L2_FIELD_SEQ_BT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - invalid buffer type|map_mode (%d|%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="n">num</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_set_norm</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">,</span>
		<span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">on</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">||</span>
	    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s: %s called while in playback/capture mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">norms</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s - unsupported norm %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">==</span> <span class="n">V4L2_STD_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_std_id</span> <span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">std</span><span class="p">);</span>
		<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>

		<span class="cm">/* let changes come into effect */</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_input_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V4L2_IN_ST_NO_SIGNAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s - no norm detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* reset norm */</span>
			<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">norm</span> <span class="o">=</span> <span class="n">std</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">tvn</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">tvn</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">tvn</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* We switch overlay off and on since a change in the</span>
<span class="cm">	 * norm needs different VFE settings */</span>
	<span class="n">on</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>
	<span class="n">encoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_std_output</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">zr36057_overlay</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Make sure the changes come into effect */</span>
	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_set_input</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">,</span>
		 <span class="kt">int</span>           <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">||</span>
	    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s: %s called while in playback/capture mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">input</span> <span class="o">&gt;=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">inputs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - unnsupported input %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zr</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>

	<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">input</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">muxsel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   ioctl routine</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cap</span><span class="p">));</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;zoran&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_STREAMING</span> <span class="o">|</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span>
			    <span class="n">V4L2_CAP_VIDEO_OUTPUT</span> <span class="o">|</span> <span class="n">V4L2_CAP_VIDEO_OVERLAY</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">num</span><span class="o">++</span> <span class="o">==</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fmt struct pre-zeroed, so adding &#39;\0&#39; not needed */</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ZORAN_FORMAT_COMPRESSED</span><span class="p">)</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FMT_FLAG_COMPRESSED</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">zoran_enum_fmt</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ZORAN_FORMAT_CAPTURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_enum_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">zoran_enum_fmt</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ZORAN_FORMAT_PLAYBACK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_enum_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">zoran_enum_fmt</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ZORAN_FORMAT_OVERLAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">/</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">HorDcm</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">VerDcm</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">TmpDcm</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">zoran_v4l2_calc_bufsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_SEQ_TB</span> <span class="o">:</span> <span class="n">V4L2_FIELD_SEQ_BT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_TOP</span> <span class="o">:</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">!=</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">zoran_g_fmt_vid_out</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*</span>
					<span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BUZ_MAX_HEIGHT</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_try_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">BUZ_MIN_WIDTH</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">BUZ_MIN_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">BUZ_MIN_HEIGHT</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">BUZ_MIN_HEIGHT</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_try_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="n">settings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">;</span>

	<span class="cm">/* we actually need to set &#39;real&#39; parameters now */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">settings</span><span class="p">.</span><span class="n">decimation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">704</span> <span class="o">:</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_check_jpg_settings</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">tryfmt_unlock_and_return</span><span class="p">;</span>

	<span class="cm">/* tell the user what we actually did */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">/</span> <span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">img_height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">*</span> <span class="n">settings</span><span class="p">.</span><span class="n">VerDcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_SEQ_TB</span> <span class="o">:</span> <span class="n">V4L2_FIELD_SEQ_BT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_TOP</span> <span class="o">:</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">);</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">zoran_v4l2_calc_bufsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">settings</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
<span class="nl">tryfmt_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">zoran_try_fmt_vid_out</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_FORMATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">depth</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">v4l_bound_align_image</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">BUZ_MIN_WIDTH</span><span class="p">,</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">,</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">BUZ_MIN_HEIGHT</span><span class="p">,</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;x=%d, y=%d, w=%d, h=%d, cnt=%d, map=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">clipcount</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">setup_window</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">,</span>
			   <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			   <span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_clip</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">clips</span><span class="p">,</span>
			   <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">clipcount</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">printformat</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="n">settings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;size=%dx%d, fmt=0x%x (%4.4s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">printformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: VIDIOC_S_FMT - cannot change capture mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">sfmtjpg_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">;</span>

	<span class="cm">/* we actually need to set &#39;real&#39; parameters now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">settings</span><span class="p">.</span><span class="n">decimation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">VerDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">field_per_buff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUZ_MAX_WIDTH</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="o">?</span> <span class="mi">704</span> <span class="o">:</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_check_jpg_settings</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sfmtjpg_unlock_and_return</span><span class="p">;</span>

	<span class="cm">/* it&#39;s ok, so set them */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="p">;</span>

	<span class="n">map_mode_jpg</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">zoran_v4l2_calc_bufsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">);</span>

	<span class="cm">/* tell the user what we actually did */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">/</span> <span class="n">settings</span><span class="p">.</span><span class="n">HorDcm</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">img_height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">*</span> <span class="n">settings</span><span class="p">.</span><span class="n">VerDcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">TmpDcm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_SEQ_TB</span> <span class="o">:</span> <span class="n">V4L2_FIELD_SEQ_BT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">odd_even</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_TOP</span> <span class="o">:</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>

<span class="nl">sfmtjpg_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">zoran_s_fmt_vid_out</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_FORMATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: VIDIOC_S_FMT - unknown/unsupported format 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">!=</span> <span class="n">ZORAN_MAP_MODE_RAW</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: VIDIOC_S_FMT - cannot change capture mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">sfmtv4l_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>

	<span class="n">map_mode_raw</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_v4l_set_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sfmtv4l_unlock_and_return</span><span class="p">;</span>

	<span class="cm">/* tell the user the results/missing stuff */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BUZ_MAX_HEIGHT</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>

<span class="nl">sfmtv4l_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fb</span><span class="p">));</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_base</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_width</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">format</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">overlay_settings</span><span class="p">.</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">vbuf_bytesperline</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_FBUF_CAP_LIST_CLIPPING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">printformat</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_FORMATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: VIDIOC_S_FBUF - format=0x%x (%4.4s) not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">printformat</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">setup_fbuffer</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zoran_formats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			    <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">setup_overlay</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">zoran_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: only MEMORY_MMAP capture is supported, not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">zoran_streamoff</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: VIDIOC_REQBUFS - buffers already allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">v4l2reqbuf_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span> <span class="o">&amp;&amp;</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* control user input */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">v4l_nbufs</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">v4l_nbufs</span><span class="p">;</span>

		<span class="cm">/* The next mmap will map the V4L buffers */</span>
		<span class="n">map_mode_raw</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">v4l_fbuffer_alloc</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">v4l2reqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span> <span class="o">||</span>
		   <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we need to calculate size ourselves now */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">jpg_nbufs</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">jpg_nbufs</span><span class="p">;</span>

		<span class="cm">/* The next mmap will map the MJPEG buffers */</span>
		<span class="n">map_mode_jpg</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">);</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">zoran_v4l2_calc_bufsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">jpg_fbuffer_alloc</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">v4l2reqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: VIDIOC_REQBUFS - unknown type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">v4l2reqbuf_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">v4l2reqbuf_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_v4l2_buffer_status</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">codec_mode</span><span class="p">,</span> <span class="n">buf_type</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_RAW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">qbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_v4l_queue_frame</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">qbuf_unlock_and_return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_LOCKED</span><span class="p">)</span>
			<span class="n">zr36057_set_memgrab</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span>:
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf_type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
			<span class="n">codec_mode</span> <span class="o">=</span> <span class="n">BUZ_MODE_MOTION_DECOMPRESS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf_type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
			<span class="n">codec_mode</span> <span class="o">=</span> <span class="n">BUZ_MODE_MOTION_COMPRESS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">buf_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">qbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_jpg_queue_frame</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">codec_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">qbuf_unlock_and_return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">BUZ_MODE_IDLE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_LOCKED</span><span class="p">)</span>
			<span class="n">zr36057_enable_jpg</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">codec_mode</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_QBUF - unsupported type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">qbuf_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_type</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* compiler borks here (?) */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_RAW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_sync_tail</span> <span class="o">&amp;</span> <span class="n">V4L_MASK_FRAME</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUZ_STATE_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">v4l_sync</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">dqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_sync_tail</span><span class="o">++</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_v4l2_buffer_status</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span>:
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">zoran_sync</span> <span class="n">bs</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span><span class="p">)</span>
			<span class="n">buf_type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf_type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">buf_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_tail</span> <span class="o">&amp;</span> <span class="n">BUZ_MASK_FRAME</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUZ_STATE_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bs</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* suppress compiler warning */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">jpg_sync</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">dqbuf_unlock_and_return</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_v4l2_buffer_status</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bs</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_DQBUF - unsupported type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">dqbuf_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_RAW</span>:	<span class="cm">/* raw capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_ACTIVE</span> <span class="o">||</span>
		    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">strmon_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_LOCKED</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">v4l_settings</span><span class="p">;</span>

		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_sync_tail</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_tail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_head</span> <span class="o">!=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_tail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zr36057_set_memgrab</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span>:
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span>:
		<span class="cm">/* what is the codec mode right now? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_ACTIVE</span> <span class="o">||</span>
		    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">strmon_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_LOCKED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_head</span> <span class="o">!=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_tail</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Start the jpeg codec when the first frame is queued  */</span>
			<span class="n">jpeg_start</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_STREAMON - invalid map mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">strmon_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_RAW</span>:	<span class="cm">/* raw capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>	<span class="cm">/* stay off other&#39;s settings! */</span>
			<span class="k">goto</span> <span class="n">strmoff_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">strmoff_unlock_and_return</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* unload capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_memgrab_active</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">zr36057_set_memgrab</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUZ_STATE_USER</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">;</span>

		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>

		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_grab_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_head</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_sync_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span>:
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>	<span class="cm">/* stay off other&#39;s settings! */</span>
			<span class="k">goto</span> <span class="n">strmoff_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">ZORAN_FREE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">strmoff_unlock_and_return</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">jpg_qbuf</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span><span class="p">)</span> <span class="o">?</span>
			     <span class="n">BUZ_MODE_MOTION_COMPRESS</span> <span class="o">:</span>
			     <span class="n">BUZ_MODE_MOTION_DECOMPRESS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">strmoff_unlock_and_return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_STREAMOFF - invalid map mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">strmoff_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="cm">/* we only support hue/saturation/contrast/brightness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">V4L2_CID_BRIGHTNESS</span> <span class="o">||</span>
	    <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">V4L2_CID_HUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">queryctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="cm">/* we only support hue/saturation/contrast/brightness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">V4L2_CID_BRIGHTNESS</span> <span class="o">||</span>
	    <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">V4L2_CID_HUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="cm">/* we only support hue/saturation/contrast/brightness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">V4L2_CID_BRIGHTNESS</span> <span class="o">||</span>
	    <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">V4L2_CID_HUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_set_norm</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="o">*</span><span class="n">std</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sstd_unlock_and_return</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">wait_grab_pending</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
<span class="nl">sstd_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">.</span><span class="n">input</span><span class="p">[</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>

	<span class="cm">/* Get status of video decoder */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">decoder_call</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_input_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_set_input</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sinput_unlock_and_return</span><span class="p">;</span>

	<span class="cm">/* Make sure the changes come into effect */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">wait_grab_pending</span><span class="p">(</span><span class="n">zr</span><span class="p">);</span>
<span class="nl">sinput_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_enum_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_output</span> <span class="o">*</span><span class="n">outp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">outp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_OUTPUT_TYPE_ANALOGVGAOVERLAY</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">outp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Autodetect&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">outp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cropping (sub-frame capture) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cropcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cropcap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cropcap</span><span class="p">));</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">||</span>
	     <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_CROPCAP - subcapture only supported for compressed capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cropcap_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">BUZ_MAX_WIDTH</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">BUZ_MAX_HEIGHT</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">BUZ_MIN_WIDTH</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">BUZ_MIN_HEIGHT</span><span class="p">;</span>
<span class="nl">cropcap_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">crop</span><span class="p">));</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">||</span>
	     <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_G_CROP - subcapture only supported for compressed capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">gcrop_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_y</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_x</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_width</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">img_height</span><span class="p">;</span>

<span class="nl">gcrop_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="n">settings</span><span class="p">;</span>

	<span class="n">settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_S_CROP - cannot change settings while active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">scrop_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">||</span>
	     <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: VIDIOC_G_CROP - subcapture only supported for compressed capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">scrop_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* move into a form that we understand */</span>
	<span class="n">settings</span><span class="p">.</span><span class="n">img_x</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="n">settings</span><span class="p">.</span><span class="n">img_y</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="n">settings</span><span class="p">.</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">settings</span><span class="p">.</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* check validity */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_check_jpg_settings</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">scrop_unlock_and_return</span><span class="p">;</span>

	<span class="cm">/* accept */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="p">;</span>

<span class="nl">scrop_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_g_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="n">params</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">quality</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">APPn</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APPn</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">APP_data</span><span class="p">,</span>
	       <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_data</span><span class="p">,</span>
	       <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_len</span><span class="p">);</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">APP_len</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">APP_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">COM_data</span><span class="p">,</span>
	       <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_data</span><span class="p">,</span>
	       <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_len</span><span class="p">);</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">COM_len</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">COM_len</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">jpeg_markers</span> <span class="o">=</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">.</span><span class="n">jpeg_markers</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zoran_s_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">__fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="n">settings</span><span class="p">;</span>

	<span class="n">settings</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">;</span>

	<span class="n">settings</span><span class="p">.</span><span class="n">jpg_comp</span> <span class="o">=</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s: VIDIOC_S_JPEGCOMP called while in playback/capture mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">sjpegc_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">zoran_check_jpg_settings</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sjpegc_unlock_and_return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span>
			<span class="n">zoran_v4l2_calc_bufsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">jpg_settings</span><span class="p">.</span><span class="n">jpg_comp</span> <span class="o">=</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">jpg_comp</span><span class="p">;</span>
<span class="nl">sjpegc_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">zoran_poll</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	    <span class="n">poll_table</span>  <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* we should check whether buffers are ready to be synced on</span>
<span class="cm">	 * (w/o waits - O_NONBLOCK) here</span>
<span class="cm">	 * if ready for read (sync), return POLLIN|POLLRDNORM,</span>
<span class="cm">	 * if ready for write (sync), return POLLOUT|POLLWRNORM,</span>
<span class="cm">	 * if error, return POLLERR,</span>
<span class="cm">	 * if no buffers queued or so, return POLLNVAL</span>
<span class="cm">	 */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_RAW</span>:
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_capq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_sync_tail</span> <span class="o">&amp;</span> <span class="n">V4L_MASK_FRAME</span><span class="p">];</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
			<span class="n">KERN_DEBUG</span>
			<span class="s">&quot;%s: %s() raw - active=%c, sync_tail=%lu/%c, pend_tail=%lu, pend_head=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="s">&quot;FAL&quot;</span><span class="p">[</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span><span class="p">],</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_sync_tail</span><span class="p">,</span>
			<span class="s">&quot;UPMD&quot;</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span><span class="p">],</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_tail</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_pend_head</span><span class="p">);</span>
		<span class="cm">/* Process is the one capturing? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
		    <span class="cm">/* Buffer ready to DQBUF? */</span>
		    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUZ_STATE_DONE</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span>:
	<span class="k">case</span> <span class="n">ZORAN_MAP_MODE_JPG_PLAY</span>:
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_capq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_pend</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_tail</span> <span class="o">&amp;</span> <span class="n">BUZ_MASK_FRAME</span><span class="p">];</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
			<span class="n">KERN_DEBUG</span>
			<span class="s">&quot;%s: %s() jpg - active=%c, que_tail=%lu/%c, que_head=%lu, dma=%lu/%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="s">&quot;FAL&quot;</span><span class="p">[</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span><span class="p">],</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_tail</span><span class="p">,</span>
			<span class="s">&quot;UPMD&quot;</span><span class="p">[</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span><span class="p">],</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_que_head</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_dma_tail</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_dma_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUZ_STATE_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_JPG_REC</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - internal error, unknown map_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">POLLNVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This maps the buffers to user space.</span>
<span class="cm"> *</span>
<span class="cm"> * Depending on the state of fh-&gt;map_mode</span>
<span class="cm"> * the V4L or the MJPEG buffers are mapped</span>
<span class="cm"> * per buffer or all together</span>
<span class="cm"> *</span>
<span class="cm"> * Note that we need to connect to some</span>
<span class="cm"> * unmap signal event to unmap the de-allocate</span>
<span class="cm"> * the buffer accordingly (zoran_vm_close())</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zoran_vm_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_mapping</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zoran_vm_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_mapping</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s - munmap(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">mode_name</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">map</span> <span class="o">==</span> <span class="n">map</span><span class="p">)</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>

	<span class="cm">/* Any buffers still mapped? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">map</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s - free %s buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">mode_name</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">zr36057_set_memgrab</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">v4l_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">v4l_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="n">ZORAN_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jpg_qbuf</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">);</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">zr</span><span class="o">-&gt;</span><span class="n">jpg_buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ZORAN_FREE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">jpg_fbuffer_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">zoran_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">zoran_vm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">zoran_vm_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zoran_mmap</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span>           <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">todo</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">fraglen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran_mapping</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
		<span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s(%s) of 0x%08lx-0x%08lx (size=%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">mode_name</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">),</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_SHARED</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_READ</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s - no MAP_SHARED/PROT_{READ,WRITE} given</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s(%s) - buffers not yet allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mode_name</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mmap_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">first</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">size</span> <span class="o">/</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">size</span> <span class="o">%</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">last</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">first</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span> <span class="o">||</span>
	    <span class="n">last</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: %s(%s) - offset=%lu or size=%lu invalid for bufsize=%d and numbufs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mode_name</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">,</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">num_buffers</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mmap_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if any buffers are already mapped */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: %s(%s) - buffer %d already mapped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mode_name</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">mmap_unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* map these buffers */</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zoran_mapping</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mmap_unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zoran_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_DONTEXPAND</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">map_mode</span> <span class="o">==</span> <span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">todo</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">)</span>
				<span class="n">todo</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l</span><span class="p">.</span><span class="n">fbuffer_phys</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
							<span class="n">todo</span><span class="p">,</span> <span class="n">PAGE_SHARED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">KERN_ERR</span>
					<span class="s">&quot;%s: %s(V4L) - remap_pfn_range failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">mmap_unlock_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">todo</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">+=</span> <span class="n">todo</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">map</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">j</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			     <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fraglen</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span>
				     <span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">todo</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="n">fraglen</span><span class="p">)</span>
					<span class="n">todo</span> <span class="o">=</span> <span class="n">fraglen</span><span class="p">;</span>
				<span class="n">pos</span> <span class="o">=</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span>
				    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span><span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">]);</span>
				<span class="cm">/* should just be pos on i386 */</span>
				<span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">bus_to_virt</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
								<span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
							<span class="n">todo</span><span class="p">,</span> <span class="n">PAGE_SHARED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
						<span class="n">KERN_ERR</span>
						<span class="s">&quot;%s: %s(V4L) - remap_pfn_range failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ZR_DEVNAME</span><span class="p">(</span><span class="n">zr</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">mmap_unlock_and_return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">size</span> <span class="o">-=</span> <span class="n">todo</span><span class="p">;</span>
				<span class="n">start</span> <span class="o">+=</span> <span class="n">todo</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jpg</span><span class="p">.</span>
				    <span class="n">frag_tab</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>	<span class="cm">/* was last fragment */</span>
			<span class="p">}</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">map</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">mmap_unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">zoran_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>    		    <span class="o">=</span> <span class="n">zoran_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>       		    <span class="o">=</span> <span class="n">zoran_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>       		    <span class="o">=</span> <span class="n">zoran_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>       		    <span class="o">=</span> <span class="n">zoran_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>     		    <span class="o">=</span> <span class="n">zoran_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>      		    <span class="o">=</span> <span class="n">zoran_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>      		    <span class="o">=</span> <span class="n">zoran_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_output</span>    		    <span class="o">=</span> <span class="n">zoran_enum_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_output</span>     		    <span class="o">=</span> <span class="n">zoran_g_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_output</span>     		    <span class="o">=</span> <span class="n">zoran_s_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fbuf</span>			    <span class="o">=</span> <span class="n">zoran_g_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fbuf</span>			    <span class="o">=</span> <span class="n">zoran_s_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span> 			    <span class="o">=</span> <span class="n">zoran_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span> 			    <span class="o">=</span> <span class="n">zoran_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_jpegcomp</span> 		    <span class="o">=</span> <span class="n">zoran_g_jpegcomp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_jpegcomp</span> 		    <span class="o">=</span> <span class="n">zoran_s_jpegcomp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_overlay</span>			    <span class="o">=</span> <span class="n">zoran_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>			    <span class="o">=</span> <span class="n">zoran_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>		    <span class="o">=</span> <span class="n">zoran_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>			    <span class="o">=</span> <span class="n">zoran_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>			    <span class="o">=</span> <span class="n">zoran_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>		    <span class="o">=</span> <span class="n">zoran_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>		    <span class="o">=</span> <span class="n">zoran_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> 	    <span class="o">=</span> <span class="n">zoran_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out</span> 	    <span class="o">=</span> <span class="n">zoran_enum_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_overlay</span> 	    <span class="o">=</span> <span class="n">zoran_enum_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> 		    <span class="o">=</span> <span class="n">zoran_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out</span>               <span class="o">=</span> <span class="n">zoran_g_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_overlay</span>           <span class="o">=</span> <span class="n">zoran_g_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>  		    <span class="o">=</span> <span class="n">zoran_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out</span>               <span class="o">=</span> <span class="n">zoran_s_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_overlay</span>           <span class="o">=</span> <span class="n">zoran_s_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>  	    <span class="o">=</span> <span class="n">zoran_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out</span> 	    <span class="o">=</span> <span class="n">zoran_try_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_overlay</span> 	    <span class="o">=</span> <span class="n">zoran_try_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span> 		    <span class="o">=</span> <span class="n">zoran_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>       		    <span class="o">=</span> <span class="n">zoran_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>       		    <span class="o">=</span> <span class="n">zoran_g_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* please use zr-&gt;resource_lock consistently and kill this wrapper */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">zoran_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">other_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">zoran_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">zoran_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">zoran_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">zoran_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">zoran_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">zoran_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">zoran_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">zoran_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">video_device</span> <span class="n">zoran_template</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ZORAN_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zoran_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zoran_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zoran_vdev_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
