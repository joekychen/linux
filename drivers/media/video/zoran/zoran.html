<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › zoran › zoran.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>zoran.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * zoran - Iomega Buz driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999 Rainer Johanni &lt;Rainer@Johanni.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * based on</span>
<span class="cm"> *</span>
<span class="cm"> * zoran.0.0.3 Copyright (C) 1998 Dave Perks &lt;dperks@ibm.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * and</span>
<span class="cm"> *</span>
<span class="cm"> * bttv - Bt848 frame grabber driver</span>
<span class="cm"> * Copyright (C) 1996,97,98 Ralph  Metzler (rjkm@thp.uni-koeln.de)</span>
<span class="cm"> *                        &amp; Marcus Metzler (mocm@thp.uni-koeln.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _BUZ_H_</span>
<span class="cp">#define _BUZ_H_</span>

<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>

<span class="k">struct</span> <span class="n">zoran_sync</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame</span><span class="p">;</span>	<span class="cm">/* number of buffer that has been free&#39;d */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>	<span class="cm">/* number of code bytes in buffer (capture only) */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seq</span><span class="p">;</span>	<span class="cm">/* frame sequence number */</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">timestamp</span><span class="p">;</span>	<span class="cm">/* timestamp */</span>
<span class="p">};</span>


<span class="cp">#define ZORAN_NAME    &quot;ZORAN&quot;	</span><span class="cm">/* name of the device */</span><span class="cp"></span>

<span class="cp">#define ZR_DEVNAME(zr) ((zr)-&gt;name)</span>

<span class="cp">#define   BUZ_MAX_WIDTH   (zr-&gt;timing-&gt;Wa)</span>
<span class="cp">#define   BUZ_MAX_HEIGHT  (zr-&gt;timing-&gt;Ha)</span>
<span class="cp">#define   BUZ_MIN_WIDTH    32	</span><span class="cm">/* never display less than 32 pixels */</span><span class="cp"></span>
<span class="cp">#define   BUZ_MIN_HEIGHT   24	</span><span class="cm">/* never display less than 24 rows */</span><span class="cp"></span>

<span class="cp">#define BUZ_NUM_STAT_COM    4</span>
<span class="cp">#define BUZ_MASK_STAT_COM   3</span>

<span class="cp">#define BUZ_MAX_FRAME     256	</span><span class="cm">/* Must be a power of 2 */</span><span class="cp"></span>
<span class="cp">#define BUZ_MASK_FRAME    255	</span><span class="cm">/* Must be BUZ_MAX_FRAME-1 */</span><span class="cp"></span>

<span class="cp">#define BUZ_MAX_INPUT       16</span>

<span class="cp">#if VIDEO_MAX_FRAME &lt;= 32</span>
<span class="cp">#   define   V4L_MAX_FRAME   32</span>
<span class="cp">#elif VIDEO_MAX_FRAME &lt;= 64</span>
<span class="cp">#   define   V4L_MAX_FRAME   64</span>
<span class="cp">#else</span>
<span class="cp">#   error   &quot;Too many video frame buffers to handle&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#define   V4L_MASK_FRAME   (V4L_MAX_FRAME - 1)</span>

<span class="cp">#define MAX_FRAME (BUZ_MAX_FRAME &gt; VIDEO_MAX_FRAME ? BUZ_MAX_FRAME : VIDEO_MAX_FRAME)</span>

<span class="cp">#include &quot;zr36057.h&quot;</span>

<span class="k">enum</span> <span class="n">card_type</span> <span class="p">{</span>
	<span class="n">UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Pinnacle/Miro */</span>
	<span class="n">DC10_old</span><span class="p">,</span>		<span class="cm">/* DC30 like */</span>
	<span class="n">DC10_new</span><span class="p">,</span>		<span class="cm">/* DC10plus like */</span>
	<span class="n">DC10plus</span><span class="p">,</span>
	<span class="n">DC30</span><span class="p">,</span>
	<span class="n">DC30plus</span><span class="p">,</span>

	<span class="cm">/* Linux Media Labs */</span>
	<span class="n">LML33</span><span class="p">,</span>
	<span class="n">LML33R10</span><span class="p">,</span>

	<span class="cm">/* Iomega */</span>
	<span class="n">BUZ</span><span class="p">,</span>

	<span class="cm">/* AverMedia */</span>
	<span class="n">AVS6EYES</span><span class="p">,</span>

	<span class="cm">/* total number of cards */</span>
	<span class="n">NUM_CARDS</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zoran_codec_mode</span> <span class="p">{</span>
	<span class="n">BUZ_MODE_IDLE</span><span class="p">,</span>		<span class="cm">/* nothing going on */</span>
	<span class="n">BUZ_MODE_MOTION_COMPRESS</span><span class="p">,</span>	<span class="cm">/* grabbing frames */</span>
	<span class="n">BUZ_MODE_MOTION_DECOMPRESS</span><span class="p">,</span>	<span class="cm">/* playing frames */</span>
	<span class="n">BUZ_MODE_STILL_COMPRESS</span><span class="p">,</span>	<span class="cm">/* still frame conversion */</span>
	<span class="n">BUZ_MODE_STILL_DECOMPRESS</span>	<span class="cm">/* still frame conversion */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zoran_buffer_state</span> <span class="p">{</span>
	<span class="n">BUZ_STATE_USER</span><span class="p">,</span>		<span class="cm">/* buffer is owned by application */</span>
	<span class="n">BUZ_STATE_PEND</span><span class="p">,</span>		<span class="cm">/* buffer is queued in pend[] ready to feed to I/O */</span>
	<span class="n">BUZ_STATE_DMA</span><span class="p">,</span>		<span class="cm">/* buffer is queued in dma[] for I/O */</span>
	<span class="n">BUZ_STATE_DONE</span>		<span class="cm">/* buffer is ready to return to application */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zoran_map_mode</span> <span class="p">{</span>
	<span class="n">ZORAN_MAP_MODE_RAW</span><span class="p">,</span>
	<span class="n">ZORAN_MAP_MODE_JPG_REC</span><span class="p">,</span>
<span class="cp">#define ZORAN_MAP_MODE_JPG ZORAN_MAP_MODE_JPG_REC</span>
	<span class="n">ZORAN_MAP_MODE_JPG_PLAY</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">gpio_type</span> <span class="p">{</span>
	<span class="n">ZR_GPIO_JPEG_SLEEP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ZR_GPIO_JPEG_RESET</span><span class="p">,</span>
	<span class="n">ZR_GPIO_JPEG_FRAME</span><span class="p">,</span>
	<span class="n">ZR_GPIO_VID_DIR</span><span class="p">,</span>
	<span class="n">ZR_GPIO_VID_EN</span><span class="p">,</span>
	<span class="n">ZR_GPIO_VID_RESET</span><span class="p">,</span>
	<span class="n">ZR_GPIO_CLK_SEL1</span><span class="p">,</span>
	<span class="n">ZR_GPIO_CLK_SEL2</span><span class="p">,</span>
	<span class="n">ZR_GPIO_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">gpcs_type</span> <span class="p">{</span>
	<span class="n">GPCS_JPEG_RESET</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">GPCS_JPEG_START</span><span class="p">,</span>
	<span class="n">GPCS_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">zoran_format</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">fourcc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">colorspace</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">vfespfr</span><span class="p">;</span>
<span class="p">};</span>
<span class="cm">/* flags */</span>
<span class="cp">#define ZORAN_FORMAT_COMPRESSED 1&lt;&lt;0</span>
<span class="cp">#define ZORAN_FORMAT_OVERLAY    1&lt;&lt;1</span>
<span class="cp">#define ZORAN_FORMAT_CAPTURE	1&lt;&lt;2</span>
<span class="cp">#define ZORAN_FORMAT_PLAYBACK	1&lt;&lt;3</span>

<span class="cm">/* overlay-settings */</span>
<span class="k">struct</span> <span class="n">zoran_overlay_settings</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>	<span class="cm">/* position */</span>
	<span class="kt">int</span> <span class="n">clipcount</span><span class="p">;</span>		<span class="cm">/* position and number of clips */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">zoran_format</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>	<span class="cm">/* overlay format */</span>
<span class="p">};</span>

<span class="cm">/* v4l-capture settings */</span>
<span class="k">struct</span> <span class="n">zoran_v4l_settings</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">bytesperline</span><span class="p">;</span>	<span class="cm">/* capture size */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">zoran_format</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>	<span class="cm">/* capture format */</span>
<span class="p">};</span>

<span class="cm">/* jpg-capture/-playback settings */</span>
<span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">decimation</span><span class="p">;</span>		<span class="cm">/* this bit is used to set everything to default */</span>
	<span class="kt">int</span> <span class="n">HorDcm</span><span class="p">,</span> <span class="n">VerDcm</span><span class="p">,</span> <span class="n">TmpDcm</span><span class="p">;</span>	<span class="cm">/* capture decimation settings (TmpDcm=1 means both fields) */</span>
	<span class="kt">int</span> <span class="n">field_per_buff</span><span class="p">,</span> <span class="n">odd_even</span><span class="p">;</span>	<span class="cm">/* field-settings (odd_even=1 (+TmpDcm=1) means top-field-first) */</span>
	<span class="kt">int</span> <span class="n">img_x</span><span class="p">,</span> <span class="n">img_y</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span><span class="p">;</span>	<span class="cm">/* crop settings (subframe capture) */</span>
	<span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="n">jpg_comp</span><span class="p">;</span>	<span class="cm">/* JPEG-specific capture settings */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">zoran_mapping</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">zoran_buffer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran_mapping</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">zoran_buffer_state</span> <span class="n">state</span><span class="p">;</span>	<span class="cm">/* state: unused/pending/dma/done */</span>
	<span class="k">struct</span> <span class="n">zoran_sync</span> <span class="n">bs</span><span class="p">;</span>		<span class="cm">/* DONE: info to return to application */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le32</span> <span class="o">*</span><span class="n">frag_tab</span><span class="p">;</span>	<span class="cm">/* addresses of frag table */</span>
			<span class="n">u32</span> <span class="n">frag_tab_bus</span><span class="p">;</span>	<span class="cm">/* same value cached to save time in ISR */</span>
		<span class="p">}</span> <span class="n">jpg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">fbuffer</span><span class="p">;</span>		<span class="cm">/* virtual address of frame buffer */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fbuffer_phys</span><span class="p">;</span><span class="cm">/* physical address of frame buffer */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fbuffer_bus</span><span class="p">;</span><span class="cm">/* bus address of frame buffer */</span>
		<span class="p">}</span> <span class="n">v4l</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zoran_lock_activity</span> <span class="p">{</span>
	<span class="n">ZORAN_FREE</span><span class="p">,</span>		<span class="cm">/* free for use */</span>
	<span class="n">ZORAN_ACTIVE</span><span class="p">,</span>		<span class="cm">/* active but unlocked */</span>
	<span class="n">ZORAN_LOCKED</span><span class="p">,</span>		<span class="cm">/* locked */</span>
<span class="p">};</span>

<span class="cm">/* buffer collections */</span>
<span class="k">struct</span> <span class="n">zoran_buffer_col</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">zoran_lock_activity</span> <span class="n">active</span><span class="p">;</span>	<span class="cm">/* feature currently in use? */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_buffers</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zoran_buffer</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_FRAME</span><span class="p">];</span>	<span class="cm">/* buffers */</span>
	<span class="n">u8</span> <span class="n">allocated</span><span class="p">;</span>		<span class="cm">/* Flag if buffers are allocated  */</span>
	<span class="n">u8</span> <span class="n">need_contiguous</span><span class="p">;</span>	<span class="cm">/* Flag if contiguous buffers are needed */</span>
	<span class="cm">/* only applies to jpg buffers, raw buffers are always contiguous */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">zoran</span><span class="p">;</span>

<span class="cm">/* zoran_fh contains per-open() settings */</span>
<span class="k">struct</span> <span class="n">zoran_fh</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="n">zr</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">zoran_map_mode</span> <span class="n">map_mode</span><span class="p">;</span>		<span class="cm">/* Flag which bufferset will map by next mmap() */</span>

	<span class="k">struct</span> <span class="n">zoran_overlay_settings</span> <span class="n">overlay_settings</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">overlay_mask</span><span class="p">;</span>			<span class="cm">/* overlay mask */</span>
	<span class="k">enum</span> <span class="n">zoran_lock_activity</span> <span class="n">overlay_active</span><span class="p">;</span><span class="cm">/* feature currently in use? */</span>

	<span class="k">struct</span> <span class="n">zoran_buffer_col</span> <span class="n">buffers</span><span class="p">;</span>	<span class="cm">/* buffers&#39; info */</span>

	<span class="k">struct</span> <span class="n">zoran_v4l_settings</span> <span class="n">v4l_settings</span><span class="p">;</span>	<span class="cm">/* structure with a lot of things to play with */</span>
	<span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="n">jpg_settings</span><span class="p">;</span>	<span class="cm">/* structure with a lot of things to play with */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">card_info</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">card_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">i2c_decoder</span><span class="p">;</span>	<span class="cm">/* i2c decoder device */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">addrs_decoder</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">i2c_encoder</span><span class="p">;</span>	<span class="cm">/* i2c encoder device */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">addrs_encoder</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">video_vfe</span><span class="p">,</span> <span class="n">video_codec</span><span class="p">;</span>			<span class="cm">/* videocodec types */</span>
	<span class="n">u16</span> <span class="n">audio_chip</span><span class="p">;</span>					<span class="cm">/* audio type */</span>

	<span class="kt">int</span> <span class="n">inputs</span><span class="p">;</span>		<span class="cm">/* number of video inputs */</span>
	<span class="k">struct</span> <span class="n">input</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">muxsel</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">input</span><span class="p">[</span><span class="n">BUZ_MAX_INPUT</span><span class="p">];</span>

	<span class="n">v4l2_std_id</span> <span class="n">norms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvnorm</span> <span class="o">*</span><span class="n">tvn</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* supported TV norms */</span>

	<span class="n">u32</span> <span class="n">jpeg_int</span><span class="p">;</span>		<span class="cm">/* JPEG interrupt */</span>
	<span class="n">u32</span> <span class="n">vsync_int</span><span class="p">;</span>		<span class="cm">/* VSYNC interrupt */</span>
	<span class="n">s8</span> <span class="n">gpio</span><span class="p">[</span><span class="n">ZR_GPIO_MAX</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">gpcs</span><span class="p">[</span><span class="n">GPCS_MAX</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">vfe_polarity</span> <span class="n">vfe_pol</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio_pol</span><span class="p">[</span><span class="n">ZR_GPIO_MAX</span><span class="p">];</span>

	<span class="cm">/* is the /GWS line connected? */</span>
	<span class="n">u8</span> <span class="n">gws_not_connected</span><span class="p">;</span>

	<span class="cm">/* avs6eyes mux setting */</span>
	<span class="n">u8</span> <span class="n">input_mux</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span> <span class="n">zr</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">zoran</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">video_dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">i2c_adapter</span><span class="p">;</span>	<span class="cm">/* */</span>
	<span class="k">struct</span> <span class="n">i2c_algo_bit_data</span> <span class="n">i2c_algo</span><span class="p">;</span>	<span class="cm">/* */</span>
	<span class="n">u32</span> <span class="n">i2cbr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">decoder</span><span class="p">;</span>	<span class="cm">/* video decoder sub-device */</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>	<span class="cm">/* video encoder sub-device */</span>

	<span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>	<span class="cm">/* video codec */</span>
	<span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">vfe</span><span class="p">;</span>	<span class="cm">/* video front end */</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">resource_lock</span><span class="p">;</span>	<span class="cm">/* prevent evil stuff */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">other_lock</span><span class="p">;</span>	<span class="cm">/* please merge with above */</span>

	<span class="n">u8</span> <span class="n">initialized</span><span class="p">;</span>		<span class="cm">/* flag if zoran has been correctly initialized */</span>
	<span class="kt">int</span> <span class="n">user</span><span class="p">;</span>		<span class="cm">/* number of current users */</span>
	<span class="k">struct</span> <span class="n">card_info</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvnorm</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">id</span><span class="p">;</span>	<span class="cm">/* number of this device */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>		<span class="cm">/* name of this device */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>	<span class="cm">/* PCI device */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">revision</span><span class="p">;</span>	<span class="cm">/* revision of zr36057 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">zr36057_mem</span><span class="p">;</span><span class="cm">/* pointer to mapped IO memory */</span>

	<span class="n">spinlock_t</span> <span class="n">spinlock</span><span class="p">;</span>	<span class="cm">/* Spinlock */</span>

	<span class="cm">/* Video for Linux parameters */</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>	<span class="cm">/* card&#39;s norm and input */</span>
	<span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">;</span>

	<span class="cm">/* Current buffer params */</span>
	<span class="kt">void</span>    <span class="o">*</span><span class="n">vbuf_base</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">vbuf_height</span><span class="p">,</span> <span class="n">vbuf_width</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">vbuf_depth</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">vbuf_bytesperline</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">zoran_overlay_settings</span> <span class="n">overlay_settings</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">overlay_mask</span><span class="p">;</span>	<span class="cm">/* overlay mask */</span>
	<span class="k">enum</span> <span class="n">zoran_lock_activity</span> <span class="n">overlay_active</span><span class="p">;</span>	<span class="cm">/* feature currently in use? */</span>

	<span class="n">wait_queue_head_t</span> <span class="n">v4l_capq</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">v4l_overlay_active</span><span class="p">;</span>	<span class="cm">/* Overlay grab is activated */</span>
	<span class="kt">int</span> <span class="n">v4l_memgrab_active</span><span class="p">;</span>	<span class="cm">/* Memory grab is activated */</span>

	<span class="kt">int</span> <span class="n">v4l_grab_frame</span><span class="p">;</span>	<span class="cm">/* Frame number being currently grabbed */</span>
<span class="cp">#define NO_GRAB_ACTIVE (-1)</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v4l_grab_seq</span><span class="p">;</span>	<span class="cm">/* Number of frames grabbed */</span>
	<span class="k">struct</span> <span class="n">zoran_v4l_settings</span> <span class="n">v4l_settings</span><span class="p">;</span>	<span class="cm">/* structure with a lot of things to play with */</span>

	<span class="cm">/* V4L grab queue of frames pending */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v4l_pend_head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v4l_pend_tail</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v4l_sync_tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v4l_pend</span><span class="p">[</span><span class="n">V4L_MAX_FRAME</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">zoran_buffer_col</span> <span class="n">v4l_buffers</span><span class="p">;</span>	<span class="cm">/* V4L buffers&#39; info */</span>

	<span class="cm">/* Buz MJPEG parameters */</span>
	<span class="k">enum</span> <span class="n">zoran_codec_mode</span> <span class="n">codec_mode</span><span class="p">;</span>	<span class="cm">/* status of codec */</span>
	<span class="k">struct</span> <span class="n">zoran_jpg_settings</span> <span class="n">jpg_settings</span><span class="p">;</span>	<span class="cm">/* structure with a lot of things to play with */</span>

	<span class="n">wait_queue_head_t</span> <span class="n">jpg_capq</span><span class="p">;</span>	<span class="cm">/* wait here for grab to finish */</span>

	<span class="cm">/* grab queue counts/indices, mask with BUZ_MASK_STAT_COM before using as index */</span>
	<span class="cm">/* (dma_head - dma_tail) is number active in DMA, must be &lt;= BUZ_NUM_STAT_COM */</span>
	<span class="cm">/* (value &amp; BUZ_MASK_STAT_COM) corresponds to index in stat_com table */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_que_head</span><span class="p">;</span>	<span class="cm">/* Index where to put next buffer which is queued */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_dma_head</span><span class="p">;</span>	<span class="cm">/* Index of next buffer which goes into stat_com  */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_dma_tail</span><span class="p">;</span>	<span class="cm">/* Index of last buffer in stat_com               */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_que_tail</span><span class="p">;</span>	<span class="cm">/* Index of last buffer in queue                  */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_seq_num</span><span class="p">;</span>	<span class="cm">/* count of frames since grab/play started        */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_err_seq</span><span class="p">;</span>	<span class="cm">/* last seq_num before error                      */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_err_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jpg_queued_num</span><span class="p">;</span>	<span class="cm">/* count of frames queued since grab/play started */</span>

	<span class="cm">/* zr36057&#39;s code buffer table */</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">stat_com</span><span class="p">;</span>		<span class="cm">/* stat_com[i] is indexed by dma_head/tail &amp; BUZ_MASK_STAT_COM */</span>

	<span class="cm">/* (value &amp; BUZ_MASK_FRAME) corresponds to index in pend[] queue */</span>
	<span class="kt">int</span> <span class="n">jpg_pend</span><span class="p">[</span><span class="n">BUZ_MAX_FRAME</span><span class="p">];</span>

	<span class="cm">/* array indexed by frame number */</span>
	<span class="k">struct</span> <span class="n">zoran_buffer_col</span> <span class="n">jpg_buffers</span><span class="p">;</span>	<span class="cm">/* MJPEG buffers&#39; info */</span>

	<span class="cm">/* Additional stuff for testing */</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">zoran_proc</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">zoran_proc</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">testing</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jpeg_error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr_counter_GIRQ1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr_counter_GIRQ0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr_counter_CodRepIRQ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr_counter_JPEGRepIRQ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">field_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">IRQ1_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">IRQ1_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">END_event_missed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_missed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_errors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_max_missed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">JPEG_min_missed</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">last_isr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame_num</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span> <span class="n">test_q</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">zoran</span> <span class="o">*</span><span class="nf">to_zoran</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zoran</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* There was something called _ALPHA_BUZ that used the PCI address instead of</span>
<span class="cm"> * the kernel iomapped address for btread/btwrite.  */</span>
<span class="cp">#define btwrite(dat,adr)    writel((dat), zr-&gt;zr36057_mem+(adr))</span>
<span class="cp">#define btread(adr)         readl(zr-&gt;zr36057_mem+(adr))</span>

<span class="cp">#define btand(dat,adr)      btwrite((dat) &amp; btread(adr), adr)</span>
<span class="cp">#define btor(dat,adr)       btwrite((dat) | btread(adr), adr)</span>
<span class="cp">#define btaor(dat,mask,adr) btwrite((dat) | ((mask) &amp; btread(adr)), adr)</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
