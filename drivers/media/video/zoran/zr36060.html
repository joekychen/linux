<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › zoran › zr36060.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>zr36060.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Zoran ZR36060 basic configuration functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002 Laurent Pinchart &lt;laurent.pinchart@skynet.be&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: zr36060.c,v 1.1.2.22 2003/05/06 09:35:36 rbultje Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * ------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * ------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cp">#define ZR060_VERSION &quot;v0.7&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>

<span class="cm">/* I/O commands, error codes */</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/* headerfile of this module */</span>
<span class="cp">#include &quot;zr36060.h&quot;</span>

<span class="cm">/* codec io API */</span>
<span class="cp">#include &quot;videocodec.h&quot;</span>

<span class="cm">/* it doesn&#39;t make sense to have more than 20 or so,</span>
<span class="cm">  just to prevent some unwanted loops */</span>
<span class="cp">#define MAX_CODECS 20</span>

<span class="cm">/* amount of chips attached via this driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">zr36060_codecs</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">low_bitrate</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">low_bitrate</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">low_bitrate</span><span class="p">,</span> <span class="s">&quot;Buz compatibility option, halves bitrate&quot;</span><span class="p">);</span>

<span class="cm">/* debugging is available via module parameter */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-4)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(num, format, args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug &gt;= num) \</span>
<span class="cp">			printk(format, ##args); \</span>
<span class="cp">	} while (0)</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Local hardware I/O functions:</span>

<span class="cm">   read/write via codec layer (registers are located in the master device)</span>
<span class="cm">   ========================================================================= */</span>

<span class="cm">/* read and write functions */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">zr36060_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	      <span class="n">u16</span>             <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>just in case something is wrong...</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">readreg</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">readreg</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span>
							  <span class="n">reg</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;%s: invalid I/O setup, nothing read!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>dprintk(4, "%s: reading from 0x%04x: %02x\n",ptr->name,reg,value);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zr36060_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	      <span class="n">u16</span>             <span class="n">reg</span><span class="p">,</span>
	      <span class="n">u8</span>              <span class="n">value</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>dprintk(4, "%s: writing 0x%02x to 0x%04x\n",ptr->name,value,reg);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;0x%02x @0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>just in case something is wrong...</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">writereg</span><span class="p">)</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">master_data</span><span class="o">-&gt;</span><span class="n">writereg</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: invalid I/O setup, nothing written!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Local helper function:</span>

<span class="cm">   status read</span>
<span class="cm">   ========================================================================= */</span>

<span class="cm">/* status is kept in datastructure */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">zr36060_read_status</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">zr36060_read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_CFSR</span><span class="p">);</span>

	<span class="n">zr36060_read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Local helper function:</span>

<span class="cm">   scale factor read</span>
<span class="cm">   ========================================================================= */</span>

<span class="cm">/* scale factor is kept in datastructure */</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">zr36060_read_scalefactor</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scalefact</span> <span class="o">=</span> <span class="p">(</span><span class="n">zr36060_read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SF_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">zr36060_read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SF_LO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="cm">/* leave 0 selected for an eventually GO from master */</span>
	<span class="n">zr36060_read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scalefact</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Local helper function:</span>

<span class="cm">   wait if codec is ready to proceed (end of processing) or time is over</span>
<span class="cm">   ========================================================================= */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zr36060_wait_end</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">zr36060_read_status</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZR060_CFSR_Busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// 200ms, there is for sure something wrong!!!</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;%s: timeout at wait_end (last status: 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Local helper function:</span>

<span class="cm">   basic test of &quot;connectivity&quot;, writes/reads to/from memory the SOF marker</span>
<span class="cm">   ========================================================================= */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_basic_test</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">zr36060_read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_IDR_DEV</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x33</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">zr36060_read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_IDR_REV</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: attach failed, can&#39;t connect to jpeg processor!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zr36060_wait_end</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZR060_CFSR_Busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: attach failed, jpeg processor failed (end flag)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* looks good! */</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Local helper function:</span>

<span class="cm">   simple loop for pushing the init datasets</span>
<span class="cm">   ========================================================================= */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_pushit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
		<span class="n">u16</span>             <span class="n">startreg</span><span class="p">,</span>
		<span class="n">u16</span>             <span class="n">len</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span>     <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s: write data block to 0x%04x (len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">startreg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">startreg</span><span class="o">++</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Basic datasets:</span>

<span class="cm">   jpeg baseline setup data (you find it on lots places in internet, or just</span>
<span class="cm">   extract it from any regular .jpg image...)</span>

<span class="cm">   Could be variable, but until it&#39;s not needed it they are just fixed to save</span>
<span class="cm">   memory. Otherwise expand zr36060 structure with arrays, push the values to</span>
<span class="cm">   it and initialize from there, as e.g. the linux zr36057/60 driver does it.</span>
<span class="cm">   ========================================================================= */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zr36060_dqt</span><span class="p">[</span><span class="mh">0x86</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span>		<span class="c1">//Marker: DQT</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>		<span class="c1">//Length: 2*65+2</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="c1">//Pq,Tq first table</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span>
	<span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span>
	<span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span>
	<span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span>
	<span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span>
	<span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span>			<span class="c1">//Pq,Tq second table</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span>
	<span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zr36060_dht</span><span class="p">[</span><span class="mh">0x1a4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span>		<span class="c1">//Marker: DHT</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span>		<span class="c1">//Length: 2*AC, 2*DC</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="c1">//DC first table</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span>			<span class="c1">//DC second table</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span>			<span class="c1">//AC first table</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span>
	<span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span>
	<span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span>
	<span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span>
	<span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span>
	<span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span>
	<span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span>
	<span class="mh">0xBA</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span>
	<span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span>
	<span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span>
	<span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span>
	<span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span>
	<span class="mh">0x11</span><span class="p">,</span>			<span class="c1">//AC second table</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
	<span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span>
	<span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span>
	<span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span>
	<span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span>
	<span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span>
	<span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span>
	<span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span>
	<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span>
	<span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span>
	<span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span>
	<span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span>
	<span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span>
	<span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span>
	<span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span>
	<span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0xFA</span>
<span class="p">};</span>

<span class="cm">/* jpeg baseline setup, this is just fixed in this driver (YUV pictures) */</span>
<span class="cp">#define NO_OF_COMPONENTS          0x3	</span><span class="c1">//Y,U,V</span>
<span class="cp">#define BASELINE_PRECISION        0x8	</span><span class="c1">//MCU size (?)</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zr36060_tq</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>	<span class="c1">//table idx&#39;s QT</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zr36060_td</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>	<span class="c1">//table idx&#39;s DC</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zr36060_ta</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>	<span class="c1">//table idx&#39;s AC</span>

<span class="cm">/* horizontal 422 decimation setup (maybe we support 411 or so later, too) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zr36060_decimation_h</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zr36060_decimation_v</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Local helper functions:</span>

<span class="cm">   calculation and setup of parameter-dependent JPEG baseline segments</span>
<span class="cm">   (needed for compression only)</span>
<span class="cm">   ========================================================================= */</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cm">/* SOF (start of frame) segment depends on width, height and sampling ratio</span>
<span class="cm">			 of each color component */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_set_sof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">sof_data</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span>	<span class="c1">// max. size of register set</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: write SOF (%dx%d, %d components)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">);</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASELINE_PRECISION</span><span class="p">;</span>	<span class="c1">// only &#39;8&#39; possible with zr36060</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sof_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sof_data</span><span class="p">[</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>	<span class="c1">// index identifier</span>
		<span class="n">sof_data</span><span class="p">[</span><span class="mi">11</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">h_samp_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_samp_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="c1">// sampling ratios</span>
		<span class="n">sof_data</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">zr36060_tq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="c1">// Q table selection</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SOF_IDX</span><span class="p">,</span>
			      <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sof_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cm">/* SOS (start of scan) segment depends on the used scan components</span>
<span class="cm">			of each color component */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_set_sos</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">sos_data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="c1">// max. size of register set</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: write SOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xda</span><span class="p">;</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sos_data</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>	<span class="c1">// index</span>
		<span class="n">sos_data</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">zr36060_td</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">zr36060_ta</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">// AC/DC tbl.sel.</span>
	<span class="p">}</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mo">00</span><span class="p">;</span>	<span class="c1">// scan start</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">sos_data</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mo">00</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SOS_IDX</span><span class="p">,</span>
			      <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">NO_OF_COMPONENTS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
			      <span class="n">sos_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cm">/* DRI (define restart interval) */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_set_dri</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dri_data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>	<span class="c1">// max. size of register set</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: write DRI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dri_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dri_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdd</span><span class="p">;</span>
	<span class="n">dri_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dri_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">dri_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">dri</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dri_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">dri</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_DRI_IDX</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">dri_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Setup function:</span>

<span class="cm">   Setup compression/decompression of Zoran&#39;s JPEG processor</span>
<span class="cm">   ( see also zoran 36060 manual )</span>

<span class="cm">   ... sorry for the spaghetti code ...</span>
<span class="cm">   ========================================================================= */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">zr36060_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">bitcnt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CODEC_DO_COMPRESSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: COMPRESSION SETUP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_LOAD</span><span class="p">,</span> <span class="n">ZR060_LOAD_SyncRst</span><span class="p">);</span>

		<span class="cm">/* 060 communicates with 067 in master mode */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_CIR</span><span class="p">,</span> <span class="n">ZR060_CIR_CodeMstr</span><span class="p">);</span>

		<span class="cm">/* Compression with or without variable scale factor */</span>
		<span class="cm">/*FIXME: What about ptr-&gt;bitrate_ctrl? */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_CMR</span><span class="p">,</span>
			      <span class="n">ZR060_CMR_Comp</span> <span class="o">|</span> <span class="n">ZR060_CMR_Pass2</span> <span class="o">|</span>
			      <span class="n">ZR060_CMR_BRB</span><span class="p">);</span>

		<span class="cm">/* Must be zero */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_MBZ</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCR_HI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCR_LO</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* Disable all IRQs - no DataErr means autoreset */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* volume control settings */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SF_HI</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scalefact</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SF_LO</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scalefact</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AF_HI</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AF_M</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AF_LO</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* setup the variable jpeg tables */</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">zr36060_set_sof</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">zr36060_set_sos</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">zr36060_set_dri</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

		<span class="cm">/* setup the fixed jpeg tables - maybe variable, though -</span>
<span class="cm">		 * (see table init section above) */</span>
		<span class="n">sum</span> <span class="o">+=</span>
		    <span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_DQT_IDX</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zr36060_dqt</span><span class="p">),</span>
				   <span class="n">zr36060_dqt</span><span class="p">);</span>
		<span class="n">sum</span> <span class="o">+=</span>
		    <span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_DHT_IDX</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zr36060_dht</span><span class="p">),</span>
				   <span class="n">zr36060_dht</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_APP_IDX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_APP_IDX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xe0</span> <span class="o">+</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">appn</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_APP_IDX</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_APP_IDX</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_APP_IDX</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
				      <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_COM_IDX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_COM_IDX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_COM_IDX</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_COM_IDX</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_COM_IDX</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
				      <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* setup misc. data for compression (target code sizes) */</span>

		<span class="cm">/* size of compressed code to reach without header data */</span>
		<span class="n">sum</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">real_code_vol</span> <span class="o">-</span> <span class="n">sum</span><span class="p">;</span>
		<span class="n">bitcnt</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* need the size in bits */</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bitcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
			<span class="s">&quot;%s: code: csize=%d, tot=%d, bit=%ld, highbits=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">real_code_vol</span><span class="p">,</span> <span class="n">bitcnt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_NET_HI</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_NET_MH</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bitcnt</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_NET_ML</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_NET_LO</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="n">bitcnt</span> <span class="o">-=</span> <span class="n">bitcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>	<span class="c1">// bits without stuffing</span>
		<span class="n">bitcnt</span> <span class="o">-=</span> <span class="p">((</span><span class="n">bitcnt</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="c1">// bits without eob</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bitcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: code: nettobit=%ld, highnettobits=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bitcnt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_DATA_HI</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_DATA_MH</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bitcnt</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_DATA_ML</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCV_DATA_LO</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* JPEG markers to be included in the compressed stream */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_MER</span><span class="p">,</span>
			      <span class="n">ZR060_MER_DQT</span> <span class="o">|</span> <span class="n">ZR060_MER_DHT</span> <span class="o">|</span>
			      <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">ZR060_MER_Com</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">ZR060_MER_App</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

		<span class="cm">/* Setup the Video Frontend */</span>
		<span class="cm">/* Limit pixel range to 16..235 as per CCIR-601 */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_VCR</span><span class="p">,</span> <span class="n">ZR060_VCR_Range</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: EXPANSION SETUP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_LOAD</span><span class="p">,</span> <span class="n">ZR060_LOAD_SyncRst</span><span class="p">);</span>

		<span class="cm">/* 060 communicates with 067 in master mode */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_CIR</span><span class="p">,</span> <span class="n">ZR060_CIR_CodeMstr</span><span class="p">);</span>

		<span class="cm">/* Decompression */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_CMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Must be zero */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_MBZ</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCR_HI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_TCR_LO</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* Disable all IRQs - no DataErr means autoreset */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* setup misc. data for expansion */</span>
		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_MER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* setup the fixed jpeg tables - maybe variable, though -</span>
<span class="cm">		 * (see table init section above) */</span>
		<span class="n">zr36060_pushit</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_DHT_IDX</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zr36060_dht</span><span class="p">),</span>
			       <span class="n">zr36060_dht</span><span class="p">);</span>

		<span class="cm">/* Setup the Video Frontend */</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>zr36060<em>write(ptr, ZR060</em>VCR, ZR060<em>VCR</em>FIExt);
this doesn't seem right and doesn't work...</p></td><td class="code"><div class="highlight"><pre>		<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_VCR</span><span class="p">,</span> <span class="n">ZR060_VCR_Range</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Load the tables */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_LOAD</span><span class="p">,</span>
		      <span class="n">ZR060_LOAD_SyncRst</span> <span class="o">|</span> <span class="n">ZR060_LOAD_Load</span><span class="p">);</span>
	<span class="n">zr36060_wait_end</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: Status after table preload: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZR060_CFSR_Busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;%s: init aborted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>		<span class="c1">// something is wrong, its timed out!!!!</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   CODEC API FUNCTIONS</span>

<span class="cm">   this functions are accessed by the master via the API structure</span>
<span class="cm">   ========================================================================= */</span>

<span class="cm">/* set compression/expansion mode and launches codec -</span>
<span class="cm">   this should be the last call from the master before starting processing */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_set_mode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
		  <span class="kt">int</span>                <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: set_mode %d call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">CODEC_DO_EXPANSION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">CODEC_DO_COMPRESSION</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">zr36060_init</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set picture size (norm is ignored as the codec doesn&#39;t know about it) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_set_video</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span>   <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">tvnorm</span>       <span class="o">*</span><span class="n">norm</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">vfe_settings</span> <span class="o">*</span><span class="n">cap</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">vfe_polarity</span> <span class="o">*</span><span class="n">pol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: set_video %d/%d-%dx%d (%%%d) call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">);</span>

	<span class="cm">/* if () return -EINVAL;</span>
<span class="cm">	 * trust the master driver that it knows what it does - so</span>
<span class="cm">	 * we allow invalid startx/y and norm for now ... */</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_LOAD</span><span class="p">,</span> <span class="n">ZR060_LOAD_SyncRst</span><span class="p">);</span>

	<span class="cm">/* Note that VSPol/HSPol bits in zr36060 have the opposite</span>
<span class="cm">	 * meaning of their zr360x7 counterparts with the same names</span>
<span class="cm">	 * N.b. for VSPol this is only true if FIVEdge = 0 (default,</span>
<span class="cm">	 * left unchanged here - in accordance with datasheet).</span>
<span class="cm">	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">vsync_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_VSPol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">hsync_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_HSPol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">field_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_FIPol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">blank_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_BLPol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">subimg_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_SImgPol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">poe_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_PoePol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">pvalid_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_PValPol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">vclk_pol</span> <span class="o">?</span> <span class="n">ZR060_VPR_VCLKPol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_VPR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ZR060_SR_HScale2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ZR060_SR_HScale4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ZR060_SR_VScale</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_BCR_Y</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_BCR_U</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_BCR_V</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* sync generator */</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">Ht</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Vtotal */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_VTOTAL_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_VTOTAL_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">Wt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Htotal */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_HTOTAL_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_HTOTAL_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* VsyncSize */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_VSYNC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>reg   = 30 - 1;               /* HsyncSize <em>/
/</em>CP*/        reg = (zr->params.norm == 1 ? 57 : 68);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">reg</span> <span class="o">=</span> <span class="mi">68</span><span class="p">;</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_HSYNC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">VStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* BVstart */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_BVSTART</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">+=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">Ha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* BVend */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_BVEND_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_BVEND_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">HStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* BHstart */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_BHSTART</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">+=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">Wa</span><span class="p">;</span>	<span class="cm">/* BHend */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_BHEND_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SGR_BHEND_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* active area */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">+</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">VStart</span><span class="p">;</span>	<span class="cm">/* Vstart */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_VSTART_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_VSTART_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">+=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>	<span class="cm">/* Vend */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_VEND_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_VEND_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">+</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">HStart</span><span class="p">;</span>	<span class="cm">/* Hstart */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_HSTART_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_HSTART_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">+=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>	<span class="cm">/* Hend */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_HEND_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_AAR_HEND_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* subimage area */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">VStart</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* SVstart */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_VSTART_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_VSTART_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">+=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">Ha</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* SVend */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_VEND_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_VEND_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">HStart</span> <span class="cm">/*+ 64 */</span>  <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* SHstart */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_HSTART_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_HSTART_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">+=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">Wa</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* SHend */</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_HEND_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_SWR_HEND_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/* Target compressed field size in bits: */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* uncompressed size in bits */</span>
	<span class="cm">/* (Ronald) by default, quality = 100 is a compression</span>
<span class="cm">	 * ratio 1:2. Setting low_bitrate (insmod option) sets</span>
<span class="cm">	 * it to 1:4 (instead of 1:2, zr36060 max) as limit because the</span>
<span class="cm">	 * buz can&#39;t handle more at decimation=1... Use low_bitrate if</span>
<span class="cm">	 * you have a Buz, unless you know what you&#39;re doing */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">/</span> <span class="p">(</span><span class="n">low_bitrate</span> <span class="o">?</span> <span class="mi">400</span> <span class="o">:</span> <span class="mi">200</span><span class="p">);</span>
	<span class="cm">/* Lower limit (arbitrary, 1 KB) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">8192</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="cm">/* Upper limit: 7/8 of the code buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">total_code_vol</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">total_code_vol</span> <span class="o">*</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">real_code_vol</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* in bytes */</span>

	<span class="cm">/* the MBCVR is the *maximum* block volume, according to the</span>
<span class="cm">	 * JPEG ISO specs, this shouldn&#39;t be used, since that allows</span>
<span class="cm">	 * for the best encoding quality. So set it to it&#39;s max value */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">max_block_vol</span><span class="p">;</span>
	<span class="n">zr36060_write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ZR060_MBCVR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* additional control functions */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_control</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
		 <span class="kt">int</span>                <span class="n">type</span><span class="p">,</span>
		 <span class="kt">int</span>                <span class="n">size</span><span class="p">,</span>
		 <span class="kt">void</span>              <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">ival</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: control %d call with %d byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
		<span class="n">size</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CODEC_G_STATUS</span>:	<span class="cm">/* get last status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">zr36060_read_status</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ival</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_G_CODEC_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ival</span> <span class="o">=</span> <span class="n">CODEC_MODE_BJPG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_S_CODEC_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ival</span> <span class="o">!=</span> <span class="n">CODEC_MODE_BJPG</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* not needed, do nothing */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_G_VFE</span>:
	<span class="k">case</span> <span class="n">CODEC_S_VFE</span>:
		<span class="cm">/* not needed, do nothing */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_S_MMAP</span>:
		<span class="cm">/* not available, give an error */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_G_JPEG_TDS_BYTE</span>:	<span class="cm">/* get target volume in byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ival</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">total_code_vol</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_S_JPEG_TDS_BYTE</span>:	<span class="cm">/* get target volume in byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">total_code_vol</span> <span class="o">=</span> <span class="o">*</span><span class="n">ival</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">real_code_vol</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">total_code_vol</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_G_JPEG_SCALE</span>:	<span class="cm">/* get scaling factor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ival</span> <span class="o">=</span> <span class="n">zr36060_read_scalefactor</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_S_JPEG_SCALE</span>:	<span class="cm">/* set scaling factor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scalefact</span> <span class="o">=</span> <span class="o">*</span><span class="n">ival</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CODEC_G_JPEG_APP_DATA</span>: <span class="p">{</span>	<span class="cm">/* get appn marker data */</span>
		<span class="k">struct</span> <span class="n">jpeg_app_marker</span> <span class="o">*</span><span class="n">app</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jpeg_app_marker</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="o">*</span><span class="n">app</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CODEC_S_JPEG_APP_DATA</span>: <span class="p">{</span>	<span class="cm">/* set appn marker data */</span>
		<span class="k">struct</span> <span class="n">jpeg_app_marker</span> <span class="o">*</span><span class="n">app</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jpeg_app_marker</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span> <span class="o">=</span> <span class="o">*</span><span class="n">app</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CODEC_G_JPEG_COM_DATA</span>: <span class="p">{</span>	<span class="cm">/* get comment marker data */</span>
		<span class="k">struct</span> <span class="n">jpeg_com_marker</span> <span class="o">*</span><span class="n">com</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jpeg_com_marker</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="o">*</span><span class="n">com</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CODEC_S_JPEG_COM_DATA</span>: <span class="p">{</span>	<span class="cm">/* set comment marker data */</span>
		<span class="k">struct</span> <span class="n">jpeg_com_marker</span> <span class="o">*</span><span class="n">com</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jpeg_com_marker</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">com</span> <span class="o">=</span> <span class="o">*</span><span class="n">com</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Exit and unregister function:</span>

<span class="cm">   Deinitializes Zoran&#39;s JPEG processor</span>
<span class="cm">   ========================================================================= */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_unset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* do wee need some codec deinit here, too ???? */</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: finished codec #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">zr36060_codecs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   Setup and registry function:</span>

<span class="cm">   Initializes Zoran&#39;s JPEG processor</span>

<span class="cm">   Also sets pixel size, average code size, mode (compr./decompr.)</span>
<span class="cm">   (the given size is determined by the processor with the video interface)</span>
<span class="cm">   ========================================================================= */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">zr36060_setup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">videocodec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zr36060</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;zr36060: initializing MJPEG subsystem #%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">zr36060_codecs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zr36060_codecs</span> <span class="o">==</span> <span class="n">MAX_CODECS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;zr36060: Can&#39;t attach more codecs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>mem structure init</p></td><td class="code"><div class="highlight"><pre>	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zr36060</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;zr36060: Can&#39;t get enough memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;zr36060[%d]&quot;</span><span class="p">,</span>
		 <span class="n">zr36060_codecs</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">zr36060_codecs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>testing</p></td><td class="code"><div class="highlight"><pre>	<span class="n">res</span> <span class="o">=</span> <span class="n">zr36060_basic_test</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zr36060_unset</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>final setup</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">h_samp_ratio</span><span class="p">,</span> <span class="n">zr36060_decimation_h</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_samp_ratio</span><span class="p">,</span> <span class="n">zr36060_decimation_v</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">bitrate_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 0 or 1 - fixed file size flag</span>
<span class="cm">				 * (what is the difference?) */</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">CODEC_DO_COMPRESSION</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">384</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">288</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">total_code_vol</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>	<span class="cm">/* CHECKME */</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">real_code_vol</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">total_code_vol</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">max_block_vol</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>	<span class="cm">/* CHECKME, was 120 is 240 */</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scalefact</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">dri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* CHECKME, was 8 is 1 */</span>

	<span class="cm">/* by default, no COM or APP markers - app should set those */</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">appn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">zr36060_init</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: codec attached and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">videocodec</span> <span class="n">zr36060_codec</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zr36060&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">,</span>		<span class="c1">// magic not used</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
	    <span class="n">CODEC_FLAG_JPEG</span> <span class="o">|</span> <span class="n">CODEC_FLAG_HARDWARE</span> <span class="o">|</span> <span class="n">CODEC_FLAG_ENCODER</span> <span class="o">|</span>
	    <span class="n">CODEC_FLAG_DECODER</span> <span class="o">|</span> <span class="n">CODEC_FLAG_VFE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CODEC_TYPE_ZR36060</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">zr36060_setup</span><span class="p">,</span>	<span class="c1">// functionality</span>
	<span class="p">.</span><span class="n">unset</span> <span class="o">=</span> <span class="n">zr36060_unset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mode</span> <span class="o">=</span> <span class="n">zr36060_set_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_video</span> <span class="o">=</span> <span class="n">zr36060_set_video</span><span class="p">,</span>
	<span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">zr36060_control</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>others are not used</p></td><td class="code"><div class="highlight"><pre><span class="p">};</span>

<span class="cm">/* =========================================================================</span>
<span class="cm">   HOOK IN DRIVER AS KERNEL MODULE</span>
<span class="cm">   ========================================================================= */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">zr36060_init_module</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>dprintk(1, "zr36060 driver %s\n",ZR060_VERSION);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">zr36060_codecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videocodec_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr36060_codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">zr36060_cleanup_module</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zr36060_codecs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="s">&quot;zr36060: something&#39;s wrong - %d codecs left somehow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">zr36060_codecs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* however, we can&#39;t just stay alive */</span>
	<span class="n">videocodec_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zr36060_codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">zr36060_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">zr36060_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Laurent Pinchart &lt;laurent.pinchart@skynet.be&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver module for ZR36060 jpeg processors &quot;</span>
		   <span class="n">ZR060_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
