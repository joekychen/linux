<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › c-qcam.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>c-qcam.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Video4Linux Colour QuickCam driver</span>
<span class="cm"> *	Copyright 1997-2000 Philip Blundell &lt;philb@gnu.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *    Module parameters:</span>
<span class="cm"> *</span>
<span class="cm"> *	parport=auto      -- probe all parports (default)</span>
<span class="cm"> *	parport=0         -- parport0 becomes qcam1</span>
<span class="cm"> *	parport=2,0,1     -- parports 2,0,1 are tried in that order</span>
<span class="cm"> *</span>
<span class="cm"> *	probe=0		  -- do no probing, assume camera is present</span>
<span class="cm"> *	probe=1		  -- use IEEE-1284 autoprobe data only (default)</span>
<span class="cm"> *	probe=2		  -- probe aggressively for cameras</span>
<span class="cm"> *</span>
<span class="cm"> *	force_rgb=1       -- force data format to RGB (default is BGR)</span>
<span class="cm"> *</span>
<span class="cm"> * The parport parameter controls which parports will be scanned.</span>
<span class="cm"> * Scanning all parports causes some printers to print a garbage page.</span>
<span class="cm"> *       -- March 14, 1999  Billy Donahue &lt;billy@escape.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed data format to BGR, added force_rgb parameter. Added missing</span>
<span class="cm"> * parport_unregister_driver() on module removal.</span>
<span class="cm"> *       -- May 28, 2000  Claudio Matsuoka &lt;claudio@conectiva.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/parport.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-fh.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>

<span class="k">struct</span> <span class="n">qcam</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccd_width</span><span class="p">,</span> <span class="n">ccd_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">whitebal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bidirectional</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* cameras maximum */</span>
<span class="cp">#define MAX_CAMS 4</span>

<span class="cm">/* The three possible QuickCam modes */</span>
<span class="cp">#define QC_MILLIONS	0x18</span>
<span class="cp">#define QC_BILLIONS	0x10</span>
<span class="cp">#define QC_THOUSANDS	0x08	</span><span class="cm">/* with VIDEC compression (not supported) */</span><span class="cp"></span>

<span class="cm">/* The three possible decimations */</span>
<span class="cp">#define QC_DECIMATION_1		0</span>
<span class="cp">#define QC_DECIMATION_2		2</span>
<span class="cp">#define QC_DECIMATION_4		4</span>

<span class="cp">#define BANNER &quot;Colour QuickCam for Video4Linux v0.06&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">parport</span><span class="p">[</span><span class="n">MAX_CAMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">1</span> <span class="p">...</span> <span class="n">MAX_CAMS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">probe</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">force_rgb</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* FIXME: parport=auto would never have worked, surely? --RR */</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">parport</span><span class="p">,</span> <span class="s">&quot;parport=&lt;auto|n[,n]...&gt; for port detection method</span><span class="se">\n</span><span class="s">&quot;</span>
			  <span class="s">&quot;probe=&lt;0|1|2&gt; for camera detection method</span><span class="se">\n</span><span class="s">&quot;</span>
			  <span class="s">&quot;force_rgb=&lt;0|1&gt; for RGB data format (default BGR)&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">parport</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_rgb</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcams</span><span class="p">[</span><span class="n">MAX_CAMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_cams</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qcam_set_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* note: the QC specs refer to the PCAck pin by voltage, not</span>
<span class="cm">	   software level.  PC ports have builtin inverters. */</span>
	<span class="n">parport_frob_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qcam_ready1</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qcam_ready2</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">parport_read_data</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qcam_await_ready1</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">oldjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	     <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">oldjiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">40</span><span class="p">));)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the camera didn&#39;t respond within 1/25 second, poll slowly</span>
<span class="cm">	   for a while. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Probably somebody pulled the plug out.  Not much we can do. */</span>
	<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;ready1 timeout (%d) %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
	       <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">),</span>
	       <span class="n">parport_read_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qcam_await_ready2</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">oldjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	     <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">oldjiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">40</span><span class="p">));)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_ready2</span><span class="p">(</span><span class="n">qcam</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the camera didn&#39;t respond within 1/25 second, poll slowly</span>
<span class="cm">	   for a while. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_ready2</span><span class="p">(</span><span class="n">qcam</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Probably somebody pulled the plug out.  Not much we can do. */</span>
	<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;ready2 timeout (%d) %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
	       <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">),</span>
	       <span class="n">parport_read_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">),</span>
	       <span class="n">parport_read_data</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idata</span><span class="p">;</span>

	<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">idata</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">idata</span> <span class="o">|=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">idata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idata</span><span class="p">;</span>

	<span class="n">parport_write_data</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">idata</span> <span class="o">=</span> <span class="n">qcam_read_data</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;sent %x but received %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
		       <span class="n">idata</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qcam_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam_write_data</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam_write_data</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qcam_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam_write_data</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qcam_read_data</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qc_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">ostat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The probe routine below is not very reliable.  The IEEE-1284</span>
<span class="cm">	   probe takes precedence. */</span>
	<span class="cm">/* XXX Currently parport provides no way to distinguish between</span>
<span class="cm">	   &quot;the IEEE probe was not done&quot; and &quot;the probe was done, but</span>
<span class="cm">	   no device was found&quot;.  Fix this one day. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">probe_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">class</span> <span class="o">==</span> <span class="n">PARPORT_CLASS_MEDIA</span>
	    <span class="o">&amp;&amp;</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">probe_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">model</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">probe_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">model</span><span class="p">,</span>
		       <span class="s">&quot;Color QuickCam 2.0&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;QuickCam: Found by IEEE1284 probe.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probe</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>

	<span class="cm">/* look for a heartbeat */</span>
	<span class="n">ostat</span> <span class="o">=</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ostat</span> <span class="o">!=</span> <span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ostat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the camera and try again */</span>
	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ostat</span> <span class="o">=</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ostat</span> <span class="o">!=</span> <span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ostat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* no (or flatline) camera, give up */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reset the QuickCam and program for brightness, contrast,</span>
<span class="cm"> * white-balance, and resolution. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qc_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qc_reset</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>

	<span class="cm">/* Set the brightness. */</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">);</span>

	<span class="cm">/* Set the height and width.  These refer to the actual</span>
<span class="cm">	   CCD area *before* applying the selected decimation.  */</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">ccd_height</span><span class="p">);</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">ccd_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Set top and left.  */</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>

	<span class="cm">/* Set contrast and white balance.  */</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">);</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">whitebal</span><span class="p">);</span>

	<span class="cm">/* Set the speed.  */</span>
	<span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read some bytes from the camera and put them in the buffer.</span>
<span class="cm">   nbytes should be a multiple of 3, because bidirectional mode gives</span>
<span class="cm">   us three bytes at a time.  */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qcam_read_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">bidirectional</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a bidirectional port */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lo1</span><span class="p">,</span> <span class="n">hi1</span><span class="p">,</span> <span class="n">lo2</span><span class="p">,</span> <span class="n">hi2</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready2</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">lo1</span> <span class="o">=</span> <span class="n">parport_read_data</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hi1</span> <span class="o">=</span> <span class="p">((</span><span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready2</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">lo2</span> <span class="o">=</span> <span class="n">parport_read_data</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hi2</span> <span class="o">=</span> <span class="p">((</span><span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">lo1</span> <span class="o">|</span> <span class="p">((</span><span class="n">hi1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">g</span> <span class="o">=</span> <span class="p">((</span><span class="n">hi1</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">hi2</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">lo2</span> <span class="o">|</span> <span class="p">((</span><span class="n">hi2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">force_rgb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bytes</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bytes</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bytes</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bytes</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bytes</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bytes</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a unidirectional port */</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
			<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">parport_read_status</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
			<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* flip some bits */</span>
			<span class="n">rgb</span><span class="p">[(</span><span class="n">i</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">++</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">|</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">^</span> <span class="mh">0x88</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">get_fragment:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">force_rgb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">get_fragment</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BUFSZ	150</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">qc_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lines</span><span class="p">,</span> <span class="n">pixelsperline</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_bi_dir</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">bidirectional</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">wantlen</span><span class="p">,</span> <span class="n">outptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="n">BUFSZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Wait for camera to become ready */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">qcam_get</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">41</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qcam_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|</span> <span class="p">(</span><span class="n">is_bi_dir</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">lines</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pixelsperline</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_bi_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn the port around */</span>
		<span class="n">parport_data_reverse</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wantlen</span> <span class="o">=</span> <span class="n">lines</span> <span class="o">*</span> <span class="n">pixelsperline</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">wantlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>

		<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">wantlen</span> <span class="o">&gt;</span> <span class="n">BUFSZ</span><span class="p">)</span> <span class="o">?</span> <span class="n">BUFSZ</span> <span class="o">:</span> <span class="n">wantlen</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">qcam_read_bytes</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">outptr</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">outptr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span>
				<span class="n">sz</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">outptr</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">sz</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">outptr</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wantlen</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">outptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wantlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;short read.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_bi_dir</span><span class="p">)</span>
			<span class="n">parport_data_forward</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_bi_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">qcam_read_bytes</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmpbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7e</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7e</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7e</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force_rgb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmpbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xe</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x0</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf</span><span class="p">)</span>
				<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;bad EOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmpbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x0</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xe</span><span class="p">)</span>
				<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;bad EOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;no ack after EOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">parport_data_forward</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
			<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">parport_data_forward</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">qcam_set_ack</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam_await_ready1</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;no ack to port turnaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">qcam_read_bytes</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7e</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">qcam_read_bytes</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">tmpbuf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force_rgb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmpbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xe</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x0</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf</span><span class="p">)</span>
				<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;bad EOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmpbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x0</span> <span class="o">||</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xe</span><span class="p">)</span>
				<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;bad EOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qcam_write_data</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Video4linux interfacing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">vcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Color Quickcam&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;parport&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_READWRITE</span><span class="p">;</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">vcap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">|</span> <span class="n">V4L2_CAP_DEVICE_CAPS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Camera&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">audioset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">inp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/* Just a guess */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="o">||</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">120</span> <span class="o">||</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">160</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/* Just a guess */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">qcam_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">60</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">QC_DECIMATION_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">QC_DECIMATION_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">QC_DECIMATION_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">QC_MILLIONS</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">parport_claim_or_block</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
	<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="s">&quot;RGB 8:8:8&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">},</span>
	<span class="p">};</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qcam_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">parport_claim_or_block</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/* Probably should have a semaphore against multiple users */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">qc_capture</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qcam</span><span class="p">,</span> <span class="n">hdl</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_GAMMA</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">whitebal</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parport_claim_or_block</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">qcam_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">v4l2_fh_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">v4l2_fh_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">v4l2_ctrl_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">qcam_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">qcam_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>    		    <span class="o">=</span> <span class="n">qcam_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>      		    <span class="o">=</span> <span class="n">qcam_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>      		    <span class="o">=</span> <span class="n">qcam_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>   		    <span class="o">=</span> <span class="n">qcam_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span>	    <span class="o">=</span> <span class="n">qcam_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> 		    <span class="o">=</span> <span class="n">qcam_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>  		    <span class="o">=</span> <span class="n">qcam_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>  	    <span class="o">=</span> <span class="n">qcam_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_log_status</span>		    <span class="o">=</span> <span class="n">v4l2_ctrl_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_subscribe_event</span>		    <span class="o">=</span> <span class="n">v4l2_ctrl_subscribe_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_unsubscribe_event</span>	    <span class="o">=</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">qcam_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">qcam_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Initialize the QuickCam driver control structure. */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="nf">qcam_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">;</span>

	<span class="n">qcam</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qcam</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;c-qcam&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Could not register v4l2_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">240</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">192</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_GAMMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">parport_register_device</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;c-qcam&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">bidirectional</span> <span class="o">=</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_TRISTATE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register for %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Colour QuickCam&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam_fops</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam_ioctl_ops</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release_empty</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_USE_FH_PRIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">qcam</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">ccd_width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">ccd_height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">QC_MILLIONS</span> <span class="o">|</span> <span class="n">QC_DECIMATION_1</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">whitebal</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qcam</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_cqcam</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parport</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The user gave specific instructions */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CAMS</span> <span class="o">&amp;&amp;</span> <span class="n">parport</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parport</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_cams</span> <span class="o">==</span> <span class="n">MAX_CAMS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="n">qcam</span> <span class="o">=</span> <span class="n">qcam_init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>

	<span class="n">parport_claim_or_block</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">qc_reset</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probe</span> <span class="o">&amp;&amp;</span> <span class="n">qc_detect</span><span class="p">(</span><span class="n">qcam</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qc_setup</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>

	<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="n">video_nr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Unable to register Colour QuickCam on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;%s: Colour QuickCam found on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">video_device_node_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">),</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">qcams</span><span class="p">[</span><span class="n">num_cams</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">qcam</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_cqcam</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cq_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_cqcam</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cq_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Write this some day. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">parport_driver</span> <span class="n">cqcam_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cqcam&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">cq_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">cq_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cqcam_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">BANNER</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">parport_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqcam_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cqcam_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">close_cqcam</span><span class="p">(</span><span class="n">qcams</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">parport_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqcam_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Philip Blundell &lt;philb@gnu.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">BANNER</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.0.4&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cqcam_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cqcam_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
