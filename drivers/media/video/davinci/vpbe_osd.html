<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › davinci › vpbe_osd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>vpbe_osd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2007-2010 Texas Instruments Inc</span>
<span class="cm"> * Copyright (C) 2007 MontaVista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Andy Lowe (alowe@mvista.com), MontaVista Software</span>
<span class="cm"> * - Initial version</span>
<span class="cm"> * Murali Karicheri (mkaricheri@gmail.com), Texas Instruments Ltd.</span>
<span class="cm"> * - ported to sub device interface</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;mach/cputype.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cp">#include &lt;media/davinci/vpss.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe_types.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe_osd.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &quot;vpbe_osd_regs.h&quot;</span>

<span class="cp">#define MODULE_NAME	VPBE_OSD_SUBDEV_NAME</span>

<span class="cm">/* register access routines */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">osd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">osd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">osd_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">osd_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">osd_modify</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">new_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* define some macros for layer and pixfmt classification */</span>
<span class="cp">#define is_osd_win(layer) (((layer) == WIN_OSD0) || ((layer) == WIN_OSD1))</span>
<span class="cp">#define is_vid_win(layer) (((layer) == WIN_VID0) || ((layer) == WIN_VID1))</span>
<span class="cp">#define is_rgb_pixfmt(pixfmt) \</span>
<span class="cp">	(((pixfmt) == PIXFMT_RGB565) || ((pixfmt) == PIXFMT_RGB888))</span>
<span class="cp">#define is_yc_pixfmt(pixfmt) \</span>
<span class="cp">	(((pixfmt) == PIXFMT_YCbCrI) || ((pixfmt) == PIXFMT_YCrCbI) || \</span>
<span class="cp">	((pixfmt) == PIXFMT_NV12))</span>
<span class="cp">#define MAX_WIN_SIZE OSD_VIDWIN0XP_V0X</span>
<span class="cp">#define MAX_LINE_LENGTH (OSD_VIDWIN0OFST_V0LO &lt;&lt; 5)</span>

<span class="cm">/**</span>
<span class="cm"> * _osd_dm6446_vid0_pingpong() - field inversion fix for DM6446</span>
<span class="cm"> * @sd - ptr to struct osd_state</span>
<span class="cm"> * @field_inversion - inversion flag</span>
<span class="cm"> * @fb_base_phys - frame buffer address</span>
<span class="cm"> * @lconfig - ptr to layer config</span>
<span class="cm"> *</span>
<span class="cm"> * This routine implements a workaround for the field signal inversion silicon</span>
<span class="cm"> * erratum described in Advisory 1.3.8 for the DM6446.  The fb_base_phys and</span>
<span class="cm"> * lconfig parameters apply to the vid0 window.  This routine should be called</span>
<span class="cm"> * whenever the vid0 layer configuration or start address is modified, or when</span>
<span class="cm"> * the OSD field inversion setting is modified.</span>
<span class="cm"> * Returns: 1 if the ping-pong buffers need to be toggled in the vsync isr, or</span>
<span class="cm"> *          0 otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_dm6446_vid0_pingpong</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">field_inversion</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_base_phys</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">lconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osd_platform_data</span> <span class="o">*</span><span class="p">)</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">field_inv_wa_enable</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field_inversion</span> <span class="o">||</span> <span class="o">!</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">,</span> <span class="n">OSD_VIDWIN0ADR</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">,</span> <span class="n">OSD_PPVWIN0ADR</span><span class="p">);</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_PPSW</span> <span class="o">|</span> <span class="n">OSD_MISCCTL_PPRV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">OSD_MISCCTL</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">miscctl</span> <span class="o">=</span> <span class="n">OSD_MISCCTL_PPRV</span><span class="p">;</span>

			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
				<span class="p">(</span><span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">-</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">,</span>
				<span class="n">OSD_VIDWIN0ADR</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
				<span class="p">(</span><span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">+</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">,</span>
				<span class="n">OSD_PPVWIN0ADR</span><span class="p">);</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
				<span class="n">OSD_MISCCTL_PPSW</span> <span class="o">|</span> <span class="n">OSD_MISCCTL_PPRV</span><span class="p">,</span> <span class="n">miscctl</span><span class="p">,</span>
				<span class="n">OSD_MISCCTL</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_field_inversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">fsinv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">fsinv</span> <span class="o">=</span> <span class="n">OSD_MODE_FSINV</span><span class="p">;</span>

	<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MODE_FSINV</span><span class="p">,</span> <span class="n">fsinv</span><span class="p">,</span> <span class="n">OSD_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_blink_attribute</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">osd_blink_interval</span> <span class="n">blink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">osdatrmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osdatrmd</span> <span class="o">|=</span> <span class="n">OSD_OSDATRMD_BLNK</span><span class="p">;</span>
		<span class="n">osdatrmd</span> <span class="o">|=</span> <span class="n">blink</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDATRMD_BLNKINT_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* caller must ensure that OSD1 is configured in attribute mode */</span>
	<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDATRMD_BLNKINT</span> <span class="o">|</span> <span class="n">OSD_OSDATRMD_BLNK</span><span class="p">,</span> <span class="n">osdatrmd</span><span class="p">,</span>
		  <span class="n">OSD_OSDATRMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_rom_clut</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">osd_rom_clut</span> <span class="n">rom_clut</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rom_clut</span> <span class="o">==</span> <span class="n">ROM_CLUT0</span><span class="p">)</span>
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_RSEL</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_RSEL</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_palette_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pixel_value</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clut_index</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">osd_pix_format</span> <span class="n">pixfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">map_2bpp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">map_1bpp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">bmp_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bmp_shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bmp_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bmp_reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIXFMT_1BPP</span>:
		<span class="n">bmp_reg</span> <span class="o">=</span> <span class="n">map_1bpp</span><span class="p">[</span><span class="n">pixel_value</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_2BPP</span>:
		<span class="n">bmp_reg</span> <span class="o">=</span> <span class="n">map_2bpp</span><span class="p">[</span><span class="n">pixel_value</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_4BPP</span>:
		<span class="n">bmp_reg</span> <span class="o">=</span> <span class="n">pixel_value</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
		<span class="n">bmp_offset</span> <span class="o">=</span> <span class="n">OSD_W0BMP01</span> <span class="o">+</span> <span class="p">(</span><span class="n">bmp_reg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
		<span class="n">bmp_offset</span> <span class="o">=</span> <span class="n">OSD_W1BMP01</span> <span class="o">+</span> <span class="p">(</span><span class="n">bmp_reg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmp_reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bmp_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bmp_mask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bmp_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bmp_mask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">bmp_mask</span><span class="p">,</span> <span class="n">clut_index</span> <span class="o">&lt;&lt;</span> <span class="n">bmp_shift</span><span class="p">,</span> <span class="n">bmp_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_rec601_attenuation</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_ATN0E</span><span class="p">,</span>
			  <span class="n">enable</span> <span class="o">?</span> <span class="n">OSD_OSDWIN0MD_ATN0E</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_ATN0E</span><span class="p">,</span>
				  <span class="n">enable</span> <span class="o">?</span> <span class="n">OSD_OSDWIN0MD_ATN0E</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_EXTMODE_ATNOSD0EN</span><span class="p">,</span>
				  <span class="n">enable</span> <span class="o">?</span> <span class="n">OSD_EXTMODE_ATNOSD0EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">OSD_EXTMODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_ATN1E</span><span class="p">,</span>
			  <span class="n">enable</span> <span class="o">?</span> <span class="n">OSD_OSDWIN1MD_ATN1E</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_ATN1E</span><span class="p">,</span>
				  <span class="n">enable</span> <span class="o">?</span> <span class="n">OSD_OSDWIN1MD_ATN1E</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_EXTMODE_ATNOSD1EN</span><span class="p">,</span>
				  <span class="n">enable</span> <span class="o">?</span> <span class="n">OSD_EXTMODE_ATNOSD1EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">OSD_EXTMODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_blending_factor</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">osd_blending_factor</span> <span class="n">blend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_BLND0</span><span class="p">,</span>
			  <span class="n">blend</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN0MD_BLND0_SHIFT</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_BLND1</span><span class="p">,</span>
			  <span class="n">blend</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN1MD_BLND1_SHIFT</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_enable_rgb888_pixblend</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_BLDSEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_EXTMODE_OSD0BLDCHR</span><span class="p">,</span>
			  <span class="n">OSD_EXTMODE_OSD0BLDCHR</span><span class="p">,</span> <span class="n">OSD_EXTMODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_EXTMODE_OSD1BLDCHR</span><span class="p">,</span>
			  <span class="n">OSD_EXTMODE_OSD1BLDCHR</span><span class="p">,</span> <span class="n">OSD_EXTMODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_enable_color_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">colorkey</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">osd_pix_format</span> <span class="n">pixfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIXFMT_1BPP</span>:
	<span class="k">case</span> <span class="n">PIXFMT_2BPP</span>:
	<span class="k">case</span> <span class="n">PIXFMT_4BPP</span>:
	<span class="k">case</span> <span class="n">PIXFMT_8BPP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_TRANSPBMPIDX_BMP0</span><span class="p">,</span>
					  <span class="n">colorkey</span> <span class="o">&lt;&lt;</span>
					  <span class="n">OSD_TRANSPBMPIDX_BMP0_SHIFT</span><span class="p">,</span>
					  <span class="n">OSD_TRANSPBMPIDX</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_TRANSPBMPIDX_BMP1</span><span class="p">,</span>
					  <span class="n">colorkey</span> <span class="o">&lt;&lt;</span>
					  <span class="n">OSD_TRANSPBMPIDX_BMP1_SHIFT</span><span class="p">,</span>
					  <span class="n">OSD_TRANSPBMPIDX</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_RGB565</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">colorkey</span> <span class="o">&amp;</span> <span class="n">OSD_TRANSPVAL_RGBTRANS</span><span class="p">,</span>
				  <span class="n">OSD_TRANSPVAL</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">colorkey</span> <span class="o">&amp;</span> <span class="n">OSD_TRANSPVALL_RGBL</span><span class="p">,</span>
				  <span class="n">OSD_TRANSPVALL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_YCbCrI</span>:
	<span class="k">case</span> <span class="n">PIXFMT_YCrCbI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_TRANSPVALU_Y</span><span class="p">,</span> <span class="n">colorkey</span><span class="p">,</span>
				   <span class="n">OSD_TRANSPVALU</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_RGB888</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">colorkey</span> <span class="o">&amp;</span> <span class="n">OSD_TRANSPVALL_RGBL</span><span class="p">,</span>
				  <span class="n">OSD_TRANSPVALL</span><span class="p">);</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_TRANSPVALU_RGBU</span><span class="p">,</span> <span class="n">colorkey</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
				  <span class="n">OSD_TRANSPVALU</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
		<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_TE0</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
		<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_TE1</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_disable_color_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_TE0</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_TE1</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_osd_clut</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">osd_clut</span> <span class="n">clut</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">winmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">osdwin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">clut</span> <span class="o">==</span> <span class="n">RAM_CLUT</span><span class="p">)</span>
			<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN0MD_CLUTS0</span><span class="p">;</span>
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_CLUTS0</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSDWIN_OSD1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">clut</span> <span class="o">==</span> <span class="n">RAM_CLUT</span><span class="p">)</span>
			<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_CLUTS1</span><span class="p">;</span>
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_CLUTS1</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_zoom</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">osd_zoom_factor</span> <span class="n">h_zoom</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">osd_zoom_factor</span> <span class="n">v_zoom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">winmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WIN_OSD0</span>:
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">h_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN0MD_OHZ0_SHIFT</span><span class="p">);</span>
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN0MD_OVZ0_SHIFT</span><span class="p">);</span>
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_OHZ0</span> <span class="o">|</span> <span class="n">OSD_OSDWIN0MD_OVZ0</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span>
			  <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID0</span>:
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">h_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_VIDWINMD_VHZ0_SHIFT</span><span class="p">);</span>
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_VIDWINMD_VVZ0_SHIFT</span><span class="p">);</span>
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD_VHZ0</span> <span class="o">|</span> <span class="n">OSD_VIDWINMD_VVZ0</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span>
			  <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_OSD1</span>:
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">h_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN1MD_OHZ1_SHIFT</span><span class="p">);</span>
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN1MD_OVZ1_SHIFT</span><span class="p">);</span>
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_OHZ1</span> <span class="o">|</span> <span class="n">OSD_OSDWIN1MD_OVZ1</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span>
			  <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID1</span>:
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">h_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_VIDWINMD_VHZ1_SHIFT</span><span class="p">);</span>
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v_zoom</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_VIDWINMD_VVZ1_SHIFT</span><span class="p">);</span>
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD_VHZ1</span> <span class="o">|</span> <span class="n">OSD_VIDWINMD_VVZ1</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span>
			  <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_disable_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WIN_OSD0</span>:
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_OACT0</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID0</span>:
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD_ACT0</span><span class="p">,</span> <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_OSD1</span>:
		<span class="cm">/* disable attribute mode as well as disabling the window */</span>
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_OASW</span> <span class="o">|</span> <span class="n">OSD_OSDWIN1MD_OACT1</span><span class="p">,</span>
			  <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID1</span>:
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD_ACT1</span><span class="p">,</span> <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_disable_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">is_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">_osd_disable_layer</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_enable_attribute_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable attribute mode for OSD1 */</span>
	<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_OASW</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_enable_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WIN_OSD0</span>:
		<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD_OACT0</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID0</span>:
		<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD_ACT0</span><span class="p">,</span> <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_OSD1</span>:
		<span class="cm">/* enable OSD1 and disable attribute mode */</span>
		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD_OASW</span> <span class="o">|</span> <span class="n">OSD_OSDWIN1MD_OACT1</span><span class="p">,</span>
			  <span class="n">OSD_OSDWIN1MD_OACT1</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID1</span>:
		<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD_ACT1</span><span class="p">,</span> <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osd_enable_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">otherwin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * use otherwin flag to know this is the other vid window</span>
<span class="cm">	 * in YUV420 mode, if is, skip this check</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otherwin</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">is_allocated</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">is_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">)</span>
		<span class="n">_osd_enable_layer</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">_osd_enable_attribute_mode</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="n">_osd_set_blink_attribute</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">is_blinking</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">blink</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define OSD_SRC_ADDR_HIGH4	0x7800000</span>
<span class="cp">#define OSD_SRC_ADDR_HIGH7	0x7F0000</span>
<span class="cp">#define OSD_SRCADD_OFSET_SFT	23</span>
<span class="cp">#define OSD_SRCADD_ADD_SFT	16</span>
<span class="cp">#define OSD_WINADL_MASK		0xFFFF</span>
<span class="cp">#define OSD_WINOFST_MASK	0x1000</span>
<span class="cp">#define VPBE_REG_BASE		0x80000000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_start_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_base_phys</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cbcr_ofst</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WIN_OSD0</span>:
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">,</span> <span class="n">OSD_OSDWIN0ADR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_VID0</span>:
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">,</span> <span class="n">OSD_VIDWIN0ADR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_OSD1</span>:
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">,</span> <span class="n">OSD_OSDWIN1ADR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_VID1</span>:
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">,</span> <span class="n">OSD_VIDWIN1ADR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	      <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_offset_32</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">fb_base_phys</span> <span class="o">-</span> <span class="n">VPBE_REG_BASE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WIN_OSD0</span>:
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWINADH_O0AH</span><span class="p">,</span>
				  <span class="n">fb_offset_32</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
						   <span class="n">OSD_OSDWINADH_O0AH_SHIFT</span><span class="p">),</span>
				  <span class="n">OSD_OSDWINADH</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_OSDWIN0ADL_O0AL</span><span class="p">,</span>
				  <span class="n">OSD_OSDWIN0ADL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_VID0</span>:
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINADH_V0AH</span><span class="p">,</span>
				  <span class="n">fb_offset_32</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
						   <span class="n">OSD_VIDWINADH_V0AH_SHIFT</span><span class="p">),</span>
				  <span class="n">OSD_VIDWINADH</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_VIDWIN0ADL_V0AL</span><span class="p">,</span>
				  <span class="n">OSD_VIDWIN0ADL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_OSD1</span>:
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWINADH_O1AH</span><span class="p">,</span>
				  <span class="n">fb_offset_32</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
						   <span class="n">OSD_OSDWINADH_O1AH_SHIFT</span><span class="p">),</span>
				  <span class="n">OSD_OSDWINADH</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_OSDWIN1ADL_O1AL</span><span class="p">,</span>
				  <span class="n">OSD_OSDWIN1ADL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_VID1</span>:
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINADH_V1AH</span><span class="p">,</span>
				  <span class="n">fb_offset_32</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
						   <span class="n">OSD_VIDWINADH_V1AH_SHIFT</span><span class="p">),</span>
				  <span class="n">OSD_VIDWINADH</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_VIDWIN1ADL_V1AL</span><span class="p">,</span>
				  <span class="n">OSD_VIDWIN1ADL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_offset_32</span><span class="p">,</span> <span class="n">cbcr_offset_32</span><span class="p">;</span>

		<span class="n">fb_offset_32</span> <span class="o">=</span> <span class="n">fb_base_phys</span> <span class="o">-</span> <span class="n">VPBE_REG_BASE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cbcr_ofst</span><span class="p">)</span>
			<span class="n">cbcr_offset_32</span> <span class="o">=</span> <span class="n">cbcr_ofst</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cbcr_offset_32</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span>
					 <span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">.</span><span class="n">ysize</span><span class="p">;</span>
		<span class="n">cbcr_offset_32</span> <span class="o">+=</span> <span class="n">fb_offset_32</span><span class="p">;</span>
		<span class="n">fb_offset_32</span> <span class="o">=</span> <span class="n">fb_offset_32</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">cbcr_offset_32</span> <span class="o">=</span> <span class="n">cbcr_offset_32</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * DM365: start address is 27-bit long address b26 - b23 are</span>
<span class="cm">		 * in offset register b12 - b9, and * bit 26 has to be &#39;1&#39;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WIN_VID0</span>:
			<span class="k">case</span> <span class="n">WIN_VID1</span>:
				<span class="cm">/* Y is in VID0 */</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWIN0OFST_V0AH</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH4</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="p">(</span><span class="n">OSD_SRCADD_OFSET_SFT</span> <span class="o">-</span>
					 <span class="n">OSD_WINOFST_AH_SHIFT</span><span class="p">))</span> <span class="o">|</span>
					 <span class="n">OSD_WINOFST_MASK</span><span class="p">,</span> <span class="n">OSD_VIDWIN0OFST</span><span class="p">);</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINADH_V0AH</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					  <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
					  <span class="n">OSD_VIDWINADH_V0AH_SHIFT</span><span class="p">),</span>
					   <span class="n">OSD_VIDWINADH</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_WINADL_MASK</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN0ADL</span><span class="p">);</span>
				<span class="cm">/* CbCr is in VID1 */</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWIN1OFST_V1AH</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">cbcr_offset_32</span> <span class="o">&amp;</span>
					 <span class="n">OSD_SRC_ADDR_HIGH4</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="p">(</span><span class="n">OSD_SRCADD_OFSET_SFT</span> <span class="o">-</span>
					 <span class="n">OSD_WINOFST_AH_SHIFT</span><span class="p">))</span> <span class="o">|</span>
					 <span class="n">OSD_WINOFST_MASK</span><span class="p">,</span> <span class="n">OSD_VIDWIN1OFST</span><span class="p">);</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINADH_V1AH</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">cbcr_offset_32</span> <span class="o">&amp;</span>
					  <span class="n">OSD_SRC_ADDR_HIGH7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					  <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
					  <span class="n">OSD_VIDWINADH_V1AH_SHIFT</span><span class="p">),</span>
					  <span class="n">OSD_VIDWINADH</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">cbcr_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_WINADL_MASK</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN1ADL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WIN_OSD0</span>:
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0OFST_O0AH</span><span class="p">,</span>
				 <span class="p">((</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH4</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				 <span class="p">(</span><span class="n">OSD_SRCADD_OFSET_SFT</span> <span class="o">-</span>
				 <span class="n">OSD_WINOFST_AH_SHIFT</span><span class="p">))</span> <span class="o">|</span> <span class="n">OSD_WINOFST_MASK</span><span class="p">,</span>
				  <span class="n">OSD_OSDWIN0OFST</span><span class="p">);</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWINADH_O0AH</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				 <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
				 <span class="n">OSD_OSDWINADH_O0AH_SHIFT</span><span class="p">),</span> <span class="n">OSD_OSDWINADH</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_WINADL_MASK</span><span class="p">,</span>
					<span class="n">OSD_OSDWIN0ADL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_VID0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWIN0OFST_V0AH</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH4</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="p">(</span><span class="n">OSD_SRCADD_OFSET_SFT</span> <span class="o">-</span>
					 <span class="n">OSD_WINOFST_AH_SHIFT</span><span class="p">))</span> <span class="o">|</span>
					 <span class="n">OSD_WINOFST_MASK</span><span class="p">,</span> <span class="n">OSD_VIDWIN0OFST</span><span class="p">);</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINADH_V0AH</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					  <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
					  <span class="n">OSD_VIDWINADH_V0AH_SHIFT</span><span class="p">),</span>
					  <span class="n">OSD_VIDWINADH</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_WINADL_MASK</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN0ADL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_OSD1</span>:
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1OFST_O1AH</span><span class="p">,</span>
				 <span class="p">((</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH4</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				 <span class="p">(</span><span class="n">OSD_SRCADD_OFSET_SFT</span> <span class="o">-</span>
				 <span class="n">OSD_WINOFST_AH_SHIFT</span><span class="p">))</span> <span class="o">|</span> <span class="n">OSD_WINOFST_MASK</span><span class="p">,</span>
				  <span class="n">OSD_OSDWIN1OFST</span><span class="p">);</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_OSDWINADH_O1AH</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				  <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
				  <span class="n">OSD_OSDWINADH_O1AH_SHIFT</span><span class="p">),</span>
				  <span class="n">OSD_OSDWINADH</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_WINADL_MASK</span><span class="p">,</span>
					<span class="n">OSD_OSDWIN1ADL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WIN_VID1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWIN1OFST_V1AH</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH4</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="p">(</span><span class="n">OSD_SRCADD_OFSET_SFT</span> <span class="o">-</span>
					 <span class="n">OSD_WINOFST_AH_SHIFT</span><span class="p">))</span> <span class="o">|</span>
					 <span class="n">OSD_WINOFST_MASK</span><span class="p">,</span> <span class="n">OSD_VIDWIN1OFST</span><span class="p">);</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_VIDWINADH_V1AH</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_SRC_ADDR_HIGH7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					  <span class="p">(</span><span class="n">OSD_SRCADD_ADD_SFT</span> <span class="o">-</span>
					  <span class="n">OSD_VIDWINADH_V1AH_SHIFT</span><span class="p">),</span>
					  <span class="n">OSD_VIDWINADH</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fb_offset_32</span> <span class="o">&amp;</span> <span class="n">OSD_WINADL_MASK</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN1ADL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_start_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_base_phys</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cbcr_ofst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">=</span> <span class="n">fb_base_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">_osd_start_layer</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">fb_base_phys</span><span class="p">,</span> <span class="n">cbcr_ofst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_VID0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osd</span><span class="o">-&gt;</span><span class="n">pingpong</span> <span class="o">=</span>
		    <span class="n">_osd_dm6446_vid0_pingpong</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">field_inversion</span><span class="p">,</span>
						       <span class="n">win</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">,</span>
						       <span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_get_layer_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">lconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">lconfig</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * try_layer_config() - Try a specific configuration for the layer</span>
<span class="cm"> * @sd  - ptr to struct osd_state</span>
<span class="cm"> * @layer - layer to configure</span>
<span class="cm"> * @lconfig - layer configuration to try</span>
<span class="cm"> *</span>
<span class="cm"> * If the requested lconfig is completely rejected and the value of lconfig on</span>
<span class="cm"> * exit is the current lconfig, then try_layer_config() returns 1.  Otherwise,</span>
<span class="cm"> * try_layer_config() returns 0.  A return value of 0 does not necessarily mean</span>
<span class="cm"> * that the value of lconfig on exit is identical to the value of lconfig on</span>
<span class="cm"> * entry, but merely that it represents a change from the current lconfig.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_layer_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">lconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bad_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* verify that the pixel format is compatible with the layer */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIXFMT_1BPP</span>:
	<span class="k">case</span> <span class="n">PIXFMT_2BPP</span>:
	<span class="k">case</span> <span class="n">PIXFMT_4BPP</span>:
	<span class="k">case</span> <span class="n">PIXFMT_8BPP</span>:
	<span class="k">case</span> <span class="n">PIXFMT_RGB565</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span>
			<span class="n">bad_config</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_vid_win</span><span class="p">(</span><span class="n">layer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_YCbCrI</span>:
	<span class="k">case</span> <span class="n">PIXFMT_YCrCbI</span>:
		<span class="n">bad_config</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_vid_win</span><span class="p">(</span><span class="n">layer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_RGB888</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span>
			<span class="n">bad_config</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_vid_win</span><span class="p">(</span><span class="n">layer</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span>
			<span class="n">bad_config</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_osd_win</span><span class="p">(</span><span class="n">layer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_NV12</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span>
			<span class="n">bad_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bad_config</span> <span class="o">=</span> <span class="n">is_osd_win</span><span class="p">(</span><span class="n">layer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIXFMT_OSD_ATTR</span>:
		<span class="n">bad_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">layer</span> <span class="o">!=</span> <span class="n">WIN_OSD1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bad_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bad_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The requested pixel format is incompatible with the layer,</span>
<span class="cm">		 * so keep the current layer configuration.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">lconfig</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">bad_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DM6446: */</span>
	<span class="cm">/* only one OSD window at a time can use RGB pixel formats */</span>
	  <span class="k">if</span> <span class="p">((</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">is_osd_win</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_rgb_pixfmt</span><span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">osd_pix_format</span> <span class="n">pixfmt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_OSD0</span><span class="p">)</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">WIN_OSD1</span><span class="p">].</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">WIN_OSD0</span><span class="p">].</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_rgb_pixfmt</span><span class="p">(</span><span class="n">pixfmt</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The other OSD window is already configured for an</span>
<span class="cm">			 * RGB, so keep the current layer configuration.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">lconfig</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* DM6446: only one video window at a time can use RGB888 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_vid_win</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_RGB888</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">osd_pix_format</span> <span class="n">pixfmt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_VID0</span><span class="p">)</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">WIN_VID1</span><span class="p">].</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">WIN_VID0</span><span class="p">].</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_RGB888</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The other video window is already configured for</span>
<span class="cm">			 * RGB888, so keep the current layer configuration.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">lconfig</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* window dimensions must be non-zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">||</span> <span class="o">!</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">||</span> <span class="o">!</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">lconfig</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* round line_length up to a multiple of 32 */</span>
	<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span>
	    <span class="n">min</span><span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MAX_LINE_LENGTH</span><span class="p">);</span>
	<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MAX_WIN_SIZE</span><span class="p">);</span>
	<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MAX_WIN_SIZE</span><span class="p">);</span>
	<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MAX_WIN_SIZE</span><span class="p">);</span>
	<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MAX_WIN_SIZE</span><span class="p">);</span>
	<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span> <span class="o">=</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ysize and ypos must be even for interlaced displays */</span>
		<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_disable_vid_rgb888</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The DM6446 supports RGB888 pixel format in a single video window.</span>
<span class="cm">	 * This routine disables RGB888 pixel format for both video windows.</span>
<span class="cm">	 * The caller must ensure that neither video window is currently</span>
<span class="cm">	 * configured for RGB888 pixel format.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span>
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_RGBEN</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_enable_vid_rgb888</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The DM6446 supports RGB888 pixel format in a single video window.</span>
<span class="cm">	 * This routine enables RGB888 pixel format for the specified video</span>
<span class="cm">	 * window.  The caller must ensure that the other video window is not</span>
<span class="cm">	 * currently configured for RGB888 pixel format, as this routine will</span>
<span class="cm">	 * disable RGB888 pixel format for the other window.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_VID0</span><span class="p">)</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_RGBEN</span> <span class="o">|</span> <span class="n">OSD_MISCCTL_RGBWIN</span><span class="p">,</span>
				  <span class="n">OSD_MISCCTL_RGBEN</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_VID1</span><span class="p">)</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_RGBEN</span> <span class="o">|</span> <span class="n">OSD_MISCCTL_RGBWIN</span><span class="p">,</span>
				  <span class="n">OSD_MISCCTL_RGBEN</span> <span class="o">|</span> <span class="n">OSD_MISCCTL_RGBWIN</span><span class="p">,</span>
				  <span class="n">OSD_MISCCTL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_cbcr_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">osd_pix_format</span> <span class="n">pixfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The caller must ensure that all windows using YC pixfmt use the same</span>
<span class="cm">	 * Cb/Cr order.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_YCbCrI</span><span class="p">)</span>
		<span class="n">osd_clear</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MODE_CS</span><span class="p">,</span> <span class="n">OSD_MODE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_YCrCbI</span><span class="p">)</span>
		<span class="n">osd_set</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MODE_CS</span><span class="p">,</span> <span class="n">OSD_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_set_layer_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">lconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">winmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">winmd_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bmw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">_osd_set_cbcr_order</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WIN_OSD0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN0MD_RGB0E</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_RGB565</span><span class="p">)</span>
				<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN0MD_RGB0E</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN0MD_BMP0MD</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PIXFMT_RGB565</span>:
					<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
					<span class="n">OSD_OSDWIN0MD_BMP0MD_SHIFT</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PIXFMT_RGB888</span>:
				<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN0MD_BMP0MD_SHIFT</span><span class="p">);</span>
				<span class="n">_osd_enable_rgb888_pixblend</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSDWIN_OSD0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PIXFMT_YCbCrI</span>:
			<span class="k">case</span> <span class="n">PIXFMT_YCrCbI</span>:
				<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN0MD_BMP0MD_SHIFT</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN0MD_BMW0</span> <span class="o">|</span> <span class="n">OSD_OSDWIN0MD_OFF0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PIXFMT_1BPP</span>:
			<span class="n">bmw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PIXFMT_2BPP</span>:
			<span class="n">bmw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PIXFMT_4BPP</span>:
			<span class="n">bmw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PIXFMT_8BPP</span>:
			<span class="n">bmw</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bmw</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN0MD_BMW0_SHIFT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span>
			<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN0MD_OFF0</span><span class="p">;</span>

		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">winmd_mask</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">OSD_OSDWIN0OFST</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="n">OSD_OSDWIN0XP</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="n">OSD_OSDWIN0XL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_OSDWIN0YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_OSDWIN0YL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">,</span> <span class="n">OSD_OSDWIN0YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">,</span> <span class="n">OSD_OSDWIN0YL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID0</span>:
		<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span>
			<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF0</span><span class="p">;</span>

		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">winmd_mask</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">OSD_VIDWIN0OFST</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="n">OSD_VIDWIN0XP</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="n">OSD_VIDWIN0XL</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * For YUV420P format the register contents are</span>
<span class="cm">		 * duplicated in both VID registers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* other window also */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF1</span><span class="p">;</span>
				<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF1</span><span class="p">;</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">winmd_mask</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span>
					  <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span>
				    <span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
				  <span class="n">OSD_VIDWIN1OFST</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="n">OSD_VIDWIN1XP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="n">OSD_VIDWIN1XL</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			  * if NV21 pixfmt and line length not 32B</span>
<span class="cm">			  * aligned (e.g. NTSC), Need to set window</span>
<span class="cm">			  * X pixel size to be 32B aligned as well</span>
<span class="cm">			  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
					  <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">),</span>
					  <span class="n">OSD_VIDWIN1XL</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
					  <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">),</span>
					  <span class="n">OSD_VIDWIN0XL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_NV12</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span> <span class="o">~</span><span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span>
						<span class="n">OSD_MISCCTL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_VIDWIN0YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_VIDWIN0YL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN1YP</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN1YL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">,</span> <span class="n">OSD_VIDWIN0YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">,</span> <span class="n">OSD_VIDWIN0YL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">,</span> <span class="n">OSD_VIDWIN1YP</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">,</span> <span class="n">OSD_VIDWIN1YL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_OSD1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The caller must ensure that OSD1 is disabled prior to</span>
<span class="cm">		 * switching from a normal mode to attribute mode or from</span>
<span class="cm">		 * attribute mode to a normal mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_ATN1E</span> <span class="o">|</span>
				<span class="n">OSD_OSDWIN1MD_RGB1E</span> <span class="o">|</span> <span class="n">OSD_OSDWIN1MD_CLUTS1</span> <span class="o">|</span>
				<span class="n">OSD_OSDWIN1MD_BLND1</span> <span class="o">|</span> <span class="n">OSD_OSDWIN1MD_TE1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_BMP1MD</span> <span class="o">|</span>
				<span class="n">OSD_OSDWIN1MD_CLUTS1</span> <span class="o">|</span> <span class="n">OSD_OSDWIN1MD_BLND1</span> <span class="o">|</span>
				<span class="n">OSD_OSDWIN1MD_TE1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_RGB1E</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_RGB565</span><span class="p">)</span>
					<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_RGB1E</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span>
				   <span class="o">||</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_BMP1MD</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">PIXFMT_RGB565</span>:
					<span class="n">winmd</span> <span class="o">|=</span>
					    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN1MD_BMP1MD_SHIFT</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PIXFMT_RGB888</span>:
					<span class="n">winmd</span> <span class="o">|=</span>
					    <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN1MD_BMP1MD_SHIFT</span><span class="p">);</span>
					<span class="n">_osd_enable_rgb888_pixblend</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
							<span class="n">OSDWIN_OSD1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PIXFMT_YCbCrI</span>:
				<span class="k">case</span> <span class="n">PIXFMT_YCrCbI</span>:
					<span class="n">winmd</span> <span class="o">|=</span>
					    <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN1MD_BMP1MD_SHIFT</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_BMW1</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PIXFMT_1BPP</span>:
				<span class="n">bmw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PIXFMT_2BPP</span>:
				<span class="n">bmw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PIXFMT_4BPP</span>:
				<span class="n">bmw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PIXFMT_8BPP</span>:
				<span class="n">bmw</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">winmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bmw</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OSDWIN1MD_BMW1_SHIFT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_OFF1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span>
			<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_OSDWIN1MD_OFF1</span><span class="p">;</span>

		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">winmd_mask</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">OSD_OSDWIN1OFST</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="n">OSD_OSDWIN1XP</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="n">OSD_OSDWIN1XL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_OSDWIN1YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_OSDWIN1YL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">,</span> <span class="n">OSD_OSDWIN1YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">,</span> <span class="n">OSD_OSDWIN1YL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID1</span>:
		<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span>
			<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF1</span><span class="p">;</span>

		<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">winmd_mask</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span> <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">OSD_VIDWIN1OFST</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="n">OSD_VIDWIN1XP</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="n">OSD_VIDWIN1XL</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * For YUV420P format the register contents are</span>
<span class="cm">		 * duplicated in both VID registers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* other window also */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">winmd_mask</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF0</span><span class="p">;</span>
					<span class="n">winmd</span> <span class="o">|=</span> <span class="n">OSD_VIDWINMD_VFF0</span><span class="p">;</span>
					<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">winmd_mask</span><span class="p">,</span> <span class="n">winmd</span><span class="p">,</span>
						  <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span>
					   <span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN0OFST</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="n">OSD_VIDWIN0XP</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="n">OSD_VIDWIN0XL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">osd_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span>
					   <span class="o">~</span><span class="n">OSD_MISCCTL_S420D</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_VIDWIN1YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OSD_VIDWIN1YL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN0YP</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">OSD_VIDWIN0YL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">,</span> <span class="n">OSD_VIDWIN1YP</span><span class="p">);</span>
			<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">,</span> <span class="n">OSD_VIDWIN1YL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">,</span> <span class="n">OSD_VIDWIN0YP</span><span class="p">);</span>
				<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">,</span> <span class="n">OSD_VIDWIN0YL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osd_set_layer_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">lconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reject_config</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">reject_config</span> <span class="o">=</span> <span class="n">try_layer_config</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">lconfig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reject_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">reject_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update the current Cb/Cr order */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_yc_pixfmt</span><span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">))</span>
		<span class="n">osd</span><span class="o">-&gt;</span><span class="n">yc_pixfmt</span> <span class="o">=</span> <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are switching OSD1 from normal mode to attribute mode or from</span>
<span class="cm">	 * attribute mode to normal mode, then we must disable the window.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_OSD1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">))</span> <span class="o">||</span>
		  <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">is_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">_osd_disable_layer</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">_osd_set_layer_config</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">lconfig</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_OSD1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_osdwin_state</span> <span class="o">*</span><span class="n">osdwin_state</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">[</span><span class="n">OSDWIN_OSD1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We just switched OSD1 from attribute mode to normal</span>
<span class="cm">			 * mode, so we must initialize the CLUT select, the</span>
<span class="cm">			 * blend factor, transparency colorkey enable, and</span>
<span class="cm">			 * attenuation enable (DM6446 only) bits in the</span>
<span class="cm">			 * OSDWIN1MD register.</span>
<span class="cm">			 */</span>
			<span class="n">_osd_set_osd_clut</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSDWIN_OSD1</span><span class="p">,</span>
						   <span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">clut</span><span class="p">);</span>
			<span class="n">_osd_set_blending_factor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSDWIN_OSD1</span><span class="p">,</span>
							  <span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">blend</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">colorkey_blending</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">_osd_enable_color_key</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSDWIN_OSD1</span><span class="p">,</span>
							       <span class="n">osdwin_state</span><span class="o">-&gt;</span>
							       <span class="n">colorkey</span><span class="p">,</span>
							       <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">_osd_disable_color_key</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSDWIN_OSD1</span><span class="p">);</span>
			<span class="n">_osd_set_rec601_attenuation</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSDWIN_OSD1</span><span class="p">,</span>
						    <span class="n">osdwin_state</span><span class="o">-&gt;</span>
						    <span class="n">rec601_attenuation</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">PIXFMT_OSD_ATTR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We just switched OSD1 from normal mode to attribute</span>
<span class="cm">			 * mode, so we must initialize the blink enable and</span>
<span class="cm">			 * blink interval bits in the OSDATRMD register.</span>
<span class="cm">			 */</span>
			<span class="n">_osd_set_blink_attribute</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">is_blinking</span><span class="p">,</span>
							  <span class="n">osd</span><span class="o">-&gt;</span><span class="n">blink</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we just switched to a 1-, 2-, or 4-bits-per-pixel bitmap format</span>
<span class="cm">	 * then configure a default palette map.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">!=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">((</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_1BPP</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_2BPP</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_4BPP</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_OSD0</span><span class="p">)</span> <span class="o">?</span> <span class="n">OSDWIN_OSD0</span> <span class="o">:</span> <span class="n">OSDWIN_OSD1</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">osd_osdwin_state</span> <span class="o">*</span><span class="n">osdwin_state</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">[</span><span class="n">osdwin</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clut_index</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clut_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PIXFMT_1BPP</span>:
			<span class="n">clut_entries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PIXFMT_2BPP</span>:
			<span class="n">clut_entries</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PIXFMT_4BPP</span>:
			<span class="n">clut_entries</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * The default palette map maps the pixel value to the clut</span>
<span class="cm">		 * index, i.e. pixel value 0 maps to clut entry 0, pixel value</span>
<span class="cm">		 * 1 maps to clut entry 1, etc.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clut_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">clut_index</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">clut_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">palette_map</span><span class="p">[</span><span class="n">clut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">clut_index</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clut_index</span> <span class="o">&lt;</span> <span class="n">clut_entries</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">_osd_set_palette_map</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osdwin</span><span class="p">,</span> <span class="n">clut_index</span><span class="p">,</span>
						     <span class="n">clut_index</span><span class="p">,</span>
						     <span class="n">lconfig</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">lconfig</span><span class="p">;</span>
	<span class="cm">/* DM6446: configure the RGB888 enable and window selection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">WIN_VID0</span><span class="p">].</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_RGB888</span><span class="p">)</span>
		<span class="n">_osd_enable_vid_rgb888</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">WIN_VID0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">WIN_VID1</span><span class="p">].</span><span class="n">lconfig</span><span class="p">.</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_RGB888</span><span class="p">)</span>
		<span class="n">_osd_enable_vid_rgb888</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">WIN_VID1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_osd_disable_vid_rgb888</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_VID0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osd</span><span class="o">-&gt;</span><span class="n">pingpong</span> <span class="o">=</span>
		    <span class="n">_osd_dm6446_vid0_pingpong</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">field_inversion</span><span class="p">,</span>
						       <span class="n">win</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">,</span>
						       <span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_init_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">osd_win_layer</span> <span class="n">osdwin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_osdwin_state</span> <span class="o">*</span><span class="n">osdwin_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">lconfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">is_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_osd_disable_layer</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">h_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X1</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">v_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X1</span><span class="p">;</span>
	<span class="n">_osd_set_zoom</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">h_zoom</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">v_zoom</span><span class="p">);</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_osd_start_layer</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">interlaced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WIN_OSD0</span>:
	<span class="k">case</span> <span class="n">WIN_OSD1</span>:
		<span class="n">osdwin</span> <span class="o">=</span> <span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">WIN_OSD0</span><span class="p">)</span> <span class="o">?</span> <span class="n">OSDWIN_OSD0</span> <span class="o">:</span> <span class="n">OSDWIN_OSD1</span><span class="p">;</span>
		<span class="n">osdwin_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">[</span><span class="n">osdwin</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * Other code relies on the fact that OSD windows default to a</span>
<span class="cm">		 * bitmap pixel format when they are deallocated, so don&#39;t</span>
<span class="cm">		 * change this default pixel format.</span>
<span class="cm">		 */</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">PIXFMT_8BPP</span><span class="p">;</span>
		<span class="n">_osd_set_layer_config</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
		<span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">clut</span> <span class="o">=</span> <span class="n">RAM_CLUT</span><span class="p">;</span>
		<span class="n">_osd_set_osd_clut</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osdwin</span><span class="p">,</span> <span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">clut</span><span class="p">);</span>
		<span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">colorkey_blending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">_osd_disable_color_key</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osdwin</span><span class="p">);</span>
		<span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">blend</span> <span class="o">=</span> <span class="n">OSD_8_VID_0</span><span class="p">;</span>
		<span class="n">_osd_set_blending_factor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osdwin</span><span class="p">,</span> <span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">blend</span><span class="p">);</span>
		<span class="n">osdwin_state</span><span class="o">-&gt;</span><span class="n">rec601_attenuation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">_osd_set_rec601_attenuation</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">osdwin</span><span class="p">,</span>
						     <span class="n">osdwin_state</span><span class="o">-&gt;</span>
						     <span class="n">rec601_attenuation</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osdwin</span> <span class="o">==</span> <span class="n">OSDWIN_OSD1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osd</span><span class="o">-&gt;</span><span class="n">is_blinking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">osd</span><span class="o">-&gt;</span><span class="n">blink</span> <span class="o">=</span> <span class="n">BLINK_X1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIN_VID0</span>:
	<span class="k">case</span> <span class="n">WIN_VID1</span>:
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">yc_pixfmt</span><span class="p">;</span>
		<span class="n">_osd_set_layer_config</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_release_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">is_allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">osd_init_layer</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">is_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osd_request_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_layer</span> <span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_window_state</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">layer</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">is_allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">is_allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_MODE</span><span class="p">);</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_VIDWINMD</span><span class="p">);</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_OSDWIN0MD</span><span class="p">);</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_OSDWIN1MD</span><span class="p">);</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_RECTCUR</span><span class="p">);</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_VBNDRY</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_EXTMODE</span><span class="p">);</span>
		<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">OSD_MISCCTL_DMANG</span><span class="p">,</span> <span class="n">OSD_MISCCTL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_set_left_margin</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OSD_BASEPX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_set_top_margin</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">osd_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OSD_BASEPY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osd_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">_osd_init</span><span class="p">(</span><span class="n">osd</span><span class="p">);</span>

	<span class="cm">/* set default Cb/Cr order */</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">yc_pixfmt</span> <span class="o">=</span> <span class="n">PIXFMT_YCbCrI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * ROM CLUT1 on the DM355 is similar (identical?) to ROM CLUT0</span>
<span class="cm">		 * on the DM6446, so make ROM_CLUT1 the default on the DM355.</span>
<span class="cm">		 */</span>
		<span class="n">osd</span><span class="o">-&gt;</span><span class="n">rom_clut</span> <span class="o">=</span> <span class="n">ROM_CLUT1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_osd_set_field_inversion</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">field_inversion</span><span class="p">);</span>
	<span class="n">_osd_set_rom_clut</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">rom_clut</span><span class="p">);</span>

	<span class="n">osd_init_layer</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">WIN_OSD0</span><span class="p">);</span>
	<span class="n">osd_init_layer</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">WIN_VID0</span><span class="p">);</span>
	<span class="n">osd_init_layer</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">WIN_OSD1</span><span class="p">);</span>
	<span class="n">osd_init_layer</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">WIN_VID1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vpbe_osd_ops</span> <span class="n">osd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">osd_initialize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_layer</span> <span class="o">=</span> <span class="n">osd_request_layer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_layer</span> <span class="o">=</span> <span class="n">osd_release_layer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_layer</span> <span class="o">=</span> <span class="n">osd_enable_layer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_layer</span> <span class="o">=</span> <span class="n">osd_disable_layer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_layer_config</span> <span class="o">=</span> <span class="n">osd_set_layer_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_layer_config</span> <span class="o">=</span> <span class="n">osd_get_layer_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_layer</span> <span class="o">=</span> <span class="n">osd_start_layer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_left_margin</span> <span class="o">=</span> <span class="n">osd_set_left_margin</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_top_margin</span> <span class="o">=</span> <span class="n">osd_set_top_margin</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">osd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osd_platform_data</span> <span class="o">*</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">vpbe_type</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">vpbe_version</span><span class="p">)</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vpbe_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data defined for OSD&quot;</span>
			<span class="s">&quot; sub device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get OSD register address map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base_phys</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base_phys</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_size</span><span class="p">,</span>
				<span class="n">MODULE_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to reserve OSD MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
							<span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to map the OSD region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_mem_region</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">osd_ops</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="n">dev_notice</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OSD sub device probe success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">release_mem_region:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base_phys</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_size</span><span class="p">);</span>
<span class="nl">free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">osd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_base_phys</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">osd_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">osd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">osd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">osd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">osd_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">osd_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DaVinci OSD Manager Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
