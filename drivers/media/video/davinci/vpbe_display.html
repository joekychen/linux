<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › davinci › vpbe_display.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>vpbe_display.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed WITHOUT ANY WARRANTY of any</span>
<span class="cm"> * kind, whether express or implied; without even the implied warranty</span>
<span class="cm"> * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;mach/cputype.h&gt;</span>

<span class="cp">#include &lt;media/v4l2-dev.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe_display.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe_types.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe_venc.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe_osd.h&gt;</span>
<span class="cp">#include &quot;vpbe_venc_regs.h&quot;</span>

<span class="cp">#define VPBE_DISPLAY_DRIVER &quot;vpbe-v4l2&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>

<span class="cp">#define VPBE_DEFAULT_NUM_BUFS 3</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_is_second_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">venc</span><span class="p">,</span>
			       <span class="n">core</span><span class="p">,</span>
			       <span class="n">ioctl</span><span class="p">,</span>
			       <span class="n">VENC_GET_FLD</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			 <span class="s">&quot;Error in getting Field ID 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpbe_isr_even_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">timevalue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">==</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ktime_get_ts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timevalue</span><span class="p">);</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">timevalue</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">timevalue</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="n">NSEC_PER_USEC</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="cm">/* Make cur_frm pointing to next_frm */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpbe_isr_odd_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">dma_queue_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">dma_queue_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * one field is displayed configure</span>
<span class="cm">	 * the next frame if it is available</span>
<span class="cm">	 * otherwise hold on current frame</span>
<span class="cm">	 * Get next from the buffer queue</span>
<span class="cm">	 */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span>  <span class="n">videobuf_buffer</span><span class="p">,</span>
				<span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Remove that from the buffer queue */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">dma_queue_lock</span><span class="p">);</span>
	<span class="cm">/* Mark state of the frame to active */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">);</span>
	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">start_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">addr</span><span class="p">,</span>
			<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">cbcr_ofst</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* interrupt service routine */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">venc_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">last_event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">venc_is_second_field</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">))</span>
		<span class="n">event</span> <span class="o">|=</span> <span class="n">VENC_SECOND_FIELD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">event</span> <span class="o">|=</span> <span class="n">VENC_FIRST_FIELD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="p">(</span><span class="n">last_event</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VENC_END_OF_FRAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* If the display is non-interlaced, then we need to flag the</span>
<span class="cm">		* end-of-frame event at every interrupt regardless of the</span>
<span class="cm">		* value of the FIDST bit.  We can conclude that the display is</span>
<span class="cm">		* non-interlaced if the value of the FIDST bit is unchanged</span>
<span class="cm">		* from the previous interrupt.</span>
<span class="cm">		*/</span>
		<span class="n">event</span> <span class="o">|=</span> <span class="n">VENC_END_OF_FRAME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VENC_SECOND_FIELD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* end-of-frame for interlaced display */</span>
		<span class="n">event</span> <span class="o">|=</span> <span class="n">VENC_END_OF_FRAME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">last_event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPBE_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">layer</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* If streaming is started in this layer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_first_int</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_first_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check the field format */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">V4L2_FIELD_NONE</span> <span class="o">==</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">VENC_END_OF_FRAME</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Progressive mode */</span>

			<span class="n">vpbe_isr_even_field</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
			<span class="n">vpbe_isr_odd_field</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Interlaced mode */</span>

			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">VENC_FIRST_FIELD</span><span class="p">)</span>
				<span class="n">fid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			* If field id does not match with store</span>
<span class="cm">			* field id</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">field_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Make them in sync */</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			* device field id and local field id are</span>
<span class="cm">			* in sync. If this is even field</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">fid</span><span class="p">)</span>
				<span class="n">vpbe_isr_even_field</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
			<span class="k">else</span>  <span class="cm">/* odd field */</span>
				<span class="n">vpbe_isr_odd_field</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_buffer_prepare()</span>
<span class="cm"> * This is the callback function called from videobuf_qbuf() function</span>
<span class="cm"> * the buffer is prepared and user space virtual address is converted into</span>
<span class="cm"> * physical address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;vpbe_buffer_prepare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If buffer is not initialized, initialize it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">.</span><span class="n">sizeimage</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to map \</span>
<span class="s">				user address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
					<span class="s">&quot;buffer_prepare:offset is \</span>
<span class="s">					not aligned to 32 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_buffer_setup()</span>
<span class="cm"> * This function allocates memory for the buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_buffer_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Get the file handle object and layer object */</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;vpbe_buffer_setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">.</span><span class="n">sizeimage</span><span class="p">;</span>

	<span class="cm">/* Store number of buffers allocated in numbuffer member */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">VPBE_DEFAULT_NUM_BUFS</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">numbuffers</span> <span class="o">=</span> <span class="n">VPBE_DEFAULT_NUM_BUFS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_buffer_queue()</span>
<span class="cm"> * This function adds the buffer to DMA queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpbe_buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Get the file handle object and layer object */</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;vpbe_buffer_queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* add the buffer to the DMA queue */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp</span><span class="o">-&gt;</span><span class="n">dma_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp</span><span class="o">-&gt;</span><span class="n">dma_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Change state of the buffer */</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_buffer_release()</span>
<span class="cm"> * This function is called from the videobuf layer to free memory allocated to</span>
<span class="cm"> * the buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpbe_buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Get the file handle object and layer object */</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;vpbe_buffer_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
		<span class="n">videobuf_dma_contig_free</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">video_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span> <span class="o">=</span> <span class="n">vpbe_buffer_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span> <span class="o">=</span> <span class="n">vpbe_buffer_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span> <span class="o">=</span> <span class="n">vpbe_buffer_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span> <span class="o">=</span> <span class="n">vpbe_buffer_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">vpbe_layer</span><span class="o">*</span>
<span class="nf">_vpbe_display_get_other_win_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vpbe_display_device_id</span> <span class="n">thiswin</span><span class="p">,</span> <span class="n">otherwin</span><span class="p">;</span>
	<span class="n">thiswin</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">;</span>

	<span class="n">otherwin</span> <span class="o">=</span> <span class="p">(</span><span class="n">thiswin</span> <span class="o">==</span> <span class="n">VPBE_DISPLAY_DEVICE_0</span><span class="p">)</span> <span class="o">?</span>
	<span class="n">VPBE_DISPLAY_DEVICE_1</span> <span class="o">:</span> <span class="n">VPBE_DISPLAY_DEVICE_0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">otherwin</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_set_osd_display_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="p">);</span>
	<span class="cm">/* Set address in the display registers */</span>
	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">start_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				    <span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
				    <span class="n">addr</span><span class="p">,</span>
				    <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">cbcr_ofst</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;Error in enabling osd window layer 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the window */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">otherlayer</span> <span class="o">=</span>
			<span class="n">_vpbe_display_get_other_win_layer</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">otherlayer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;Error in enabling osd window layer 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">otherlayer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vpbe_disp_calculate_scale_factor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">expected_xsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expected_ysize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">display_layer_info</span> <span class="o">*</span><span class="n">layer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">calculated_xsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h_exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v_exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h_scale</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v_scale</span><span class="p">;</span>

	<span class="n">v4l2_std_id</span> <span class="n">standard_id</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">std_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Application initially set the image format. Current display</span>
<span class="cm">	 * size is obtained from the vpbe display controller. expected_xsize</span>
<span class="cm">	 * and expected_ysize are set through S_CROP ioctl. Based on this,</span>
<span class="cm">	 * driver will calculate the scale factors for vertical and</span>
<span class="cm">	 * horizontal direction so that the image is displayed scaled</span>
<span class="cm">	 * and expanded. Application uses expansion to display the image</span>
<span class="cm">	 * in a square pixel. Otherwise it is displayed using displays</span>
<span class="cm">	 * pixel aspect ratio.It is expected that application chooses</span>
<span class="cm">	 * the crop coordinates for cropped or scaled display. if crop</span>
<span class="cm">	 * size is less than the image size, it is displayed cropped or</span>
<span class="cm">	 * it is displayed scaled and/or expanded.</span>
<span class="cm">	 *</span>
<span class="cm">	 * to begin with, set the crop window same as expected. Later we</span>
<span class="cm">	 * will override with scaled window size</span>
<span class="cm">	 */</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">h_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X1</span><span class="p">;</span>	<span class="cm">/* no horizontal zoom */</span>
	<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">v_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X1</span><span class="p">;</span>	<span class="cm">/* no horizontal zoom */</span>
	<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">h_exp</span> <span class="o">=</span> <span class="n">H_EXP_OFF</span><span class="p">;</span>	<span class="cm">/* no horizontal zoom */</span>
	<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">v_exp</span> <span class="o">=</span> <span class="n">V_EXP_OFF</span><span class="p">;</span>	<span class="cm">/* no horizontal zoom */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">expected_xsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h_scale</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">xres</span> <span class="o">/</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h_scale</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">h_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h_scale</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">h_scale</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">h_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">*=</span> <span class="n">h_scale</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">&lt;</span> <span class="n">expected_xsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">standard_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">standard_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calculated_xsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">*</span>
					<span class="n">VPBE_DISPLAY_H_EXP_RATIO_N</span><span class="p">)</span> <span class="o">/</span>
					<span class="n">VPBE_DISPLAY_H_EXP_RATIO_D</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">calculated_xsize</span> <span class="o">&lt;=</span> <span class="n">expected_xsize</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">h_exp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">=</span> <span class="n">calculated_xsize</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h_scale</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">h_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h_scale</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">h_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h_exp</span><span class="p">)</span>
			<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">h_exp</span> <span class="o">=</span> <span class="n">H_EXP_9_OVER_8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no scaling, only cropping. Set display area to crop area */</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">=</span> <span class="n">expected_xsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">expected_ysize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v_scale</span> <span class="o">=</span> <span class="n">expected_ysize</span> <span class="o">/</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v_scale</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">v_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v_scale</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">v_scale</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">v_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">*=</span> <span class="n">v_scale</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">&lt;</span> <span class="n">expected_ysize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">standard_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calculated_xsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">*</span>
					<span class="n">VPBE_DISPLAY_V_EXP_RATIO_N</span><span class="p">)</span> <span class="o">/</span>
					<span class="n">VPBE_DISPLAY_V_EXP_RATIO_D</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">calculated_xsize</span> <span class="o">&lt;=</span> <span class="n">expected_ysize</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">v_exp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">calculated_xsize</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v_scale</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">v_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v_scale</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">v_zoom</span> <span class="o">=</span> <span class="n">ZOOM_X4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v_exp</span><span class="p">)</span>
			<span class="n">layer_info</span><span class="o">-&gt;</span><span class="n">h_exp</span> <span class="o">=</span> <span class="n">V_EXP_6_OVER_5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no scaling, only cropping. Set display area to crop area */</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">expected_ysize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;crop display xsize = %d, ysize = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpbe_disp_adj_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">left</span><span class="p">,</span>
			<span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">);</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">top</span><span class="p">,</span>
			<span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;new xpos = %d, ypos = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpbe_disp_check_window_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">xres</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="o">&gt;</span>
	  <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">yres</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>

	<span class="cm">/* window height must be even for interlaced display */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">interlaced</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_try_format()</span>
<span class="cm"> * If user application provides width and height, and have bytesperline set</span>
<span class="cm"> * to zero, driver calculates bytesperline and sizeimage based on hardware</span>
<span class="cm"> * limits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_NV12</span><span class="p">))</span>
		<span class="cm">/* choose default as V4L2_PIX_FMT_UYVY */</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">;</span>

	<span class="cm">/* Check the field format */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">interlaced</span><span class="p">)</span>
			<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">)</span>
		<span class="n">min_height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12</span><span class="p">)</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">max_width</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">max_height</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>

	<span class="n">min_width</span> <span class="o">/=</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">min_width</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">max_width</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span>  <span class="o">&lt;</span> <span class="n">min_height</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span>  <span class="o">&gt;</span> <span class="n">max_height</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">))</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="cm">/* Make the bytesperline 32 byte aligned */</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="p">((</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12</span><span class="p">)</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_g_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v4l2_prio_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_s_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_prio_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">VPBE_DISPLAY_VERSION_CODE</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span> <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">VPBE_DISPLAY_DRIVER</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;platform&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">module_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;VIDIOC_S_CROP, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buf type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vpbe_disp_check_window_params</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>

	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_layer_config</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="n">vpbe_disp_calculate_scale_factor</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span>
					<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
					<span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">vpbe_disp_adj_position</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
					<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_layer_config</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;Error in set layer config:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* apply zooming and h or v expansion */</span>
	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">h_zoom</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">v_zoom</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_vid_expansion</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">h_exp</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">v_exp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;Error in set vid expansion:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">h_zoom</span> <span class="o">!=</span> <span class="n">ZOOM_X1</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">v_zoom</span> <span class="o">!=</span> <span class="n">ZOOM_X1</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">h_exp</span> <span class="o">!=</span> <span class="n">H_EXP_OFF</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">v_exp</span> <span class="o">!=</span> <span class="n">V_EXP_OFF</span><span class="p">))</span>
		<span class="cm">/* Enable expansion filter */</span>
		<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_interpolation_filter</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_interpolation_filter</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;VIDIOC_G_CROP, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buf type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_layer_config</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ypos</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xpos</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cropcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_CROPCAP ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">aspect</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span> <span class="o">=</span> <span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_g_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;VIDIOC_G_FMT, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="cm">/* If buffer type is video output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;invalid type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill in the information about format */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;VIDIOC_ENUM_FMT, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid format index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the information about format */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">));</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;YUV 4:2:2 - UYVY&quot;</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;Y/CbCr 4:2:0&quot;</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV12</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;VIDIOC_S_FMT, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="cm">/* If streaming is started, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Streaming is started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;invalid type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check for valid pixel format */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpbe_try_format</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* YUV420 is requested, check availability of the</span>
<span class="cm">	other video window */</span>

	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="o">*</span><span class="n">pixfmt</span><span class="p">;</span>

	<span class="cm">/* Get osd layer config */</span>
	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_layer_config</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="cm">/* Store the pixel format in the layer object */</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xsize</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ypos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">xpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">interlaced</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">interlaced</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_PIX_FMT_UYVY</span> <span class="o">==</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">PIXFMT_YCbCrI</span><span class="p">;</span>

	<span class="cm">/* Change of the default pixel format for both video windows */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_PIX_FMT_NV12</span> <span class="o">==</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">otherlayer</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">PIXFMT_NV12</span><span class="p">;</span>
		<span class="n">otherlayer</span> <span class="o">=</span> <span class="n">_vpbe_display_get_other_win_layer</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span>
								<span class="n">layer</span><span class="p">);</span>
		<span class="n">otherlayer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">PIXFMT_NV12</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the layer config in the osd window */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_layer_config</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;Error in S_FMT params:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Readback and fill the local copy of current pix format */</span>
	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_layer_config</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_TRY_FMT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;invalid type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for valid field format */</span>
	<span class="k">return</span>  <span class="n">vpbe_try_format</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_s_std - Set the given standard in the encoder</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the standard if supported by the current encoder. Return the status.</span>
<span class="cm"> * 0 - success &amp; -EINVAL on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_S_STD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If streaming is started, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Streaming is started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">s_std</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">s_std</span><span class="p">(</span><span class="n">vpbe_dev</span><span class="p">,</span> <span class="n">std_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to set standard for sub devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_g_std - Get the standard in the current encoder</span>
<span class="cm"> *</span>
<span class="cm"> * Get the standard in the current encoder. Return the status. 0 - success</span>
<span class="cm"> * -EINVAL on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>	<span class="s">&quot;VIDIOC_G_STD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Get the standard from the current encoder */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">timings_type</span> <span class="o">&amp;</span> <span class="n">VPBE_ENC_STD</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">std_id</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">std_id</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_enum_output - enumerate outputs</span>
<span class="cm"> *</span>
<span class="cm"> * Enumerates the outputs available at the vpbe display</span>
<span class="cm"> * returns the status, -EINVAL if end of output list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_enum_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_output</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>	<span class="s">&quot;VIDIOC_ENUM_OUTPUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Enumerate outputs */</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enum_outputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enum_outputs</span><span class="p">(</span><span class="n">vpbe_dev</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to enumerate outputs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_s_output - Set output to</span>
<span class="cm"> * the output specified by the index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_s_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>	<span class="s">&quot;VIDIOC_S_OUTPUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* If streaming is started, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Streaming is started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_output</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">vpbe_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to set output for sub devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_g_output - Get output from subdevice</span>
<span class="cm"> * for a given by the index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_g_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_G_OUTPUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Get the standard from the current encoder */</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_out_index</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_enum_dv_presets - Enumerate the dv presets</span>
<span class="cm"> *</span>
<span class="cm"> * enum the preset in the current encoder. Return the status. 0 - success</span>
<span class="cm"> * -EINVAL on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vpbe_display_enum_dv_presets</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_dv_enum_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_ENUM_DV_PRESETS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Enumerate outputs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enum_dv_presets</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enum_dv_presets</span><span class="p">(</span><span class="n">vpbe_dev</span><span class="p">,</span> <span class="n">preset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to enumerate dv presets info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_s_dv_preset - Set the dv presets</span>
<span class="cm"> *</span>
<span class="cm"> * Set the preset in the current encoder. Return the status. 0 - success</span>
<span class="cm"> * -EINVAL on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vpbe_display_s_dv_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_S_DV_PRESETS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="cm">/* If streaming is started, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Streaming is started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the given standard in the encoder */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">s_dv_preset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">s_dv_preset</span><span class="p">(</span><span class="n">vpbe_dev</span><span class="p">,</span> <span class="n">preset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to set the dv presets info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set the current norm to zero to be consistent. If STD is used</span>
<span class="cm">	 * v4l2 layer will set the norm properly on successful s_std call</span>
<span class="cm">	 */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">.</span><span class="n">current_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpbe_display_g_dv_preset - Set the dv presets</span>
<span class="cm"> *</span>
<span class="cm"> * Get the preset in the current encoder. Return the status. 0 - success</span>
<span class="cm"> * -EINVAL on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vpbe_display_g_dv_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="o">*</span><span class="n">dv_preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_G_DV_PRESETS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Get the given standard in the encoder */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">timings_type</span> <span class="o">&amp;</span>
				<span class="n">VPBE_ENC_DV_PRESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dv_preset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">=</span>
			<span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">dv_preset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buf_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;VIDIOC_STREAMOFF,layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">buf_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buffer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If io is allowed for this file handle, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;No io_allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If streaming is not started, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;streaming not started in layer&quot;</span>
			<span class="s">&quot; id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buf_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;VIDIOC_STREAMON, layerid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">buf_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buffer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If file handle is not allowed IO, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;No io_allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If Streaming is already started, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;layer is already streaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call videobuf_streamon to start streaming</span>
<span class="cm">	 * in videobuf</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;error in videobuf_streamon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If buffer queue is empty, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;buffer queue is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">streamoff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get the next frame from the buffer queue */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Remove buffer from the buffer queue */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Mark state of the current frame to active */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
	<span class="cm">/* Initialize field_id and started member */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set parameters in OSD and VENC */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpbe_set_osd_display_params</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">streamoff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if request format is yuv420 semiplanar, need to</span>
<span class="cm">	 * enable both video windows</span>
<span class="cm">	 */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_first_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">streamoff:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;VIDIOC_DQBUF, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buffer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If this file handle is not allowed to do IO, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;No io_allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
		<span class="cm">/* Call videobuf_dqbuf for non blocking mode */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Call videobuf_dqbuf for blocking mode */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;VIDIOC_QBUF, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buffer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If this file handle is not allowed to do IO, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;No io_allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;VIDIOC_QUERYBUF, layer id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buffer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Call videobuf_querybuf to get information */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">req_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;vpbe_display_reqbufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">req_buf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid buffer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If io users of the layer is not zero, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">io_usrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;not IO user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize videobuf queue as per the buffer type */</span>
	<span class="n">videobuf_queue_dma_contig_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">video_qops</span><span class="p">,</span>
				<span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span>
				<span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">.</span><span class="n">field</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">),</span>
				<span class="n">fh</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Set io allowed member of file handle to TRUE */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Increment io usrs member of layer object to 1 */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">io_usrs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Store type of memory requested in layer object */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">req_buf</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">;</span>
	<span class="cm">/* Initialize buffer queue */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">);</span>
	<span class="cm">/* Allocate buffers */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">req_buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_display_mmap()</span>
<span class="cm"> * It is used to map kernel space buffers into user spaces</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Get the layer object and file handle object */</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">filep</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;vpbe_display_mmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_mmap_mapper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* vpbe_display_poll(): It is used for select/poll system call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">vpbe_display_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">filep</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;vpbe_display_poll</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">filep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_display_open()</span>
<span class="cm"> * It creates object of file handle structure and stores it in private_data</span>
<span class="cm"> * member of filepointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Allocate memory for the file handle object */</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_fh</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;unable to allocate memory for file handle object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;vpbe display open plane = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">layer</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="cm">/* store pointer to fh in private_data member of filep */</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">usrs</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* First claim the layer for this device */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">request_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
						<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Couldn&#39;t get layer */</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;Display Manager failed to allocate layer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Increment layer usrs counter */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">usrs</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Set io_allowed member to false */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Initialize priority of this instance to default priority */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="n">V4L2_PRIORITY_UNSET</span><span class="p">;</span>
	<span class="n">v4l2_prio_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;vpbe display device opened successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_display_release()</span>
<span class="cm"> * This function deletes buffer queue, frees the buffers and the davinci</span>
<span class="cm"> * display file * handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Get the layer object and file handle object */</span>
	<span class="k">struct</span> <span class="n">vpbe_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_layer_config</span> <span class="o">*</span><span class="n">cfg</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_state</span> <span class="o">*</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">osd_device</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;vpbe_display_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* if this instance is doing IO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset io_usrs member of layer object */</span>
		<span class="n">layer</span><span class="o">-&gt;</span><span class="n">io_usrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">layer</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Free buffers allocated */</span>
		<span class="n">videobuf_queue_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
		<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Decrement layer usrs counter */</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">usrs</span><span class="o">--</span><span class="p">;</span>
	<span class="cm">/* If this file handle has initialize encoder device, reset it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">usrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">PIXFMT_NV12</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">otherlayer</span><span class="p">;</span>
			<span class="n">otherlayer</span> <span class="o">=</span>
			<span class="n">_vpbe_display_get_other_win_layer</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
			<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
					<span class="n">otherlayer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
					<span class="n">otherlayer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">disable_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">osd_device</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release_layer</span><span class="p">(</span><span class="n">osd_device</span><span class="p">,</span>
				<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Close the priority */</span>
	<span class="n">v4l2_prio_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free memory allocated to file handle object */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">cbcr_ofst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_dbg_match</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">venc</span><span class="p">,</span>
				 <span class="n">core</span><span class="p">,</span>
				 <span class="n">g_register</span><span class="p">,</span>
				 <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* vpbe capture ioctl operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">vpbe_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>	 <span class="o">=</span> <span class="n">vpbe_display_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out</span>    <span class="o">=</span> <span class="n">vpbe_display_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out</span> <span class="o">=</span> <span class="n">vpbe_display_enum_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out</span>    <span class="o">=</span> <span class="n">vpbe_display_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out</span>  <span class="o">=</span> <span class="n">vpbe_display_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>		 <span class="o">=</span> <span class="n">vpbe_display_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>	 <span class="o">=</span> <span class="n">vpbe_display_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>		 <span class="o">=</span> <span class="n">vpbe_display_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>		 <span class="o">=</span> <span class="n">vpbe_display_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>	 <span class="o">=</span> <span class="n">vpbe_display_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>	 <span class="o">=</span> <span class="n">vpbe_display_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>		 <span class="o">=</span> <span class="n">vpbe_display_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>		 <span class="o">=</span> <span class="n">vpbe_display_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>		 <span class="o">=</span> <span class="n">vpbe_display_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_priority</span>	 <span class="o">=</span> <span class="n">vpbe_display_g_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_priority</span>	 <span class="o">=</span> <span class="n">vpbe_display_s_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>		 <span class="o">=</span> <span class="n">vpbe_display_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span>		 <span class="o">=</span> <span class="n">vpbe_display_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_output</span>	 <span class="o">=</span> <span class="n">vpbe_display_enum_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_output</span>	 <span class="o">=</span> <span class="n">vpbe_display_s_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_output</span>	 <span class="o">=</span> <span class="n">vpbe_display_g_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_dv_preset</span>	 <span class="o">=</span> <span class="n">vpbe_display_s_dv_preset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_dv_preset</span>	 <span class="o">=</span> <span class="n">vpbe_display_g_dv_preset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_dv_presets</span>	 <span class="o">=</span> <span class="n">vpbe_display_enum_dv_presets</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span>	 <span class="o">=</span> <span class="n">vpbe_display_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span>	 <span class="o">=</span> <span class="n">vpbe_display_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">vpbe_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">vpbe_display_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">vpbe_display_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">vpbe_display_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">vpbe_display_poll</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_device_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">vpbe_disp</span>  <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;vpbe_controller&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vpbe_disp</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;vpbe-osd&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vpbe_disp</span><span class="o">-&gt;</span><span class="n">osd_device</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">init_vpbe_layer</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">vpbe_display_layer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vbd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Allocate memory for four plane display objects */</span>

	<span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_layer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="cm">/* If memory allocation fails, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ran out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">opslock</span><span class="p">);</span>

	<span class="cm">/* Get the pointer to the layer object */</span>
	<span class="n">vpbe_display_layer</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">vbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">;</span>
	<span class="cm">/* Initialize field of video device */</span>
	<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">release</span>	<span class="o">=</span> <span class="n">video_device_release_empty</span><span class="p">;</span>
	<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">fops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vpbe_fops</span><span class="p">;</span>
	<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vpbe_ioctl_ops</span><span class="p">;</span>
	<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">minor</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="cm">/* Locking in file operations other than ioctl should be done</span>
<span class="cm">	   by the driver, not the V4L2 core.</span>
<span class="cm">	   This driver needs auditing so that this flag can be removed. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_LOCK_ALL_FOPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vbd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">lock</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">opslock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">current_timings</span><span class="p">.</span><span class="n">timings_type</span> <span class="o">&amp;</span>
			<span class="n">VPBE_ENC_STD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">tvnorms</span> <span class="o">=</span> <span class="p">(</span><span class="n">V4L2_STD_525_60</span> <span class="o">|</span> <span class="n">V4L2_STD_625_50</span><span class="p">);</span>
		<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">current_norm</span> <span class="o">=</span>
			<span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span>
			<span class="n">current_timings</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">std_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vbd</span><span class="o">-&gt;</span><span class="n">current_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">vbd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vbd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			<span class="s">&quot;DaVinci_VPBE Display_DRIVER_V%d.%d.%d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">VPBE_DISPLAY_VERSION_CODE</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">VPBE_DISPLAY_VERSION_CODE</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">VPBE_DISPLAY_VERSION_CODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">layer_info</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">VPBE_DISPLAY_DEVICE_0</span><span class="p">)</span> <span class="o">?</span> <span class="n">WIN_VID0</span> <span class="o">:</span> <span class="n">WIN_VID1</span><span class="p">);</span>

	<span class="cm">/* Initialize prio member of layer object */</span>
	<span class="n">v4l2_prio_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">vpbe_display_layer</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		  <span class="s">&quot;Trying to register VPBE display device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		  <span class="s">&quot;layer=%x,layer-&gt;video_dev=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vpbe_display_layer</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span>
				    <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span>
				    <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="p">;</span>
	<span class="cm">/* set the driver data in platform device */</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">disp_dev</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span>
			  <span class="n">vpbe_display_layer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * vpbe_display_probe()</span>
<span class="cm"> * This function creates device entries by register itself to the V4L2 driver</span>
<span class="cm"> * and initializes fields of each layer objects</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">vpbe_display_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">vpbe_display_layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;vpbe_display_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Allocate memory for vpbe_display */</span>
	<span class="n">disp_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpbe_display</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disp_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ran out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dma_queue_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Scan all the platform devices to find the vpbe</span>
<span class="cm">	 * controller device and get the vpbe_dev object</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">disp_dev</span><span class="p">,</span>
			<span class="n">vpbe_device_get</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* Initialize the vpbe display controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">initialize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
					<span class="s">&quot;Error initing vpbe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPBE_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_vpbe_layer</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">disp_dev</span><span class="p">,</span> <span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			 <span class="s">&quot;Unable to get VENC interrupt resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">venc_isr</span><span class="p">,</span>  <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">VPBE_DISPLAY_DRIVER</span><span class="p">,</span>
		<span class="n">disp_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to request interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPBE_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">register_device</span><span class="p">(</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">disp_dev</span><span class="p">,</span> <span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">probe_out_irq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Successfully completed the probing of vpbe v4l2 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_out_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">disp_dev</span><span class="p">);</span>
<span class="nl">probe_out:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">VPBE_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the pointer to the layer object */</span>
		<span class="n">vpbe_display_layer</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="cm">/* Unregister video device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpbe_display_layer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">video_unregister_device</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">disp_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpbe_display_remove()</span>
<span class="cm"> * It un-register hardware layer from V4L2 driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpbe_display_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpbe_layer</span> <span class="o">*</span><span class="n">vpbe_display_layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpbe_display</span> <span class="o">*</span><span class="n">disp_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vpbe_device</span> <span class="o">*</span><span class="n">vpbe_dev</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">vpbe_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;vpbe_display_remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* unregister irq */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">disp_dev</span><span class="p">);</span>

	<span class="cm">/* deinitialize the vpbe display controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">deinitialize</span><span class="p">)</span>
		<span class="n">vpbe_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">deinitialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vpbe_dev</span><span class="p">);</span>
	<span class="cm">/* un-register device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPBE_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the pointer to the layer object */</span>
		<span class="n">vpbe_display_layer</span> <span class="o">=</span> <span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* Unregister video device */</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpbe_display_layer</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPBE_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">disp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">vpbe_display_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">VPBE_DISPLAY_DRIVER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">vpbe_display_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">vpbe_display_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">vpbe_display_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TI DM644x/DM355/DM365 VPBE Display controller&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
