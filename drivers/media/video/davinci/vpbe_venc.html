<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › davinci › vpbe_venc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>vpbe_venc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments Inc</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;mach/mux.h&gt;</span>
<span class="cp">#include &lt;mach/i2c.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;media/davinci/vpbe_types.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpbe_venc.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpss.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>

<span class="cp">#include &quot;vpbe_venc_regs.h&quot;</span>

<span class="cp">#define MODULE_NAME	VPBE_VENC_SUBDEV_NAME</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level 0-2&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">venc_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">venc_callback</span> <span class="o">*</span><span class="n">callback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">output</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">venc_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vdaccfg_reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="nf">to_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">venc_state</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">venc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">venc_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">venc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">venc_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">venc_modify</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">new_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">venc_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">new_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">new_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">vdaccfg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">vdaccfg_reg</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">vdaccfg_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define VDAC_COMPONENT	0x543</span>
<span class="cp">#define VDAC_S_VIDEO	0x210</span>
<span class="cm">/* This function sets the dac of the VPBE for various outputs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">out_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">out_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Setting output to Composite</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DACSEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Setting output to Component</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DACSEL</span><span class="p">,</span> <span class="n">VDAC_COMPONENT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Setting output to S-video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DACSEL</span><span class="p">,</span> <span class="n">VDAC_S_VIDEO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_enabledigitaloutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">benable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_enabledigitaloutput</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">benable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_CVBS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_LCDOUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HSPLS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HSTART</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HVALID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VSPLS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VSTART</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VVALID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_YCCCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DACSEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* disable VCLK output pin enable */</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VIDCTL</span><span class="p">,</span> <span class="mh">0x141</span><span class="p">);</span>

		<span class="cm">/* Disable output sync pins */</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_SYNCCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Disable DCLOCK */</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DCLKCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DRGBX1</span><span class="p">,</span> <span class="mh">0x0000057C</span><span class="p">);</span>

		<span class="cm">/* Disable LCD output control (accepting default polarity) */</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_LCDOUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span>
			<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_CMPNT</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HSPLS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HSTART</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HVALID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VSPLS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VSTART</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VVALID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_HSDLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VSDLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_YCCCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VSTARTA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Set OSD clock and OSD Sync Adavance registers */</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define VDAC_CONFIG_SD_V3	0x0E21A6B6</span>
<span class="cp">#define VDAC_CONFIG_SD_V2	0x081141CF</span>
<span class="cm">/*</span>
<span class="cm"> * setting NTSC mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_ntsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_set_ntsc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Setup clock at VPSS &amp; VENC for SD */</span>
	<span class="n">vpss_enable_clock</span><span class="p">(</span><span class="n">VPSS_VENC_CLOCK_SEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_clock</span><span class="p">(</span><span class="n">VPBE_ENC_STD</span><span class="p">,</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">venc_enabledigitaloutput</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_CLKCTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VIDCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_SD_V3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_CLKCTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VIDCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_SD_V2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* to set VENC CLK DIV to 1 - final clock is 54 MHz */</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VIDCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Set REC656 Mode */</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_YCCCTL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VDPRO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VENC_VDPRO_DAFRQ</span><span class="p">);</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VDPRO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VENC_VDPRO_DAUPS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VIE_SHIFT</span><span class="p">),</span>
			<span class="n">VENC_VMOD_VIE</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VMD</span><span class="p">),</span> <span class="n">VENC_VMOD_VMD</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_TVTYP_SHIFT</span><span class="p">),</span>
			<span class="n">VENC_VMOD_TVTYP</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DACTST</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * setting PAL mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_pal</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_set_pal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Setup clock at VPSS &amp; VENC for SD */</span>
	<span class="n">vpss_enable_clock</span><span class="p">(</span><span class="n">VPSS_VENC_CLOCK_SEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_clock</span><span class="p">(</span><span class="n">VPBE_ENC_STD</span><span class="p">,</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">venc_enabledigitaloutput</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_CLKCTL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VIDCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_SD_V3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_CLKCTL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VIDCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_SD_V2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* to set VENC CLK DIV to 1 - final clock is 54 MHz */</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VIDCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Set REC656 Mode */</span>
		<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_YCCCTL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_SYNCCTL</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_SYNCCTL_OVD_SHIFT</span><span class="p">,</span>
			<span class="n">VENC_SYNCCTL_OVD</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VIE_SHIFT</span><span class="p">),</span>
			<span class="n">VENC_VMOD_VIE</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VMD</span><span class="p">),</span> <span class="n">VENC_VMOD_VMD</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_TVTYP_SHIFT</span><span class="p">),</span>
			<span class="n">VENC_VMOD_TVTYP</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_DACTST</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define VDAC_CONFIG_HD_V2	0x081141EF</span>
<span class="cm">/*</span>
<span class="cm"> * venc_set_480p59_94</span>
<span class="cm"> *</span>
<span class="cm"> * This function configures the video encoder to EDTV(525p) component setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_480p59_94</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_set_480p59_94</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Setup clock at VPSS &amp; VENC for SD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_clock</span><span class="p">(</span><span class="n">VPBE_ENC_DV_PRESET</span><span class="p">,</span> <span class="n">V4L2_DV_480P59_94</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">venc_enabledigitaloutput</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span>
		<span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_HD_V2</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VDPRO</span><span class="p">,</span> <span class="n">VENC_VDPRO_DAFRQ</span><span class="p">,</span>
			    <span class="n">VENC_VDPRO_DAFRQ</span><span class="p">);</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VDPRO</span><span class="p">,</span> <span class="n">VENC_VDPRO_DAUPS</span><span class="p">,</span>
			    <span class="n">VENC_VDPRO_DAUPS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VIE_SHIFT</span><span class="p">),</span>
		    <span class="n">VENC_VMOD_VIE</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="n">HDTV_525P</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_TVTYP_SHIFT</span><span class="p">),</span>
		    <span class="n">VENC_VMOD_TVTYP</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VDMD_YCBCR8</span> <span class="o">&lt;&lt;</span>
		    <span class="n">VENC_VMOD_VDMD_SHIFT</span><span class="p">,</span> <span class="n">VENC_VMOD_VDMD</span><span class="p">);</span>

	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * venc_set_625p</span>
<span class="cm"> *</span>
<span class="cm"> * This function configures the video encoder to HDTV(625p) component setting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_576p50</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_set_576p50</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Setup clock at VPSS &amp; VENC for SD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_clock</span><span class="p">(</span><span class="n">VPBE_ENC_DV_PRESET</span><span class="p">,</span> <span class="n">V4L2_DV_576P50</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">venc_enabledigitaloutput</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">)</span>
		<span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_HD_V2</span><span class="p">);</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VDPRO</span><span class="p">,</span> <span class="n">VENC_VDPRO_DAFRQ</span><span class="p">,</span>
			    <span class="n">VENC_VDPRO_DAFRQ</span><span class="p">);</span>
		<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VDPRO</span><span class="p">,</span> <span class="n">VENC_VDPRO_DAUPS</span><span class="p">,</span>
			    <span class="n">VENC_VDPRO_DAUPS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VIE_SHIFT</span><span class="p">),</span>
		    <span class="n">VENC_VMOD_VIE</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="n">HDTV_625P</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_TVTYP_SHIFT</span><span class="p">),</span>
		    <span class="n">VENC_VMOD_TVTYP</span><span class="p">);</span>

	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VDMD_YCBCR8</span> <span class="o">&lt;&lt;</span>
		    <span class="n">VENC_VMOD_VDMD_SHIFT</span><span class="p">,</span> <span class="n">VENC_VMOD_VDMD</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * venc_set_720p60_internal - Setup 720p60 in venc for dm365 only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_720p60_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_clock</span><span class="p">(</span><span class="n">VPBE_ENC_DV_PRESET</span><span class="p">,</span> <span class="n">V4L2_DV_720P60</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">venc_enabledigitaloutput</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* DM365 component HD mode */</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VIE_SHIFT</span><span class="p">),</span>
	    <span class="n">VENC_VMOD_VIE</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="n">HDTV_720P</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_TVTYP_SHIFT</span><span class="p">),</span>
		    <span class="n">VENC_VMOD_TVTYP</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_XHINTVL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * venc_set_1080i30_internal - Setup 1080i30 in venc for dm365 only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_1080i30_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_clock</span><span class="p">(</span><span class="n">VPBE_ENC_DV_PRESET</span><span class="p">,</span> <span class="n">V4L2_DV_1080P30</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">venc_enabledigitaloutput</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_OSDCLK1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>


	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* DM365 component HD mode */</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_VIE_SHIFT</span><span class="p">),</span>
		    <span class="n">VENC_VMOD_VIE</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">,</span> <span class="n">VENC_VMOD_HDMD</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="p">(</span><span class="n">HDTV_1080I</span> <span class="o">&lt;&lt;</span> <span class="n">VENC_VMOD_TVTYP_SHIFT</span><span class="p">),</span>
		    <span class="n">VENC_VMOD_TVTYP</span><span class="p">);</span>
	<span class="n">venc_modify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VMOD</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">,</span> <span class="n">VENC_VMOD_VENC</span><span class="p">);</span>
	<span class="n">venc_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_XHINTVL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_s_std_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_s_std_output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">venc_set_ntsc</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">venc_set_pal</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_s_dv_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="o">*</span><span class="n">dv_preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_s_dv_preset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dv_preset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">==</span> <span class="n">V4L2_DV_576P50</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">venc_set_576p50</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dv_preset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">==</span> <span class="n">V4L2_DV_480P59_94</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">venc_set_480p59_94</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dv_preset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">==</span> <span class="n">V4L2_DV_720P60</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TBD setup internal 720p mode here */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">venc_set_720p60_internal</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="cm">/* for DM365 VPBE, there is DAC inside */</span>
		<span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_HD_V2</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dv_preset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">==</span> <span class="n">V4L2_DV_1080I30</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">==</span> <span class="n">VPBE_VERSION_2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TBD setup internal 1080i mode here */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">venc_set_1080i30_internal</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="cm">/* for DM365 VPBE, there is DAC inside */</span>
		<span class="n">vdaccfg_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VDAC_CONFIG_HD_V2</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_s_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">input</span><span class="p">,</span> <span class="n">u32</span> <span class="n">output</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;venc_s_routing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">venc_set_dac</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">venc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">venc_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VENC_GET_FLD</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">venc_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">VENC_VSTAT</span><span class="p">);</span>
		<span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VENC_VSTAT_FIDST</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">VENC_VSTAT_FIDST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Wrong IOCTL cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">venc_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ioctl</span>      <span class="o">=</span> <span class="n">venc_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">venc_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_routing</span> <span class="o">=</span> <span class="n">venc_s_routing</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_std_output</span> <span class="o">=</span> <span class="n">venc_s_std_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_dv_preset</span> <span class="o">=</span> <span class="n">venc_s_dv_preset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">venc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">venc_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">venc_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Set default to output to composite and std to NTSC */</span>
	<span class="n">venc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">venc</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_525_60</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">venc_s_routing</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Error setting output during init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">venc_s_std_output</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Error setting std during init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_device_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">**</span><span class="n">venc</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">MODULE_NAME</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">venc_sub_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">venc_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">venc</span><span class="p">,</span>
			<span class="n">venc_device_get</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">venc_ops</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">venc_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;vpbe unable to register venc sub device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">venc_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;vpbe venc initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">venc_sub_dev_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">venc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">venc_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;Unable to get platform data for&quot;</span>
			<span class="s">&quot; VENC sub device&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="s">&quot;Unable to get VENC register address map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;venc&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;Unable to reserve VENC MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">venc</span><span class="o">-&gt;</span><span class="n">venc_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">venc_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;Unable to map VENC IO space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_venc_mem_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="s">&quot;Unable to get VDAC_CONFIG address map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap_venc_io</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;venc&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="s">&quot;Unable to reserve VDAC_CONFIG  MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap_venc_io</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">venc</span><span class="o">-&gt;</span><span class="n">vdaccfg_reg</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						    <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">vdaccfg_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="s">&quot;Unable to map VDAC_CONFIG IO space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">release_vdaccfg_mem_region</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">venc</span><span class="p">);</span>
	<span class="n">dev_notice</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;VENC sub device probe success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">release_vdaccfg_mem_region:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="nl">unmap_venc_io:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">venc_base</span><span class="p">);</span>
<span class="nl">release_venc_mem_region:</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="nl">free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">venc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">venc_state</span> <span class="o">*</span><span class="n">venc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">venc_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">venc_type</span> <span class="o">!=</span> <span class="n">VPBE_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">venc</span><span class="o">-&gt;</span><span class="n">vdaccfg_reg</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">venc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">venc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">venc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">venc_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">venc_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VPBE VENC Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
