<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › davinci › vpif_display.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>vpif_display.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * vpif-display - VPIF display driver</span>
<span class="cm"> * Display driver for TI DaVinci VPIF</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed .as is. WITHOUT ANY WARRANTY of any</span>
<span class="cm"> * kind, whether express or implied; without even the implied warranty</span>
<span class="cm"> * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>

<span class="cp">#include &lt;media/adv7343.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>

<span class="cp">#include &quot;vpif_display.h&quot;</span>
<span class="cp">#include &quot;vpif.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TI DaVinci VPIF Display driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">VPIF_DISPLAY_VERSION</span><span class="p">);</span>

<span class="cp">#define DM646X_V4L2_STD (V4L2_STD_525_60 | V4L2_STD_625_50)</span>

<span class="cp">#define vpif_err(fmt, arg...)	v4l2_err(&amp;vpif_obj.v4l2_dev, fmt, ## arg)</span>
<span class="cp">#define vpif_dbg(level, debug, fmt, arg...)	\</span>
<span class="cp">		v4l2_dbg(level, debug, &amp;vpif_obj.v4l2_dev, fmt, ## arg)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">ch2_numbuffers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">ch3_numbuffers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">ch2_bufsize</span> <span class="o">=</span> <span class="mi">1920</span> <span class="o">*</span> <span class="mi">1080</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">ch3_bufsize</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">576</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ch2_numbuffers</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ch3_numbuffers</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ch2_bufsize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ch3_bufsize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level 0-1&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ch2_numbuffers</span><span class="p">,</span> <span class="s">&quot;Channel2 buffer count (default:3)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ch3_numbuffers</span><span class="p">,</span> <span class="s">&quot;Channel3 buffer count (default:3)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ch2_bufsize</span><span class="p">,</span> <span class="s">&quot;Channel2 buffer size (default:1920 x 1080 x 2)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ch3_bufsize</span><span class="p">,</span> <span class="s">&quot;Channel3 buffer size (default:720 x 576 x 2)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpif_config_params</span> <span class="n">config_params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">min_numbuffers</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_bufsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">480</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_bufsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">480</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">1920</span> <span class="o">*</span> <span class="mi">1080</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">576</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpif_device</span> <span class="n">vpif_obj</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">vpif_dev</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_uservirt_to_phys: This function is used to convert user</span>
<span class="cm"> * space virtual address to physical address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">vpif_uservirt_to_phys</span><span class="p">(</span><span class="n">u32</span> <span class="n">virtp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>

	<span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">virtp</span><span class="p">);</span>

	<span class="cm">/* For kernel direct-mapped memory, take the easy way */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virtp</span> <span class="o">&gt;=</span> <span class="n">PAGE_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">physp</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">virtp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this will catch, kernel-allocated, mmaped-to-usermode addr */</span>
		<span class="n">physp</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">virtp</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* otherwise, use get_user_pages() for general userland pages */</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">nr_pages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span>
				     <span class="n">virtp</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">physp</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">virtp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;get_user_pages failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">physp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * buffer_prepare: This is the callback function called from videobuf_qbuf()</span>
<span class="cm"> * function the buffer is prepared and user space virtual address is converted</span>
<span class="cm"> * into physical address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span>	<span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>

	<span class="cm">/* if user pointer memory mechanism is used, get the physical</span>
<span class="cm">	 * address of the buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">baddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;buffer_address is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">boff</span> <span class="o">=</span> <span class="n">vpif_uservirt_to_phys</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">baddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISALIGNED</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">boff</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">buf_align_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">boff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_SLICED_VBI_OUTPUT</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISALIGNED</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ISALIGNED</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ISALIGNED</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ISALIGNED</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">buf_align_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">buf_align_exit:</span>
	<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;buffer offset not aligned to 8 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_buffer_setup: This function allocates memory for the buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_buffer_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">!=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_numbuffers</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_numbuffers</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_buffer_queue: This function adds the buffer to DMA queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpif_buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>

	<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="cm">/* add the buffer to the DMA queue */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">);</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_buffer_release: This function is called from the videobuf layer to</span>
<span class="cm"> * free memory allocated to the buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpif_buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="n">videobuf_dma_contig_free</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">!=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buf_size</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">video_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span>	<span class="o">=</span> <span class="n">vpif_buffer_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>	<span class="o">=</span> <span class="n">vpif_buffer_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>	<span class="o">=</span> <span class="n">vpif_buffer_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span>	<span class="o">=</span> <span class="n">vpif_buffer_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">channel_first_int</span><span class="p">[</span><span class="n">VPIF_NUMOBJECTS</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_progressive_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the next buffer from buffer queue */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Remove that buffer from the buffer queue */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Mark status of the buffer as active */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>

	<span class="cm">/* Set top and bottom field addrs in VPIF registers */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">set_addr</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span><span class="p">,</span>
				 <span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span><span class="p">,</span>
				 <span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span><span class="p">,</span>
				 <span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_interlaced_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">fid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* device field id and local field id are in sync */</span>
	<span class="cm">/* If this is even field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* one frame is displayed If next frame is</span>
<span class="cm">		 *  available, release cur_frm and move on */</span>
		<span class="cm">/* Copy frame display time */</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">);</span>
		<span class="cm">/* Change status of the cur_frm */</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
		<span class="cm">/* unlock semaphore on cur_frm */</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="cm">/* Make cur_frm pointing to next_frm */</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">fid</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* odd field */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">!=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* one field is displayed configure the next</span>
<span class="cm">		 * frame if it is available else hold on current</span>
<span class="cm">		 * frame */</span>
		<span class="cm">/* Get next from the buffer queue */</span>
		<span class="n">process_progressive_mode</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_channel_isr: It changes status of the displayed buffer, takes next</span>
<span class="cm"> * buffer from the queue and sets its address in VPIF registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vpif_channel_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">channel_id</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">channel_id</span><span class="p">];</span>
	<span class="n">field</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">].</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPIF_NUMOBJECTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* If streaming is started in this channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">frm_fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Progressive mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel_first_int</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">channel_id</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* Mark status of the cur_frm to</span>
<span class="cm">				 * done and unlock semaphore on it */</span>
				<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">);</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
				<span class="cm">/* Make cur_frm pointing to next_frm */</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">channel_first_int</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">process_progressive_mode</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Interlaced mode */</span>
			<span class="cm">/* If it is first interrupt, ignore it */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">channel_first_int</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">channel_id</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">channel_first_int</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="cm">/* Get field id from VPIF registers */</span>
				<span class="n">fid</span> <span class="o">=</span> <span class="n">vpif_channel_getfid</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="cm">/* If fid does not match with stored field id */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">field_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Make them in sync */</span>
					<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">fid</span><span class="p">)</span>
						<span class="n">ch</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>

					<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">process_interlaced_mode</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">common</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_update_std_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_params</span> <span class="o">*</span><span class="n">vpifparams</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_channel_config_params</span> <span class="o">*</span><span class="n">std_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">std_info</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vpif_channel_config_params</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vpif_ch_params_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch_params</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">hd_sd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;SD format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">stdid</span> <span class="o">&amp;</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">stdid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">std_info</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;HD format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">dv_preset</span> <span class="o">==</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">dv_preset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">std_info</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">vpif_ch_params_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Format not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_update_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_params</span> <span class="o">*</span><span class="n">vpifparams</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_channel_config_params</span> <span class="o">*</span><span class="n">std_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">std_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">stdid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">dv_preset</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">bt_timings</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">stdid</span> <span class="o">||</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">dv_preset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpif_update_std_info</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Pixel details: Width = %d,Height = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* Set height and width paramateres */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_calculate_offsets: This function calculates buffers offset for Y and C</span>
<span class="cm"> * in the top and bottom field</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpif_calculate_offsets</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">vpif_params</span> <span class="o">*</span><span class="n">vpifparams</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hpitch</span><span class="p">,</span> <span class="n">vpitch</span><span class="p">,</span> <span class="n">sizeimage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_ANY</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">frm_fmt</span><span class="p">)</span>
			<span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
		<span class="n">sizeimage</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sizeimage</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>

	<span class="n">hpitch</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">vpitch</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="p">(</span><span class="n">hpitch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">V4L2_FIELD_NONE</span> <span class="o">==</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">V4L2_FIELD_INTERLACED</span> <span class="o">==</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span> <span class="o">=</span> <span class="n">hpitch</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">hpitch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_SEQ_TB</span> <span class="o">==</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span> <span class="o">+</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_SEQ_BT</span> <span class="o">==</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span> <span class="o">+</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">V4L2_FIELD_NONE</span> <span class="o">==</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">V4L2_FIELD_INTERLACED</span> <span class="o">==</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">buf_field</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">video_params</span><span class="p">.</span><span class="n">storage_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">video_params</span><span class="p">.</span><span class="n">storage_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">frm_fmt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">video_params</span><span class="p">.</span><span class="n">hpitch</span> <span class="o">=</span>
		    <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">))</span>
			<span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">video_params</span><span class="p">.</span><span class="n">hpitch</span> <span class="o">=</span>
			    <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">video_params</span><span class="p">.</span><span class="n">hpitch</span> <span class="o">=</span>
			    <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">video_params</span><span class="p">.</span><span class="n">stdid</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">stdid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpif_config_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config_params</span><span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span>
			<span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_check_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sizeimage</span><span class="p">,</span> <span class="n">hpitch</span><span class="p">,</span> <span class="n">vpitch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">invalid_fmt_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VPIF_VALID_FIELD</span><span class="p">(</span><span class="n">field</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">invalid_fmt_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">invalid_pitch_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
		<span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sizeimage</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpif_update_resolution</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hpitch</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">vpitch</span> <span class="o">=</span> <span class="n">sizeimage</span> <span class="o">/</span> <span class="p">(</span><span class="n">hpitch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Check for valid value of pitch */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hpitch</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vpitch</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">height</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">invalid_pitch_exit</span><span class="p">;</span>

	<span class="cm">/* Check for 8 byte alignment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISALIGNED</span><span class="p">(</span><span class="n">hpitch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;invalid pitch alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">invalid_fmt_exit:</span>
	<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;invalid field format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">invalid_pitch_exit:</span>
	<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;invalid pitch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpif_config_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">muxmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VPIF_CHANNEL3_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">set_addr</span> <span class="o">=</span> <span class="n">ch3_set_videobuf_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">muxmode</span><span class="p">)</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">set_addr</span> <span class="o">=</span> <span class="n">ch2_set_videobuf_addr_yc_nmux</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">set_addr</span> <span class="o">=</span> <span class="n">ch2_set_videobuf_addr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_mmap: It is used to map kernel space buffers into user spaces</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">filep</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">]);</span>

	<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;vpif_mmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_mmap_mapper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_poll: It is used for select/poll system call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">vpif_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">filep</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">filep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_open: It creates object of file handle structure and stores it in</span>
<span class="cm"> * private_data member of filepointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">filep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="cm">/* Allocate memory for the file handle object */</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpif_fh</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;unable to allocate memory for file handle object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* store pointer to fh in private_data member of filep */</span>
	<span class="n">filep</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Increment channel usrs counter */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">usrs</span><span class="p">);</span>
	<span class="cm">/* Set io_allowed[VPIF_VIDEO_INDEX] member to false */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Initialize priority of this instance to default priority */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="n">V4L2_PRIORITY_UNSET</span><span class="p">;</span>
	<span class="n">v4l2_prio_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_release: This function deletes buffer queue, frees the buffers and</span>
<span class="cm"> * the vpif file handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">filep</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="cm">/* if this instance is doing IO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Reset io_usrs member of channel object */</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">io_usrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Disable channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VPIF_CHANNEL2_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable_channel2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">channel2_intr_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">VPIF_CHANNEL3_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">enable_channel3</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">channel3_intr_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Free buffers allocated */</span>
		<span class="n">videobuf_queue_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
		<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">numbuffers</span> <span class="o">=</span>
		    <span class="n">config_params</span><span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Decrement channel usrs counter */</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">usrs</span><span class="p">);</span>
	<span class="cm">/* If this file handle has initialize encoder device, reset it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Close the priority */</span>
	<span class="n">v4l2_prio_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="n">filep</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* functions implementing ioctls */</span>
<span class="cm">/**</span>
<span class="cm"> * vpif_querycap() - QUERYCAP handler</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @cap: ptr to v4l2_capability structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_display_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">vpif_dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span> <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;vpif display&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;Platform&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_enum_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;Invalid format index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the information about format */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;YCbCr4:2:2 YC Planar&quot;</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_g_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="cm">/* Check the validity of the buffer type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpif_update_resolution</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_s_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">VPIF_CHANNEL2_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">VPIF_CHANNEL3_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Channel Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check for the priority */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Streaming in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pixfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="cm">/* Check for valid field format */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpif_check_format</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* store the pix format in the channel object */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span> <span class="o">=</span> <span class="o">*</span><span class="n">pixfmt</span><span class="p">;</span>
	<span class="cm">/* store the format in the channel object */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_try_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpif_check_format</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">reqbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This file handle has not initialized the channel,</span>
<span class="cm">	   It is not allowed to do settings */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">VPIF_CHANNEL2_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">VPIF_CHANNEL3_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;Channel Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">VPIF_VIDEO_INDEX</span><span class="p">;</span>

	<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">io_usrs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">)</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_VBI_INTERLACED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize videobuf queue as per the buffer type */</span>
	<span class="n">videobuf_queue_dma_contig_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">video_qops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span>
					    <span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">),</span> <span class="n">fh</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Set io allowed member of file handle to TRUE */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Increment io usrs member of channel object to 1 */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">io_usrs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Store type of memory requested in channel object */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">);</span>

	<span class="cm">/* Allocate buffers */</span>
	<span class="k">return</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">reqbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">tbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">tbuf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="n">tbuf</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">buf1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">tbuf</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;fh-&gt;io_allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">!=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">field_id</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* bufferqueue is empty store buffer address in VPIF registers */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">.</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="n">buf1</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">.</span><span class="n">bufs</span><span class="p">[</span><span class="n">tbuf</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">tbuf</span><span class="p">.</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;invalid buffer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">qbuf_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buf1</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">buf1</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;invalid state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">qbuf_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">buf1</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MEMORY_MMAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="o">-&gt;</span><span class="n">baddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">qbuf_exit</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_MEMORY_USERPTR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tbuf</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">buf1</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">qbuf_exit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">!=</span> <span class="n">buf1</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf1</span><span class="o">-&gt;</span><span class="n">baddr</span> <span class="o">!=</span> <span class="n">tbuf</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vpif_buffer_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">buf1</span><span class="p">);</span>
			<span class="n">buf1</span><span class="o">-&gt;</span><span class="n">baddr</span> <span class="o">=</span> <span class="n">tbuf</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">qbuf_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpif_buffer_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span>
					<span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">qbuf_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf1</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">buf1</span><span class="o">-&gt;</span><span class="n">boff</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbuf</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">set_addr</span><span class="p">((</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf1</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">.</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">qbuf_exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">.</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">std_id</span> <span class="o">&amp;</span> <span class="n">DM646X_V4L2_STD</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;streaming in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Call encoder subdevice function to set the standard */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">stdid</span> <span class="o">=</span> <span class="o">*</span><span class="n">std_id</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">dv_preset</span> <span class="o">=</span> <span class="n">V4L2_DV_INVALID</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">bt_timings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">bt_timings</span><span class="p">));</span>

	<span class="cm">/* Get the information about the standard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpif_update_resolution</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span>
		<span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;invalid std for this size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="cm">/* Configure the default format information */</span>
	<span class="n">vpif_config_format</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
						<span class="n">s_std_output</span><span class="p">,</span> <span class="o">*</span><span class="n">std_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;Failed to set output standard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span>
							<span class="n">s_std</span><span class="p">,</span> <span class="o">*</span><span class="n">std_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;Failed to set standard for sub devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">stdid</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
					<span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buftype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">oth_ch</span> <span class="o">=</span> <span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">vpif_params</span> <span class="o">*</span><span class="n">vpif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_display_config</span> <span class="o">*</span><span class="n">vpif_config_data</span> <span class="o">=</span>
					<span class="n">vpif_dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buftype</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;buffer type not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;fh-&gt;io_allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If Streaming is already started, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;channel-&gt;started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span> <span class="o">==</span> <span class="n">VPIF_CHANNEL2_VIDEO</span>
		<span class="o">&amp;&amp;</span> <span class="n">oth_ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">].</span><span class="n">started</span> <span class="o">&amp;&amp;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">ycmux_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span> <span class="o">==</span> <span class="n">VPIF_CHANNEL3_VIDEO</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">oth_ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">].</span><span class="n">started</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;other channel is using</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vpif_check_format</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Call videobuf_streamon to start streaming in videobuf */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;videobuf_streamon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If buffer queue is empty, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;buffer queue is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the next frame from the buffer queue */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span>
			    <span class="n">list_entry</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Mark state of the current frame to active */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>

	<span class="cm">/* Initialize field_id and started member */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buftype</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">boff</span><span class="p">;</span>
		<span class="cm">/* Calculate the offset for Y and C data  in the buffer */</span>
		<span class="n">vpif_calculate_offsets</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">frm_fmt</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">)))</span>
			<span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">frm_fmt</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;conflict in field format and std format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clock settings */</span>
		<span class="n">ret</span> <span class="o">=</span>
		 <span class="n">vpif_config_data</span><span class="o">-&gt;</span><span class="n">set_clock</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">ycmux_mode</span><span class="p">,</span>
						<span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">.</span><span class="n">std_info</span><span class="p">.</span><span class="n">hd_sd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;can&#39;t set clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set the parameters and addresses */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vpif_set_video_params</span><span class="p">(</span><span class="n">vpif</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">vpif_config_addr</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">set_addr</span><span class="p">((</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span><span class="p">));</span>

		<span class="cm">/* Set interrupt for both the fields in VPIF</span>
<span class="cm">		   Register enable channel in VPIF register */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VPIF_CHANNEL2_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel2_intr_assert</span><span class="p">();</span>
			<span class="n">channel2_intr_enable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">enable_channel2</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">VPIF_CHANNEL3_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">channel3_intr_assert</span><span class="p">();</span>
			<span class="n">channel3_intr_enable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">enable_channel3</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">channel_first_int</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">][</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buftype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buftype</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;buffer type not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">io_allowed</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;fh-&gt;io_allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;channel-&gt;started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buftype</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VPIF_CHANNEL2_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable_channel2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">channel2_intr_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">VPIF_CHANNEL3_VIDEO</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">enable_channel3</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">channel3_intr_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">buffer_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_enum_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_output</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">vpif_display_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">vpif_dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">output_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Invalid output index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">output</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_OUTPUT_TYPE_ANALOG</span><span class="p">;</span>
	<span class="n">output</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">DM646X_V4L2_STD</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_s_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;Streaming in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
							<span class="n">s_routing</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;Failed to set output standard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">output_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_g_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">output_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_g_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v4l2_prio_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_s_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_prio_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpif_enum_dv_presets() - ENUM_DV_PRESETS handler</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @preset: input preset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_enum_dv_presets</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dv_enum_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">output_id</span><span class="p">],</span>
			<span class="n">video</span><span class="p">,</span> <span class="n">enum_dv_presets</span><span class="p">,</span> <span class="n">preset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpif_s_dv_presets() - S_DV_PRESETS handler</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @preset: input preset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_s_dv_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;streaming in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Call encoder subdevice function to set the standard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">dv_preset</span> <span class="o">=</span> <span class="n">preset</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">stdid</span> <span class="o">=</span> <span class="n">V4L2_STD_UNKNOWN</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">bt_timings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">bt_timings</span><span class="p">));</span>

	<span class="cm">/* Get the information about the standard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpif_update_resolution</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Configure the default format information */</span>
		<span class="n">vpif_config_format</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">output_id</span><span class="p">],</span>
				<span class="n">video</span><span class="p">,</span> <span class="n">s_dv_preset</span><span class="p">,</span> <span class="n">preset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * vpif_g_dv_presets() - G_DV_PRESETS handler</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @preset: input preset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_g_dv_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">preset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">dv_preset</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * vpif_s_dv_timings() - S_DV_TIMINGS handler</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @timings: digital video timings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_s_dv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dv_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_params</span> <span class="o">*</span><span class="n">vpifparams</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_channel_config_params</span> <span class="o">*</span><span class="n">std_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpifparams</span><span class="o">-&gt;</span><span class="n">std_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_bt_timings</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">bt_timings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_DV_BT_656_1120</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Timing type not defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure subdevice timings, if any */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">output_id</span><span class="p">],</span>
			<span class="n">video</span><span class="p">,</span> <span class="n">s_dv_timings</span><span class="p">,</span> <span class="n">timings</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Custom DV timings not supported by &quot;</span>
				<span class="s">&quot;subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Error setting custom DV timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;&amp;</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">height</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">hbackporch</span> <span class="o">||</span>
				 <span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">hfrontporch</span> <span class="o">||</span>
				 <span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">hsync</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">vfrontporch</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">vbackporch</span> <span class="o">||</span>
				 <span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">.</span><span class="n">vsync</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Timings for width, height, &quot;</span>
				<span class="s">&quot;horizontal back porch, horizontal sync, &quot;</span>
				<span class="s">&quot;horizontal front porch, vertical back porch, &quot;</span>
				<span class="s">&quot;vertical sync and vertical back porch &quot;</span>
				<span class="s">&quot;must be defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">;</span>

	<span class="cm">/* Configure video port timings */</span>

	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">eav2sav</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">hbackporch</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">hfrontporch</span> <span class="o">+</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">hsync</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">sav2eav</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l3</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">vbackporch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vbackporch</span> <span class="o">||</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vfrontporch</span> <span class="o">||</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vsync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">vsize</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
				<span class="n">bt</span><span class="o">-&gt;</span><span class="n">vfrontporch</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">vbackporch</span> <span class="o">+</span>
				<span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vfrontporch</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vsync</span> <span class="o">+</span>
				<span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vbackporch</span><span class="p">;</span>
			<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l5</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">vsize</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">vfrontporch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l7</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">vsize</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l9</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l7</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vsync</span> <span class="o">+</span>
				<span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vbackporch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l11</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">vsize</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">il_vfrontporch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Required timing values for &quot;</span>
					<span class="s">&quot;interlaced BT format missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">vsize</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">vfrontporch</span> <span class="o">+</span>
			<span class="n">bt</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">vbackporch</span><span class="p">;</span>
		<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">l5</span> <span class="o">=</span> <span class="n">std_info</span><span class="o">-&gt;</span><span class="n">vsize</span> <span class="o">-</span> <span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">vfrontporch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">std_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Custom timings BT656/1120&quot;</span><span class="p">,</span>
			<span class="n">VPIF_MAX_NAME</span><span class="p">);</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">frm_fmt</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">interlaced</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">ycmux_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">capture_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">vbi_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">hd_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">stdid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">std_info</span><span class="o">-&gt;</span><span class="n">dv_preset</span> <span class="o">=</span> <span class="n">V4L2_DV_INVALID</span><span class="p">;</span>

	<span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">stdid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">dv_preset</span> <span class="o">=</span> <span class="n">V4L2_DV_INVALID</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vpif_g_dv_timings() - G_DV_TIMINGS handler</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @timings: digital video timings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_g_dv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dv_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_bt_timings</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">bt_timings</span><span class="p">;</span>

	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">bt</span> <span class="o">=</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_g_chip_ident() - Identify the chip</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @chip: chip identity</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero or -EINVAL if read operations fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_NONE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_DRIVER</span> <span class="o">&amp;&amp;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_ADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;match_type is invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span>
			<span class="n">g_chip_ident</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * vpif_dbg_g_register() - Read register</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @reg: register to be read</span>
<span class="cm"> *</span>
<span class="cm"> * Debugging only</span>
<span class="cm"> * Returns zero or -EINVAL if read operations fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vpif_dbg_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">){</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">output_id</span><span class="p">],</span> <span class="n">core</span><span class="p">,</span>
			<span class="n">g_register</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_dbg_s_register() - Write to register</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> * @reg: register to be modified</span>
<span class="cm"> *</span>
<span class="cm"> * Debugging only</span>
<span class="cm"> * Returns zero or -EINVAL if write operations fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vpif_dbg_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">){</span>
	<span class="k">struct</span> <span class="n">vpif_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_obj</span> <span class="o">*</span><span class="n">vid_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">vid_ch</span><span class="o">-&gt;</span><span class="n">output_id</span><span class="p">],</span> <span class="n">core</span><span class="p">,</span>
			<span class="n">s_register</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_log_status() - Status information</span>
<span class="cm"> * @file: file ptr</span>
<span class="cm"> * @priv: file handle</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vpif_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* status for sub devices */</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">log_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* vpif display ioctl operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">vpif_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>        	<span class="o">=</span> <span class="n">vpif_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_priority</span>		<span class="o">=</span> <span class="n">vpif_g_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_priority</span>		<span class="o">=</span> <span class="n">vpif_s_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out</span>	<span class="o">=</span> <span class="n">vpif_enum_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out</span>  		<span class="o">=</span> <span class="n">vpif_g_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out</span>   	<span class="o">=</span> <span class="n">vpif_s_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out</span> 	<span class="o">=</span> <span class="n">vpif_try_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>         	<span class="o">=</span> <span class="n">vpif_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>        	<span class="o">=</span> <span class="n">vpif_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>            	<span class="o">=</span> <span class="n">vpif_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>           	<span class="o">=</span> <span class="n">vpif_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>        	<span class="o">=</span> <span class="n">vpif_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>       	<span class="o">=</span> <span class="n">vpif_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>           	<span class="o">=</span> <span class="n">vpif_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span>			<span class="o">=</span> <span class="n">vpif_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_output</span>		<span class="o">=</span> <span class="n">vpif_enum_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_output</span>		<span class="o">=</span> <span class="n">vpif_s_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_output</span>		<span class="o">=</span> <span class="n">vpif_g_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>         	<span class="o">=</span> <span class="n">vpif_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_dv_presets</span>         <span class="o">=</span> <span class="n">vpif_enum_dv_presets</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_dv_preset</span>             <span class="o">=</span> <span class="n">vpif_s_dv_preset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_dv_preset</span>             <span class="o">=</span> <span class="n">vpif_g_dv_preset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_dv_timings</span>            <span class="o">=</span> <span class="n">vpif_s_dv_timings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_dv_timings</span>            <span class="o">=</span> <span class="n">vpif_g_dv_timings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_chip_ident</span>		<span class="o">=</span> <span class="n">vpif_g_chip_ident</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span>		<span class="o">=</span> <span class="n">vpif_dbg_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span>		<span class="o">=</span> <span class="n">vpif_dbg_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">vidioc_log_status</span>		<span class="o">=</span> <span class="n">vpif_log_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">vpif_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">vpif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">vpif_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">vpif_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">vpif_poll</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">vpif_video_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;vpif&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">vpif_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vpif_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span>	<span class="o">=</span> <span class="n">DM646X_V4L2_STD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">current_norm</span>	<span class="o">=</span> <span class="n">V4L2_STD_625_50</span><span class="p">,</span>

<span class="p">};</span>

<span class="cm">/*Configure the channels, buffer sizei, request irq */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">initialize_vpif</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">free_channel_objects_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_buffer_channel_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_buffer_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Default number of buffers should be 3 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ch2_numbuffers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ch2_numbuffers</span> <span class="o">&lt;</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_numbuffers</span><span class="p">))</span>
		<span class="n">ch2_numbuffers</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_numbuffers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ch3_numbuffers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ch3_numbuffers</span> <span class="o">&lt;</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_numbuffers</span><span class="p">))</span>
		<span class="n">ch3_numbuffers</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_numbuffers</span><span class="p">;</span>

	<span class="cm">/* Set buffer size to min buffers size if invalid buffer size is</span>
<span class="cm">	 * given */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch2_bufsize</span> <span class="o">&lt;</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_bufsize</span><span class="p">[</span><span class="n">VPIF_CHANNEL2_VIDEO</span><span class="p">])</span>
		<span class="n">ch2_bufsize</span> <span class="o">=</span>
		    <span class="n">config_params</span><span class="p">.</span><span class="n">min_bufsize</span><span class="p">[</span><span class="n">VPIF_CHANNEL2_VIDEO</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch3_bufsize</span> <span class="o">&lt;</span> <span class="n">config_params</span><span class="p">.</span><span class="n">min_bufsize</span><span class="p">[</span><span class="n">VPIF_CHANNEL3_VIDEO</span><span class="p">])</span>
		<span class="n">ch3_bufsize</span> <span class="o">=</span>
		    <span class="n">config_params</span><span class="p">.</span><span class="n">min_bufsize</span><span class="p">[</span><span class="n">VPIF_CHANNEL3_VIDEO</span><span class="p">];</span>

	<span class="n">config_params</span><span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="n">VPIF_CHANNEL2_VIDEO</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch2_numbuffers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch2_numbuffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">VPIF_CHANNEL2_VIDEO</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">ch2_bufsize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">config_params</span><span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="n">VPIF_CHANNEL3_VIDEO</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch3_numbuffers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch3_numbuffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config_params</span><span class="p">.</span><span class="n">channel_bufsize</span><span class="p">[</span><span class="n">VPIF_CHANNEL3_VIDEO</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">ch3_bufsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for six channel objects */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPIF_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_obj</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="cm">/* If memory allocation fails, return error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">free_channel_objects_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">vpif_init_free_channel_objects</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">free_channel_objects_index</span> <span class="o">=</span> <span class="n">VPIF_DISPLAY_MAX_DEVICES</span><span class="p">;</span>
	<span class="n">free_buffer_channel_index</span> <span class="o">=</span> <span class="n">VPIF_DISPLAY_NUM_CHANNELS</span><span class="p">;</span>
	<span class="n">free_buffer_index</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">vpif_init_free_channel_objects:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">free_channel_objects_index</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_probe: This function creates device entries by register itself to the</span>
<span class="cm"> * V4L2 driver and initializes fields of each channel objects</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">vpif_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vpif_subdev_info</span> <span class="o">*</span><span class="n">subdevdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpif_display_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_obj</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">subdev_count</span><span class="p">;</span>

	<span class="n">vpif_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">initialize_vpif</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">vpif_dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;Error initializing vpif</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="n">vpif_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">vpif_dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;Error registering v4l2 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vpif_channel_isr</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
					<span class="s">&quot;DM646x_Display&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">vpif_int_err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">k</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPIF_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Get the pointer to the channel object */</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Allocate memory for video device */</span>
		<span class="n">vfd</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vfd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">video_device_release</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">vpif_int_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize field of video device */</span>
		<span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="n">vpif_video_template</span><span class="p">;</span>
		<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">;</span>
		<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;DM646x_VPIFDisplay_DRIVER_V%s&quot;</span><span class="p">,</span>
			 <span class="n">VPIF_DISPLAY_VERSION</span><span class="p">);</span>

		<span class="cm">/* Set video_dev to the video device */</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="n">vfd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">VPIF_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="cm">/* Initialize field of the channel objects */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">usrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">VPIF_NUMOBJECTS</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">numbuffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">io_usrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>
			<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">numbuffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">set_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ytop_off</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ybtm_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ctop_off</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cbtm_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">));</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">numbuffers</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

		<span class="p">}</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">].</span><span class="n">numbuffers</span> <span class="o">=</span>
			    <span class="n">config_params</span><span class="p">.</span><span class="n">numbuffers</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">].</span><span class="n">numbuffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">vpifparams</span><span class="p">));</span>

		<span class="cm">/* Initialize prio member of channel object */</span>
		<span class="n">v4l2_prio_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">[</span><span class="n">VPIF_VIDEO_INDEX</span><span class="p">].</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
						<span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
		<span class="cm">/* Locking in file operations other than ioctl should be done</span>
<span class="cm">		   by the driver, not the V4L2 core.</span>
<span class="cm">		   This driver needs auditing so that this flag can be removed. */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_LOCK_ALL_FOPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>

		<span class="cm">/* register video device */</span>
		<span class="n">vpif_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;channel=%x,channel-&gt;video_dev=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ch</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span>
					  <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>

		<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">subdev_count</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">subdev_count</span><span class="p">;</span>
	<span class="n">subdevdata</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">subdevinfo</span><span class="p">;</span>
	<span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">subdev_count</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;unable to allocate memory for subdevice pointers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">subdev_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev_board</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span>
						<span class="n">i2c_adap</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">subdevdata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_info</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;Error registering v4l2 subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">probe_subdev_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot;DM646x VPIF display driver initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_subdev_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">);</span>
<span class="nl">probe_out:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">vpif_int_err:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">vpif_err</span><span class="p">(</span><span class="s">&quot;VPIF IRQ request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span> <span class="n">m</span><span class="o">--</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_remove: It un-register channels from V4L2 driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vpif_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel_obj</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="cm">/* un-register device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPIF_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the pointer to the channel object */</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* Unregister video device */</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__refdata</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">vpif_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;vpif_display&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">vpif_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">vpif_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">vpif_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vpif_cleanup: This function un-registers device and driver to the kernel,</span>
<span class="cm"> * frees requested irq handler and de-allocates memory allocated for channel</span>
<span class="cm"> * objects.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpif_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vpif_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">irq_num</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span> <span class="n">irq_num</span> <span class="o">&lt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span> <span class="n">irq_num</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">irq_num</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">));</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_driver</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VPIF_DISPLAY_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vpif_obj</span><span class="p">.</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">vpif_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vpif_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
