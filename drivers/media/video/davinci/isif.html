<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › davinci › isif.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>isif.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2008-2009 Texas Instruments Inc</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * Image Sensor Interface (ISIF) driver</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is for configuring the ISIF IP available on DM365 or any other</span>
<span class="cm"> * TI SoCs. This is used for capturing yuv or bayer video or image data</span>
<span class="cm"> * from a decoder or sensor. This IP is similar to the CCDC IP on DM355</span>
<span class="cm"> * and DM6446, but with enhanced or additional ip blocks. The driver</span>
<span class="cm"> * configures the ISIF upon commands from the vpfe bridge driver through</span>
<span class="cm"> * ccdc_hw_device interface.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: 1) Raw bayer parameter settings and bayer capture</span>
<span class="cm"> *	 2) Add support for control ioctl</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;mach/mux.h&gt;</span>

<span class="cp">#include &lt;media/davinci/isif.h&gt;</span>
<span class="cp">#include &lt;media/davinci/vpss.h&gt;</span>

<span class="cp">#include &quot;isif_regs.h&quot;</span>
<span class="cp">#include &quot;ccdc_hw_device.h&quot;</span>

<span class="cm">/* Defaults for module configuration parameters */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isif_config_params_raw</span> <span class="n">isif_config_defaults</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">linearize</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">corr_shft</span> <span class="o">=</span> <span class="n">ISIF_NO_SHIFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scale_fact</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">df_csc</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">df_or_csc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">csc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">dfc</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">bclamp</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">gain_offset</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">gain</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">r_ye</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			<span class="p">.</span><span class="n">gr_cy</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			<span class="p">.</span><span class="n">gb_g</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			<span class="p">.</span><span class="n">b_mg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">culling</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hcpat_odd</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hcpat_even</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vcpat</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">compress</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">ISIF_ALAW</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ISIF operation configuration */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isif_oper_config</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vpfe_hw_if_type</span> <span class="n">if_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isif_ycbcr_config</span> <span class="n">ycbcr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isif_params_raw</span> <span class="n">bayer</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">isif_data_pack</span> <span class="n">data_pack</span><span class="p">;</span>
	<span class="cm">/* Master clock */</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">mclk</span><span class="p">;</span>
	<span class="cm">/* ISIF base address */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="cm">/* ISIF Linear Table 0 */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">linear_tbl0_addr</span><span class="p">;</span>
	<span class="cm">/* ISIF Linear Table 1 */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">linear_tbl1_addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">isif_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ycbcr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">CCDC_PIXFMT_YCBCR_8BIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frm_fmt</span> <span class="o">=</span> <span class="n">CCDC_FRMFMT_INTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">ISIF_WIN_NTSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fid_pol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vd_pol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hd_pol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pix_order</span> <span class="o">=</span> <span class="n">CCDC_PIXORDER_CBYCRY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_type</span> <span class="o">=</span> <span class="n">CCDC_BUFTYPE_FLD_INTERLEAVED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">bayer</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">CCDC_PIXFMT_RAW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frm_fmt</span> <span class="o">=</span> <span class="n">CCDC_FRMFMT_PROGRESSIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">ISIF_WIN_VGA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fid_pol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vd_pol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hd_pol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gain</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">r_ye</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			<span class="p">.</span><span class="n">gr_cy</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			<span class="p">.</span><span class="n">gb_g</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			<span class="p">.</span><span class="n">b_mg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">cfa_pat</span> <span class="o">=</span> <span class="n">ISIF_CFA_PAT_MOSAIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_msb</span> <span class="o">=</span> <span class="n">ISIF_BIT_MSB_11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">config_params</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">data_shift</span> <span class="o">=</span> <span class="n">ISIF_NO_SHIFT</span><span class="p">,</span>
			<span class="p">.</span><span class="n">col_pat_field0</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">olop</span> <span class="o">=</span> <span class="n">ISIF_GREEN_BLUE</span><span class="p">,</span>
				<span class="p">.</span><span class="n">olep</span> <span class="o">=</span> <span class="n">ISIF_BLUE</span><span class="p">,</span>
				<span class="p">.</span><span class="n">elop</span> <span class="o">=</span> <span class="n">ISIF_RED</span><span class="p">,</span>
				<span class="p">.</span><span class="n">elep</span> <span class="o">=</span> <span class="n">ISIF_GREEN_RED</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">col_pat_field1</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">olop</span> <span class="o">=</span> <span class="n">ISIF_GREEN_BLUE</span><span class="p">,</span>
				<span class="p">.</span><span class="n">olep</span> <span class="o">=</span> <span class="n">ISIF_BLUE</span><span class="p">,</span>
				<span class="p">.</span><span class="n">elop</span> <span class="o">=</span> <span class="n">ISIF_RED</span><span class="p">,</span>
				<span class="p">.</span><span class="n">elep</span> <span class="o">=</span> <span class="n">ISIF_GREEN_RED</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">test_pat_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">data_pack</span> <span class="o">=</span> <span class="n">ISIF_DATA_PACK8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Raw Bayer formats */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">isif_raw_bayer_pix_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_PIX_FMT_SBGGR8</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_SBGGR16</span><span class="p">};</span>

<span class="cm">/* Raw YUV formats */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">isif_raw_yuv_pix_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">};</span>

<span class="cm">/* register access routines */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">regr</span><span class="p">(</span><span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">regw</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* reg_modify() - read, modify and write register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">reg_modify</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">new_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">regr</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">regw_lin_tbl</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl0_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl1_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_disable_all_modules</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable BC */</span>
	<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CLAMPCFG</span><span class="p">);</span>
	<span class="cm">/* disable vdfc */</span>
	<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DFCCTL</span><span class="p">);</span>
	<span class="cm">/* disable CSC */</span>
	<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CSCCTL</span><span class="p">);</span>
	<span class="cm">/* disable linearization */</span>
	<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LINCFG0</span><span class="p">);</span>
	<span class="cm">/* disable other modules here as they are supported */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_enable</span><span class="p">(</span><span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Before disable isif, disable all ISIF modules */</span>
		<span class="n">isif_disable_all_modules</span><span class="p">();</span>
		<span class="cm">/*</span>
<span class="cm">		 * wait for next VD. Assume lowest scan rate is 12 Hz. So</span>
<span class="cm">		 * 100 msec delay is good enough</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">reg_modify</span><span class="p">(</span><span class="n">ISIF_SYNCEN_VDHDEN_MASK</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">SYNCEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_enable_output_to_sdram</span><span class="p">(</span><span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg_modify</span><span class="p">(</span><span class="n">ISIF_SYNCEN_WEN_MASK</span><span class="p">,</span> <span class="n">en</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_SYNCEN_WEN_SHIFT</span><span class="p">,</span> <span class="n">SYNCEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_config_culling</span><span class="p">(</span><span class="k">struct</span> <span class="n">isif_cul</span> <span class="o">*</span><span class="n">cul</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Horizontal pattern */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">cul</span><span class="o">-&gt;</span><span class="n">hcpat_even</span> <span class="o">&lt;&lt;</span> <span class="n">CULL_PAT_EVEN_LINE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">cul</span><span class="o">-&gt;</span><span class="n">hcpat_odd</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CULH</span><span class="p">);</span>

	<span class="cm">/* vertical pattern */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">cul</span><span class="o">-&gt;</span><span class="n">vcpat</span><span class="p">,</span> <span class="n">CULV</span><span class="p">);</span>

	<span class="cm">/* LPF */</span>
	<span class="n">reg_modify</span><span class="p">(</span><span class="n">ISIF_LPF_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_LPF_SHIFT</span><span class="p">,</span>
		  <span class="n">cul</span><span class="o">-&gt;</span><span class="n">en_lpf</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_LPF_SHIFT</span><span class="p">,</span> <span class="n">MODESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_config_gain_offset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isif_gain_offsets_adj</span> <span class="o">*</span><span class="n">gain_off_p</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">.</span><span class="n">gain_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="o">!!</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain_sdram_en</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_SDRAM_EN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="o">!!</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain_ipipe_en</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_IPIPE_EN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="o">!!</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain_h3a_en</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_H3A_EN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="o">!!</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">offset_sdram_en</span> <span class="o">&lt;&lt;</span> <span class="n">OFST_SDRAM_EN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="o">!!</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">offset_ipipe_en</span> <span class="o">&lt;&lt;</span> <span class="n">OFST_IPIPE_EN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="o">!!</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">offset_h3a_en</span> <span class="o">&lt;&lt;</span> <span class="n">OFST_H3A_EN_SHIFT</span><span class="p">);</span>

	<span class="n">reg_modify</span><span class="p">(</span><span class="n">GAIN_OFFSET_EN_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">CGAMMAWD</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">r_ye</span><span class="p">.</span><span class="n">integer</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_INTEGER_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">r_ye</span><span class="p">.</span><span class="n">decimal</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CRGAIN</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">gr_cy</span><span class="p">.</span><span class="n">integer</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_INTEGER_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">gr_cy</span><span class="p">.</span><span class="n">decimal</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CGRGAIN</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">gb_g</span><span class="p">.</span><span class="n">integer</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_INTEGER_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">gb_g</span><span class="p">.</span><span class="n">decimal</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CGBGAIN</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">b_mg</span><span class="p">.</span><span class="n">integer</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_INTEGER_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">.</span><span class="n">b_mg</span><span class="p">.</span><span class="n">decimal</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CBGAIN</span><span class="p">);</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">gain_off_p</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">COFSTA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_restore_defaults</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vpss_ccdc_source_sel</span> <span class="n">source</span> <span class="o">=</span> <span class="n">VPSS_CCDCIN</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">starting isif_restore_defaults...&quot;</span><span class="p">);</span>
	<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span> <span class="o">=</span> <span class="n">isif_config_defaults</span><span class="p">;</span>
	<span class="cm">/* Enable clock to ISIF, IPIPEIF and BL */</span>
	<span class="n">vpss_enable_clock</span><span class="p">(</span><span class="n">VPSS_CCDC_CLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vpss_enable_clock</span><span class="p">(</span><span class="n">VPSS_IPIPEIF_CLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vpss_enable_clock</span><span class="p">(</span><span class="n">VPSS_BL_CLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Set default offset and gain */</span>
	<span class="n">isif_config_gain_offset</span><span class="p">();</span>
	<span class="n">vpss_select_ccdc_source</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">End of isif_restore_defaults...&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isif_restore_defaults</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function will configure the window size to be capture in ISIF reg */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_setwin</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">image_win</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ccdc_frmfmt</span> <span class="n">frm_fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ppc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">horz_start</span><span class="p">,</span> <span class="n">horz_nr_pixels</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vert_start</span><span class="p">,</span> <span class="n">vert_nr_lines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mid_img</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Starting isif_setwin...&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * ppc - per pixel count. indicates how many pixels per cell</span>
<span class="cm">	 * output to SDRAM. example, for ycbcr, it is one y and one c, so 2.</span>
<span class="cm">	 * raw capture this is 1</span>
<span class="cm">	 */</span>
	<span class="n">horz_start</span> <span class="o">=</span> <span class="n">image_win</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ppc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">horz_nr_pixels</span> <span class="o">=</span> <span class="p">((</span><span class="n">image_win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ppc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Writing the horizontal info into the registers */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">horz_start</span> <span class="o">&amp;</span> <span class="n">START_PX_HOR_MASK</span><span class="p">,</span> <span class="n">SPH</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">horz_nr_pixels</span> <span class="o">&amp;</span> <span class="n">NUM_PX_HOR_MASK</span><span class="p">,</span> <span class="n">LNH</span><span class="p">);</span>
	<span class="n">vert_start</span> <span class="o">=</span> <span class="n">image_win</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frm_fmt</span> <span class="o">==</span> <span class="n">CCDC_FRMFMT_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vert_nr_lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_win</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vert_start</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* To account for VD since line 0 doesn&#39;t have any data */</span>
		<span class="n">vert_start</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* To account for VD since line 0 doesn&#39;t have any data */</span>
		<span class="n">vert_start</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vert_nr_lines</span> <span class="o">=</span> <span class="n">image_win</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* configure VDINT0 and VDINT1 */</span>
		<span class="n">mid_img</span> <span class="o">=</span> <span class="n">vert_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">image_win</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">mid_img</span><span class="p">,</span> <span class="n">VDINT1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VDINT0</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">vert_start</span> <span class="o">&amp;</span> <span class="n">START_VER_ONE_MASK</span><span class="p">,</span> <span class="n">SLV0</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">vert_start</span> <span class="o">&amp;</span> <span class="n">START_VER_TWO_MASK</span><span class="p">,</span> <span class="n">SLV1</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">vert_nr_lines</span> <span class="o">&amp;</span> <span class="n">NUM_LINES_VER</span><span class="p">,</span> <span class="n">LNV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_config_bclamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">isif_black_clamp</span> <span class="o">*</span><span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * DC Offset is always added to image data irrespective of bc enable</span>
<span class="cm">	 * status</span>
<span class="cm">	 */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">dc_offset</span><span class="p">,</span> <span class="n">CLDCOFST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">bc_mode_color</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_BC_MODE_COLOR_SHIFT</span><span class="p">;</span>

		<span class="cm">/* Enable BC and horizontal clamp caculation paramaters */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_HORZ_BC_MODE_SHIFT</span><span class="p">);</span>

		<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CLAMPCFG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">ISIF_HORZ_BC_DISABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Window count for calculation</span>
<span class="cm">			 * Base window selection</span>
<span class="cm">			 * pixel limit</span>
<span class="cm">			 * Horizontal size of window</span>
<span class="cm">			 * vertical size of the window</span>
<span class="cm">			 * Horizontal start position of the window</span>
<span class="cm">			 * Vertical start position of the window</span>
<span class="cm">			 */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">win_count_calc</span> <span class="o">|</span>
			      <span class="p">((</span><span class="o">!!</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">base_win_sel_calc</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">ISIF_HORZ_BC_WIN_SEL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">((</span><span class="o">!!</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">clamp_pix_limit</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">ISIF_HORZ_BC_PIX_LIMIT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">win_h_sz_calc</span> <span class="o">&lt;&lt;</span>
				<span class="n">ISIF_HORZ_BC_WIN_H_SIZE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">win_v_sz_calc</span> <span class="o">&lt;&lt;</span>
				<span class="n">ISIF_HORZ_BC_WIN_V_SIZE_SHIFT</span><span class="p">);</span>
			<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CLHWIN0</span><span class="p">);</span>

			<span class="n">regw</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">win_start_h_calc</span><span class="p">,</span> <span class="n">CLHWIN1</span><span class="p">);</span>
			<span class="n">regw</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">.</span><span class="n">win_start_v_calc</span><span class="p">,</span> <span class="n">CLHWIN2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* vertical clamp caculation paramaters */</span>

		<span class="cm">/* Reset clamp value sel for previous line */</span>
		<span class="n">val</span> <span class="o">|=</span>
		<span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">vert</span><span class="p">.</span><span class="n">reset_val_sel</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VERT_BC_RST_VAL_SEL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">vert</span><span class="p">.</span><span class="n">line_ave_coef</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VERT_BC_LINE_AVE_COEF_SHIFT</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CLVWIN0</span><span class="p">);</span>

		<span class="cm">/* Optical Black horizontal start position */</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">vert</span><span class="p">.</span><span class="n">ob_start_h</span><span class="p">,</span> <span class="n">CLVWIN1</span><span class="p">);</span>
		<span class="cm">/* Optical Black vertical start position */</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">vert</span><span class="p">.</span><span class="n">ob_start_v</span><span class="p">,</span> <span class="n">CLVWIN2</span><span class="p">);</span>
		<span class="cm">/* Optical Black vertical size for calculation */</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">vert</span><span class="p">.</span><span class="n">ob_v_sz_calc</span><span class="p">,</span> <span class="n">CLVWIN3</span><span class="p">);</span>
		<span class="cm">/* Vertical start position for BC subtraction */</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">vert_start_sub</span><span class="p">,</span> <span class="n">CLSV</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_config_linearization</span><span class="p">(</span><span class="k">struct</span> <span class="n">isif_linearize</span> <span class="o">*</span><span class="n">linearize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">linearize</span><span class="o">-&gt;</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LINCFG0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* shift value for correction &amp; enable linearization (set lsb) */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">linearize</span><span class="o">-&gt;</span><span class="n">corr_shft</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_LIN_CORRSFT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">LINCFG0</span><span class="p">);</span>

	<span class="cm">/* Scale factor */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="o">!!</span><span class="n">linearize</span><span class="o">-&gt;</span><span class="n">scale_fact</span><span class="p">.</span><span class="n">integer</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
	       <span class="n">ISIF_LIN_SCALE_FACT_INTEG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">linearize</span><span class="o">-&gt;</span><span class="n">scale_fact</span><span class="p">.</span><span class="n">decimal</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">LINCFG1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISIF_LINEAR_TAB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">regw_lin_tbl</span><span class="p">(</span><span class="n">linearize</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">regw_lin_tbl</span><span class="p">(</span><span class="n">linearize</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_config_dfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">isif_dfc</span> <span class="o">*</span><span class="n">vdfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* initialize retries to loop for max ~ 250 usec */</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4000</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">en</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Correction mode */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">corr_mode</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VDFC_CORR_MOD_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Correct whole line or partial */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">corr_whole_line</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VDFC_CORR_WHOLE_LN_SHIFT</span><span class="p">;</span>

	<span class="cm">/* level shift value */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">def_level_shift</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VDFC_LEVEL_SHFT_SHIFT</span><span class="p">;</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DFCCTL</span><span class="p">);</span>

	<span class="cm">/* Defect saturation level */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">def_sat_level</span><span class="p">,</span> <span class="n">VDFSATLV</span><span class="p">);</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pos_vert</span><span class="p">,</span> <span class="n">DFCMEM0</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pos_horz</span><span class="p">,</span> <span class="n">DFCMEM1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">corr_mode</span> <span class="o">==</span> <span class="n">ISIF_VDFC_NORMAL</span> <span class="o">||</span>
	    <span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">corr_mode</span> <span class="o">==</span> <span class="n">ISIF_VDFC_HORZ_INTERPOL_IF_SAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">level_at_pos</span><span class="p">,</span> <span class="n">DFCMEM2</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">level_up_pixels</span><span class="p">,</span> <span class="n">DFCMEM3</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">level_low_pixels</span><span class="p">,</span> <span class="n">DFCMEM4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set DFCMARST and set DFCMWR */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">regr</span><span class="p">(</span><span class="n">DFCMEMCTL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_DFCMEMCTL_DFCMARST_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DFCMEMCTL</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">retries</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">regr</span><span class="p">(</span><span class="n">DFCMEMCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;defect table write timeout !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">num_vdefects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos_vert</span><span class="p">,</span> <span class="n">DFCMEM0</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos_horz</span><span class="p">,</span> <span class="n">DFCMEM1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">corr_mode</span> <span class="o">==</span> <span class="n">ISIF_VDFC_NORMAL</span> <span class="o">||</span>
		    <span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">corr_mode</span> <span class="o">==</span> <span class="n">ISIF_VDFC_HORZ_INTERPOL_IF_SAT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level_at_pos</span><span class="p">,</span> <span class="n">DFCMEM2</span><span class="p">);</span>
			<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level_up_pixels</span><span class="p">,</span> <span class="n">DFCMEM3</span><span class="p">);</span>
			<span class="n">regw</span><span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level_low_pixels</span><span class="p">,</span> <span class="n">DFCMEM4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">regr</span><span class="p">(</span><span class="n">DFCMEMCTL</span><span class="p">);</span>
		<span class="cm">/* clear DFCMARST and set DFCMWR */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">ISIF_DFCMEMCTL_DFCMARST_SHIFT</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DFCMEMCTL</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">retries</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">regr</span><span class="p">(</span><span class="n">DFCMEMCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;defect table write timeout !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdfc</span><span class="o">-&gt;</span><span class="n">num_vdefects</span> <span class="o">&lt;</span> <span class="n">ISIF_VDFC_TABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Extra cycle needed */</span>
		<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DFCMEM0</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="mh">0x1FFF</span><span class="p">,</span> <span class="n">DFCMEM1</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DFCMEMCTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* enable VDFC */</span>
	<span class="n">reg_modify</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VDFC_EN_SHIFT</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VDFC_EN_SHIFT</span><span class="p">),</span>
		   <span class="n">DFCCTL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_config_csc</span><span class="p">(</span><span class="k">struct</span> <span class="n">isif_df_csc</span> <span class="o">*</span><span class="n">df_csc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">csc</span><span class="p">.</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CSCCTL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISIF_CSC_NUM_COEFF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* CSCM - LSB */</span>
			<span class="n">val1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">csc</span><span class="p">.</span><span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">integer</span> <span class="o">&lt;&lt;</span>
				<span class="n">ISIF_CSC_COEF_INTEG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">csc</span><span class="p">.</span><span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">decimal</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* CSCM - MSB */</span>
			<span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">csc</span><span class="p">.</span><span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">integer</span> <span class="o">&lt;&lt;</span>
				<span class="n">ISIF_CSC_COEF_INTEG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">csc</span><span class="p">.</span><span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">decimal</span><span class="p">;</span>
			<span class="n">val2</span> <span class="o">&lt;&lt;=</span> <span class="n">ISIF_CSCM_MSB_SHIFT</span><span class="p">;</span>
			<span class="n">val2</span> <span class="o">|=</span> <span class="n">val1</span><span class="p">;</span>
			<span class="n">regw</span><span class="p">(</span><span class="n">val2</span><span class="p">,</span> <span class="p">(</span><span class="n">CSCM0</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* program the active area */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">start_pix</span><span class="p">,</span> <span class="n">FMTSPH</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * one extra pixel as required for CSC. Actually number of</span>
<span class="cm">	 * pixel - 1 should be configured in this register. So we</span>
<span class="cm">	 * need to subtract 1 before writing to FMTSPH, but we will</span>
<span class="cm">	 * not do this since csc requires one extra pixel</span>
<span class="cm">	 */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">num_pixels</span><span class="p">,</span> <span class="n">FMTLNH</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">start_line</span><span class="p">,</span> <span class="n">FMTSLV</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * one extra line as required for CSC. See reason documented for</span>
<span class="cm">	 * num_pixels</span>
<span class="cm">	 */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">df_csc</span><span class="o">-&gt;</span><span class="n">num_lines</span><span class="p">,</span> <span class="n">FMTLNV</span><span class="p">);</span>

	<span class="cm">/* Enable CSC */</span>
	<span class="n">regw</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">CSCCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_config_raw</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isif_params_raw</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isif_config_params_raw</span> <span class="o">*</span><span class="n">module_params</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpss_pg_frame_size</span> <span class="n">frame_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpss_sync_pol</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Starting isif_config_raw..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure CCDCFG register:-</span>
<span class="cm">	 * Set CCD Not to swap input since input is RAW data</span>
<span class="cm">	 * Set FID detection function to Latch at V-Sync</span>
<span class="cm">	 * Set WENLOG - isif valid area</span>
<span class="cm">	 * Set TRGSEL</span>
<span class="cm">	 * Set EXTRG</span>
<span class="cm">	 * Packed to 8 or 16 bits</span>
<span class="cm">	 */</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ISIF_YCINSWP_RAW</span> <span class="o">|</span> <span class="n">ISIF_CCDCFG_FIDMD_LATCH_VSYNC</span> <span class="o">|</span>
		<span class="n">ISIF_CCDCFG_WENLOG_AND</span> <span class="o">|</span> <span class="n">ISIF_CCDCFG_TRGSEL_WEN</span> <span class="o">|</span>
		<span class="n">ISIF_CCDCFG_EXTRG_DISABLE</span> <span class="o">|</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing 0x%x to ...CCDCFG </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CCDCFG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure the vertical sync polarity(MODESET.VDPOL)</span>
<span class="cm">	 * Configure the horizontal sync polarity (MODESET.HDPOL)</span>
<span class="cm">	 * Configure frame id polarity (MODESET.FLDPOL)</span>
<span class="cm">	 * Configure data polarity</span>
<span class="cm">	 * Configure External WEN Selection</span>
<span class="cm">	 * Configure frame format(progressive or interlace)</span>
<span class="cm">	 * Configure pixel format (Input mode)</span>
<span class="cm">	 * Configure the data shift</span>
<span class="cm">	 */</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ISIF_VDHDOUT_INPUT</span> <span class="o">|</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vd_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VD_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hd_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_HD_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">fid_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_FID_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ISIF_DATAPOL_NORMAL</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_DATAPOL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ISIF_EXWEN_DISABLE</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_EXWEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_FRM_FMT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_INPUT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">data_shift</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_DATASFT_SHIFT</span><span class="p">);</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MODESET</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing 0x%x to MODESET...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure GAMMAWD register</span>
<span class="cm">	 * CFA pattern setting</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cfa_pat</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_GAMMAWD_CFA_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Gamma msb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">compress</span><span class="p">.</span><span class="n">alg</span> <span class="o">==</span> <span class="n">ISIF_ALAW</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ISIF_ALAW_ENABLE</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">data_msb</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_ALAW_GAMA_WD_SHIFT</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CGAMMAWD</span><span class="p">);</span>

	<span class="cm">/* Configure DPCM compression settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">compress</span><span class="p">.</span><span class="n">alg</span> <span class="o">==</span> <span class="n">ISIF_DPCM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span>  <span class="n">BIT</span><span class="p">(</span><span class="n">ISIF_DPCM_EN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">compress</span><span class="p">.</span><span class="n">pred</span> <span class="o">&lt;&lt;</span>
		       <span class="n">ISIF_DPCM_PREDICTOR_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MISC</span><span class="p">);</span>

	<span class="cm">/* Configure Gain &amp; Offset */</span>
	<span class="n">isif_config_gain_offset</span><span class="p">();</span>

	<span class="cm">/* Configure Color pattern */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field0</span><span class="p">.</span><span class="n">olop</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field0</span><span class="p">.</span><span class="n">olep</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field0</span><span class="p">.</span><span class="n">elop</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field0</span><span class="p">.</span><span class="n">elep</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field1</span><span class="p">.</span><span class="n">olop</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field1</span><span class="p">.</span><span class="n">olep</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field1</span><span class="p">.</span><span class="n">elop</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">col_pat_field1</span><span class="p">.</span><span class="n">elep</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CCOLP</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing %x to CCOLP ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Configure HSIZE register  */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="o">!!</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">horz_flip_en</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_HSIZE_FLIP_SHIFT</span><span class="p">;</span>

	<span class="cm">/* calculate line offset in 32 bytes based on pack value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span> <span class="o">==</span> <span class="n">ISIF_PACK_8BIT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span> <span class="o">==</span> <span class="n">ISIF_PACK_12BIT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">HSIZE</span><span class="p">);</span>

	<span class="cm">/* Configure SDOFST register  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span> <span class="o">==</span> <span class="n">CCDC_FRMFMT_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">image_invert_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For interlace inverse mode */</span>
			<span class="n">regw</span><span class="p">(</span><span class="mh">0x4B6D</span><span class="p">,</span> <span class="n">SDOFST</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing 0x4B6D to SDOFST...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* For interlace non inverse mode */</span>
			<span class="n">regw</span><span class="p">(</span><span class="mh">0x0B6D</span><span class="p">,</span> <span class="n">SDOFST</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing 0x0B6D to SDOFST...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span> <span class="o">==</span> <span class="n">CCDC_FRMFMT_PROGRESSIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">image_invert_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For progressive inverse mode */</span>
			<span class="n">regw</span><span class="p">(</span><span class="mh">0x4000</span><span class="p">,</span> <span class="n">SDOFST</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing 0x4000 to SDOFST...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* For progressive non inverse mode */</span>
			<span class="n">regw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">SDOFST</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing 0x0000 to SDOFST...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Configure video window */</span>
	<span class="n">isif_setwin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Configure Black Clamp */</span>
	<span class="n">isif_config_bclamp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">bclamp</span><span class="p">);</span>

	<span class="cm">/* Configure Vertical Defection Pixel Correction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_config_dfc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">dfc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">df_csc</span><span class="p">.</span><span class="n">df_or_csc</span><span class="p">)</span>
		<span class="cm">/* Configure Color Space Conversion */</span>
		<span class="n">isif_config_csc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">df_csc</span><span class="p">);</span>

	<span class="n">isif_config_linearization</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">linearize</span><span class="p">);</span>

	<span class="cm">/* Configure Culling */</span>
	<span class="n">isif_config_culling</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">culling</span><span class="p">);</span>

	<span class="cm">/* Configure horizontal and vertical offsets(DFC,LSC,Gain) */</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">horz_offset</span><span class="p">,</span> <span class="n">DATAHOFST</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">(</span><span class="n">module_params</span><span class="o">-&gt;</span><span class="n">vert_offset</span><span class="p">,</span> <span class="n">DATAVOFST</span><span class="p">);</span>

	<span class="cm">/* Setup test pattern if enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">config_params</span><span class="p">.</span><span class="n">test_pat_gen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use the HD/VD pol settings from user */</span>
		<span class="n">sync</span><span class="p">.</span><span class="n">ccdpg_hdpol</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">hd_pol</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">.</span><span class="n">ccdpg_vdpol</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">vd_pol</span><span class="p">;</span>
		<span class="n">dm365_vpss_set_sync_pol</span><span class="p">(</span><span class="n">sync</span><span class="p">);</span>
		<span class="n">frame_size</span><span class="p">.</span><span class="n">hlpfr</span> <span class="o">=</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">frame_size</span><span class="p">.</span><span class="n">pplen</span> <span class="o">=</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">dm365_vpss_set_pg_frame_size</span><span class="p">(</span><span class="n">frame_size</span><span class="p">);</span>
		<span class="n">vpss_select_ccdc_source</span><span class="p">(</span><span class="n">VPSS_PGLPBK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">End of isif_config_ycbcr...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_set_buftype</span><span class="p">(</span><span class="k">enum</span> <span class="n">ccdc_buftype</span> <span class="n">buf_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">buf_type</span> <span class="o">=</span> <span class="n">buf_type</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">buf_type</span> <span class="o">=</span> <span class="n">buf_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">ccdc_buftype</span> <span class="nf">isif_get_buftype</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">buf_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">buf_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_enum_pix</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">pix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isif_raw_bayer_pix_formats</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="n">isif_raw_bayer_pix_formats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isif_raw_yuv_pix_formats</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="n">isif_raw_yuv_pix_formats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_set_pixel_format</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_SBGGR8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">.</span><span class="n">compress</span><span class="p">.</span><span class="n">alg</span> <span class="o">!=</span>
			     <span class="n">ISIF_ALAW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">.</span><span class="n">compress</span><span class="p">.</span><span class="n">alg</span> <span class="o">!=</span>
			     <span class="n">ISIF_DPCM</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Either configure A-Law or DPCM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span> <span class="o">=</span> <span class="n">ISIF_PACK_8BIT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_SBGGR16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">.</span><span class="n">compress</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span>
					<span class="n">ISIF_NO_COMPRESSION</span><span class="p">;</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span> <span class="o">=</span> <span class="n">ISIF_PACK_16BIT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">CCDC_PIXFMT_RAW</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">pix_order</span> <span class="o">=</span> <span class="n">CCDC_PIXORDER_YCBYCR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">)</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">pix_order</span> <span class="o">=</span> <span class="n">CCDC_PIXORDER_CBYCRY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span> <span class="o">=</span> <span class="n">ISIF_PACK_8BIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">isif_get_pixel_format</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pixfmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">.</span><span class="n">compress</span><span class="p">.</span><span class="n">alg</span> <span class="o">==</span> <span class="n">ISIF_ALAW</span> <span class="o">||</span>
		    <span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">.</span><span class="n">compress</span><span class="p">.</span><span class="n">alg</span> <span class="o">==</span> <span class="n">ISIF_DPCM</span><span class="p">)</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_SBGGR8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_SBGGR16</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">pix_order</span> <span class="o">==</span> <span class="n">CCDC_PIXORDER_YCBYCR</span><span class="p">)</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pixfmt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_set_image_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_get_image_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span>
		<span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">isif_get_line_length</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span> <span class="o">==</span> <span class="n">ISIF_PACK_8BIT</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">data_pack</span> <span class="o">==</span> <span class="n">ISIF_PACK_12BIT</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(((</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				 <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)));</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(((</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(((</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="k">return</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_set_frame_format</span><span class="p">(</span><span class="k">enum</span> <span class="n">ccdc_frmfmt</span> <span class="n">frm_fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">frm_fmt</span> <span class="o">=</span> <span class="n">frm_fmt</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">frm_fmt</span> <span class="o">=</span> <span class="n">frm_fmt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">ccdc_frmfmt</span> <span class="nf">isif_get_frame_format</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">frm_fmt</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">frm_fmt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_getfid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">regr</span><span class="p">(</span><span class="n">MODESET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* misc operations */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isif_setfbaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regw</span><span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">,</span> <span class="n">CADU</span><span class="p">);</span>
	<span class="n">regw</span><span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0ffff</span><span class="p">,</span> <span class="n">CADL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_set_hw_if_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">vpfe_hw_if_param</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">if_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">if_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VPFE_BT656</span>:
	<span class="k">case</span> <span class="n">VPFE_BT656_10BIT</span>:
	<span class="k">case</span> <span class="n">VPFE_YCBCR_SYNC_8</span>:
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">CCDC_PIXFMT_YCBCR_8BIT</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">pix_order</span> <span class="o">=</span> <span class="n">CCDC_PIXORDER_CBYCRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VPFE_BT1120</span>:
	<span class="k">case</span> <span class="n">VPFE_YCBCR_SYNC_16</span>:
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">CCDC_PIXFMT_YCBCR_16BIT</span><span class="p">;</span>
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">.</span><span class="n">pix_order</span> <span class="o">=</span> <span class="n">CCDC_PIXORDER_CBYCRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VPFE_RAW_BAYER</span>:
		<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">CCDC_PIXFMT_RAW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid interface type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function will configure ISIF for YCbCr parameters. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_config_ycbcr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isif_ycbcr_config</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">ycbcr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpss_pg_frame_size</span> <span class="n">frame_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">modeset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ccdcfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vpss_sync_pol</span> <span class="n">sync</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Starting isif_config_ycbcr...&quot;</span><span class="p">);</span>

	<span class="cm">/* configure pixel format or input mode */</span>
	<span class="n">modeset</span> <span class="o">=</span> <span class="n">modeset</span> <span class="o">|</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_INPUT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_FRM_FMT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">fid_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_FID_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hd_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_HD_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vd_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VD_POL_SHIFT</span><span class="p">);</span>

	<span class="cm">/* pack the data to 8-bit ISIFCFG */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VPFE_BT656</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">!=</span> <span class="n">CCDC_PIXFMT_YCBCR_8BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid pix_fmt(input mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">modeset</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VPFE_PINPOL_NEGATIVE</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_VD_POL_SHIFT</span><span class="p">);</span>
		<span class="n">regw</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">REC656IF</span><span class="p">);</span>
		<span class="n">ccdcfg</span> <span class="o">=</span> <span class="n">ccdcfg</span> <span class="o">|</span> <span class="n">ISIF_DATA_PACK8</span> <span class="o">|</span> <span class="n">ISIF_YCINSWP_YCBCR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VPFE_BT656_10BIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">!=</span> <span class="n">CCDC_PIXFMT_YCBCR_8BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid pix_fmt(input mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* setup BT.656, embedded sync  */</span>
		<span class="n">regw</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">REC656IF</span><span class="p">);</span>
		<span class="cm">/* enable 10 bit mode in ccdcfg */</span>
		<span class="n">ccdcfg</span> <span class="o">=</span> <span class="n">ccdcfg</span> <span class="o">|</span> <span class="n">ISIF_DATA_PACK8</span> <span class="o">|</span> <span class="n">ISIF_YCINSWP_YCBCR</span> <span class="o">|</span>
			<span class="n">ISIF_BW656_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VPFE_BT1120</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">!=</span> <span class="n">CCDC_PIXFMT_YCBCR_16BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid pix_fmt(input mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">regw</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">REC656IF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VPFE_YCBCR_SYNC_8</span>:
		<span class="n">ccdcfg</span> <span class="o">|=</span> <span class="n">ISIF_DATA_PACK8</span><span class="p">;</span>
		<span class="n">ccdcfg</span> <span class="o">|=</span> <span class="n">ISIF_YCINSWP_YCBCR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">!=</span> <span class="n">CCDC_PIXFMT_YCBCR_8BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid pix_fmt(input mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VPFE_YCBCR_SYNC_16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">!=</span> <span class="n">CCDC_PIXFMT_YCBCR_16BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid pix_fmt(input mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* should never come here */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid interface type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">modeset</span><span class="p">,</span> <span class="n">MODESET</span><span class="p">);</span>

	<span class="cm">/* Set up pix order */</span>
	<span class="n">ccdcfg</span> <span class="o">|=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">pix_order</span> <span class="o">&lt;&lt;</span> <span class="n">ISIF_PIX_ORDER_SHIFT</span><span class="p">;</span>

	<span class="n">regw</span><span class="p">(</span><span class="n">ccdcfg</span><span class="p">,</span> <span class="n">CCDCFG</span><span class="p">);</span>

	<span class="cm">/* configure video window */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_BT1120</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_YCBCR_SYNC_16</span><span class="p">))</span>
		<span class="n">isif_setwin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">isif_setwin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * configure the horizontal line offset</span>
<span class="cm">	 * this is done by rounding up width to a multiple of 16 pixels</span>
<span class="cm">	 * and multiply by two to account for y:cb:cr 4:2:2 data</span>
<span class="cm">	 */</span>
	<span class="n">regw</span><span class="p">(((((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">),</span> <span class="n">HSIZE</span><span class="p">);</span>

	<span class="cm">/* configure the memory line offset */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">frm_fmt</span> <span class="o">==</span> <span class="n">CCDC_FRMFMT_INTERLACED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">buf_type</span> <span class="o">==</span> <span class="n">CCDC_BUFTYPE_FLD_INTERLEAVED</span><span class="p">))</span>
		<span class="cm">/* two fields are interleaved in memory */</span>
		<span class="n">regw</span><span class="p">(</span><span class="mh">0x00000249</span><span class="p">,</span> <span class="n">SDOFST</span><span class="p">);</span>

	<span class="cm">/* Setup test pattern if enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span><span class="p">.</span><span class="n">test_pat_gen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sync</span><span class="p">.</span><span class="n">ccdpg_hdpol</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">hd_pol</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">.</span><span class="n">ccdpg_vdpol</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">vd_pol</span><span class="p">;</span>
		<span class="n">dm365_vpss_set_sync_pol</span><span class="p">(</span><span class="n">sync</span><span class="p">);</span>
		<span class="n">dm365_vpss_set_pg_frame_size</span><span class="p">(</span><span class="n">frame_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_configure</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">VPFE_RAW_BAYER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">isif_config_raw</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">isif_config_ycbcr</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* copy defaults to module params */</span>
	<span class="n">isif_cfg</span><span class="p">.</span><span class="n">bayer</span><span class="p">.</span><span class="n">config_params</span> <span class="o">=</span> <span class="n">isif_config_defaults</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccdc_hw_device</span> <span class="n">isif_hw_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ISIF&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">isif_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">isif_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">isif_enable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enable_out_to_sdram</span> <span class="o">=</span> <span class="n">isif_enable_output_to_sdram</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_hw_if_params</span> <span class="o">=</span> <span class="n">isif_set_hw_if_params</span><span class="p">,</span>
		<span class="p">.</span><span class="n">configure</span> <span class="o">=</span> <span class="n">isif_configure</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_buftype</span> <span class="o">=</span> <span class="n">isif_set_buftype</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_buftype</span> <span class="o">=</span> <span class="n">isif_get_buftype</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enum_pix</span> <span class="o">=</span> <span class="n">isif_enum_pix</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_pixel_format</span> <span class="o">=</span> <span class="n">isif_set_pixel_format</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_pixel_format</span> <span class="o">=</span> <span class="n">isif_get_pixel_format</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_frame_format</span> <span class="o">=</span> <span class="n">isif_set_frame_format</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_frame_format</span> <span class="o">=</span> <span class="n">isif_get_frame_format</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_image_window</span> <span class="o">=</span> <span class="n">isif_set_image_window</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_image_window</span> <span class="o">=</span> <span class="n">isif_get_image_window</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_line_length</span> <span class="o">=</span> <span class="n">isif_get_line_length</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setfbaddr</span> <span class="o">=</span> <span class="n">isif_setfbaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">getfid</span> <span class="o">=</span> <span class="n">isif_getfid</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">isif_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">setup_pinmux</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">__iomem</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * first try to register with vpfe. If not correct platform, then we</span>
<span class="cm">	 * don&#39;t have to iomap</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vpfe_register_ccdc_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isif_hw_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Get and enable Master clock */</span>
	<span class="n">isif_cfg</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;master&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">mclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">mclk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_mclk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_enable</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">mclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_mclk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Platform data holds setup_pinmux function ptr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_mclk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">setup_pinmux</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * setup Mux configuration for ccdc which may be different for</span>
<span class="cm">	 * different SoCs using this CCDC</span>
<span class="cm">	 */</span>
	<span class="n">setup_pinmux</span><span class="p">();</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Get the ISIF base address, linearization table0 and table1 addr. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_nobase_res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
					 <span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_nobase_res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_base_iomap</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* ISIF base address */</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* ISIF linear tbl0 address */</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl0_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* ISIF linear tbl0 address */</span>
			<span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl1_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isif_cfg</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s is registered with vpfe.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">isif_hw_dev</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_base_iomap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="n">i</span><span class="o">--</span><span class="p">;</span>
<span class="nl">fail_nobase_res:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">base_addr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl0_addr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl0_addr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">fail_mclk:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">mclk</span><span class="p">);</span>
	<span class="n">vpfe_unregister_ccdc_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isif_hw_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isif_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl0_addr</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">isif_cfg</span><span class="p">.</span><span class="n">linear_tbl1_addr</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vpfe_unregister_ccdc_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isif_hw_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">isif_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;isif&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">isif_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">isif_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">isif_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
