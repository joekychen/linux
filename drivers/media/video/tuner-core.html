<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › tuner-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tuner-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * i2c tv tuner chip device driver</span>
<span class="cm"> * core core, i.e. kernel interfaces, registering and so on</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) by Ralph Metzler, Gerd Knorr, Gunther Mayer</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2005-2011 by Mauro Carvalho Chehab</span>
<span class="cm"> *	- Added support for a separate Radio tuner</span>
<span class="cm"> *	- Major rework and cleanups at the code</span>
<span class="cm"> *</span>
<span class="cm"> * This driver supports many devices and the idea is to let the driver</span>
<span class="cm"> * detect which device is present. So rather than listing all supported</span>
<span class="cm"> * devices here, we pretend to support a single, fake device type that will</span>
<span class="cm"> * handle both radio and analog TV tuning.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &lt;media/tuner-types.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &quot;mt20xx.h&quot;</span>
<span class="cp">#include &quot;tda8290.h&quot;</span>
<span class="cp">#include &quot;tea5761.h&quot;</span>
<span class="cp">#include &quot;tea5767.h&quot;</span>
<span class="cp">#include &quot;tuner-xc2028.h&quot;</span>
<span class="cp">#include &quot;tuner-simple.h&quot;</span>
<span class="cp">#include &quot;tda9887.h&quot;</span>
<span class="cp">#include &quot;xc5000.h&quot;</span>
<span class="cp">#include &quot;tda18271.h&quot;</span>
<span class="cp">#include &quot;xc4000.h&quot;</span>

<span class="cp">#define UNSET (-1U)</span>

<span class="cp">#define PREFIX (t-&gt;i2c-&gt;driver-&gt;driver.name)</span>

<span class="cm">/*</span>
<span class="cm"> * Driver modprobe parameters</span>
<span class="cm"> */</span>

<span class="cm">/* insmod options used at init time =&gt; read/only */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">no_autodetect</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">show_i2c</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_autodetect</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">show_i2c</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/* insmod options used at runtime =&gt; read/write */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tuner_debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">958</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">108</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">pal</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;--&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">secam</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;--&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ntsc</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">tuner_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">tv_range</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">radio_range</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">pal</span><span class="p">,</span> <span class="n">pal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pal</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">secam</span><span class="p">,</span> <span class="n">secam</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">secam</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">ntsc</span><span class="p">,</span> <span class="n">ntsc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ntsc</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Static vars</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tuner_list</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">tuner_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Debug macros</span>
<span class="cm"> */</span>

<span class="cp">#define tuner_warn(fmt, arg...) do {			\</span>
<span class="cp">	printk(KERN_WARNING &quot;%s %d-%04x: &quot; fmt, PREFIX, \</span>
<span class="cp">	       i2c_adapter_id(t-&gt;i2c-&gt;adapter),		\</span>
<span class="cp">	       t-&gt;i2c-&gt;addr, ##arg);			\</span>
<span class="cp">	 } while (0)</span>

<span class="cp">#define tuner_info(fmt, arg...) do {			\</span>
<span class="cp">	printk(KERN_INFO &quot;%s %d-%04x: &quot; fmt, PREFIX,	\</span>
<span class="cp">	       i2c_adapter_id(t-&gt;i2c-&gt;adapter),		\</span>
<span class="cp">	       t-&gt;i2c-&gt;addr, ##arg);			\</span>
<span class="cp">	 } while (0)</span>

<span class="cp">#define tuner_err(fmt, arg...) do {			\</span>
<span class="cp">	printk(KERN_ERR &quot;%s %d-%04x: &quot; fmt, PREFIX,	\</span>
<span class="cp">	       i2c_adapter_id(t-&gt;i2c-&gt;adapter),		\</span>
<span class="cp">	       t-&gt;i2c-&gt;addr, ##arg);			\</span>
<span class="cp">	 } while (0)</span>

<span class="cp">#define tuner_dbg(fmt, arg...) do {				\</span>
<span class="cp">	if (tuner_debug)					\</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s %d-%04x: &quot; fmt, PREFIX,	\</span>
<span class="cp">		       i2c_adapter_id(t-&gt;i2c-&gt;adapter),		\</span>
<span class="cp">		       t-&gt;i2c-&gt;addr, ##arg);			\</span>
<span class="cp">	 } while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * Internal struct used inside the driver</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">tuner</span> <span class="p">{</span>
	<span class="cm">/* device */</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">fe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>   <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span>  <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>    <span class="n">list</span><span class="p">;</span>

	<span class="cm">/* keep track of the current settings */</span>
	<span class="n">v4l2_std_id</span>         <span class="n">std</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">tv_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">radio_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">audmode</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">v4l2_tuner_type</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">mode_mask</span><span class="p">;</span> <span class="cm">/* Combination of allowable modes */</span>

	<span class="n">bool</span>                <span class="n">standby</span><span class="p">;</span>	<span class="cm">/* Standby mode */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">type</span><span class="p">;</span> <span class="cm">/* chip type id */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function prototypes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">set_tv_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_radio_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tuner attach/detach logic</span>
<span class="cm"> */</span>

<span class="cm">/* This macro allows us to probe dynamically, avoiding static links */</span>
<span class="cp">#ifdef CONFIG_MEDIA_ATTACH</span>
<span class="cp">#define tuner_symbol_probe(FUNCTION, ARGS...) ({ \</span>
<span class="cp">	int __r = -EINVAL; \</span>
<span class="cp">	typeof(&amp;FUNCTION) __a = symbol_request(FUNCTION); \</span>
<span class="cp">	if (__a) { \</span>
<span class="cp">		__r = (int) __a(ARGS); \</span>
<span class="cp">		symbol_put(FUNCTION); \</span>
<span class="cp">	} else { \</span>
<span class="cp">		printk(KERN_ERR &quot;TUNER: Unable to find &quot; \</span>
<span class="cp">				&quot;symbol &quot;#FUNCTION&quot;()\n&quot;); \</span>
<span class="cp">	} \</span>
<span class="cp">	__r; \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tuner_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">symbol_put_addr</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">symbol_put_addr</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define tuner_symbol_probe(FUNCTION, ARGS...) ({ \</span>
<span class="cp">	FUNCTION(ARGS); \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tuner_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="nf">to_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * struct analog_demod_ops callbacks</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fe_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">analog_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">fe_tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">set_analog_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;Tuner frontend module has no way to set freq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">set_analog_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fe_standby</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">fe_tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">)</span>
		<span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fe_has_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">strength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">get_rf_strength</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">get_rf_strength</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">strength</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">strength</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fe_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">fe_tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">priv_cfg</span><span class="p">);</span>

	<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;Tuner frontend module has no way to set config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tuner_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="n">tuner_analog_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_params</span>     <span class="o">=</span> <span class="n">fe_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">standby</span>        <span class="o">=</span> <span class="n">fe_standby</span><span class="p">,</span>
	<span class="p">.</span><span class="n">has_signal</span>     <span class="o">=</span> <span class="n">fe_has_signal</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_config</span>     <span class="o">=</span> <span class="n">fe_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_status</span>   <span class="o">=</span> <span class="n">tuner_status</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Functions to select between radio and TV and tuner probe/remove functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * set_type - Sets the tuner type for a given device</span>
<span class="cm"> *</span>
<span class="cm"> * @c:			i2c_client descriptoy</span>
<span class="cm"> * @type:		type of the tuner (e. g. tuner number)</span>
<span class="cm"> * @new_mode_mask:	Indicates if tuner supports TV and/or Radio</span>
<span class="cm"> * @new_config:		an optional parameter ranging from 0-255 used by</span>
<span class="cm">			a few tuners to adjust an internal parameter,</span>
<span class="cm">			like LNA mode</span>
<span class="cm"> * @tuner_callback:	an optional function to be called when switching</span>
<span class="cm"> *			to analog mode</span>
<span class="cm"> *</span>
<span class="cm"> * This function applys the tuner config to tuner specified</span>
<span class="cm"> * by tun_setup structure. It contains several per-tuner initialization &quot;magic&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_mode_mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_config</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">tuner_callback</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">component</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">fe_tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tune_now</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">UNSET</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">TUNER_ABSENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;tuner 0x%02x: Tuner type absent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="cm">/* prevent invalid config values */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">new_config</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">?</span> <span class="n">new_config</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;defining GPIO callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">tuner_callback</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* discard private data, in case set_type() was previously called */</span>
	<span class="n">tuner_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">analog_demod_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_MT2032</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">microtune_attach</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_TDA8290</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">tda829x_config</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">lna_cfg</span>        <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda829x_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TUNER_TEA5767</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tea5767_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">T_RADIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_TEA5761</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tea5761_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">T_RADIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FMD1216ME_MK3</span>:
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_FMD1216MEX_MK3</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdc</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9c</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x54</span><span class="p">;</span>
		<span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_PHILIPS_TD1316</span>:
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdc</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa4</span><span class="p">;</span>
		<span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_XC2028</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">xc2028_config</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2c_adap</span>  <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
			<span class="p">.</span><span class="n">i2c_addr</span>  <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">xc2028_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="n">tune_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TUNER_TDA9887</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda9887_attach</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_XC5000</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">xc5000_config</span> <span class="n">xc5000_cfg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="cm">/* if_khz will be set at dvb_attach() */</span>
			<span class="p">.</span><span class="n">if_khz</span>	  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">xc5000_attach</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xc5000_cfg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="n">tune_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TUNER_XC5000C</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">xc5000_config</span> <span class="n">xc5000c_cfg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="cm">/* if_khz will be set at dvb_attach() */</span>
			<span class="p">.</span><span class="n">if_khz</span>	  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">chip_id</span>  <span class="o">=</span> <span class="n">XC5000C</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">xc5000_attach</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xc5000c_cfg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="n">tune_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TUNER_NXP_TDA18271</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">tda18271_config</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
			<span class="p">.</span><span class="n">small_i2c</span> <span class="o">=</span> <span class="n">TDA18271_03_BYTE_CHUNK_INIT</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18271_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="n">tune_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TUNER_XC4000</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">xc4000_config</span> <span class="n">xc4000_cfg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2c_address</span>	  <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="cm">/* FIXME: the correct parameters will be set */</span>
			<span class="cm">/* only when the digital dvb_attach() occurs */</span>
			<span class="p">.</span><span class="n">default_pm</span>	  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">dvb_amplitude</span>	  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_smoothedcvbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">if_khz</span>		  <span class="o">=</span> <span class="mi">0</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">xc4000_attach</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xc4000_cfg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>
		<span class="n">tune_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">attach_failed</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">set_params</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">set_analog_params</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">analog_demod_priv</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">analog_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_analog_ops</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">analog_demod_ops</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;type set to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">new_mode_mask</span><span class="p">;</span>

	<span class="cm">/* Some tuners require more initialization setup before use,</span>
<span class="cm">	   such as firmware download or device calibration.</span>
<span class="cm">	   trying to set a frequency here will just fail</span>
<span class="cm">	   FIXME: better to move set_freq to the tuner code. This is needed</span>
<span class="cm">	   on analog tuners for PLL to properly work</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tune_now</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_TUNER_RADIO</span> <span class="o">==</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
			<span class="n">set_radio_freq</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">radio_freq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_tv_freq</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_freq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;%s %s I2C addr 0x%02x with type %d used for 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
		  <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">attach_failed:</span>
	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Tuner attach for type = %d failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TUNER_ABSENT</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_s_type_addr - Sets the tuner type for a device</span>
<span class="cm"> *</span>
<span class="cm"> * @sd:		subdev descriptor</span>
<span class="cm"> * @tun_setup:	type to be associated to a given tuner i2c address</span>
<span class="cm"> *</span>
<span class="cm"> * This function applys the tuner config to tuner specified</span>
<span class="cm"> * by tun_setup structure.</span>
<span class="cm"> * If tuner I2C address is UNSET, then it will only set the device</span>
<span class="cm"> * if the tuner supports the mode specified in the call.</span>
<span class="cm"> * If the address is specified, the change will be applied only if</span>
<span class="cm"> * tuner I2C address matches.</span>
<span class="cm"> * The call can change the tuner number and the tuner mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_s_type_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tuner_setup</span> <span class="o">*</span><span class="n">tun_setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Calling set_type_addr for type=%d, addr=0x%02x, mode=0x%02x, config=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			<span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">,</span>
			<span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">UNSET</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="n">ADDR_UNSET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">&amp;</span> <span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_type</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">,</span>
			 <span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">tuner_callback</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;set addr discarded for type %i, mask %x. &quot;</span>
			  <span class="s">&quot;Asked to change tuner at addr 0x%02x, with mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">,</span>
			  <span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tun_setup</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_s_config - Sets tuner configuration</span>
<span class="cm"> *</span>
<span class="cm"> * @sd:		subdev descriptor</span>
<span class="cm"> * @cfg:	tuner configuration</span>
<span class="cm"> *</span>
<span class="cm"> * Calls tuner set_config() private function to set some tuner-internal</span>
<span class="cm"> * parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_s_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_priv_tun_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">tuner</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Tuner frontend module has no way to set config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_lookup - Seek for tuner adapters</span>
<span class="cm"> *</span>
<span class="cm"> * @adap:	i2c_adapter struct</span>
<span class="cm"> * @radio:	pointer to be filled if the adapter is radio</span>
<span class="cm"> * @tv:		pointer to be filled if the adapter is TV</span>
<span class="cm"> *</span>
<span class="cm"> * Search for existing radio and/or TV tuners on the given I2C adapter,</span>
<span class="cm"> * discarding demod-only adapters (tda9887).</span>
<span class="cm"> *</span>
<span class="cm"> * Note that when this function is called from tuner_probe you can be</span>
<span class="cm"> * certain no other devices will be added/deleted at the same time, I2C</span>
<span class="cm"> * core protects against that.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tuner_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">tuner</span> <span class="o">**</span><span class="n">radio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tuner</span> <span class="o">**</span><span class="n">tv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mode_mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">!=</span> <span class="n">adap</span> <span class="o">||</span>
		    <span class="n">strcmp</span><span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tuner&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mode_mask</span> <span class="o">=</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">radio</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">mode_mask</span> <span class="o">==</span> <span class="n">T_RADIO</span><span class="p">)</span>
			<span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="cm">/* Note: currently TDA9887 is the only demod-only</span>
<span class="cm">		   device. If other devices appear then we need to</span>
<span class="cm">		   make this test more general. */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tv</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TUNER_TDA9887</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">&amp;</span> <span class="n">T_ANALOG_TV</span><span class="p">))</span>
			<span class="o">*</span><span class="n">tv</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *tuner_probe - Probes the existing tuners on an I2C bus</span>
<span class="cm"> *</span>
<span class="cm"> * @client:	i2c_client descriptor</span>
<span class="cm"> * @id:		not used</span>
<span class="cm"> *</span>
<span class="cm"> * This routine probes for tuners at the expected I2C addresses. On most</span>
<span class="cm"> * cases, if a device answers to a given I2C address, it assumes that the</span>
<span class="cm"> * device is a tuner. On a few cases, however, an additional logic is needed</span>
<span class="cm"> * to double check if the device is really a tuner, or to identify the tuner</span>
<span class="cm"> * type, like on tea5767/5761 devices.</span>
<span class="cm"> *</span>
<span class="cm"> * During client attach, set_type is called by adapter&#39;s attach_inform callback.</span>
<span class="cm"> * set_type must then be completed by tuner_probe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">radio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">tv</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tuner</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_ops</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;(tuner unset)&quot;</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">radio_freq</span> <span class="o">=</span> <span class="mf">87.5</span> <span class="o">*</span> <span class="mi">16000</span><span class="p">;</span>	<span class="cm">/* Initial freq range */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_freq</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* Sets freq to VHF High - needed for some PLL&#39;s to properly start */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">show_i2c</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;I2C RECV = &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* autodetection code based on the i2c addr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_autodetect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tuner_symbol_probe</span><span class="p">(</span><span class="n">tea5761_autodetection</span><span class="p">,</span>
					       <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
					       <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TUNER_TEA5761</span><span class="p">;</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">T_RADIO</span><span class="p">;</span>
				<span class="n">tuner_lookup</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">)</span>
					<span class="n">tv</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">T_RADIO</span><span class="p">;</span>

				<span class="k">goto</span> <span class="n">register_client</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x42</span>:
		<span class="k">case</span> <span class="mh">0x43</span>:
		<span class="k">case</span> <span class="mh">0x4a</span>:
		<span class="k">case</span> <span class="mh">0x4b</span>:
			<span class="cm">/* If chip is not tda8290, don&#39;t register.</span>
<span class="cm">			   since it can be tda9887*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tuner_symbol_probe</span><span class="p">(</span><span class="n">tda829x_probe</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
					       <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;tda829x detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Default is being tda9887 */</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TUNER_TDA9887</span><span class="p">;</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">T_RADIO</span> <span class="o">|</span> <span class="n">T_ANALOG_TV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">register_client</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x60</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tuner_symbol_probe</span><span class="p">(</span><span class="n">tea5767_autodetection</span><span class="p">,</span>
					       <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
					<span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TUNER_TEA5767</span><span class="p">;</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">T_RADIO</span><span class="p">;</span>
				<span class="cm">/* Sets freq to FM range */</span>
				<span class="n">tuner_lookup</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">)</span>
					<span class="n">tv</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">T_RADIO</span><span class="p">;</span>

				<span class="k">goto</span> <span class="n">register_client</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Initializes only the first TV tuner on this adapter. Why only the</span>
<span class="cm">	   first? Because there are some devices (notably the ones with TI</span>
<span class="cm">	   tuners) that have more than one i2c address for the *same* device.</span>
<span class="cm">	   Experience shows that, except for just one case, the first</span>
<span class="cm">	   address is the right one. The exception is a Russian tuner</span>
<span class="cm">	   (ACORP_Y878F). So, the desired behavior is just to enable the</span>
<span class="cm">	   first found TV tuner. */</span>
	<span class="n">tuner_lookup</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">T_ANALOG_TV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">|=</span> <span class="n">T_RADIO</span><span class="p">;</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Setting mode_mask to 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Should be just before return */</span>
<span class="nl">register_client:</span>
	<span class="cm">/* Sets a default mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">&amp;</span> <span class="n">T_ANALOG_TV</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="n">set_type</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">callback</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_list</span><span class="p">);</span>

	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Tuner %d found with type(s)%s%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">&amp;</span> <span class="n">T_RADIO</span> <span class="o">?</span> <span class="s">&quot; Radio&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span> <span class="o">&amp;</span> <span class="n">T_ANALOG_TV</span> <span class="o">?</span> <span class="s">&quot; TV&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_remove - detaches a tuner</span>
<span class="cm"> *</span>
<span class="cm"> * @client:	i2c_client descriptor</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">tuner_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">analog_demod_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions to switch between Radio and TV</span>
<span class="cm"> *</span>
<span class="cm"> * A few cards have a separate I2C tuner for radio. Those routines</span>
<span class="cm"> * take care of switching between TV/Radio mode, filtering only the</span>
<span class="cm"> * commands that apply to the Radio or TV tuner.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * check_mode - Verify if tuner supports the requested mode</span>
<span class="cm"> * @t: a pointer to the module&#39;s internal struct_tuner</span>
<span class="cm"> *</span>
<span class="cm"> * This function checks if the tuner is capable of tuning analog TV,</span>
<span class="cm"> * digital TV or radio, depending on what the caller wants. If the</span>
<span class="cm"> * tuner can&#39;t support that mode, it returns -EINVAL. Otherwise, it</span>
<span class="cm"> * returns 0.</span>
<span class="cm"> * This function is needed for boards that have a separate tuner for</span>
<span class="cm"> * radio (like devices with tea5767).</span>
<span class="cm"> * NOTE: mt20xx uses V4L2_TUNER_DIGITAL_TV and calls set_tv_freq to</span>
<span class="cm"> *       select a TV frequency. So, t_mode = T_ANALOG_TV could actually</span>
<span class="cm"> *	 be used to represent a Digital TV too.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">check_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_tuner_type</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span>
		<span class="n">t_mode</span> <span class="o">=</span> <span class="n">T_RADIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">t_mode</span> <span class="o">=</span> <span class="n">T_ANALOG_TV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">t_mode</span> <span class="o">&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * set_mode - Switch tuner to other mode.</span>
<span class="cm"> * @t:		a pointer to the module&#39;s internal struct_tuner</span>
<span class="cm"> * @mode:	enum v4l2_type (radio or TV)</span>
<span class="cm"> *</span>
<span class="cm"> * If tuner doesn&#39;t support the needed mode (radio or TV), prints a</span>
<span class="cm"> * debug message and returns -EINVAL, changing its state to standby.</span>
<span class="cm"> * Otherwise, changes the mode and returns 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_tuner_type</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Tuner doesn&#39;t support mode %d. &quot;</span>
				  <span class="s">&quot;Putting tuner to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">)</span>
				<span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Changing to mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * set_freq - Set the tuner to the desired frequency.</span>
<span class="cm"> * @t:		a pointer to the module&#39;s internal struct_tuner</span>
<span class="cm"> * @freq:	frequency to set (0 means to use the current frequency)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">radio_freq</span><span class="p">;</span>
		<span class="n">set_radio_freq</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_freq</span><span class="p">;</span>
		<span class="n">set_tv_freq</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions that are specific for TV mode</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * set_tv_freq - Set tuner frequency,  freq in Units of 62.5 kHz = 1/16MHz</span>
<span class="cm"> *</span>
<span class="cm"> * @c:	i2c_client descriptor</span>
<span class="cm"> * @freq: frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_tv_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">analog_parameters</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mode</span>      <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">audmode</span>   <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>       <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">UNSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;tuner type not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;Tuner has no way to set tv freq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;TV freq (%d.%02d) out of range (%d-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">freq</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">freq</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">tv_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="cm">/* V4L2 spec: if the freq is not possible then the closest</span>
<span class="cm">		   possible value should be selected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">params</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;tv freq set to %d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">freq</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">freq</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">set_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_fixup_std - force a given video standard variant</span>
<span class="cm"> *</span>
<span class="cm"> * @t: tuner internal struct</span>
<span class="cm"> * @std:	TV standard</span>
<span class="cm"> *</span>
<span class="cm"> * A few devices or drivers have problem to detect some standard variations.</span>
<span class="cm"> * On other operational systems, the drivers generally have a per-country</span>
<span class="cm"> * code, and some logic to apply per-country hacks. V4L2 API doesn&#39;t provide</span>
<span class="cm"> * such hacks. Instead, it relies on a proper video standard selection from</span>
<span class="cm"> * the userspace application. However, as some apps are buggy, not allowing</span>
<span class="cm"> * to distinguish all video standard variations, a modprobe parameter can</span>
<span class="cm"> * be used to force a video standard match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">v4l2_std_id</span> <span class="nf">tuner_fixup_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;6&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;B&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;I&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;N&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span> <span class="o">||</span> <span class="n">pal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">V4L2_STD_PAL_N</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;pal= argument not recognised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="o">==</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">secam</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;B&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;H&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_SECAM_B</span> <span class="o">|</span>
			       <span class="n">V4L2_STD_SECAM_G</span> <span class="o">|</span>
			       <span class="n">V4L2_STD_SECAM_H</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_SECAM_DK</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">secam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">secam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;secam= argument not recognised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntsc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ntsc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;j&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;J&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
			<span class="k">return</span> <span class="n">V4L2_STD_NTSC_M_KR</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;ntsc= argument not recognised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">std</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions that are specific for Radio mode</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * set_radio_freq - Set tuner frequency,  freq in Units of 62.5 Hz  = 1/16kHz</span>
<span class="cm"> *</span>
<span class="cm"> * @c:	i2c_client descriptor</span>
<span class="cm"> * @freq: frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_radio_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">analog_parameters</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mode</span>      <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">audmode</span>   <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>       <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">UNSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;tuner type not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_warn</span><span class="p">(</span><span class="s">&quot;tuner has no way to set radio frequency</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16000</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;radio freq (%d.%02d) out of range (%d-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">freq</span> <span class="o">/</span> <span class="mi">16000</span><span class="p">,</span> <span class="n">freq</span> <span class="o">%</span> <span class="mi">16000</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16000</span><span class="p">,</span>
			   <span class="n">radio_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="cm">/* V4L2 spec: if the freq is not possible then the closest</span>
<span class="cm">		   possible value should be selected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16000</span><span class="p">)</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">params</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;radio freq set to %d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">freq</span> <span class="o">/</span> <span class="mi">16000</span><span class="p">,</span> <span class="n">freq</span> <span class="o">%</span> <span class="mi">16000</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16000</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">radio_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">set_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Debug function for reporting tuner status to userspace</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_status - Dumps the current tuner status at dmesg</span>
<span class="cm"> * @fe: pointer to struct dvb_frontend</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is used only for driver debug purposes, answering to</span>
<span class="cm"> * VIDIOC_LOG_STATUS. No changes should happen on this call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tuner_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">analog_demod_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">,</span> <span class="n">freq_fraction</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">fe_tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_RADIO</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;radio&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_DIGITAL_TV</span>: <span class="cm">/* Used by mt20xx */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;digital TV&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_ANALOG_TV</span>:
	<span class="nl">default:</span>
		<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;analog TV&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">radio_freq</span> <span class="o">/</span> <span class="mi">16000</span><span class="p">;</span>
		<span class="n">freq_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">radio_freq</span> <span class="o">%</span> <span class="mi">16000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_freq</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">freq_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_freq</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Tuner mode:      %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">?</span> <span class="s">&quot; on standby mode&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Frequency:       %lu.%02lu MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">freq_fraction</span><span class="p">);</span>
	<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Standard:        0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tuner_status</span><span class="p">;</span>

		<span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tuner_status</span> <span class="o">&amp;</span> <span class="n">TUNER_STATUS_LOCKED</span><span class="p">)</span>
			<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Tuner is locked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tuner_status</span> <span class="o">&amp;</span> <span class="n">TUNER_STATUS_STEREO</span><span class="p">)</span>
			<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Stereo:          yes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">has_signal</span><span class="p">)</span>
		<span class="n">tuner_info</span><span class="p">(</span><span class="s">&quot;Signal strength: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">has_signal</span><span class="p">(</span><span class="n">fe</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function to splicitly change mode to radio. Probably not needed anymore</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_s_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tuner callbacks to handle userspace ioctl&#39;s</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_s_power - controls the power state of the tuner</span>
<span class="cm"> * @sd: pointer to struct v4l2_subdev</span>
<span class="cm"> * @on: a zero value puts the tuner to sleep, non-zero wakes it up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_s_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">&amp;&amp;</span> <span class="n">set_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Waking up tuner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Putting tuner to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">)</span>
		<span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">tuner_fixup_std</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">!=</span> <span class="n">std</span><span class="p">)</span>
		<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;Fixup standard %llx to %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
	<span class="n">set_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_g_frequency - Get the tuned frequency for the tuner</span>
<span class="cm"> * @sd: pointer to struct v4l2_subdev</span>
<span class="cm"> * @f: pointer to struct v4l2_frequency</span>
<span class="cm"> *</span>
<span class="cm"> * At return, the structure f will be filled with tuner frequency</span>
<span class="cm"> * if the tuner matches the f-&gt;type.</span>
<span class="cm"> * Note: f-&gt;type should be initialized before calling it.</span>
<span class="cm"> * This is done by either video_ioctl2 or by the bridge driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">fe_tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">get_frequency</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">abs_freq</span><span class="p">;</span>

		<span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">get_frequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abs_freq</span><span class="p">);</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">V4L2_TUNER_RADIO</span> <span class="o">==</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">abs_freq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">125</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">abs_freq</span><span class="p">,</span> <span class="mi">62500</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">V4L2_TUNER_RADIO</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">radio_freq</span> <span class="o">:</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_freq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_g_tuner - Fill in tuner information</span>
<span class="cm"> * @sd: pointer to struct v4l2_subdev</span>
<span class="cm"> * @vt: pointer to struct v4l2_tuner</span>
<span class="cm"> *</span>
<span class="cm"> * At return, the structure vt will be filled with tuner information</span>
<span class="cm"> * if the tuner matches vt-&gt;type.</span>
<span class="cm"> * Note: vt-&gt;type should be initialized before calling it.</span>
<span class="cm"> * This is done by either video_ioctl2 or by the bridge driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">fe_tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">get_afc</span><span class="p">)</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">afc</span> <span class="o">=</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">get_afc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_CAP_NORM</span><span class="p">;</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rangelow</span> <span class="o">=</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="n">tv_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* radio mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tuner_status</span><span class="p">;</span>

			<span class="n">fe_tuner_ops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_status</span><span class="p">);</span>
			<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">tuner_status</span> <span class="o">&amp;</span> <span class="n">TUNER_STATUS_STEREO</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">V4L2_TUNER_SUB_STEREO</span> <span class="o">:</span>
				<span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">has_signal</span><span class="p">)</span>
			<span class="n">vt</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">has_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_CAP_LOW</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_STEREO</span><span class="p">;</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rangelow</span> <span class="o">=</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16000</span><span class="p">;</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="n">radio_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16000</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tuner_s_tuner - Set the tuner&#39;s audio mode</span>
<span class="cm"> * @sd: pointer to struct v4l2_subdev</span>
<span class="cm"> * @vt: pointer to struct v4l2_tuner</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the audio mode if the tuner matches vt-&gt;type.</span>
<span class="cm"> * Note: vt-&gt;type should be initialized before calling it.</span>
<span class="cm"> * This is done by either video_ioctl2 or by the bridge driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
	<span class="n">set_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">tuner_status</span><span class="p">)</span>
		<span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">tuner_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">analog_demod_ops</span> <span class="o">*</span><span class="n">analog_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">;</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">&amp;&amp;</span> <span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">)</span>
		<span class="n">analog_ops</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">to_tuner</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>

	<span class="n">tuner_dbg</span><span class="p">(</span><span class="s">&quot;resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_mode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">set_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* TUNER_SET_CONFIG is still called by tuner-simple.c, so we have</span>
<span class="cm">	   to handle it here.</span>
<span class="cm">	   There must be a better way of doing this... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_SET_CONFIG</span>:
		<span class="k">return</span> <span class="n">tuner_s_config</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback structs</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">tuner_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">log_status</span> <span class="o">=</span> <span class="n">tuner_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_std</span> <span class="o">=</span> <span class="n">tuner_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_power</span> <span class="o">=</span> <span class="n">tuner_s_power</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_tuner_ops</span> <span class="n">tuner_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_radio</span> <span class="o">=</span> <span class="n">tuner_s_radio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_tuner</span> <span class="o">=</span> <span class="n">tuner_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_tuner</span> <span class="o">=</span> <span class="n">tuner_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_frequency</span> <span class="o">=</span> <span class="n">tuner_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_frequency</span> <span class="o">=</span> <span class="n">tuner_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_type_addr</span> <span class="o">=</span> <span class="n">tuner_s_type_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_config</span> <span class="o">=</span> <span class="n">tuner_s_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tuner_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tuner_tuner_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * I2C structs and module init functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">tuner_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">tuner_suspend</span><span class="p">,</span> <span class="n">tuner_resume</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tuner_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tuner&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* autodetect */</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tuner_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tuner_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;tuner&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tuner_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tuner_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">tuner_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">command</span>	<span class="o">=</span> <span class="n">tuner_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tuner_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">tuner_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;device driver for various TV and TV+FM radio tuners&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralph Metzler, Gerd Knorr, Gunther Mayer&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
