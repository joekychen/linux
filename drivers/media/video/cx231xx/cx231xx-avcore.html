<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx231xx › cx231xx-avcore.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx231xx-avcore.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   cx231xx_avcore.c - driver for Conexant Cx23100/101/102</span>
<span class="cm">		      USB video capture devices</span>

<span class="cm">   Copyright (C) 2008 &lt;srinivasa.deevi at conexant dot com&gt;</span>

<span class="cm">   This program contains the specific code to control the avdecoder chip and</span>
<span class="cm">   other related usb control functions for cx231xx based chipset.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>

<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>

<span class="cp">#include &quot;cx231xx.h&quot;</span>
<span class="cp">#include &quot;cx231xx-dif.h&quot;</span>

<span class="cp">#define TUNER_MODE_FM_RADIO 0</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">			-: BLOCK ARRANGEMENT :-</span>
<span class="cm">	I2S block ----------------------|</span>
<span class="cm">	[I2S audio]			|</span>
<span class="cm">					|</span>
<span class="cm">	Analog Front End --&gt; Direct IF -|-&gt; Cx25840 --&gt; Audio</span>
<span class="cm">	[video &amp; audio]			|   [Audio]</span>
<span class="cm">					|</span>
<span class="cm">					|-&gt; Cx25840 --&gt; Video</span>
<span class="cm">					    [Video]</span>

<span class="cm">*******************************************************************************/</span>
<span class="cm">/******************************************************************************</span>
<span class="cm"> *                    VERVE REGISTER                                          *</span>
<span class="cm"> *									      *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">verve_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VERVE_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verve_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VERVE_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">initGPIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">_gpio_direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">_gpio_direction</span> <span class="o">=</span> <span class="n">_gpio_direction</span> <span class="o">&amp;</span> <span class="mh">0xFC0003FF</span><span class="p">;</span>
	<span class="n">_gpio_direction</span> <span class="o">=</span> <span class="n">_gpio_direction</span> <span class="o">|</span> <span class="mh">0x03FDFC00</span><span class="p">;</span>
	<span class="n">cx231xx_send_gpio_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">_gpio_direction</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">verve_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot; verve_read_byte address0x07=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">verve_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">);</span>
	<span class="n">verve_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot; verve_read_byte address0x07=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_MODE_SET</span><span class="p">,</span> <span class="mh">0x0500FE00</span><span class="p">);</span>
	<span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GBULK_BIT_EN</span><span class="p">,</span> <span class="mh">0xFFFDFFFF</span><span class="p">);</span>

<span class="p">}</span>
<span class="kt">void</span> <span class="nf">uninitGPIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">verve_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
			<span class="mh">0x68</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *                    A F E - B L O C K    C O N T R O L   functions          *</span>
<span class="cm"> * 				[ANALOG FRONT END]			      *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afe_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_DEVICE_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">afe_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_DEVICE_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_afe_init_super_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ref_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">afe_power_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* super block initialize */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">ref_count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_TUNE2</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_TUNE2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">ref_count</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_TUNE1</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PLL2</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* enable pll     */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">afe_power_status</span> <span class="o">!=</span> <span class="mh">0x18</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_info</span><span class="p">(</span>
			<span class="s">&quot;: Init Super Block failed in send cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
		<span class="n">afe_power_status</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_info</span><span class="p">(</span>
			<span class="s">&quot;: Init Super Block failed in receive cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_info</span><span class="p">(</span>
			<span class="s">&quot;: Init Super Block force break in loop !!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* start tuning filter */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_TUNE3</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* exit tuning */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_TUNE3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_afe_init_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* power up all 3 channels, clear pd_buffer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Enable quantizer calibration */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_COM_QUANT</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="cm">/* channel initialize, force modulator (fb) reset */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH1</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH2</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH3</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>

	<span class="cm">/* start quantilizer calibration  */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CAL_ATEST_CH1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CAL_ATEST_CH2</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CAL_ATEST_CH3</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* exit modulator (fb) reset */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH1</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH2</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH3</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>

	<span class="cm">/* enable the pre_clamp in each channel for single-ended input */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_NTF_PRECLMP_EN_CH1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_NTF_PRECLMP_EN_CH2</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_NTF_PRECLMP_EN_CH3</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>

	<span class="cm">/* use diode instead of resistor, so set term_en to 0, res_en to 0  */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_DEVICE_ADDRESS</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
				   <span class="n">ADC_QGAIN_RES_TRM_CH1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_DEVICE_ADDRESS</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
				   <span class="n">ADC_QGAIN_RES_TRM_CH2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_DEVICE_ADDRESS</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
				   <span class="n">ADC_QGAIN_RES_TRM_CH3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* dynamic element matching off */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_DCSERVO_DEM_CH1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_DCSERVO_DEM_CH2</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_DCSERVO_DEM_CH3</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_afe_setup_AFE_for_baseband</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">c_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c_value</span><span class="p">);</span>
	<span class="n">c_value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x50</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span> <span class="n">c_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	The Analog Front End in Cx231xx has 3 channels. These</span>
<span class="cm">	channels are used to share between different inputs</span>
<span class="cm">	like tuner, s-video and composite inputs.</span>

<span class="cm">	channel 1 ----- pin 1  to pin4(in reg is 1-4)</span>
<span class="cm">	channel 2 ----- pin 5  to pin8(in reg is 5-8)</span>
<span class="cm">	channel 3 ----- pin 9 to pin 12(in reg is 9-11)</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">cx231xx_afe_set_input_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">input_mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ch1_setting</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">input_mux</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ch2_setting</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">input_mux</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ch3_setting</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">input_mux</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch1_setting</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INPUT_SEL_MASK</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ch1_setting</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch2_setting</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INPUT_SEL_MASK</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ch2_setting</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH2</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For ch3_setting, the value to put in the register is</span>
<span class="cm">	   7 less than the input number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch3_setting</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INPUT_SEL_MASK</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ch3_setting</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_afe_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">AFE_MODE</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	* FIXME: We need to implement the AFE code for LOW IF and for HI IF.</span>
<span class="cm">	* Currently, only baseband works.</span>
<span class="cm">	*/</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AFE_MODE_LOW_IF</span>:
		<span class="n">cx231xx_Setup_AFE_for_LowIF</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFE_MODE_BASEBAND</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_afe_setup_AFE_for_baseband</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFE_MODE_EU_HI_IF</span>:
		<span class="cm">/* SetupAFEforEuHiIF(); */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFE_MODE_US_HI_IF</span>:
		<span class="cm">/* SetupAFEforUsHiIF(); */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFE_MODE_JAPAN_HI_IF</span>:
		<span class="cm">/* SetupAFEforJapanHiIF(); */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">afe_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span> <span class="o">==</span> <span class="n">CX231XX_VMUX_TELEVISION</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_afe_adjust_ref_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="n">CX231XX_VMUX_TELEVISION</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">afe_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_afe_update_power_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">AV_MODE</span> <span class="n">avmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">afe_power_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_CARRAERA</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_250</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_SHELBY</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_250</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_253S</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_253S</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_VIDEO_GRABBER</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_EXETER</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USBLIVE2</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_PV_PLAYTV_USB_HYBRID</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">avmode</span> <span class="o">==</span> <span class="n">POLARIS_AVMODE_ANALOGT_TV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">afe_power_status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
							<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH1</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avmode</span> <span class="o">==</span> <span class="n">POLARIS_AVMODE_DIGITAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH1</span><span class="p">,</span>
							<span class="mh">0x70</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span>
							<span class="mh">0x70</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span>
							<span class="mh">0x70</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
			<span class="n">afe_power_status</span> <span class="o">|=</span> <span class="n">FLD_PWRDN_PD_BANDGAP</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_PD_BIAS</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_PD_TUNECK</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
						   <span class="n">afe_power_status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avmode</span> <span class="o">==</span> <span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">afe_power_status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
							<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH1</span><span class="p">,</span>
						<span class="mh">0x00</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span>
						<span class="mh">0x00</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span>
						<span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;Invalid AV mode input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avmode</span> <span class="o">==</span> <span class="n">POLARIS_AVMODE_ANALOGT_TV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">afe_power_status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
							<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH1</span><span class="p">,</span>
							<span class="mh">0x40</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span>
							<span class="mh">0x40</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avmode</span> <span class="o">==</span> <span class="n">POLARIS_AVMODE_DIGITAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH1</span><span class="p">,</span>
							<span class="mh">0x70</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span>
							<span class="mh">0x70</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span>
							<span class="mh">0x70</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
			<span class="n">afe_power_status</span> <span class="o">|=</span> <span class="n">FLD_PWRDN_PD_BANDGAP</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_PD_BIAS</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_PD_TUNECK</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="n">afe_power_status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avmode</span> <span class="o">==</span> <span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">afe_power_status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
						<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="n">FLD_PWRDN_TUNING_BIAS</span> <span class="o">|</span>
							<span class="n">FLD_PWRDN_ENABLE_PLL</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUP_BLK_PWRDN</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">afe_power_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH1</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH2</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span>
							<span class="mh">0x40</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;Invalid AV mode input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="cm">/* switch  */</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_afe_adjust_ref_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">video_input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">input_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ntf_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span> <span class="o">=</span> <span class="n">video_input</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_input</span> <span class="o">==</span> <span class="n">CX231XX_VMUX_TELEVISION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_mode</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_NTF_PRECLMP_EN_CH3</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ntf_mode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_mode</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_NTF_PRECLMP_EN_CH1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ntf_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">input_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntf_mode</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">input_mode</span> <span class="o">&amp;</span> <span class="mh">0x6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">input_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SINGLE_ENDED</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">afe_ref_count</span> <span class="o">=</span> <span class="mh">0x23C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOW_IF</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">afe_ref_count</span> <span class="o">=</span> <span class="mh">0x24C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EU_IF</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">afe_ref_count</span> <span class="o">=</span> <span class="mh">0x258</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">US_IF</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">afe_ref_count</span> <span class="o">=</span> <span class="mh">0x260</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_afe_init_super_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">afe_ref_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *     V I D E O / A U D I O    D E C O D E R    C O N T R O L   functions    *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vid_blk_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vid_blk_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vid_blk_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vid_blk_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">cx231xx_check_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DL_CTL_ADDRESS_LOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_video_input_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">INPUT</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX231XX_VMUX_COMPOSITE1</span>:
	<span class="k">case</span> <span class="n">CX231XX_VMUX_SVIDEO</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_BUS_POWER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* External AV */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_power_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: set_power_mode : Failed to&quot;</span>
						<span class="s">&quot; set Power - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_decoder_video_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">INPUT</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
							 <span class="n">INPUT</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmux</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX231XX_VMUX_TELEVISION</span>:
	<span class="k">case</span> <span class="n">CX231XX_VMUX_CABLE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_BUS_POWER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">POLARIS_AVMODE_ANALOGT_TV</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Tuner */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_power_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">POLARIS_AVMODE_ANALOGT_TV</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: set_power_mode:Failed&quot;</span>
					<span class="s">&quot; to set Power - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_NXP_TDA18271</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_decoder_video_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">CX231XX_VMUX_TELEVISION</span><span class="p">,</span>
							<span class="n">INPUT</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmux</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_decoder_video_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">CX231XX_VMUX_COMPOSITE1</span><span class="p">,</span>
							<span class="n">INPUT</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmux</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: set_power_mode : Unknown Input %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save the selection */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_decoder_video_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">pin_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pin_type</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_afe_adjust_ref_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pin_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: adjust_ref_count :Failed to set&quot;</span>
				<span class="s">&quot;AFE input mux - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* call afe block to set video inputs */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_afe_set_input_mux</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: set_input_mux :Failed to set&quot;</span>
				<span class="s">&quot; AFE input mux - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pin_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX231XX_VMUX_COMPOSITE1</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

		<span class="cm">/* set [24:23] [22:15] to 0  */</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x1ff8000</span><span class="p">));</span>
		<span class="cm">/* set FUNC_MODE[24:23] = 2 IF_MOD[22:15] = 0  */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x1000000</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="cm">/* Set output mode */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">OUT_CTRL1</span><span class="p">,</span>
							<span class="n">FLD_OUT_MODE</span><span class="p">,</span>
							<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>

		<span class="cm">/* Tell DIF object to go to baseband mode  */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_dif_set_standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_USE_BASEBAND</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: cx231xx_dif set to By pass&quot;</span>
						   <span class="s">&quot; mode- errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read the DFE_CTRL1 register */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

		<span class="cm">/* enable the VBI_GATE_EN */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VBI_GATE_EN</span><span class="p">;</span>

		<span class="cm">/* Enable the auto-VGA enable */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VGA_AUTO_EN</span><span class="p">;</span>

		<span class="cm">/* Write it back */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="cm">/* Disable auto config of registers */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">MODE_CTRL</span><span class="p">,</span> <span class="n">FLD_ACFG_DIS</span><span class="p">,</span>
					<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_ACFG_DIS</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

		<span class="cm">/* Set CVBS input mode */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
			<span class="n">MODE_CTRL</span><span class="p">,</span> <span class="n">FLD_INPUT_MODE</span><span class="p">,</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_INPUT_MODE</span><span class="p">,</span> <span class="n">INPUT_MODE_CVBS_0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX231XX_VMUX_SVIDEO</span>:
		<span class="cm">/* Disable the use of  DIF */</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

		<span class="cm">/* set [24:23] [22:15] to 0 */</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x1ff8000</span><span class="p">));</span>
		<span class="cm">/* set FUNC_MODE[24:23] = 2</span>
<span class="cm">		IF_MOD[22:15] = 0 DCR_BYP_CH2[4:4] = 1; */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x1000010</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="cm">/* Tell DIF object to go to baseband mode */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_dif_set_standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_USE_BASEBAND</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: cx231xx_dif set to By pass&quot;</span>
						   <span class="s">&quot; mode- errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read the DFE_CTRL1 register */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

		<span class="cm">/* enable the VBI_GATE_EN */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VBI_GATE_EN</span><span class="p">;</span>

		<span class="cm">/* Enable the auto-VGA enable */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VGA_AUTO_EN</span><span class="p">;</span>

		<span class="cm">/* Write it back */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="cm">/* Disable auto config of registers  */</span>
		<span class="n">status</span> <span class="o">=</span>  <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">MODE_CTRL</span><span class="p">,</span> <span class="n">FLD_ACFG_DIS</span><span class="p">,</span>
					<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_ACFG_DIS</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

		<span class="cm">/* Set YC input mode */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
			<span class="n">MODE_CTRL</span><span class="p">,</span>
			<span class="n">FLD_INPUT_MODE</span><span class="p">,</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_INPUT_MODE</span><span class="p">,</span> <span class="n">INPUT_MODE_YC_1</span><span class="p">));</span>

		<span class="cm">/* Chroma to ADC2 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_CHROMA_IN_SEL</span><span class="p">;</span>	<span class="cm">/* set the chroma in select */</span>

		<span class="cm">/* Clear VGA_SEL_CH2 and VGA_SEL_CH3 (bits 7 and 8)</span>
<span class="cm">		   This sets them to use video</span>
<span class="cm">		   rather than audio.  Only one of the two will be in use. */</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FLD_VGA_SEL_CH2</span> <span class="o">|</span> <span class="n">FLD_VGA_SEL_CH3</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_afe_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_MODE_BASEBAND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX231XX_VMUX_TELEVISION</span>:
	<span class="k">case</span> <span class="n">CX231XX_VMUX_CABLE</span>:
	<span class="nl">default:</span>
		<span class="cm">/* TODO: Test if this is also needed for xc2028/xc3028 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_XC5000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable the use of  DIF   */</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

			<span class="cm">/* set [24:23] [22:15] to 0 */</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x1FF8000</span><span class="p">));</span>
			<span class="cm">/* set FUNC_MODE[24:23] = 2 IF_MOD[22:15] = 0 */</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x1000000</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Set output mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="n">FLD_OUT_MODE</span><span class="p">,</span>
							<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>

			<span class="cm">/* Tell DIF object to go to baseband mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_dif_set_standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">DIF_USE_BASEBAND</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: cx231xx_dif set to By pass&quot;</span>
						<span class="s">&quot; mode- errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Read the DFE_CTRL1 register */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

			<span class="cm">/* enable the VBI_GATE_EN */</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VBI_GATE_EN</span><span class="p">;</span>

			<span class="cm">/* Enable the auto-VGA enable */</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VGA_AUTO_EN</span><span class="p">;</span>

			<span class="cm">/* Write it back */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Disable auto config of registers */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">MODE_CTRL</span><span class="p">,</span> <span class="n">FLD_ACFG_DIS</span><span class="p">,</span>
					<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_ACFG_DIS</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

			<span class="cm">/* Set CVBS input mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
				<span class="n">MODE_CTRL</span><span class="p">,</span> <span class="n">FLD_INPUT_MODE</span><span class="p">,</span>
				<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_INPUT_MODE</span><span class="p">,</span>
						<span class="n">INPUT_MODE_CVBS_0</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Enable the DIF for the tuner */</span>

			<span class="cm">/* Reinitialize the DIF */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_dif_set_standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: cx231xx_dif set to By pass&quot;</span>
						<span class="s">&quot; mode- errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Make sure bypass is cleared */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Clear the bypass bit */</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLD_DIF_DIF_BYPASS</span><span class="p">;</span>

			<span class="cm">/* Enable the use of the DIF block */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Read the DFE_CTRL1 register */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Disable the VBI_GATE_EN */</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLD_VBI_GATE_EN</span><span class="p">;</span>

			<span class="cm">/* Enable the auto-VGA enable, AGC, and</span>
<span class="cm">			   set the skip count to 2 */</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VGA_AUTO_EN</span> <span class="o">|</span> <span class="n">FLD_AGC_AUTO_EN</span> <span class="o">|</span> <span class="mh">0x00200000</span><span class="p">;</span>

			<span class="cm">/* Write it back */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Wait until AGC locks up */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* Disable the auto-VGA enable AGC */</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FLD_VGA_AUTO_EN</span><span class="p">);</span>

			<span class="cm">/* Write it back */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Enable Polaris B0 AGC output */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PIN_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FLD_OEF_AGC_RF</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">FLD_OEF_AGC_IFVGA</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">FLD_OEF_AGC_IF</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PIN_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Set output mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
						<span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="n">FLD_OUT_MODE</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>

			<span class="cm">/* Disable auto config of registers */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">MODE_CTRL</span><span class="p">,</span> <span class="n">FLD_ACFG_DIS</span><span class="p">,</span>
					<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_ACFG_DIS</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

			<span class="cm">/* Set CVBS input mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
				<span class="n">MODE_CTRL</span><span class="p">,</span> <span class="n">FLD_INPUT_MODE</span><span class="p">,</span>
				<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_INPUT_MODE</span><span class="p">,</span>
						<span class="n">INPUT_MODE_CVBS_0</span><span class="p">));</span>

			<span class="cm">/* Set some bits in AFE_CTRL so that channel 2 or 3</span>
<span class="cm">			 * is ready to receive audio */</span>
			<span class="cm">/* Clear clamp for channels 2 and 3      (bit 16-17) */</span>
			<span class="cm">/* Clear droop comp                      (bit 19-20) */</span>
			<span class="cm">/* Set VGA_SEL (for audio control)       (bit 7-8) */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

			<span class="cm">/*Set Func mode:01-DIF 10-baseband 11-YUV*/</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FLD_FUNC_MODE</span><span class="p">));</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x800000</span><span class="p">;</span>

			<span class="n">value</span> <span class="o">|=</span> <span class="n">FLD_VGA_SEL_CH3</span> <span class="o">|</span> <span class="n">FLD_VGA_SEL_CH2</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_NXP_TDA18271</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PIN_CTRL</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PIN_CTRL</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFEF</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set raw VBI mode */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
				<span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="n">FLD_VBIHACTRAW_EN</span><span class="p">,</span>
				<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_VBIHACTRAW_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OUT_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx231xx_enable656</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*enable TS1 data[0:7] as output to export 656*/</span>

	<span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_PIN_CTL0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="cm">/*enable TS1 clock as output to export 656*/</span>

	<span class="n">vid_blk_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_PIN_CTL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">|</span><span class="mh">0x04</span><span class="p">;</span>

	<span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_PIN_CTL1</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_enable656</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cx231xx_disable656</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_PIN_CTL0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">vid_blk_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_PIN_CTL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">&amp;</span><span class="mh">0xFB</span><span class="p">;</span>

	<span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_PIN_CTL1</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_disable656</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Handle any video-mode specific overrides that are different</span>
<span class="cm"> * on a per video standards basis after touching the MODE_CTRL</span>
<span class="cm"> * register which resets many values for autodetect</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cx231xx_do_mode_ctrl_overrides</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;do_mode_ctrl_overrides : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">);</span>

	<span class="cm">/* Change the DFE_CTRL3 bp_percent to fix flagging */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DFE_CTRL3</span><span class="p">,</span> <span class="mh">0xCD3F0280</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;do_mode_ctrl_overrides NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Move the close caption lines out of active video,</span>
<span class="cm">		   adjust the active video start point */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_VBLANK_CNT</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_VACTIVE_CNT</span><span class="p">,</span>
							<span class="mh">0x1E7000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_V656BLANK_CNT</span><span class="p">,</span>
							<span class="mh">0x1C000000</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">HORIZ_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_HBLANK_CNT</span><span class="p">,</span>
							<span class="n">cx231xx_set_field</span>
							<span class="p">(</span><span class="n">FLD_HBLANK_CNT</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;do_mode_ctrl_overrides SECAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span>  <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_VBLANK_CNT</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_VACTIVE_CNT</span><span class="p">,</span>
							<span class="n">cx231xx_set_field</span>
							<span class="p">(</span><span class="n">FLD_VACTIVE_CNT</span><span class="p">,</span>
							 <span class="mh">0x244</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_V656BLANK_CNT</span><span class="p">,</span>
							<span class="n">cx231xx_set_field</span>
							<span class="p">(</span><span class="n">FLD_V656BLANK_CNT</span><span class="p">,</span>
							<span class="mh">0x24</span><span class="p">));</span>
		<span class="cm">/* Adjust the active video horizontal start point */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">HORIZ_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_HBLANK_CNT</span><span class="p">,</span>
							<span class="n">cx231xx_set_field</span>
							<span class="p">(</span><span class="n">FLD_HBLANK_CNT</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;do_mode_ctrl_overrides PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_VBLANK_CNT</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_VACTIVE_CNT</span><span class="p">,</span>
							<span class="n">cx231xx_set_field</span>
							<span class="p">(</span><span class="n">FLD_VACTIVE_CNT</span><span class="p">,</span>
							 <span class="mh">0x244</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">VERT_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_V656BLANK_CNT</span><span class="p">,</span>
							<span class="n">cx231xx_set_field</span>
							<span class="p">(</span><span class="n">FLD_V656BLANK_CNT</span><span class="p">,</span>
							<span class="mh">0x24</span><span class="p">));</span>
		<span class="cm">/* Adjust the active video horizontal start point */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
							<span class="n">HORIZ_TIM_CTRL</span><span class="p">,</span>
							<span class="n">FLD_HBLANK_CNT</span><span class="p">,</span>
							<span class="n">cx231xx_set_field</span>
							<span class="p">(</span><span class="n">FLD_HBLANK_CNT</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">));</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_unmute_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_VOL_CTL</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_unmute_audio</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">stopAudioFirmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DL_CTL_CONTROL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">restartAudioFirmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DL_CTL_CONTROL</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_audio_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">AUDIO_INPUT</span> <span class="n">ainput</span> <span class="o">=</span> <span class="n">AUDIO_INPUT_LINE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">INPUT</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">amux</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX231XX_AMUX_VIDEO</span>:
		<span class="n">ainput</span> <span class="o">=</span> <span class="n">AUDIO_INPUT_TUNER_TV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX231XX_AMUX_LINE_IN</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_i2s_blk_set_audio_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="n">ainput</span> <span class="o">=</span> <span class="n">AUDIO_INPUT_LINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_audio_decoder_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ainput</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_audio_decoder_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">AUDIO_INPUT</span> <span class="n">audio_input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dwval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gen_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Put it in soft reset   */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GENERAL_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen_ctrl</span><span class="p">);</span>
	<span class="n">gen_ctrl</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GENERAL_CTL</span><span class="p">,</span> <span class="n">gen_ctrl</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">audio_input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AUDIO_INPUT_LINE</span>:
		<span class="cm">/* setup AUD_IO control from Merlin paralle output */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_AUD_CHAN1_SRC</span><span class="p">,</span>
					  <span class="n">AUD_CHAN_SRC_PARALLEL</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AUD_IO_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="cm">/* setup input to Merlin, SRC2 connect to AC97</span>
<span class="cm">		   bypass upsample-by-2, slave mode, sony mode, left justify</span>
<span class="cm">		   adr 091c, dat 01000000 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwval</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_CTL</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">dwval</span> <span class="o">|</span> <span class="n">FLD_AC97_UP2X_BYPASS</span><span class="p">));</span>

		<span class="cm">/* select the parallel1 and SRC3 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAND_OUT_SEL</span><span class="p">,</span>
				<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC3_IN_SEL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC3_CLK_SEL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_PARALLEL1_SRC_SEL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">));</span>

		<span class="cm">/* unmute all, AC97 in, independence mode</span>
<span class="cm">		   adr 08d0, data 0x00063073 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DL_CTL</span><span class="p">,</span> <span class="mh">0x3000001</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_CTL1</span><span class="p">,</span> <span class="mh">0x00063073</span><span class="p">);</span>

		<span class="cm">/* set AVC maximum threshold, adr 08d4, dat ffff0024 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_VOL_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwval</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_VOL_CTL</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">dwval</span> <span class="o">|</span> <span class="n">FLD_PATH1_AVC_THRESHOLD</span><span class="p">));</span>

		<span class="cm">/* set SC maximum threshold, adr 08ec, dat ffffb3a3 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_SC_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwval</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_SC_CTL</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">dwval</span> <span class="o">|</span> <span class="n">FLD_PATH1_SC_THRESHOLD</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_INPUT_TUNER_TV</span>:
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">stopAudioFirmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* Setup SRC sources and clocks */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAND_OUT_SEL</span><span class="p">,</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC6_IN_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>         <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC6_CLK_SEL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span>        <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC5_IN_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>         <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC5_CLK_SEL</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span>        <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC4_IN_SEL</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span>         <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC4_CLK_SEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)</span>        <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC3_IN_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>         <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SRC3_CLK_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>        <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_BASEBAND_BYPASS_CTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_AC97_SRC_SEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)</span>        <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_I2S_SRC_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>         <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_PARALLEL2_SRC_SEL</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span>   <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_PARALLEL1_SRC_SEL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">));</span>

		<span class="cm">/* Setup the AUD_IO control */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AUD_IO_CTRL</span><span class="p">,</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_I2S_PORT_DIR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>  <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_I2S_OUT_SRC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>   <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_AUD_CHAN3_SRC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_AUD_CHAN2_SRC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_AUD_CHAN1_SRC</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">));</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_CTL1</span><span class="p">,</span> <span class="mh">0x1F063870</span><span class="p">);</span>

		<span class="cm">/* setAudioStandard(_audio_standard); */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_CTL1</span><span class="p">,</span> <span class="mh">0x00063870</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">restartAudioFirmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_XC5000</span>:
			<span class="cm">/* SIF passthrough at 28.6363 MHz sample rate */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">CHIP_CTRL</span><span class="p">,</span>
					<span class="n">FLD_SIF_EN</span><span class="p">,</span>
					<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SIF_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_NXP_TDA18271</span>:
			<span class="cm">/* Normal mode: SIF passthrough at 14.32 MHz */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span>
					<span class="n">CHIP_CTRL</span><span class="p">,</span>
					<span class="n">FLD_SIF_EN</span><span class="p">,</span>
					<span class="n">cx231xx_set_field</span><span class="p">(</span><span class="n">FLD_SIF_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* This is just a casual suggestion to people adding</span>
<span class="cm">			   new boards in case they use a tuner type we don&#39;t</span>
<span class="cm">			   currently know about */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unknown tuner type configuring SIF&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_INPUT_TUNER_FM</span>:
		<span class="cm">/*  use SIF for FM radio</span>
<span class="cm">		   setupFM();</span>
<span class="cm">		   setAudioStandard(_audio_standard);</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_INPUT_MUTE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PATH1_CTL1</span><span class="p">,</span> <span class="mh">0x1F011012</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Take it out of soft reset */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GENERAL_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen_ctrl</span><span class="p">);</span>
	<span class="n">gen_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GENERAL_CTL</span><span class="p">,</span> <span class="n">gen_ctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *                    C H I P Specific  C O N T R O L   functions             *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_init_ctrl_pin_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PIN_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="o">~</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">ctl_pin_status_mask</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PIN_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_agc_analog_digital_mux_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">u8</span> <span class="n">analog_or_digital</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first set the direction to output */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_direction</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span>
					    <span class="n">agc_analog_digital_select_gpio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* 0 - demod ; 1 - Analog mode */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">agc_analog_digital_select_gpio</span><span class="p">,</span>
				   <span class="n">analog_or_digital</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_enable_i2c_port_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_port_3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">current_is_port_3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">dont_use_port_3</span><span class="p">)</span>
		<span class="n">is_port_3</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span>
				       <span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">current_is_port_3</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">I2C_DEMOD_EN</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Just return, if already using the right port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_is_port_3</span> <span class="o">==</span> <span class="n">is_port_3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_port_3</span><span class="p">)</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">I2C_DEMOD_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I2C_DEMOD_EN</span><span class="p">;</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;Changing the i2c master port to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">is_port_3</span> <span class="o">?</span>  <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
					<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_enable_i2c_port_3</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">update_HH_register_after_set_DIF</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">	u8 status = 0;</span>
<span class="cm">	u32 value = 0;</span>

<span class="cm">	vid_blk_write_word(dev, PIN_CTRL, 0xA0FFF82F);</span>
<span class="cm">	vid_blk_write_word(dev, DIF_MISC_CTRL, 0x0A203F11);</span>
<span class="cm">	vid_blk_write_word(dev, DIF_SRC_PHASE_INC, 0x1BEFBF06);</span>

<span class="cm">	status = vid_blk_read_word(dev, AFE_CTRL_C2HH_SRC_CTRL, &amp;value);</span>
<span class="cm">	vid_blk_write_word(dev, AFE_CTRL_C2HH_SRC_CTRL, 0x4485D390);</span>
<span class="cm">	status = vid_blk_read_word(dev, AFE_CTRL_C2HH_SRC_CTRL,  &amp;value);</span>
<span class="cm">*/</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx231xx_dump_HH_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="mh">0x45005390</span><span class="p">;</span>
	<span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x104</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x140</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x440</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;AFE_CTRL_C2HH_SRC_CTRL=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mh">0x4485D390</span><span class="p">);</span>
	<span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;AFE_CTRL_C2HH_SRC_CTRL=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx231xx_dump_SC_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;cx231xx_dump_SC_reg!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">BOARD_CFG_STAT</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BOARD_CFG_STAT</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">TS1_CFG_REG</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TS1_CFG_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">TS1_LENGTH_REG</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TS1_LENGTH_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">TS2_CFG_REG</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TS2_CFG_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">TS2_LENGTH_REG</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TS2_LENGTH_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">EP_MODE_SET</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">EP_MODE_SET</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_PWR_PTN1</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_PWR_PTN1</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_PWR_PTN2</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_PWR_PTN2</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_PWR_PTN3</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_PWR_PTN3</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_PWR_MASK0</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_PWR_MASK0</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_PWR_MASK1</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_PWR_MASK1</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_PWR_MASK2</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_PWR_MASK2</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_GAIN</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_GAIN</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_CAR_REG</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_CAR_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_OT_CFG1</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_OT_CFG1</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">CIR_OT_CFG2</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CIR_OT_CFG2</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>


<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx231xx_Setup_AFE_for_LowIF</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_STATUS2_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span><span class="o">|</span><span class="mh">0x01</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_STATUS2_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_STATUS2_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span><span class="o">|</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_STATUS2_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm">	config colibri to lo-if mode</span>

<span class="cm">	FIXME: ntf_mode = 2&#39;b00 by default. But set 0x1 would reduce</span>
<span class="cm">		the diff IF input by half,</span>

<span class="cm">		for low-if agc defect</span>
<span class="cm">*/</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_NTF_PRECLMP_EN_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span><span class="o">|</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_NTF_PRECLMP_EN_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xF9</span><span class="p">)</span><span class="o">|</span><span class="mh">0x02</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_INPUT_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFB</span><span class="p">)</span><span class="o">|</span><span class="mh">0x04</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_FB_FRCRST_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_DCSERVO_DEM_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span><span class="o">|</span><span class="mh">0x03</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_DCSERVO_DEM_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CTRL_DAC1_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFB</span><span class="p">)</span><span class="o">|</span><span class="mh">0x04</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CTRL_DAC1_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CTRL_DAC23_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span><span class="o">|</span><span class="mh">0x06</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CTRL_DAC23_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CTRL_DAC23_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x8F</span><span class="p">)</span><span class="o">|</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_CTRL_DAC23_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">afe_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xDF</span><span class="p">)</span><span class="o">|</span><span class="mh">0x20</span><span class="p">;</span>
	<span class="n">afe_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ADC_PWRDN_CLAMP_CH3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx231xx_set_Colibri_For_LowIF</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">if_freq</span><span class="p">,</span>
		 <span class="n">u8</span> <span class="n">spectral_invert</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">colibri_carrier_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">func_mode</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* Device has a DIF if this function is called */</span>
	<span class="n">u32</span> <span class="n">standard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;Enter cx231xx_set_Colibri_For_LowIF()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x6F</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x6F</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x6F</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x6F</span><span class="p">;</span>
	<span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
					<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/*Set colibri for low IF*/</span>
	<span class="n">cx231xx_afe_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFE_MODE_LOW_IF</span><span class="p">);</span>

	<span class="cm">/* Set C2HH for low IF operation.*/</span>
	<span class="n">standard</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">;</span>
	<span class="n">cx231xx_dif_configure_C2HH_for_low_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">active_mode</span><span class="p">,</span>
						       <span class="n">func_mode</span><span class="p">,</span> <span class="n">standard</span><span class="p">);</span>

	<span class="cm">/* Get colibri offsets.*/</span>
	<span class="n">colibri_carrier_offset</span> <span class="o">=</span> <span class="n">cx231xx_Get_Colibri_CarrierOffset</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span>
								   <span class="n">standard</span><span class="p">);</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;colibri_carrier_offset=%d, standard=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">colibri_carrier_offset</span><span class="p">,</span> <span class="n">standard</span><span class="p">);</span>

	<span class="cm">/* Set the band Pass filter for DIF*/</span>
	<span class="n">cx231xx_set_DIF_bandpass</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">if_freq</span><span class="o">+</span><span class="n">colibri_carrier_offset</span><span class="p">),</span>
				 <span class="n">spectral_invert</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">cx231xx_Get_Colibri_CarrierOffset</span><span class="p">(</span><span class="n">u32</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">standerd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">colibri_carrier_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TUNER_MODE_FM_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">colibri_carrier_offset</span> <span class="o">=</span> <span class="mi">1100000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standerd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_MN</span> <span class="o">|</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">colibri_carrier_offset</span> <span class="o">=</span> <span class="mi">4832000</span><span class="p">;</span>  <span class="cm">/*4.83MHz	*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standerd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_B</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_G</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">colibri_carrier_offset</span> <span class="o">=</span> <span class="mi">2700000</span><span class="p">;</span>  <span class="cm">/*2.70MHz       */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standerd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_D</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_I</span>
			<span class="o">|</span> <span class="n">V4L2_STD_SECAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">colibri_carrier_offset</span> <span class="o">=</span> <span class="mi">2100000</span><span class="p">;</span>  <span class="cm">/*2.10MHz	*/</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">colibri_carrier_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx231xx_set_DIF_bandpass</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">if_freq</span><span class="p">,</span>
		 <span class="n">u8</span> <span class="n">spectral_invert</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pll_freq_word</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dif_misc_ctrl_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pll_freq_u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;if_freq=%d;spectral_invert=0x%x;mode=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">if_freq</span><span class="p">,</span> <span class="n">spectral_invert</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TUNER_MODE_FM_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll_freq_word</span> <span class="o">=</span> <span class="mh">0x905A1CAC</span><span class="p">;</span>
		<span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_FREQ_WORD</span><span class="p">,</span>  <span class="n">pll_freq_word</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="cm">/*KSPROPERTY_TUNER_MODE_TV*/</span><span class="p">{</span>
		<span class="cm">/* Calculate the PLL frequency word based on the adjusted if_freq*/</span>
		<span class="n">pll_freq_word</span> <span class="o">=</span> <span class="n">if_freq</span><span class="p">;</span>
		<span class="n">pll_freq_u64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pll_freq_word</span> <span class="o">&lt;&lt;</span> <span class="mi">28L</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">pll_freq_u64</span><span class="p">,</span> <span class="mi">50000000</span><span class="p">);</span>
		<span class="n">pll_freq_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pll_freq_u64</span><span class="p">;</span>
		<span class="cm">/*pll_freq_word = 0x3463497;*/</span>
		<span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_FREQ_WORD</span><span class="p">,</span>  <span class="n">pll_freq_word</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spectral_invert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">if_freq</span> <span class="o">-=</span> <span class="mi">400000</span><span class="p">;</span>
		<span class="cm">/* Enable Spectral Invert*/</span>
		<span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dif_misc_ctrl_value</span><span class="p">);</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">=</span> <span class="n">dif_misc_ctrl_value</span> <span class="o">|</span> <span class="mh">0x00200000</span><span class="p">;</span>
		<span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span>
					<span class="n">dif_misc_ctrl_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">if_freq</span> <span class="o">+=</span> <span class="mi">400000</span><span class="p">;</span>
		<span class="cm">/* Disable Spectral Invert*/</span>
		<span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dif_misc_ctrl_value</span><span class="p">);</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">=</span> <span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;</span> <span class="mh">0xFFDFFFFF</span><span class="p">;</span>
		<span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span>
					<span class="n">dif_misc_ctrl_value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">if_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">if_freq</span><span class="o">/</span><span class="mi">100000</span><span class="p">)</span><span class="o">*</span><span class="mi">100000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">if_freq</span> <span class="o">&lt;</span> <span class="mi">3000000</span><span class="p">)</span>
		<span class="n">if_freq</span> <span class="o">=</span> <span class="mi">3000000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">if_freq</span> <span class="o">&gt;</span> <span class="mi">16000000</span><span class="p">)</span>
		<span class="n">if_freq</span> <span class="o">=</span> <span class="mi">16000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;Enter IF=%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">Dif_set_array</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">Dif_set_array</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Dif_set_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">if_freq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">Dif_set_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">register_address</span><span class="p">,</span> <span class="n">Dif_set_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *                 D I F - B L O C K    C O N T R O L   functions             *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_dif_configure_C2HH_for_low_IF</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">,</span>
					  <span class="n">u32</span> <span class="n">function_mode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">standard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* C2HH */</span>
		<span class="cm">/* lo if big signal */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
				<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="cm">/* FUNC_MODE = DIF */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
				<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">function_mode</span><span class="p">);</span>
		<span class="cm">/* IF_MODE */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
				<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="cm">/* no inv */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
				<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">!=</span> <span class="n">DIF_USE_BASEBAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_MN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* lo if big signal */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="cm">/* FUNC_MODE = DIF */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
					<span class="n">function_mode</span><span class="p">);</span>
			<span class="cm">/* IF_MODE */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">);</span>
			<span class="cm">/* no inv */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="cm">/* 0x124, AUD_CHAN1_SRC = 0x3 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AUD_IO_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">standard</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_D</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* C2HH setup */</span>
			<span class="cm">/* lo if big signal */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="cm">/* FUNC_MODE = DIF */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
					<span class="n">function_mode</span><span class="p">);</span>
			<span class="cm">/* IF_MODE */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">);</span>
			<span class="cm">/* no inv */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* default PAL BG */</span>
			<span class="cm">/* C2HH setup */</span>
			<span class="cm">/* lo if big signal */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="cm">/* FUNC_MODE = DIF */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
					<span class="n">function_mode</span><span class="p">);</span>
			<span class="cm">/* IF_MODE */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">);</span>
			<span class="cm">/* no inv */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					<span class="n">AFE_CTRL_C2HH_SRC_CTRL</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_dif_set_standard</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">standard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dif_misc_ctrl_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">func_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;%s: setStandard to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">standard</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dif_misc_ctrl_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">!=</span> <span class="n">DIF_USE_BASEBAND</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">standard</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_CARRAERA</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_250</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_SHELBY</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_250</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_VIDEO_GRABBER</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_EXETER</span>:
		<span class="n">func_mode</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_253S</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_253S</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC</span>:
		<span class="n">func_mode</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">func_mode</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_dif_configure_C2HH_for_low_IF</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">active_mode</span><span class="p">,</span>
						  <span class="n">func_mode</span><span class="p">,</span> <span class="n">standard</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">==</span> <span class="n">DIF_USE_BASEBAND</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* base band */</span>
		<span class="cm">/* There is a different SRC_PHASE_INC value</span>
<span class="cm">		   for baseband vs. DIF */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span> <span class="mh">0xDF7DF83</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dif_misc_ctrl_value</span><span class="p">);</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="n">FLD_DIF_DIF_BYPASS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span>
						<span class="n">dif_misc_ctrl_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_D</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x6503bc0c</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xbd038c85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1db4640a</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x444C1380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA302600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA261700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_RF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x72500800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x3F3934EA</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x000035e8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_RPT_VARIANCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="mh">0x3a023F11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x6503bc0c</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xbd038c85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1db4640a</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x444C1380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA302600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA261700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_RF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x72500800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x5F39A934</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x000035e8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_RPT_VARIANCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="mh">0x3a033F11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* improved Low Frequency Phase Noise */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mh">0xFF01FF0C</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mh">0xbd038c85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mh">0x1db4640a</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mh">0x444C1380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span>
						<span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span>
						<span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span>
						<span class="mh">0x72500800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span>
						<span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span> <span class="mh">0x012c405d</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span>
						<span class="mh">0x009f50c1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span>
						<span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span>
						<span class="mh">0x000035e8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SOFT_RST_CTRL_REVB</span><span class="p">,</span>
						<span class="mh">0x00000000</span><span class="p">);</span>
		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="mh">0x3A0A3F10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_N</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* improved Low Frequency Phase Noise */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mh">0xFF01FF0C</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mh">0xbd038c85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mh">0x1db4640a</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mh">0x444C1380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span>
						<span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span>
						<span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span>
						<span class="mh">0x72500800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span>
						<span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span>
						<span class="mh">0x012c405d</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span>
						<span class="mh">0x009f50c1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span>
						<span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span>
						<span class="mh">0x000035e8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SOFT_RST_CTRL_REVB</span><span class="p">,</span>
						<span class="mh">0x00000000</span><span class="p">);</span>
		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">=</span> <span class="mh">0x3A093F10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span>
		  <span class="p">(</span><span class="n">V4L2_STD_SECAM_B</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_D</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_G</span> <span class="o">|</span>
		   <span class="n">V4L2_STD_SECAM_K</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_K1</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x6503bc0c</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xbd038c85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1db4640a</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x888C0380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xe0262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xc2171700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_RF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xc2262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x3F3530ec</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x000035e8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_RPT_VARIANCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0xf4000000</span><span class="p">);</span>

		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="mh">0x3a023F11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_SECAM_L</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Is it SECAM_L1? */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x6503bc0c</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xbd038c85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1db4640a</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x888C0380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xe0262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xc2171700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_RF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xc2262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x3F3530ec</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x000035e8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_RPT_VARIANCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0xf2560000</span><span class="p">);</span>

		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="mh">0x3a023F11</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">standard</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* V4L2_STD_NTSC_M (75 IRE Setup) Or</span>
<span class="cm">		   V4L2_STD_NTSC_M_JP (Japan,  0 IRE Setup) */</span>

		<span class="cm">/* For NTSC the centre frequency of video coming out of</span>
<span class="cm">		   sidewinder is around 7.1MHz or 3.6MHz depending on the</span>
<span class="cm">		   spectral inversion. so for a non spectrally inverted channel</span>
<span class="cm">		   the pll freq word is 0x03420c49</span>
<span class="cm">		 */</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mh">0x6503BC0C</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mh">0xBD038C85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mh">0x1DB4640A</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mh">0x444C0380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span>
						<span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span>
						<span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span>
						<span class="mh">0x04000800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span>
						<span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span> <span class="mh">0x01296e1f</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span>
						<span class="mh">0x009f50c1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span>
						<span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span>
						<span class="mh">0x000035e8</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_CTRL_IF</span><span class="p">,</span> <span class="mh">0xC2262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_CTRL_INT</span><span class="p">,</span>
						<span class="mh">0xC2262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_CTRL_RF</span><span class="p">,</span> <span class="mh">0xC2262600</span><span class="p">);</span>

		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="mh">0x3a003F10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default PAL BG */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x6503bc0c</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xbd038c85</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x1db4640a</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_PLL_CTRL3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00008800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x444C1380</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA302600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA261700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_CTRL_RF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0xDA262600</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_IF_INT_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x26001700</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AGC_RF_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00002660</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VIDEO_AGC_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x72500800</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_VID_AUD_OVERRIDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x27000100</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_AV_SEP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x3F3530EC</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_COMP_FLT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x00A653A8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_PHASE_INC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x1befbf06</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_SRC_GAIN_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
					   <span class="mh">0x000035e8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_reg_mask_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VID_BLK_I2C_ADDRESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
					   <span class="n">DIF_RPT_VARIANCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="cm">/* Save the Spec Inversion value */</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="n">FLD_DIF_SPEC_INV</span><span class="p">;</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">|=</span> <span class="mh">0x3a013F11</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The AGC values should be the same for all standards,</span>
<span class="cm">	   AUD_SRC_SEL[19] should always be disabled    */</span>
	<span class="n">dif_misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLD_DIF_AUD_SRC_SEL</span><span class="p">;</span>

	<span class="cm">/* It is still possible to get Set Standard calls even when we</span>
<span class="cm">	   are in FM mode.</span>
<span class="cm">	   This is done to override the value for FM. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">active_mode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span>
		<span class="n">dif_misc_ctrl_value</span> <span class="o">=</span> <span class="mh">0x7a080000</span><span class="p">;</span>

	<span class="cm">/* Write the calculated value for misc ontrol register      */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_MISC_CTRL</span><span class="p">,</span> <span class="n">dif_misc_ctrl_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_tuner_pre_channel_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dwval</span><span class="p">;</span>

	<span class="cm">/* Set the RF and IF k_agc values to 3 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwval</span><span class="p">);</span>
	<span class="n">dwval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FLD_DIF_K_AGC_RF</span> <span class="o">|</span> <span class="n">FLD_DIF_K_AGC_IF</span><span class="p">);</span>
	<span class="n">dwval</span> <span class="o">|=</span> <span class="mh">0x33000000</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="n">dwval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_tuner_post_channel_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dwval</span><span class="p">;</span>
	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;cx231xx_tuner_post_channel_change  dev-&gt;tuner_type =0%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">);</span>
	<span class="cm">/* Set the RF and IF k_agc values to 4 for PAL/NTSC and 8 for</span>
<span class="cm">	 * SECAM L/B/D standards */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_read_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwval</span><span class="p">);</span>
	<span class="n">dwval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FLD_DIF_K_AGC_RF</span> <span class="o">|</span> <span class="n">FLD_DIF_K_AGC_IF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_SECAM_L</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_B</span> <span class="o">|</span>
			 <span class="n">V4L2_STD_SECAM_D</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_NXP_TDA18271</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dwval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLD_DIF_IF_REF</span><span class="p">;</span>
				<span class="n">dwval</span> <span class="o">|=</span> <span class="mh">0x88000300</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dwval</span> <span class="o">|=</span> <span class="mh">0x88000000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_NXP_TDA18271</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dwval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLD_DIF_IF_REF</span><span class="p">;</span>
				<span class="n">dwval</span> <span class="o">|=</span> <span class="mh">0xCC000300</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dwval</span> <span class="o">|=</span> <span class="mh">0x44000000</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vid_blk_write_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_AGC_IF_REF</span><span class="p">,</span> <span class="n">dwval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *        	    I 2 S - B L O C K    C O N T R O L   functions            *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_i2s_blk_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
				       <span class="n">CH_PWR_CTRL1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* enables clock to delta-sigma and decimation filter */</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
					<span class="n">CH_PWR_CTRL1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* power up all channel */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
					<span class="n">CH_PWR_CTRL2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_i2s_blk_update_power_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">AV_MODE</span> <span class="n">avmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">avmode</span> <span class="o">!=</span> <span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
					  <span class="n">CH_PWR_CTRL2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
						<span class="n">CH_PWR_CTRL2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
						<span class="n">CH_PWR_CTRL2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set i2s_blk for audio input types */</span>
<span class="kt">int</span> <span class="nf">cx231xx_i2s_blk_set_audio_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">audio_input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">audio_input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX231XX_AMUX_LINE_IN</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
						<span class="n">CH_PWR_CTRL2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2S_BLK_DEVICE_ADDRESS</span><span class="p">,</span>
						<span class="n">CH_PWR_CTRL1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX231XX_AMUX_VIDEO</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_ainput</span> <span class="o">=</span> <span class="n">audio_input</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *                  P O W E R      C O N T R O L   functions                  *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_set_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">AV_MODE</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot; setPowerMode::mode = %d, No Change req.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
				       <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span>:

		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">PWR_MODE_MASK</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_AV_EN</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_ISO_EN</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
					   <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* reset state of xceive tuner */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">xc_fw_load_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POLARIS_AVMODE_ANALOGT_TV</span>:

		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_DEMOD_EN</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">I2C_DEMOD_EN</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PWR_TUNER_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PWR_TUNER_EN</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PWR_AV_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_AV_EN</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PWR_ISO_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_ISO_EN</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">POLARIS_AVMODE_ANALOGT_TV</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">POLARIS_AVMODE_ANALOGT_TV</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_type</span> <span class="o">!=</span> <span class="n">TUNER_ABSENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable tuner */</span>
			<span class="n">cx231xx_enable_i2c_port_3</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="cm">/* reset the Tuner */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_gpio</span><span class="p">)</span>
				<span class="n">cx231xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_gpio</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_reset_analog_tuner</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_reset_analog_tuner</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POLARIS_AVMODE_DIGITAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PWR_TUNER_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PWR_TUNER_EN</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PWR_AV_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_AV_EN</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PWR_ISO_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_ISO_EN</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">PWR_AV_MODE</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">POLARIS_AVMODE_DIGITAL</span> <span class="o">|</span> <span class="n">I2C_DEMOD_EN</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PWR_DEMOD_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_DEMOD_EN</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
							<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_type</span> <span class="o">!=</span> <span class="n">TUNER_ABSENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Enable tuner</span>
<span class="cm">			 *	Hauppauge Exeter seems to need to do something different!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_EXETER</span><span class="p">)</span>
				<span class="n">cx231xx_enable_i2c_port_3</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cx231xx_enable_i2c_port_3</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="cm">/* reset the Tuner */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_gpio</span><span class="p">)</span>
				<span class="n">cx231xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_gpio</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_reset_analog_tuner</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_reset_analog_tuner</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>

	<span class="cm">/* For power saving, only enable Pwr_resetout_n</span>
<span class="cm">	   when digital TV is selected. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">POLARIS_AVMODE_DIGITAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PWR_RESETOUT_EN</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">PWR_SLEEP_INTERVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update power control for afe */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_afe_update_power_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* update power control for i2s_blk */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_i2s_blk_update_power_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
				       <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_power_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
				       <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">PWR_MODE_MASK</span><span class="p">);</span>

	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *                  S T R E A M    C O N T R O L   functions                  *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_start_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ep_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;cx231xx_start_stream():: ep_mask = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep_mask</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">EP_MODE_SET</span><span class="p">,</span>
				       <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ep_mask</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span> <span class="n">EP_MODE_SET</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_stop_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ep_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;cx231xx_stop_stream():: ep_mask = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep_mask</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">EP_MODE_SET</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">ep_mask</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span> <span class="n">EP_MODE_SET</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_initialize_stream_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">media_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">media_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">81</span>: <span class="cm">/* audio */</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;%s: Audio enter HANC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="mh">0x9300</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* vbi */</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;%s: set vanc registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* sliced cc */</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;%s: set hanc registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="mh">0x1300</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* video */</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;%s: set video registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* ts1 */</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;%s: set ts1 registers&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">has_417</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot; MPEG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x3</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA3</span><span class="p">;</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3B</span><span class="p">;</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
				 <span class="n">TS1_CFG_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
				 <span class="n">TS1_LENGTH_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot; BDA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_CFG_REG</span><span class="p">,</span> <span class="mh">0x010</span><span class="p">);</span>
		<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* ts1 parallel mode */</span>
			<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;%s: set ts1 parallel mode registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS1_CFG_REG</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_mode_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_capture_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">u8</span> <span class="n">media_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ep_mask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcb_config</span> <span class="o">*</span><span class="n">pcb_config</span><span class="p">;</span>

	<span class="cm">/* get EP for media type */</span>
	<span class="n">pcb_config</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pcb_config</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcb_config</span><span class="o">-&gt;</span><span class="n">config_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">media_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* Video */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP4</span><span class="p">;</span>	<span class="cm">/* ep4  [00:1000] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* Audio */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP3</span><span class="p">;</span>	<span class="cm">/* ep3  [00:0100] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* Vbi */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP5</span><span class="p">;</span>	<span class="cm">/* ep5 [01:0000] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* Sliced_cc */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP6</span><span class="p">;</span>	<span class="cm">/* ep6 [10:0000] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* ts1 */</span>
		<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* ts1 parallel mode */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP1</span><span class="p">;</span>	<span class="cm">/* ep1 [00:0001] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* ts2 */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP2</span><span class="p">;</span>	<span class="cm">/* ep2 [00:0010] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pcb_config</span><span class="o">-&gt;</span><span class="n">config_num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">media_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* Video */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP4</span><span class="p">;</span>	<span class="cm">/* ep4  [00:1000] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* Audio */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP3</span><span class="p">;</span>	<span class="cm">/* ep3  [00:0100] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* Vbi */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP5</span><span class="p">;</span>	<span class="cm">/* ep5 [01:0000] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* Sliced_cc */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP6</span><span class="p">;</span>	<span class="cm">/* ep6 [10:0000] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* ts1 */</span>
		<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* ts1 parallel mode */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP1</span><span class="p">;</span>	<span class="cm">/* ep1 [00:0001] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* ts2 */</span>
			<span class="n">ep_mask</span> <span class="o">=</span> <span class="n">ENABLE_EP2</span><span class="p">;</span>	<span class="cm">/* ep2 [00:0010] */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cx231xx_initialize_stream_xfer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">media_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* enable video capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cx231xx_start_stream</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep_mask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* disable video capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cx231xx_stop_stream</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CX231XX_ANALOG_MODE</span><span class="p">)</span>
		<span class="p">;</span><span class="cm">/* do any in Analog mode */</span>
	<span class="k">else</span>
		<span class="p">;</span><span class="cm">/* do any in digital mode */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_capture_start</span><span class="p">);</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm">*                   G P I O   B I T control functions                        *</span>
<span class="cm">******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio_bit</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">gpio_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_send_gpio_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gpio_bit</span><span class="p">,</span> <span class="n">gpio_val</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_get_gpio_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio_bit</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">gpio_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_send_gpio_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gpio_bit</span><span class="p">,</span> <span class="n">gpio_val</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* cx231xx_set_gpio_direction</span>
<span class="cm">*      Sets the direction of the GPIO pin to input or output</span>
<span class="cm">*</span>
<span class="cm">* Parameters :</span>
<span class="cm">*      pin_number : The GPIO Pin number to program the direction for</span>
<span class="cm">*                   from 0 to 31</span>
<span class="cm">*      pin_value : The Direction of the GPIO Pin under reference.</span>
<span class="cm">*                      0 = Input direction</span>
<span class="cm">*                      1 = Output direction</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">cx231xx_set_gpio_direction</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">pin_number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check for valid pin_number - if 32 , bail out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_number</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin_number</span><span class="p">));</span>	<span class="cm">/* clear */</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin_number</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* cache the value for future */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* cx231xx_set_gpio_value</span>
<span class="cm">*      Sets the value of the GPIO pin to Logic high or low. The Pin under</span>
<span class="cm">*      reference should ALREADY BE SET IN OUTPUT MODE !!!!!!!!!</span>
<span class="cm">*</span>
<span class="cm">* Parameters :</span>
<span class="cm">*      pin_number : The GPIO Pin number to program the direction for</span>
<span class="cm">*      pin_value : The value of the GPIO Pin under reference.</span>
<span class="cm">*                      0 = set it to 0</span>
<span class="cm">*                      1 = set it to 1</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">cx231xx_set_gpio_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check for valid pin_number - if 0xFF , bail out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_number</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* first do a sanity check - if the Pin is not output, make it output */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin_number</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It was in input mode */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin_number</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pin_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin_number</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin_number</span><span class="p">);</span>

	<span class="cm">/* store the value */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* toggle bit0 of GP_IO */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm">*                      G P I O I2C related functions                         *</span>
<span class="cm">******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set SCL to output 1 ; set SDA to output 1 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* set SCL to output 1; set SDA to output 0 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* set SCL to output 0; set SDA to output 0      */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set SCL to output 0; set SDA to output 0      */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* set SCL to output 1; set SDA to output 0      */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* set SCL to input ,release SCL cable control</span>
<span class="cm">	   set SDA to input ,release SDA cable control */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set SCL to output ; set SDA to output */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set SCL to output 0; set SDA to output 0     */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

			<span class="cm">/* set SCL to output 1; set SDA to output 0     */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

			<span class="cm">/* set SCL to output 0; set SDA to output 0     */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* set SCL to output 0; set SDA to output 1     */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

			<span class="cm">/* set SCL to output 1; set SDA to output 1     */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

			<span class="cm">/* set SCL to output 0; set SDA to output 1     */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio_logic_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* read byte */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* send write I2c addr */</span>

		<span class="cm">/* set SCL to output 0; set SDA to input */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

		<span class="cm">/* set SCL to output 1; set SDA to input */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

		<span class="cm">/* get SDA data bit */</span>
		<span class="n">gpio_logic_value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_get_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">gpio_logic_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set SCL to output 0,finish the read latest SCL signal.</span>
<span class="cm">	   !!!set SDA to input, never to modify SDA direction at</span>
<span class="cm">	   the same times */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* store the value */</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_read_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio_logic_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nCnt</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nInit</span> <span class="o">=</span> <span class="n">nCnt</span><span class="p">;</span>

	<span class="cm">/* clock stretch; set SCL to input; set SDA to input;</span>
<span class="cm">	   get SCL value till SCL = 1 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>

	<span class="n">gpio_logic_value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_get_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>
		<span class="n">nCnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;</span>
			  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">nCnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nCnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;No ACK after %d msec -GPIO I2C failed!&quot;</span><span class="p">,</span>
			     <span class="n">nInit</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * readAck</span>
<span class="cm">	 * through clock stretch, slave has given a SCL signal,</span>
<span class="cm">	 * so the SDA data can be directly read.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_get_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">gpio_logic_value</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">gpio_logic_value</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* read SDA end, set the SCL to output 0, after this operation,</span>
<span class="cm">	   SDA direction can be changed. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">gpio_logic_value</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_write_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set SDA to ouput */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* set SCL = 0 (output); set SDA = 0 (output) */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* set SCL = 1 (output); set SDA = 0 (output) */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* set SCL = 0 (output); set SDA = 0 (output) */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* set SDA to input,and then the slave will read data from SDA. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_write_nak</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set scl to output ; set sda to input */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_sda_gpio</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* set scl to output 0; set sda to input */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* set scl to output 1; set sda to input */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_scl_gpio</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm">*                      G P I O I2C related functions                         *</span>
<span class="cm">******************************************************************************/</span>
<span class="cm">/* cx231xx_gpio_i2c_read</span>
<span class="cm"> * Function to read data from gpio based I2C interface</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the lock */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_i2c_lock</span><span class="p">);</span>

	<span class="cm">/* start */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_gpio_i2c_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* write dev_addr */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_gpio_i2c_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">dev_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* readAck */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_gpio_i2c_read_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* read data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read data */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_gpio_i2c_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* only do write ack if we more length */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_gpio_i2c_write_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* write NAK - inform reads are complete */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_gpio_i2c_write_nak</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* write end */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_gpio_i2c_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* release the lock */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_i2c_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cx231xx_gpio_i2c_write</span>
<span class="cm"> * Function to write data to gpio based I2C interface</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cx231xx_gpio_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the lock */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_i2c_lock</span><span class="p">);</span>

	<span class="cm">/* start */</span>
	<span class="n">cx231xx_gpio_i2c_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* write dev_addr */</span>
	<span class="n">cx231xx_gpio_i2c_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* read Ack */</span>
	<span class="n">cx231xx_gpio_i2c_read_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write data */</span>
		<span class="n">cx231xx_gpio_i2c_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* read Ack */</span>
		<span class="n">cx231xx_gpio_i2c_read_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write End */</span>
	<span class="n">cx231xx_gpio_i2c_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* release the lock */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_i2c_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
