<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx231xx › cx231xx-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx231xx-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   cx231xx-core.c - driver for Conexant Cx23100/101/102</span>
<span class="cm">				USB video capture devices</span>

<span class="cm">   Copyright (C) 2008 &lt;srinivasa.deevi at conexant dot com&gt;</span>
<span class="cm">				Based on em28xx driver</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>

<span class="cp">#include &quot;cx231xx.h&quot;</span>
<span class="cp">#include &quot;cx231xx-reg.h&quot;</span>

<span class="cm">/* #define ENABLE_DEBUG_ISOC_FRAMES */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">core_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [core]&quot;</span><span class="p">);</span>

<span class="cp">#define cx231xx_coredbg(fmt, arg...) do {\</span>
<span class="cp">	if (core_debug) \</span>
<span class="cp">		printk(KERN_INFO &quot;%s %s :&quot;fmt, \</span>
<span class="cp">			 dev-&gt;name, __func__ , ##arg); } while (0)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reg_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reg_debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [URB reg]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">CX231XX_PINOUT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="s">&quot;alternate setting to use for video endpoint&quot;</span><span class="p">);</span>

<span class="cp">#define cx231xx_isocdbg(fmt, arg...) do {\</span>
<span class="cp">	if (core_debug) \</span>
<span class="cp">		printk(KERN_INFO &quot;%s %s :&quot;fmt, \</span>
<span class="cp">			 dev-&gt;name, __func__ , ##arg); } while (0)</span>

<span class="cm">/*****************************************************************</span>
<span class="cm">*             Device control list functions     				 *</span>
<span class="cm">******************************************************************/</span>

<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cx231xx_devlist</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * cx231xx_realease_resources()</span>
<span class="cm"> * unregisters the v4l2,i2c and usb devices</span>
<span class="cm"> * called when the device gets disconected or at module unload</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">cx231xx_remove_from_devlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist_count</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">cx231xx_add_into_devlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx231xx_devlist</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist_count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cx231xx_extension_devlist</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cx231xx_register_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx231xx_extension_devlist</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx231xx_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: %s initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx231xx_register_extension</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cx231xx_unregister_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx231xx_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: %s removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx231xx_unregister_extension</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cx231xx_init_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_extension_devlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx231xx_extension_devlist</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx231xx_close_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_extension_devlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx231xx_extension_devlist</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">)</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx231xx_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************</span>
<span class="cm">*               U S B related functions                         *</span>
<span class="cm">*****************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_send_usb_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx_i2c</span> <span class="o">*</span><span class="n">i2c_bus</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cx231xx_i2c_xfer_data</span> <span class="o">*</span><span class="n">req_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">VENDOR_REQUEST_IN</span> <span class="n">ven_req</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">saddr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">_i2c_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">_i2c_nostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">_i2c_reserve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Get the I2C period, nostop and reserve parameters */</span>
	<span class="n">_i2c_period</span> <span class="o">=</span> <span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">i2c_period</span><span class="p">;</span>
	<span class="n">_i2c_nostop</span> <span class="o">=</span> <span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">i2c_nostop</span><span class="p">;</span>
	<span class="n">_i2c_reserve</span> <span class="o">=</span> <span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">i2c_reserve</span><span class="p">;</span>

	<span class="n">saddr_len</span> <span class="o">=</span> <span class="n">req_data</span><span class="o">-&gt;</span><span class="n">saddr_len</span><span class="p">;</span>

	<span class="cm">/* Set wValue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* need check saddr_len == 0  */</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span>
		    <span class="n">req_data</span><span class="o">-&gt;</span>
		    <span class="n">dev_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span> <span class="o">|</span> <span class="n">_i2c_period</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">saddr_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span>
		    <span class="n">_i2c_nostop</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">I2C_SYNC</span> <span class="o">|</span> <span class="n">_i2c_reserve</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span>
		    <span class="n">req_data</span><span class="o">-&gt;</span>
		    <span class="n">dev_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span> <span class="o">|</span> <span class="n">_i2c_period</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">saddr_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span>
		    <span class="n">_i2c_nostop</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">I2C_SYNC</span> <span class="o">|</span> <span class="n">_i2c_reserve</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="cm">/* set channel number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* channel number, for read,spec required channel_num +4 */</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>	<span class="cm">/* channel number,  */</span>

	<span class="cm">/* set index value */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">saddr_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ven_req</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* need check */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ven_req</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">saddr_dat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ven_req</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">req_data</span><span class="o">-&gt;</span><span class="n">saddr_dat</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set wLength value */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">req_data</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>

	<span class="cm">/* set bData value */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">bData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set the direction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ven_req</span><span class="p">.</span><span class="n">wLength</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>

	<span class="cm">/* set the buffer for read / write */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">pBuff</span> <span class="o">=</span> <span class="n">req_data</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">;</span>


	<span class="cm">/* call common vendor command request */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_send_vendor_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ven_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span>
		    <span class="p">(</span><span class="s">&quot;UsbInterface::sendCommand, failed with status -%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_send_usb_command</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Sends/Receives URB control messages, assuring to use a kalloced buffer</span>
<span class="cm"> * for all operations (dev-&gt;urb_buf), to avoid using stacked buffers, as</span>
<span class="cm"> * they aren&#39;t safe for usage with USB, due to DMA restrictions.</span>
<span class="cm"> * Also implements the debug code for control URB&#39;s.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__usb_control_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
	<span class="n">__u8</span> <span class="n">request</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">requesttype</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">index</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: (pipe 0x%08x): &quot;</span>
				<span class="s">&quot;%s:  %02x %02x %02x %02x %02x %02x %02x %02x &quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">pipe</span><span class="p">,</span>
				<span class="p">(</span><span class="n">requesttype</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
				<span class="n">requesttype</span><span class="p">,</span>
				<span class="n">request</span><span class="p">,</span>
				<span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				<span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				<span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">requesttype</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;&gt;&gt;&gt;&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
				       <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Do the real call to usb_control_msg */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctrl_urb_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">requesttype</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">urb_buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">requesttype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
			     <span class="n">index</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">urb_buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">requesttype</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">urb_buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctrl_urb_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">requesttype</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
				       <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cx231xx_read_ctrl_reg()</span>
<span class="cm"> * reads data from the usb device specifying bRequest and wValue</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">URB_MAX_CTRL_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_ONE_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_TWE_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_THREE_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_FOUR_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* invalid option */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
			      <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_send_vendor_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">VENDOR_REQUEST_IN</span> <span class="o">*</span><span class="n">ven_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unsend_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wLength</span> <span class="o">&gt;</span> <span class="n">URB_MAX_CTRL_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">)</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the cx23102 read more than 4 bytes with i2c bus,</span>
<span class="cm">	 * need chop to 4 byte per request</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wLength</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="mh">0x5</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="mh">0x6</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">unsend_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">pBuff</span><span class="p">;</span>


		<span class="n">unsend_size</span> <span class="o">=</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">;</span>

		<span class="cm">/* the first package */</span>
		<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&amp;</span> <span class="mh">0xFFFB</span><span class="p">;</span>
		<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&amp;</span> <span class="mh">0xFFBD</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">,</span>
			<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span>
			<span class="mh">0x0004</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">unsend_size</span> <span class="o">=</span> <span class="n">unsend_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* the middle package */</span>
		<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&amp;</span> <span class="mh">0xFFBD</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x42</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">unsend_size</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdata</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">,</span>
				<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
				<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span>
				<span class="mh">0x0004</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="n">unsend_size</span> <span class="o">=</span> <span class="n">unsend_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* the last package */</span>
		<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&amp;</span> <span class="mh">0xFFBD</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdata</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">,</span>
			<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span>
			<span class="n">unsend_size</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">,</span>
				<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
				<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">,</span>
				<span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">pBuff</span><span class="p">,</span> <span class="n">ven_req</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cx231xx_write_ctrl_reg()</span>
<span class="cm"> * sends data to the usb device, specifying bRequest</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">URB_MAX_CTRL_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_ONE_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_TWE_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_THREE_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ENABLE_FOUR_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* invalid option */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">byte</span><span class="p">;</span>

		<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;(pipe 0x%08x): &quot;</span>
			<span class="s">&quot;OUT: %02x %02x %02x %02x %02x %02x %02x %02x &gt;&gt;&gt;&quot;</span><span class="p">,</span>
			<span class="n">pipe</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">byte</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">byte</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">byte</span><span class="p">]);</span>
		<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
			      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************</span>
<span class="cm">*           USB Alternate Setting functions                     *</span>
<span class="cm">*****************************************************************/</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_video_alternate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errCode</span><span class="p">,</span> <span class="n">prev_alt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">usb_interface_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* When image size is bigger than a certain value,</span>
<span class="cm">	   the frame size should be increased, otherwise, only</span>
<span class="cm">	   green screen will be received.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">240</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">min_pkt_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* resolutions: 720,704,640 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* resolutions: 360,352,320,240 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* resolutions: 180,176,160,128,88 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Change to alt0 BULK to release USB bandwidth */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">USE_ISO</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;dev-&gt;video_mode.alt= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>

	<span class="cm">/* Get the correct video interface Index */</span>
	<span class="n">usb_interface_index</span> <span class="o">=</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">hs_config_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_info</span><span class="p">.</span>
	    <span class="n">video_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">!=</span> <span class="n">prev_alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;minimum isoc packet size: %u (alt=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">min_pkt_size</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">];</span>
		<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;setting alternate %d with wMaxPacketSize=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">max_pkt_size</span><span class="p">);</span>
		<span class="n">errCode</span> <span class="o">=</span>
		    <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_interface_index</span><span class="p">,</span>
				      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_errdev</span>
			    <span class="p">(</span><span class="s">&quot;cannot change alt number to %d (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_alt_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">alt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">usb_interface_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_pkt_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INDEX_TS1</span>:
		<span class="n">usb_interface_index</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">hs_config_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_info</span><span class="p">.</span>
		    <span class="n">ts1_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INDEX_TS2</span>:
		<span class="n">usb_interface_index</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">hs_config_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_info</span><span class="p">.</span>
		    <span class="n">ts2_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INDEX_AUDIO</span>:
		<span class="n">usb_interface_index</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">hs_config_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_info</span><span class="p">.</span>
		    <span class="n">audio_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">adev</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adev</span><span class="p">.</span><span class="n">alt_max_pkt_size</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">adev</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">adev</span><span class="p">.</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adev</span><span class="p">.</span><span class="n">alt</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INDEX_VIDEO</span>:
		<span class="n">usb_interface_index</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">hs_config_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_info</span><span class="p">.</span>
		    <span class="n">video_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span>
							     <span class="n">alt</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INDEX_VANC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">no_alt_vanc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">usb_interface_index</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">hs_config_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_info</span><span class="p">.</span>
		    <span class="n">vanc_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_mode</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_mode</span><span class="p">.</span><span class="n">alt</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INDEX_HANC</span>:
		<span class="n">usb_interface_index</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_pcb_config</span><span class="p">.</span><span class="n">hs_config_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_info</span><span class="p">.</span>
		    <span class="n">hanc_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sliced_cc_mode</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sliced_cc_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sliced_cc_mode</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sliced_cc_mode</span><span class="p">.</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span>
								 <span class="n">sliced_cc_mode</span><span class="p">.</span>
								 <span class="n">alt</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">max_pkt_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span>
		<span class="p">(</span><span class="s">&quot;can&#39;t change interface %d alt no. to %d: Max. Pkt size = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">usb_interface_index</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
		<span class="cm">/*To workaround error number=-71 on EP0 for videograbber,</span>
<span class="cm">		 need add following codes.*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">no_alt_vanc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;setting alternate %d with wMaxPacketSize=%u,&quot;</span>
			<span class="s">&quot;Interface = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">max_pkt_size</span><span class="p">,</span>
			<span class="n">usb_interface_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_interface_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_interface_index</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_errdev</span>
			<span class="p">(</span><span class="s">&quot;can&#39;t change interface %d alt no. to %d (err=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">usb_interface_index</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_set_alt_setting</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cx231xx_gpio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx231xx_reg_seq</span> <span class="o">*</span><span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Send GPIO reset sequences specified at board entry */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sleep</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cx231xx_set_gpio_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">bit</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sleep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">);</span>

		<span class="n">gpio</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_demod_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;Enter cx231xx_demod_reset()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
						<span class="n">PWR_CTL_EN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>



	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
				 <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;reg0x%x=0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PWR_CTL_EN</span><span class="p">,</span>
			<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_demod_reset</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">is_fw_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx231xx_check_fw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">is_fw_load</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cx231xx_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cx231xx_mode</span> <span class="n">set_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">set_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_mode</span> <span class="o">==</span> <span class="n">CX231XX_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the chip in power saving mode */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">set_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Resource is locked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">CX231XX_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">set_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CX231XX_DIGITAL_MODE</span><span class="p">)</span><span class="cm">/* Set Digital power mode */</span> <span class="p">{</span>
	<span class="cm">/* set AGC mode to Digital */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_CARRAERA</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_250</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_SHELBY</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_250</span>:
		<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_agc_analog_digital_mux_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_253S</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_253S</span>:
			<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_agc_analog_digital_mux_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_EXETER</span>:
			<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_power_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">POLARIS_AVMODE_DIGITAL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span><span class="cm">/* Set Analog Power mode */</span> <span class="p">{</span>
	<span class="cm">/* set AGC mode to Analog */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_CARRAERA</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_250</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_SHELBY</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_250</span>:
		<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_agc_analog_digital_mux_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_253S</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_253S</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_EXETER</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_PV_PLAYTV_USB_HYBRID</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL</span>:
		<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC</span>:
		<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_agc_analog_digital_mux_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">errCode</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_set_mode</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cx231xx_ep5_bulkout</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">firmware</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actlen</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;out of mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">firmware</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
			<span class="n">buffer</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actlen</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;bulk message failed: %d (%d/%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
				<span class="n">size</span><span class="p">,</span> <span class="n">actlen</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">errCode</span> <span class="o">=</span> <span class="n">actlen</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************</span>
<span class="cm">*                URB Streaming functions                         *</span>
<span class="cm">******************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * IRQ callback, called by URB callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx231xx_isoc_irq_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx_dmaqueue</span> <span class="o">*</span><span class="n">dma_q</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx231xx_video_mode</span> <span class="o">*</span><span class="n">vmode</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">dma_q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx231xx_video_mode</span><span class="p">,</span> <span class="n">vidq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vmode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx231xx</span><span class="p">,</span> <span class="n">video_mode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* success */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:	<span class="cm">/* NAK */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:	<span class="cm">/* kill */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* error */</span>
		<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;urb completition error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy data from URB */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">isoc_copy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">slock</span><span class="p">);</span>

	<span class="cm">/* Reset urb buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;urb resubmit failed (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************</span>
<span class="cm">*                URB Streaming functions                         *</span>
<span class="cm">******************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * IRQ callback, called by URB callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx231xx_bulk_irq_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx_dmaqueue</span> <span class="o">*</span><span class="n">dma_q</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx231xx_video_mode</span> <span class="o">*</span><span class="n">vmode</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">dma_q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx231xx_video_mode</span><span class="p">,</span> <span class="n">vidq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vmode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx231xx</span><span class="p">,</span> <span class="n">video_mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* success */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:	<span class="cm">/* NAK */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:	<span class="cm">/* kill */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* error */</span>
		<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;urb completition error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy data from URB */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">bulk_copy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">slock</span><span class="p">);</span>

	<span class="cm">/* Reset urb buffers */</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;urb resubmit failed (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Stop and Deallocate URBs</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cx231xx_uninit_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx_dmaqueue</span> <span class="o">*</span><span class="n">dma_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">vidq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;cx231xx: called cx231xx_uninit_isoc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">nfields</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">())</span>
				<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
						  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span>
						  <span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">p_left_data</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">num_bufs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">p_left_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_tv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Raw_Video</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TS1_serial_mode</span><span class="p">);</span>


<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_uninit_isoc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Stop and Deallocate URBs</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cx231xx_uninit_bulk</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cx231xx_isocdbg</span><span class="p">(</span><span class="s">&quot;cx231xx: called cx231xx_uninit_bulk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">nfields</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">())</span>
				<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span>
						<span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">num_bufs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_tv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Raw_Video</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TS1_serial_mode</span><span class="p">);</span>


<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_uninit_bulk</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate URBs and start IRQ</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cx231xx_init_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_packets</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_pkt_size</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">isoc_copy</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx_dmaqueue</span> <span class="o">*</span><span class="n">dma_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">vidq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sb_size</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* De-allocates all pending stuff */</span>
	<span class="n">cx231xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">p_left_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">p_left_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span><span class="p">(</span><span class="s">&quot;out of mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>



	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">isoc_copy</span> <span class="o">=</span> <span class="n">isoc_copy</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">num_bufs</span> <span class="o">=</span> <span class="n">num_bufs</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">is_partial_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">last_sav</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">current_field</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">field1_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">lines_per_field</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">bytes_left_in_line</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">lines_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">mpeg_buffer_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">left_data_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">mpeg_buffer_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">add_ps_package_head</span> <span class="o">=</span> <span class="n">CX231XX_NEED_ADD_PS_PACKAGE_HEAD</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBA</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">partial_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span> <span class="o">=</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;cannot alloc memory for usb buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span> <span class="o">=</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;cannot allocate memory for usbtransfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">max_pkt_size</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sb_size</span> <span class="o">=</span> <span class="n">max_packets</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">max_pkt_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_tv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">end_point_addr</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">end_point_addr</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>


	<span class="cm">/* allocate urbs and transfer buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">max_packets</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_err</span><span class="p">(</span><span class="s">&quot;cannot alloc isoc_ctl.urb %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">cx231xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">sb_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cx231xx_err</span><span class="p">(</span><span class="s">&quot;unable to allocate %i bytes for transfer&quot;</span>
				    <span class="s">&quot; buffer %i%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">sb_size</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				    <span class="n">in_interrupt</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot; while in int&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">cx231xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sb_size</span><span class="p">);</span>

		<span class="n">pipe</span> <span class="o">=</span>
		    <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">end_point_addr</span><span class="p">);</span>

		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				 <span class="n">sb_size</span><span class="p">,</span> <span class="n">cx231xx_isoc_irq_callback</span><span class="p">,</span> <span class="n">dma_q</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">max_packets</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span> <span class="o">|</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

		<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_packets</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">max_pkt_size</span><span class="p">;</span>
			<span class="n">k</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">max_pkt_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="cm">/* submit urbs and enables IRQ */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_err</span><span class="p">(</span><span class="s">&quot;submit of urb %i failed (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				    <span class="n">rc</span><span class="p">);</span>
			<span class="n">cx231xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_tv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Raw_Video</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TS1_serial_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_init_isoc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate URBs and start IRQ</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cx231xx_init_bulk</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_packets</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_pkt_size</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bulk_copy</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx231xx_dmaqueue</span> <span class="o">*</span><span class="n">dma_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">vidq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sb_size</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span><span class="p">;</span>

	<span class="n">cx231xx_coredbg</span><span class="p">(</span><span class="s">&quot;Setting Video mux to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span><span class="p">);</span>

	<span class="n">video_mux</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_input</span><span class="p">);</span>

	<span class="cm">/* De-allocates all pending stuff */</span>
	<span class="n">cx231xx_uninit_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">bulk_copy</span> <span class="o">=</span> <span class="n">bulk_copy</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">num_bufs</span> <span class="o">=</span> <span class="n">num_bufs</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">is_partial_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">last_sav</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">current_field</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">field1_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">lines_per_field</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">bytes_left_in_line</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">lines_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">mpeg_buffer_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">left_data_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">mpeg_buffer_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">ps_head</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBA</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">partial_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span> <span class="o">=</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;cannot alloc memory for usb buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span> <span class="o">=</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;cannot allocate memory for usbtransfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">max_pkt_size</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sb_size</span> <span class="o">=</span> <span class="n">max_packets</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">max_pkt_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_tv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">end_point_addr</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">end_point_addr</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>


	<span class="cm">/* allocate urbs and transfer buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_err</span><span class="p">(</span><span class="s">&quot;cannot alloc bulk_ctl.urb %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">cx231xx_uninit_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">sb_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cx231xx_err</span><span class="p">(</span><span class="s">&quot;unable to allocate %i bytes for transfer&quot;</span>
				    <span class="s">&quot; buffer %i%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">sb_size</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				    <span class="n">in_interrupt</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot; while in int&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">cx231xx_uninit_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sb_size</span><span class="p">);</span>

		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">end_point_addr</span><span class="p">);</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				  <span class="n">sb_size</span><span class="p">,</span> <span class="n">cx231xx_bulk_irq_callback</span><span class="p">,</span> <span class="n">dma_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="cm">/* submit urbs and enables IRQ */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_mode</span><span class="p">.</span><span class="n">bulk_ctl</span><span class="p">.</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_err</span><span class="p">(</span><span class="s">&quot;submit of urb %i failed (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				    <span class="n">rc</span><span class="p">);</span>
			<span class="n">cx231xx_uninit_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_tv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Raw_Video</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cx231xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TS1_serial_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_init_bulk</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">cx231xx_stop_TS1</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
			<span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
			<span class="n">TS1_CFG_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* EXPORT_SYMBOL_GPL(cx231xx_stop_TS1); */</span>
<span class="kt">void</span> <span class="nf">cx231xx_start_TS1</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
			<span class="n">TS_MODE_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA3</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3B</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span>
			<span class="n">TS1_CFG_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* EXPORT_SYMBOL_GPL(cx231xx_start_TS1); */</span>
<span class="cm">/*****************************************************************</span>
<span class="cm">*             Device Init/UnInit functions                       *</span>
<span class="cm">******************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize I2C bus */</span>

	<span class="cm">/* External Master 1 Bus */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_period</span> <span class="o">=</span> <span class="n">I2C_SPEED_100K</span><span class="p">;</span>	<span class="cm">/* 100 KHz */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_nostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_reserve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* External Master 2 Bus */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_period</span> <span class="o">=</span> <span class="n">I2C_SPEED_100K</span><span class="p">;</span>	<span class="cm">/* 100 KHz */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_nostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_reserve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Internal Master 3 Bus */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">i2c_period</span> <span class="o">=</span> <span class="n">I2C_SPEED_100K</span><span class="p">;</span>	<span class="cm">/* 100kHz */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">i2c_nostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">i2c_reserve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* register I2C buses */</span>
	<span class="n">cx231xx_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">cx231xx_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">cx231xx_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="cm">/* init hardware */</span>
	<span class="cm">/* Note : with out calling set power mode function,</span>
<span class="cm">	afe can not be set up correctly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">external_av</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_power_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">POLARIS_AVMODE_ENXTERNAL_AV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_errdev</span>
			<span class="p">(</span><span class="s">&quot;%s: Failed to set Power - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_power_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">POLARIS_AVMODE_ANALOGT_TV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx231xx_errdev</span>
			<span class="p">(</span><span class="s">&quot;%s: Failed to set Power - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* reset the Tuner, if it is a Xceive tuner */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_XC5000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_XC2028</span><span class="p">))</span>
			<span class="n">cx231xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">tuner_gpio</span><span class="p">);</span>

	<span class="cm">/* initialize Colibri block */</span>
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_afe_init_super_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x23c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span>
		    <span class="p">(</span><span class="s">&quot;%s: cx231xx_afe init super block - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_afe_init_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span>
		    <span class="p">(</span><span class="s">&quot;%s: cx231xx_afe init channels - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set DIF in By pass mode */</span>
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_dif_set_standard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIF_USE_BASEBAND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span>
		    <span class="p">(</span><span class="s">&quot;%s: cx231xx_dif set to By pass mode - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* I2S block related functions */</span>
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_i2s_blk_initialize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span>
		    <span class="p">(</span><span class="s">&quot;%s: cx231xx_i2s block initialize - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init control pins */</span>
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_init_ctrl_pin_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span><span class="p">(</span><span class="s">&quot;%s: cx231xx_init ctrl pins - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set AGC mode to Analog */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_CARRAERA</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_250</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_SHELBY</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_250</span>:
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_agc_analog_digital_mux_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDE_253S</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_CNXT_RDU_253S</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_EXETER</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_PV_PLAYTV_USB_HYBRID</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL</span>:
	<span class="k">case</span> <span class="n">CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC</span>:
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_set_agc_analog_digital_mux_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_errdev</span>
		    <span class="p">(</span><span class="s">&quot;%s: cx231xx_AGC mode to Analog - errCode [%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set all alternate settings to zero initially */</span>
	<span class="n">cx231xx_set_alt_setting</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INDEX_VIDEO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx231xx_set_alt_setting</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INDEX_VANC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx231xx_set_alt_setting</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INDEX_HANC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">has_dvb</span><span class="p">)</span>
		<span class="n">cx231xx_set_alt_setting</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INDEX_TS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set the I2C master port to 3 on channel 1 */</span>
	<span class="n">errCode</span> <span class="o">=</span> <span class="n">cx231xx_enable_i2c_port_3</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_dev_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cx231xx_dev_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Un Initialize I2C bus */</span>
	<span class="n">cx231xx_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">cx231xx_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">cx231xx_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_dev_uninit</span><span class="p">);</span>

<span class="cm">/*****************************************************************</span>
<span class="cm">*              G P I O related functions                         *</span>
<span class="cm">******************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_send_gpio_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio_bit</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">gpio_val</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">request</span><span class="p">,</span> <span class="n">u8</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">VENDOR_REQUEST_IN</span> <span class="n">ven_req</span><span class="p">;</span>

	<span class="cm">/* Set wValue */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">gpio_bit</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* set request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span>
			<span class="n">ven_req</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">VRT_GET_GPIO</span><span class="p">;</span>	<span class="cm">/* 0x8 gpio */</span>
		<span class="k">else</span>
			<span class="n">ven_req</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">VRT_SET_GPIO</span><span class="p">;</span>	<span class="cm">/* 0x9 gpio */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span>
			<span class="n">ven_req</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">VRT_GET_GPIE</span><span class="p">;</span>	<span class="cm">/* 0xa gpie */</span>
		<span class="k">else</span>
			<span class="n">ven_req</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">VRT_SET_GPIE</span><span class="p">;</span>	<span class="cm">/* 0xb gpie */</span>
	<span class="p">}</span>

	<span class="cm">/* set index value */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">gpio_bit</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* set wLength value */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* set bData value */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">bData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set the buffer for read / write */</span>
	<span class="n">ven_req</span><span class="p">.</span><span class="n">pBuff</span> <span class="o">=</span> <span class="n">gpio_val</span><span class="p">;</span>

	<span class="cm">/* set the direction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ven_req</span><span class="p">.</span><span class="n">pBuff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ven_req</span><span class="p">.</span><span class="n">wLength</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ven_req</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>


	<span class="cm">/* call common vendor command request */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_send_vendor_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ven_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx231xx_info</span>
		    <span class="p">(</span><span class="s">&quot;UsbInterface::sendCommand, failed with status -%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cx231xx_send_gpio_cmd</span><span class="p">);</span>

<span class="cm">/*****************************************************************</span>
<span class="cm"> *    C O N T R O L - Register R E A D / W R I T E functions     *</span>
<span class="cm"> *****************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_mode_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">cx231xx_read_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_GET_REGISTER</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">cx231xx_write_ctrl_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VRT_SET_REGISTER</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************</span>
<span class="cm"> *            I 2 C Internal C O N T R O L   functions           *</span>
<span class="cm"> *****************************************************************/</span>
<span class="kt">int</span> <span class="nf">cx231xx_read_i2c_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">saddr_len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx231xx_i2c_xfer_data</span> <span class="n">req_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* prepare xfer_data struct */</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">dev_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_len</span> <span class="o">=</span> <span class="n">saddr_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_dat</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">p_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* usb send command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy the data read back to main buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span>
			    <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
			    <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">saddr</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_write_i2c_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">saddr_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">cx231xx_i2c_xfer_data</span> <span class="n">req_data</span><span class="p">;</span>

	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* prepare xfer_data struct */</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">dev_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_len</span> <span class="o">=</span> <span class="n">saddr_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_dat</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">p_buffer</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* usb send command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				 <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				 <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_read_i2c_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">saddr_len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx231xx_i2c_xfer_data</span> <span class="n">req_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* prepare xfer_data struct */</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">dev_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_len</span> <span class="o">=</span> <span class="n">saddr_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_dat</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">p_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* usb send command */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy the data read back to main buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span>
			    <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
			    <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_write_i2c_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">saddr_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">cx231xx_i2c_xfer_data</span> <span class="n">req_data</span><span class="p">;</span>

	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">saddr_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">saddr</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* prepare xfer_data struct */</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">dev_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_len</span> <span class="o">=</span> <span class="n">saddr_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">saddr_dat</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">req_data</span><span class="p">.</span><span class="n">p_buffer</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* usb send command */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx231xx_send_usb_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">req_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_reg_mask_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">size</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">register_address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit_start</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit_end</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bit_start</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">bit_end</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">register_address</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">register_address</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit_end</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">bit_end</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">bit_start</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">value</span> <span class="o">&lt;&lt;=</span> <span class="n">bit_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">register_address</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
					   <span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">register_address</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
					   <span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx231xx_read_modify_write_i2c_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx231xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_addr</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_read_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cx231xx_write_i2c_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">cx231xx_set_field</span><span class="p">(</span><span class="n">u32</span> <span class="n">field_mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">field_mask</span><span class="p">;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
