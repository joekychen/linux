<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › omap › omap_vout.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>omap_vout.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * omap_vout.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2010 Texas Instruments.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public License</span>
<span class="cm"> * version 2. This program is licensed &quot;as is&quot; without any warranty of any</span>
<span class="cm"> * kind, whether express or implied.</span>
<span class="cm"> *</span>
<span class="cm"> * Leveraged code from the OMAP2 camera driver</span>
<span class="cm"> * Video-for-Linux (Version 2) camera capture driver for</span>
<span class="cm"> * the OMAP24xx camera controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Andy Lowe (source@mvista.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 MontaVista Software, Inc.</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments.</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> * 20-APR-2006 Khasim		Modified VRFB based Rotation,</span>
<span class="cm"> *				The image data is always read from 0 degree</span>
<span class="cm"> *				view and written</span>
<span class="cm"> *				to the virtual space of desired rotation angle</span>
<span class="cm"> * 4-DEC-2006  Jian		Changed to support better memory management</span>
<span class="cm"> *</span>
<span class="cm"> * 17-Nov-2008 Hardik		Changed driver to use video_ioctl2</span>
<span class="cm"> *</span>
<span class="cm"> * 23-Feb-2010 Vaibhav H	Modified to use new DSS2 interface</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;media/videobuf-dma-contig.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="cp">#include &lt;plat/dma.h&gt;</span>
<span class="cp">#include &lt;plat/vrfb.h&gt;</span>
<span class="cp">#include &lt;video/omapdss.h&gt;</span>

<span class="cp">#include &quot;omap_voutlib.h&quot;</span>
<span class="cp">#include &quot;omap_voutdef.h&quot;</span>
<span class="cp">#include &quot;omap_vout_vrfb.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP Video for Linux Video out driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* Driver Configuration macros */</span>
<span class="cp">#define VOUT_NAME		&quot;omap_vout&quot;</span>

<span class="k">enum</span> <span class="n">omap_vout_channels</span> <span class="p">{</span>
	<span class="n">OMAP_VIDEO1</span><span class="p">,</span>
	<span class="n">OMAP_VIDEO2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">video_vbq_ops</span><span class="p">;</span>
<span class="cm">/* Variables configurable through module params*/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">video1_numbuffers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">video2_numbuffers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">video1_bufsize</span> <span class="o">=</span> <span class="n">OMAP_VOUT_MAX_BUF_SIZE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">video2_bufsize</span> <span class="o">=</span> <span class="n">OMAP_VOUT_MAX_BUF_SIZE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">vid1_static_vrfb_alloc</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">vid2_static_vrfb_alloc</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="cm">/* Module parameters */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video1_numbuffers</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video1_numbuffers</span><span class="p">,</span>
	<span class="s">&quot;Number of buffers to be allocated at init time for Video1 device.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">video2_numbuffers</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video2_numbuffers</span><span class="p">,</span>
	<span class="s">&quot;Number of buffers to be allocated at init time for Video2 device.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">video1_bufsize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video1_bufsize</span><span class="p">,</span>
	<span class="s">&quot;Size of the buffer to be allocated for video1 device&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">video2_bufsize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video2_bufsize</span><span class="p">,</span>
	<span class="s">&quot;Size of the buffer to be allocated for video2 device&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">vid1_static_vrfb_alloc</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vid1_static_vrfb_alloc</span><span class="p">,</span>
	<span class="s">&quot;Static allocation of the VRFB buffer for video1 device&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">vid2_static_vrfb_alloc</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vid2_static_vrfb_alloc</span><span class="p">,</span>
	<span class="s">&quot;Static allocation of the VRFB buffer for video2 device&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-1)&quot;</span><span class="p">);</span>

<span class="cm">/* list of image formats supported by OMAP2 video pipelines */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="n">omap_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* Note:  V4L2 defines RGB565 as:</span>
<span class="cm">		 *</span>
<span class="cm">		 *      Byte 0                    Byte 1</span>
<span class="cm">		 *      g2 g1 g0 r4 r3 r2 r1 r0   b4 b3 b2 b1 b0 g5 g4 g3</span>
<span class="cm">		 *</span>
<span class="cm">		 * We interpret RGB565 as:</span>
<span class="cm">		 *</span>
<span class="cm">		 *      Byte 0                    Byte 1</span>
<span class="cm">		 *      g2 g1 g0 b4 b3 b2 b1 b0   r4 r3 r2 r1 r0 g5 g4 g3</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;RGB565, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Note:  V4L2 defines RGB32 as: RGB-8-8-8-8  we use</span>
<span class="cm">		 *  this for RGB24 unpack mode, the last 8 bits are ignored</span>
<span class="cm">		 * */</span>
		<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;RGB32, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB32</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Note:  V4L2 defines RGB24 as: RGB-8-8-8  we use</span>
<span class="cm">		 *        this for RGB24 packed mode</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;RGB24, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;YUYV (YUV 4:2:2), packed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;UYVY, packed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_OUTPUT_FORMATS (ARRAY_SIZE(omap_formats))</span>

<span class="cm">/*</span>
<span class="cm"> * Try format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ifmt</span><span class="p">,</span> <span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">VID_MIN_HEIGHT</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">VID_MAX_HEIGHT</span><span class="p">);</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">VID_MIN_WIDTH</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">VID_MAX_WIDTH</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ifmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ifmt</span> <span class="o">&lt;</span> <span class="n">NUM_OUTPUT_FORMATS</span><span class="p">;</span> <span class="n">ifmt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">ifmt</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifmt</span> <span class="o">==</span> <span class="n">NUM_OUTPUT_FORMATS</span><span class="p">)</span>
		<span class="n">ifmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">ifmt</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_YUYV</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_UYVY</span>:
	<span class="nl">default:</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">YUYV_BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565X</span>:
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">RGB565_BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">RGB24_BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_BGR32</span>:
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">RGB32_BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bpp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap_vout_uservirt_to_phys: This inline function is used to convert user</span>
<span class="cm"> * space virtual address to physical address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">omap_vout_uservirt_to_phys</span><span class="p">(</span><span class="n">u32</span> <span class="n">virtp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>

	<span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">virtp</span><span class="p">);</span>
	<span class="cm">/* For kernel direct-mapped memory, take the easy way */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virtp</span> <span class="o">&gt;=</span> <span class="n">PAGE_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">physp</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">virtp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this will catch, kernel-allocated, mmaped-to-usermode</span>
<span class="cm">		   addresses */</span>
		<span class="n">physp</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">virtp</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* otherwise, use get_user_pages() for general userland pages */</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">nr_pages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">virtp</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">physp</span> <span class="o">=</span>  <span class="n">__pa</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">virtp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">VOUT_NAME</span>
					<span class="s">&quot;get_user_pages failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">physp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free the V4L2 buffers</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap_vout_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">numbuffers</span><span class="p">;</span>

	<span class="cm">/* Allocate memory for the buffers */</span>
	<span class="n">numbuffers</span> <span class="o">=</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">)</span> <span class="o">?</span>  <span class="n">video2_numbuffers</span> <span class="o">:</span> <span class="n">video1_numbuffers</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">)</span> <span class="o">?</span> <span class="n">video2_bufsize</span> <span class="o">:</span> <span class="n">video1_bufsize</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numbuffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_vout_free_buffer</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert V4L2 rotation to DSS rotation</span>
<span class="cm"> *	V4L2 understand 0, 90, 180, 270.</span>
<span class="cm"> *	Convert to 0, 1, 2 and 3 respectively for DSS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">v4l2_rot_to_dss_rot</span><span class="p">(</span><span class="kt">int</span> <span class="n">v4l2_rotation</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">dss_rotation</span> <span class="o">*</span><span class="n">rotation</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mirror</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">v4l2_rotation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">90</span>:
		<span class="o">*</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">dss_rotation_90_degree</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">180</span>:
		<span class="o">*</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">dss_rotation_180_degree</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">270</span>:
		<span class="o">*</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">dss_rotation_270_degree</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="o">*</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">dss_rotation_0_degree</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_calculate_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">cropped_offset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cropped_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">line_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_vout_calculate_vrfb_offset</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">line_length</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_PIX_FMT_YUYV</span> <span class="o">==</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">||</span>
			<span class="n">V4L2_PIX_FMT_UYVY</span> <span class="o">==</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_PIX_FMT_RGB32</span> <span class="o">==</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_PIX_FMT_RGB24</span> <span class="o">==</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span><span class="p">;</span>

		<span class="o">*</span><span class="n">cropped_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">ps</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;%s Offset:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">cropped_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert V4L2 pixel format to DSS pixel format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_mode_to_dss_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_YUYV</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_YUV2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_UYVY</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB24P</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">OMAP_DSS_VIDEO1</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">OMAP_DSS_COLOR_RGB24U</span> <span class="o">:</span> <span class="n">OMAP_DSS_COLOR_ARGB32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_BGR32</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGBX32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup the overlay</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapvid_setup_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">outw</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">outh</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cropheight</span><span class="p">,</span> <span class="n">cropwidth</span><span class="p">,</span> <span class="n">pixheight</span><span class="p">,</span> <span class="n">pixwidth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_SCALE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">outw</span> <span class="o">!=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="n">outh</span> <span class="o">!=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">setup_ovl_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">dss_mode</span> <span class="o">=</span> <span class="n">video_mode_to_dss_mode</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dss_mode</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">setup_ovl_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the input plane parameters according to</span>
<span class="cm">	 * rotation value selected.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_rotation_90_or_270</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cropheight</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">cropwidth</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">pixheight</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">pixwidth</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cropheight</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">cropwidth</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">pixheight</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">pixwidth</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">get_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">cropwidth</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">cropheight</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">dss_mode</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">pos_x</span> <span class="o">=</span> <span class="n">posx</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">pos_y</span> <span class="o">=</span> <span class="n">posy</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_width</span> <span class="o">=</span> <span class="n">outw</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_height</span> <span class="o">=</span> <span class="n">outh</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_rotation_enabled</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">rotation_type</span> <span class="o">=</span> <span class="n">OMAP_DSS_ROT_DMA</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">screen_width</span> <span class="o">=</span> <span class="n">pixwidth</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">rotation_type</span> <span class="o">=</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">screen_width</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;%s enable=%d addr=%x width=%d</span><span class="se">\n</span><span class="s"> height=%d color_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;rotation=%d mirror=%d posx=%d posy=%d out_width = %d </span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;out_height=%d rotation_type=%d screen_width=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">ovl</span><span class="p">),</span> <span class="n">info</span><span class="p">.</span><span class="n">paddr</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		<span class="n">info</span><span class="p">.</span><span class="n">color_mode</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">rotation</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">mirror</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">pos_x</span><span class="p">,</span>
		<span class="n">info</span><span class="p">.</span><span class="n">pos_y</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">out_width</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">out_height</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">rotation_type</span><span class="p">,</span>
		<span class="n">info</span><span class="p">.</span><span class="n">screen_width</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">set_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">setup_ovl_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">setup_ovl_err:</span>
	<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;setup_overlay failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the overlay structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapvid_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">win</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">,</span> <span class="n">outw</span><span class="p">,</span> <span class="n">outh</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>

		<span class="n">outw</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">outh</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">dss_rotation_90_degree</span>:
			<span class="cm">/* Invert the height and width for 90</span>
<span class="cm">			 * and 270 degree rotation</span>
<span class="cm">			 */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">outw</span><span class="p">;</span>
			<span class="n">outw</span> <span class="o">=</span> <span class="n">outh</span><span class="p">;</span>
			<span class="n">outh</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">posy</span> <span class="o">=</span> <span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
			<span class="n">posx</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">dss_rotation_180_degree</span>:
			<span class="n">posx</span> <span class="o">=</span> <span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
			<span class="n">posy</span> <span class="o">=</span> <span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">dss_rotation_270_degree</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">outw</span><span class="p">;</span>
			<span class="n">outw</span> <span class="o">=</span> <span class="n">outh</span><span class="p">;</span>
			<span class="n">outh</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">posy</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
			<span class="n">posx</span> <span class="o">=</span> <span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">posx</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
			<span class="n">posy</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_setup_overlay</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span> <span class="n">ovl</span><span class="p">,</span> <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">,</span>
				<span class="n">outw</span><span class="p">,</span> <span class="n">outh</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">omapvid_init_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">omapvid_init_err:</span>
	<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;apply_changes failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Apply the changes set the go bit of DSS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapvid_apply_changes</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">apply</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapvid_handle_interlace_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="n">timevalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">first_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">first_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">DISPC_IRQ_EVSYNC_ODD</span><span class="p">)</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">DISPC_IRQ_EVSYNC_EVEN</span><span class="p">)</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">field_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">==</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">ts</span> <span class="o">=</span> <span class="n">timevalue</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">!=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">field_id</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">mgr_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">timevalue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">cur_display</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/* get the display device attached to the overlay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mgr_id</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cur_display</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq_lock</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timevalue</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cur_display</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DISPLAY_TYPE_DSI</span>:
	<span class="k">case</span> <span class="n">OMAP_DISPLAY_TYPE_DPI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr_id</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">)</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VSYNC</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mgr_id</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VSYNC2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">vout_isr_err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">irq</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">vout_isr_err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DISPLAY_TYPE_VENC</span>:
		<span class="n">fid</span> <span class="o">=</span> <span class="n">omapvid_handle_interlace_display</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">,</span>
				<span class="n">timevalue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">vout_isr_err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DISPLAY_TYPE_HDMI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">DISPC_IRQ_EVSYNC_EVEN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">vout_isr_err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">vout_isr_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">first_int</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">!=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">ts</span> <span class="o">=</span> <span class="n">timevalue</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">first_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">vout_isr_err</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">queued_buf_addr</span><span class="p">[</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">]</span>
		<span class="o">+</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">cropped_offset</span><span class="p">;</span>

	<span class="cm">/* First save the configuration in ovelray structure */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_init</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">VOUT_NAME</span>
			<span class="s">&quot;failed to set overlay info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Enable the pipeline and set the Go bit */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_apply_changes</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">VOUT_NAME</span> <span class="s">&quot;failed to change mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">vout_isr_err:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Video buffer call backs */</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer setup function is called by videobuf layer when REQBUF ioctl is</span>
<span class="cm"> * called. This is used to setup buffers and return size and count of</span>
<span class="cm"> * buffers allocated. After the call to this buffer, videobuf layer will</span>
<span class="cm"> * setup buffer queue depending on the size and count of buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_buffer_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">startindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">virt_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vid_max_buf_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vid_max_buf_size</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">==</span> <span class="n">OMAP_VIDEO1</span> <span class="o">?</span> <span class="n">video1_bufsize</span> <span class="o">:</span>
		<span class="n">video2_bufsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">startindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">==</span> <span class="n">OMAP_VIDEO1</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">video1_numbuffers</span> <span class="o">:</span> <span class="n">video2_numbuffers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">==</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">startindex</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">startindex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_vout_vrfb_buffer_setup</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">startindex</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">!=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Now allocated the V4L2 buffers */</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">);</span>
	<span class="n">startindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">==</span> <span class="n">OMAP_VIDEO1</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">video1_numbuffers</span> <span class="o">:</span> <span class="n">video2_numbuffers</span><span class="p">;</span>

	<span class="cm">/* Check the size of the buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">vid_max_buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;buffer allocation mismatch [%u] [%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">startindex</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>

		<span class="n">virt_addr</span> <span class="o">=</span> <span class="n">omap_vout_alloc_buffer</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">phy_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">virt_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_rotation_enabled</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Free the VRFB buffers if no space for V4L2 buffers */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">omap_vout_free_buffer</span><span class="p">(</span>
						<span class="n">vout</span><span class="o">-&gt;</span><span class="n">smsshado_virt_addr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						<span class="n">vout</span><span class="o">-&gt;</span><span class="n">smsshado_size</span><span class="p">);</span>
				<span class="n">vout</span><span class="o">-&gt;</span><span class="n">smsshado_virt_addr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">vout</span><span class="o">-&gt;</span><span class="n">smsshado_phy_addr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_addr</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free the V4L2 buffers additionally allocated than default</span>
<span class="cm"> * number of buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_free_extra_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_buffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">num_buffers</span> <span class="o">=</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">==</span> <span class="n">OMAP_VIDEO1</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">video1_numbuffers</span> <span class="o">:</span> <span class="n">video2_numbuffers</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">omap_vout_free_buffer</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">num_buffers</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function will be called when VIDIOC_QBUF ioctl is called.</span>
<span class="cm"> * It prepare buffers before give out for the display. This function</span>
<span class="cm"> * converts user space virtual address into physical address if userptr memory</span>
<span class="cm"> * exchange mechanism is used. If rotation is enabled, it copies entire</span>
<span class="cm"> * buffer into VRFB memory space before giving it to the DSS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="cm">/* if user pointer memory mechanism is used, get the physical</span>
<span class="cm">	 * address of the buffer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">==</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">baddr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Physical address */</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">queued_buf_addr</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">omap_vout_uservirt_to_phys</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">baddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">];</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span>
				<span class="n">size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">))</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;dma_map_single failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">queued_buf_addr</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">omap_vout_prepare_vrfb</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer queue function will be called from the videobuf layer when _QBUF</span>
<span class="cm"> * ioctl is called. It is used to enqueue buffer, which is ready to be</span>
<span class="cm"> * displayed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="cm">/* Driver is also maintainig a queue. So enqueue buffer in the driver</span>
<span class="cm">	 * queue */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">);</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer release function is called from videobuf layer to release buffer</span>
<span class="cm"> * which are already allocated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">!=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  File operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">omap_vout_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_vm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;vm_open [vma=%08lx-%08lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">);</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_vm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		<span class="s">&quot;vm_close [vma=%08lx-%08lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">);</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">omap_vout_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>	<span class="o">=</span> <span class="n">omap_vout_vm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>	<span class="o">=</span> <span class="n">omap_vout_vm_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="s">&quot; %s pgoff=0x%lx, start=0x%lx, end=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">);</span>

	<span class="cm">/* look for the buffer to map */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VIDEO_MAX_FRAME</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">boff</span> <span class="o">==</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEO_MAX_FRAME</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;offset invalid [offset=0x%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check the size of the buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;insufficient memory [%lu] [%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">size</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">baddr</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_RESERVED</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span> <span class="o">=</span> <span class="n">pgprot_writecombine</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_vout_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">vout</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SHARED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Exiting %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Entering %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>
	<span class="cm">/* Disable all the overlay managers connected with this interface */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Turn off the pipeline */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_apply_changes</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to apply changes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Free all buffers */</span>
	<span class="n">omap_vout_free_extra_buffers</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>

	<span class="cm">/* Free the VRFB buffers only if they are allocated</span>
<span class="cm">	 * during reqbufs.  Don&#39;t free if init time allocated</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vrfb_static_allocation</span><span class="p">)</span>
			<span class="n">omap_vout_free_vrfb_buffers</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="cm">/* Even if apply changes fails we should continue</span>
<span class="cm">	   freeing allocated memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VSYNC</span> <span class="o">|</span> <span class="n">DISPC_IRQ_EVSYNC_EVEN</span> <span class="o">|</span>
			<span class="n">DISPC_IRQ_EVSYNC_ODD</span> <span class="o">|</span> <span class="n">DISPC_IRQ_VSYNC2</span><span class="p">;</span>
		<span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">omap_vout_isr</span><span class="p">,</span> <span class="n">vout</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">videobuf_streamoff</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="n">videobuf_queue_cancel</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">mmap_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">mmap_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span><span class="p">)</span>
		<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Exiting %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vout</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Entering %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* for now, we only support single open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">vout</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>
	<span class="n">video_vbq_ops</span><span class="p">.</span><span class="n">buf_setup</span> <span class="o">=</span> <span class="n">omap_vout_buffer_setup</span><span class="p">;</span>
	<span class="n">video_vbq_ops</span><span class="p">.</span><span class="n">buf_prepare</span> <span class="o">=</span> <span class="n">omap_vout_buffer_prepare</span><span class="p">;</span>
	<span class="n">video_vbq_ops</span><span class="p">.</span><span class="n">buf_release</span> <span class="o">=</span> <span class="n">omap_vout_buffer_release</span><span class="p">;</span>
	<span class="n">video_vbq_ops</span><span class="p">.</span><span class="n">buf_queue</span> <span class="o">=</span> <span class="n">omap_vout_buffer_queue</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq_lock</span><span class="p">);</span>

	<span class="n">videobuf_queue_dma_contig_init</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_vbq_ops</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq_lock</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">),</span> <span class="n">vout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Exiting %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * V4L2 ioctls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">VOUT_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_STREAMING</span> <span class="o">|</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_VIDEO_OUTPUT_OVERLAY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">NUM_OUTPUT_FORMATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">description</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* get the display device attached to the overlay */</span>
	<span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>

	<span class="n">omap_vout_try_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* get the display device attached to the overlay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">s_fmt_vid_out_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>

	<span class="cm">/* We dont support RGB24-packed mode if vrfb rotation</span>
<span class="cm">	 * is enabled*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">is_rotation_enabled</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">s_fmt_vid_out_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the framebuffer parameters */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_rotation_90_or_270</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* change to samller size is OK */</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">omap_vout_try_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="cm">/* try &amp; set the new output format */</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vrfb_bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If YUYV then vrfb bpp is 2, for  others its 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_PIX_FMT_YUYV</span> <span class="o">==</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">||</span>
			<span class="n">V4L2_PIX_FMT_UYVY</span> <span class="o">==</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vrfb_bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* set default crop and win */</span>
	<span class="n">omap_vout_new_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">);</span>

	<span class="cm">/* Save the changes in the overlay strcuture */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_init</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;failed to change mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">s_fmt_vid_out_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">s_fmt_vid_out_exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_vout_try_window</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_GLOBAL_ALPHA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_vout_new_window</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Video1 plane does not support global alpha on OMAP3 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_GLOBAL_ALPHA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span><span class="p">;</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">chromakey</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">chromakey</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">NUM_OUTPUT_FORMATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">description</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">omap_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">key_value</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_manager_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">key_value</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">trans_key</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">chromakey</span> <span class="o">=</span> <span class="n">key_value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cropcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Width and height are always even */</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">omap_vout_default_crop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">);</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">s_crop_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* get the display device attached to the overlay */</span>
	<span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_rotation_90_or_270</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_vout_new_crop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">);</span>

<span class="nl">s_crop_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ROTATE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BG_COLOR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFFFFFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ROTATE</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BG_COLOR</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay_manager_info</span> <span class="n">info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>

		<span class="n">ovl</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">default_color</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ROTATE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rotation</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

		<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">&amp;&amp;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">&amp;&amp;</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_rot_to_dss_rot</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">,</span>
							<span class="n">vout</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BG_COLOR</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">color</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_overlay_manager_info</span> <span class="n">info</span><span class="p">;</span>

		<span class="n">ovl</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">||</span> <span class="o">!</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">default_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">mirror</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

		<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
		<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mirror</span> <span class="o">&amp;&amp;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mirror</span>  <span class="o">&amp;&amp;</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_buffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* if memory is not mmp or userptr</span>
<span class="cm">	   return error */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Cannot be requested when streaming is on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reqbuf_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If buffers are already allocated free them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">V4L2_MEMORY_MMAP</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reqbuf_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">num_buffers</span> <span class="o">=</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">==</span> <span class="n">OMAP_VIDEO1</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">video1_numbuffers</span> <span class="o">:</span> <span class="n">video2_numbuffers</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">num_buffers</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_vout_free_buffer</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">num_buffers</span><span class="p">;</span>
		<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*store the memory type in data structure */</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">);</span>

	<span class="cm">/* call videobuf_reqbufs api */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reqbuf_err</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

<span class="nl">reqbuf_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">!=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_allocated</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_MEMORY_USERPTR</span> <span class="o">==</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">is_rotation_enabled</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vrfb_dma_tx</span><span class="p">.</span><span class="n">req_status</span> <span class="o">==</span> <span class="n">DMA_CHAN_NOT_ALLOTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;DMA Channel not allocated for Rotation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">;</span>

	<span class="n">vb</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
		<span class="cm">/* Call videobuf_dqbuf for non blocking mode */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Call videobuf_dqbuf for  blocking mode */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">];</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>  <span class="n">addr</span><span class="p">,</span>
				<span class="n">size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">streamon_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">streamon_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">streamon_err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the next frame from the buffer queue */</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">next_frm</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Remove buffer from the buffer queue */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* Mark state of the current frame to active */</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
	<span class="cm">/* Initialize field_id and started member */</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">field_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set flag here. Next QBUF will start DMA */</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">first_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_vout_calculate_offset</span><span class="p">(</span><span class="n">vout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">streamon_err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">queued_buf_addr</span><span class="p">[</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">cur_frm</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">]</span>
		<span class="o">+</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">cropped_offset</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VSYNC</span> <span class="o">|</span> <span class="n">DISPC_IRQ_EVSYNC_EVEN</span> <span class="o">|</span> <span class="n">DISPC_IRQ_EVSYNC_ODD</span>
		<span class="o">|</span> <span class="n">DISPC_IRQ_VSYNC2</span><span class="p">;</span>

	<span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">omap_vout_isr</span><span class="p">,</span> <span class="n">vout</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="n">info</span><span class="p">;</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">get_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="n">info</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">set_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">streamon_err1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* First save the configuration in ovelray structure */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_init</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="s">&quot;failed to set overlay info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Enable the pipeline and set the Go bit */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_apply_changes</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;failed to change mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">streamon_err1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">streamon_err1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="nl">streamon_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VSYNC</span> <span class="o">|</span> <span class="n">DISPC_IRQ_EVSYNC_EVEN</span> <span class="o">|</span> <span class="n">DISPC_IRQ_EVSYNC_ODD</span>
		<span class="o">|</span> <span class="n">DISPC_IRQ_VSYNC2</span><span class="p">;</span>

	<span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">omap_vout_isr</span><span class="p">,</span> <span class="n">vout</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Turn of the pipeline */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_apply_changes</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;failed to change mode in&quot;</span>
				<span class="s">&quot; streamoff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_manager_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_dss_trans_key_type</span> <span class="n">key_type</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_KEY_GFX_DST</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* OMAP DSS doesn&#39;t support Source and Destination color</span>
<span class="cm">	   key together */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_SRC_CHROMAKEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* OMAP DSS Doesn&#39;t support the Destination color key</span>
<span class="cm">	   and alpha blending together */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_LOCAL_ALPHA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_SRC_CHROMAKEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_SRC_CHROMAKEY</span><span class="p">;</span>
		<span class="n">key_type</span> <span class="o">=</span>  <span class="n">OMAP_DSS_COLOR_KEY_VID_SRC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_FBUF_FLAG_SRC_CHROMAKEY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">;</span>
		<span class="n">key_type</span> <span class="o">=</span>  <span class="n">OMAP_DSS_COLOR_KEY_GFX_DST</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span> <span class="o">|</span>
				<span class="n">V4L2_FBUF_FLAG_SRC_CHROMAKEY</span><span class="p">))</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span> <span class="o">&amp;&amp;</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_manager_info</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">trans_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">trans_key_type</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">trans_key</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">chromakey</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_LOCAL_ALPHA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_LOCAL_ALPHA</span><span class="p">;</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_FBUF_FLAG_LOCAL_ALPHA</span><span class="p">;</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span> <span class="o">&amp;&amp;</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_manager_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="cm">/* enable this only if there is no zorder cap */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_ZORDER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">info</span><span class="p">.</span><span class="n">partial_alpha_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_manager_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">ovid</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* The video overlay must stay within the framebuffer and can&#39;t be</span>
<span class="cm">	   positioned independently. */</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_FBUF_FLAG_OVERLAY</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_FBUF_CAP_LOCAL_ALPHA</span> <span class="o">|</span> <span class="n">V4L2_FBUF_CAP_CHROMAKEY</span>
		<span class="o">|</span> <span class="n">V4L2_FBUF_CAP_SRC_CHROMAKEY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">trans_key_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_KEY_VID_SRC</span><span class="p">)</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_SRC_CHROMAKEY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">trans_key_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_KEY_GFX_DST</span><span class="p">)</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_manager_info</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">partial_alpha_enabled</span><span class="p">)</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_LOCAL_ALPHA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">vout_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>      			<span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out</span> 		<span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out</span>			<span class="o">=</span> <span class="n">vidioc_g_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out</span>			<span class="o">=</span> <span class="n">vidioc_try_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out</span>			<span class="o">=</span> <span class="n">vidioc_s_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>    			<span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>       			<span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fbuf</span>				<span class="o">=</span> <span class="n">vidioc_s_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fbuf</span>				<span class="o">=</span> <span class="n">vidioc_g_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>       			<span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_overlay</span> 		<span class="o">=</span> <span class="n">vidioc_try_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_overlay</span>		<span class="o">=</span> <span class="n">vidioc_s_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_overlay</span>		<span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_overlay</span>		<span class="o">=</span> <span class="n">vidioc_g_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>				<span class="o">=</span> <span class="n">vidioc_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>				<span class="o">=</span> <span class="n">vidioc_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>				<span class="o">=</span> <span class="n">vidioc_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>				<span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>			<span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>				<span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>				<span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>			<span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>			<span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">omap_vout_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> 		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">omap_vout_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> 		<span class="o">=</span> <span class="n">omap_vout_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> 		<span class="o">=</span> <span class="n">omap_vout_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> 	<span class="o">=</span> <span class="n">omap_vout_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Init functions used during driver initialization */</span>
<span class="cm">/* Initial setup of video_data */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_vout_setup_video_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span> <span class="o">=</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="cm">/* set the default pix */</span>
	<span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>

	<span class="cm">/* Set the default picture of QVGA  */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">QQVGA_WIDTH</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">QQVGA_HEIGHT</span><span class="p">;</span>

	<span class="cm">/* Default pixel format is RGB 5-6-5 */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">RGB565_BPP</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span>  <span class="n">display</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">x_res</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span>  <span class="n">display</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">y_res</span><span class="p">;</span>

	<span class="cm">/* Set the data structures for the overlay parameters*/</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_FBUF_CAP_LOCAL_ALPHA</span> <span class="o">|</span>
		<span class="n">V4L2_FBUF_CAP_SRC_CHROMAKEY</span> <span class="o">|</span> <span class="n">V4L2_FBUF_CAP_CHROMAKEY</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">chromakey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omap_vout_new_format</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">);</span>

	<span class="cm">/*Initialize the control variables for</span>
<span class="cm">	  rotation, flipping and background color. */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_ROTATE</span><span class="p">;</span>
	<span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">mirror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_HFLIP</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vrfb_bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_BG_COLOR</span><span class="p">;</span>
	<span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* initialize the video_device struct */</span>
	<span class="n">vfd</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">vfd</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vfd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">VOUT_NAME</span> <span class="s">&quot;: could not allocate&quot;</span>
				<span class="s">&quot; video device struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout_ioctl_ops</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">VOUT_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_vout_fops</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Setup video buffers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_vout_setup_video_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">vid_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">numbuffers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap2video_device</span> <span class="o">*</span><span class="n">vid_dev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap2video_device</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">vout</span> <span class="o">=</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">vouts</span><span class="p">[</span><span class="n">vid_num</span><span class="p">];</span>
	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>

	<span class="n">numbuffers</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">video1_numbuffers</span> <span class="o">:</span> <span class="n">video2_numbuffers</span><span class="p">;</span>
	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">video1_bufsize</span> <span class="o">:</span> <span class="n">video2_bufsize</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Buffer Size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numbuffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">omap_vout_alloc_buffer</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">numbuffers</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_buffers</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vout</span><span class="o">-&gt;</span><span class="n">cropped_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">static_vrfb_allocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">vid1_static_vrfb_alloc</span> <span class="o">:</span> <span class="n">vid2_static_vrfb_alloc</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_vout_setup_vrfb_bufs</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vid_num</span><span class="p">,</span>
				<span class="n">static_vrfb_allocation</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">free_buffers:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numbuffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_vout_free_buffer</span><span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_virt_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">buf_phy_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Create video out devices */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_vout_create_video_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap2video_device</span> <span class="o">*</span><span class="n">vid_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">omap2video_device</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">vout</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: could not allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">vouts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">vout</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_dev</span> <span class="o">=</span> <span class="n">vid_dev</span><span class="p">;</span>
		<span class="cm">/* Select video2 if only 1 overlay is controlled by V4L2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="cm">/* Else select video1 and video2 one by one. */</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">num_overlays</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Set VRFB as rotation_type for omap2 and omap3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_omap34xx</span><span class="p">())</span>
			<span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">rotation_type</span> <span class="o">=</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">;</span>

		<span class="cm">/* Setup the default configuration for the video devices</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_vout_setup_video_data</span><span class="p">(</span><span class="n">vout</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Allocate default number of buffers for the video streaming</span>
<span class="cm">		 * and reserve the VRFB space for rotation</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_vout_setup_video_bufs</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Register the Video device with V4L2</span>
<span class="cm">		 */</span>
		<span class="n">vfd</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">vfd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: Could not register &quot;</span>
					<span class="s">&quot;Video for Linux device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">vout</span><span class="p">);</span>

		<span class="cm">/* Configure the overlay structure */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omapvid_init</span><span class="p">(</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">vouts</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>

<span class="nl">error2:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">.</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span>
			<span class="n">omap_vout_release_vrfb</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
		<span class="n">omap_vout_free_buffers</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
<span class="nl">error1:</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>
<span class="nl">error:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">success:</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: registered and initialized&quot;</span>
				<span class="s">&quot; video device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vfd</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* Driver functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_cleanup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_vout_device</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapvideo_info</span> <span class="o">*</span><span class="n">ovid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vout</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vfd</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">vfd</span><span class="p">;</span>
	<span class="n">ovid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vid_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vfd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">vfd</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The device was never registered, so release the</span>
<span class="cm">			 * video_device struct directly.</span>
<span class="cm">			 */</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The unregister function will release the video_device</span>
<span class="cm">			 * struct as well as unregistering it.</span>
<span class="cm">			 */</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovid</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">VOUT_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_vout_release_vrfb</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
		<span class="cm">/* Free the VRFB buffer if allocated</span>
<span class="cm">		 * init time</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">vrfb_static_allocation</span><span class="p">)</span>
			<span class="n">omap_vout_free_vrfb_buffers</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omap_vout_free_buffers</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vout_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap2video_device</span> <span class="o">*</span><span class="n">vid_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span>
			<span class="n">omap2video_device</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="n">omap_vout_cleanup_device</span><span class="p">(</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">vouts</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_displays</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OMAP_DSS_DISPLAY_DISABLED</span><span class="p">)</span>
			<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>

		<span class="n">omap_dss_put_device</span><span class="p">(</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vid_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_vout_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">def_display</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap2video_device</span> <span class="o">*</span><span class="n">vid_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probed for an unknown device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vid_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap2video_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vid_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_displays</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_dss_dev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_dss_get_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no driver for display: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">omap_dss_put_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_displays</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dssdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_displays</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no displays</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_overlays</span> <span class="o">=</span> <span class="n">omap_dss_get_num_overlays</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_managers</span> <span class="o">=</span> <span class="n">omap_dss_get_num_overlay_managers</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_managers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">managers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay_manager</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Get the Video1 overlay and video2 overlay.</span>
<span class="cm">	 * Setup the Display attached to that overlays</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">def_display</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot find display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">def_display</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">def_display</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_dss_driver</span> <span class="o">*</span><span class="n">dssdrv</span> <span class="o">=</span> <span class="n">def_display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">def_display</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Here we are not considering a error</span>
<span class="cm">				 *  as display may be enabled by frame</span>
<span class="cm">				 *  buffer driver</span>
<span class="cm">				 */</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;&#39;%s&#39; Display already enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">def_display</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;v4l2_device_register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_vout_create_video_devices</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_err2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_displays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span>
			<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">display</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">x_res</span><span class="p">,</span>
					<span class="n">display</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">y_res</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_err2:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">probe_err1:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vid_dev</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">def_display</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
			<span class="n">def_display</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">def_display</span> <span class="o">&amp;&amp;</span> <span class="n">def_display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
			<span class="n">def_display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">def_display</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">probe_err0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vid_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_vout_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">VOUT_NAME</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">omap_vout_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_vout_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_vout_driver</span><span class="p">,</span> <span class="n">omap_vout_probe</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">VOUT_NAME</span> <span class="s">&quot;:Could not register Video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_vout_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_vout_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">omap_vout_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">omap_vout_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
