<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › w9966.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>w9966.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Winbond w9966cf Webcam parport driver.</span>

<span class="cm">	Version 0.33</span>

<span class="cm">	Copyright (C) 2001 Jakob Kemi &lt;jakob.kemi@post.utfors.se&gt;</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the Free Software</span>
<span class="cm">	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">	Supported devices:</span>
<span class="cm">	*Lifeview FlyCam Supra (using the Philips saa7111a chip)</span>

<span class="cm">	Does any other model using the w9966 interface chip exist ?</span>

<span class="cm">	Todo:</span>

<span class="cm">	*Add a working EPP mode, since DMA ECP read isn&#39;t implemented</span>
<span class="cm">	in the parport drivers. (That&#39;s why it&#39;s so sloow)</span>

<span class="cm">	*Add support for other ccd-control chips than the saa7111</span>
<span class="cm">	please send me feedback on what kind of chips you have.</span>

<span class="cm">	*Add proper probing. I don&#39;t know what&#39;s wrong with the IEEE1284</span>
<span class="cm">	parport drivers but (IEEE1284_MODE_NIBBLE|IEEE1284_DEVICE_ID)</span>
<span class="cm">	and nibble read seems to be broken for some peripherals.</span>

<span class="cm">	*Add probing for onboard SRAM, port directions etc. (if possible)</span>

<span class="cm">	*Add support for the hardware compressed modes (maybe using v4l2)</span>

<span class="cm">	*Fix better support for the capture window (no skewed images, v4l</span>
<span class="cm">	interface to capt. window)</span>

<span class="cm">	*Probably some bugs that I don&#39;t know of</span>

<span class="cm">	Please support me by sending feedback!</span>

<span class="cm">	Changes:</span>

<span class="cm">	Alan Cox:	Removed RGB mode for kernel merge, added THIS_MODULE</span>
<span class="cm">			and owner support for newer module locks</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-fh.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>
<span class="cp">#include &lt;linux/parport.h&gt;</span>

<span class="cm">/*#define DEBUG*/</span>				<span class="cm">/* Undef me for production */</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DPRINTF(x, a...) printk(KERN_DEBUG &quot;W9966: %s(): &quot;x, __func__ , ##a)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTF(x...)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	Defines, simple typedefs etc.</span>
<span class="cm"> */</span>

<span class="cp">#define W9966_DRIVERNAME	&quot;W9966CF Webcam&quot;</span>
<span class="cp">#define W9966_MAXCAMS		4	</span><span class="cm">/* Maximum number of cameras */</span><span class="cp"></span>
<span class="cp">#define W9966_RBUFFER		2048	</span><span class="cm">/* Read buffer (must be an even number) */</span><span class="cp"></span>
<span class="cp">#define W9966_SRAMSIZE		131072	</span><span class="cm">/* 128kb */</span><span class="cp"></span>
<span class="cp">#define W9966_SRAMID		0x02	</span><span class="cm">/* check w9966cf.pdf */</span><span class="cp"></span>

<span class="cm">/* Empirically determined window limits */</span>
<span class="cp">#define W9966_WND_MIN_X		16</span>
<span class="cp">#define W9966_WND_MIN_Y		14</span>
<span class="cp">#define W9966_WND_MAX_X		705</span>
<span class="cp">#define W9966_WND_MAX_Y		253</span>
<span class="cp">#define W9966_WND_MAX_W		(W9966_WND_MAX_X - W9966_WND_MIN_X)</span>
<span class="cp">#define W9966_WND_MAX_H		(W9966_WND_MAX_Y - W9966_WND_MIN_Y)</span>

<span class="cm">/* Keep track of our current state */</span>
<span class="cp">#define W9966_STATE_PDEV	0x01</span>
<span class="cp">#define W9966_STATE_CLAIMED	0x02</span>
<span class="cp">#define W9966_STATE_VDEV	0x04</span>

<span class="cp">#define W9966_I2C_W_ID		0x48</span>
<span class="cp">#define W9966_I2C_R_ID		0x49</span>
<span class="cp">#define W9966_I2C_R_DATA	0x08</span>
<span class="cp">#define W9966_I2C_R_CLOCK	0x04</span>
<span class="cp">#define W9966_I2C_W_DATA	0x02</span>
<span class="cp">#define W9966_I2C_W_CLOCK	0x01</span>

<span class="k">struct</span> <span class="n">w9966</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i2c_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ppmode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="n">vdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brightness</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="n">contrast</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="n">color</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="n">hue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Module specific properties</span>
<span class="cm"> */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jakob Kemi &lt;jakob.kemi@post.utfors.se&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Winbond w9966cf WebCam driver (0.32)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.33.1&quot;</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pardev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">W9966_MAXCAMS</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pardev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">W9966_MAXCAMS</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;aggressive&quot;</span><span class="p">};</span>
<span class="cp">#endif</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pardev</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pardev</span><span class="p">,</span> <span class="s">&quot;pardev: where to search for</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">each camera. &#39;aggressive&#39; means brute-force search.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">Eg: &gt;pardev=parport3,aggressive,parport2,parport1&lt; would assign</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">cam 1 to parport3 and search every parport for cam 2 etc...&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">parmode</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">parmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">parmode</span><span class="p">,</span> <span class="s">&quot;parmode: transfer mode (0=auto, 1=ecp, 2=epp&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">w9966</span> <span class="n">w9966_cams</span><span class="p">[</span><span class="n">W9966_MAXCAMS</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> *	Private function defines</span>
<span class="cm"> */</span>


<span class="cm">/* Set camera phase flags, so we know what to uninit when terminating */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">w9966_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">dev_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">dev_state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get camera phase flags */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">w9966_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">dev_state</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Claim parport for ourself */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w9966_pdev_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_get_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_CLAIMED</span><span class="p">,</span> <span class="n">W9966_STATE_CLAIMED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">parport_claim_or_block</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">w9966_set_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_CLAIMED</span><span class="p">,</span> <span class="n">W9966_STATE_CLAIMED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Release parport for others to use */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w9966_pdev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_get_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_CLAIMED</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">parport_release</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">w9966_set_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_CLAIMED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read register from W9966 interface-chip</span>
<span class="cm">   Expects a claimed pdev</span>
<span class="cm">   -1 on error, else register data (byte) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ECP, read, regtransfer, REG, REG, REG, REG, REG */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parport_negotiate</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">|</span> <span class="n">IEEE1284_ADDR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_write</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_negotiate</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">|</span> <span class="n">IEEE1284_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_read</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write register to W9966 interface-chip</span>
<span class="cm">   Expects a claimed pdev</span>
<span class="cm">   -1 on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ECP, write, regtransfer, REG, REG, REG, REG, REG */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0xc0</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parport_negotiate</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">|</span> <span class="n">IEEE1284_ADDR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_write</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_negotiate</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">|</span> <span class="n">IEEE1284_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_write</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Ugly and primitive i2c protocol functions</span>
<span class="cm"> */</span>

<span class="cm">/* Sets the data line on the i2c bus.</span>
<span class="cm">   Expects a claimed pdev. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w9966_i2c_setsda</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">i2c_state</span> <span class="o">|=</span> <span class="n">W9966_I2C_W_DATA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">i2c_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">W9966_I2C_W_DATA</span><span class="p">;</span>

	<span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">i2c_state</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get peripheral clock line</span>
<span class="cm">   Expects a claimed pdev. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_i2c_getscl</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span> <span class="o">=</span> <span class="n">w9966_read_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">W9966_I2C_R_CLOCK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Sets the clock line on the i2c bus.</span>
<span class="cm">   Expects a claimed pdev. -1 on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_i2c_setscl</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">i2c_state</span> <span class="o">|=</span> <span class="n">W9966_I2C_W_CLOCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">i2c_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">W9966_I2C_W_CLOCK</span><span class="p">;</span>

	<span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">i2c_state</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* we go to high, we also expect the peripheral to ack. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">w9966_i2c_getscl</span><span class="p">(</span><span class="n">cam</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* Get peripheral data line</span>
<span class="c">   Expects a claimed pdev. */</span>
<span class="c">static int w9966_i2c_getsda(struct w9966 *cam)</span>
<span class="c">{</span>
<span class="c">	const unsigned char state = w9966_read_reg(cam, 0x18);</span>
<span class="c">	return ((state &amp; W9966_I2C_R_DATA) &gt; 0);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Write a byte with ack to the i2c bus.</span>
<span class="cm">   Expects a claimed pdev. -1 on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_i2c_wbyte</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w9966_i2c_setsda</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w9966_i2c_setscl</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">w9966_i2c_setscl</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">w9966_i2c_setsda</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_i2c_setscl</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">w9966_i2c_setscl</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read a data byte with ack from the i2c-bus</span>
<span class="cm">   Expects a claimed pdev. -1 on error */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int w9966_i2c_rbyte(struct w9966 *cam)</span>
<span class="c">{</span>
<span class="c">	unsigned char data = 0x00;</span>
<span class="c">	int i;</span>

<span class="c">	w9966_i2c_setsda(cam, 1);</span>

<span class="c">	for (i = 0; i &lt; 8; i++) {</span>
<span class="c">		if (w9966_i2c_setscl(cam, 1) == -1)</span>
<span class="c">			return -1;</span>
<span class="c">		data = data &lt;&lt; 1;</span>
<span class="c">		if (w9966_i2c_getsda(cam))</span>
<span class="c">			data |= 0x01;</span>

<span class="c">		w9966_i2c_setscl(cam, 0);</span>
<span class="c">	}</span>
<span class="c">	return data;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Read a register from the i2c device.</span>
<span class="cm">   Expects claimed pdev. -1 on error */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int w9966_read_reg_i2c(struct w9966 *cam, int reg)</span>
<span class="c">{</span>
<span class="c">	int data;</span>

<span class="c">	w9966_i2c_setsda(cam, 0);</span>
<span class="c">	w9966_i2c_setscl(cam, 0);</span>

<span class="c">	if (w9966_i2c_wbyte(cam, W9966_I2C_W_ID) == -1 ||</span>
<span class="c">	    w9966_i2c_wbyte(cam, reg) == -1)</span>
<span class="c">		return -1;</span>

<span class="c">	w9966_i2c_setsda(cam, 1);</span>
<span class="c">	if (w9966_i2c_setscl(cam, 1) == -1)</span>
<span class="c">		return -1;</span>
<span class="c">	w9966_i2c_setsda(cam, 0);</span>
<span class="c">	w9966_i2c_setscl(cam, 0);</span>

<span class="c">	if (w9966_i2c_wbyte(cam, W9966_I2C_R_ID) == -1)</span>
<span class="c">		return -1;</span>
<span class="c">	data = w9966_i2c_rbyte(cam);</span>
<span class="c">	if (data == -1)</span>
<span class="c">		return -1;</span>

<span class="c">	w9966_i2c_setsda(cam, 0);</span>

<span class="c">	if (w9966_i2c_setscl(cam, 1) == -1)</span>
<span class="c">		return -1;</span>
<span class="c">	w9966_i2c_setsda(cam, 1);</span>

<span class="c">	return data;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Write a register to the i2c device.</span>
<span class="cm">   Expects claimed pdev. -1 on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_write_reg_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">w9966_i2c_setsda</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">w9966_i2c_setscl</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_i2c_wbyte</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_I2C_W_ID</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
			<span class="n">w9966_i2c_wbyte</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
			<span class="n">w9966_i2c_wbyte</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">w9966_i2c_setsda</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_i2c_setscl</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">w9966_i2c_setsda</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find a good length for capture window (used both for W and H)</span>
<span class="cm">   A bit ugly but pretty functional. The capture length</span>
<span class="cm">   have to match the downscale */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_findlen</span><span class="p">(</span><span class="kt">int</span> <span class="n">near</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bestlen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">besterr</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">near</span> <span class="o">-</span> <span class="n">bestlen</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">;</span> <span class="n">len</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="mi">64</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="o">%</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">near</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

		<span class="cm">/* Only continue as long as we keep getting better values */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="n">besterr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">besterr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">bestlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bestlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Modify capture window (if necessary)</span>
<span class="cm">   and calculate downscaling</span>
<span class="cm">   Return -1 on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_calcscale</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">beg</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">factor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">maxlen</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">end</span> <span class="o">-</span> <span class="o">*</span><span class="n">beg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newlen</span> <span class="o">=</span> <span class="n">w9966_findlen</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">newlen</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Check for bad format */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newlen</span> <span class="o">&gt;</span> <span class="n">maxlen</span> <span class="o">||</span> <span class="n">newlen</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set factor (6 bit fixed) */</span>
	<span class="o">*</span><span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="n">newlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">factor</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span>
		<span class="o">*</span><span class="n">factor</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* downscale is disabled */</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">factor</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* set downscale-enable bit */</span>

	<span class="cm">/* Modify old beginning and end */</span>
	<span class="o">*</span><span class="n">beg</span> <span class="o">-=</span> <span class="n">err</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">end</span> <span class="o">+=</span> <span class="n">err</span> <span class="o">-</span> <span class="p">(</span><span class="n">err</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Move window if outside borders */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">beg</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">end</span> <span class="o">+=</span> <span class="n">min</span> <span class="o">-</span> <span class="o">*</span><span class="n">beg</span><span class="p">;</span>
		<span class="o">*</span><span class="n">beg</span> <span class="o">+=</span> <span class="n">min</span> <span class="o">-</span> <span class="o">*</span><span class="n">beg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">beg</span> <span class="o">-=</span> <span class="o">*</span><span class="n">end</span> <span class="o">-</span> <span class="n">max</span><span class="p">;</span>
		<span class="o">*</span><span class="n">end</span> <span class="o">-=</span> <span class="o">*</span><span class="n">end</span> <span class="o">-</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Setup the cameras capture window etc.</span>
<span class="cm">   Expects a claimed pdev</span>
<span class="cm">   return -1 on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enh_s</span><span class="p">,</span> <span class="n">enh_e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regs</span><span class="p">[</span><span class="mh">0x1c</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7111_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc0</span>
	<span class="p">};</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">W9966_SRAMSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;capture window exceeds SRAM size!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">160</span><span class="p">;</span>	<span class="cm">/* Pick default values */</span>
	<span class="p">}</span>

	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">w</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">h</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">W9966_WND_MAX_W</span><span class="p">)</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">W9966_WND_MAX_W</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">W9966_WND_MAX_H</span><span class="p">)</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">W9966_WND_MAX_H</span><span class="p">;</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">enh_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">enh_e</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Modify capture window if necessary and calculate downscaling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_calcscale</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">W9966_WND_MIN_X</span><span class="p">,</span> <span class="n">W9966_WND_MAX_X</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scale_x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">w9966_calcscale</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">W9966_WND_MIN_Y</span><span class="p">,</span> <span class="n">W9966_WND_MAX_Y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scale_y</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;%dx%d, x: %d&lt;-&gt;%d, y: %d&lt;-&gt;%d, sx: %d/64, sy: %d/64.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">scale_x</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">scale_y</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* Setup registers */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>			<span class="cm">/* Set normal operation */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>			<span class="cm">/* Capture mode */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_y</span><span class="p">;</span>			<span class="cm">/* V-scaling */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_x</span><span class="p">;</span>			<span class="cm">/* H-scaling */</span>

	<span class="cm">/* Capture window */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">);</span>		<span class="cm">/* X-start (8 low bits) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>		<span class="cm">/* X-start (2 high bits) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">);</span>		<span class="cm">/* Y-start (8 low bits) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>		<span class="cm">/* Y-start (2 high bits) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">);</span>		<span class="cm">/* X-end (8 low bits) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>		<span class="cm">/* X-end (2 high bits) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">);</span>		<span class="cm">/* Y-end (8 low bits) */</span>

	<span class="n">regs</span><span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="n">W9966_SRAMID</span><span class="p">;</span>		<span class="cm">/* SRAM-banks (1x 128kb) */</span>

	<span class="cm">/* Enhancement layer */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh_s</span> <span class="o">&amp;</span> <span class="mh">0x000ff</span><span class="p">);</span>		<span class="cm">/* Enh. start (0-7) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh_s</span> <span class="o">&amp;</span> <span class="mh">0x0ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* Enh. start (8-15) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh_s</span> <span class="o">&amp;</span> <span class="mh">0x70000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* Enh. start (16-17/18??) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh_e</span> <span class="o">&amp;</span> <span class="mh">0x000ff</span><span class="p">);</span>		<span class="cm">/* Enh. end (0-7) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh_e</span> <span class="o">&amp;</span> <span class="mh">0x0ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* Enh. end (8-15) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh_e</span> <span class="o">&amp;</span> <span class="mh">0x70000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* Enh. end (16-17/18??) */</span>

	<span class="cm">/* Misc */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>			<span class="cm">/* VEE control (raw 4:2:2) */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>			<span class="cm">/* ??? */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">i2c_state</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Serial bus */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>			<span class="cm">/* I/O port direction control */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>			<span class="cm">/* I/O port data register */</span>
	<span class="n">regs</span><span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>			<span class="cm">/* ??? */</span>

	<span class="cm">/* SAA7111 chip settings */</span>
	<span class="n">saa7111_regs</span><span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">;</span>
	<span class="n">saa7111_regs</span><span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">;</span>
	<span class="n">saa7111_regs</span><span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>
	<span class="n">saa7111_regs</span><span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">;</span>

	<span class="cm">/* Reset (ECP-fifo &amp; serial-bus) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Write regs to w9966cf chip */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1c</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Write regs to saa7111 chip */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w9966_write_reg_i2c</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">saa7111_regs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Video4linux interfacing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">vcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">W9966_DRIVERNAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;parport&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_READWRITE</span><span class="p">;</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">vcap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">|</span> <span class="n">V4L2_CAP_DEVICE_CAPS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Camera&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">audioset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">inp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w9966</span><span class="p">,</span> <span class="n">hdl</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">hue</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w9966_pdev_claim</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w9966_write_reg_i2c</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
		    <span class="n">w9966_write_reg_i2c</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
		    <span class="n">w9966_write_reg_i2c</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
		    <span class="n">w9966_write_reg_i2c</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">w9966_pdev_release</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/* Just a guess */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">W9966_WND_MAX_W</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">W9966_WND_MAX_W</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">W9966_WND_MAX_H</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">W9966_WND_MAX_H</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/* Just a guess */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cam_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Update camera regs */</span>
	<span class="n">w9966_pdev_claim</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">w9966_setup</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">w9966_pdev_release</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cam_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="s">&quot;YUV 4:2:2&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">},</span>
	<span class="p">};</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Capture data */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w9966_v4l_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span>  <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>	<span class="cm">/* ECP, read, CCD-transfer, 00000 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dleft</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tbuf</span><span class="p">;</span>

	<span class="cm">/* Why would anyone want more than this?? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">w9966_pdev_claim</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>	<span class="cm">/* Reset ECP-FIFO buffer */</span>
	<span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Return to normal operation */</span>
	<span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">);</span>	<span class="cm">/* Enable capture */</span>

	<span class="cm">/* write special capture-addr and negotiate into data transfer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">parport_negotiate</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span><span class="o">|</span><span class="n">IEEE1284_ADDR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">parport_write</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">parport_negotiate</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span><span class="o">|</span><span class="n">IEEE1284_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">w9966_pdev_release</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">W9966_RBUFFER</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dleft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">dleft</span> <span class="o">&gt;</span> <span class="n">W9966_RBUFFER</span><span class="p">)</span> <span class="o">?</span> <span class="n">W9966_RBUFFER</span> <span class="o">:</span> <span class="n">dleft</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parport_read</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">,</span> <span class="n">tsize</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dest</span> <span class="o">+=</span> <span class="n">tsize</span><span class="p">;</span>
		<span class="n">dleft</span> <span class="o">-=</span> <span class="n">tsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">w9966_write_reg</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>	<span class="cm">/* Disable capture */</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tbuf</span><span class="p">);</span>
	<span class="n">w9966_pdev_release</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">w9966_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">v4l2_fh_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">v4l2_fh_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">v4l2_ctrl_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>           <span class="o">=</span> <span class="n">w9966_v4l_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">w9966_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>    		    <span class="o">=</span> <span class="n">cam_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>      		    <span class="o">=</span> <span class="n">cam_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>      		    <span class="o">=</span> <span class="n">cam_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>   		    <span class="o">=</span> <span class="n">cam_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> 	    <span class="o">=</span> <span class="n">cam_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> 		    <span class="o">=</span> <span class="n">cam_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>  		    <span class="o">=</span> <span class="n">cam_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>  	    <span class="o">=</span> <span class="n">cam_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_log_status</span>		    <span class="o">=</span> <span class="n">v4l2_ctrl_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_subscribe_event</span>		    <span class="o">=</span> <span class="n">v4l2_ctrl_subscribe_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_unsubscribe_event</span>	    <span class="o">=</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">cam_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">cam_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Initialize camera device. Setup all internal flags, set a</span>
<span class="cm">   default video mode, setup ccd-chip, register v4l device etc..</span>
<span class="cm">   Also used for &#39;probing&#39; of hardware.</span>
<span class="cm">   -1 on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w9966_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">dev_state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;w9966&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Could not register v4l2_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_SATURATION</span><span class="p">,</span> <span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_HUE</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">hue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Select requested transfer mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">parmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>	<span class="cm">/* Auto-detect (priority: hw-ecp, hw-epp, sw-ecp) */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_ECP</span><span class="p">)</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">=</span> <span class="n">IEEE1284_MODE_ECP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_EPP</span><span class="p">)</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">=</span> <span class="n">IEEE1284_MODE_EPP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">=</span> <span class="n">IEEE1284_MODE_ECP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* hw- or sw-ecp */</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">=</span> <span class="n">IEEE1284_MODE_ECP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* hw- or sw-epp */</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ppmode</span> <span class="o">=</span> <span class="n">IEEE1284_MODE_EPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tell the parport driver that we exists */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">parport_register_device</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;w9966&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;parport_register_device() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">w9966_set_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_PDEV</span><span class="p">,</span> <span class="n">W9966_STATE_PDEV</span><span class="p">);</span>

	<span class="n">w9966_pdev_claim</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="cm">/* Setup a default capture mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_setup</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;w9966_setup() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">w9966_pdev_release</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="cm">/* Fill in the video_device struct and register us to v4l */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">W9966_DRIVERNAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w9966_fops</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w9966_ioctl_ops</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release_empty</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_USE_FH_PRIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">cam</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="n">video_nr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">w9966_set_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_VDEV</span><span class="p">,</span> <span class="n">W9966_STATE_VDEV</span><span class="p">);</span>

	<span class="cm">/* All ok */</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Found and initialized a webcam on %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Terminate everything gracefully */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w9966_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">w9966</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Unregister from v4l */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_get_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_VDEV</span><span class="p">,</span> <span class="n">W9966_STATE_VDEV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
		<span class="n">w9966_set_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_VDEV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>

	<span class="cm">/* Terminate from IEEE1284 mode and release pdev block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_get_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_PDEV</span><span class="p">,</span> <span class="n">W9966_STATE_PDEV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">w9966_pdev_claim</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
		<span class="n">parport_negotiate</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">IEEE1284_MODE_COMPAT</span><span class="p">);</span>
		<span class="n">w9966_pdev_release</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Unregister from parport */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w9966_get_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_PDEV</span><span class="p">,</span> <span class="n">W9966_STATE_PDEV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">w9966_set_state</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">W9966_STATE_PDEV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cam</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* Called once for every parport on init */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w9966_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">W9966_MAXCAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w9966_cams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Cam is already assigned */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pardev</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;aggressive&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pardev</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w9966_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w9966_cams</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">w9966_term</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w9966_cams</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* return */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Called once for every parport on termination */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w9966_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">W9966_MAXCAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w9966_cams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_state</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">w9966_cams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pport</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
			<span class="n">w9966_term</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w9966_cams</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">parport_driver</span> <span class="n">w9966_ppd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">W9966_DRIVERNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">w9966_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">w9966_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Module entry point */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">w9966_mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">W9966_MAXCAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">w9966_cams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">parport_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w9966_ppd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Module cleanup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">w9966_mod_term</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">parport_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w9966_ppd</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">w9966_mod_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">w9966_mod_term</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
