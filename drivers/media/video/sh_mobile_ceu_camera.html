<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › sh_mobile_ceu_camera.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sh_mobile_ceu_camera.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * V4L2 Driver for SuperH Mobile CEU interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Magnus Damm</span>
<span class="cm"> *</span>
<span class="cm"> * Based on V4L2 Driver for PXA camera host - &quot;pxa_camera.c&quot;,</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006, Sascha Hauer, Pengutronix</span>
<span class="cm"> * Copyright (C) 2008, Guennadi Liakhovetski &lt;kernel@pengutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-dev.h&gt;</span>
<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/sh_mobile_ceu.h&gt;</span>
<span class="cp">#include &lt;media/sh_mobile_csi2.h&gt;</span>
<span class="cp">#include &lt;media/videobuf2-dma-contig.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;media/soc_mediabus.h&gt;</span>

<span class="cm">/* register offsets for sh7722 / sh7723 */</span>

<span class="cp">#define CAPSR  0x00 </span><span class="cm">/* Capture start register */</span><span class="cp"></span>
<span class="cp">#define CAPCR  0x04 </span><span class="cm">/* Capture control register */</span><span class="cp"></span>
<span class="cp">#define CAMCR  0x08 </span><span class="cm">/* Capture interface control register */</span><span class="cp"></span>
<span class="cp">#define CMCYR  0x0c </span><span class="cm">/* Capture interface cycle  register */</span><span class="cp"></span>
<span class="cp">#define CAMOR  0x10 </span><span class="cm">/* Capture interface offset register */</span><span class="cp"></span>
<span class="cp">#define CAPWR  0x14 </span><span class="cm">/* Capture interface width register */</span><span class="cp"></span>
<span class="cp">#define CAIFR  0x18 </span><span class="cm">/* Capture interface input format register */</span><span class="cp"></span>
<span class="cp">#define CSTCR  0x20 </span><span class="cm">/* Camera strobe control register (&lt;= sh7722) */</span><span class="cp"></span>
<span class="cp">#define CSECR  0x24 </span><span class="cm">/* Camera strobe emission count register (&lt;= sh7722) */</span><span class="cp"></span>
<span class="cp">#define CRCNTR 0x28 </span><span class="cm">/* CEU register control register */</span><span class="cp"></span>
<span class="cp">#define CRCMPR 0x2c </span><span class="cm">/* CEU register forcible control register */</span><span class="cp"></span>
<span class="cp">#define CFLCR  0x30 </span><span class="cm">/* Capture filter control register */</span><span class="cp"></span>
<span class="cp">#define CFSZR  0x34 </span><span class="cm">/* Capture filter size clip register */</span><span class="cp"></span>
<span class="cp">#define CDWDR  0x38 </span><span class="cm">/* Capture destination width register */</span><span class="cp"></span>
<span class="cp">#define CDAYR  0x3c </span><span class="cm">/* Capture data address Y register */</span><span class="cp"></span>
<span class="cp">#define CDACR  0x40 </span><span class="cm">/* Capture data address C register */</span><span class="cp"></span>
<span class="cp">#define CDBYR  0x44 </span><span class="cm">/* Capture data bottom-field address Y register */</span><span class="cp"></span>
<span class="cp">#define CDBCR  0x48 </span><span class="cm">/* Capture data bottom-field address C register */</span><span class="cp"></span>
<span class="cp">#define CBDSR  0x4c </span><span class="cm">/* Capture bundle destination size register */</span><span class="cp"></span>
<span class="cp">#define CFWCR  0x5c </span><span class="cm">/* Firewall operation control register */</span><span class="cp"></span>
<span class="cp">#define CLFCR  0x60 </span><span class="cm">/* Capture low-pass filter control register */</span><span class="cp"></span>
<span class="cp">#define CDOCR  0x64 </span><span class="cm">/* Capture data output control register */</span><span class="cp"></span>
<span class="cp">#define CDDCR  0x68 </span><span class="cm">/* Capture data complexity level register */</span><span class="cp"></span>
<span class="cp">#define CDDAR  0x6c </span><span class="cm">/* Capture data complexity level address register */</span><span class="cp"></span>
<span class="cp">#define CEIER  0x70 </span><span class="cm">/* Capture event interrupt enable register */</span><span class="cp"></span>
<span class="cp">#define CETCR  0x74 </span><span class="cm">/* Capture event flag clear register */</span><span class="cp"></span>
<span class="cp">#define CSTSR  0x7c </span><span class="cm">/* Capture status register */</span><span class="cp"></span>
<span class="cp">#define CSRTR  0x80 </span><span class="cm">/* Capture software reset register */</span><span class="cp"></span>
<span class="cp">#define CDSSR  0x84 </span><span class="cm">/* Capture data size register */</span><span class="cp"></span>
<span class="cp">#define CDAYR2 0x90 </span><span class="cm">/* Capture data address Y register 2 */</span><span class="cp"></span>
<span class="cp">#define CDACR2 0x94 </span><span class="cm">/* Capture data address C register 2 */</span><span class="cp"></span>
<span class="cp">#define CDBYR2 0x98 </span><span class="cm">/* Capture data bottom-field address Y register 2 */</span><span class="cp"></span>
<span class="cp">#define CDBCR2 0x9c </span><span class="cm">/* Capture data bottom-field address C register 2 */</span><span class="cp"></span>

<span class="cp">#undef DEBUG_GEOMETRY</span>
<span class="cp">#ifdef DEBUG_GEOMETRY</span>
<span class="cp">#define dev_geo	dev_info</span>
<span class="cp">#else</span>
<span class="cp">#define dev_geo	dev_dbg</span>
<span class="cp">#endif</span>

<span class="cm">/* per video frame buffer */</span>
<span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="n">vb</span><span class="p">;</span> <span class="cm">/* v4l buffer must be first */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="n">ici</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">csi2_pdev</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">video_limit</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_total</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>		<span class="cm">/* Protects video buffer lists */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">capture</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_alloc_ctx</span> <span class="o">*</span><span class="n">alloc_ctx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sh_mobile_ceu_info</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">complete</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">cflcr</span><span class="p">;</span>

	<span class="cm">/* static max sizes either from platform data or default */</span>
	<span class="kt">int</span> <span class="n">max_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_height</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sequence</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">image_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_16bit</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frozen</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="p">{</span>
	<span class="cm">/* CEU offsets within the camera output, before the CEU scaler */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ceu_left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ceu_top</span><span class="p">;</span>
	<span class="cm">/* Client output, as seen by the CEU */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * User window from S_CROP / G_CROP, produced by client cropping and</span>
<span class="cm">	 * scaling, CEU scaling and CEU cropping, mapped back onto the client</span>
<span class="cm">	 * input window</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">subrect</span><span class="p">;</span>
	<span class="cm">/* Camera cropping rectangle */</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">rect</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">extra_fmt</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span> <span class="o">*</span><span class="nf">to_ceu_vb</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceu_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_offs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg_offs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ceu_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_offs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg_offs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">icd</span><span class="p">;</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span> <span class="cm">/* reset */</span>

	<span class="cm">/* wait CSTSR.CPTON bit */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CSTSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">success</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait CAPSR.CPKIL bit */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">success</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">success</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;soft reset time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Videobuf operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * .queue_setup() is called to check, whether the driver can accept the</span>
<span class="cm"> *		  requested number of buffers and to fill in plane sizes</span>
<span class="cm"> *		  for the current frame format if required</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_videobuf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_planes</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sizes</span><span class="p">[],</span> <span class="kt">void</span> <span class="o">*</span><span class="n">alloc_ctxs</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_camera_device</span><span class="p">,</span> <span class="n">vb2_vidq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span> <span class="o">=</span> <span class="n">soc_camera_xlate_by_fourcc</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span>
								<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_per_line</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xlate</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_mbus_bytes_per_line</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
					      <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">bytes_per_line</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_mbus_image_size</span><span class="p">(</span><span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="p">,</span> <span class="n">bytes_per_line</span><span class="p">,</span>
					  <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Called from VIDIOC_REQBUFS or in compatibility mode */</span>
		<span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">sizeimage</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">alloc_ctxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">num_buffers</span><span class="p">)</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* If *num_planes != 0, we have already verified *count. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">video_limit</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">num_planes</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="o">*</span><span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">&gt;</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">video_limit</span><span class="p">)</span>
			<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">video_limit</span> <span class="o">-</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">buf_total</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;count=%d, size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CEU_CETCR_MAGIC 0x0317f313 </span><span class="cm">/* acknowledge magical interrupt sources */</span><span class="cp"></span>
<span class="cp">#define CEU_CETCR_IGRW (1 &lt;&lt; 4) </span><span class="cm">/* prohibited register access interrupt bit */</span><span class="cp"></span>
<span class="cp">#define CEU_CEIER_CPEIE (1 &lt;&lt; 0) </span><span class="cm">/* one-frame capture end interrupt */</span><span class="cp"></span>
<span class="cp">#define CEU_CEIER_VBP   (1 &lt;&lt; 20) </span><span class="cm">/* vbp error */</span><span class="cp"></span>
<span class="cp">#define CEU_CAPCR_CTNCP (1 &lt;&lt; 16) </span><span class="cm">/* continuous capture mode (if set) */</span><span class="cp"></span>
<span class="cp">#define CEU_CEIER_MASK (CEU_CEIER_CPEIE | CEU_CEIER_VBP)</span>


<span class="cm">/*</span>
<span class="cm"> * return value doesn&#39;t reflex the success/failure to queue the new buffer,</span>
<span class="cm"> * but rather the status of the previous buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">icd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr_top</span><span class="p">,</span> <span class="n">phys_addr_bottom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bottom1</span><span class="p">,</span> <span class="n">bottom2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">planar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The hardware is _very_ picky about this sequence. Especially</span>
<span class="cm">	 * the CEU_CETCR_MAGIC value. It seems like we need to acknowledge</span>
<span class="cm">	 * several not-so-well documented interrupt sources in CETCR.</span>
<span class="cm">	 */</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CEIER</span><span class="p">,</span> <span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CEIER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CEU_CEIER_MASK</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CETCR</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CETCR</span><span class="p">,</span> <span class="o">~</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CEU_CETCR_MAGIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">frozen</span><span class="p">)</span>
		<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CEIER</span><span class="p">,</span> <span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CEIER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CEU_CEIER_MASK</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPCR</span><span class="p">,</span> <span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CEU_CAPCR_CTNCP</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CETCR</span><span class="p">,</span> <span class="n">CEU_CETCR_MAGIC</span> <span class="o">^</span> <span class="n">CEU_CETCR_IGRW</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * When a VBP interrupt occurs, a capture end interrupt does not occur</span>
<span class="cm">	 * and the image of that frame is not captured correctly. So, soft reset</span>
<span class="cm">	 * is needed here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CEU_CEIER_VBP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sh_mobile_ceu_soft_reset</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">frozen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_INTERLACED_BT</span> <span class="o">==</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top1</span>	<span class="o">=</span> <span class="n">CDBYR</span><span class="p">;</span>
		<span class="n">top2</span>	<span class="o">=</span> <span class="n">CDBCR</span><span class="p">;</span>
		<span class="n">bottom1</span>	<span class="o">=</span> <span class="n">CDAYR</span><span class="p">;</span>
		<span class="n">bottom2</span>	<span class="o">=</span> <span class="n">CDACR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">top1</span>	<span class="o">=</span> <span class="n">CDAYR</span><span class="p">;</span>
		<span class="n">top2</span>	<span class="o">=</span> <span class="n">CDACR</span><span class="p">;</span>
		<span class="n">bottom1</span>	<span class="o">=</span> <span class="n">CDBYR</span><span class="p">;</span>
		<span class="n">bottom2</span>	<span class="o">=</span> <span class="n">CDBCR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phys_addr_top</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV12</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV21</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV16</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV61</span>:
		<span class="n">planar</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">planar</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">top1</span><span class="p">,</span> <span class="n">phys_addr_top</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_NONE</span> <span class="o">!=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_addr_bottom</span> <span class="o">=</span> <span class="n">phys_addr_top</span> <span class="o">+</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>
		<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">bottom1</span><span class="p">,</span> <span class="n">phys_addr_bottom</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">planar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_addr_top</span> <span class="o">+=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">;</span>
		<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">top2</span><span class="p">,</span> <span class="n">phys_addr_top</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_NONE</span> <span class="o">!=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phys_addr_bottom</span> <span class="o">=</span> <span class="n">phys_addr_top</span> <span class="o">+</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>
			<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">bottom2</span><span class="p">,</span> <span class="n">phys_addr_bottom</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span> <span class="cm">/* start capture */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_videobuf_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">to_ceu_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>

	<span class="cm">/* Added list head initialization on alloc */</span>
	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">),</span> <span class="s">&quot;Buffer %p on queue!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_mobile_ceu_videobuf_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_camera_device</span><span class="p">,</span> <span class="n">vb2_vidq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">to_ceu_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">sizeimage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Buffer #%d too small (%lu &lt; %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;%s (vb=0x%p) 0x%p %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">vb</span><span class="p">,</span> <span class="n">vb2_plane_vaddr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">vb2_get_plane_payload</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be useful if you want to see if we actually fill</span>
<span class="cm">	 * the buffer with something</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vb2_plane_vaddr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">vb2_plane_vaddr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">vb2_get_plane_payload</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Because there were no active buffer at this moment,</span>
<span class="cm">		 * we are not interested in the return value of</span>
<span class="cm">		 * sh_mobile_ceu_capture here.</span>
<span class="cm">		 */</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
		<span class="n">sh_mobile_ceu_capture</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_mobile_ceu_videobuf_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_camera_device</span><span class="p">,</span> <span class="n">vb2_vidq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">to_ceu_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="n">vb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable capture (release DMA buffer), reset */</span>
		<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Doesn&#39;t hurt also if the list is empty, but it hurts, if queuing the</span>
<span class="cm">	 * buffer failed, and .buf_init() hasn&#39;t been called</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">-=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;%s() %zu bytes buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">buf_total</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_videobuf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_camera_device</span><span class="p">,</span> <span class="n">vb2_vidq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">+=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;%s() %zu bytes buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">buf_total</span><span class="p">);</span>

	<span class="cm">/* This is for locking debugging only */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_ceu_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_stop_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_camera_device</span><span class="p">,</span> <span class="n">vb2_vidq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">buf_head</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">buf_head</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">)</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="n">buf_head</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sh_mobile_ceu_soft_reset</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vb2_ops</span> <span class="n">sh_mobile_ceu_videobuf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue_setup</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_videobuf_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_videobuf_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_videobuf_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_cleanup</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_videobuf_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_init</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_videobuf_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_prepare</span>	<span class="o">=</span> <span class="n">soc_camera_unlock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_finish</span>	<span class="o">=</span> <span class="n">soc_camera_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_streaming</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_stop_streaming</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sh_mobile_ceu_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">vb</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vb</span><span class="p">)</span>
		<span class="cm">/* Stale interrupt from a released buffer */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_ceu_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">))</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">list_entry</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_capture</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">VB2_BUF_STATE_ERROR</span> <span class="o">:</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">find_csi2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">v4l2_device_for_each_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">sd</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with .video_lock held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">csi2_sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">icd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
		 <span class="s">&quot;SuperH Mobile CEU driver attached to camera %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">icd</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">ici</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_soft_reset</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>

	<span class="n">csi2_sd</span> <span class="o">=</span> <span class="n">find_csi2</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2_sd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csi2_sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
		<span class="n">v4l2_set_subdev_hostdata</span><span class="p">(</span><span class="n">csi2_sd</span><span class="p">,</span> <span class="n">icd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">csi2_sd</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">ici</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * -ENODEV is special: either csi2_sd == NULL or the CSI-2 driver</span>
<span class="cm">	 * has not found this soc-camera device among its clients</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">&amp;&amp;</span> <span class="n">csi2_sd</span><span class="p">)</span>
		<span class="n">csi2_sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">icd</span> <span class="o">=</span> <span class="n">icd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with .video_lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_mobile_ceu_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">csi2_sd</span> <span class="o">=</span> <span class="n">find_csi2</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">icd</span> <span class="o">!=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">icd</span><span class="p">);</span>

	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">csi2_sd</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2_sd</span><span class="p">)</span>
		<span class="n">csi2_sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* disable capture, disable interrupts */</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CEIER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sh_mobile_ceu_soft_reset</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>

	<span class="cm">/* make sure active buffer is canceled */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_ceu_vb</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">ici</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
		 <span class="s">&quot;SuperH Mobile CEU driver detached from camera %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">icd</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">icd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * See chapter 29.4.12 &quot;Capture Filter Control Register (CFLCR)&quot;</span>
<span class="cm"> * in SH7722 Hardware Manual</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">size_dst</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mant_pre</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span> <span class="o">||</span> <span class="o">!</span><span class="n">scale</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">src</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">mant_pre</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">src</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mant_pre</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">mant_pre</span> <span class="o">*</span> <span class="mi">4096</span> <span class="o">/</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">calc_scale</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">scale</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span> <span class="o">*</span> <span class="mi">4096</span> <span class="o">/</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">scale</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">&amp;&amp;</span> <span class="n">size_dst</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
		<span class="n">scale</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">size_dst</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">scale</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scale</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* rect is guaranteed to not exceed the scaled camera rectangle */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_mobile_ceu_set_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">cdwdr_width</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">left_offset</span><span class="p">,</span> <span class="n">top_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">camor</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Crop %ux%u@%u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_left</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_top</span><span class="p">);</span>

	<span class="n">left_offset</span>	<span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_left</span><span class="p">;</span>
	<span class="n">top_offset</span>	<span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_top</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">image_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_width</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">is_16bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">in_width</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">left_offset</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">w_factor</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">packing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOC_MBUS_PACKING_2X8_PADHI</span>:
			<span class="n">w_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">w_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">in_width</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">w_factor</span><span class="p">;</span>
		<span class="n">left_offset</span> <span class="o">*=</span> <span class="n">w_factor</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cdwdr_width</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>

	<span class="n">height</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">;</span>
	<span class="n">in_height</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_NONE</span> <span class="o">!=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">in_height</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">top_offset</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cdwdr_width</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CSI2 special configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">csi2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_width</span> <span class="o">=</span> <span class="p">((</span><span class="n">in_width</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">left_offset</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set CAMOR, CAPWR, CFSZR, take care of CDWDR */</span>
	<span class="n">camor</span> <span class="o">=</span> <span class="n">left_offset</span> <span class="o">|</span> <span class="p">(</span><span class="n">top_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
		<span class="s">&quot;CAMOR 0x%x, CAPWR 0x%x, CFSZR 0x%x, CDWDR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">camor</span><span class="p">,</span>
		<span class="p">(</span><span class="n">in_height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">in_width</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">width</span><span class="p">,</span>
		<span class="n">cdwdr_width</span><span class="p">);</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAMOR</span><span class="p">,</span> <span class="n">camor</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPWR</span><span class="p">,</span> <span class="p">(</span><span class="n">in_height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">in_width</span><span class="p">);</span>
	<span class="cm">/* CFSZR clipping is applied _after_ the scaling filter (CFLCR) */</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CFSZR</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">width</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CDWDR</span><span class="p">,</span> <span class="n">cdwdr_width</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">capture_save_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">capsr</span> <span class="o">=</span> <span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span> <span class="cm">/* reset, stop capture */</span>
	<span class="k">return</span> <span class="n">capsr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">capture_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">capsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the end of the current frame. It can take a long time,</span>
<span class="cm">	 * but if it has been aborted by a CAPSR reset, it shoule exit sooner.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CSTSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Timeout waiting for frame end! Interface problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait until reset clears, this shall not hang... */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ceu_read</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Anything to restore? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capsr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span>
		<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPSR</span><span class="p">,</span> <span class="n">capsr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Find the bus subdevice driver, e.g., CSI2 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">find_bus_subdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">csi2_sd</span> <span class="o">=</span> <span class="n">find_csi2</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csi2_sd</span> <span class="o">&amp;&amp;</span> <span class="n">csi2_sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">==</span> <span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">csi2_sd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CEU_BUS_FLAGS (V4L2_MBUS_MASTER |	\</span>
<span class="cp">		V4L2_MBUS_PCLK_SAMPLE_RISING |	\</span>
<span class="cp">		V4L2_MBUS_HSYNC_ACTIVE_HIGH |	\</span>
<span class="cp">		V4L2_MBUS_HSYNC_ACTIVE_LOW |	\</span>
<span class="cp">		V4L2_MBUS_VSYNC_ACTIVE_HIGH |	\</span>
<span class="cp">		V4L2_MBUS_VSYNC_ACTIVE_LOW |	\</span>
<span class="cp">		V4L2_MBUS_DATA_ACTIVE_HIGH)</span>

<span class="cm">/* Capture is not running, no interrupts, no locking needed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_set_bus_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">find_bus_subdev</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">,};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">,</span> <span class="n">common_flags</span> <span class="o">=</span> <span class="n">CEU_BUS_FLAGS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capsr</span> <span class="o">=</span> <span class="n">capture_save_reset</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yuv_lineskip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the client doesn&#39;t implement g_mbus_config, we just use our</span>
<span class="cm">	 * platform data</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_mbus_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common_flags</span> <span class="o">=</span> <span class="n">soc_mbus_config_compatible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span>
							  <span class="n">common_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_flags</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make choises, based on platform preferences */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_CEU_FLAG_HSYNC_LOW</span><span class="p">)</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_CEU_FLAG_VSYNC_LOW</span><span class="p">)</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">common_flags</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_mbus_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">is_16bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">is_16bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CRCNTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CRCMPR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00000010</span><span class="p">;</span> <span class="cm">/* data fetch by default */</span>
	<span class="n">yuv_lineskip</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV12</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV21</span>:
		<span class="cm">/* convert 4:2:2 -&gt; 4:2:0 */</span>
		<span class="n">yuv_lineskip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* skip for NV12/21, no skip for NV16/61 */</span>
		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV16</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV61</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="cm">/* Cb0, Y0, Cr0, Y1 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_VYUY8_2X8</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">;</span> <span class="cm">/* Cr0, Y0, Cb0, Y1 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00000200</span><span class="p">;</span> <span class="cm">/* Y0, Cb0, Y1, Cr0 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YVYU8_2X8</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00000300</span><span class="p">;</span> <span class="cm">/* Y0, Cr0, Y1, Cb0 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV21</span> <span class="o">||</span>
	    <span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV61</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">^=</span> <span class="mh">0x00000100</span><span class="p">;</span> <span class="cm">/* swap U, V to change from NV1x-&gt;NVx1 */</span>

	<span class="n">value</span> <span class="o">|=</span> <span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">csi2</span><span class="p">)</span> <span class="cm">/* CSI2 mode */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">is_16bit</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_CEU_FLAG_LOWER_8BIT</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAMCR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAPCR</span><span class="p">,</span> <span class="mh">0x00300000</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED_TB</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x101</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED_BT</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x102</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CAIFR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">sh_mobile_ceu_set_rect</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;CFLCR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">cflcr</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CFLCR</span><span class="p">,</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">cflcr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * A few words about byte order (observed in Big Endian mode)</span>
<span class="cm">	 *</span>
<span class="cm">	 * In data fetch mode bytes are received in chunks of 8 bytes.</span>
<span class="cm">	 * D0, D1, D2, D3, D4, D5, D6, D7 (D0 received first)</span>
<span class="cm">	 *</span>
<span class="cm">	 * The data is however by default written to memory in reverse order:</span>
<span class="cm">	 * D7, D6, D5, D4, D3, D2, D1, D0 (D7 written to lowest byte)</span>
<span class="cm">	 *</span>
<span class="cm">	 * The lowest three bits of CDOCR allows us to do swapping,</span>
<span class="cm">	 * using 7 we swap the data bytes to match the incoming order:</span>
<span class="cm">	 * D0, D1, D2, D3, D4, D5, D6, D7</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00000007</span> <span class="o">|</span> <span class="n">yuv_lineskip</span><span class="p">;</span>

	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CDOCR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CFWCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* keep &quot;datafetch firewall&quot; disabled */</span>

	<span class="n">capture_restore</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">capsr</span><span class="p">);</span>

	<span class="cm">/* not in bundle mode: skip CBDSR, CDAYR2, CDACR2, CDBYR2, CDBCR2 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_try_bus_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buswidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">find_bus_subdev</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">icd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">common_flags</span> <span class="o">=</span> <span class="n">CEU_BUS_FLAGS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">,};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_mbus_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">common_flags</span> <span class="o">=</span> <span class="n">soc_mbus_config_compatible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span>
							  <span class="n">common_flags</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_flags</span> <span class="o">||</span> <span class="n">buswidth</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="n">sh_mobile_ceu_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">fourcc</span>			<span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;NV12&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_sample</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">packing</span>		<span class="o">=</span> <span class="n">SOC_MBUS_PACKING_1_5X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">order</span>			<span class="o">=</span> <span class="n">SOC_MBUS_ORDER_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">layout</span>			<span class="o">=</span> <span class="n">SOC_MBUS_LAYOUT_PLANAR_2Y_C</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fourcc</span>			<span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;NV21&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_sample</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">packing</span>		<span class="o">=</span> <span class="n">SOC_MBUS_PACKING_1_5X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">order</span>			<span class="o">=</span> <span class="n">SOC_MBUS_ORDER_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">layout</span>			<span class="o">=</span> <span class="n">SOC_MBUS_LAYOUT_PLANAR_2Y_C</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fourcc</span>			<span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;NV16&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_sample</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">packing</span>		<span class="o">=</span> <span class="n">SOC_MBUS_PACKING_2X8_PADHI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">order</span>			<span class="o">=</span> <span class="n">SOC_MBUS_ORDER_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">layout</span>			<span class="o">=</span> <span class="n">SOC_MBUS_LAYOUT_PLANAR_Y_C</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fourcc</span>			<span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV61</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;NV61&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_sample</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">packing</span>		<span class="o">=</span> <span class="n">SOC_MBUS_PACKING_2X8_PADHI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">order</span>			<span class="o">=</span> <span class="n">SOC_MBUS_ORDER_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">layout</span>			<span class="o">=</span> <span class="n">SOC_MBUS_LAYOUT_PLANAR_Y_C</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* This will be corrected as we get more formats */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">sh_mobile_ceu_packing_supported</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">SOC_MBUS_PACKING_NONE</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		 <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">SOC_MBUS_PACKING_1_5X8</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		 <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">SOC_MBUS_PACKING_2X8_PADHI</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		 <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">SOC_MBUS_PACKING_EXTEND16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">client_g_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="nf">ctrl_to_icd</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_camera_device</span><span class="p">,</span>
							<span class="n">ctrl_handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">ctrl_to_icd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SHARPNESS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV12</span>:
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV21</span>:
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV16</span>:
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV61</span>:
			<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CLFCR</span><span class="p">,</span> <span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">sh_mobile_ceu_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_get_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">formats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">enum_mbus_fmt</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* No more formats */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">soc_mbus_get_fmtdesc</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported format code #%u: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">csi2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Are there any restrictions in the CSI-2 case? */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_try_bus_param</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">rect</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Add our control */</span>
		<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh_mobile_ceu_ctrl_ops</span><span class="p">,</span>
				  <span class="n">V4L2_CID_SHARPNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="cm">/* FIXME: subwindow is lost between close / open */</span>

		<span class="cm">/* Cache current client geometry */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">client_g_rect</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* First time */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * All currently existing CEU implementations support 2560x1920</span>
<span class="cm">		 * or larger frames. If the sensor is proposing too big a frame,</span>
<span class="cm">		 * don&#39;t bother with possibly supportred by the CEU larger</span>
<span class="cm">		 * sizes, just try VGA multiples. If needed, this can be</span>
<span class="cm">		 * adjusted in the future.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">mf</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">||</span>
			<span class="n">mf</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Try 2560x1920, 1280x960, 640x480, 320x240 */</span>
			<span class="n">mf</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="mi">2560</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="n">mf</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="mi">1920</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
					<span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">),</span> <span class="n">video</span><span class="p">,</span>
					<span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">shift</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to configure the client below %ux%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;camera fmt %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

		<span class="n">cam</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cam</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* We are called with current camera crop, initialise subrect with it */</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span>	<span class="o">=</span> <span class="n">rect</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span>	<span class="o">=</span> <span class="n">rect</span><span class="p">;</span>

		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

		<span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span> <span class="o">=</span> <span class="n">cam</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Beginning of a pass */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idx</span><span class="p">)</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">extra_fmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_VYUY8_2X8</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YVYU8_2X8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">extra_fmt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Our case is simple so far: for any of the above four camera</span>
<span class="cm">		 * formats we add all our four synthesized NV* formats, so,</span>
<span class="cm">		 * just marking the device with a single flag suffices. If</span>
<span class="cm">		 * the format generation rules are more complex, you would have</span>
<span class="cm">		 * to actually hang your already added / counted formats onto</span>
<span class="cm">		 * the host_priv pointer and check whether the format you&#39;re</span>
<span class="cm">		 * going to add now is already there.</span>
<span class="cm">		 */</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">extra_fmt</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_formats</span><span class="p">;</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sh_mobile_ceu_formats</span><span class="p">);</span>
		<span class="n">formats</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xlate</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_mobile_ceu_formats</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">code</span><span class="p">;</span>
			<span class="n">xlate</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Providing format %s using code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sh_mobile_ceu_formats</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh_mobile_ceu_packing_supported</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Generic pass-through */</span>
	<span class="n">formats</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span>	<span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">code</span><span class="p">;</span>
		<span class="n">xlate</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Providing format %s in pass-through mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">formats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_mobile_ceu_put_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">);</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check if any dimension of r1 is smaller than respective one of r2 */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_smaller</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">r1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">r2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check if r1 fails to cover r2 */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_inside</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">r1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">r2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">||</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&gt;</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">||</span>
		<span class="n">r1</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span>
		<span class="n">r1</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">scale_down</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="mi">4096</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_generic_scale</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">input</span> <span class="o">*</span> <span class="mi">4096</span> <span class="o">+</span> <span class="n">output</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">output</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get and store current client crop */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">client_g_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="n">crop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">crop</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_crop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Camera driver doesn&#39;t support .g_crop(), assume default rectangle */</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">cropcap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Client crop has changed, update our sub-rectangle to remain within the area */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_subrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">,</span> <span class="o">*</span><span class="n">subrect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
		<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
		<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span>
		 <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
		<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span>
			<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&gt;</span> <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span>
		<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span>
		 <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">subrect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span>
			<span class="n">subrect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The common for both scaling and cropping iterative approach is:</span>
<span class="cm"> * 1. try if the client can produce exactly what requested by the user</span>
<span class="cm"> * 2. if (1) failed, try to double the client image until we get one big enough</span>
<span class="cm"> * 3. if (2) failed, try to request the maximum image</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">client_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">cam_crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">cam_rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam_crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>

	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_crop</span><span class="p">,</span> <span class="n">crop</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">client_g_rect</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">cam_rect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now cam_crop contains the current camera input rectangle, and it must</span>
<span class="cm">	 * be within camera cropcap bounds</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">cam_rect</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rect</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Even if camera S_CROP failed, but camera rectangle matches */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Camera S_CROP successful for %dx%d@%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span> <span class="o">=</span> <span class="o">*</span><span class="n">cam_rect</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to fix cropping, that camera hasn&#39;t managed to set */</span>
	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fix camera S_CROP for %dx%d@%d:%d to %dx%d@%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* We need sensor maximum rectangle */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">cropcap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Put user requested rectangle within sensor bounds */</span>
	<span class="n">soc_camera_limit_side</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">soc_camera_limit_side</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			      <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Popular special case - some cameras can only handle fixed sizes like</span>
<span class="cm">	 * QVGA, VGA,... Take care to avoid infinite loop.</span>
<span class="cm">	 */</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop as long as sensor is not covering the requested rectangle and</span>
<span class="cm">	 * is still within its bounds</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">is_smaller</span><span class="p">(</span><span class="n">cam_rect</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">is_inside</span><span class="p">(</span><span class="n">cam_rect</span><span class="p">,</span> <span class="n">rect</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">width</span> <span class="o">||</span> <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">width</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We do not know what capabilities the camera has to set up</span>
<span class="cm">		 * left and top borders. We could try to be smarter in iterating</span>
<span class="cm">		 * them, e.g., if camera current left is to the right of the</span>
<span class="cm">		 * target left, set it to the middle point between the current</span>
<span class="cm">		 * left and minimum left. But that would add too much</span>
<span class="cm">		 * complexity: we would have to iterate each border separately.</span>
<span class="cm">		 * Instead we just drop to the left and top bounds.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span>
				<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&gt;</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span>
				<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>

		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_crop</span><span class="p">,</span> <span class="n">cam_crop</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">client_g_rect</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">cam_rect</span><span class="p">);</span>
		<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Camera S_CROP %d for %dx%d@%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* S_CROP must not modify the rectangle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_smaller</span><span class="p">(</span><span class="n">cam_rect</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_inside</span><span class="p">(</span><span class="n">cam_rect</span><span class="p">,</span> <span class="n">rect</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The camera failed to configure a suitable cropping,</span>
<span class="cm">		 * we cannot use the current rectangle, set to max</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">cam_rect</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">;</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_crop</span><span class="p">,</span> <span class="n">cam_crop</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">client_g_rect</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">cam_rect</span><span class="p">);</span>
		<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Camera S_CROP %d for max %dx%d@%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span> <span class="o">=</span> <span class="o">*</span><span class="n">cam_rect</span><span class="p">;</span>
		<span class="n">update_subrect</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Iterative s_mbus_fmt, also updates cached client crop on success */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">client_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ceu_can_scale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">tmp_w</span><span class="p">,</span> <span class="n">tmp_h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_width</span><span class="p">,</span> <span class="n">max_height</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cap</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ceu_1to1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
					 <span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">),</span> <span class="n">video</span><span class="p">,</span>
					 <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;camera scaled to %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">==</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Perfect! The client has done it all. */</span>
		<span class="n">ceu_1to1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">update_cache</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ceu_1to1</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceu_can_scale</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">update_cache</span><span class="p">;</span>

	<span class="n">cap</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">cropcap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">max_width</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_width</span><span class="p">);</span>
	<span class="n">max_height</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">);</span>

	<span class="cm">/* Camera set a format, but geometry is not precise, try to improve */</span>
	<span class="n">tmp_w</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">tmp_h</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* width &lt;= max_width &amp;&amp; height &lt;= max_height - guaranteed by try_fmt */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">tmp_w</span> <span class="o">||</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">tmp_h</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="n">tmp_w</span> <span class="o">&lt;</span> <span class="n">max_width</span> <span class="o">&amp;&amp;</span> <span class="n">tmp_h</span> <span class="o">&lt;</span> <span class="n">max_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_w</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tmp_w</span><span class="p">,</span> <span class="n">max_width</span><span class="p">);</span>
		<span class="n">tmp_h</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tmp_h</span><span class="p">,</span> <span class="n">max_height</span><span class="p">);</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">tmp_w</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">tmp_h</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
					<span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">),</span> <span class="n">video</span><span class="p">,</span>
					<span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Camera scaled to %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This shouldn&#39;t happen */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Client failed to set format: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">update_cache:</span>
	<span class="cm">/* Update cache */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">client_g_rect</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceu_1to1</span><span class="p">)</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">update_subrect</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @width	- on output: user width, mapped back to input</span>
<span class="cm"> * @height	- on output: user height, mapped back to input</span>
<span class="cm"> * @mf		- in- / output camera output window</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">client_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">height</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">ceu_can_scale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf_tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scale_h</span><span class="p">,</span> <span class="n">scale_v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 5. Apply iterative camera S_FMT for camera user window (also updates</span>
<span class="cm">	 *    client crop cache and the imaginary sub-rectangle).</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">client_s_fmt</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf_tmp</span><span class="p">,</span> <span class="n">ceu_can_scale</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;5: camera scaled to %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mf_tmp</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf_tmp</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* 6. Retrieve camera output window (g_fmt) */</span>

	<span class="cm">/* unneeded - it is already in &quot;mf_tmp&quot; */</span>

	<span class="cm">/* 7. Calculate new client scales. */</span>
	<span class="n">scale_h</span> <span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf_tmp</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">scale_v</span> <span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">mf_tmp</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">mf_tmp</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">mf_tmp</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">mf_tmp</span><span class="p">.</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 8. Calculate new CEU crop - apply camera scales to previously</span>
<span class="cm">	 *    updated &quot;effective&quot; crop.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">);</span>
	<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">scale_v</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;8: new client sub-window %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CEU can scale and crop, but we don&#39;t want to waste bandwidth and kill the</span>
<span class="cm"> * framerate by always requesting the maximum image from the client. See</span>
<span class="cm"> * Documentation/video4linux/sh_mobile_ceu_camera.txt for a description of</span>
<span class="cm"> * scaling and cropping algorithms and for the meaning of referenced here steps.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_set_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="n">cam_crop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">cam_rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam_crop</span><span class="p">.</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scale_cam_h</span><span class="p">,</span> <span class="n">scale_cam_v</span><span class="p">,</span> <span class="n">scale_ceu_h</span><span class="p">,</span> <span class="n">scale_ceu_v</span><span class="p">,</span>
		<span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interm_width</span><span class="p">,</span> <span class="n">interm_height</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capsr</span><span class="p">,</span> <span class="n">cflcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;S_CROP(%ux%u@%u:%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* During camera cropping its output window can change too, stop CEU */</span>
	<span class="n">capsr</span> <span class="o">=</span> <span class="n">capture_save_reset</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CAPSR 0x%x, CFLCR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">capsr</span><span class="p">,</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">cflcr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 1. - 2. Apply iterative camera S_CROP for new input window, read back</span>
<span class="cm">	 * actual camera rectangle.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">client_s_crop</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam_crop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;1-2: camera cropped to %ux%u@%u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		<span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* On success cam_crop contains current camera crop */</span>

	<span class="cm">/* 3. Retrieve camera output window */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">||</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* 4. Calculate camera scales */</span>
	<span class="n">scale_cam_h</span>	<span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">scale_cam_v</span>	<span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* Calculate intermediate window */</span>
	<span class="n">interm_width</span>	<span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">scale_cam_h</span><span class="p">);</span>
	<span class="n">interm_height</span>	<span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">scale_cam_v</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interm_width</span> <span class="o">&lt;</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">new_scale_h</span><span class="p">;</span>

		<span class="n">new_scale_h</span> <span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">);</span>

		<span class="n">mf</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">new_scale_h</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interm_height</span> <span class="o">&lt;</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">new_scale_v</span><span class="p">;</span>

		<span class="n">new_scale_v</span> <span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">);</span>

		<span class="n">mf</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">new_scale_v</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interm_width</span> <span class="o">&lt;</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span> <span class="o">||</span> <span class="n">interm_height</span> <span class="o">&lt;</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
					<span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">),</span> <span class="n">video</span><span class="p">,</span>
					<span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;New camera output %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="n">scale_cam_h</span>	<span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="n">scale_cam_v</span>	<span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="n">interm_width</span>	<span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">scale_cam_h</span><span class="p">);</span>
		<span class="n">interm_height</span>	<span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">scale_cam_v</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Cache camera output window */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">image_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_width</span>	<span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">interm_width</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">);</span>
		<span class="n">out_height</span>	<span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">interm_height</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">out_width</span>	<span class="o">=</span> <span class="n">interm_width</span><span class="p">;</span>
		<span class="n">out_height</span>	<span class="o">=</span> <span class="n">interm_height</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 5. Calculate CEU scales from camera scales from results of (5) and</span>
<span class="cm">	 *    the user window</span>
<span class="cm">	 */</span>
	<span class="n">scale_ceu_h</span>	<span class="o">=</span> <span class="n">calc_scale</span><span class="p">(</span><span class="n">interm_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_width</span><span class="p">);</span>
	<span class="n">scale_ceu_v</span>	<span class="o">=</span> <span class="n">calc_scale</span><span class="p">(</span><span class="n">interm_height</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_height</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;5: CEU scales %u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scale_ceu_h</span><span class="p">,</span> <span class="n">scale_ceu_v</span><span class="p">);</span>

	<span class="cm">/* Apply CEU scales. */</span>
	<span class="n">cflcr</span> <span class="o">=</span> <span class="n">scale_ceu_h</span> <span class="o">|</span> <span class="p">(</span><span class="n">scale_ceu_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflcr</span> <span class="o">!=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">cflcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">cflcr</span> <span class="o">=</span> <span class="n">cflcr</span><span class="p">;</span>
		<span class="n">ceu_write</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">CFLCR</span><span class="p">,</span> <span class="n">cflcr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span>	 <span class="o">=</span> <span class="n">out_width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span> <span class="o">=</span> <span class="n">out_height</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* Offsets are applied at the CEU scaling filter input */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_left</span>	 <span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">-</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">scale_cam_h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_top</span>	 <span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">-</span> <span class="n">cam_rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">scale_cam_v</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* 6. Use CEU cropping to crop to the new window. */</span>
	<span class="n">sh_mobile_ceu_set_rect</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span> <span class="o">=</span> <span class="o">*</span><span class="n">rect</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;6: CEU cropped to %ux%u@%u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">,</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_left</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">ceu_top</span><span class="p">);</span>

	<span class="cm">/* Restore capture. The CE bit can be cleared by the hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">capsr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">capture_restore</span><span class="p">(</span><span class="n">pcdev</span><span class="p">,</span> <span class="n">capsr</span><span class="p">);</span>

	<span class="cm">/* Even if only camera cropping succeeded */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_get_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate real client output window by applying new scales to the current</span>
<span class="cm"> * client crop. New scales are calculated from the requested output format and</span>
<span class="cm"> * CEU crop, mapped backed onto the client input (subrect).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">calculate_client_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">cam_subrect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">subrect</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scale_v</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No sub-cropping */</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 1.-2. Current camera scales and subwin - cached. */</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;2: subwin %ux%u@%u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		<span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 3. Calculate new combined scales from input sub-window to requested</span>
<span class="cm">	 *    user window.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: CEU cannot scale images larger than VGA to smaller than SubQCIF</span>
<span class="cm">	 * (128x96) or larger than VGA</span>
<span class="cm">	 */</span>
	<span class="n">scale_h</span> <span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="n">scale_v</span> <span class="o">=</span> <span class="n">calc_generic_scale</span><span class="p">(</span><span class="n">cam_subrect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;3: scales %u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">,</span> <span class="n">scale_v</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 4. Calculate desired client output window by applying combined scales</span>
<span class="cm">	 *    to client (real) input window.</span>
<span class="cm">	 */</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">);</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">scale_down</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">scale_v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Similar to set_crop multistage iterative algorithm */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">pixfmt</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span><span class="p">;</span>
	<span class="cm">/* Keep Compiler Happy */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ceu_sub_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ceu_sub_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scale_v</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">image_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED_TB</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED_BT</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_NONE</span>:
		<span class="n">field</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED_TB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xlate</span> <span class="o">=</span> <span class="n">soc_camera_xlate_by_fourcc</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Format %x not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 1.-4. Calculate desired client output geometry */</span>
	<span class="n">calculate_client_output</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">field</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV12</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV21</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV16</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV61</span>:
		<span class="n">image_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">image_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;S_FMT(pix=0x%x, fld 0x%x, code 0x%x, %ux%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">field</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;4: request camera output %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* 5. - 9. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">client_scale</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceu_sub_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceu_sub_height</span><span class="p">,</span>
			   <span class="n">image_mode</span> <span class="o">&amp;&amp;</span> <span class="n">V4L2_FIELD_NONE</span> <span class="o">==</span> <span class="n">field</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;5-9: client scale return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Done with the camera. Now see if we can improve the result */</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fmt %ux%u, requested %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* 9. Prepare CEU crop */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* 10. Use CEU scaling to scale to the requested user window. */</span>

	<span class="cm">/* We cannot scale up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">ceu_sub_width</span><span class="p">)</span>
		<span class="n">ceu_sub_width</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">ceu_sub_height</span><span class="p">)</span>
		<span class="n">ceu_sub_height</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Scale pix-&gt;{width x height} down to width x height */</span>
		<span class="n">scale_h</span>		<span class="o">=</span> <span class="n">calc_scale</span><span class="p">(</span><span class="n">ceu_sub_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
		<span class="n">scale_v</span>		<span class="o">=</span> <span class="n">calc_scale</span><span class="p">(</span><span class="n">ceu_sub_height</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">ceu_sub_width</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">ceu_sub_height</span><span class="p">;</span>
		<span class="n">scale_h</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scale_v</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">cflcr</span> <span class="o">=</span> <span class="n">scale_h</span> <span class="o">|</span> <span class="p">(</span><span class="n">scale_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have calculated CFLCR, the actual configuration will be performed</span>
<span class="cm">	 * in sh_mobile_ceu_set_bus_param()</span>
<span class="cm">	 */</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;10: W: %u : 0x%x = %u, H: %u : 0x%x = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ceu_sub_width</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
		<span class="n">ceu_sub_height</span><span class="p">,</span> <span class="n">scale_v</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">code</span>		<span class="o">=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span>	<span class="o">=</span> <span class="n">xlate</span><span class="p">;</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">image_mode</span> <span class="o">=</span> <span class="n">image_mode</span><span class="p">;</span>

	<span class="cm">/* CFSZR requirement */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CEU_CHDW_MAX	8188U	</span><span class="cm">/* Maximum line stride */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">pixfmt</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;TRY_FMT(pix=0x%x, %ux%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pixfmt</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">xlate</span> <span class="o">=</span> <span class="n">soc_camera_xlate_by_fourcc</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xlate</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Format %x not found, keeping %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pixfmt</span><span class="p">,</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">);</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: calculate using depth and bus width */</span>

	<span class="cm">/* CFSZR requires height and width to be 4-pixel aligned */</span>
	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_width</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* limit to sensor capabilities */</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">field</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">),</span>
					 <span class="n">video</span><span class="p">,</span> <span class="n">try_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pixfmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV12</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV21</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV16</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV61</span>:
		<span class="cm">/* FIXME: check against rect_max after converting soc-camera */</span>
		<span class="cm">/* We can scale precisely, need a bigger image from camera */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="o">||</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We presume, the sensor behaves sanely, i.e., if</span>
<span class="cm">			 * requested a bigger rectangle, it will not return a</span>
<span class="cm">			 * smaller one.</span>
<span class="cm">			 */</span>
			<span class="n">mf</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_width</span><span class="p">;</span>
			<span class="n">mf</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
					<span class="n">soc_camera_grp_id</span><span class="p">(</span><span class="n">icd</span><span class="p">),</span> <span class="n">video</span><span class="p">,</span>
					<span class="n">try_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Shouldn&#39;t actually happen... */</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
					<span class="s">&quot;FIXME: client try_fmt() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* We will scale exactly */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">)</span>
			<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">)</span>
			<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>

		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">,</span> <span class="n">CEU_CHDW_MAX</span><span class="p">);</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Configurable stride isn&#39;t supported in pass-through mode. */</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;%s(): return %d, fmt 0x%x, %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_set_livecrop</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">out_width</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">,</span> <span class="n">out_height</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Freeze queue */</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">frozen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Wait for frame */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
	<span class="cm">/* Stop the client */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
			 <span class="s">&quot;Client failed to stop the stream: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Do the crop, if it fails, there&#39;s nothing more we can do */</span>
		<span class="n">sh_mobile_ceu_set_crop</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

	<span class="n">dev_geo</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Output after crop: %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span> <span class="o">!=</span> <span class="n">out_width</span> <span class="o">||</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span> <span class="o">!=</span> <span class="n">out_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="n">f</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span>	<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">out_width</span><span class="p">,</span>
				<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">out_height</span><span class="p">,</span>
				<span class="p">.</span><span class="n">pixelformat</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">,</span>
				<span class="p">.</span><span class="n">field</span>		<span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">,</span>
				<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">};</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_set_fmt</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">out_width</span> <span class="o">!=</span> <span class="n">f</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span>
			     <span class="n">out_height</span> <span class="o">!=</span> <span class="n">f</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span>		<span class="o">=</span> <span class="n">out_width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
			<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span>	<span class="o">=</span> <span class="n">out_height</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_set_bus_param</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Thaw the queue */</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">frozen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sh_mobile_ceu_capture</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Start the client */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vb2_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">vb2_vidq</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;SuperH_Mobile_CEU&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_init_videobuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span> <span class="o">|</span> <span class="n">VB2_USERPTR</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span> <span class="o">=</span> <span class="n">icd</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_mobile_ceu_videobuf_ops</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">mem_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vb2_dma_contig_memops</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">buf_struct_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_ceu_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vb2_queue_init</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">soc_camera_host_ops</span> <span class="n">sh_mobile_ceu_host_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span>		<span class="o">=</span> <span class="n">sh_mobile_ceu_add_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">sh_mobile_ceu_remove_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_formats</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_get_formats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_formats</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_put_formats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_crop</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_get_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_crop</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_set_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_livecrop</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_set_livecrop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_set_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_fmt</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">sh_mobile_ceu_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querycap</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bus_param</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_set_bus_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_videobuf2</span>	<span class="o">=</span> <span class="n">sh_mobile_ceu_init_videobuf</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bus_wait</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">notifier_block</span>	<span class="n">notifier</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">completion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bus_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_wait</span> <span class="o">*</span><span class="n">wait</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_wait</span><span class="p">,</span> <span class="n">notifier</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BUS_NOTIFY_UNBOUND_DRIVER</span>:
		<span class="cm">/* Protect from module unloading */</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sh_mobile_ceu_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_wait</span> <span class="n">wait</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">COMPLETION_INITIALIZER_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">.</span><span class="n">completion</span><span class="p">),</span>
		<span class="p">.</span><span class="n">notifier</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">bus_notify</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_companion</span> <span class="o">*</span><span class="n">csi2</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough CEU platform resources.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pcdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not allocate pcdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CEU platform data not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">2560</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1920</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to ioremap CEU registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">video_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* only enabled if second resource exists */</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dma_declare_coherent_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						  <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						  <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
						  <span class="n">DMA_MEMORY_MAP</span> <span class="o">|</span>
						  <span class="n">DMA_MEMORY_EXCLUSIVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to declare CEU memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_iounmap</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">video_limit</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* request irq */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sh_mobile_ceu_irq</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
			  <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">pcdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to register CEU interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_release_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_suspend_ignore_children</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pcdev</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_mobile_ceu_host_ops</span><span class="p">;</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">SOCAM_HOST_CAP_STRIDE</span><span class="p">;</span>

	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span> <span class="o">=</span> <span class="n">vb2_dma_contig_init_ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_free_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">soc_camera_host_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_free_ctx</span><span class="p">;</span>

	<span class="cm">/* CSI2 interfacing */</span>
	<span class="n">csi2</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">csi2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">csi2_pdev</span> <span class="o">=</span>
			<span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;sh-mobile-csi2&quot;</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sh_csi2_pdata</span> <span class="o">*</span><span class="n">csi2_pdata</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csi2_pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_host_unregister</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span>		<span class="o">=</span> <span class="n">csi2_pdev</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">csi2_pdev</span><span class="p">,</span> <span class="n">csi2_pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">csi2_pdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_pdev_put</span><span class="p">;</span>

		<span class="n">csi2_pdata</span>			<span class="o">=</span> <span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
		<span class="n">csi2_pdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">;</span>

		<span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">resource</span>		<span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">;</span>
		<span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">num_resources</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">csi2_pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_pdev_put</span><span class="p">;</span>

		<span class="n">wait</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">bus_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">notifier</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_pdev_unregister</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * From this point the driver module will not unload, until</span>
<span class="cm">		 * we complete the completion.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
			<span class="cm">/* Either too late, or probing failed */</span>
			<span class="n">bus_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">notifier</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_pdev_unregister</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The module is still loaded, in the worst case it is hanging</span>
<span class="cm">		 * in device release on our completion. So, _now_ dereferencing</span>
<span class="cm">		 * the &quot;owner&quot; is safe!</span>
<span class="cm">		 */</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">try_module_get</span><span class="p">(</span><span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

		<span class="cm">/* Let notifier complete, if it has been locked */</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
		<span class="n">bus_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">notifier</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_pdev_unregister</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_pdev_unregister:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span><span class="p">);</span>
<span class="nl">exit_pdev_put:</span>
	<span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span><span class="p">);</span>
<span class="nl">exit_host_unregister:</span>
	<span class="n">soc_camera_host_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">ici</span><span class="p">);</span>
<span class="nl">exit_free_ctx:</span>
	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">);</span>
<span class="nl">exit_free_clk:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pcdev</span><span class="p">);</span>
<span class="nl">exit_release_mem:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">dma_release_declared_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="nl">exit_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">sh_mobile_ceu_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">soc_host</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span> <span class="o">*</span><span class="n">pcdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">soc_host</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sh_mobile_ceu_dev</span><span class="p">,</span> <span class="n">ici</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">csi2_pdev</span> <span class="o">=</span> <span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">csi2_pdev</span><span class="p">;</span>

	<span class="n">soc_camera_host_unregister</span><span class="p">(</span><span class="n">soc_host</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pcdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">dma_release_declared_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">pcdev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2_pdev</span> <span class="o">&amp;&amp;</span> <span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">csi2_drv</span> <span class="o">=</span> <span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="n">platform_device_del</span><span class="p">(</span><span class="n">csi2_pdev</span><span class="p">);</span>
		<span class="n">csi2_pdev</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">platform_device_put</span><span class="p">(</span><span class="n">csi2_pdev</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">csi2_drv</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mobile_ceu_runtime_nop</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Runtime PM callback shared between -&gt;runtime_suspend()</span>
<span class="cm">	 * and -&gt;runtime_resume(). Simply returns success.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This driver re-initializes all registers after</span>
<span class="cm">	 * pm_runtime_get_sync() anyway so there is no need</span>
<span class="cm">	 * to save and restore registers here.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">sh_mobile_ceu_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_runtime_nop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">sh_mobile_ceu_runtime_nop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sh_mobile_ceu_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> 	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sh_mobile_ceu&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_mobile_ceu_dev_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sh_mobile_ceu_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sh_mobile_ceu_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sh_mobile_ceu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Whatever return code */</span>
	<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;sh_mobile_csi2&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_mobile_ceu_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sh_mobile_ceu_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_mobile_ceu_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sh_mobile_ceu_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sh_mobile_ceu_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SuperH Mobile CEU driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Magnus Damm&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.0.6&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:sh_mobile_ceu&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
