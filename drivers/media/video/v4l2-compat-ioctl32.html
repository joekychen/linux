<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › v4l2-compat-ioctl32.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>v4l2-compat-ioctl32.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ioctl32.c: Conversion between 32bit and 64bit native ioctls.</span>
<span class="cm"> *	Separated from fs stuff by Arnd Bergmann &lt;arnd@arndb.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997-2000  Jakub Jelinek  (jakub@redhat.com)</span>
<span class="cm"> * Copyright (C) 1998  Eddie C. Dost  (ecd@skynet.be)</span>
<span class="cm"> * Copyright (C) 2001,2002  Andi Kleen, SuSE Labs</span>
<span class="cm"> * Copyright (C) 2003       Pavel Machek (pavel@ucw.cz)</span>
<span class="cm"> * Copyright (C) 2005       Philippe De Muyter (phdm@macqel.be)</span>
<span class="cm"> * Copyright (C) 2008       Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * These routines maintain argument size conversion between 32bit and 64bit</span>
<span class="cm"> * ioctls.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-dev.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">native_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">unlocked_ioctl</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">unlocked_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">v4l2_clip32</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span>        <span class="n">c</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> 		<span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">v4l2_window32</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span>        <span class="n">w</span><span class="p">;</span>
	<span class="n">__u32</span>		  	<span class="n">field</span><span class="p">;</span>	<span class="cm">/* enum v4l2_field */</span>
	<span class="n">__u32</span>			<span class="n">chromakey</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>		<span class="n">clips</span><span class="p">;</span> <span class="cm">/* actually struct v4l2_clip32 * */</span>
	<span class="n">__u32</span>			<span class="n">clipcount</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>		<span class="n">bitmap</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_window32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_window32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_window32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">chromakey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">chromakey</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">clipcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">clipcount</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">clipcount</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">clipcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_clip32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uclips</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_clip</span> <span class="n">__user</span> <span class="o">*</span><span class="n">kclips</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">clipcount</span><span class="p">;</span>
		<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">clips</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">uclips</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">kclips</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_clip</span><span class="p">));</span>
		<span class="n">kp</span><span class="o">-&gt;</span><span class="n">clips</span> <span class="o">=</span> <span class="n">kclips</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kclips</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uclips</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uclips</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">n</span> <span class="o">?</span> <span class="n">kclips</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kclips</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">uclips</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">kclips</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kp</span><span class="o">-&gt;</span><span class="n">clips</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_window32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_window32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">chromakey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">chromakey</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">clipcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">clipcount</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_v4l2_pix_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_v4l2_pix_format_mplane</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">put_v4l2_pix_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">put_v4l2_pix_format_mplane</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_v4l2_vbi_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_vbi_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_vbi_format</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_vbi_format</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">put_v4l2_vbi_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_vbi_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_vbi_format</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_vbi_format</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_v4l2_sliced_vbi_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">put_v4l2_sliced_vbi_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_format32</span> <span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">type</span><span class="p">;</span>	<span class="cm">/* enum v4l2_buf_type */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_pix_format</span>	<span class="n">pix</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span>	<span class="n">pix_mp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_window32</span>	<span class="n">win</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_vbi_format</span>	<span class="n">vbi</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span>	<span class="n">sliced</span><span class="p">;</span>
		<span class="n">__u8</span>	<span class="n">raw_data</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>        <span class="cm">/* user-defined */</span>
	<span class="p">}</span> <span class="n">fmt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct v4l2_create_buffers32 - VIDIOC_CREATE_BUFS32 argument</span>
<span class="cm"> * @index:	on return, index of the first created buffer</span>
<span class="cm"> * @count:	entry: number of requested buffers,</span>
<span class="cm"> *		return: number of created buffers</span>
<span class="cm"> * @memory:	buffer memory type</span>
<span class="cm"> * @format:	frame format, for which buffers are requested</span>
<span class="cm"> * @reserved:	future extensions</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">v4l2_create_buffers32</span> <span class="p">{</span>
	<span class="n">__u32</span>			<span class="n">index</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">count</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">memory</span><span class="p">;</span>	<span class="cm">/* enum v4l2_memory */</span>
	<span class="k">struct</span> <span class="n">v4l2_format32</span>	<span class="n">format</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">reserved</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__get_v4l2_format32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span>:
		<span class="k">return</span> <span class="n">get_v4l2_pix_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span>:
		<span class="k">return</span> <span class="n">get_v4l2_pix_format_mplane</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY</span>:
		<span class="k">return</span> <span class="n">get_v4l2_window32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_OUTPUT</span>:
		<span class="k">return</span> <span class="n">get_v4l2_vbi_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_CAPTURE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_OUTPUT</span>:
		<span class="k">return</span> <span class="n">get_v4l2_sliced_vbi_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_PRIVATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">raw_data</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;compat_ioctl32: unexpected VIDIOC_FMT type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_format32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_format32</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__get_v4l2_format32</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_create32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_create_buffers</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_create_buffers32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_create_buffers32</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_create_buffers32</span><span class="p">,</span> <span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__get_v4l2_format32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__put_v4l2_format32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span>:
		<span class="k">return</span> <span class="n">put_v4l2_pix_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span>:
		<span class="k">return</span> <span class="n">put_v4l2_pix_format_mplane</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY</span>:
		<span class="k">return</span> <span class="n">put_v4l2_window32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_OUTPUT</span>:
		<span class="k">return</span> <span class="n">put_v4l2_vbi_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_CAPTURE</span>:
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_OUTPUT</span>:
		<span class="k">return</span> <span class="n">put_v4l2_sliced_vbi_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_PRIVATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">raw_data</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;compat_ioctl32: unexpected VIDIOC_FMT type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_format32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_format32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__put_v4l2_format32</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_create32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_create_buffers</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_create_buffers32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_create_buffers32</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_create_buffers32</span><span class="p">,</span> <span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__put_v4l2_format32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_standard32</span> <span class="p">{</span>
	<span class="n">__u32</span>		     <span class="n">index</span><span class="p">;</span>
	<span class="n">__u32</span>		     <span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* __u64 would get the alignment wrong */</span>
	<span class="n">__u8</span>		     <span class="n">name</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_fract</span>    <span class="n">frameperiod</span><span class="p">;</span> <span class="cm">/* Frames, not fields */</span>
	<span class="n">__u32</span>		     <span class="n">framelines</span><span class="p">;</span>
	<span class="n">__u32</span>		     <span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_standard32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_standard</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_standard32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* other fields are not set by the user, nor used by the driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_standard32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_standard32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_standard</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_standard32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_standard32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">frameperiod</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">frameperiod</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">frameperiod</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">framelines</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">framelines</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_plane32</span> <span class="p">{</span>
	<span class="n">__u32</span>			<span class="n">bytesused</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">length</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">__u32</span>		<span class="n">mem_offset</span><span class="p">;</span>
		<span class="n">compat_long_t</span>	<span class="n">userptr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">data_offset</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">reserved</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">v4l2_buffer32</span> <span class="p">{</span>
	<span class="n">__u32</span>			<span class="n">index</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">type</span><span class="p">;</span>	<span class="cm">/* enum v4l2_buf_type */</span>
	<span class="n">__u32</span>			<span class="n">bytesused</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">field</span><span class="p">;</span>	<span class="cm">/* enum v4l2_field */</span>
	<span class="k">struct</span> <span class="n">compat_timeval</span>	<span class="n">timestamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_timecode</span>	<span class="n">timecode</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">sequence</span><span class="p">;</span>

	<span class="cm">/* memory location */</span>
	<span class="n">__u32</span>			<span class="n">memory</span><span class="p">;</span>	<span class="cm">/* enum v4l2_memory */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">__u32</span>           <span class="n">offset</span><span class="p">;</span>
		<span class="n">compat_long_t</span>   <span class="n">userptr</span><span class="p">;</span>
		<span class="n">compat_caddr_t</span>  <span class="n">planes</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">length</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">input</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_plane32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_plane</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_plane32</span> <span class="o">*</span><span class="n">up32</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_memory</span> <span class="n">memory</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up_pln</span><span class="p">;</span>
	<span class="n">compat_long_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">up32</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up32</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memory</span> <span class="o">==</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up32</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">up_pln</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">up_pln</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">mem_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up32</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">mem_offset</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_plane32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_plane</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_plane32</span> <span class="o">*</span><span class="n">up32</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_memory</span> <span class="n">memory</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">up32</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up32</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* For MMAP, driver might&#39;ve set up the offset, so copy it back.</span>
<span class="cm">	 * USERPTR stays the same (was userspace-provided), so no copying. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memory</span> <span class="o">==</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up32</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">mem_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">mem_offset</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_buffer32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_plane32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uplane32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_plane</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uplane</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_planes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_buffer32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_TYPE_IS_OUTPUT</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_TYPE_IS_MULTIPLANAR</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">num_planes</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_planes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">planes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* num_planes == 0 is legal, e.g. when userspace doesn&#39;t</span>
<span class="cm">			 * need planes array on DQBUF*/</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">planes</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">uplane32</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">uplane32</span><span class="p">,</span>
				<span class="n">num_planes</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_plane32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="cm">/* We don&#39;t really care if userspace decides to kill itself</span>
<span class="cm">		 * by passing a very big num_planes value */</span>
		<span class="n">uplane</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">num_planes</span> <span class="o">*</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_plane</span><span class="p">));</span>
		<span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">planes</span> <span class="o">=</span> <span class="n">uplane</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">num_planes</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_v4l2_plane32</span><span class="p">(</span><span class="n">uplane</span><span class="p">,</span> <span class="n">uplane32</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="o">++</span><span class="n">uplane</span><span class="p">;</span>
			<span class="o">++</span><span class="n">uplane32</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MEMORY_MMAP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MEMORY_USERPTR</span>:
			<span class="p">{</span>
			<span class="n">compat_long_t</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">get_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MEMORY_OVERLAY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_buffer32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_plane32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uplane32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_plane</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uplane</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_planes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_buffer32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">timecode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">timecode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_timecode</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_TYPE_IS_MULTIPLANAR</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">num_planes</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_planes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">uplane</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">planes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">planes</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">uplane32</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">num_planes</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">put_v4l2_plane32</span><span class="p">(</span><span class="n">uplane</span><span class="p">,</span> <span class="n">uplane32</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="o">++</span><span class="n">uplane</span><span class="p">;</span>
			<span class="o">++</span><span class="n">uplane32</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MEMORY_MMAP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MEMORY_USERPTR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MEMORY_OVERLAY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_framebuffer32</span> <span class="p">{</span>
	<span class="n">__u32</span>			<span class="n">capability</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> 		<span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span>	<span class="n">fmt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_framebuffer32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_framebuffer32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_framebuffer32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">get_v4l2_pix_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_framebuffer32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_framebuffer32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_framebuffer32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">put_v4l2_pix_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_input32</span> <span class="p">{</span>
	<span class="n">__u32</span>	     <span class="n">index</span><span class="p">;</span>		<span class="cm">/*  Which input */</span>
	<span class="n">__u8</span>	     <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>		<span class="cm">/*  Label */</span>
	<span class="n">__u32</span>	     <span class="n">type</span><span class="p">;</span>		<span class="cm">/*  Type of input */</span>
	<span class="n">__u32</span>	     <span class="n">audioset</span><span class="p">;</span>		<span class="cm">/*  Associated audios (bitfield) */</span>
	<span class="n">__u32</span>        <span class="n">tuner</span><span class="p">;</span>             <span class="cm">/*  Associated tuner */</span>
	<span class="n">v4l2_std_id</span>  <span class="n">std</span><span class="p">;</span>
	<span class="n">__u32</span>	     <span class="n">status</span><span class="p">;</span>
	<span class="n">__u32</span>	     <span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* The 64-bit v4l2_input struct has extra padding at the end of the struct.</span>
<span class="cm">   Otherwise it is identical to the 32-bit version. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_v4l2_input32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_input32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">put_v4l2_input32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_input32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_ext_controls32</span> <span class="p">{</span>
       <span class="n">__u32</span> <span class="n">ctrl_class</span><span class="p">;</span>
       <span class="n">__u32</span> <span class="n">count</span><span class="p">;</span>
       <span class="n">__u32</span> <span class="n">error_idx</span><span class="p">;</span>
       <span class="n">__u32</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
       <span class="n">compat_caddr_t</span> <span class="n">controls</span><span class="p">;</span> <span class="cm">/* actually struct v4l2_ext_control32 * */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">v4l2_ext_control32</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">__s32</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">__s64</span> <span class="n">value64</span><span class="p">;</span>
		<span class="n">compat_caddr_t</span> <span class="n">string</span><span class="p">;</span> <span class="cm">/* actually char * */</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* The following function really belong in v4l2-common, but that causes</span>
<span class="cm">   a circular dependency between modules. We need to think about this, but</span>
<span class="cm">   for now this will do. */</span>

<span class="cm">/* Return non-zero if this control is a pointer type. Currently only</span>
<span class="cm">   type STRING is a pointer type. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ctrl_is_pointer</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_v4l2_ext_controls32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_controls32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ucontrols</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">__user</span> <span class="o">*</span><span class="n">kcontrols</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_controls32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">error_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">error_idx</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kp</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">ucontrols</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">ucontrols</span><span class="p">,</span>
			<span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_control32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">kcontrols</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_control</span><span class="p">));</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">=</span> <span class="n">kcontrols</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">kcontrols</span><span class="p">,</span> <span class="n">ucontrols</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ucontrols</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_is_pointer</span><span class="p">(</span><span class="n">kcontrols</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrols</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kcontrols</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ucontrols</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kcontrols</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_ext_controls32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_controls32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ucontrols</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">__user</span> <span class="o">*</span><span class="n">kcontrols</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_controls32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">error_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">error_idx</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">ucontrols</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">ucontrols</span><span class="p">,</span>
			<span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_control32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ucontrols</span><span class="p">);</span>

		<span class="cm">/* Do not modify the pointer when copying a pointer control.</span>
<span class="cm">		   The contents of the pointer was changed, not the pointer</span>
<span class="cm">		   itself. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_is_pointer</span><span class="p">(</span><span class="n">kcontrols</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ucontrols</span><span class="o">-&gt;</span><span class="n">value64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">ucontrols</span><span class="p">,</span> <span class="n">kcontrols</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ucontrols</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kcontrols</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_event32</span> <span class="p">{</span>
	<span class="n">__u32</span>				<span class="n">type</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">__u8</span>			<span class="n">data</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">__u32</span>				<span class="n">pending</span><span class="p">;</span>
	<span class="n">__u32</span>				<span class="n">sequence</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compat_timespec</span>		<span class="n">timestamp</span><span class="p">;</span>
	<span class="n">__u32</span>				<span class="n">id</span><span class="p">;</span>
	<span class="n">__u32</span>				<span class="n">reserved</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_v4l2_event32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_event</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_event32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_event32</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define VIDIOC_G_FMT32		_IOWR(&#39;V&#39;,  4, struct v4l2_format32)</span>
<span class="cp">#define VIDIOC_S_FMT32		_IOWR(&#39;V&#39;,  5, struct v4l2_format32)</span>
<span class="cp">#define VIDIOC_QUERYBUF32	_IOWR(&#39;V&#39;,  9, struct v4l2_buffer32)</span>
<span class="cp">#define VIDIOC_G_FBUF32		_IOR (&#39;V&#39;, 10, struct v4l2_framebuffer32)</span>
<span class="cp">#define VIDIOC_S_FBUF32		_IOW (&#39;V&#39;, 11, struct v4l2_framebuffer32)</span>
<span class="cp">#define VIDIOC_QBUF32		_IOWR(&#39;V&#39;, 15, struct v4l2_buffer32)</span>
<span class="cp">#define VIDIOC_DQBUF32		_IOWR(&#39;V&#39;, 17, struct v4l2_buffer32)</span>
<span class="cp">#define VIDIOC_ENUMSTD32	_IOWR(&#39;V&#39;, 25, struct v4l2_standard32)</span>
<span class="cp">#define VIDIOC_ENUMINPUT32	_IOWR(&#39;V&#39;, 26, struct v4l2_input32)</span>
<span class="cp">#define VIDIOC_TRY_FMT32      	_IOWR(&#39;V&#39;, 64, struct v4l2_format32)</span>
<span class="cp">#define VIDIOC_G_EXT_CTRLS32    _IOWR(&#39;V&#39;, 71, struct v4l2_ext_controls32)</span>
<span class="cp">#define VIDIOC_S_EXT_CTRLS32    _IOWR(&#39;V&#39;, 72, struct v4l2_ext_controls32)</span>
<span class="cp">#define VIDIOC_TRY_EXT_CTRLS32  _IOWR(&#39;V&#39;, 73, struct v4l2_ext_controls32)</span>
<span class="cp">#define	VIDIOC_DQEVENT32	_IOR (&#39;V&#39;, 89, struct v4l2_event32)</span>
<span class="cp">#define VIDIOC_CREATE_BUFS32	_IOWR(&#39;V&#39;, 92, struct v4l2_create_buffers32)</span>
<span class="cp">#define VIDIOC_PREPARE_BUF32	_IOWR(&#39;V&#39;, 93, struct v4l2_buffer32)</span>

<span class="cp">#define VIDIOC_OVERLAY32	_IOW (&#39;V&#39;, 14, s32)</span>
<span class="cp">#define VIDIOC_STREAMON32	_IOW (&#39;V&#39;, 18, s32)</span>
<span class="cp">#define VIDIOC_STREAMOFF32	_IOW (&#39;V&#39;, 19, s32)</span>
<span class="cp">#define VIDIOC_G_INPUT32	_IOR (&#39;V&#39;, 38, s32)</span>
<span class="cp">#define VIDIOC_S_INPUT32	_IOWR(&#39;V&#39;, 39, s32)</span>
<span class="cp">#define VIDIOC_G_OUTPUT32	_IOR (&#39;V&#39;, 46, s32)</span>
<span class="cp">#define VIDIOC_S_OUTPUT32	_IOWR(&#39;V&#39;, 47, s32)</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">do_video_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="n">v2f</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="n">v2b</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="n">v2fb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="n">v2i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_standard</span> <span class="n">v2s</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="n">v2ecs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">v2ev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_create_buffers</span> <span class="n">v2crt</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">vi</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">karg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* First, convert the command. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_FMT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_G_FMT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_FMT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_S_FMT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_QUERYBUF32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_QUERYBUF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_FBUF32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_G_FBUF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_FBUF32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_S_FBUF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_QBUF32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_QBUF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_DQBUF32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_DQBUF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUMSTD32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_ENUMSTD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUMINPUT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_ENUMINPUT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_TRY_FMT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_TRY_FMT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_EXT_CTRLS32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_G_EXT_CTRLS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_EXT_CTRLS32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_TRY_EXT_CTRLS32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_TRY_EXT_CTRLS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_DQEVENT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_DQEVENT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_OVERLAY32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_OVERLAY</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_STREAMON32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_STREAMON</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_STREAMOFF32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_STREAMOFF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_INPUT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_G_INPUT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_INPUT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_S_INPUT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_OUTPUT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_G_OUTPUT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_OUTPUT32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_S_OUTPUT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_CREATE_BUFS32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_CREATE_BUFS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_PREPARE_BUF32</span>: <span class="n">cmd</span> <span class="o">=</span> <span class="n">VIDIOC_PREPARE_BUF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDIOC_OVERLAY</span>:
	<span class="k">case</span> <span class="n">VIDIOC_STREAMON</span>:
	<span class="k">case</span> <span class="n">VIDIOC_STREAMOFF</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_INPUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_OUTPUT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">vi</span><span class="p">,</span> <span class="p">(</span><span class="n">s32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_INPUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_OUTPUT</span>:
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_FMT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_FMT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_FMT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_v4l2_format32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2f</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_CREATE_BUFS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_v4l2_create32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2crt</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_PREPARE_BUF</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERYBUF</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QBUF</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DQBUF</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_v4l2_buffer32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2b</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_S_FBUF</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_v4l2_framebuffer32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2fb</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_FBUF</span>:
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_ENUMSTD</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_v4l2_standard32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2s</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_ENUMINPUT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_v4l2_input32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2i</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_EXT_CTRLS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_EXT_CTRLS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_EXT_CTRLS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_v4l2_ext_controls32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2ecs</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDIOC_DQEVENT</span>:
		<span class="n">compatible_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compatible_arg</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">native_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">up</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

		<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">native_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">);</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Special case: even after an error we need to put the</span>
<span class="cm">	   results back for these ioctls since the error_idx will</span>
<span class="cm">	   contain information on which control failed. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_EXT_CTRLS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_EXT_CTRLS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_EXT_CTRLS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">put_v4l2_ext_controls32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2ecs</span><span class="p">,</span> <span class="n">up</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_INPUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_OUTPUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_INPUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_OUTPUT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(((</span><span class="n">s32</span><span class="p">)</span><span class="n">karg</span><span class="p">.</span><span class="n">vi</span><span class="p">),</span> <span class="p">(</span><span class="n">s32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_FBUF</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_v4l2_framebuffer32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2fb</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_DQEVENT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_v4l2_event32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2ev</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_FMT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_FMT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_FMT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_v4l2_format32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2f</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_CREATE_BUFS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_v4l2_create32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2crt</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_QUERYBUF</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QBUF</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DQBUF</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_v4l2_buffer32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2b</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_ENUMSTD</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_v4l2_standard32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2s</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_ENUMINPUT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_v4l2_input32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">v2i</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">v4l2_compat_ioctl32</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">unlocked_ioctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDIOC_QUERYCAP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_RESERVED</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_FMT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_FMT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_FMT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_REQBUFS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERYBUF32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_FBUF32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_FBUF32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_OVERLAY32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QBUF32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DQBUF32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_STREAMON32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_STREAMOFF32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_PARM</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_PARM</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_STD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_STD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUMSTD32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUMINPUT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_CTRL</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_CTRL</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_TUNER</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_TUNER</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_AUDIO</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_AUDIO</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERYCTRL</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERYMENU</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_INPUT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_INPUT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_OUTPUT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_OUTPUT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUMOUTPUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_AUDOUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_AUDOUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_MODULATOR</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_MODULATOR</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_FREQUENCY</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_FREQUENCY</span>:
	<span class="k">case</span> <span class="n">VIDIOC_CROPCAP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_CROP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_CROP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_SELECTION</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_SELECTION</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_JPEGCOMP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_JPEGCOMP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERYSTD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_FMT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUMAUDIO</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUMAUDOUT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_PRIORITY</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_PRIORITY</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_SLICED_VBI_CAP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_LOG_STATUS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_EXT_CTRLS32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_EXT_CTRLS32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_EXT_CTRLS32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_FRAMESIZES</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_FRAMEINTERVALS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_ENC_INDEX</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENCODER_CMD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_ENCODER_CMD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DECODER_CMD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_DECODER_CMD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DBG_S_REGISTER</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DBG_G_REGISTER</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DBG_G_CHIP_IDENT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_HW_FREQ_SEEK</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_DV_PRESETS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_DV_PRESET</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_DV_PRESET</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERY_DV_PRESET</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_DV_TIMINGS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_DV_TIMINGS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DQEVENT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DQEVENT32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_SUBSCRIBE_EVENT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_UNSUBSCRIBE_EVENT</span>:
	<span class="k">case</span> <span class="n">VIDIOC_CREATE_BUFS32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_PREPARE_BUF32</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_DV_TIMINGS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERY_DV_TIMINGS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_DV_TIMINGS_CAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_video_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">compat_ioctl32</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">compat_ioctl32</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;compat_ioctl32: &quot;</span>
				<span class="s">&quot;unknown ioctl &#39;%c&#39;, dir=%d, #%d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
				<span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">v4l2_compat_ioctl32</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
