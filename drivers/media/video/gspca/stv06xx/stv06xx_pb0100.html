<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › gspca › stv06xx › stv06xx_pb0100.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>stv06xx_pb0100.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2001 Jean-Fredric Clere, Nikolas Zimmermann, Georg Acher</span>
<span class="cm"> *		      Mark Cave-Ayland, Carlo E Prelz, Dick Streefland</span>
<span class="cm"> * Copyright (c) 2002, 2003 Tuukka Toivonen</span>
<span class="cm"> * Copyright (c) 2008 Erik Andrén</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * P/N 861037:      Sensor HDCS1000        ASIC STV0600</span>
<span class="cm"> * P/N 861050-0010: Sensor HDCS1000        ASIC STV0600</span>
<span class="cm"> * P/N 861050-0020: Sensor Photobit PB100  ASIC STV0600-1 - QuickCam Express</span>
<span class="cm"> * P/N 861055:      Sensor ST VV6410       ASIC STV0610   - LEGO cam</span>
<span class="cm"> * P/N 861075-0040: Sensor HDCS1000        ASIC</span>
<span class="cm"> * P/N 961179-0700: Sensor ST VV6410       ASIC STV0602   - Dexxa WebCam USB</span>
<span class="cm"> * P/N 861040-0000: Sensor ST VV6410       ASIC STV0610   - QuickCam Web</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The spec file for the PB-0100 suggests the following for best quality</span>
<span class="cm"> * images after the sensor has been reset :</span>
<span class="cm"> *</span>
<span class="cm"> * PB_ADCGAINL      = R60 = 0x03 (3 dec)      : sets low reference of ADC</span>
<span class="cm">						to produce good black level</span>
<span class="cm"> * PB_PREADCTRL     = R32 = 0x1400 (5120 dec) : Enables global gain changes</span>
<span class="cm">						through R53</span>
<span class="cm"> * PB_ADCMINGAIN    = R52 = 0x10 (16 dec)     : Sets the minimum gain for</span>
<span class="cm">						auto-exposure</span>
<span class="cm"> * PB_ADCGLOBALGAIN = R53 = 0x10 (16 dec)     : Sets the global gain</span>
<span class="cm"> * PB_EXPGAIN       = R14 = 0x11 (17 dec)     : Sets the auto-exposure value</span>
<span class="cm"> * PB_UPDATEINT     = R23 = 0x02 (2 dec)      : Sets the speed on</span>
<span class="cm">						auto-exposure routine</span>
<span class="cm"> * PB_CFILLIN       = R5  = 0x0E (14 dec)     : Sets the frame rate</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;stv06xx_pb0100.h&quot;</span>

<span class="k">struct</span> <span class="n">pb0100_ctrls</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span> <span class="cm">/* one big happy control cluster... */</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">autogain</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">gain</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">exposure</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">red</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">blue</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">natural</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">pb0100_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* low res / subsample modes disabled as they are only half res horizontal,</span>
<span class="cm">   halving the vertical resolution does not seem to work */</span>
	<span class="p">{</span>
		<span class="mi">320</span><span class="p">,</span>
		<span class="mi">240</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_SGRBG8</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">320</span> <span class="o">*</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">PB0100_CROP_TO_VGA</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mi">352</span><span class="p">,</span>
		<span class="mi">288</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_SGRBG8</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">352</span> <span class="o">*</span> <span class="mi">288</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">352</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pb0100_ctrls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTOGAIN</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">pb0100_set_autogain</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pb0100_set_gain</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pb0100_set_exposure</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_CLASS_USER</span> <span class="o">+</span> <span class="mh">0x1001</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">pb0100_set_autogain_target</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">pb0100_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">pb0100_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_init_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">ctrl_handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pb0100_ctrls</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_config</span> <span class="n">autogain_target</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pb0100_ctrl_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CTRL_CLASS_USER</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Automatic Gain Target&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_config</span> <span class="n">natural_light</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pb0100_ctrl_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CTRL_CLASS_USER</span> <span class="o">+</span> <span class="mh">0x1001</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Natural Light Source&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">ctrls</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctrls</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrls</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">autogain</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pb0100_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_AUTOGAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">exposure</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pb0100_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_EXPOSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">511</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pb0100_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">red</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pb0100_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_RED_BALANCE</span><span class="p">,</span> <span class="o">-</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pb0100_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_BLUE_BALANCE</span><span class="p">,</span> <span class="o">-</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">natural</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_custom</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">natural_light</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_custom</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autogain_target</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ctrls</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor_priv</span> <span class="o">=</span> <span class="n">ctrls</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_auto_cluster</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">autogain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sensor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_read_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_IDENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sensor</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Photobit pb0100 sensor detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span> <span class="o">=</span> <span class="n">pb0100_mode</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">cam</span><span class="p">.</span><span class="n">nmodes</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pb0100_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">,</span> <span class="n">max_packet_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">cam</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">curr_mode</span><span class="p">].</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">intf</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">alt</span> <span class="o">=</span> <span class="n">usb_altnum_to_altsetting</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">alt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>

	<span class="cm">/* If we don&#39;t have enough bandwidth use a lower framerate */</span>
	<span class="n">max_packet_size</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">[</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">curr_mode</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet_size</span> <span class="o">&lt;</span> <span class="n">max_packet_size</span><span class="p">)</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ROWSPEED</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ROWSPEED</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Setup sensor window */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">PB0100_CROP_TO_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RSTART</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CSTART</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RWSIZE</span><span class="p">,</span> <span class="mi">240</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CWSIZE</span><span class="p">,</span> <span class="mi">320</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RSTART</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CSTART</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RWSIZE</span><span class="p">,</span> <span class="mi">288</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CWSIZE</span><span class="p">,</span> <span class="mi">352</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">PB0100_SUBSAMPLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_Y_CTRL</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span> <span class="cm">/* Wrong, FIXME */</span>
		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_X_CTRL</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>

		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_SCAN_RATE</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_Y_CTRL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_X_CTRL</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
		<span class="cm">/* larger -&gt; slower */</span>
		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_SCAN_RATE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CONTROL</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;Started stream, status: %d&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ABORTFRAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Set bit 1 to zero */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CONTROL</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;Halting stream&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: Sort the init commands out and put them into tables,</span>
<span class="cm">	  this is only for getting the camera to work */</span>
<span class="cm">/* FIXME: No error handling for now,</span>
<span class="cm">	  add this once the init has been converted to proper tables */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_REG00</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_SCAN_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Reset sensor */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable chip */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CONTROL</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

	<span class="cm">/* Gain stuff...*/</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_PREADCTRL</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ADCGLOBALGAIN</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* Set up auto-exposure */</span>
	<span class="cm">/* ADC VREF_HI new setting for a transition</span>
<span class="cm">	  from the Expose1 to the Expose2 setting */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_R28</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* gain max for autoexposure */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ADCMAXGAIN</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>
	<span class="cm">/* gain min for autoexposure  */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ADCMINGAIN</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* Maximum frame integration time (programmed into R8)</span>
<span class="cm">	   allowed for auto-exposure routine */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_R54</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="cm">/* Minimum frame integration time (programmed into R8)</span>
<span class="cm">	   allowed for auto-exposure routine */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_R55</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_UPDATEINT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* R15  Expose0 (maximum that auto-exposure may use) */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_R15</span><span class="p">,</span> <span class="mi">800</span><span class="p">);</span>
	<span class="cm">/* R17  Expose2 (minimum that auto-exposure may use) */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_R17</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_EXPGAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* 0x14 */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_VOFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* 0x0D */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ADCGAINH</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="cm">/* Set black level (important!) */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ADCGAINL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* ??? */</span>
	<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_REG00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_REG03</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
	<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_REG04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>

	<span class="cm">/* Scan/timing for the sensor */</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_ROWSPEED</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_CFILLIN</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_VBL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_FINTTIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RINTTIME</span><span class="p">,</span> <span class="mi">123</span><span class="p">);</span>

	<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_REG01</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">);</span>
	<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_REG02</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_set_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">__s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pb0100_ctrls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor_priv</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_G1GAIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_G2GAIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_V4L2</span><span class="p">,</span> <span class="s">&quot;Set green gain to %d, status: %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pb0100_set_red_balance</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">red</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pb0100_set_blue_balance</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">blue</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_set_red_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">__s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pb0100_ctrls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor_priv</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">+=</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RGAIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_V4L2</span><span class="p">,</span> <span class="s">&quot;Set red gain to %d, status: %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_set_blue_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">__s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pb0100_ctrls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor_priv</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">+=</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_BGAIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_V4L2</span><span class="p">,</span> <span class="s">&quot;Set blue gain to %d, status: %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_set_exposure</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">__s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_RINTTIME</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_V4L2</span><span class="p">,</span> <span class="s">&quot;Set exposure to %d, status: %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_set_autogain</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">__s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pb0100_ctrls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">natural</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_EXPGAIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_V4L2</span><span class="p">,</span> <span class="s">&quot;Set autogain to %d (natural: %d), status: %d&quot;</span><span class="p">,</span>
	       <span class="n">val</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">natural</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pb0100_set_autogain_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">__s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">totalpixels</span><span class="p">,</span> <span class="n">brightpixels</span><span class="p">,</span> <span class="n">darkpixels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="cm">/* Number of pixels counted by the sensor when subsampling the pixels.</span>
<span class="cm">	 * Slightly larger than the real value to avoid oscillation */</span>
	<span class="n">totalpixels</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">totalpixels</span> <span class="o">=</span> <span class="n">totalpixels</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">totalpixels</span><span class="o">/</span><span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">64</span><span class="p">);</span>

	<span class="n">brightpixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">totalpixels</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">darkpixels</span>   <span class="o">=</span> <span class="n">totalpixels</span> <span class="o">-</span> <span class="n">brightpixels</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_R21</span><span class="p">,</span> <span class="n">brightpixels</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_sensor</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PB_R22</span><span class="p">,</span> <span class="n">darkpixels</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_V4L2</span><span class="p">,</span> <span class="s">&quot;Set autogain target to %d, status: %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
