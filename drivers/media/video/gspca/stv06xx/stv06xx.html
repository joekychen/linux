<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › gspca › stv06xx › stv06xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>stv06xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2001 Jean-Fredric Clere, Nikolas Zimmermann, Georg Acher</span>
<span class="cm"> *		      Mark Cave-Ayland, Carlo E Prelz, Dick Streefland</span>
<span class="cm"> * Copyright (c) 2002, 2003 Tuukka Toivonen</span>
<span class="cm"> * Copyright (c) 2008 Erik Andrén</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * P/N 861037:      Sensor HDCS1000        ASIC STV0600</span>
<span class="cm"> * P/N 861050-0010: Sensor HDCS1000        ASIC STV0600</span>
<span class="cm"> * P/N 861050-0020: Sensor Photobit PB100  ASIC STV0600-1 - QuickCam Express</span>
<span class="cm"> * P/N 861055:      Sensor ST VV6410       ASIC STV0610   - LEGO cam</span>
<span class="cm"> * P/N 861075-0040: Sensor HDCS1000        ASIC</span>
<span class="cm"> * P/N 961179-0700: Sensor ST VV6410       ASIC STV0602   - Dexxa WebCam USB</span>
<span class="cm"> * P/N 861040-0000: Sensor ST VV6410       ASIC STV0610   - QuickCam Web</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &quot;stv06xx_sensor.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Erik Andrén&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;STV06XX USB Camera Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">dump_bridge</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">dump_sensor</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">stv06xx_write_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">i2c_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">usb_buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">i2c_data</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i2c_data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			      <span class="n">STV06XX_URB_MSG_TIMEOUT</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;Written 0x%x to address 0x%x, status: %d&quot;</span><span class="p">,</span>
	       <span class="n">i2c_data</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv06xx_read_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">i2c_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">usb_buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">STV06XX_URB_MSG_TIMEOUT</span><span class="p">);</span>

	<span class="o">*</span><span class="n">i2c_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;Reading 0x%x from address 0x%x, status %d&quot;</span><span class="p">,</span>
	       <span class="o">*</span><span class="n">i2c_data</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wraps the normal write sensor bytes / words functions for writing a</span>
<span class="cm">   single value */</span>
<span class="kt">int</span> <span class="nf">stv06xx_write_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">i2c_len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span> <span class="p">};</span>
		<span class="k">return</span> <span class="n">stv06xx_write_sensor_words</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span> <span class="p">};</span>
		<span class="k">return</span> <span class="n">stv06xx_write_sensor_bytes</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv06xx_write_sensor_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">==</span> <span class="n">BRIDGE_STV610</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">usb_buf</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x1704</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				      <span class="n">STV06XX_URB_MSG_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv06xx_write_sensor_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">usb_buf</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;I2C: Command buffer contains %d entries&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;)</span> <span class="p">{</span>
		<span class="cm">/* Build the command buffer */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_BUFFER_LENGTH</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">I2C_MAX_BYTES</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">];</span>
			<span class="n">buf</span><span class="p">[</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;I2C: Writing 0x%02x to reg 0x%02x&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mh">0x21</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Number of commands to send - 1 */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mh">0x22</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2C_WRITE_CMD</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				      <span class="n">I2C_BUFFER_LENGTH</span><span class="p">,</span>
				      <span class="n">STV06XX_URB_MSG_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">stv06xx_write_sensor_finish</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv06xx_write_sensor_words</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">usb_buf</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;I2C: Command buffer contains %d entries&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;)</span> <span class="p">{</span>
		<span class="cm">/* Build the command buffer */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_BUFFER_LENGTH</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">I2C_MAX_WORDS</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">];</span>
			<span class="n">buf</span><span class="p">[</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">buf</span><span class="p">[</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;I2C: Writing 0x%04x to reg 0x%02x&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mh">0x21</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Number of commands to send - 1 */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mh">0x22</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2C_WRITE_CMD</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				<span class="n">I2C_BUFFER_LENGTH</span><span class="p">,</span>
				<span class="n">STV06XX_URB_MSG_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">stv06xx_write_sensor_finish</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv06xx_read_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">usb_buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_I2C_FLUSH</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">i2c_flush</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Clear mem */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_BUFFER_LENGTH</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read I2C register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x22</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2C_READ_CMD</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x1400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">I2C_BUFFER_LENGTH</span><span class="p">,</span>
			      <span class="n">STV06XX_URB_MSG_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I2C: Read error writing address: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x1410</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">i2c_len</span><span class="p">,</span>
			      <span class="n">STV06XX_URB_MSG_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">i2c_len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;I2C: Read 0x%x from address 0x%x, status: %d&quot;</span><span class="p">,</span>
	       <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Dumps all bridge registers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv06xx_dump_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Dumping all stv06xx bridge registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x1400</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x160f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv06xx_read_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Read 0x%x from address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Testing stv06xx bridge registers for writability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x1400</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x160f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv06xx_read_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">stv06xx_read_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Register 0x%x is read/write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Register 0x%x is read/write, but only partially</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Register 0x%x is read-only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this function is called at probe and resume time */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv06xx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;Initializing camera&quot;</span><span class="p">);</span>

	<span class="cm">/* Let the usb init settle for a bit</span>
<span class="cm">	   before performing the initialization */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dump_sensor</span> <span class="o">&amp;&amp;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">)</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function is called at probe time */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv06xx_init_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;Initializing controls&quot;</span><span class="p">);</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">init_controls</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Start the camera */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv06xx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">;</span>

	<span class="n">intf</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">alt</span> <span class="o">=</span> <span class="n">usb_altnum_to_altsetting</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">gspca_dev</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t get altsetting&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">alt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_ISO_SIZE_L</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Prepare the sensor for start */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Start isochronous streaming */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_ISO_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;Starting stream failed&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;Started streaming&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv06xx_isoc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="cm">/* Start isoc bandwidth &quot;negotiation&quot; at max isoc bandwidth */</span>
	<span class="n">alt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">intf_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">alt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">[</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv06xx_isoc_nego</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">,</span> <span class="n">min_packet_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="n">alt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">intf_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">alt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
	<span class="n">min_packet_size</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">min_packet_size</span><span class="p">[</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet_size</span> <span class="o">&lt;=</span> <span class="n">min_packet_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">packet_size</span> <span class="o">-=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet_size</span> <span class="o">&lt;</span> <span class="n">min_packet_size</span><span class="p">)</span>
		<span class="n">packet_size</span> <span class="o">=</span> <span class="n">min_packet_size</span><span class="p">;</span>
	<span class="n">alt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">packet_size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="o">|</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;set alt 1 err %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv06xx_stopN</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="cm">/* stop ISO-streaming */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">stv06xx_write_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">STV_ISO_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;Failed to stop stream&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;Stopped streaming&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Analyse an USB packet of the data stream and store it appropriately.</span>
<span class="cm"> * Each packet contains an integral number of chunks. Each chunk has</span>
<span class="cm"> * 2-bytes identification, followed by 2-bytes that describe the chunk</span>
<span class="cm"> * length. Known/guessed chunk identifications are:</span>
<span class="cm"> * 8001/8005/C001/C005 - Begin new frame</span>
<span class="cm"> * 8002/8006/C002/C006 - End frame</span>
<span class="cm"> * 0200/4200           - Contains actual image data, bayer or compressed</span>
<span class="cm"> * 0005                - 11 bytes of unknown data</span>
<span class="cm"> * 0100                - 2 bytes of unknown data</span>
<span class="cm"> * The 0005 and 0100 chunks seem to appear only in compressed stream.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv06xx_pkt_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>			<span class="cm">/* isoc packet */</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>			<span class="cm">/* iso packet length */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Packet of length %d arrived&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* A packet may contain several frames</span>
<span class="cm">	   loop until the whole packet is reached */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Packet is smaller than 4 bytes&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Capture the id */</span>
		<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="cm">/* Capture the chunk length */</span>
		<span class="n">chunk_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Chunk id: %x, length: %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">chunk_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="p">,</span> <span class="s">&quot;URB packet length is smaller&quot;</span>
				<span class="s">&quot; than the specified chunk length&quot;</span><span class="p">);</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">DISCARD_PACKET</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* First byte seem to be 02=data 2nd byte is unknown??? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">==</span> <span class="n">BRIDGE_ST6422</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0200</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">frame_data</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0200</span>:
		<span class="k">case</span> <span class="mh">0x4200</span>:
<span class="nl">frame_data:</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Frame data packet detected&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">to_skip</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">to_skip</span> <span class="o">&lt;</span> <span class="n">chunk_len</span><span class="p">)</span> <span class="o">?</span>
					    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">to_skip</span> <span class="o">:</span> <span class="n">chunk_len</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="n">skip</span><span class="p">;</span>
				<span class="n">chunk_len</span> <span class="o">-=</span> <span class="n">skip</span><span class="p">;</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">to_skip</span> <span class="o">-=</span> <span class="n">skip</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">INTER_PACKET</span><span class="p">,</span>
					<span class="n">data</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x8001</span>:
		<span class="k">case</span> <span class="mh">0x8005</span>:
		<span class="k">case</span> <span class="mh">0xc001</span>:
		<span class="k">case</span> <span class="mh">0xc005</span>:
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Starting new frame&quot;</span><span class="p">);</span>

			<span class="cm">/* Create a new frame, chunk length should be zero */</span>
			<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">FIRST_PACKET</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">==</span> <span class="n">BRIDGE_ST6422</span><span class="p">)</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">to_skip</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chunk_len</span><span class="p">)</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="p">,</span> <span class="s">&quot;Chunk length is &quot;</span>
					      <span class="s">&quot;non-zero on a SOF&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x8002</span>:
		<span class="k">case</span> <span class="mh">0x8006</span>:
		<span class="k">case</span> <span class="mh">0xc002</span>:
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;End of frame detected&quot;</span><span class="p">);</span>

			<span class="cm">/* Complete the last frame (if any) */</span>
			<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">LAST_PACKET</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chunk_len</span><span class="p">)</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="p">,</span> <span class="s">&quot;Chunk length is &quot;</span>
					      <span class="s">&quot;non-zero on a EOF&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0005</span>:
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Chunk 0x005 detected&quot;</span><span class="p">);</span>
			<span class="cm">/* Unknown chunk with 11 bytes of data,</span>
<span class="cm">			   occurs just before end of each frame</span>
<span class="cm">			   in compressed mode */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0100</span>:
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Chunk 0x0100 detected&quot;</span><span class="p">);</span>
			<span class="cm">/* Unknown chunk with 2 bytes of data,</span>
<span class="cm">			   occurs 2-3 times per USB interrupt */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x42ff</span>:
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Chunk 0x42ff detected&quot;</span><span class="p">);</span>
			<span class="cm">/* Special chunk seen sometimes on the ST6422 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;Unknown chunk 0x%04x detected&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="cm">/* Unknown chunk */</span>
		<span class="p">}</span>
		<span class="n">data</span>    <span class="o">+=</span> <span class="n">chunk_len</span><span class="p">;</span>
		<span class="n">len</span>     <span class="o">-=</span> <span class="n">chunk_len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_int_pkt_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>		<span class="cm">/* interrupt packet data */</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>		<span class="cm">/* interrupt packet length */</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">KEY_CAMERA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x88</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">KEY_CAMERA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">stv06xx_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>

<span class="cm">/* sub-driver description */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sd_desc</span> <span class="n">sd_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">stv06xx_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">stv06xx_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_controls</span> <span class="o">=</span> <span class="n">stv06xx_init_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">stv06xx_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stopN</span> <span class="o">=</span> <span class="n">stv06xx_stopN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pkt_scan</span> <span class="o">=</span> <span class="n">stv06xx_pkt_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">isoc_init</span> <span class="o">=</span> <span class="n">stv06xx_isoc_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">isoc_nego</span> <span class="o">=</span> <span class="n">stv06xx_isoc_nego</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
	<span class="p">.</span><span class="n">int_pkt_scan</span> <span class="o">=</span> <span class="n">sd_int_pkt_scan</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* This function is called at probe time */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv06xx_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;Configuring camera&quot;</span><span class="p">);</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dump_bridge</span><span class="p">)</span>
		<span class="n">stv06xx_dump_bridge</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stv06xx_sensor_st6422</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stv06xx_sensor_vv6410</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stv06xx_sensor_hdcs1x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stv06xx_sensor_hdcs1020</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stv06xx_sensor_pb0100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* -- module initialisation -- */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">device_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* QuickCam Express */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0x0840</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">BRIDGE_STV600</span> <span class="p">},</span>
	<span class="cm">/* LEGO cam / QuickCam Web */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0x0850</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">BRIDGE_STV610</span> <span class="p">},</span>
	<span class="cm">/* Dexxa WebCam USB */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0x0870</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">BRIDGE_STV602</span> <span class="p">},</span>
	<span class="cm">/* QuickCam Messenger */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08F0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">BRIDGE_ST6422</span> <span class="p">},</span>
	<span class="cm">/* QuickCam Communicate */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08F5</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">BRIDGE_ST6422</span> <span class="p">},</span>
	<span class="cm">/* QuickCam Messenger (new) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08F6</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">BRIDGE_ST6422</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">device_table</span><span class="p">);</span>

<span class="cm">/* -- device connect -- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;Probing for a stv06xx device&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gspca_dev_probe</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span><span class="p">),</span>
			       <span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor_priv</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;Disconnecting the stv06xx device&quot;</span><span class="p">);</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gspca_disconnect</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">sd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">device_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">sd_disconnect</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">gspca_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">gspca_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span> <span class="n">gspca_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">sd_driver</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dump_bridge</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dump_bridge</span><span class="p">,</span> <span class="s">&quot;Dumps all usb bridge registers at startup&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dump_sensor</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dump_sensor</span><span class="p">,</span> <span class="s">&quot;Dumps all sensor registers at startup&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
