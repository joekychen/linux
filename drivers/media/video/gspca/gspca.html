<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › gspca › gspca.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>gspca.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Main USB camera driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008-2011 Jean-François Moine &lt;http://moinejf.free.fr&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Camera button input handling by Márton Németh</span>
<span class="cm"> * Copyright (C) 2009-2010 Márton Németh &lt;nm127@freemail.hu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software Foundation,</span>
<span class="cm"> * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define GSPCA_VERSION	&quot;2.14.0&quot;</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/ktime.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-fh.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>

<span class="cp">#include &quot;gspca.h&quot;</span>

<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/* global values */</span>
<span class="cp">#define DEF_NURBS 3		</span><span class="cm">/* default number of URBs */</span><span class="cp"></span>
<span class="cp">#if DEF_NURBS &gt; MAX_NURBS</span>
<span class="cp">#error &quot;DEF_NURBS too big&quot;</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jean-François Moine &lt;http://moinejf.free.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;GSPCA USB Camera Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">GSPCA_VERSION</span><span class="p">);</span>

<span class="cp">#ifdef GSPCA_DEBUG</span>
<span class="kt">int</span> <span class="n">gspca_debug</span> <span class="o">=</span> <span class="n">D_ERR</span> <span class="o">|</span> <span class="n">D_PROBE</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gspca_debug</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">PDEBUG_MODE</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">txt</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">pixfmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pixfmt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="o">|</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;%s %c%c%c%c %dx%d&quot;</span><span class="p">,</span>
			<span class="n">txt</span><span class="p">,</span>
			<span class="n">pixfmt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">pixfmt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">pixfmt</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="n">pixfmt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
			<span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="o">|</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;%s 0x%08x %dx%d&quot;</span><span class="p">,</span>
			<span class="n">txt</span><span class="p">,</span>
			<span class="n">pixfmt</span><span class="p">,</span>
			<span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define PDEBUG_MODE(txt, pixfmt, w, h)</span>
<span class="cp">#endif</span>

<span class="cm">/* specific memory types - !! should be different from V4L2_MEMORY_xxx */</span>
<span class="cp">#define GSPCA_MEMORY_NO 0	</span><span class="cm">/* V4L2_MEMORY_xxx starts from 1 */</span><span class="cp"></span>
<span class="cp">#define GSPCA_MEMORY_READ 7</span>

<span class="cp">#define BUF_ALL_FLAGS (V4L2_BUF_FLAG_QUEUED | V4L2_BUF_FLAG_DONE)</span>

<span class="cm">/*</span>
<span class="cm"> * VMA operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gspca_vm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">vma_use_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gspca_vm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">vma_use_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">gspca_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">gspca_vm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">gspca_vm_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Input and interrupt endpoint handling functions</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">int_pkt_scan</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span>
		    <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="p">,</span> <span class="s">&quot;Unknown packet received&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* Stop is requested either by software or hardware is gone,</span>
<span class="cm">		 * keep the ret value non-zero and don&#39;t resubmit later.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="p">,</span> <span class="s">&quot;URB error %i, resubmitting&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Resubmit URB failed with error %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gspca_input_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">int_pkt_scan</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">other_input</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">usb_make_path</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>

		<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">KEY_CAMERA</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">KEY_CAMERA</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Input device registration failed with error %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err</span><span class="p">);</span>
			<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_and_submit_int_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buffer_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buffer_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
	<span class="n">interval</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;found int in endpoint: 0x%x, &quot;</span>
		<span class="s">&quot;buffer_len=%u, interval=%u&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_buffer</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
		<span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span>
		<span class="n">int_irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="p">,</span> <span class="s">&quot;submit int URB failed with error %i&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_submit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">int_urb</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_submit:</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
			  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
<span class="nl">error_buffer:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gspca_input_create_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">intf_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">int_pkt_scan</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">intf</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">);</span>
		<span class="n">intf_desc</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">intf_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf_desc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">usb_endpoint_xfer_int</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">alloc_and_submit_int_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gspca_input_destroy_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">int_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
				  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
				  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gspca_input_destroy_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gspca_input_create_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gspca_input_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * fill a video frame from an URB and resubmit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>		<span class="cm">/* address of data in the iso message */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">cam_pkt_op</span> <span class="n">pkt_scan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>		<span class="cm">/* disconnection */</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frozen</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="o">|</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;urb status: %d&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pkt_scan</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">pkt_scan</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>

		<span class="cm">/* check the packet status and length */</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ISOC data error: [%d] len=%d, status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">DISCARD_PACKET</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">empty_packet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">empty_packet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* let the packet be analyzed by the subdriver */</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;packet [%d] o:%d l:%d&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span>
					<span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">pkt_scan</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">resubmit:</span>
	<span class="cm">/* resubmit the URB */</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_submit_urb() ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ISOC message interrupt from the USB device</span>
<span class="cm"> *</span>
<span class="cm"> * Analyse each packet and call the subdriver for copy to the frame buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isoc_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;isoc irq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">fill_frame</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bulk message interrupt from the USB device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bulk_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">st</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;bulk irq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* disconnection */</span>
	<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frozen</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="o">|</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;urb status: %d&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;packet l:%d&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">pkt_scan</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

<span class="nl">resubmit:</span>
	<span class="cm">/* resubmit the URB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk_nurbs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_submit_urb() ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * add data to the current frame</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called by the subdrivers at interrupt level.</span>
<span class="cm"> *</span>
<span class="cm"> * To build a frame, these ones must add</span>
<span class="cm"> *	- one FIRST_PACKET</span>
<span class="cm"> *	- 0 or many INTER_PACKETs</span>
<span class="cm"> *	- one LAST_PACKET</span>
<span class="cm"> * DISCARD_PACKET invalidates the whole frame.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gspca_frame_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">gspca_packet_type</span> <span class="n">packet_type</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;add t:%d l:%d&quot;</span><span class="p">,</span>	<span class="n">packet_type</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet_type</span> <span class="o">==</span> <span class="n">FIRST_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_i</span><span class="p">);</span>

		<span class="cm">/* if there are no queued buffer, discard the whole frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">DISCARD_PACKET</span><span class="p">;</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">ktime_to_timeval</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">());</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DISCARD_PACKET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">packet_type</span> <span class="o">==</span> <span class="n">LAST_PACKET</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">packet_type</span><span class="p">;</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LAST_PACKET</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* append the packet to the frame buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frsz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="o">|</span><span class="n">D_PACK</span><span class="p">,</span> <span class="s">&quot;frame overflow %d &gt; %d&quot;</span><span class="p">,</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frsz</span><span class="p">);</span>
			<span class="n">packet_type</span> <span class="o">=</span> <span class="n">DISCARD_PACKET</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cm">/* !! image is NULL only when last pkt is LAST or DISCARD</span>
<span class="cm">			if (gspca_dev-&gt;image == NULL) {</span>
<span class="cm">				pr_err(&quot;gspca_frame_add() image == NULL\n&quot;);</span>
<span class="cm">				return;</span>
<span class="cm">			}</span>
<span class="cm"> */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image</span> <span class="o">+</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span><span class="p">,</span>
				<span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">packet_type</span><span class="p">;</span>

	<span class="cm">/* if last packet, invalidate packet concatenation until</span>
<span class="cm">	 * next first packet, wake up the application and advance</span>
<span class="cm">	 * in the queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet_type</span> <span class="o">==</span> <span class="n">LAST_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_i</span><span class="p">);</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span>
					 <span class="o">|</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">GSPCA_MAX_FRAMES</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_i</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>	<span class="cm">/* event = new frame */</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;frame complete len:%d&quot;</span><span class="p">,</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">bytesused</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gspca_frame_add</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">frame_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">v4l2_memory</span> <span class="n">memory</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frsz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">;</span>
	<span class="n">frsz</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeimage</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;frame alloc frsz: %d&quot;</span><span class="p">,</span> <span class="n">frsz</span><span class="p">);</span>
	<span class="n">frsz</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">frsz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">GSPCA_MAX_FRAMES</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">GSPCA_MAX_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frbuf</span> <span class="o">=</span> <span class="n">vmalloc_32</span><span class="p">(</span><span class="n">frsz</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;frame alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frsz</span> <span class="o">=</span> <span class="n">frsz</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">frsz</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frbuf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">frsz</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">frsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">frame_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;frame free&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frbuf</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frsz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">GSPCA_MEMORY_NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;kill transfer&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NURBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
					  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
					  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gspca_set_alt0</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;set alt 0 err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note: both the queue and the usb locks should be held when calling this */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gspca_stream_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stopN</span><span class="p">)</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stopN</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">destroy_urbs</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">gspca_input_destroy_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">gspca_set_alt0</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">gspca_input_create_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stop0</span><span class="p">)</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stop0</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;stream off OK&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * look for an input transfer endpoint in an alternate setting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="nf">alt_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">xfer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alt</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="n">xfer</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">!=</span> <span class="mi">0</span>
		    <span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* compute the minimum bandwidth for the current transfer */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">which_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* get the (max) image size */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">;</span>
	<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeimage</span><span class="p">;</span>

	<span class="cm">/* if the image is compressed, estimate its mean size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">needs_full_bandwidth</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bandwidth</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">*</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">)</span>
		<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bandwidth</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* 0.375 */</span>

	<span class="cm">/* estimate the frame rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_streamparm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="n">parm</span><span class="p">;</span>

		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_streamparm</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">bandwidth</span> <span class="o">*=</span> <span class="n">parm</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">;</span>
		<span class="n">bandwidth</span> <span class="o">/=</span> <span class="n">parm</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* don&#39;t hope more than 15 fps with USB 1.1 and</span>
<span class="cm">		 * image resolution &gt;= 640x480 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">640</span>
		 <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
			<span class="n">bandwidth</span> <span class="o">*=</span> <span class="mi">15</span><span class="p">;</span>		<span class="cm">/* 15 fps */</span>
		<span class="k">else</span>
			<span class="n">bandwidth</span> <span class="o">*=</span> <span class="mi">30</span><span class="p">;</span>		<span class="cm">/* 30 fps */</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;min bandwidth: %d&quot;</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bandwidth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* endpoint table */</span>
<span class="cp">#define MAX_ALT 16</span>
<span class="k">struct</span> <span class="n">ep_tb_s</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">alt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * build the table of the endpoints</span>
<span class="cm"> * and compute the minimum bandwidth for the image transfer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_isoc_ep_tb</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ep_tb_s</span> <span class="o">*</span><span class="n">ep_tb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nbalt</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">last_bw</span><span class="p">;</span>

	<span class="n">nbalt</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">num_altsetting</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbalt</span> <span class="o">&gt;</span> <span class="n">MAX_ALT</span><span class="p">)</span>
		<span class="n">nbalt</span> <span class="o">=</span> <span class="n">MAX_ALT</span><span class="p">;</span>	<span class="cm">/* fixme: should warn */</span>

	<span class="cm">/* build the endpoint table */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">last_bw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">2000</span> <span class="o">*</span> <span class="mi">2000</span> <span class="o">*</span> <span class="mi">120</span><span class="p">;</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nbalt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">alt_xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
				      <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;alt %d iso endp with 0 interval</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">psize</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">psize</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">psize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span>
			 <span class="o">||</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
				<span class="n">bandwidth</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">bandwidth</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">&lt;=</span> <span class="n">last_bw</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">&lt;</span> <span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bandwidth</span><span class="p">;</span>
				<span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;alt %d bandwidth %d&quot;</span><span class="p">,</span>
				<span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">,</span> <span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">);</span>
		<span class="n">last_bw</span> <span class="o">=</span> <span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ep_tb</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the camera:</span>
<span class="cm">	 * has a usb audio class interface (a built in usb mic); and</span>
<span class="cm">	 * is a usb 1 full speed device; and</span>
<span class="cm">	 * uses the max full speed iso bandwidth; and</span>
<span class="cm">	 * and has more than 1 alt setting</span>
<span class="cm">	 * then skip the highest alt setting to spare bandwidth for the mic</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">audio</span> <span class="o">&amp;&amp;</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span> <span class="o">&amp;&amp;</span>
			<span class="n">last_bw</span> <span class="o">&gt;=</span> <span class="mi">1000000</span> <span class="o">&amp;&amp;</span>
			<span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;dev has usb audio, skipping highest alt&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ep_tb</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the requested bandwidth and start at the highest atlsetting */</span>
	<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">which_bandwidth</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">ep_tb</span><span class="o">--</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep_tb</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_tb</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">&lt;</span> <span class="n">bandwidth</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create the URBs for image transfer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">nurbs</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">npkt</span><span class="p">,</span> <span class="n">bsize</span><span class="p">;</span>

	<span class="cm">/* calculate the packet size and the number of packets */</span>
	<span class="n">psize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* isoc */</span>

		<span class="cm">/* See paragraph 5.9 / table 5-11 of the usb 2.0 spec. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">psize</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">psize</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
		<span class="n">npkt</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">npkt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npkt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">npkt</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>		<span class="cm">/* default value */</span>
		<span class="n">bsize</span> <span class="o">=</span> <span class="n">psize</span> <span class="o">*</span> <span class="n">npkt</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span>
			<span class="s">&quot;isoc %d pkts size %d = bsize:%d&quot;</span><span class="p">,</span>
			<span class="n">npkt</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
		<span class="n">nurbs</span> <span class="o">=</span> <span class="n">DEF_NURBS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* bulk */</span>
		<span class="n">npkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bsize</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bsize</span> <span class="o">=</span> <span class="n">psize</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;bulk bsize:%d&quot;</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk_nurbs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nurbs</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk_nurbs</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nurbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">nurbs</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">npkt</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_alloc_urb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">bsize</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_alloc_coherent failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">bsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npkt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* ISOC */</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span>
					<span class="o">|</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">isoc_irq</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">npkt</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npkt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">psize</span><span class="p">;</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">psize</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* bulk */</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">bulk_irq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * start the USB transfer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gspca_init_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep_tb_s</span> <span class="n">ep_tb</span><span class="p">[</span><span class="n">MAX_ALT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">xfer</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">alt_idx</span><span class="p">;</span>

	<span class="cm">/* reset the streaming variables */</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">DISCARD_PACKET</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* do the specific subdriver stuff before endpoint selection */</span>
	<span class="n">intf</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk</span> <span class="o">?</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">num_altsetting</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">isoc_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">isoc_init</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xfer</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk</span> <span class="o">?</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>
				   <span class="o">:</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">;</span>

	<span class="cm">/* if bulk or the subdriver forced an altsetting, get the endpoint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* (previous version compatibility) */</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">alt_xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">],</span> <span class="n">xfer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;bad altsetting %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ep_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">alt</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">;</span>
		<span class="n">alt_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

	<span class="cm">/* else, compute the minimum bandwidth</span>
<span class="cm">	 * and build the endpoint table */</span>
		<span class="n">alt_idx</span> <span class="o">=</span> <span class="n">build_isoc_ep_tb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">ep_tb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alt_idx</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no transfer endpoint found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set the highest alternate setting and</span>
<span class="cm">	 * loop until urb submit succeeds */</span>
	<span class="n">gspca_input_destroy_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">ep_tb</span><span class="p">[</span><span class="o">--</span><span class="n">alt_idx</span><span class="p">].</span><span class="n">alt</span><span class="p">;</span>
	<span class="n">alt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">!=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alt</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">num_altsetting</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span>
							<span class="n">alt</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span> <span class="cm">/*fixme: ugly*/</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;set alt %d err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">no_urb_create</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;init transfer alt %d&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">create_urbs</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span>
				<span class="n">alt_xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="n">alt</span><span class="p">],</span> <span class="n">xfer</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">destroy_urbs</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* clear the bulk endpoint */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk</span><span class="p">)</span>
			<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

		<span class="cm">/* start the cam */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">destroy_urbs</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* some bulk transfers are started by the subdriver */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk</span> <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">bulk_nurbs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* submit the URBs */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">MAX_NURBS</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>			<span class="cm">/* transfer is started */</span>

		<span class="cm">/* something when wrong</span>
<span class="cm">		 * stop the webcam and free the transfer resources */</span>
		<span class="n">gspca_stream_off</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_submit_urb alt %d err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* the bandwidth is not wide enough</span>
<span class="cm">		 * negotiate or try a lower alternate setting */</span>
<span class="nl">retry:</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="o">|</span><span class="n">D_STREAM</span><span class="p">,</span>
			<span class="s">&quot;alt %d - bandwidth not wide enough - trying again&quot;</span><span class="p">,</span>
			<span class="n">alt</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>	<span class="cm">/* wait for kill complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">isoc_nego</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">isoc_nego</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">alt_idx</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no transfer endpoint found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">ep_tb</span><span class="p">[</span><span class="o">--</span><span class="n">alt_idx</span><span class="p">].</span><span class="n">alt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">gspca_input_create_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gspca_set_default_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">nmodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* take the highest mode */</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">;</span>

	<span class="cm">/* set the current control values to their default values</span>
<span class="cm">	 * which may have changed in sd_init() */</span>
	<span class="cm">/* does nothing if ctrl_handler == NULL */</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">nctrls</span><span class="p">;</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wxh_to_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">nmodes</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span>
		    <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * search a mode with the right pixel format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gspca_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">pixfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">modeU</span><span class="p">,</span> <span class="n">modeD</span><span class="p">;</span>

	<span class="n">modeU</span> <span class="o">=</span> <span class="n">modeD</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">modeU</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">nmodes</span><span class="p">)</span> <span class="o">||</span> <span class="n">modeD</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">modeD</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">modeD</span><span class="p">].</span><span class="n">pixelformat</span>
								<span class="o">==</span> <span class="n">pixfmt</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">modeD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">modeU</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">nmodes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">modeU</span><span class="p">].</span><span class="n">pixelformat</span>
								<span class="o">==</span> <span class="n">pixfmt</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">modeU</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_chip_ident</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_register</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_register</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_chip_ident</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">set_register</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">set_register</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_chip_ident</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_chip_ident</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmtdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">fmt_tb</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* give an index to each format */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">nmodes</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt_tb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt_tb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">fmt_tb</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>		<span class="cm">/* new format */</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fmt_tb</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* no more format */</span>

	<span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">fmt_tb</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">&lt;</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">*</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">)</span>
		<span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_FMT_FLAG_COMPRESSED</span><span class="p">;</span>
	<span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
		<span class="k">sizeof</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mode2</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

<span class="cp">#ifdef GSPCA_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_debug</span> <span class="o">&amp;</span> <span class="n">D_CONF</span><span class="p">)</span>
		<span class="n">PDEBUG_MODE</span><span class="p">(</span><span class="s">&quot;try fmt cap&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* search the closest mode for width and height */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">wxh_to_mode</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="cm">/* OK if right palette */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">mode</span><span class="p">].</span><span class="n">pixelformat</span>
						<span class="o">!=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* else, search the closest mode with the same pixel format */</span>
		<span class="n">mode2</span> <span class="o">=</span> <span class="n">gspca_get_mode</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
					<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">mode2</span><span class="p">;</span>
<span class="cm">/*		else</span>
<span class="cm">			;		 * no chance, return this mode */</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
		<span class="k">sizeof</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>			<span class="cm">/* used when s_fmt */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_fmt_vid_cap</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_fmt_vid_cap</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">!=</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">&gt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frsz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>			<span class="cm">/* same mode */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_framesizes</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_frmsizeenum</span> <span class="o">*</span><span class="n">fsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">nmodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">pixel_format</span> <span class="o">!=</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMSIZE_TYPE_DISCRETE</span><span class="p">;</span>
			<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
			<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_frameintervals</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_frmivalenum</span> <span class="o">*</span><span class="n">fival</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">wxh_to_mode</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">fival</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fival</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">mode_framerates</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">mode_framerates</span><span class="p">[</span><span class="n">mode</span><span class="p">].</span><span class="n">nrates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">pixel_format</span> <span class="o">!=</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">mode</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">mode_framerates</span><span class="p">[</span><span class="n">mode</span><span class="p">].</span><span class="n">nrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMSIZE_TYPE_DISCRETE</span><span class="p">;</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">mode_framerates</span><span class="p">[</span><span class="n">mode</span><span class="p">].</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gspca_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;%s released&quot;</span><span class="p">,</span>
		<span class="n">video_device_node_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>

	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;[%s] open&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>

	<span class="cm">/* protect the subdriver against rmmod */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef GSPCA_DEBUG</span>
	<span class="cm">/* activate the v4l2 debug */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_debug</span> <span class="o">&amp;</span> <span class="n">D_V4L2</span><span class="p">)</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">debug</span> <span class="o">|=</span> <span class="n">V4L2_DEBUG_IOCTL</span>
					<span class="o">|</span> <span class="n">V4L2_DEBUG_IOCTL_ARG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">V4L2_DEBUG_IOCTL</span>
					<span class="o">|</span> <span class="n">V4L2_DEBUG_IOCTL_ARG</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">v4l2_fh_open</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;[%s] close&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>

	<span class="cm">/* Needed for gspca_stream_off, always lock before queue_lock! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if the file did the capture, free the streaming resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
			<span class="n">gspca_stream_off</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="n">frame_free</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;close done&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_fh_release</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="k">sizeof</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span>
			<span class="k">sizeof</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
			<span class="s">&quot;USB Camera (%04x:%04x)&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span>
			  <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span>
			  <span class="o">|</span> <span class="n">V4L2_CAP_READWRITE</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">|</span> <span class="n">V4L2_CAP_DEVICE_CAPS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ctrl</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctrls</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">nctrls</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">ctrl_dis</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">qctrl</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">q_ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ctrl</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gspca_ctrl</span> <span class="o">*</span><span class="n">gspca_ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">q_ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_NEXT_CTRL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">&amp;=</span> <span class="n">V4L2_CTRL_ID_MASK</span><span class="p">;</span>
		<span class="n">id</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">nctrls</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">ctrl_dis</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">id</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
			 <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qctrl</span><span class="p">.</span><span class="n">id</span>
				    <span class="o">&gt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">qctrl</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">get_ctrl</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ctrls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">q_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">qctrl</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">q_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">q_ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">gspca_ctrl</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">;</span>
		<span class="n">q_ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">gspca_ctrl</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
		<span class="n">q_ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">gspca_ctrl</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">ctrl_inac</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">))</span>
		<span class="n">q_ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_INACTIVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ctrl</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gspca_ctrl</span> <span class="o">*</span><span class="n">gspca_ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">get_ctrl</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">ctrl_inac</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ctrls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">gspca_ctrl</span><span class="o">-&gt;</span><span class="n">min</span>
		    <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">gspca_ctrl</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gspca_ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">qctrl</span><span class="p">.</span><span class="n">minimum</span>
		    <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">qctrl</span><span class="p">.</span><span class="n">maximum</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_CONF</span><span class="p">,</span> <span class="s">&quot;set ctrl [%08x] = %d&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_ctrl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">set_control</span> <span class="o">!=</span> <span class="nb">NULL</span>
		 <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
			<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">set_control</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ctrl</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">get_ctrl</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ctrls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querymenu</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">qmenu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">querymenu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">querymenu</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">qmenu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">input_flags</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">streaming</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">;</span>			<span class="cm">/* (avoid compilation warning) */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GSPCA_MEMORY_READ</span>:			<span class="cm">/* (internal call) */</span>
	<span class="k">case</span> <span class="n">V4L2_MEMORY_MMAP</span>:
	<span class="k">case</span> <span class="n">V4L2_MEMORY_USERPTR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">GSPCA_MEMORY_NO</span>
	    <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">GSPCA_MEMORY_READ</span>
	    <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* only one file may do the capture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="nb">NULL</span>
	    <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if allocated, the buffers must not be mapped */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vma_use_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* stop streaming */</span>
	<span class="n">streaming</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_stream_off</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>

		<span class="cm">/* Don&#39;t restart the stream when switching from read</span>
<span class="cm">		 * to mmap mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">==</span> <span class="n">GSPCA_MEMORY_READ</span><span class="p">)</span>
			<span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* free the previous allocated buffers, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">frame_free</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>			<span class="cm">/* unrequest */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">frame_alloc</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">streaming</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">gspca_init_transfer</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;reqbufs st:%d c:%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">v4l2_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">v4l2_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">v4l2_buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buf_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="cm">/* check the capture file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gspca_init_transfer</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef GSPCA_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_debug</span> <span class="o">&amp;</span> <span class="n">D_STREAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG_MODE</span><span class="p">(</span><span class="s">&quot;stream on OK&quot;</span><span class="p">,</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">,</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buf_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the capture file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* stop streaming */</span>
	<span class="n">gspca_stream_off</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="cm">/* In case another thread is waiting in dqbuf */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="cm">/* empty the transfer queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BUF_ALL_FLAGS</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">jpegcomp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_jcomp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_jcomp</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">jpegcomp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">jpegcomp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">set_jcomp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">set_jcomp</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">jpegcomp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>

	<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">readbuffers</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nbufread</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_streamparm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">get_streamparm</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">readbuffers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">GSPCA_MAX_FRAMES</span><span class="p">)</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">readbuffers</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nbufread</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nbufread</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">set_streamparm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">set_streamparm</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;mmap start:%08x size:%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;mmap bad memory type&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span>
						<span class="o">==</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;mmap no frame buffer found&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;mmap bad size&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * - VM_IO marks the area as being a mmaped region for I/O to a</span>
<span class="cm">	 *   device. It also prevents the region from being core dumped.</span>
<span class="cm">	 */</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_IO</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vm_insert_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">gspca_vm_open</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">frame_ready_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_memory</span> <span class="n">memory</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="n">file</span> <span class="o">||</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">memory</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* check if a frame is ready */</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_o</span> <span class="o">!=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">frame_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">v4l2_memory</span> <span class="n">memory</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">frame_ready_nolock</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dequeue a video buffer</span>
<span class="cm"> *</span>
<span class="cm"> * If nonblock_ing is false, block until a buffer is available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">v4l2_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;dqbuf&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">frame_ready_nolock</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="cm">/* wait till a frame is ready */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
			<span class="n">frame_ready</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">),</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">3000</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_o</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_o</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">GSPCA_MAX_FRAMES</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">v4l2_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">v4l2_buf</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;dqbuf %d&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">==</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="n">__u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">,</span>
				 <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				 <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">bytesused</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="o">|</span><span class="n">D_STREAM</span><span class="p">,</span>
				<span class="s">&quot;dqbuf cp to user failed&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">dq_callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">dq_callback</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * queue a video buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Attempting to queue a buffer that has already been</span>
<span class="cm"> * queued will return -EINVAL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">v4l2_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;qbuf %d&quot;</span><span class="p">,</span> <span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span>
			<span class="s">&quot;qbuf idx %d &gt;= %d&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;qbuf bad memory type&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BUF_ALL_FLAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;qbuf bad state&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">memory</span> <span class="o">==</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span> <span class="o">=</span> <span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">userptr</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* put the buffer in the &#39;queued&#39; queue */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_q</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_q</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">GSPCA_MAX_FRAMES</span><span class="p">);</span>

	<span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
	<span class="n">v4l2_buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate the resources for read()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="n">v4l2_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;read alloc&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="n">rb</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">rb</span><span class="p">);</span>
		<span class="n">rb</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nbufread</span><span class="p">;</span>
		<span class="n">rb</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="n">rb</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">GSPCA_MEMORY_READ</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;read reqbuf err %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v4l2_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">v4l2_buf</span><span class="p">);</span>
		<span class="n">v4l2_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="n">v4l2_buf</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">GSPCA_MEMORY_READ</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nbufread</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4l2_buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;read qbuf err: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* start streaming */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;read streamon err %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dev_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_events</span> <span class="o">=</span> <span class="n">poll_requested_events</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;poll&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_events</span> <span class="o">&amp;</span> <span class="n">POLLPRI</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">v4l2_ctrl_poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* if reqbufs is not done, the user would use read() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">==</span> <span class="n">GSPCA_MEMORY_NO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read_alloc</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">POLLERR</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

		<span class="cm">/* check if an image has been received */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">POLLERR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_o</span> <span class="o">!=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">fr_i</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">POLLHUP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dev_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gspca_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="n">v4l2_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_FRAM</span><span class="p">,</span> <span class="s">&quot;read (%zd)&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">==</span> <span class="n">GSPCA_MEMORY_NO</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* first time ? */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_alloc</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get a frame */</span>
	<span class="n">timestamp</span> <span class="o">=</span> <span class="n">ktime_to_timeval</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">());</span>
	<span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">--</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v4l2_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">v4l2_buf</span><span class="p">);</span>
		<span class="n">v4l2_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="n">v4l2_buf</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">GSPCA_MEMORY_READ</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4l2_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;read dqbuf err %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if the process slept for more than 1 second,</span>
<span class="cm">		 * get a newer frame */</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>			<span class="cm">/* avoid infinite loop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">&gt;=</span> <span class="n">timestamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4l2_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_STREAM</span><span class="p">,</span> <span class="s">&quot;read qbuf err %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* copy the frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">bytesused</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">bytesused</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_ERR</span><span class="o">|</span><span class="n">D_STREAM</span><span class="p">,</span>
			<span class="s">&quot;read cp to user lack %d / %zd&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="cm">/* in each case, requeue the buffer */</span>
	<span class="n">ret2</span> <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4l2_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">dev_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">dev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dev_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">dev_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>	<span class="o">=</span> <span class="n">dev_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">dev_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>	<span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>		<span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>		<span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>	<span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span>	<span class="o">=</span> <span class="n">vidioc_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>	<span class="o">=</span> <span class="n">vidioc_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>	<span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>	<span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>		<span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>		<span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querymenu</span>	<span class="o">=</span> <span class="n">vidioc_querymenu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>	<span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>		<span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>		<span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>		<span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>	<span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>	<span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_jpegcomp</span>	<span class="o">=</span> <span class="n">vidioc_g_jpegcomp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_jpegcomp</span>	<span class="o">=</span> <span class="n">vidioc_s_jpegcomp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_parm</span>		<span class="o">=</span> <span class="n">vidioc_g_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_parm</span>		<span class="o">=</span> <span class="n">vidioc_s_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_framesizes</span> <span class="o">=</span> <span class="n">vidioc_enum_framesizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_frameintervals</span> <span class="o">=</span> <span class="n">vidioc_enum_frameintervals</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span>	<span class="o">=</span> <span class="n">vidioc_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span>	<span class="o">=</span> <span class="n">vidioc_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">vidioc_g_chip_ident</span>	<span class="o">=</span> <span class="n">vidioc_g_chip_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_subscribe_event</span> <span class="o">=</span> <span class="n">v4l2_ctrl_subscribe_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_unsubscribe_event</span> <span class="o">=</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">gspca_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;gspca main driver&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release_empty</span><span class="p">,</span> <span class="cm">/* We use v4l2_dev.release */</span>
<span class="p">};</span>

<span class="cm">/* initialize the controls */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctrls_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">nctrls</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">def</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qctrl</span><span class="p">.</span><span class="n">default_value</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qctrl</span><span class="p">.</span><span class="n">minimum</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qctrl</span><span class="p">.</span><span class="n">maximum</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * probe and create a new gspca device</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called by the sub-driver when it is</span>
<span class="cm"> * called for probing a new device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gspca_dev_probe2</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sd_desc</span> <span class="o">*</span><span class="n">sd_desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">dev_size</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s-&quot;</span> <span class="n">GSPCA_VERSION</span> <span class="s">&quot; probing %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="cm">/* create the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
		<span class="n">dev_size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dev_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t kzalloc gspca struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">USB_BUF_SZ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="cm">/* check if any audio device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumInterfaces</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf2</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumInterfaces</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intf2</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intf2</span> <span class="o">!=</span> <span class="nb">NULL</span>
			 <span class="o">&amp;&amp;</span> <span class="n">intf2</span><span class="o">-&gt;</span><span class="n">altsetting</span> <span class="o">!=</span> <span class="nb">NULL</span>
			 <span class="o">&amp;&amp;</span> <span class="n">intf2</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">==</span>
					 <span class="n">USB_CLASS_AUDIO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">audio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">gspca_release</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span> <span class="o">=</span> <span class="n">sd_desc</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">nbufread</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">empty_packet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* don&#39;t check the empty packets */</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">gspca_template</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_USE_FH_PRIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="cm">/* configure the subdriver and initialize the USB device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">ctrls</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ctrls_init</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">init_controls</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">init_controls</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">gspca_set_default_mode</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gspca_input_connect</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t take usb_lock for these ioctls. This improves latency if</span>
<span class="cm">	 * usb_lock is taken for a long time, e.g. when changing a control</span>
<span class="cm">	 * value, and a new frame is ready to be dequeued.</span>
<span class="cm">	 */</span>
	<span class="n">v4l2_disable_ioctl_locking</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VIDIOC_DQBUF</span><span class="p">);</span>
	<span class="n">v4l2_disable_ioctl_locking</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VIDIOC_QBUF</span><span class="p">);</span>
	<span class="n">v4l2_disable_ioctl_locking</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VIDIOC_QUERYBUF</span><span class="p">);</span>

	<span class="cm">/* init video stuff */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span>
				  <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span>
				  <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;video_register_device err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;%s created&quot;</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>

	<span class="n">gspca_input_create_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gspca_dev_probe2</span><span class="p">);</span>

<span class="cm">/* same function as the previous one, but check the interface */</span>
<span class="kt">int</span> <span class="nf">gspca_dev_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sd_desc</span> <span class="o">*</span><span class="n">sd_desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">dev_size</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="cm">/* we don&#39;t handle multi-config cameras */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%04x:%04x too many config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the USB video interface must be the first one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumInterfaces</span> <span class="o">!=</span> <span class="mi">1</span>
	 <span class="o">&amp;&amp;</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gspca_dev_probe2</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">sd_desc</span><span class="p">,</span> <span class="n">dev_size</span><span class="p">,</span> <span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gspca_dev_probe</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * USB disconnection</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called by the sub-driver</span>
<span class="cm"> * when the device disconnects, after the specific resources are freed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gspca_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">D_PROBE</span><span class="p">,</span> <span class="s">&quot;%s disconnect&quot;</span><span class="p">,</span>
		<span class="n">video_device_node_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">destroy_urbs</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
	<span class="n">gspca_input_destroy_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Free subdriver&#39;s streaming resources / stop sd workqueue(s) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stop0</span> <span class="o">&amp;&amp;</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stop0</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="n">v4l2_device_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>

	<span class="cm">/* (this will call gspca_release() immediately or on last close) */</span>
	<span class="n">v4l2_device_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gspca_disconnect</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="nf">gspca_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frozen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* avoid urb error messages */</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stopN</span><span class="p">)</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stopN</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">destroy_urbs</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">gspca_input_destroy_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">gspca_set_alt0</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stop0</span><span class="p">)</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">stop0</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gspca_suspend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">gspca_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">streaming</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">frozen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">sd_desc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">gspca_input_create_urb</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Most subdrivers send all ctrl values on sd_start and thus</span>
<span class="cm">	 * only write to the device registers on s_ctrl when streaming -&gt;</span>
<span class="cm">	 * Clear streaming to avoid setting all ctrls twice.</span>
<span class="cm">	 */</span>
	<span class="n">streaming</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">;</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">streaming</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gspca_init_transfer</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gspca_resume</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* -- module insert / remove -- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gspca_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;v&quot;</span> <span class="n">GSPCA_VERSION</span> <span class="s">&quot; registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">gspca_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">gspca_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">gspca_exit</span><span class="p">);</span>

<span class="cp">#ifdef GSPCA_DEBUG</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">gspca_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>
		<span class="s">&quot;Debug (bit) 0x01:error 0x02:probe 0x04:config&quot;</span>
		<span class="s">&quot; 0x08:stream 0x10:frame 0x20:packet&quot;</span>
		<span class="s">&quot; 0x0100: v4l2&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
