<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › gspca › se401.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>se401.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * GSPCA Endpoints (formerly known as AOX) se401 USB Camera sub Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Hans de Goede &lt;hdegoede@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the v4l1 se401 driver which is:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000 Jeroen B. Vreeken (pe1rxq@amsat.org)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define MODULE_NAME &quot;se401&quot;</span>

<span class="cp">#define BULK_SIZE 4096</span>
<span class="cp">#define PACKET_SIZE 1024</span>
<span class="cp">#define READ_REQ_SIZE 64</span>
<span class="cp">#define MAX_MODES ((READ_REQ_SIZE - 6) / 4)</span>
<span class="cm">/* The se401 compression algorithm uses a fixed quant factor, which</span>
<span class="cm">   can be configured by setting the high nibble of the SE401_OPERATINGMODE</span>
<span class="cm">   feature. This needs to exactly match what is in libv4l! */</span>
<span class="cp">#define SE401_QUANT_FACT 8</span>

<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;gspca.h&quot;</span>
<span class="cp">#include &quot;se401.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hans de Goede &lt;hdegoede@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Endpoints se401&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* controls */</span>
<span class="k">enum</span> <span class="n">e_ctrl</span> <span class="p">{</span>
	<span class="n">BRIGHTNESS</span><span class="p">,</span>
	<span class="n">GAIN</span><span class="p">,</span>
	<span class="n">EXPOSURE</span><span class="p">,</span>
	<span class="n">FREQ</span><span class="p">,</span>
	<span class="n">NCTRL</span>	<span class="cm">/* number of controls */</span>
<span class="p">};</span>

<span class="cm">/* exposure change state machine states */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">EXPO_CHANGED</span><span class="p">,</span>
	<span class="n">EXPO_DROP_FRAME</span><span class="p">,</span>
	<span class="n">EXPO_NO_CHANGE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* specific webcam descriptor */</span>
<span class="k">struct</span> <span class="n">sd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gspca_dev</span> <span class="n">gspca_dev</span><span class="p">;</span>	<span class="cm">/* !! must be the first item */</span>
	<span class="k">struct</span> <span class="n">gspca_ctrl</span> <span class="n">ctrls</span><span class="p">[</span><span class="n">NCTRL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">fmts</span><span class="p">[</span><span class="n">MAX_MODES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">pixels_read</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">packet_read</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">packet</span><span class="p">[</span><span class="n">PACKET_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">restart_stream</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">button_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resetlevel</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resetlevel_frame_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resetlevel_adjust_dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">expo_change_state</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">setbrightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setgain</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setexposure</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ctrl</span> <span class="n">sd_ctrls</span><span class="p">[</span><span class="n">NCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">[</span><span class="n">BRIGHTNESS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">id</span>      <span class="o">=</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>    <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
			<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;Brightness&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
			<span class="p">.</span><span class="n">step</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">set_control</span> <span class="o">=</span> <span class="n">setbrightness</span>
	<span class="p">},</span>
<span class="p">[</span><span class="n">GAIN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">id</span>      <span class="o">=</span> <span class="n">V4L2_CID_GAIN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>    <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
			<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;Gain&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="cm">/* Really 63 but &gt; 50 is not pretty */</span>
			<span class="p">.</span><span class="n">step</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">set_control</span> <span class="o">=</span> <span class="n">setgain</span>
	<span class="p">},</span>
<span class="p">[</span><span class="n">EXPOSURE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_EXPOSURE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Exposure&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">,</span>
			<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">set_control</span> <span class="o">=</span> <span class="n">setexposure</span>
	<span class="p">},</span>
<span class="p">[</span><span class="n">FREQ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">id</span>	 <span class="o">=</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>    <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
			<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;Light frequency filter&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">step</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">set_control</span> <span class="o">=</span> <span class="n">setexposure</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">se401_write_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span>
			      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;write req failed req %#04x val %#04x error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">req</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">se401_read_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">USB_BUF_SZ</span> <span class="o">&lt;</span> <span class="n">READ_REQ_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;USB_BUF_SZ too small!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span>
			      <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">,</span> <span class="n">READ_REQ_SIZE</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;read req failed req %#04x error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">se401_set_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">selector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">SE401_REQ_SET_EXT_FEATURE</span><span class="p">,</span>
			      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="n">param</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;set feature failed sel %#04x param %#04x error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">selector</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">se401_get_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">USB_BUF_SZ</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;USB_BUF_SZ too small!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">SE401_REQ_GET_EXT_FEATURE</span><span class="p">,</span>
			      <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;get feature failed sel %#04x error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">selector</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setbrightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">ctrl_dis</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BRIGHTNESS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* HDG: this does not seem to do anything on my cam */</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_SET_BRT</span><span class="p">,</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">BRIGHTNESS</span><span class="p">].</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setgain</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gain</span> <span class="o">=</span> <span class="mi">63</span> <span class="o">-</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">GAIN</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>

	<span class="cm">/* red color gain */</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_ARCG</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
	<span class="cm">/* green color gain */</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_AGCG</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
	<span class="cm">/* blue color gain */</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_ABCG</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setexposure</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span> <span class="n">gspca_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">integration</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">EXPOSURE</span><span class="p">].</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">expose_h</span><span class="p">,</span> <span class="n">expose_m</span><span class="p">,</span> <span class="n">expose_l</span><span class="p">;</span>

	<span class="cm">/* Do this before the set_feature calls, for proper timing wrt</span>
<span class="cm">	   the interrupt driven pkt_scan. Note we may still race but that</span>
<span class="cm">	   is not a big issue, the expo change state machine is merely for</span>
<span class="cm">	   avoiding underexposed frames getting send out, if one sneaks</span>
<span class="cm">	   through so be it */</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">expo_change_state</span> <span class="o">=</span> <span class="n">EXPO_CHANGED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">FREQ</span><span class="p">].</span><span class="n">val</span> <span class="o">==</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_50HZ</span><span class="p">)</span>
		<span class="n">integration</span> <span class="o">=</span> <span class="n">integration</span> <span class="o">-</span> <span class="n">integration</span> <span class="o">%</span> <span class="mi">106667</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">FREQ</span><span class="p">].</span><span class="n">val</span> <span class="o">==</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_60HZ</span><span class="p">)</span>
		<span class="n">integration</span> <span class="o">=</span> <span class="n">integration</span> <span class="o">-</span> <span class="n">integration</span> <span class="o">%</span> <span class="mi">88889</span><span class="p">;</span>

	<span class="n">expose_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">integration</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">expose_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">integration</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">expose_l</span> <span class="o">=</span> <span class="n">integration</span><span class="p">;</span>

	<span class="cm">/* integration time low */</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_TITL</span><span class="p">,</span> <span class="n">expose_l</span><span class="p">);</span>
	<span class="cm">/* integration time mid */</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_TITM</span><span class="p">,</span> <span class="n">expose_m</span><span class="p">);</span>
	<span class="cm">/* integration time high */</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_TITU</span><span class="p">,</span> <span class="n">expose_h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">widths</span><span class="p">[</span><span class="n">MAX_MODES</span><span class="p">],</span> <span class="n">heights</span><span class="p">[</span><span class="n">MAX_MODES</span><span class="p">];</span>

	<span class="cm">/* Read the camera descriptor */</span>
	<span class="n">se401_read_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_GET_CAMERA_DESCRIPTOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sometimes after being idle for a while the se401 won&#39;t</span>
<span class="cm">		   respond and needs a good kicking  */</span>
		<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">se401_read_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_GET_CAMERA_DESCRIPTOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Some cameras start with their LED on */</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_LED_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x41</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Wrong descriptor type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SE401_FORMAT_BAYER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Bayer format not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ExtraFeatures: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX_MODES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Too many frame sizes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* janggu compression only works for 1/4th or 1/16th res */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="n">heights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* 1/16th if available too is better then 1/4th, because</span>
<span class="cm">		   we then use a larger area of the sensor */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">==</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="n">heights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">==</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Not a 1/4th or 1/16th res, use bayer */</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_SBGGR8</span><span class="p">;</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Frame size: %dx%d bayer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Found a match use janggu compression */</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_SE401</span><span class="p">;</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Frame size: %dx%d 1/%dth janggu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priv</span> <span class="o">*</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">cam_mode</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">fmts</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">nmodes</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">bulk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">bulk_size</span> <span class="o">=</span> <span class="n">BULK_SIZE</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">bulk_nurbs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span> <span class="o">=</span> <span class="mh">0x2d</span><span class="p">;</span> <span class="cm">/* Set initial resetlevel */</span>

	<span class="cm">/* See if the camera supports brightness */</span>
	<span class="n">se401_read_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_GET_BRT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">ctrl_dis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BRIGHTNESS</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function is called at probe and resume time */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* function called at start time before URB creation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_isoc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Ignore the bogus isoc alt settings */</span>

	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -- start the camera -- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mult</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">].</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_CAMERA_POWER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sometimes after being idle for a while the se401 won&#39;t</span>
<span class="cm">		   respond and needs a good kicking  */</span>
		<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_CAMERA_POWER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_LED_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_MODE_B</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>

	<span class="cm">/* set size + mode */</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_SET_WIDTH</span><span class="p">,</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">mult</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_SET_HEIGHT</span><span class="p">,</span>
			<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">mult</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * HDG: disabled this as it does not seem to do anything</span>
<span class="cm">	 * se401_write_req(gspca_dev, SE401_REQ_SET_OUTPUT_MODE,</span>
<span class="cm">	 *		   SE401_FORMAT_BAYER, 0);</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mult</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* Raw bayer */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* 1/4th janggu */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">SE401_QUANT_FACT</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* 1/16th janggu */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">SE401_QUANT_FACT</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_OPERATINGMODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">setbrightness</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">setgain</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">setexposure</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
	<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_ARLV</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span><span class="p">);</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">pixels_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">restart_stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_frame_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_adjust_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">expo_change_state</span> <span class="o">=</span> <span class="n">EXPO_NO_CHANGE</span><span class="p">;</span>

	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_START_CONTINUOUS_CAPTURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">usb_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_stopN</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_STOP_CONTINUOUS_CAPTURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_LED_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">se401_write_req</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">SE401_REQ_CAMERA_POWER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_dq_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ahrc</span><span class="p">,</span> <span class="n">alrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oldreset</span><span class="p">,</span> <span class="n">adjust_dir</span><span class="p">;</span>

	<span class="cm">/* Restart the stream if requested do so by pkt_scan */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">restart_stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_stopN</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="n">sd_start</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">);</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">restart_stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Automatically adjust sensor reset level</span>
<span class="cm">	   Hyundai have some really nice docs about this and other sensor</span>
<span class="cm">	   related stuff on their homepage: www.hei.co.kr */</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_frame_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_frame_count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* For some reason this normally read-only register doesn&#39;t get reset</span>
<span class="cm">	   to zero after reading them just once... */</span>
	<span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_HIREFNOH</span><span class="p">);</span>
	<span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_HIREFNOL</span><span class="p">);</span>
	<span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_LOREFNOH</span><span class="p">);</span>
	<span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_LOREFNOL</span><span class="p">);</span>
	<span class="n">ahrc</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_HIREFNOH</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_HIREFNOL</span><span class="p">);</span>
	<span class="n">alrc</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_LOREFNOH</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">se401_get_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_LOREFNOL</span><span class="p">);</span>

	<span class="cm">/* Not an exact science, but it seems to work pretty well... */</span>
	<span class="n">oldreset</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alrc</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">alrc</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span> <span class="o">&lt;</span> <span class="mi">63</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span><span class="o">++</span><span class="p">;</span>
			<span class="n">alrc</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahrc</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ahrc</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ahrc</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Detect ping-pong-ing and halve adjustment to avoid overshoot */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span> <span class="o">&gt;</span> <span class="n">oldreset</span><span class="p">)</span>
		<span class="n">adjust_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adjust_dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_adjust_dir</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_adjust_dir</span> <span class="o">!=</span> <span class="n">adjust_dir</span><span class="p">)</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span> <span class="o">=</span> <span class="n">oldreset</span> <span class="o">+</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span> <span class="o">-</span> <span class="n">oldreset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span> <span class="o">!=</span> <span class="n">oldreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_adjust_dir</span> <span class="o">=</span> <span class="n">adjust_dir</span><span class="p">;</span>
		<span class="n">se401_set_feature</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">HV7131_REG_ARLV</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">resetlevel_frame_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_complete_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">expo_change_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EXPO_CHANGED</span>:
		<span class="cm">/* The exposure was changed while this frame</span>
<span class="cm">		   was being send, so this frame is ok */</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">expo_change_state</span> <span class="o">=</span> <span class="n">EXPO_DROP_FRAME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXPO_DROP_FRAME</span>:
		<span class="cm">/* The exposure was changed while this frame</span>
<span class="cm">		   was being captured, drop it! */</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">DISCARD_PACKET</span><span class="p">;</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">expo_change_state</span> <span class="o">=</span> <span class="n">EXPO_NO_CHANGE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXPO_NO_CHANGE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">LAST_PACKET</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_pkt_scan_janggu</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imagesize</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">restart_stream</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Sometimes a 1024 bytes garbage bulk packet is send between frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">==</span> <span class="n">LAST_PACKET</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">last_packet_type</span> <span class="o">=</span> <span class="n">DISCARD_PACKET</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read header if not already be present from prev bulk pkt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bits</span>   <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pixels</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">info</span>   <span class="o">=</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">plen</span>   <span class="o">=</span> <span class="p">((</span><span class="n">bits</span> <span class="o">+</span> <span class="mi">47</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Sanity checks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;invalid packet len %d restarting stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">plen</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unknown frame info value restarting stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read (remainder of) packet contents */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">plen</span> <span class="o">-</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span> <span class="o">&lt;</span> <span class="n">plen</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">pixels_read</span> <span class="o">+=</span> <span class="n">pixels</span><span class="p">;</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* Frame data */</span>
			<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">INTER_PACKET</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span>
					<span class="n">plen</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* EOF */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">pixels_read</span> <span class="o">!=</span> <span class="n">imagesize</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;frame size %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">sd</span><span class="o">-&gt;</span><span class="n">pixels_read</span><span class="p">,</span> <span class="n">imagesize</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sd_complete_frame</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* Discard the rest of the bulk packet !! */</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* SOF */</span>
			<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">FIRST_PACKET</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span>
					<span class="n">plen</span><span class="p">);</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">pixels_read</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">restart_stream</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Give userspace a 0 bytes frame, so our dq callback gets</span>
<span class="cm">	   called and it can restart the stream */</span>
	<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">FIRST_PACKET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">LAST_PACKET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_pkt_scan_bayer</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cam</span> <span class="o">*</span><span class="n">cam</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imagesize</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">].</span><span class="n">sizeimage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">FIRST_PACKET</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">image_len</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">imagesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_complete_frame</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gspca_frame_add</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">INTER_PACKET</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_pkt_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mult</span> <span class="o">=</span> <span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">cam</span><span class="p">.</span><span class="n">cam_mode</span><span class="p">[</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">curr_mode</span><span class="p">].</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mult</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* mult == 1 means raw bayer */</span>
		<span class="n">sd_pkt_scan_bayer</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sd_pkt_scan_janggu</span><span class="p">(</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_querymenu</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_DISABLED</span>:
			<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;NoFliker&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_50HZ</span>:
			<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;50 Hz&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_60HZ</span>:
			<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;60 Hz&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_int_pkt_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gspca_dev</span> <span class="o">*</span><span class="n">gspca_dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd</span> <span class="o">*</span><span class="p">)</span><span class="n">gspca_dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">button_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">KEY_CAMERA</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">gspca_dev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">button_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* sub-driver description */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sd_desc</span> <span class="n">sd_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">sd_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nctrls</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sd_ctrls</span><span class="p">),</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">sd_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">sd_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">isoc_init</span> <span class="o">=</span> <span class="n">sd_isoc_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">sd_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stopN</span> <span class="o">=</span> <span class="n">sd_stopN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dq_callback</span> <span class="o">=</span> <span class="n">sd_dq_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pkt_scan</span> <span class="o">=</span> <span class="n">sd_pkt_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querymenu</span> <span class="o">=</span> <span class="n">sd_querymenu</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)</span>
	<span class="p">.</span><span class="n">int_pkt_scan</span> <span class="o">=</span> <span class="n">sd_int_pkt_scan</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* -- module initialisation -- */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">device_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03e8</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">)},</span> <span class="cm">/* Endpoints/Aox SE401 */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x030b</span><span class="p">)},</span> <span class="cm">/* Philips PCVC665K */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x047d</span><span class="p">,</span> <span class="mh">0x5001</span><span class="p">)},</span> <span class="cm">/* Kensington 67014 */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x047d</span><span class="p">,</span> <span class="mh">0x5002</span><span class="p">)},</span> <span class="cm">/* Kensington 6701(5/7) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x047d</span><span class="p">,</span> <span class="mh">0x5003</span><span class="p">)},</span> <span class="cm">/* Kensington 67016 */</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">device_table</span><span class="p">);</span>

<span class="cm">/* -- device connect -- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gspca_dev_probe</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd</span><span class="p">),</span>
				<span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_post_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">sd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">device_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">gspca_disconnect</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">gspca_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">gspca_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">pre_reset</span> <span class="o">=</span> <span class="n">sd_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_reset</span> <span class="o">=</span> <span class="n">sd_post_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">sd_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
