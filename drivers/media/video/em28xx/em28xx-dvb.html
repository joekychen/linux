<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › em28xx › em28xx-dvb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>em28xx-dvb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> DVB device driver for em28xx</span>

<span class="cm"> (c) 2008-2011 Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>

<span class="cm"> (c) 2008 Devin Heitmueller &lt;devin.heitmueller@gmail.com&gt;</span>
<span class="cm">	- Fixes for the driver to properly work with HVR-950</span>
<span class="cm">	- Fixes for the driver to properly work with Pinnacle PCTV HD Pro Stick</span>
<span class="cm">	- Fixes for the driver to properly work with AMD ATI TV Wonder HD 600</span>

<span class="cm"> (c) 2008 Aidan Thornton &lt;makosoft@googlemail.com&gt;</span>

<span class="cm"> Based on cx88-dvb, saa7134-dvb and videobuf-dvb originally written by:</span>
<span class="cm">	(c) 2004, 2005 Chris Pascoe &lt;c.pascoe@itee.uq.edu.au&gt;</span>
<span class="cm">	(c) 2004 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]</span>

<span class="cm"> This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> it under the terms of the GNU General Public License as published by</span>
<span class="cm"> the Free Software Foundation; either version 2 of the License.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>

<span class="cp">#include &quot;em28xx.h&quot;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/videobuf-vmalloc.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &quot;tuner-simple.h&quot;</span>

<span class="cp">#include &quot;lgdt330x.h&quot;</span>
<span class="cp">#include &quot;lgdt3305.h&quot;</span>
<span class="cp">#include &quot;zl10353.h&quot;</span>
<span class="cp">#include &quot;s5h1409.h&quot;</span>
<span class="cp">#include &quot;mt352.h&quot;</span>
<span class="cp">#include &quot;mt352_priv.h&quot; </span><span class="cm">/* FIXME */</span><span class="cp"></span>
<span class="cp">#include &quot;tda1002x.h&quot;</span>
<span class="cp">#include &quot;tda18271.h&quot;</span>
<span class="cp">#include &quot;s921.h&quot;</span>
<span class="cp">#include &quot;drxd.h&quot;</span>
<span class="cp">#include &quot;cxd2820r.h&quot;</span>
<span class="cp">#include &quot;tda18271c2dd.h&quot;</span>
<span class="cp">#include &quot;drxk.h&quot;</span>
<span class="cp">#include &quot;tda10071.h&quot;</span>
<span class="cp">#include &quot;a8293.h&quot;</span>
<span class="cp">#include &quot;qt1010.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;driver for em28xx based DVB cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [dvb]&quot;</span><span class="p">);</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="cp">#define dprintk(level, fmt, arg...) do {			\</span>
<span class="cp">if (debug &gt;= level) 						\</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/2-dvb: &quot; fmt, dev-&gt;name, ## arg);	\</span>
<span class="cp">} while (0)</span>

<span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span>        <span class="o">*</span><span class="n">fe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* feed count management */</span>
	<span class="k">struct</span> <span class="n">mutex</span>               <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>                        <span class="n">nfeeds</span><span class="p">;</span>

	<span class="cm">/* general boilerplate stuff */</span>
	<span class="k">struct</span> <span class="n">dvb_adapter</span>         <span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span>           <span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmxdev</span>              <span class="n">dmxdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmx_frontend</span>        <span class="n">fe_hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmx_frontend</span>        <span class="n">fe_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_net</span>             <span class="n">net</span><span class="p">;</span>

	<span class="cm">/* Due to DRX-K - probably need changes */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">gate_ctrl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">semaphore</span>      <span class="n">pll_mutex</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">dont_attach_fe1</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print_err_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">packet</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;unlinked synchronuously&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;unlinked asynchronuously&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOSR</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Buffer error (overrun)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Stalled (device not responding)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EOVERFLOW</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Babble (bad cable?)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPROTO</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Bit-stuff error (bad cable?)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EILSEQ</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;CRC/Timeout (could be anything)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Device does not respond&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;URB status %d [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;URB packet %d, status %d [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">packet</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">em28xx_dvb_isoc_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_MISCONFIGURED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_err_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_err_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dvb_dmx_swfilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span>
				 <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
				 <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_start_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_dvb_packet_size</span><span class="p">;</span>

	<span class="n">usb_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb_alt</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">max_dvb_packet_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb_max_pkt_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_dvb_packet_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">max_dvb_packet_size</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Using %d buffers each with %d x %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">EM28XX_DVB_NUM_BUFS</span><span class="p">,</span>
		<span class="n">EM28XX_DVB_MAX_PACKETS</span><span class="p">,</span>
		<span class="n">max_dvb_packet_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">em28xx_init_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">,</span>
				<span class="n">EM28XX_DVB_MAX_PACKETS</span><span class="p">,</span> <span class="n">EM28XX_DVB_NUM_BUFS</span><span class="p">,</span>
				<span class="n">max_dvb_packet_size</span><span class="p">,</span> <span class="n">em28xx_dvb_isoc_copy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_stop_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">em28xx_stop_urbs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">em28xx_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_SUSPEND</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_start_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span>  <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span> <span class="o">=</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">nfeeds</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">nfeeds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">nfeeds</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_start_streaming</span><span class="p">(</span><span class="n">dvb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_stop_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span>  <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span> <span class="o">=</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">nfeeds</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">nfeeds</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">em28xx_stop_streaming</span><span class="p">(</span><span class="n">dvb</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_dvb_bus_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acquire</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acquire</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">em28xx_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">em28xx_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_SUSPEND</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lgdt330x_config</span> <span class="n">em2880_lgdt3303_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_chip</span> <span class="o">=</span> <span class="n">LGDT3303</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lgdt3305_config</span> <span class="n">em2870_lgdt3304_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_addr</span>           <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_chip</span>         <span class="o">=</span> <span class="n">LGDT3304</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spectral_inversion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deny_i2c_rptr</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mpeg_mode</span>          <span class="o">=</span> <span class="n">LGDT3305_MPEG_PARALLEL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpclk_edge</span>         <span class="o">=</span> <span class="n">LGDT3305_TPCLK_FALLING_EDGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpvalid_polarity</span>   <span class="o">=</span> <span class="n">LGDT3305_TP_VALID_HIGH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsb_if_khz</span>         <span class="o">=</span> <span class="mi">3250</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qam_if_khz</span>         <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s921_config</span> <span class="n">sharp_isdbt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x30</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zl10353_config</span> <span class="n">em28xx_zl10353_with_xc3028</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1e</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">no_tuner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parallel_ts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if2</span> <span class="o">=</span> <span class="mi">45600</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s5h1409_config</span> <span class="n">em28xx_s5h1409_with_xc3028</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x32</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_mode</span>   <span class="o">=</span> <span class="n">S5H1409_PARALLEL_OUTPUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio</span>          <span class="o">=</span> <span class="n">S5H1409_GPIO_OFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inversion</span>     <span class="o">=</span> <span class="n">S5H1409_INVERSION_OFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status_mode</span>   <span class="o">=</span> <span class="n">S5H1409_DEMODLOCKING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mpeg_timing</span>   <span class="o">=</span> <span class="n">S5H1409_MPEGTIMING_CONTINOUS_NONINVERTING_CLOCK</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda18271_std_map</span> <span class="n">kworld_a340_std_map</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">atsc_6</span>   <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">if_freq</span> <span class="o">=</span> <span class="mi">3250</span><span class="p">,</span> <span class="p">.</span><span class="n">agc_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="p">.</span><span class="n">if_lvl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">rfagc_top</span> <span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">qam_6</span>    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">if_freq</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span> <span class="p">.</span><span class="n">agc_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		      <span class="p">.</span><span class="n">if_lvl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">rfagc_top</span> <span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda18271_config</span> <span class="n">kworld_a340_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">std_map</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">kworld_a340_std_map</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zl10353_config</span> <span class="n">em28xx_zl10353_xc3028_no_i2c_gate</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1e</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">no_tuner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_i2c_gate_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parallel_ts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if2</span> <span class="o">=</span> <span class="mi">45600</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drxd_config</span> <span class="n">em28xx_drxd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_revision</span> <span class="o">=</span> <span class="mh">0xa2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_type</span> <span class="o">=</span> <span class="n">DRXD_PLL_NONE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">insert_rs_byte</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">IF</span> <span class="o">=</span> <span class="mi">42800000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_i2c_gate_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">drxk_config</span> <span class="n">terratec_h5_drxk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">adr</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="p">.</span><span class="n">single_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_i2c_bridge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">microcode_name</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-terratec-h5-drxk.fw&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">drxk_config</span> <span class="n">hauppauge_930c_drxk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">adr</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="p">.</span><span class="n">single_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_i2c_bridge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">microcode_name</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-hauppauge-hvr930c-drxk.fw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">56</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">drxk_config</span> <span class="n">maxmedia_ub425_tc_drxk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">adr</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="p">.</span><span class="n">single_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_i2c_bridge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">drxk_config</span> <span class="n">pctv_520e_drxk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">adr</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="p">.</span><span class="n">single_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">microcode_name</span> <span class="o">=</span> <span class="s">&quot;dvb-demod-drxk-pctv.fw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">58</span><span class="p">,</span>
	<span class="p">.</span><span class="n">antenna_dvbt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="cm">/* disable LNA */</span>
	<span class="p">.</span><span class="n">antenna_gpio</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* disable LNA */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">sec_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">pll_mutex</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">pll_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hauppauge_hvr930c_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">em28xx_reg_seq</span> <span class="n">hauppauge_hvr930c_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x65</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xfb</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x32</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0xb8</span><span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                   <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">em28xx_reg_seq</span> <span class="n">hauppauge_hvr930c_end</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xef</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xaf</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x65</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xef</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x76</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xef</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xcf</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x0b</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xef</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>

		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xcf</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x65</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xef</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x65</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xcf</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x0b</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xef</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0x65</span><span class="p">},</span>

		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                   <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc6</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hauppauge_hvr930c_init</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R06_I2C_CLK</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R06_I2C_CLK</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x82</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">i2c_master_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
	<span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hauppauge_hvr930c_end</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R06_I2C_CLK</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R06_I2C_CLK</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">terratec_h5_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_reg_seq</span> <span class="n">terratec_h5_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">EM28XX_R08_GPIO</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mi">10</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xf6</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mi">100</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xf2</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mi">50</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xf6</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mi">100</span><span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                   <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">em28xx_reg_seq</span> <span class="n">terratec_h5_end</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xe6</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mi">100</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xa6</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mi">50</span><span class="p">},</span>
		<span class="p">{</span><span class="n">EM2874_R80_GPIO</span><span class="p">,</span>	<span class="mh">0xe6</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">,</span>	<span class="mi">100</span><span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                   <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">,</span>     <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc6</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">terratec_h5_init</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R06_I2C_CLK</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R06_I2C_CLK</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x82</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">i2c_master_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
	<span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">terratec_h5_end</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pctv_520e_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Init AVF4910B analog decoder. Looks like I2C traffic to</span>
<span class="cm">	 * digital demodulator and tuner are routed via AVF4910B.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc6</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x82</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 0x41 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">i2c_master_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_mt352_terratec_xs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Values extracted from a USB trace of the Terratec Windows driver */</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">clock_config</span><span class="p">[]</span>   <span class="o">=</span> <span class="p">{</span> <span class="n">CLOCK_CTL</span><span class="p">,</span>  <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x2c</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">reset</span><span class="p">[]</span>          <span class="o">=</span> <span class="p">{</span> <span class="n">RESET</span><span class="p">,</span>      <span class="mh">0x80</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">adc_ctl_1_cfg</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="n">ADC_CTL_1</span><span class="p">,</span>  <span class="mh">0x40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">agc_cfg</span><span class="p">[]</span>        <span class="o">=</span> <span class="p">{</span> <span class="n">AGC_TARGET</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">input_freq_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">INPUT_FREQ_1</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb8</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">rs_err_cfg</span><span class="p">[]</span>     <span class="o">=</span> <span class="p">{</span> <span class="n">RS_ERR_PER_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4d</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">capt_range_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CAPT_RANGE</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">trl_nom_cfg</span><span class="p">[]</span>    <span class="o">=</span> <span class="p">{</span> <span class="n">TRL_NOMINAL_RATE_1</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">tps_given_cfg</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="n">TPS_GIVEN_1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x50</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">tuner_go</span><span class="p">[]</span>       <span class="o">=</span> <span class="p">{</span> <span class="n">TUNER_GO</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">};</span>

	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">clock_config</span><span class="p">,</span>   <span class="k">sizeof</span><span class="p">(</span><span class="n">clock_config</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span>          <span class="k">sizeof</span><span class="p">(</span><span class="n">reset</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">adc_ctl_1_cfg</span><span class="p">,</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">adc_ctl_1_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">agc_cfg</span><span class="p">,</span>        <span class="k">sizeof</span><span class="p">(</span><span class="n">agc_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">input_freq_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_freq_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">rs_err_cfg</span><span class="p">,</span>     <span class="k">sizeof</span><span class="p">(</span><span class="n">rs_err_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">capt_range_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">capt_range_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">trl_nom_cfg</span><span class="p">,</span>    <span class="k">sizeof</span><span class="p">(</span><span class="n">trl_nom_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">tps_given_cfg</span><span class="p">,</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">tps_given_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">tuner_go</span><span class="p">,</span>       <span class="k">sizeof</span><span class="p">(</span><span class="n">tuner_go</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt352_config</span> <span class="n">terratec_xs_mt352_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1e</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">no_tuner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if2</span> <span class="o">=</span> <span class="mi">45600</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_init</span> <span class="o">=</span> <span class="n">em28xx_mt352_terratec_xs_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda10023_config</span> <span class="n">em28xx_tda10023_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxd2820r_config</span> <span class="n">em28xx_cxd2820r_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xd8</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ts_mode</span> <span class="o">=</span> <span class="n">CXD2820R_TS_SERIAL</span><span class="p">,</span>

	<span class="cm">/* enable LNA for DVB-T, DVB-T2 and DVB-C */</span>
	<span class="p">.</span><span class="n">gpio_dvbt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CXD2820R_GPIO_E</span> <span class="o">|</span> <span class="n">CXD2820R_GPIO_O</span> <span class="o">|</span> <span class="n">CXD2820R_GPIO_L</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_dvbt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CXD2820R_GPIO_E</span> <span class="o">|</span> <span class="n">CXD2820R_GPIO_O</span> <span class="o">|</span> <span class="n">CXD2820R_GPIO_L</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_dvbc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CXD2820R_GPIO_E</span> <span class="o">|</span> <span class="n">CXD2820R_GPIO_O</span> <span class="o">|</span> <span class="n">CXD2820R_GPIO_L</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda18271_config</span> <span class="n">em28xx_cxd2820r_tda18271_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">output_opt</span> <span class="o">=</span> <span class="n">TDA18271_OUTPUT_LT_OFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gate</span> <span class="o">=</span> <span class="n">TDA18271_GATE_DIGITAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tda10071_config</span> <span class="n">em28xx_tda10071_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span> <span class="cm">/* (0xaa &gt;&gt; 1) */</span>
	<span class="p">.</span><span class="n">i2c_wr_max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ts_mode</span> <span class="o">=</span> <span class="n">TDA10071_TS_SERIAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spec_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal</span> <span class="o">=</span> <span class="mi">40444000</span><span class="p">,</span> <span class="cm">/* 40.444 MHz */</span>
	<span class="p">.</span><span class="n">pll_multiplier</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">a8293_config</span> <span class="n">em28xx_a8293_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span> <span class="cm">/* (0x10 &gt;&gt; 1) */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zl10353_config</span> <span class="n">em28xx_zl10353_no_i2c_gate_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1e</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">disable_i2c_gate_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_tuner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parallel_ts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qt1010_config</span> <span class="n">em28xx_qt1010_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0x62</span>

<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_attach_xc3028</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xc2028_config</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">i2c_adap</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">i2c_addr</span>  <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;/2: dvb frontend not attached. &quot;</span>
				<span class="s">&quot;Can&#39;t attach xc3028</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">xc2028_attach</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;/2: xc3028 attach failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;%s/2: xc3028 attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_register_dvb</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* register adapter */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_register_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
				      <span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dvb_register_adapter failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_adapter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure all frontends negotiate bus access */</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span> <span class="o">=</span> <span class="n">em28xx_dvb_bus_ctrl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span> <span class="o">=</span> <span class="n">em28xx_dvb_bus_ctrl</span><span class="p">;</span>

	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* register frontend */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dvb_register_frontend failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_frontend0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register 2nd frontend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: 2nd dvb_register_frontend failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_frontend1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* register demux stuff */</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span>
		<span class="n">DMX_TS_FILTERING</span> <span class="o">|</span> <span class="n">DMX_SECTION_FILTERING</span> <span class="o">|</span>
		<span class="n">DMX_MEMORY_BASED_FILTERING</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">priv</span>       <span class="o">=</span> <span class="n">dvb</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">filternum</span>  <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">feednum</span>    <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">start_feed</span> <span class="o">=</span> <span class="n">em28xx_start_feed</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">stop_feed</span>  <span class="o">=</span> <span class="n">em28xx_stop_feed</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_dmx_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dvb_dmx_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_dmx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">filternum</span>    <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">demux</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_dmxdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dvb_dmxdev_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_dmxdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_FRONTEND_0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: add_frontend failed (DMX_FRONTEND_0, errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_fe_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: add_frontend failed (DMX_MEMORY_FE, errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_fe_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">connect_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: connect_frontend failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_fe_conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register network adapter */</span>
	<span class="n">dvb_net_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_fe_conn:</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">);</span>
<span class="nl">fail_fe_mem:</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
<span class="nl">fail_fe_hw:</span>
	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
<span class="nl">fail_dmxdev:</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
<span class="nl">fail_dmx:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">fail_frontend1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nl">fail_frontend0:</span>
	<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">fail_adapter:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_unregister_dvb</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dvb_net_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">);</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">dont_attach_fe1</span><span class="p">)</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_dvb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mfe_shared</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">has_dvb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This device does not support the extension */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;em28xx_dvb: This device does not support the extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dvb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_dvb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;em28xx_dvb: memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span> <span class="o">=</span> <span class="n">dvb</span><span class="p">;</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">em28xx_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">);</span>
	<span class="cm">/* init frontend */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EM2874_BOARD_LEADERSHIP_ISDBT</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">s921_attach</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sharp_isdbt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2883_BOARD_HAUPPAUGE_WINTV_HVR_850</span>:
	<span class="k">case</span> <span class="n">EM2883_BOARD_HAUPPAUGE_WINTV_HVR_950</span>:
	<span class="k">case</span> <span class="n">EM2880_BOARD_PINNACLE_PCTV_HD_PRO</span>:
	<span class="k">case</span> <span class="n">EM2880_BOARD_AMD_ATI_TV_WONDER_HD_600</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">lgdt330x_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em2880_lgdt3303_dev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_attach_xc3028</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2880_BOARD_KWORLD_DVB_310U</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">zl10353_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em28xx_zl10353_with_xc3028</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_attach_xc3028</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2880_BOARD_HAUPPAUGE_WINTV_HVR_900</span>:
	<span class="k">case</span> <span class="n">EM2882_BOARD_TERRATEC_HYBRID_XS</span>:
	<span class="k">case</span> <span class="n">EM2880_BOARD_EMPIRE_DUAL_TV</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">zl10353_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em28xx_zl10353_xc3028_no_i2c_gate</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_attach_xc3028</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2880_BOARD_TERRATEC_HYBRID_XS</span>:
	<span class="k">case</span> <span class="n">EM2880_BOARD_TERRATEC_HYBRID_XS_FR</span>:
	<span class="k">case</span> <span class="n">EM2881_BOARD_PINNACLE_HYBRID_PRO</span>:
	<span class="k">case</span> <span class="n">EM2882_BOARD_DIKOM_DK300</span>:
	<span class="k">case</span> <span class="n">EM2882_BOARD_KWORLD_VS_DVBT</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">zl10353_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em28xx_zl10353_xc3028_no_i2c_gate</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This board could have either a zl10353 or a mt352.</span>
<span class="cm">			   If the chip id isn&#39;t for zl10353, try mt352 */</span>
			<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt352_attach</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">terratec_xs_mt352_cfg</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_attach_xc3028</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2870_BOARD_KWORLD_355U</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">zl10353_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em28xx_zl10353_no_i2c_gate_dev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">qt1010_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_qt1010_config</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2883_BOARD_KWORLD_HYBRID_330U</span>:
	<span class="k">case</span> <span class="n">EM2882_BOARD_EVGA_INDTUBE</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">s5h1409_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em28xx_s5h1409_with_xc3028</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_attach_xc3028</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2882_BOARD_KWORLD_ATSC_315U</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">lgdt330x_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em2880_lgdt3303_dev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="n">TUNER_THOMSON_DTT761X</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2880_BOARD_HAUPPAUGE_WINTV_HVR_900_R2</span>:
	<span class="k">case</span> <span class="n">EM2882_BOARD_PINNACLE_HYBRID_PRO_330E</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">drxd_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_drxd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_attach_xc3028</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2870_BOARD_REDDO_DVB_C_USB_BOX</span>:
		<span class="cm">/* Philips CU1216L NIM (Philips TDA10023 + Infineon TUA6034) */</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10023_attach</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">em28xx_tda10023_config</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">TUNER_PHILIPS_CU1216L</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2870_BOARD_KWORLD_A340</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">lgdt3305_attach</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">em2870_lgdt3304_dev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18271_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x60</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kworld_a340_config</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM28174_BOARD_PCTV_290E</span>:
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">cxd2820r_attach</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">em28xx_cxd2820r_config</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* FE 0 attach tuner */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18271_attach</span><span class="p">,</span>
					<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="mh">0x60</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">em28xx_cxd2820r_tda18271_config</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2884_BOARD_HAUPPAUGE_WINTV_HVR_930C</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">xc5000_config</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="n">hauppauge_hvr930c_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">drxk_attach</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hauppauge_930c_drxk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FIXME: do we need a pll semaphore? */</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sec_priv</span> <span class="o">=</span> <span class="n">dvb</span><span class="p">;</span>
		<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">pll_mutex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">gate_ctrl</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">;</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">drxk_gate_ctrl</span><span class="p">;</span>

		<span class="cm">/* Attach xc5000 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">));</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">i2c_address</span>  <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">if_khz</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">xc5000_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">EM2884_BOARD_TERRATEC_H5</span>:
	<span class="k">case</span> <span class="n">EM2884_BOARD_CINERGY_HTC_STICK</span>:
		<span class="n">terratec_h5_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">drxk_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">terratec_h5_drxk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FIXME: do we need a pll semaphore? */</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sec_priv</span> <span class="o">=</span> <span class="n">dvb</span><span class="p">;</span>
		<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">pll_mutex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">gate_ctrl</span> <span class="o">=</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">;</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">drxk_gate_ctrl</span><span class="p">;</span>

		<span class="cm">/* Attach tda18271 to DVB-C frontend */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18271c2dd_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM28174_BOARD_PCTV_460E</span>:
		<span class="cm">/* attach demod */</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10071_attach</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">em28xx_tda10071_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="cm">/* attach SEC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">a8293_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">em28xx_a8293_config</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2874_BOARD_MAXMEDIA_UB425_TC</span>:
		<span class="cm">/* attach demodulator */</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">drxk_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxmedia_ub425_tc_drxk</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* disable I2C-gate */</span>
			<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* attach tuner */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18271c2dd_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* TODO: we need drx-3913k firmware in order to support DVB-T */</span>
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;MaxMedia UB425-TC: only DVB-C supported by that &quot;</span> \
				<span class="s">&quot;driver version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2884_BOARD_PCTV_510E</span>:
	<span class="k">case</span> <span class="n">EM2884_BOARD_PCTV_520E</span>:
		<span class="n">pctv_520e_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* attach demodulator */</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">drxk_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pctv_520e_drxk</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* attach tuner */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18271_attach</span><span class="p">,</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x60</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">em28xx_cxd2820r_tda18271_config</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;/2: The frontend of your DVB/ATSC card&quot;</span>
				<span class="s">&quot; isn&#39;t supported yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;/2: frontend initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* define general-purpose callback pointer */</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">em28xx_tuner_callback</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">em28xx_tuner_callback</span><span class="p">;</span>

	<span class="cm">/* register everything */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">em28xx_register_dvb</span><span class="p">(</span><span class="n">dvb</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="cm">/* MFE lock */</span>
	<span class="n">dvb</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">mfe_shared</span> <span class="o">=</span> <span class="n">mfe_shared</span><span class="p">;</span>

	<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;Successfully loaded em28xx-dvb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">ret:</span>
	<span class="n">em28xx_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_SUSPEND</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dvb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">prevent_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">sleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_dvb_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">has_dvb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This device does not support the extension */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">em28xx_dvb</span> <span class="o">*</span><span class="n">dvb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We cannot tell the device to sleep</span>
<span class="cm">			 * once it has been unplugged. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">prevent_sleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">prevent_sleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">em28xx_unregister_dvb</span><span class="p">(</span><span class="n">dvb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dvb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dvb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">em28xx_ops</span> <span class="n">dvb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>   <span class="o">=</span> <span class="n">EM28XX_DVB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Em28xx dvb Extension&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">em28xx_dvb_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fini</span> <span class="o">=</span> <span class="n">em28xx_dvb_fini</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">em28xx_dvb_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">em28xx_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">em28xx_dvb_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">em28xx_unregister_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvb_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">em28xx_dvb_register</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">em28xx_dvb_unregister</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
