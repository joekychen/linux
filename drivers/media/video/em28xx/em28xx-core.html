<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › em28xx › em28xx-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>em28xx-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   em28xx-core.c - driver for Empia EM2800/EM2820/2840 USB video capture devices</span>

<span class="cm">   Copyright (C) 2005 Ludovico Cavedon &lt;cavedon@sssup.it&gt;</span>
<span class="cm">		      Markus Rechberger &lt;mrechberger@gmail.com&gt;</span>
<span class="cm">		      Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>
<span class="cm">		      Sascha Sommer &lt;saschasommer@freenet.de&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>

<span class="cp">#include &quot;em28xx.h&quot;</span>

<span class="cm">/* #define ENABLE_DEBUG_ISOC_FRAMES */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">core_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [core]&quot;</span><span class="p">);</span>

<span class="cp">#define em28xx_coredbg(fmt, arg...) do {\</span>
<span class="cp">	if (core_debug) \</span>
<span class="cp">		printk(KERN_INFO &quot;%s %s :&quot;fmt, \</span>
<span class="cp">			 dev-&gt;name, __func__ , ##arg); } while (0)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reg_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reg_debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [URB reg]&quot;</span><span class="p">);</span>

<span class="cp">#define em28xx_regdbg(fmt, arg...) do {\</span>
<span class="cp">	if (reg_debug) \</span>
<span class="cp">		printk(KERN_INFO &quot;%s %s :&quot;fmt, \</span>
<span class="cp">			 dev-&gt;name, __func__ , ##arg); } while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">alt</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="s">&quot;alternate setting to use for video endpoint&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">disable_vbi</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_vbi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_vbi</span><span class="p">,</span> <span class="s">&quot;disable vbi support&quot;</span><span class="p">);</span>

<span class="cm">/* FIXME */</span>
<span class="cp">#define em28xx_isocdbg(fmt, arg...) do {\</span>
<span class="cp">	if (core_debug) \</span>
<span class="cp">		printk(KERN_INFO &quot;%s %s :&quot;fmt, \</span>
<span class="cp">			 dev-&gt;name, __func__ , ##arg); } while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_read_reg_req()</span>
<span class="cm"> * reads data from the usb device specifying bRequest</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_read_reg_req_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">URB_MAX_CTRL_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(pipe 0x%08x): &quot;</span>
			<span class="s">&quot;IN:  %02x %02x %02x %02x %02x %02x %02x %02x &quot;</span><span class="p">,</span>
			<span class="n">pipe</span><span class="p">,</span>
			<span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
			<span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctrl_urb_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
			      <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="mh">0x0000</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">urb_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctrl_urb_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">urb_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctrl_urb_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">byte</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">byte</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">byte</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">byte</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_read_reg_req()</span>
<span class="cm"> * reads data from the usb device specifying bRequest</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_read_reg_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_read_reg_req_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">em28xx_read_reg_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_REQ_GET_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_read_reg</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_write_regs_req()</span>
<span class="cm"> * sends data to the usb device, specifying bRequest</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_write_regs_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DEV_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">URB_MAX_CTRL_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">byte</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(pipe 0x%08x): &quot;</span>
			<span class="s">&quot;OUT: %02x %02x %02x %02x %02x %02x %02x %02x &gt;&gt;&gt;&quot;</span><span class="p">,</span>
			<span class="n">pipe</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
			<span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">byte</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">byte</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">byte</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctrl_urb_lock</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">urb_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
			      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="mh">0x0000</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">urb_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctrl_urb_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wait_after_write</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wait_after_write</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_regs_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_REQ_GET_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Stores GPO/GPIO values at the cache, if changed</span>
<span class="cm">	   Only write values should be stored, since input on a GPIO</span>
<span class="cm">	   register will return the input bits.</span>
<span class="cm">	   Not sure what happens on reading GPO register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpo_num</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpo</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpio_num</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpio</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_write_regs</span><span class="p">);</span>

<span class="cm">/* Write a single register */</span>
<span class="kt">int</span> <span class="nf">em28xx_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_write_reg</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_write_reg_bits()</span>
<span class="cm"> * sets only some bits (specified by bitmask) of a register, by first reading</span>
<span class="cm"> * the actual value</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_write_reg_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">bitmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">oldval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">newval</span><span class="p">;</span>

	<span class="cm">/* Uses cache for gpo/gpio registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpo_num</span><span class="p">)</span>
		<span class="n">oldval</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpo</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpio_num</span><span class="p">)</span>
		<span class="n">oldval</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_gpio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oldval</span> <span class="o">=</span> <span class="n">em28xx_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">oldval</span><span class="p">;</span>

	<span class="n">newval</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u8</span><span class="p">)</span> <span class="n">oldval</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bitmask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newval</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_write_reg_bits</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_is_ac97_ready()</span>
<span class="cm"> * Checks if ac97 is ready</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_is_ac97_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Wait up to 50 ms for AC97 command to complete */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R43_AC97BUSY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;AC97 command still being executed: not handled properly!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_read_ac97()</span>
<span class="cm"> * write a 16 bit value to the specified AC97 address (LSB first!)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_read_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_is_ac97_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R42_AC97ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">em28xx_read_reg_req_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EM28XX_R40_AC97LSB</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_read_ac97</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_write_ac97()</span>
<span class="cm"> * write a 16 bit value to the specified AC97 address (LSB first!)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_write_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_is_ac97_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R40_AC97LSB</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R42_AC97ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_write_ac97</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">em28xx_vol_itable</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">em28xx_amux</span> <span class="n">mux</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">em28xx_vol_itable</span> <span class="n">inputs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">EM28XX_AMUX_VIDEO</span><span class="p">,</span> 	<span class="n">AC97_VIDEO_VOL</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AMUX_LINE_IN</span><span class="p">,</span>	<span class="n">AC97_LINEIN_VOL</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AMUX_PHONE</span><span class="p">,</span>	<span class="n">AC97_PHONE_VOL</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AMUX_MIC</span><span class="p">,</span>	<span class="n">AC97_MIC_VOL</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AMUX_CD</span><span class="p">,</span>	<span class="n">AC97_CD_VOL</span>      <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AMUX_AUX</span><span class="p">,</span>	<span class="n">AC97_AUX_VOL</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AMUX_PCM_OUT</span><span class="p">,</span>	<span class="n">AC97_PCM_OUT_VOL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_ac97_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">em28xx_amux</span> <span class="n">amux</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_ainput</span><span class="p">;</span>

	<span class="cm">/* EM28XX_AMUX_VIDEO2 is a special case used to indicate that</span>
<span class="cm">	   em28xx should point to LINE IN, while AC97 should use VIDEO</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amux</span> <span class="o">==</span> <span class="n">EM28XX_AMUX_VIDEO2</span><span class="p">)</span>
		<span class="n">amux</span> <span class="o">=</span> <span class="n">EM28XX_AMUX_VIDEO</span><span class="p">;</span>

	<span class="cm">/* Mute all entres but the one that were selected */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">inputs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amux</span> <span class="o">==</span> <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mux</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;couldn&#39;t setup AC97 register %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_set_audio_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">input</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">is_em2800</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_ainput</span> <span class="o">==</span> <span class="n">EM28XX_AMUX_VIDEO</span><span class="p">)</span>
			<span class="n">input</span> <span class="o">=</span> <span class="n">EM2800_AUDIO_SRC_TUNER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">input</span> <span class="o">=</span> <span class="n">EM2800_AUDIO_SRC_LINE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM2800_R08_AUDIOSRC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">has_msp34xx</span><span class="p">)</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">EM28XX_AUDIO_SRC_TUNER</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_ainput</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EM28XX_AMUX_VIDEO</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="n">EM28XX_AUDIO_SRC_TUNER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">input</span> <span class="o">=</span> <span class="n">EM28XX_AUDIO_SRC_LINE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">mute_gpio</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">mute_gpio</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R0E_AUDIOSRC</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EM28XX_NO_AC97</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_ac97_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">em28xx_vol_otable</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">em28xx_aout</span> <span class="n">mux</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">em28xx_vol_otable</span> <span class="n">outputs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">EM28XX_AOUT_MASTER</span><span class="p">,</span> <span class="n">AC97_MASTER_VOL</span>      <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AOUT_LINE</span><span class="p">,</span>   <span class="n">AC97_LINE_LEVEL_VOL</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AOUT_MONO</span><span class="p">,</span>   <span class="n">AC97_MASTER_MONO_VOL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AOUT_LFE</span><span class="p">,</span>    <span class="n">AC97_LFE_MASTER_VOL</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">EM28XX_AOUT_SURR</span><span class="p">,</span>   <span class="n">AC97_SURR_MASTER_VOL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">em28xx_audio_analog_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">xclk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">has_audio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* It is assumed that all devices use master volume for output.</span>
<span class="cm">	   It would be possible to use also line output.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span> <span class="o">!=</span> <span class="n">EM28XX_NO_AC97</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mute all outputs */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">outputs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;couldn&#39;t setup AC97 register %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">xclk</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">xclk</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">xclk</span> <span class="o">|=</span> <span class="n">EM28XX_XCLK_AUDIO_UNMUTE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R0F_XCLK</span><span class="p">,</span> <span class="n">xclk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Selects the proper audio input */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_set_audio_source</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Sets volume */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span> <span class="o">!=</span> <span class="n">EM28XX_NO_AC97</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">vol</span><span class="p">;</span>

		<span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_POWER_DOWN_CTRL</span><span class="p">,</span> <span class="mh">0x4200</span><span class="p">);</span>
		<span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_EXT_AUD_CTRL</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">);</span>
		<span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_PCM_IN_SRATE</span><span class="p">,</span> <span class="mh">0xbb80</span><span class="p">);</span>

		<span class="cm">/* LSB: left channel - both channels with the same level */</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mh">0x1f</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/* Mute device, if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">)</span>
			<span class="n">vol</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

		<span class="cm">/* Sets volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">outputs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_aoutput</span> <span class="o">&amp;</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mux</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span>
							<span class="n">vol</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;couldn&#39;t setup AC97 register %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_aoutput</span> <span class="o">&amp;</span> <span class="n">EM28XX_AOUT_PCM_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">sel</span> <span class="o">=</span> <span class="n">ac97_return_record_select</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_aoutput</span><span class="p">);</span>

			<span class="cm">/* Use the same input for both left and right</span>
<span class="cm">			   channels */</span>
			<span class="n">sel</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

			<span class="n">em28xx_write_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_RECORD_SELECT</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_audio_analog_set</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">em28xx_audio_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vid1</span><span class="p">,</span> <span class="n">vid2</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2870</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2874</span>
		<span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM28174</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Digital only device - don&#39;t load any alsa module */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">has_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_audio_class</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_alsa_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">has_audio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* See how this device is configured */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">em28xx_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R00_CHIPCFG</span><span class="p">);</span>
	<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;Config register raw data: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Register read error?  */</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">EM28XX_CHIPCFG_AC97</span><span class="p">;</span> <span class="cm">/* Be conservative */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">EM28XX_CHIPCFG_AUDIOMASK</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The device doesn&#39;t have vendor audio at all */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_alsa_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">has_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">EM28XX_CHIPCFG_AUDIOMASK</span><span class="p">)</span> <span class="o">==</span>
		   <span class="n">EM28XX_CHIPCFG_I2S_3_SAMPRATES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;I2S Audio (3 sample rates)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">i2s_3rates</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">EM28XX_CHIPCFG_AUDIOMASK</span><span class="p">)</span> <span class="o">==</span>
		   <span class="n">EM28XX_CHIPCFG_I2S_5_SAMPRATES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;I2S Audio (5 sample rates)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">i2s_5rates</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">EM28XX_CHIPCFG_AUDIOMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EM28XX_CHIPCFG_AC97</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Skip the code that does AC97 vendor detection */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">EM28XX_NO_AC97</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_audio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">EM28XX_AC97_OTHER</span><span class="p">;</span>

	<span class="n">vid1</span> <span class="o">=</span> <span class="n">em28xx_read_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vid1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Device likely doesn&#39;t support AC97</span>
<span class="cm">		 * Note: (some) em2800 devices without eeprom reports 0x91 on</span>
<span class="cm">		 *	 CHIPCFG register, even not having an AC97 chip</span>
<span class="cm">		 */</span>
		<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;AC97 chip type couldn&#39;t be determined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">EM28XX_NO_AC97</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_alsa_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">has_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_audio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vid2</span> <span class="o">=</span> <span class="n">em28xx_read_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vid2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_audio</span><span class="p">;</span>

	<span class="n">vid</span> <span class="o">=</span> <span class="n">vid1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">vid2</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97_vendor_id</span> <span class="o">=</span> <span class="n">vid</span><span class="p">;</span>
	<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;AC97 vendor ID = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>

	<span class="n">feat</span> <span class="o">=</span> <span class="n">em28xx_read_ac97</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">feat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_audio</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97_feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">;</span>
	<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;AC97 features = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">feat</span><span class="p">);</span>

	<span class="cm">/* Try to identify what audio processor we have */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">vid</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vid</span> <span class="o">==</span> <span class="mh">0x83847650</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">feat</span> <span class="o">==</span> <span class="mh">0x6a90</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">EM28XX_AC97_EM202</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">vid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x838476</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">EM28XX_AC97_SIGMATEL</span><span class="p">;</span>

<span class="nl">init_audio:</span>
	<span class="cm">/* Reports detected AC97 processor */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EM28XX_NO_AC97</span>:
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;No AC97 audio processor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM28XX_AC97_EM202</span>:
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;Empia 202 AC97 audio processor detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM28XX_AC97_SIGMATEL</span>:
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;Sigmatel audio processor detected(stac 97%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">.</span><span class="n">ac97_vendor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM28XX_AC97_OTHER</span>:
		<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;Unknown AC97 audio processor detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">em28xx_audio_analog_set</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_audio_setup</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">em28xx_colorlevels_set_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R20_YGAIN</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>	<span class="cm">/* contrast */</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R21_YOFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* brightness */</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R22_UVGAIN</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>	<span class="cm">/* saturation */</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R23_UOFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R24_VOFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R25_SHARPNESS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R14_GAMMA</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R15_RGAIN</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R16_GGAIN</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R17_BGAIN</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R18_ROFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R19_GOFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R1A_BOFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_capture_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2874</span> <span class="o">||</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2884</span> <span class="o">||</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM28174</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The Transport Stream Enable Register moved in em2874 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM2874_R5F_TS_ENABLE</span><span class="p">,</span>
						   <span class="mh">0x00</span><span class="p">,</span>
						   <span class="n">EM2874_TS1_CAPTURE_ENABLE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable Transport Stream */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM2874_R5F_TS_ENABLE</span><span class="p">,</span>
					   <span class="n">EM2874_TS1_CAPTURE_ENABLE</span><span class="p">,</span>
					   <span class="n">EM2874_TS1_CAPTURE_ENABLE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* FIXME: which is the best order? */</span>
	<span class="cm">/* video registers are sampled by VREF */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R0C_USBSUSP</span><span class="p">,</span>
				   <span class="n">start</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable video capture */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R12_VINENABLE</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">is_webcam</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>

	<span class="cm">/* enable video capture */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EM28XX_ANALOG_MODE</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R12_VINENABLE</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R12_VINENABLE</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_vbi_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Modprobe option to manually disable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_vbi</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2860</span> <span class="o">||</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2883</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Version of em28xx that does not support VBI */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_set_outfmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vinctrl</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R27_OUTFMT</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R10_VINMODE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vinmode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vinctrl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vinctl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_vbi_supported</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vinctrl</span> <span class="o">|=</span> <span class="n">EM28XX_VINCTRL_VBI_RAW</span><span class="p">;</span>
		<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R34_VBI_START_H</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R36_VBI_WIDTH</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_width</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R37_VBI_HEIGHT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* NTSC */</span>
			<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R35_VBI_START_V</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PAL */</span>
			<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R35_VBI_START_V</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R11_VINCTRL</span><span class="p">,</span> <span class="n">vinctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_accumulator_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">u8</span> <span class="n">xmax</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ymax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">em28xx_coredbg</span><span class="p">(</span><span class="s">&quot;em28xx Scale: (%d,%d)-(%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">);</span>

	<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R28_XMIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R29_XMAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R2A_YMIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ymin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R2B_YMAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ymax</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_capture_area_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hstart</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vstart</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cwidth</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cheight</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">overflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">em28xx_coredbg</span><span class="p">(</span><span class="s">&quot;em28xx Area Set: (%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">width</span> <span class="o">|</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
			<span class="p">(</span><span class="n">height</span> <span class="o">|</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R1C_HSTART</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hstart</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R1D_VSTART</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vstart</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R1E_CWIDTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cwidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R1F_CHEIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cheight</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R1B_OFLOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">overflow</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_scaler_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">h</span><span class="p">,</span> <span class="n">u16</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
	<span class="cm">/* the em2800 scaler only supports scaling down to 50% */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">is_em2800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">h</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R30_HSCALELOW</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R32_VSCALELOW</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* it seems that both H and V scalers must be active</span>
<span class="cm">		   to work correctly */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">||</span> <span class="n">v</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x30</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R26_COMPR</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* FIXME: this only function read values from dev */</span>
<span class="kt">int</span> <span class="nf">em28xx_resolution_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">norm_maxw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">norm_maxh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Properly setup VBI */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_height</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_height</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">progressive</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">&gt;&gt;=</span> <span class="n">norm_maxh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">em28xx_set_outfmt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="n">em28xx_accumulator_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* If we don&#39;t set the start position to 2 in VBI mode, we end up</span>
<span class="cm">	   with line 20/21 being YUYV encoded instead of being in 8-bit</span>
<span class="cm">	   greyscale.  The core of the issue is that line 21 (and line 23 for</span>
<span class="cm">	   PAL WSS) are inside of active video region, and as a result they</span>
<span class="cm">	   get the pixelformatting associated with that area.  So by cropping</span>
<span class="cm">	   it out, we end up with the same format as the rest of the VBI</span>
<span class="cm">	   region */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">em28xx_vbi_supported</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">em28xx_capture_area_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">em28xx_capture_area_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">em28xx_scaler_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hscale</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vscale</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_set_alternate</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errCode</span><span class="p">,</span> <span class="n">prev_alt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * alt = 0 is used only for control messages, so, only values</span>
<span class="cm">	 * greater than 0 can be used for streaming.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">&amp;&amp;</span> <span class="n">alt</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_coredbg</span><span class="p">(</span><span class="s">&quot;alternate forced to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_alt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* When image size is bigger than a certain value,</span>
<span class="cm">	   the frame size should be increased, otherwise, only</span>
<span class="cm">	   green screen will be received.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">240</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">min_pkt_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_alt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop when the selected alt setting offers enough bandwidth */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_pkt_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* otherwise make sure that we end up with the maximum bandwidth</span>
<span class="cm">		   because the min_pkt_size equation might be wrong...</span>
<span class="cm">		*/</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">])</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">set_alt:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">!=</span> <span class="n">prev_alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_coredbg</span><span class="p">(</span><span class="s">&quot;minimum isoc packet size: %u (alt=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">min_pkt_size</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">];</span>
		<span class="n">em28xx_coredbg</span><span class="p">(</span><span class="s">&quot;setting alternate %d with wMaxPacketSize=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">);</span>
		<span class="n">errCode</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;cannot change alternate number to %d (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">,</span> <span class="n">errCode</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">errCode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_gpio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">em28xx_reg_seq</span> <span class="o">*</span><span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">EM28XX_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EM28XX_ANALOG_MODE</span><span class="p">)</span>
			<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R12_VINENABLE</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">em28xx_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R12_VINENABLE</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Send GPIO reset sequences specified at board entry */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sleep</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span>
						   <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span>
						   <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sleep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">);</span>

		<span class="n">gpio</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_gpio_set</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">em28xx_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">em28xx_mode</span> <span class="n">set_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">set_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_mode</span> <span class="o">==</span> <span class="n">EM28XX_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">set_mode</span><span class="p">;</span>

		<span class="cm">/* FIXME: add suspend support for ac97 */</span>

		<span class="k">return</span> <span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">suspend_gpio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">set_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">dvb_gpio</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">em28xx_gpio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_set_mode</span><span class="p">);</span>

<span class="cm">/* ------------------------------------------------------------------</span>
<span class="cm">	URB control</span>
<span class="cm">   ------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * IRQ callback, called by URB callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_irq_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:             <span class="cm">/* success */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:    <span class="cm">/* NAK */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:   <span class="cm">/* kill */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>            <span class="cm">/* error */</span>
		<span class="n">em28xx_isocdbg</span><span class="p">(</span><span class="s">&quot;urb completition error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy data from URB */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">isoc_copy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="cm">/* Reset urb buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_isocdbg</span><span class="p">(</span><span class="s">&quot;urb resubmit failed (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop and Deallocate URBs</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">em28xx_uninit_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">em28xx_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_usb_isoc_bufs</span> <span class="o">*</span><span class="n">isoc_bufs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">em28xx_isocdbg</span><span class="p">(</span><span class="s">&quot;em28xx: called em28xx_uninit_isoc in mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">)</span>
		<span class="n">isoc_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">digital_bufs</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">isoc_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">analog_bufs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">())</span>
				<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
					<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>

	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_bufs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">em28xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_uninit_isoc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Stop URBs</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">em28xx_stop_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_usb_isoc_bufs</span> <span class="o">*</span><span class="n">isoc_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">digital_bufs</span><span class="p">;</span>

	<span class="n">em28xx_isocdbg</span><span class="p">(</span><span class="s">&quot;em28xx: called em28xx_stop_urbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">())</span>
				<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">em28xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_stop_urbs</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate URBs</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_alloc_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">em28xx_mode</span> <span class="n">mode</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">max_packets</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_pkt_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_usb_isoc_bufs</span> <span class="o">*</span><span class="n">isoc_bufs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sb_size</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">em28xx_isocdbg</span><span class="p">(</span><span class="s">&quot;em28xx: called em28xx_alloc_isoc in mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">)</span>
		<span class="n">isoc_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">digital_bufs</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">isoc_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">analog_bufs</span><span class="p">;</span>

	<span class="cm">/* De-allocates all pending stuff */</span>
	<span class="n">em28xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_bufs</span> <span class="o">=</span> <span class="n">num_bufs</span><span class="p">;</span>

	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">num_bufs</span><span class="p">,</span>  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;cannot alloc memory for usb buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">num_bufs</span><span class="p">,</span>
					     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;cannot allocate memory for usb transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span> <span class="o">=</span> <span class="n">max_pkt_size</span><span class="p">;</span>
	<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_packets</span> <span class="o">=</span> <span class="n">max_packets</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">vid_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">vbi_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sb_size</span> <span class="o">=</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_packets</span> <span class="o">*</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">;</span>

	<span class="cm">/* allocate urbs and transfer buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_packets</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">em28xx_err</span><span class="p">(</span><span class="s">&quot;cannot alloc isoc_ctl.urb %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">em28xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>

		<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">sb_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">em28xx_err</span><span class="p">(</span><span class="s">&quot;unable to allocate %i bytes for transfer&quot;</span>
					<span class="s">&quot; buffer %i%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sb_size</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">in_interrupt</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot; while in int&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">em28xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sb_size</span><span class="p">);</span>

		<span class="cm">/* FIXME: this is a hack - should be</span>
<span class="cm">			&#39;desc.bEndpointAddress &amp; USB_ENDPOINT_NUMBER_MASK&#39;</span>
<span class="cm">			should also be using &#39;desc.bInterval&#39;</span>
<span class="cm">		 */</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				       <span class="n">mode</span> <span class="o">==</span> <span class="n">EM28XX_ANALOG_MODE</span> <span class="o">?</span>
				       <span class="n">EM28XX_EP_ANALOG</span> <span class="o">:</span> <span class="n">EM28XX_EP_DIGITAL</span><span class="p">);</span>

		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				 <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sb_size</span><span class="p">,</span>
				 <span class="n">em28xx_irq_callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_packets</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span> <span class="o">|</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

		<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_packets</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
						<span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">;</span>
			<span class="n">k</span> <span class="o">+=</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">max_pkt_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_alloc_isoc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate URBs and start IRQ</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">em28xx_init_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">em28xx_mode</span> <span class="n">mode</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">max_packets</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_pkt_size</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">isoc_copy</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_dmaqueue</span> <span class="o">*</span><span class="n">dma_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vidq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_dmaqueue</span> <span class="o">*</span><span class="n">vbi_dma_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbiq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_usb_isoc_bufs</span> <span class="o">*</span><span class="n">isoc_bufs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alloc</span><span class="p">;</span>

	<span class="n">em28xx_isocdbg</span><span class="p">(</span><span class="s">&quot;em28xx: called em28xx_init_isoc in mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">isoc_copy</span> <span class="o">=</span> <span class="n">isoc_copy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EM28XX_DIGITAL_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isoc_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">digital_bufs</span><span class="p">;</span>
		<span class="cm">/* no need to free/alloc isoc buffers in digital mode */</span>
		<span class="n">alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">isoc_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_ctl</span><span class="p">.</span><span class="n">analog_bufs</span><span class="p">;</span>
		<span class="n">alloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em28xx_alloc_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">max_packets</span><span class="p">,</span>
				       <span class="n">num_bufs</span><span class="p">,</span> <span class="n">max_pkt_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vbi_dma_q</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="n">em28xx_capture_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* submit urbs and enables IRQ */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">num_bufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">isoc_bufs</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">em28xx_err</span><span class="p">(</span><span class="s">&quot;submit of urb %i failed (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">);</span>
			<span class="n">em28xx_uninit_isoc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">em28xx_init_isoc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * em28xx_wake_i2c()</span>
<span class="cm"> * configure i2c attached devices</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">em28xx_wake_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span>  <span class="n">reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span>
			<span class="n">INPUT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmux</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Device control list</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">em28xx_devlist</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Extension interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">em28xx_extension_devlist</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">em28xx_register_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_extension_devlist</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Em28xx: Initialized (%s) extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">em28xx_register_extension</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">em28xx_unregister_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Em28xx: Removed (%s) extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">em28xx_unregister_extension</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">em28xx_init_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">em28xx_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_devlist</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_extension_devlist</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">em28xx_close_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">em28xx_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em28xx_extension_devlist</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em28xx_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
