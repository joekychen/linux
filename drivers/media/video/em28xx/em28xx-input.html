<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › em28xx › em28xx-input.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>em28xx-input.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  handle em28xx IR remotes via linux kernel input layer.</span>

<span class="cm">   Copyright (C) 2005 Ludovico Cavedon &lt;cavedon@sssup.it&gt;</span>
<span class="cm">		      Markus Rechberger &lt;mrechberger@gmail.com&gt;</span>
<span class="cm">		      Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>
<span class="cm">		      Sascha Sommer &lt;saschasommer@freenet.de&gt;</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;em28xx.h&quot;</span>

<span class="cp">#define EM28XX_SNAPSHOT_KEY KEY_CAMERA</span>
<span class="cp">#define EM28XX_SBUTTON_QUERY_INTERVAL 500</span>
<span class="cp">#define EM28XX_R0C_USBSUSP_SNAPSHOT 0x20</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ir_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [IR]&quot;</span><span class="p">);</span>

<span class="cp">#define MODULE_NAME &quot;em28xx&quot;</span>

<span class="cp">#define i2cdprintk(fmt, arg...) \</span>
<span class="cp">	if (ir_debug) { \</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s/ir: &quot; fmt, ir-&gt;name , ## arg); \</span>
<span class="cp">	}</span>

<span class="cp">#define dprintk(fmt, arg...) \</span>
<span class="cp">	if (ir_debug) { \</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s/ir: &quot; fmt, ir-&gt;name , ## arg); \</span>
<span class="cp">	}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> Polling structure used by em28xx IR&#39;s</span>
<span class="cm"> **********************************************************/</span>

<span class="k">struct</span> <span class="n">em28xx_ir_poll_result</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">toggle_bit</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_count</span><span class="o">:</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="cm">/* 1 byte on em2860/2880, 4 on em2874 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* poll external decoder */</span>
	<span class="kt">int</span> <span class="n">polling</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">full_code</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_readcount</span><span class="p">;</span>

	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">get_key</span><span class="p">)(</span><span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">em28xx_ir_poll_result</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> I2C IR based get keycodes - should be used with ir-kbd-i2c</span>
<span class="cm"> **********************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_get_key_terratec</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>

	<span class="cm">/* poll IR chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* it seems that 0xFE indicates that a button is still hold</span>
<span class="cm">	   down, while 0xff indicates that no button is hold</span>
<span class="cm">	   down. 0xfe sequences are sometimes interrupted by 0xFF */</span>

	<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;key %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
		<span class="cm">/* keep old data */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_get_key_em_haup</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* poll IR chip */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Does eliminate repeated parity code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">old</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rearranges bits to the right order.</span>
<span class="cm">	 * The bit order were determined experimentally by using</span>
<span class="cm">	 * The original Hauppauge Grey IR and another RC5 that uses addr=0x08</span>
<span class="cm">	 * The RC5 code has 14 bits, but we&#39;ve experimentally determined</span>
<span class="cm">	 * the meaning for only 11 bits.</span>
<span class="cm">	 * So, the code translation is not complete. Yet, it is enough to</span>
<span class="cm">	 * work with the provided RC5 IR.</span>
<span class="cm">	 */</span>
	<span class="n">code</span> <span class="o">=</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0020</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 		0010 0000 */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0010</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 		0001 0000 */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0008</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 		0000 1000 */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0004</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 		0000 0100 */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0002</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 		0000 0010 */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0001</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 		0000 0001 */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 0001 0000		  */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0800</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 0000 1000		  */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0400</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 0000 0100		  */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0200</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 0000 0010		  */</span>
		 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* 0000 0001		  */</span>

	<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;ir hauppauge (em2840): code=0x%02x (rcv=0x%02x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">code</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* return key */</span>
	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_get_key_pinnacle_usb_grey</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* poll IR chip */</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">3</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;key %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_get_key_winfast_usbii_deluxe</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span>
					<span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">subaddr</span><span class="p">,</span> <span class="n">keydetect</span><span class="p">,</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">subaddr</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>

				<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">keydetect</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span> <span class="p">};</span>

	<span class="n">subaddr</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keydetect</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">subaddr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> Poll based get keycode functions</span>
<span class="cm"> **********************************************************/</span>

<span class="cm">/* This is for the em2860/em2880 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">default_polling_getkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">em28xx_ir_poll_result</span> <span class="o">*</span><span class="n">poll_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="cm">/* Read key toggle, brand, and key code</span>
<span class="cm">	   on registers 0x45, 0x46 and 0x47</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">em28xx_read_reg_req_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EM28XX_R45_IR</span><span class="p">,</span>
					  <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Infrared toggle (Reg 0x45[7]) */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">toggle_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="cm">/* Infrared read count (Reg 0x45[6:0] */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">read_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="cm">/* Remote Control Address (Reg 0x46) */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">rc_address</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Remote Control Data (Reg 0x47) */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em2874_polling_getkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">em28xx_ir_poll_result</span> <span class="o">*</span><span class="n">poll_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="cm">/* Read key toggle, brand, and key code</span>
<span class="cm">	   on registers 0x51-55</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">em28xx_read_reg_req_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EM2874_R51_IR</span><span class="p">,</span>
					  <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Infrared toggle (Reg 0x51[7]) */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">toggle_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="cm">/* Infrared read count (Reg 0x51[6:0] */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">read_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="cm">/* Remote Control Address (Reg 0x52) */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">rc_address</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Remote Control Data (Reg 0x53-55) */</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">poll_result</span><span class="o">-&gt;</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> Polling code for em28xx</span>
<span class="cm"> **********************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_ir_handle_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_ir_poll_result</span> <span class="n">poll_result</span><span class="p">;</span>

	<span class="cm">/* read the registers containing the IR status */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">poll_result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ir-&gt;get_key() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">poll_result</span><span class="p">.</span><span class="n">read_count</span> <span class="o">!=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">last_readcount</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: toggle: %d, count: %d, key 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">poll_result</span><span class="p">.</span><span class="n">toggle_bit</span><span class="p">,</span> <span class="n">poll_result</span><span class="p">.</span><span class="n">read_count</span><span class="p">,</span>
			<span class="n">poll_result</span><span class="p">.</span><span class="n">rc_address</span><span class="p">,</span> <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">full_code</span><span class="p">)</span>
			<span class="n">rc_keydown</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span>
				   <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_address</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
				   <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="n">poll_result</span><span class="p">.</span><span class="n">toggle_bit</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc_keydown</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span>
				   <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="n">poll_result</span><span class="p">.</span><span class="n">toggle_bit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2874</span> <span class="o">||</span>
		    <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_EM2884</span><span class="p">)</span>
			<span class="cm">/* The em2874 clears the readcount field every time the</span>
<span class="cm">			   register is read.  The em2860/2880 datasheet says that it</span>
<span class="cm">			   is supposed to clear the readcount, but it doesn&#39;t.  So with</span>
<span class="cm">			   the em2874, we are looking for a non-zero read count as</span>
<span class="cm">			   opposed to a readcount that is incrementing */</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">last_readcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">last_readcount</span> <span class="o">=</span> <span class="n">poll_result</span><span class="p">.</span><span class="n">read_count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_ir_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">em28xx_IR</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">em28xx_ir_handle_key</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_ir_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">em28xx_ir_work</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_ir_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">em28xx_ir_change_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc_dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rc_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc_dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ir_config</span> <span class="o">=</span> <span class="n">EM2874_IR_RC5</span><span class="p">;</span>

	<span class="cm">/* Adjust xclk based o IR table for RC5/NEC tables */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_RC5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">xclk</span> <span class="o">|=</span> <span class="n">EM28XX_XCLK_IR_RC5_MODE</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">full_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_NEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">xclk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EM28XX_XCLK_IR_RC5_MODE</span><span class="p">;</span>
		<span class="n">ir_config</span> <span class="o">=</span> <span class="n">EM2874_IR_NEC</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">full_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">!=</span> <span class="n">RC_TYPE_UNKNOWN</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">em28xx_write_reg_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R0F_XCLK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">xclk</span><span class="p">,</span>
			      <span class="n">EM28XX_XCLK_IR_RC5_MODE</span><span class="p">);</span>

	<span class="cm">/* Setup the proper handler based on the chip */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_ID_EM2860</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_EM2883</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">default_polling_getkey</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_ID_EM2884</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_EM2874</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_EM28174</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">em2874_polling_getkey</span><span class="p">;</span>
		<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM2874_R50_IR_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir_config</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unrecognized em28xx chip id 0x%02x: IR not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_register_i2c_ir</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Leadtek winfast tv USBII deluxe can find a non working IR-device */</span>
	<span class="cm">/* at address 0x18, so if that address is needed for another board in */</span>
	<span class="cm">/* the future, please put it after 0x1f. */</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span>
	<span class="p">};</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;ir_video&quot;</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="cm">/* detect &amp; configure */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EM2800_BOARD_TERRATEC_CINERGY_200</span>:
	<span class="k">case</span> <span class="n">EM2820_BOARD_TERRATEC_CINERGY_250</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_EM_TERRATEC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">em28xx_get_key_terratec</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i2c IR (EM28XX Terratec)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2820_BOARD_PINNACLE_USB_2</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_PINNACLE_GREY</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">em28xx_get_key_pinnacle_usb_grey</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i2c IR (EM28XX Pinnacle PCTV)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2820_BOARD_HAUPPAUGE_WINTV_USB_2</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">em28xx_get_key_em_haup</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i2c IR (EM2840 Hauppauge)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EM2820_BOARD_LEADTEK_WINFAST_USBII_DELUXE</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_WINFAST_USBII_DELUXE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">em28xx_get_key_winfast_usbii_deluxe</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i2c IR (EM2820 Winfast TV USBII Deluxe)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">;</span>
	<span class="n">i2c_new_probed_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">addr_list</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> Handle Webcam snapshot button</span>
<span class="cm"> **********************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_query_sbutton</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Poll the register and see if the button is depressed */</span>
	<span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">em28xx</span><span class="p">,</span> <span class="n">sbutton_query_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">em28xx_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R0C_USBSUSP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">EM28XX_R0C_USBSUSP_SNAPSHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">cleared</span><span class="p">;</span>
		<span class="cm">/* Button is depressed, clear the register */</span>
		<span class="n">cleared</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">ret</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EM28XX_R0C_USBSUSP_SNAPSHOT</span><span class="p">;</span>
		<span class="n">em28xx_write_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EM28XX_R0C_USBSUSP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cleared</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Not emulate the keypress */</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_input_dev</span><span class="p">,</span> <span class="n">EM28XX_SNAPSHOT_KEY</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Now unpress the key */</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_input_dev</span><span class="p">,</span> <span class="n">EM28XX_SNAPSHOT_KEY</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Schedule next poll */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_query_work</span><span class="p">,</span>
			      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">EM28XX_SBUTTON_QUERY_INTERVAL</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_register_snapshot_button</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;Registering snapshot button...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;input_allocate_device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">snapshot_button_path</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snapshot_button_path</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snapshot_button_path</span><span class="p">,</span> <span class="s">&quot;/sbutton&quot;</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snapshot_button_path</span><span class="p">));</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_query_work</span><span class="p">,</span> <span class="n">em28xx_query_sbutton</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;em28xx snapshot button&quot;</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">snapshot_button_path</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">EM28XX_SNAPSHOT_KEY</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodemax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_USB</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_errdev</span><span class="p">(</span><span class="s">&quot;input_register_device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_input_dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_query_work</span><span class="p">,</span>
			      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">EM28XX_SBUTTON_QUERY_INTERVAL</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em28xx_deregister_snapshot_button</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_input_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">em28xx_info</span><span class="p">(</span><span class="s">&quot;Deregistering snapshot button</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_query_work</span><span class="p">);</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_input_dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbutton_input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_ir_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No remote control support */</span>
		<span class="n">em28xx_warn</span><span class="p">(</span><span class="s">&quot;Remote control support is not available for &quot;</span>
				<span class="s">&quot;this card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ir</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span> <span class="o">||</span> <span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>

	<span class="cm">/* record handles to ourself */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="n">ir</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * em2874 supports more protocols. For now, let&#39;s just announce</span>
<span class="cm">	 * the two protocols that were already tested</span>
<span class="cm">	 */</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_RC5</span> <span class="o">|</span> <span class="n">RC_TYPE_NEC</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ir</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">change_protocol</span> <span class="o">=</span> <span class="n">em28xx_ir_change_protocol</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">em28xx_ir_start</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">em28xx_ir_stop</span><span class="p">;</span>

	<span class="cm">/* By default, keep protocol field untouched */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">em28xx_ir_change_protocol</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">RC_TYPE_UNKNOWN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>

	<span class="cm">/* This is how often we ask the chip for IR information */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* ms */</span>

	<span class="cm">/* init input device */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;em28xx IR (%s)&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_USB</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">ir_codes</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">;</span>

	<span class="cm">/* all done */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_stop</span><span class="p">;</span>

	<span class="n">em28xx_register_i2c_ir</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_MODULES) &amp;&amp; defined(MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">has_ir_i2c</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;ir-kbd-i2c&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">has_snapshot_button</span><span class="p">)</span>
		<span class="n">em28xx_register_snapshot_button</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_out_stop:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">err_out_free:</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em28xx_ir_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">em28xx</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">em28xx_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>

	<span class="n">em28xx_deregister_snapshot_button</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* skip detach on non attached boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* done */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">em28xx_ops</span> <span class="n">rc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>   <span class="o">=</span> <span class="n">EM28XX_RC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Em28xx Input Extension&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">em28xx_ir_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fini</span> <span class="o">=</span> <span class="n">em28xx_ir_fini</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">em28xx_rc_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">em28xx_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">em28xx_rc_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">em28xx_unregister_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mauro Carvalho Chehab &lt;mchehab@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Em28xx Input driver&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">em28xx_rc_register</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">em28xx_rc_unregister</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
