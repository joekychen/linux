<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › tvp7002.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tvp7002.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Texas Instruments Triple 8-/10-BIT 165-/110-MSPS Video and Graphics</span>
<span class="cm"> * Digitizer with Horizontal PLL registers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments Inc</span>
<span class="cm"> * Author: Santiago Nunez-Corrales &lt;santiago.nunez@ridgerun.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This code is partially based upon the TVP5150 driver</span>
<span class="cm"> * written by Mauro Carvalho Chehab (mchehab@infradead.org),</span>
<span class="cm"> * the TVP514x driver written by Vaibhav Hiremath &lt;hvaibhav@ti.com&gt;</span>
<span class="cm"> * and the TVP7002 driver in the TI LSP 2.10.00.14. Revisions by</span>
<span class="cm"> * Muralidharan Karicheri and Snehaprabha Narnakaje (TI).</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-dv-timings.h&gt;</span>
<span class="cp">#include &lt;media/tvp7002.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &quot;tvp7002_reg.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TI TVP7002 Video and Graphics Digitizer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Santiago Nunez-Corrales &lt;santiago.nunez@ridgerun.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* Module Name */</span>
<span class="cp">#define TVP7002_MODULE_NAME	&quot;tvp7002&quot;</span>

<span class="cm">/* I2C retry attempts */</span>
<span class="cp">#define I2C_RETRY_COUNT		(5)</span>

<span class="cm">/* End of registers */</span>
<span class="cp">#define TVP7002_EOR		0x5c</span>

<span class="cm">/* Read write definition for registers */</span>
<span class="cp">#define TVP7002_READ		0</span>
<span class="cp">#define TVP7002_WRITE		1</span>
<span class="cp">#define TVP7002_RESERVED	2</span>

<span class="cm">/* Interlaced vs progressive mask and shift */</span>
<span class="cp">#define TVP7002_IP_SHIFT	5</span>
<span class="cp">#define TVP7002_INPR_MASK	(0x01 &lt;&lt; TVP7002_IP_SHIFT)</span>

<span class="cm">/* Shift for CPL and LPF registers */</span>
<span class="cp">#define TVP7002_CL_SHIFT	8</span>
<span class="cp">#define TVP7002_CL_MASK		0x0f</span>

<span class="cm">/* Debug functions */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-2)&quot;</span><span class="p">);</span>

<span class="cm">/* Structure for register values */</span>
<span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Register default values (according to tvp7002 datasheet)</span>
<span class="cm"> * In the case of read-only registers, the value (0xff) is</span>
<span class="cm"> * never written. R/W functionality is controlled by the</span>
<span class="cm"> * writable bit in the register struct definition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_init_default</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_CHIP_REV</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PHASE_SEL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HSYNC_OUT_W</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_B_FINE_GAIN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_G_FINE_GAIN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_R_FINE_GAIN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_B_FINE_OFF_MSBS</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_G_FINE_OFF_MSBS</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_R_FINE_OFF_MSBS</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_SYNC_CTL_1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_AND_CLAMP_CTL</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_SYNC_ON_G_THRS</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_SYNC_SEPARATOR_THRS</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_SYNC_DETECT_STAT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_OUT_FORMATTER</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_MISC_CTL_1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_MISC_CTL_2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_MISC_CTL_3</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_IN_MUX_SEL_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_IN_MUX_SEL_2</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_B_AND_G_COARSE_GAIN</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_R_COARSE_GAIN</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_FINE_OFF_LSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_B_COARSE_OFF</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_G_COARSE_OFF</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_R_COARSE_OFF</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HSOUT_OUT_START</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_MISC_CTL_4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_B_DGTL_ALC_OUT_LSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_G_DGTL_ALC_OUT_LSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_R_DGTL_ALC_OUT_LSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AUTO_LVL_CTL_ENABLE</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_DGTL_ALC_OUT_MSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AUTO_LVL_CTL_FILTER</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_FINE_CLAMP_CTL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="cm">/* PWR_CTL is controlled only by the probe and reset functions */</span>
	<span class="p">{</span> <span class="n">TVP7002_PWR_CTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ADC_SETUP</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_COARSE_CLAMP_CTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_SOG_CLAMP</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_RGB_COARSE_CLAMP_CTL</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_SOG_COARSE_CLAMP_CTL</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_MVIS_STRIPPER_W</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VSYNC_ALGN</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_SYNC_BYPASS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_L_FRAME_STAT_LSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_L_FRAME_STAT_MSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLK_L_STAT_LSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLK_L_STAT_MSBS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HSYNC_W</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VSYNC_W</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_READ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_L_LENGTH_TOL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VIDEO_BWTH_CTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_FBIT_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_FBIT_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_Y_G_COEF_LSBS</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_Y_G_COEF_MSBS</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_Y_B_COEF_LSBS</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_Y_B_COEF_MSBS</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_Y_R_COEF_LSBS</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_Y_R_COEF_MSBS</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_U_G_COEF_LSBS</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_U_G_COEF_MSBS</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_U_B_COEF_LSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_U_B_COEF_MSBS</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_U_R_COEF_LSBS</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_U_R_COEF_MSBS</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_V_G_COEF_LSBS</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_V_G_COEF_MSBS</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_V_B_COEF_LSBS</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_V_B_COEF_MSBS</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_V_R_COEF_LSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_YUV_V_R_COEF_MSBS</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="cm">/* This signals end of register values */</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Register parameters for 480P */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_parms_480P</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Register parameters for 576P */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_parms_576P</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Register parameters for 1080I60 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_parms_1080I60</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Register parameters for 1080P60 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_parms_1080P60</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Register parameters for 1080I50 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_parms_1080I50</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Register parameters for 720P60 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_parms_720P60</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Register parameters for 720P50 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp7002_parms_720P50</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_MSBS</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_FDBK_DIV_LSBS</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_CRTL</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_START_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_LSBS</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_AVID_STOP_PIXEL_MSBS</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_START_L_OFF</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_START_L_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_0_DURATION</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_VBLK_F_1_DURATION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_ALC_PLACEMENT</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_START</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_CLAMP_W</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_PRE_COAST</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_HPLL_POST_COAST</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP7002_WRITE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVP7002_EOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TVP7002_RESERVED</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Preset definition for handling device operation */</span>
<span class="k">struct</span> <span class="n">tvp7002_preset_definition</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">preset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_dv_timings</span> <span class="n">timings</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="o">*</span><span class="n">p_settings</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_colorspace</span> <span class="n">color_space</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">scanmode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">progressive</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lines_per_frame</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cpl_min</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cpl_max</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Struct list for digital video presets */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tvp7002_preset_definition</span> <span class="n">tvp7002_presets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">V4L2_DV_720P60</span><span class="p">,</span>
		<span class="n">V4L2_DV_BT_CEA_1280X720P60</span><span class="p">,</span>
		<span class="n">tvp7002_parms_720P60</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_REC709</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="mh">0x2EE</span><span class="p">,</span>
		<span class="mi">135</span><span class="p">,</span>
		<span class="mi">153</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">V4L2_DV_1080I60</span><span class="p">,</span>
		<span class="n">V4L2_DV_BT_CEA_1920X1080I60</span><span class="p">,</span>
		<span class="n">tvp7002_parms_1080I60</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_REC709</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mh">0x465</span><span class="p">,</span>
		<span class="mi">181</span><span class="p">,</span>
		<span class="mi">205</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">V4L2_DV_1080I50</span><span class="p">,</span>
		<span class="n">V4L2_DV_BT_CEA_1920X1080I50</span><span class="p">,</span>
		<span class="n">tvp7002_parms_1080I50</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_REC709</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mh">0x465</span><span class="p">,</span>
		<span class="mi">217</span><span class="p">,</span>
		<span class="mi">245</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">V4L2_DV_720P50</span><span class="p">,</span>
		<span class="n">V4L2_DV_BT_CEA_1280X720P50</span><span class="p">,</span>
		<span class="n">tvp7002_parms_720P50</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_REC709</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="mh">0x2EE</span><span class="p">,</span>
		<span class="mi">163</span><span class="p">,</span>
		<span class="mi">183</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">V4L2_DV_1080P60</span><span class="p">,</span>
		<span class="n">V4L2_DV_BT_CEA_1920X1080P60</span><span class="p">,</span>
		<span class="n">tvp7002_parms_1080P60</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_REC709</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="mh">0x465</span><span class="p">,</span>
		<span class="mi">90</span><span class="p">,</span>
		<span class="mi">102</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">V4L2_DV_480P59_94</span><span class="p">,</span>
		<span class="n">V4L2_DV_BT_CEA_720X480P59_94</span><span class="p">,</span>
		<span class="n">tvp7002_parms_480P</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="mh">0x20D</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">V4L2_DV_576P50</span><span class="p">,</span>
		<span class="n">V4L2_DV_BT_CEA_720X576P50</span><span class="p">,</span>
		<span class="n">tvp7002_parms_576P</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="mh">0x271</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NUM_PRESETS	ARRAY_SIZE(tvp7002_presets)</span>

<span class="cm">/* Device definition */</span>
<span class="k">struct</span> <span class="n">tvp7002</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tvp7002_config</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">streaming</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">tvp7002_preset_definition</span> <span class="o">*</span><span class="n">current_preset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * to_tvp7002 - Obtain device handler TVP7002</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns device handler tvp7002.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="nf">to_tvp7002</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tvp7002</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">to_sd</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tvp7002</span><span class="p">,</span> <span class="n">hdl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_read - Read a value from a register in an TVP7002</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> * @addr: TVP7002 register address</span>
<span class="cm"> * @dst: pointer to 8-bit destination</span>
<span class="cm"> *</span>
<span class="cm"> * Returns value read if successful, or non-zero (-1) otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="n">I2C_RETRY_COUNT</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">error</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;TVP7002 read error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_read_err() - Read a register value with error code</span>
<span class="cm"> * @sd: pointer to standard V4L2 sub-device structure</span>
<span class="cm"> * @reg: destination register</span>
<span class="cm"> * @val: value to be read</span>
<span class="cm"> * @err: pointer to error value</span>
<span class="cm"> *</span>
<span class="cm"> * Read a value in a register and save error value in pointer.</span>
<span class="cm"> * Also update the register table if successful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tvp7002_read_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
							<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">err</span><span class="p">)</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">tvp7002_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_write() - Write a value to a register in TVP7002</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> * @addr: TVP7002 register address</span>
<span class="cm"> * @value: value to be written to the register</span>
<span class="cm"> *</span>
<span class="cm"> * Write a value to a register in an TVP7002 decoder device.</span>
<span class="cm"> * Returns zero if successful, or non-zero otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="n">I2C_RETRY_COUNT</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Write: retry ... %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="p">);</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;TVP7002 write error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_write_err() - Write a register value with error code</span>
<span class="cm"> * @sd: pointer to standard V4L2 sub-device structure</span>
<span class="cm"> * @reg: destination register</span>
<span class="cm"> * @val: value to be written</span>
<span class="cm"> * @err: pointer to error value</span>
<span class="cm"> *</span>
<span class="cm"> * Write a value in a register and save error value in pointer.</span>
<span class="cm"> * Also update the register table if successful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tvp7002_write_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
							<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">err</span><span class="p">)</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">tvp7002_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_g_chip_ident() - Get chip identification number</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> * @chip: ptr to v4l2_dbg_chip_ident struct</span>
<span class="cm"> *</span>
<span class="cm"> * Obtains the chip&#39;s identification number.</span>
<span class="cm"> * Returns zero or -EINVAL if read operation fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_CHIP_REV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_chip_ident_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_IDENT_TVP7002</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_write_inittab() - Write initialization values</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> * @regs: ptr to i2c_reg_value struct</span>
<span class="cm"> *</span>
<span class="cm"> * Write initialization values.</span>
<span class="cm"> * Returns zero or -EINVAL if read operation fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_write_inittab</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize the first (defined) registers */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">TVP7002_EOR</span> <span class="o">!=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TVP7002_WRITE</span> <span class="o">==</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
			<span class="n">tvp7002_write_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
		<span class="n">regs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_s_dv_preset() - Set digital video preset</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> * @dv_preset: ptr to v4l2_dv_preset struct</span>
<span class="cm"> *</span>
<span class="cm"> * Set the digital video preset for a TVP7002 decoder device.</span>
<span class="cm"> * Returns zero when successful or -EINVAL if register access fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_s_dv_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="o">*</span><span class="n">dv_preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_tvp7002</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">preset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PRESETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">preset</span> <span class="o">=</span> <span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">preset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">preset</span> <span class="o">==</span> <span class="n">dv_preset</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">return</span> <span class="n">tvp7002_write_inittab</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_settings</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_s_dv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dv_timings</span> <span class="o">*</span><span class="n">dv_timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_tvp7002</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_bt_timings</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dv_timings</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dv_timings</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_DV_BT_656_1120</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PRESETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_bt_timings</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timings</span><span class="p">.</span><span class="n">bt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">standards</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">return</span> <span class="n">tvp7002_write_inittab</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_settings</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_g_dv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dv_timings</span> <span class="o">*</span><span class="n">dv_timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_tvp7002</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="o">*</span><span class="n">dv_timings</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_s_ctrl() - Set a control</span>
<span class="cm"> * @ctrl: ptr to v4l2_ctrl struct</span>
<span class="cm"> *</span>
<span class="cm"> * Set a control in TVP7002 decoder device.</span>
<span class="cm"> * Returns zero when successful or -EINVAL if register access fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_GAIN</span>:
		<span class="n">tvp7002_write_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_R_FINE_GAIN</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
		<span class="n">tvp7002_write_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_G_FINE_GAIN</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
		<span class="n">tvp7002_write_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_B_FINE_GAIN</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_mbus_fmt() - V4L2 decoder interface handler for try/s/g_mbus_fmt</span>
<span class="cm"> * @sd: pointer to standard V4L2 sub-device structure</span>
<span class="cm"> * @f: pointer to mediabus format structure</span>
<span class="cm"> *</span>
<span class="cm"> * Negotiate the image capture size and mediabus format.</span>
<span class="cm"> * There is only one possible format, so this single function works for</span>
<span class="cm"> * get, set and try.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_mbus_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_tvp7002</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_dv_enum_preset</span> <span class="n">e_preset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Calculate height and width based on current standard */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">v4l_fill_dv_preset_info</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e_preset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV10_1X20</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span><span class="o">-&gt;</span><span class="n">scanmode</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span><span class="o">-&gt;</span><span class="n">color_space</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;MBUS_FMT: Width - %d, Height - %d&quot;</span><span class="p">,</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_query_dv_preset() - query DV preset</span>
<span class="cm"> * @sd: pointer to standard V4L2 sub-device structure</span>
<span class="cm"> * @qpreset: standard V4L2 v4l2_dv_preset structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the current DV preset by TVP7002. If no active input is</span>
<span class="cm"> * detected, returns -EINVAL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_query_dv</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tvp7002_preset_definition</span> <span class="o">*</span><span class="n">presets</span> <span class="o">=</span> <span class="n">tvp7002_presets</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">progressive</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lpfr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cpln</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lpf_lsb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lpf_msb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cpl_lsb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cpl_msb</span><span class="p">;</span>

	<span class="cm">/* Return invalid index if no active input is detected */</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">NUM_PRESETS</span><span class="p">;</span>

	<span class="cm">/* Read standards from device registers */</span>
	<span class="n">tvp7002_read_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_L_FRAME_STAT_LSBS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpf_lsb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">tvp7002_read_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_L_FRAME_STAT_MSBS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpf_msb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">tvp7002_read_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_CLK_L_STAT_LSBS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpl_lsb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">tvp7002_read_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_CLK_L_STAT_MSBS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpl_msb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Get lines per frame, clocks per line and interlaced/progresive */</span>
	<span class="n">lpfr</span> <span class="o">=</span> <span class="n">lpf_lsb</span> <span class="o">|</span> <span class="p">((</span><span class="n">TVP7002_CL_MASK</span> <span class="o">&amp;</span> <span class="n">lpf_msb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TVP7002_CL_SHIFT</span><span class="p">);</span>
	<span class="n">cpln</span> <span class="o">=</span> <span class="n">cpl_lsb</span> <span class="o">|</span> <span class="p">((</span><span class="n">TVP7002_CL_MASK</span> <span class="o">&amp;</span> <span class="n">cpl_msb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TVP7002_CL_SHIFT</span><span class="p">);</span>
	<span class="n">progressive</span> <span class="o">=</span> <span class="p">(</span><span class="n">lpf_msb</span> <span class="o">&amp;</span> <span class="n">TVP7002_INPR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TVP7002_IP_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Do checking of video modes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">NUM_PRESETS</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">index</span><span class="p">)</span><span class="o">++</span><span class="p">,</span> <span class="n">presets</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfr</span> <span class="o">==</span> <span class="n">presets</span><span class="o">-&gt;</span><span class="n">lines_per_frame</span> <span class="o">&amp;&amp;</span>
			<span class="n">progressive</span> <span class="o">==</span> <span class="n">presets</span><span class="o">-&gt;</span><span class="n">progressive</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">presets</span><span class="o">-&gt;</span><span class="n">cpl_min</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpln</span> <span class="o">&gt;=</span> <span class="n">presets</span><span class="o">-&gt;</span><span class="n">cpl_min</span> <span class="o">&amp;&amp;</span> <span class="n">cpln</span> <span class="o">&lt;=</span> <span class="n">presets</span><span class="o">-&gt;</span><span class="n">cpl_max</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">index</span> <span class="o">==</span> <span class="n">NUM_PRESETS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;detection failed: lpf = %x, cpl = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">lpfr</span><span class="p">,</span> <span class="n">cpln</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update lines per frame and clocks per line info */</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;detected preset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">index</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_query_dv_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="o">*</span><span class="n">qpreset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">tvp7002_query_dv</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">index</span> <span class="o">==</span> <span class="n">NUM_PRESETS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qpreset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">=</span> <span class="n">V4L2_DV_INVALID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qpreset</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">=</span> <span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">preset</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_query_dv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dv_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">tvp7002_query_dv</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">timings</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * tvp7002_g_register() - Get the value of a register</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> * @reg: ptr to v4l2_dbg_register struct</span>
<span class="cm"> *</span>
<span class="cm"> * Get the value of a TVP7002 decoder device register.</span>
<span class="cm"> * Returns zero when successful, -EINVAL if register read fails or</span>
<span class="cm"> * access to I2C client fails, -EPERM if the call is not allowed</span>
<span class="cm"> * by disabled CAP_SYS_ADMIN.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tvp7002_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_s_register() - set a control</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> * @reg: ptr to v4l2_dbg_register struct</span>
<span class="cm"> *</span>
<span class="cm"> * Get the value of a TVP7002 decoder device register.</span>
<span class="cm"> * Returns zero when successful, -EINVAL if register read fails or</span>
<span class="cm"> * -EPERM if call not allowed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tvp7002_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_enum_mbus_fmt() - Enum supported mediabus formats</span>
<span class="cm"> * @sd: pointer to standard V4L2 sub-device structure</span>
<span class="cm"> * @index: format index</span>
<span class="cm"> * @code: pointer to mediabus format</span>
<span class="cm"> *</span>
<span class="cm"> * Enumerate supported mediabus formats.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_enum_mbus_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check requested format index is within range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV10_1X20</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_s_stream() - V4L2 decoder i/f handler for s_stream</span>
<span class="cm"> * @sd: pointer to standard V4L2 sub-device structure</span>
<span class="cm"> * @enable: streaming enable or disable</span>
<span class="cm"> *</span>
<span class="cm"> * Sets streaming to enable or disable, if possible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_tvp7002</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set output state on (low impedance means stream on) */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_MISC_CTL_2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set output state off (high impedance means stream off) */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_MISC_CTL_2</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Unable to stop streaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">device</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_log_status() - Print information about register settings</span>
<span class="cm"> * @sd: ptr to v4l2_subdev struct</span>
<span class="cm"> *</span>
<span class="cm"> * Log register values of a TVP7002 decoder device.</span>
<span class="cm"> * Returns zero or -EINVAL if read operation fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tvp7002_preset_definition</span> <span class="o">*</span><span class="n">presets</span> <span class="o">=</span> <span class="n">tvp7002_presets</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_tvp7002</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_dv_enum_preset</span> <span class="n">e_preset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="n">detected</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">detected</span><span class="p">.</span><span class="n">preset</span> <span class="o">=</span> <span class="n">V4L2_DV_INVALID</span><span class="p">;</span>
	<span class="cm">/* Find my current standard*/</span>
	<span class="n">tvp7002_query_dv_preset</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">detected</span><span class="p">);</span>

	<span class="cm">/* Print standard related code values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PRESETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">presets</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">presets</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">==</span> <span class="n">detected</span><span class="p">.</span><span class="n">preset</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l_fill_dv_preset_info</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e_preset</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Selected DV Preset: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;   Pixels per line: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;   Lines per frame: %u</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_PRESETS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected DV Preset: None</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v4l_fill_dv_preset_info</span><span class="p">(</span><span class="n">presets</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e_preset</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected DV Preset: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;  Pixels per line: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;  Lines per frame: %u</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e_preset</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Streaming enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">device</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="cm">/* Print the current value of the gain control */</span>
	<span class="n">v4l2_ctrl_handler_log_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_enum_dv_presets() - Enum supported digital video formats</span>
<span class="cm"> * @sd: pointer to standard V4L2 sub-device structure</span>
<span class="cm"> * @preset: pointer to format struct</span>
<span class="cm"> *</span>
<span class="cm"> * Enumerate supported digital video formats.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_enum_dv_presets</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_dv_enum_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check requested format index is within range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">NUM_PRESETS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l_fill_dv_preset_info</span><span class="p">(</span><span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">preset</span><span class="p">,</span> <span class="n">preset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_enum_dv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_enum_dv_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check requested format index is within range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">NUM_PRESETS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">timings</span> <span class="o">=</span> <span class="n">tvp7002_presets</span><span class="p">[</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">timings</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">tvp7002_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">tvp7002_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* V4L2 core operation handlers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">tvp7002_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span> <span class="o">=</span> <span class="n">tvp7002_g_chip_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">log_status</span> <span class="o">=</span> <span class="n">tvp7002_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_try_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queryctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querymenu</span> <span class="o">=</span> <span class="n">v4l2_subdev_querymenu</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span> <span class="o">=</span> <span class="n">tvp7002_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span> <span class="o">=</span> <span class="n">tvp7002_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* Specific video subsystem operation handlers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">tvp7002_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_dv_presets</span> <span class="o">=</span> <span class="n">tvp7002_enum_dv_presets</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_dv_preset</span> <span class="o">=</span> <span class="n">tvp7002_s_dv_preset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">query_dv_preset</span> <span class="o">=</span> <span class="n">tvp7002_query_dv_preset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_dv_timings</span> <span class="o">=</span> <span class="n">tvp7002_g_dv_timings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_dv_timings</span> <span class="o">=</span> <span class="n">tvp7002_s_dv_timings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_dv_timings</span> <span class="o">=</span> <span class="n">tvp7002_enum_dv_timings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">query_dv_timings</span> <span class="o">=</span> <span class="n">tvp7002_query_dv_timings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">tvp7002_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp7002_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp7002_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp7002_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp7002_enum_mbus_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* V4L2 top level operation handlers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">tvp7002_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp7002_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp7002_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_probe - Probe a TVP7002 device</span>
<span class="cm"> * @c: ptr to i2c_client struct</span>
<span class="cm"> * @id: ptr to i2c_device_id struct</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize the TVP7002 device</span>
<span class="cm"> * Returns zero when successful, -EINVAL if register read fails or</span>
<span class="cm"> * -EIO if i2c access is not available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_dv_preset</span> <span class="n">preset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">polarity_a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">polarity_b</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">revision</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Check if the adapter supports the needed features */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">I2C_FUNC_SMBUS_READ_BYTE</span> <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_WRITE_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_err</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;No platform data!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tvp7002</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span> <span class="o">=</span> <span class="n">tvp7002_presets</span><span class="p">;</span>

	<span class="cm">/* Tell v4l2 the device is ready */</span>
	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp7002_ops</span><span class="p">);</span>
	<span class="n">v4l_info</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;tvp7002 found @ 0x%02x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_CHIP_REV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">found_error</span><span class="p">;</span>

	<span class="cm">/* Get revision number */</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Rev. %02x detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Unknown revision detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initializes TVP7002 to its default values */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_write_inittab</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">tvp7002_init_default</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">found_error</span><span class="p">;</span>

	<span class="cm">/* Set polarity information after registers have been set */</span>
	<span class="n">polarity_a</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hs_polarity</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
			<span class="o">|</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vs_polarity</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_SYNC_CTL_1</span><span class="p">,</span> <span class="n">polarity_a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">found_error</span><span class="p">;</span>

	<span class="n">polarity_b</span> <span class="o">=</span> <span class="mh">0x01</span>  <span class="o">|</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">fid_polarity</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
			<span class="o">|</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">sog_polarity</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
			<span class="o">|</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_polarity</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP7002_MISC_CTL_3</span><span class="p">,</span> <span class="n">polarity_b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">found_error</span><span class="p">;</span>

	<span class="cm">/* Set registers according to default video mode */</span>
	<span class="n">preset</span><span class="p">.</span><span class="n">preset</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">current_preset</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tvp7002_s_dv_preset</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">preset</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp7002_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>

<span class="nl">found_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tvp7002_remove - Remove TVP7002 device support</span>
<span class="cm"> * @c: ptr to i2c_client struct</span>
<span class="cm"> *</span>
<span class="cm"> * Reset the TVP7002 device</span>
<span class="cm"> * Returns zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp7002_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tvp7002</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_tvp7002</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Removing tvp7002 adapter&quot;</span>
				<span class="s">&quot;on address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* I2C Device ID table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tvp7002_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tvp7002&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tvp7002_id</span><span class="p">);</span>

<span class="cm">/* I2C driver data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tvp7002_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TVP7002_MODULE_NAME</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tvp7002_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">tvp7002_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tvp7002_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">tvp7002_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
