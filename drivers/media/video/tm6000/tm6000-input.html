<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › tm6000 › tm6000-input.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tm6000-input.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  tm6000-input.c - driver for TM5600/TM6000/TM6010 USB video capture devices</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2010 Stefan Ringel &lt;stefan.ringel@arcor.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation version 2</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>

<span class="cp">#include &lt;media/rc-core.h&gt;</span>

<span class="cp">#include &quot;tm6000.h&quot;</span>
<span class="cp">#include &quot;tm6000-regs.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ir_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="s">&quot;debug message level&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable_ir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_ir</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_ir</span><span class="p">,</span> <span class="s">&quot;enable ir (default is enable)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ir_clock_mhz</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ir_clock_mhz</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_ir</span><span class="p">,</span> <span class="s">&quot;ir clock, in MHz&quot;</span><span class="p">);</span>

<span class="cp">#define URB_SUBMIT_DELAY	100	</span><span class="cm">/* ms - Delay to submit an URB request on retrial and init */</span><span class="cp"></span>
<span class="cp">#define URB_INT_LED_DELAY	100	</span><span class="cm">/* ms - Delay to turn led on again on int mode */</span><span class="cp"></span>

<span class="cp">#undef dprintk</span>

<span class="cp">#define dprintk(level, fmt, arg...) do {\</span>
<span class="cp">	if (ir_debug &gt;= level) \</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s/ir: &quot; fmt, ir-&gt;name , ## arg); \</span>
<span class="cp">	} while (0)</span>

<span class="k">struct</span> <span class="n">tm6000_ir_poll_result</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">rc_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span>		<span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span>			<span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* poll expernal decoder */</span>
	<span class="kt">int</span>			<span class="n">polling</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">work</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">wait</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">pwled</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">submit_urb</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">key_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">int_urb</span><span class="p">;</span>

	<span class="cm">/* IR device properties */</span>
	<span class="n">u64</span>			<span class="n">rc_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">tm6000_ir_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tm6000_ir_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pulse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">leader</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The IR decoder supports RC-5 or NEC, with a configurable timing.</span>
<span class="cm">	 * The timing configuration there is not that accurate, as it uses</span>
<span class="cm">	 * approximate values. The NEC spec mentions a 562.5 unit period,</span>
<span class="cm">	 * and RC-5 uses a 888.8 period.</span>
<span class="cm">	 * Currently, driver assumes a clock provided by a 12 MHz XTAL, but</span>
<span class="cm">	 * a modprobe parameter can adjust it.</span>
<span class="cm">	 * Adjustments are required for other timings.</span>
<span class="cm">	 * It seems that the 900ms timing for NEC is used to detect a RC-5</span>
<span class="cm">	 * IR, in order to discard such decoding</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RC_TYPE_NEC</span>:
		<span class="n">leader</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span>	<span class="cm">/* ms */</span>
		<span class="n">pulse</span>  <span class="o">=</span> <span class="mi">700</span><span class="p">;</span>	<span class="cm">/* ms - the actual value would be 562 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">RC_TYPE_RC5</span>:
		<span class="n">leader</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span>	<span class="cm">/* ms - from the NEC decoding */</span>
		<span class="n">pulse</span>  <span class="o">=</span> <span class="mi">1780</span><span class="p">;</span>	<span class="cm">/* ms - The actual value would be 1776 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pulse</span> <span class="o">=</span> <span class="n">ir_clock_mhz</span> <span class="o">*</span> <span class="n">pulse</span><span class="p">;</span>
	<span class="n">leader</span> <span class="o">=</span> <span class="n">ir_clock_mhz</span> <span class="o">*</span> <span class="n">leader</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_NEC</span><span class="p">)</span>
		<span class="n">leader</span> <span class="o">=</span> <span class="n">leader</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: %s, %d MHz, leader = 0x%04x, pulse = 0x%06x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_NEC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;NEC&quot;</span> <span class="o">:</span> <span class="s">&quot;RC-5&quot;</span><span class="p">,</span>
		<span class="n">ir_clock_mhz</span><span class="p">,</span> <span class="n">leader</span><span class="p">,</span> <span class="n">pulse</span><span class="p">);</span>

	<span class="cm">/* Remote WAKEUP = enable, normal mode, from IR decoder output */</span>
	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RE5_REMOTE_WAKEUP</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>

	<span class="cm">/* Enable IR reception on non-busrt mode */</span>
	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RD8_IR</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">);</span>

	<span class="cm">/* IR_WKUP_SEL = Low byte in decoded IR data */</span>
	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RDA_IR_WAKEUP_SEL</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* IR_WKU_ADD code */</span>
	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RDB_IR_WAKEUP_ADD</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RDC_IR_LEADER1</span><span class="p">,</span> <span class="n">leader</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RDD_IR_LEADER0</span><span class="p">,</span> <span class="n">leader</span><span class="p">);</span>

	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RDE_IR_PULSE_CNT1</span><span class="p">,</span> <span class="n">pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RDF_IR_PULSE_CNT0</span><span class="p">,</span> <span class="n">pulse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_04_EN_DISABLE_MCU_INT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_04_EN_DISABLE_MCU_INT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Shows that IR is working via the LED */</span>
	<span class="n">tm6000_flash_led</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">tm6000_flash_led</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6000_ir_urb_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tm6000_ir_poll_result</span> <span class="n">poll_result</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tm6000: IR URB failure: status: %i, length %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">submit_urb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">URB_SUBMIT_DELAY</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir_debug</span><span class="p">)</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;tm6000: IR data: &quot;</span><span class="p">,</span>
			       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">buf</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span> <span class="o">|=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s, scancode: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span><span class="p">);</span>
	<span class="n">rc_keydown</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Flash the led. We can&#39;t do it here, as it is running on IRQ context.</span>
<span class="cm">	 * So, use the scheduler to do it, in a few ms.</span>
<span class="cm">	 */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6000_ir_handle_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tm6000_IR</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tm6000_ir_poll_result</span> <span class="n">poll_result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_read_write_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span>
		<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
		<span class="n">REQ_02_GET_IR_CODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Check if something was read */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tm6000_flash_led</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s, scancode: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span><span class="p">);</span>
	<span class="n">rc_keydown</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">poll_result</span><span class="p">.</span><span class="n">rc_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tm6000_flash_led</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Re-schedule polling */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6000_ir_int_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tm6000_IR</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s, submit_urb = %d, pwled = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">submit_urb</span><span class="p">,</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">submit_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Resubmit urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_04_EN_DISABLE_MCU_INT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tm6000: Can&#39;t submit an IR interrupt. Error %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rc</span><span class="p">);</span>
			<span class="cm">/* Retry in 100 ms */</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">URB_SUBMIT_DELAY</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">submit_urb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Led is enabled only if USB submit doesn&#39;t fail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tm6000_flash_led</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">URB_INT_LED_DELAY</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tm6000_flash_led</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tm6000_ir_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6000_ir_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tm6000_ir_change_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rc_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rc_map</span><span class="p">.</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_NEC</span><span class="p">))</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">key_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rc_map</span><span class="p">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">scancode</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">=</span> <span class="n">rc_type</span><span class="p">;</span>

	<span class="n">tm6000_ir_config</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="cm">/* TODO */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__tm6000_ir_int_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_in</span><span class="p">.</span><span class="n">endp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span>
		<span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;IR max size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;int interval: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_in</span><span class="p">.</span><span class="n">endp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="n">tm6000_ir_urb_received</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_in</span><span class="p">.</span><span class="n">endp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">submit_urb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">URB_SUBMIT_DELAY</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tm6000_ir_int_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span> <span class="o">||</span> <span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">);</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">int_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_ir_int_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__tm6000_ir_int_start</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tm6000_ir_int_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span> <span class="o">||</span> <span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">__tm6000_ir_int_stop</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_ir_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_remote</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_codes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ir</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span> <span class="o">||</span> <span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* record handles to ourself */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="n">ir</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* input setup */</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_RC5</span> <span class="o">|</span> <span class="n">RC_TYPE_NEC</span><span class="p">;</span>
	<span class="cm">/* Neded, in order to support NEC remotes with 24 or 32 bits */</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">scanmask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ir</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">change_protocol</span> <span class="o">=</span> <span class="n">tm6000_ir_change_protocol</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_in</span><span class="p">.</span><span class="n">endp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">open</span>    <span class="o">=</span> <span class="n">__tm6000_ir_int_start</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">close</span>   <span class="o">=</span> <span class="n">__tm6000_ir_int_stop</span><span class="p">;</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">tm6000_ir_int_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">open</span>  <span class="o">=</span> <span class="n">tm6000_ir_start</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">tm6000_ir_stop</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">tm6000_ir_handle_key</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_SCANCODE</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;tm5600/60x0 IR (%s)&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

	<span class="n">tm6000_ir_change_protocol</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">RC_TYPE_UNKNOWN</span><span class="p">);</span>

	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_USB</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_codes</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;tm6000&quot;</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* ir register */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_ir_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>

	<span class="cm">/* skip detach on non attached board */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span>
		<span class="n">__tm6000_ir_int_stop</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>

	<span class="n">tm6000_ir_stop</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Turn off the led */</span>
	<span class="n">tm6000_flash_led</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">pwled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
