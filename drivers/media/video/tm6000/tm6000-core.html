<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › tm6000 › tm6000-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tm6000-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  tm6000-core.c - driver for TM5600/TM6000/TM6010 USB video capture devices</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006-2007 Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007 Michel Ludwig &lt;michel.ludwig@gmail.com&gt;</span>
<span class="cm"> *      - DVB-T support</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation version 2</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &quot;tm6000.h&quot;</span>
<span class="cp">#include &quot;tm6000-regs.h&quot;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>

<span class="cp">#define USB_TIMEOUT	(5 * HZ) </span><span class="cm">/* ms */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">tm6000_read_write_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>          <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">u8</span>	     <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_type</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tm6000_debug</span> <span class="o">&amp;</span> <span class="n">V4L2_DEBUG_I2C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(dev %p, pipe %08x): &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s: %02x %02x %02x %02x %02x %02x %02x %02x &quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">req_type</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
			<span class="n">req_type</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">value</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">value</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">index</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span>
			<span class="n">index</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">len</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req_type</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;&gt;&gt;&gt; &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req_type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
			      <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">USB_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_type</span> <span class="o">&amp;</span>  <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tm6000_debug</span> <span class="o">&amp;</span> <span class="n">V4L2_DEBUG_I2C</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req_type</span> <span class="o">&amp;</span>  <span class="n">USB_DIR_IN</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;&lt;&lt;&lt; (len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s: Error #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req_type</span> <span class="o">&amp;</span>  <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;&lt;&lt;&lt; &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TM6000_QUIRK_NO_USB_DELAY</span><span class="p">)</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">REQ_16_SET_GET_I2C_WR1_RDN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">req_type</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tsleep</span><span class="p">;</span>
		<span class="cm">/* Calculate delay time, 14000us for 64 bytes */</span>
		<span class="n">tsleep</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span> <span class="o">+</span> <span class="mi">200</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tsleep</span> <span class="o">&lt;</span> <span class="n">delay</span><span class="p">)</span>
			<span class="n">tsleep</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="n">tsleep</span><span class="p">,</span> <span class="n">tsleep</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">delay</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>
		<span class="n">tm6000_read_write_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span>
				      <span class="n">req</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tm6000_set_reg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tm6000_get_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_read_write_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tm6000_get_reg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tm6000_set_reg_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">new_index</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_read_write_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">new_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_index</span> <span class="o">==</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tm6000_read_write_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span>
				      <span class="n">req</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">new_index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tm6000_set_reg_mask</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tm6000_get_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_read_write_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_get_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_read_write_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_i2c_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tsleep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_03_SET_GET_MCU_PIN</span><span class="p">,</span> <span class="n">TM6000_GPIO_CLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">tsleep</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_03_SET_GET_MCU_PIN</span><span class="p">,</span> <span class="n">TM6000_GPIO_CLK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">tsleep</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tm6000_set_fourcc_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tm6000_get_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">)</span>
			<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">)</span>
			<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC1_TRESHOLD</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC1_TRESHOLD</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6000_set_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME:</span>
<span class="cm">	 * VBI lines and start/end are different between 60Hz and 50Hz</span>
<span class="cm">	 * So, it is very likely that we need to change the config to</span>
<span class="cm">	 * something that takes it into account, doing something different</span>
<span class="cm">	 * if (dev-&gt;norm &amp; V4L2_STD_525_60)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R41_TELETEXT_VBI_CODE1</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R42_VBI_DATA_HIGH_LEVEL</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R43_VBI_DATA_TYPE_LINE7</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R44_VBI_DATA_TYPE_LINE8</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R45_VBI_DATA_TYPE_LINE9</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R46_VBI_DATA_TYPE_LINE10</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R47_VBI_DATA_TYPE_LINE11</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R48_VBI_DATA_TYPE_LINE12</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R49_VBI_DATA_TYPE_LINE13</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R4A_VBI_DATA_TYPE_LINE14</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R4B_VBI_DATA_TYPE_LINE15</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R4C_VBI_DATA_TYPE_LINE16</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R4D_VBI_DATA_TYPE_LINE17</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R4E_VBI_DATA_TYPE_LINE18</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R4F_VBI_DATA_TYPE_LINE19</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R50_VBI_DATA_TYPE_LINE20</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R51_VBI_DATA_TYPE_LINE21</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R52_VBI_DATA_TYPE_LINE22</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R53_VBI_DATA_TYPE_LINE23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R54_VBI_DATA_TYPE_RLINES</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R55_VBI_LOOP_FILTER_GAIN</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R56_VBI_LOOP_FILTER_I_GAIN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">TM6010_REQ07_R57_VBI_LOOP_FILTER_P_GAIN</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R58_VBI_CAPTION_DTO1</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R59_VBI_CAPTION_DTO0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R5A_VBI_TELETEXT_DTO1</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R5B_VBI_TELETEXT_DTO0</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R40_TELETEXT_VBI_CODE0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_init_analog_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="n">f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">active</span> <span class="o">=</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF_AUDIO_ENABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
			<span class="n">active</span> <span class="o">|=</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF_VIDEO_ENABLE</span><span class="p">;</span>

		<span class="cm">/* Enable video and audio */</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF</span><span class="p">,</span>
							<span class="n">active</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
		<span class="cm">/* Disable TS input */</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC0_ACTIVE_VIDEO_SOURCE</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Enables soft reset */</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">)</span>
			<span class="cm">/* Disable Hfilter and Enable TS Drop err */</span>
			<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC0_ACTIVE_VIDEO_SOURCE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="k">else</span>	<span class="cm">/* Enable Hfilter and disable TS Drop err */</span>
			<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC0_ACTIVE_VIDEO_SOURCE</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC3_HSTART1</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RDA_CLK_SEL</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RD1_ADDR_FOR_REQ1</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RD2_ADDR_FOR_REQ2</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RD6_ENDP_REQ1_REQ2</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RDF_PWDOWN_ACLK</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>

		<span class="cm">/* AP Software reset */</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RFF_SOFT_RESET</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RFF_SOFT_RESET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="n">tm6000_set_fourcc_format</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Disables soft reset */</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Tuner firmware can now be loaded */</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: This is a hack! xc3028 &quot;sleeps&quot; when no channel is detected</span>
<span class="cm">	 * for more than a few seconds. Not sure why, as this behavior does</span>
<span class="cm">	 * not happen on other devices with xc3028. So, I suspect that it</span>
<span class="cm">	 * is yet another bug at tm6000. After start sleeping, decoding</span>
<span class="cm">	 * doesn&#39;t start automatically. Instead, it requires some</span>
<span class="cm">	 * I2C commands to wake it up. As we want to have image at the</span>
<span class="cm">	 * beginning, we needed to add this hack. The better would be to</span>
<span class="cm">	 * discover some way to make tm6000 to wake up without this hack.</span>
<span class="cm">	 */</span>
	<span class="n">f</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_frequency</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">tm6000_set_standard</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tm6000_set_vbi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tm6000_set_audio_bitrate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">48000</span><span class="p">);</span>

	<span class="cm">/* switch dvb led off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">dvb_led</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_03_SET_GET_MCU_PIN</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">dvb_led</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_init_digital_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable video and audio */</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF</span><span class="p">,</span>
				<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
		<span class="cm">/* Enable TS input */</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC0_ACTIVE_VIDEO_SOURCE</span><span class="p">,</span>
				<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="cm">/* all power down, but not the digital data port */</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RFE_POWER_DOWN</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RE2_POWER_DOWN_CTRL1</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RE6_POWER_DOWN_CTRL2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RFF_SOFT_RESET</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RFF_SOFT_RESET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RDF_PWDOWN_ACLK</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RE2_VADC_STATUS_CTL</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RE8_VADC_PWDOWN_CTL</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_REB_VADC_AADC_MODE</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC0_ACTIVE_VIDEO_SOURCE</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC1_TRESHOLD</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RC3_HSTART1</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RDA_CLK_SEL</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RD1_ADDR_FOR_REQ1</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RD2_ADDR_FOR_REQ2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_RD6_ENDP_REQ1_REQ2</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>

		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RE2_VADC_STATUS_CTL</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RE8_VADC_PWDOWN_CTL</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_REB_VADC_AADC_MODE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_04_EN_DISABLE_MCU_INT</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_04_EN_DISABLE_MCU_INT</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_04_EN_DISABLE_MCU_INT</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* switch dvb led on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">dvb_led</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_03_SET_GET_MCU_PIN</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">dvb_led</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tm6000_init_digital_mode</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">reg_init</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The meaning of those initializations are unknown */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_init</span> <span class="n">tm6000_init_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* REG  VALUE */</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_RDF_PWDOWN_ACLK</span><span class="p">,</span> <span class="mh">0x1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RFF_SOFT_RESET</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RFF_SOFT_RESET</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RD5_POWERSAVE</span><span class="p">,</span> <span class="mh">0x4f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_RDA_CLK_SEL</span><span class="p">,</span> <span class="mh">0x23</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_RDB_OUT_SEL</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_RE2_VADC_STATUS_CTL</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_RE3_VADC_INP_LPF_SEL1</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_RE5_VADC_INP_LPF_SEL2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_RE8_VADC_PWDOWN_CTL</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_REB_VADC_AADC_MODE</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>	<span class="cm">/* 48000 bits/sample, external input */</span>
	<span class="p">{</span> <span class="n">TM6000_REQ07_REE_VADC_CTRL_SEL_CONTROL</span><span class="p">,</span> <span class="mh">0xc2</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>		<span class="cm">/* Start of soft reset */</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R00_VIDEO_CONTROL0</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R01_VIDEO_CONTROL1</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R02_VIDEO_CONTROL2</span><span class="p">,</span> <span class="mh">0x5f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R03_YC_SEP_CONTROL</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R05_NOISE_THRESHOLD</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R07_OUTPUT_CONTROL</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R08_LUMA_CONTRAST_ADJ</span><span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R09_LUMA_BRIGHTNESS_ADJ</span><span class="p">,</span> <span class="mh">0x36</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R0A_CHROMA_SATURATION_ADJ</span><span class="p">,</span> <span class="mh">0x50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R0C_CHROMA_AGC_CONTROL</span><span class="p">,</span> <span class="mh">0x6a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R11_AGC_PEAK_CONTROL</span><span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R12_AGC_GATE_STARTH</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R13_AGC_GATE_STARTL</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R14_AGC_GATE_WIDTH</span><span class="p">,</span> <span class="mh">0x47</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R15_AGC_BP_DELAY</span><span class="p">,</span> <span class="mh">0x6f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R17_HLOOP_MAXSTATE</span><span class="p">,</span> <span class="mh">0xcd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R18_CHROMA_DTO_INCREMENT3</span><span class="p">,</span> <span class="mh">0x1e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R19_CHROMA_DTO_INCREMENT2</span><span class="p">,</span> <span class="mh">0x8b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1A_CHROMA_DTO_INCREMENT1</span><span class="p">,</span> <span class="mh">0xa2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1B_CHROMA_DTO_INCREMENT0</span><span class="p">,</span> <span class="mh">0xe9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1C_HSYNC_DTO_INCREMENT3</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1D_HSYNC_DTO_INCREMENT2</span><span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1E_HSYNC_DTO_INCREMENT1</span><span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1F_HSYNC_DTO_INCREMENT0</span><span class="p">,</span> <span class="mh">0xcd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R20_HSYNC_RISING_EDGE_TIME</span><span class="p">,</span> <span class="mh">0x3c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R21_HSYNC_PHASE_OFFSET</span><span class="p">,</span> <span class="mh">0x3c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R2D_CHROMA_BURST_END</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R2E_ACTIVE_VIDEO_HSTART</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R30_ACTIVE_VIDEO_VSTART</span><span class="p">,</span> <span class="mh">0x22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R31_ACTIVE_VIDEO_VHIGHT</span><span class="p">,</span> <span class="mh">0x61</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R32_VSYNC_HLOCK_MIN</span><span class="p">,</span> <span class="mh">0x74</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R33_VSYNC_HLOCK_MAX</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R34_VSYNC_AGC_MIN</span><span class="p">,</span> <span class="mh">0x74</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R35_VSYNC_AGC_MAX</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R36_VSYNC_VBI_MIN</span><span class="p">,</span> <span class="mh">0x7a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R37_VSYNC_VBI_MAX</span><span class="p">,</span> <span class="mh">0x26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R38_VSYNC_THRESHOLD</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R39_VSYNC_TIME_CONSTANT</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R42_VBI_DATA_HIGH_LEVEL</span><span class="p">,</span> <span class="mh">0x55</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R51_VBI_DATA_TYPE_LINE21</span><span class="p">,</span> <span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R55_VBI_LOOP_FILTER_GAIN</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R57_VBI_LOOP_FILTER_P_GAIN</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R58_VBI_CAPTION_DTO1</span><span class="p">,</span> <span class="mh">0x35</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R59_VBI_CAPTION_DTO0</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R80_COMB_FILTER_TRESHOLD</span><span class="p">,</span> <span class="mh">0x15</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R82_COMB_FILTER_CONFIG</span><span class="p">,</span> <span class="mh">0x42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RC1_TRESHOLD</span><span class="p">,</span> <span class="mh">0xd0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RC3_HSTART1</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>		<span class="cm">/* End of the soft reset */</span>
	<span class="p">{</span> <span class="n">TM6010_REQ05_R18_IMASK7</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_init</span> <span class="n">tm6010_init_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RC0_ACTIVE_VIDEO_SOURCE</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RC4_HSTART0</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RC6_HEND0</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RCA_VEND0</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RCC_ACTIVE_IF</span><span class="p">,</span> <span class="mh">0xe1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RE0_DVIDEO_SOURCE</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RFE_POWER_DOWN</span><span class="p">,</span> <span class="mh">0x7f</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">TM6010_REQ08_RE2_POWER_DOWN_CTRL1</span><span class="p">,</span> <span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_RE3_ADC_IN1_SEL</span><span class="p">,</span> <span class="mh">0xf4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_RE4_ADC_IN2_SEL</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_RE6_POWER_DOWN_CTRL2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_REA_BUFF_DRV_CTRL</span><span class="p">,</span> <span class="mh">0xf2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_REB_SIF_GAIN_CTRL</span><span class="p">,</span> <span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_REC_REVERSE_YC_CTRL</span><span class="p">,</span> <span class="mh">0xc2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_RF0_DAUDIO_INPUT_CONFIG</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ08_RF1_AADC_POWER_DOWN</span><span class="p">,</span> <span class="mh">0xfc</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R00_VIDEO_CONTROL0</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R01_VIDEO_CONTROL1</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R02_VIDEO_CONTROL2</span><span class="p">,</span> <span class="mh">0x5f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R03_YC_SEP_CONTROL</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R05_NOISE_THRESHOLD</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R07_OUTPUT_CONTROL</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R08_LUMA_CONTRAST_ADJ</span><span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R09_LUMA_BRIGHTNESS_ADJ</span><span class="p">,</span> <span class="mh">0x36</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R0A_CHROMA_SATURATION_ADJ</span><span class="p">,</span> <span class="mh">0x50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R0C_CHROMA_AGC_CONTROL</span><span class="p">,</span> <span class="mh">0x6a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R11_AGC_PEAK_CONTROL</span><span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R12_AGC_GATE_STARTH</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R13_AGC_GATE_STARTL</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R14_AGC_GATE_WIDTH</span><span class="p">,</span> <span class="mh">0x47</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R15_AGC_BP_DELAY</span><span class="p">,</span> <span class="mh">0x6f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R17_HLOOP_MAXSTATE</span><span class="p">,</span> <span class="mh">0xcd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R18_CHROMA_DTO_INCREMENT3</span><span class="p">,</span> <span class="mh">0x1e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R19_CHROMA_DTO_INCREMENT2</span><span class="p">,</span> <span class="mh">0x8b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1A_CHROMA_DTO_INCREMENT1</span><span class="p">,</span> <span class="mh">0xa2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1B_CHROMA_DTO_INCREMENT0</span><span class="p">,</span> <span class="mh">0xe9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1C_HSYNC_DTO_INCREMENT3</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1D_HSYNC_DTO_INCREMENT2</span><span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1E_HSYNC_DTO_INCREMENT1</span><span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R1F_HSYNC_DTO_INCREMENT0</span><span class="p">,</span> <span class="mh">0xcd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R20_HSYNC_RISING_EDGE_TIME</span><span class="p">,</span> <span class="mh">0x3c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R21_HSYNC_PHASE_OFFSET</span><span class="p">,</span> <span class="mh">0x3c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R2D_CHROMA_BURST_END</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R2E_ACTIVE_VIDEO_HSTART</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R30_ACTIVE_VIDEO_VSTART</span><span class="p">,</span> <span class="mh">0x22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R31_ACTIVE_VIDEO_VHIGHT</span><span class="p">,</span> <span class="mh">0x61</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R32_VSYNC_HLOCK_MIN</span><span class="p">,</span> <span class="mh">0x74</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R33_VSYNC_HLOCK_MAX</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R34_VSYNC_AGC_MIN</span><span class="p">,</span> <span class="mh">0x74</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R35_VSYNC_AGC_MAX</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R36_VSYNC_VBI_MIN</span><span class="p">,</span> <span class="mh">0x7a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R37_VSYNC_VBI_MAX</span><span class="p">,</span> <span class="mh">0x26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R38_VSYNC_THRESHOLD</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R39_VSYNC_TIME_CONSTANT</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R42_VBI_DATA_HIGH_LEVEL</span><span class="p">,</span> <span class="mh">0x55</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R51_VBI_DATA_TYPE_LINE21</span><span class="p">,</span> <span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R55_VBI_LOOP_FILTER_GAIN</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R57_VBI_LOOP_FILTER_P_GAIN</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R58_VBI_CAPTION_DTO1</span><span class="p">,</span> <span class="mh">0x35</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R59_VBI_CAPTION_DTO0</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R80_COMB_FILTER_TRESHOLD</span><span class="p">,</span> <span class="mh">0x15</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R82_COMB_FILTER_CONFIG</span><span class="p">,</span> <span class="mh">0x42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RC1_TRESHOLD</span><span class="p">,</span> <span class="mh">0xd0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RC3_HSTART1</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_R3F_RESET</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">TM6010_REQ05_R18_IMASK7</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">TM6010_REQ07_RDC_IR_LEADER1</span><span class="p">,</span> <span class="mh">0xaa</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RDD_IR_LEADER0</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RDE_IR_PULSE_CNT1</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RDF_IR_PULSE_CNT0</span><span class="p">,</span> <span class="mh">0xd0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">REQ_04_EN_DISABLE_MCU_INT</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RD8_IR</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="p">},</span>

	<span class="cm">/* set remote wakeup key:any key wakeup */</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RE5_REMOTE_WAKEUP</span><span class="p">,</span>  <span class="mh">0xfe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TM6010_REQ07_RDA_IR_WAKEUP_SEL</span><span class="p">,</span>  <span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">tm6000_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">board</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reg_init</span> <span class="o">*</span><span class="n">tab</span><span class="p">;</span>

	<span class="cm">/* Check board revision */</span>
	<span class="n">board</span> <span class="o">=</span> <span class="n">tm6000_get_reg32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REQ_40_GET_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">board</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xf3</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Found tm6000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">TM6000</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">TM6000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xf4</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Found tm6010</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">TM6010</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">TM6010</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unknown board version = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">board</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error %i while retrieving board version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">board</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tab</span> <span class="o">=</span> <span class="n">tm6010_init_tab</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tm6010_init_tab</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tab</span> <span class="o">=</span> <span class="n">tm6000_init_tab</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tm6000_init_tab</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Load board&#39;s initialization table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">,</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error %i while setting req %d, &quot;</span>
					<span class="s">&quot;reg %d to value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
					<span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">,</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="cm">/* Just to be conservative */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tm6000_cards_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">tm6000_set_audio_bitrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">areg_f0</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span> <span class="cm">/* ADC MCLK = 250 Fs */</span>
	<span class="n">u8</span> <span class="n">areg_0a</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span> <span class="cm">/* SIF 48KHz */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bitrate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">areg_f0</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span> <span class="cm">/* ADC MCLK = 250 Fs */</span>
		<span class="n">areg_0a</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span> <span class="cm">/* SIF 48KHz */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_bitrate</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">areg_f0</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* ADC MCLK = 375 Fs */</span>
		<span class="n">areg_0a</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span> <span class="cm">/* SIF 32KHz */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">audio_bitrate</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* enable I2S, if we use sif or external I2S device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_R0A_A_I2S_MOD</span><span class="p">,</span> <span class="n">areg_0a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RF0_DAUDIO_INPUT_CONFIG</span><span class="p">,</span>
							<span class="n">areg_f0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_REB_VADC_AADC_MODE</span><span class="p">,</span>
							<span class="n">areg_f0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tm6000_set_audio_bitrate</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tm6000_set_audio_rinput</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Audio crossbar setting, default SIF1 */</span>
		<span class="n">u8</span> <span class="n">areg_f0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">areg_07</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rinput</span><span class="p">.</span><span class="n">amux</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TM6000_AMUX_SIF1</span>:
		<span class="k">case</span> <span class="n">TM6000_AMUX_SIF2</span>:
			<span class="n">areg_f0</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="n">areg_07</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TM6000_AMUX_ADC1</span>:
			<span class="n">areg_f0</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TM6000_AMUX_ADC2</span>:
			<span class="n">areg_f0</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TM6000_AMUX_I2S</span>:
			<span class="n">areg_f0</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: audio input dosn&#39;t support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Set audio input crossbar */</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RF0_DAUDIO_INPUT_CONFIG</span><span class="p">,</span>
							<span class="n">areg_f0</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="cm">/* Mux overflow workaround */</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ07_R07_OUTPUT_CONTROL</span><span class="p">,</span>
			<span class="n">areg_07</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">areg_eb</span><span class="p">;</span>
		<span class="cm">/* Audio setting, default LINE1 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rinput</span><span class="p">.</span><span class="n">amux</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TM6000_AMUX_ADC1</span>:
			<span class="n">areg_eb</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TM6000_AMUX_ADC2</span>:
			<span class="n">areg_eb</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: audio input dosn&#39;t support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Set audio input */</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_REB_VADC_AADC_MODE</span><span class="p">,</span>
							<span class="n">areg_eb</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6010_set_mute_sif</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mute_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">mute_reg</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_R0A_A_I2S_MOD</span><span class="p">,</span> <span class="n">mute_reg</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6010_set_mute_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mute_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">mute_reg</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RF2_LEFT_CHANNEL_VOL</span><span class="p">,</span>
							<span class="n">mute_reg</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RF3_RIGHT_CHANNEL_VOL</span><span class="p">,</span>
							<span class="n">mute_reg</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_REC_VADC_AADC_LVOL</span><span class="p">,</span>
							<span class="n">mute_reg</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">tm6000_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RED_VADC_AADC_RVOL</span><span class="p">,</span>
							<span class="n">mute_reg</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_tvaudio_set_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">tm6000_mux</span> <span class="n">mux</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="n">mux</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rinput</span><span class="p">.</span><span class="n">amux</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mux</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vinput</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">].</span><span class="n">amux</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mux</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TM6000_AMUX_SIF1</span>:
	<span class="k">case</span> <span class="n">TM6000_AMUX_SIF2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span>
			<span class="n">tm6010_set_mute_sif</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ERROR: TM5600 and TM6000 don&#39;t has&quot;</span>
					<span class="s">&quot; SIF audio inputs. Please check the %s&quot;</span>
					<span class="s">&quot; configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TM6000_AMUX_ADC1</span>:
	<span class="k">case</span> <span class="n">TM6000_AMUX_ADC2</span>:
		<span class="n">tm6010_set_mute_adc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6010_set_volume_sif</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">vol_reg</span><span class="p">;</span>

	<span class="n">vol_reg</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vol_reg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_R07_A_LEFT_VOL</span><span class="p">,</span> <span class="n">vol_reg</span><span class="p">);</span>
	<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_R08_A_RIGHT_VOL</span><span class="p">,</span> <span class="n">vol_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tm6010_set_volume_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">vol_reg</span><span class="p">;</span>

	<span class="n">vol_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">vol</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RF2_LEFT_CHANNEL_VOL</span><span class="p">,</span> <span class="n">vol_reg</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6010_REQ08_RF3_RIGHT_CHANNEL_VOL</span><span class="p">,</span> <span class="n">vol_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_REC_VADC_AADC_LVOL</span><span class="p">,</span> <span class="n">vol_reg</span><span class="p">);</span>
		<span class="n">tm6000_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TM6000_REQ07_RED_VADC_AADC_RVOL</span><span class="p">,</span> <span class="n">vol_reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tm6000_set_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">tm6000_mux</span> <span class="n">mux</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mux</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rinput</span><span class="p">.</span><span class="n">amux</span><span class="p">;</span>
		<span class="n">vol</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* Offset to 0 dB */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mux</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vinput</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">].</span><span class="n">amux</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mux</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TM6000_AMUX_SIF1</span>:
	<span class="k">case</span> <span class="n">TM6000_AMUX_SIF2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TM6010</span><span class="p">)</span>
			<span class="n">tm6010_set_volume_sif</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ERROR: TM5600 and TM6000 don&#39;t has&quot;</span>
					<span class="s">&quot; SIF audio inputs. Please check the %s&quot;</span>
					<span class="s">&quot; configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TM6000_AMUX_ADC1</span>:
	<span class="k">case</span> <span class="n">TM6000_AMUX_ADC2</span>:
		<span class="n">tm6010_set_volume_adc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tm6000_devlist</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tm6000_realease_resource()</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tm6000_remove_from_devlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">tm6000_add_into_devlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm6000_devlist</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Extension interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tm6000_extension_devlist</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tm6000_call_fillbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">tm6000_ops_type</span> <span class="n">type</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* FIXME: tm6000_extension_devlist_lock should be a spinlock */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_extension_devlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm6000_extension_devlist</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fillbuf</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">fillbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tm6000_register_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm6000_extension_devlist</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm6000_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Initialized (%s) extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tm6000_register_extension</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tm6000_unregister_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm6000_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tm6000: Remove (%s) extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tm6000_unregister_extension</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tm6000_init_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_extension_devlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm6000_extension_devlist</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tm6000_close_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm6000_core</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tm6000_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_extension_devlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm6000_extension_devlist</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">)</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm6000_devlist_mutex</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
