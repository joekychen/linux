<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › ov2640.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ov2640.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ov2640 Camera Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Alberto Panizzo &lt;maramaopercheseimorto@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on ov772x, ov9640 drivers and previous non merged implementations.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005-2009 Freescale Semiconductor, Inc. All Rights Reserved.</span>
<span class="cm"> * Copyright (C) 2006, OmniVision</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>

<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>

<span class="cp">#define VAL_SET(x, mask, rshift, lshift)  \</span>
<span class="cp">		((((x) &gt;&gt; rshift) &amp; mask) &lt;&lt; lshift)</span>
<span class="cm">/*</span>
<span class="cm"> * DSP registers</span>
<span class="cm"> * register offset for BANK_SEL == BANK_SEL_DSP</span>
<span class="cm"> */</span>
<span class="cp">#define R_BYPASS    0x05 </span><span class="cm">/* Bypass DSP */</span><span class="cp"></span>
<span class="cp">#define   R_BYPASS_DSP_BYPAS    0x01 </span><span class="cm">/* Bypass DSP, sensor out directly */</span><span class="cp"></span>
<span class="cp">#define   R_BYPASS_USE_DSP      0x00 </span><span class="cm">/* Use the internal DSP */</span><span class="cp"></span>
<span class="cp">#define QS          0x44 </span><span class="cm">/* Quantization Scale Factor */</span><span class="cp"></span>
<span class="cp">#define CTRLI       0x50</span>
<span class="cp">#define   CTRLI_LP_DP           0x80</span>
<span class="cp">#define   CTRLI_ROUND           0x40</span>
<span class="cp">#define   CTRLI_V_DIV_SET(x)    VAL_SET(x, 0x3, 0, 3)</span>
<span class="cp">#define   CTRLI_H_DIV_SET(x)    VAL_SET(x, 0x3, 0, 0)</span>
<span class="cp">#define HSIZE       0x51 </span><span class="cm">/* H_SIZE[7:0] (real/4) */</span><span class="cp"></span>
<span class="cp">#define   HSIZE_SET(x)          VAL_SET(x, 0xFF, 2, 0)</span>
<span class="cp">#define VSIZE       0x52 </span><span class="cm">/* V_SIZE[7:0] (real/4) */</span><span class="cp"></span>
<span class="cp">#define   VSIZE_SET(x)          VAL_SET(x, 0xFF, 2, 0)</span>
<span class="cp">#define XOFFL       0x53 </span><span class="cm">/* OFFSET_X[7:0] */</span><span class="cp"></span>
<span class="cp">#define   XOFFL_SET(x)          VAL_SET(x, 0xFF, 0, 0)</span>
<span class="cp">#define YOFFL       0x54 </span><span class="cm">/* OFFSET_Y[7:0] */</span><span class="cp"></span>
<span class="cp">#define   YOFFL_SET(x)          VAL_SET(x, 0xFF, 0, 0)</span>
<span class="cp">#define VHYX        0x55 </span><span class="cm">/* Offset and size completion */</span><span class="cp"></span>
<span class="cp">#define   VHYX_VSIZE_SET(x)     VAL_SET(x, 0x1, (8+2), 7)</span>
<span class="cp">#define   VHYX_HSIZE_SET(x)     VAL_SET(x, 0x1, (8+2), 3)</span>
<span class="cp">#define   VHYX_YOFF_SET(x)      VAL_SET(x, 0x3, 8, 4)</span>
<span class="cp">#define   VHYX_XOFF_SET(x)      VAL_SET(x, 0x3, 8, 0)</span>
<span class="cp">#define DPRP        0x56</span>
<span class="cp">#define TEST        0x57 </span><span class="cm">/* Horizontal size completion */</span><span class="cp"></span>
<span class="cp">#define   TEST_HSIZE_SET(x)     VAL_SET(x, 0x1, (9+2), 7)</span>
<span class="cp">#define ZMOW        0x5A </span><span class="cm">/* Zoom: Out Width  OUTW[7:0] (real/4) */</span><span class="cp"></span>
<span class="cp">#define   ZMOW_OUTW_SET(x)      VAL_SET(x, 0xFF, 2, 0)</span>
<span class="cp">#define ZMOH        0x5B </span><span class="cm">/* Zoom: Out Height OUTH[7:0] (real/4) */</span><span class="cp"></span>
<span class="cp">#define   ZMOH_OUTH_SET(x)      VAL_SET(x, 0xFF, 2, 0)</span>
<span class="cp">#define ZMHH        0x5C </span><span class="cm">/* Zoom: Speed and H&amp;W completion */</span><span class="cp"></span>
<span class="cp">#define   ZMHH_ZSPEED_SET(x)    VAL_SET(x, 0x0F, 0, 4)</span>
<span class="cp">#define   ZMHH_OUTH_SET(x)      VAL_SET(x, 0x1, (8+2), 2)</span>
<span class="cp">#define   ZMHH_OUTW_SET(x)      VAL_SET(x, 0x3, (8+2), 0)</span>
<span class="cp">#define BPADDR      0x7C </span><span class="cm">/* SDE Indirect Register Access: Address */</span><span class="cp"></span>
<span class="cp">#define BPDATA      0x7D </span><span class="cm">/* SDE Indirect Register Access: Data */</span><span class="cp"></span>
<span class="cp">#define CTRL2       0x86 </span><span class="cm">/* DSP Module enable 2 */</span><span class="cp"></span>
<span class="cp">#define   CTRL2_DCW_EN          0x20</span>
<span class="cp">#define   CTRL2_SDE_EN          0x10</span>
<span class="cp">#define   CTRL2_UV_ADJ_EN       0x08</span>
<span class="cp">#define   CTRL2_UV_AVG_EN       0x04</span>
<span class="cp">#define   CTRL2_CMX_EN          0x01</span>
<span class="cp">#define CTRL3       0x87 </span><span class="cm">/* DSP Module enable 3 */</span><span class="cp"></span>
<span class="cp">#define   CTRL3_BPC_EN          0x80</span>
<span class="cp">#define   CTRL3_WPC_EN          0x40</span>
<span class="cp">#define SIZEL       0x8C </span><span class="cm">/* Image Size Completion */</span><span class="cp"></span>
<span class="cp">#define   SIZEL_HSIZE8_11_SET(x) VAL_SET(x, 0x1, 11, 6)</span>
<span class="cp">#define   SIZEL_HSIZE8_SET(x)    VAL_SET(x, 0x7, 0, 3)</span>
<span class="cp">#define   SIZEL_VSIZE8_SET(x)    VAL_SET(x, 0x7, 0, 0)</span>
<span class="cp">#define HSIZE8      0xC0 </span><span class="cm">/* Image Horizontal Size HSIZE[10:3] */</span><span class="cp"></span>
<span class="cp">#define   HSIZE8_SET(x)         VAL_SET(x, 0xFF, 3, 0)</span>
<span class="cp">#define VSIZE8      0xC1 </span><span class="cm">/* Image Vertical Size VSIZE[10:3] */</span><span class="cp"></span>
<span class="cp">#define   VSIZE8_SET(x)         VAL_SET(x, 0xFF, 3, 0)</span>
<span class="cp">#define CTRL0       0xC2 </span><span class="cm">/* DSP Module enable 0 */</span><span class="cp"></span>
<span class="cp">#define   CTRL0_AEC_EN       0x80</span>
<span class="cp">#define   CTRL0_AEC_SEL      0x40</span>
<span class="cp">#define   CTRL0_STAT_SEL     0x20</span>
<span class="cp">#define   CTRL0_VFIRST       0x10</span>
<span class="cp">#define   CTRL0_YUV422       0x08</span>
<span class="cp">#define   CTRL0_YUV_EN       0x04</span>
<span class="cp">#define   CTRL0_RGB_EN       0x02</span>
<span class="cp">#define   CTRL0_RAW_EN       0x01</span>
<span class="cp">#define CTRL1       0xC3 </span><span class="cm">/* DSP Module enable 1 */</span><span class="cp"></span>
<span class="cp">#define   CTRL1_CIP          0x80</span>
<span class="cp">#define   CTRL1_DMY          0x40</span>
<span class="cp">#define   CTRL1_RAW_GMA      0x20</span>
<span class="cp">#define   CTRL1_DG           0x10</span>
<span class="cp">#define   CTRL1_AWB          0x08</span>
<span class="cp">#define   CTRL1_AWB_GAIN     0x04</span>
<span class="cp">#define   CTRL1_LENC         0x02</span>
<span class="cp">#define   CTRL1_PRE          0x01</span>
<span class="cp">#define R_DVP_SP    0xD3 </span><span class="cm">/* DVP output speed control */</span><span class="cp"></span>
<span class="cp">#define   R_DVP_SP_AUTO_MODE 0x80</span>
<span class="cp">#define   R_DVP_SP_DVP_MASK  0x3F </span><span class="cm">/* DVP PCLK = sysclk (48)/[6:0] (YUV0);</span>
<span class="cm">				   *          = sysclk (48)/(2*[6:0]) (RAW);*/</span><span class="cp"></span>
<span class="cp">#define IMAGE_MODE  0xDA </span><span class="cm">/* Image Output Format Select */</span><span class="cp"></span>
<span class="cp">#define   IMAGE_MODE_Y8_DVP_EN   0x40</span>
<span class="cp">#define   IMAGE_MODE_JPEG_EN     0x10</span>
<span class="cp">#define   IMAGE_MODE_YUV422      0x00</span>
<span class="cp">#define   IMAGE_MODE_RAW10       0x04 </span><span class="cm">/* (DVP) */</span><span class="cp"></span>
<span class="cp">#define   IMAGE_MODE_RGB565      0x08</span>
<span class="cp">#define   IMAGE_MODE_HREF_VSYNC  0x02 </span><span class="cm">/* HREF timing select in DVP JPEG output</span>
<span class="cm">				       * mode (0 for HREF is same as sensor) */</span><span class="cp"></span>
<span class="cp">#define   IMAGE_MODE_LBYTE_FIRST 0x01 </span><span class="cm">/* Byte swap enable for DVP</span>
<span class="cm">				       *    1: Low byte first UYVY (C2[4] =0)</span>
<span class="cm">				       *        VYUY (C2[4] =1)</span>
<span class="cm">				       *    0: High byte first YUYV (C2[4]=0)</span>
<span class="cm">				       *        YVYU (C2[4] = 1) */</span><span class="cp"></span>
<span class="cp">#define RESET       0xE0 </span><span class="cm">/* Reset */</span><span class="cp"></span>
<span class="cp">#define   RESET_MICROC       0x40</span>
<span class="cp">#define   RESET_SCCB         0x20</span>
<span class="cp">#define   RESET_JPEG         0x10</span>
<span class="cp">#define   RESET_DVP          0x04</span>
<span class="cp">#define   RESET_IPU          0x02</span>
<span class="cp">#define   RESET_CIF          0x01</span>
<span class="cp">#define REGED       0xED </span><span class="cm">/* Register ED */</span><span class="cp"></span>
<span class="cp">#define   REGED_CLK_OUT_DIS  0x10</span>
<span class="cp">#define MS_SP       0xF0 </span><span class="cm">/* SCCB Master Speed */</span><span class="cp"></span>
<span class="cp">#define SS_ID       0xF7 </span><span class="cm">/* SCCB Slave ID */</span><span class="cp"></span>
<span class="cp">#define SS_CTRL     0xF8 </span><span class="cm">/* SCCB Slave Control */</span><span class="cp"></span>
<span class="cp">#define   SS_CTRL_ADD_AUTO_INC  0x20</span>
<span class="cp">#define   SS_CTRL_EN            0x08</span>
<span class="cp">#define   SS_CTRL_DELAY_CLK     0x04</span>
<span class="cp">#define   SS_CTRL_ACC_EN        0x02</span>
<span class="cp">#define   SS_CTRL_SEN_PASS_THR  0x01</span>
<span class="cp">#define MC_BIST     0xF9 </span><span class="cm">/* Microcontroller misc register */</span><span class="cp"></span>
<span class="cp">#define   MC_BIST_RESET           0x80 </span><span class="cm">/* Microcontroller Reset */</span><span class="cp"></span>
<span class="cp">#define   MC_BIST_BOOT_ROM_SEL    0x40</span>
<span class="cp">#define   MC_BIST_12KB_SEL        0x20</span>
<span class="cp">#define   MC_BIST_12KB_MASK       0x30</span>
<span class="cp">#define   MC_BIST_512KB_SEL       0x08</span>
<span class="cp">#define   MC_BIST_512KB_MASK      0x0C</span>
<span class="cp">#define   MC_BIST_BUSY_BIT_R      0x02</span>
<span class="cp">#define   MC_BIST_MC_RES_ONE_SH_W 0x02</span>
<span class="cp">#define   MC_BIST_LAUNCH          0x01</span>
<span class="cp">#define BANK_SEL    0xFF </span><span class="cm">/* Register Bank Select */</span><span class="cp"></span>
<span class="cp">#define   BANK_SEL_DSP     0x00</span>
<span class="cp">#define   BANK_SEL_SENS    0x01</span>

<span class="cm">/*</span>
<span class="cm"> * Sensor registers</span>
<span class="cm"> * register offset for BANK_SEL == BANK_SEL_SENS</span>
<span class="cm"> */</span>
<span class="cp">#define GAIN        0x00 </span><span class="cm">/* AGC - Gain control gain setting */</span><span class="cp"></span>
<span class="cp">#define COM1        0x03 </span><span class="cm">/* Common control 1 */</span><span class="cp"></span>
<span class="cp">#define   COM1_1_DUMMY_FR          0x40</span>
<span class="cp">#define   COM1_3_DUMMY_FR          0x80</span>
<span class="cp">#define   COM1_7_DUMMY_FR          0xC0</span>
<span class="cp">#define   COM1_VWIN_LSB_UXGA       0x0F</span>
<span class="cp">#define   COM1_VWIN_LSB_SVGA       0x0A</span>
<span class="cp">#define   COM1_VWIN_LSB_CIF        0x06</span>
<span class="cp">#define REG04       0x04 </span><span class="cm">/* Register 04 */</span><span class="cp"></span>
<span class="cp">#define   REG04_DEF             0x20 </span><span class="cm">/* Always set */</span><span class="cp"></span>
<span class="cp">#define   REG04_HFLIP_IMG       0x80 </span><span class="cm">/* Horizontal mirror image ON/OFF */</span><span class="cp"></span>
<span class="cp">#define   REG04_VFLIP_IMG       0x40 </span><span class="cm">/* Vertical flip image ON/OFF */</span><span class="cp"></span>
<span class="cp">#define   REG04_VREF_EN         0x10</span>
<span class="cp">#define   REG04_HREF_EN         0x08</span>
<span class="cp">#define   REG04_AEC_SET(x)      VAL_SET(x, 0x3, 0, 0)</span>
<span class="cp">#define REG08       0x08 </span><span class="cm">/* Frame Exposure One-pin Control Pre-charge Row Num */</span><span class="cp"></span>
<span class="cp">#define COM2        0x09 </span><span class="cm">/* Common control 2 */</span><span class="cp"></span>
<span class="cp">#define   COM2_SOFT_SLEEP_MODE  0x10 </span><span class="cm">/* Soft sleep mode */</span><span class="cp"></span>
				     <span class="cm">/* Output drive capability */</span>
<span class="cp">#define   COM2_OCAP_Nx_SET(N)   (((N) - 1) &amp; 0x03) </span><span class="cm">/* N = [1x .. 4x] */</span><span class="cp"></span>
<span class="cp">#define PID         0x0A </span><span class="cm">/* Product ID Number MSB */</span><span class="cp"></span>
<span class="cp">#define VER         0x0B </span><span class="cm">/* Product ID Number LSB */</span><span class="cp"></span>
<span class="cp">#define COM3        0x0C </span><span class="cm">/* Common control 3 */</span><span class="cp"></span>
<span class="cp">#define   COM3_BAND_50H        0x04 </span><span class="cm">/* 0 For Banding at 60H */</span><span class="cp"></span>
<span class="cp">#define   COM3_BAND_AUTO       0x02 </span><span class="cm">/* Auto Banding */</span><span class="cp"></span>
<span class="cp">#define   COM3_SING_FR_SNAPSH  0x01 </span><span class="cm">/* 0 For enable live video output after the</span>
<span class="cm">				     * snapshot sequence*/</span><span class="cp"></span>
<span class="cp">#define AEC         0x10 </span><span class="cm">/* AEC[9:2] Exposure Value */</span><span class="cp"></span>
<span class="cp">#define CLKRC       0x11 </span><span class="cm">/* Internal clock */</span><span class="cp"></span>
<span class="cp">#define   CLKRC_EN             0x80</span>
<span class="cp">#define   CLKRC_DIV_SET(x)     (((x) - 1) &amp; 0x1F) </span><span class="cm">/* CLK = XVCLK/(x) */</span><span class="cp"></span>
<span class="cp">#define COM7        0x12 </span><span class="cm">/* Common control 7 */</span><span class="cp"></span>
<span class="cp">#define   COM7_SRST            0x80 </span><span class="cm">/* Initiates system reset. All registers are</span>
<span class="cm">				     * set to factory default values after which</span>
<span class="cm">				     * the chip resumes normal operation */</span><span class="cp"></span>
<span class="cp">#define   COM7_RES_UXGA        0x00 </span><span class="cm">/* Resolution selectors for UXGA */</span><span class="cp"></span>
<span class="cp">#define   COM7_RES_SVGA        0x40 </span><span class="cm">/* SVGA */</span><span class="cp"></span>
<span class="cp">#define   COM7_RES_CIF         0x20 </span><span class="cm">/* CIF */</span><span class="cp"></span>
<span class="cp">#define   COM7_ZOOM_EN         0x04 </span><span class="cm">/* Enable Zoom mode */</span><span class="cp"></span>
<span class="cp">#define   COM7_COLOR_BAR_TEST  0x02 </span><span class="cm">/* Enable Color Bar Test Pattern */</span><span class="cp"></span>
<span class="cp">#define COM8        0x13 </span><span class="cm">/* Common control 8 */</span><span class="cp"></span>
<span class="cp">#define   COM8_DEF             0xC0 </span><span class="cm">/* Banding filter ON/OFF */</span><span class="cp"></span>
<span class="cp">#define   COM8_BNDF_EN         0x20 </span><span class="cm">/* Banding filter ON/OFF */</span><span class="cp"></span>
<span class="cp">#define   COM8_AGC_EN          0x04 </span><span class="cm">/* AGC Auto/Manual control selection */</span><span class="cp"></span>
<span class="cp">#define   COM8_AEC_EN          0x01 </span><span class="cm">/* Auto/Manual Exposure control */</span><span class="cp"></span>
<span class="cp">#define COM9        0x14 </span><span class="cm">/* Common control 9</span>
<span class="cm">			  * Automatic gain ceiling - maximum AGC value [7:5]*/</span><span class="cp"></span>
<span class="cp">#define   COM9_AGC_GAIN_2x     0x00 </span><span class="cm">/* 000 :   2x */</span><span class="cp"></span>
<span class="cp">#define   COM9_AGC_GAIN_4x     0x20 </span><span class="cm">/* 001 :   4x */</span><span class="cp"></span>
<span class="cp">#define   COM9_AGC_GAIN_8x     0x40 </span><span class="cm">/* 010 :   8x */</span><span class="cp"></span>
<span class="cp">#define   COM9_AGC_GAIN_16x    0x60 </span><span class="cm">/* 011 :  16x */</span><span class="cp"></span>
<span class="cp">#define   COM9_AGC_GAIN_32x    0x80 </span><span class="cm">/* 100 :  32x */</span><span class="cp"></span>
<span class="cp">#define   COM9_AGC_GAIN_64x    0xA0 </span><span class="cm">/* 101 :  64x */</span><span class="cp"></span>
<span class="cp">#define   COM9_AGC_GAIN_128x   0xC0 </span><span class="cm">/* 110 : 128x */</span><span class="cp"></span>
<span class="cp">#define COM10       0x15 </span><span class="cm">/* Common control 10 */</span><span class="cp"></span>
<span class="cp">#define   COM10_PCLK_HREF      0x20 </span><span class="cm">/* PCLK output qualified by HREF */</span><span class="cp"></span>
<span class="cp">#define   COM10_PCLK_RISE      0x10 </span><span class="cm">/* Data is updated at the rising edge of</span>
<span class="cm">				     * PCLK (user can latch data at the next</span>
<span class="cm">				     * falling edge of PCLK).</span>
<span class="cm">				     * 0 otherwise. */</span><span class="cp"></span>
<span class="cp">#define   COM10_HREF_INV       0x08 </span><span class="cm">/* Invert HREF polarity:</span>
<span class="cm">				     * HREF negative for valid data*/</span><span class="cp"></span>
<span class="cp">#define   COM10_VSINC_INV      0x02 </span><span class="cm">/* Invert VSYNC polarity */</span><span class="cp"></span>
<span class="cp">#define HSTART      0x17 </span><span class="cm">/* Horizontal Window start MSB 8 bit */</span><span class="cp"></span>
<span class="cp">#define HEND        0x18 </span><span class="cm">/* Horizontal Window end MSB 8 bit */</span><span class="cp"></span>
<span class="cp">#define VSTART      0x19 </span><span class="cm">/* Vertical Window start MSB 8 bit */</span><span class="cp"></span>
<span class="cp">#define VEND        0x1A </span><span class="cm">/* Vertical Window end MSB 8 bit */</span><span class="cp"></span>
<span class="cp">#define MIDH        0x1C </span><span class="cm">/* Manufacturer ID byte - high */</span><span class="cp"></span>
<span class="cp">#define MIDL        0x1D </span><span class="cm">/* Manufacturer ID byte - low  */</span><span class="cp"></span>
<span class="cp">#define AEW         0x24 </span><span class="cm">/* AGC/AEC - Stable operating region (upper limit) */</span><span class="cp"></span>
<span class="cp">#define AEB         0x25 </span><span class="cm">/* AGC/AEC - Stable operating region (lower limit) */</span><span class="cp"></span>
<span class="cp">#define VV          0x26 </span><span class="cm">/* AGC/AEC Fast mode operating region */</span><span class="cp"></span>
<span class="cp">#define   VV_HIGH_TH_SET(x)      VAL_SET(x, 0xF, 0, 4)</span>
<span class="cp">#define   VV_LOW_TH_SET(x)       VAL_SET(x, 0xF, 0, 0)</span>
<span class="cp">#define REG2A       0x2A </span><span class="cm">/* Dummy pixel insert MSB */</span><span class="cp"></span>
<span class="cp">#define FRARL       0x2B </span><span class="cm">/* Dummy pixel insert LSB */</span><span class="cp"></span>
<span class="cp">#define ADDVFL      0x2D </span><span class="cm">/* LSB of insert dummy lines in Vertical direction */</span><span class="cp"></span>
<span class="cp">#define ADDVFH      0x2E </span><span class="cm">/* MSB of insert dummy lines in Vertical direction */</span><span class="cp"></span>
<span class="cp">#define YAVG        0x2F </span><span class="cm">/* Y/G Channel Average value */</span><span class="cp"></span>
<span class="cp">#define REG32       0x32 </span><span class="cm">/* Common Control 32 */</span><span class="cp"></span>
<span class="cp">#define   REG32_PCLK_DIV_2    0x80 </span><span class="cm">/* PCLK freq divided by 2 */</span><span class="cp"></span>
<span class="cp">#define   REG32_PCLK_DIV_4    0xC0 </span><span class="cm">/* PCLK freq divided by 4 */</span><span class="cp"></span>
<span class="cp">#define ARCOM2      0x34 </span><span class="cm">/* Zoom: Horizontal start point */</span><span class="cp"></span>
<span class="cp">#define REG45       0x45 </span><span class="cm">/* Register 45 */</span><span class="cp"></span>
<span class="cp">#define FLL         0x46 </span><span class="cm">/* Frame Length Adjustment LSBs */</span><span class="cp"></span>
<span class="cp">#define FLH         0x47 </span><span class="cm">/* Frame Length Adjustment MSBs */</span><span class="cp"></span>
<span class="cp">#define COM19       0x48 </span><span class="cm">/* Zoom: Vertical start point */</span><span class="cp"></span>
<span class="cp">#define ZOOMS       0x49 </span><span class="cm">/* Zoom: Vertical start point */</span><span class="cp"></span>
<span class="cp">#define COM22       0x4B </span><span class="cm">/* Flash light control */</span><span class="cp"></span>
<span class="cp">#define COM25       0x4E </span><span class="cm">/* For Banding operations */</span><span class="cp"></span>
<span class="cp">#define BD50        0x4F </span><span class="cm">/* 50Hz Banding AEC 8 LSBs */</span><span class="cp"></span>
<span class="cp">#define BD60        0x50 </span><span class="cm">/* 60Hz Banding AEC 8 LSBs */</span><span class="cp"></span>
<span class="cp">#define REG5D       0x5D </span><span class="cm">/* AVGsel[7:0],   16-zone average weight option */</span><span class="cp"></span>
<span class="cp">#define REG5E       0x5E </span><span class="cm">/* AVGsel[15:8],  16-zone average weight option */</span><span class="cp"></span>
<span class="cp">#define REG5F       0x5F </span><span class="cm">/* AVGsel[23:16], 16-zone average weight option */</span><span class="cp"></span>
<span class="cp">#define REG60       0x60 </span><span class="cm">/* AVGsel[31:24], 16-zone average weight option */</span><span class="cp"></span>
<span class="cp">#define HISTO_LOW   0x61 </span><span class="cm">/* Histogram Algorithm Low Level */</span><span class="cp"></span>
<span class="cp">#define HISTO_HIGH  0x62 </span><span class="cm">/* Histogram Algorithm High Level */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * ID</span>
<span class="cm"> */</span>
<span class="cp">#define MANUFACTURER_ID	0x7FA2</span>
<span class="cp">#define PID_OV2640	0x2642</span>
<span class="cp">#define VERSION(pid, ver) ((pid &lt;&lt; 8) | (ver &amp; 0xFF))</span>

<span class="cm">/*</span>
<span class="cm"> * Struct</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regval_list</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg_num</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Supported resolutions */</span>
<span class="k">enum</span> <span class="n">ov2640_width</span> <span class="p">{</span>
	<span class="n">W_QCIF</span>	<span class="o">=</span> <span class="mi">176</span><span class="p">,</span>
	<span class="n">W_QVGA</span>	<span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
	<span class="n">W_CIF</span>	<span class="o">=</span> <span class="mi">352</span><span class="p">,</span>
	<span class="n">W_VGA</span>	<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="n">W_SVGA</span>	<span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
	<span class="n">W_XGA</span>	<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="n">W_SXGA</span>	<span class="o">=</span> <span class="mi">1280</span><span class="p">,</span>
	<span class="n">W_UXGA</span>	<span class="o">=</span> <span class="mi">1600</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ov2640_height</span> <span class="p">{</span>
	<span class="n">H_QCIF</span>	<span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
	<span class="n">H_QVGA</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	<span class="n">H_CIF</span>	<span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
	<span class="n">H_VGA</span>	<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="n">H_SVGA</span>	<span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
	<span class="n">H_XGA</span>	<span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
	<span class="n">H_SXGA</span>	<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="n">H_UXGA</span>	<span class="o">=</span> <span class="mi">1200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ov2640_win_size</span> <span class="p">{</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ov2640_width</span>		<span class="n">width</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ov2640_height</span>		<span class="n">height</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">ov2640_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span>		<span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span>	<span class="n">hdl</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span>	<span class="n">cfmt_code</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ov2640_win_size</span>	<span class="o">*</span><span class="n">win</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">model</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Registers settings</span>
<span class="cm"> */</span>

<span class="cp">#define ENDMARKER { 0xff, 0xff }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_init_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">BANK_SEL</span><span class="p">,</span> <span class="n">BANK_SEL_DSP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2c</span><span class="p">,</span>   <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2e</span><span class="p">,</span>   <span class="mh">0xdf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BANK_SEL</span><span class="p">,</span> <span class="n">BANK_SEL_SENS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3c</span><span class="p">,</span>   <span class="mh">0x32</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CLKRC</span><span class="p">,</span> <span class="n">CLKRC_DIV_SET</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">COM2</span><span class="p">,</span> <span class="n">COM2_OCAP_Nx_SET</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">REG04</span><span class="p">,</span> <span class="n">REG04_DEF</span> <span class="o">|</span> <span class="n">REG04_HREF_EN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">COM8</span><span class="p">,</span>  <span class="n">COM8_DEF</span> <span class="o">|</span> <span class="n">COM8_BNDF_EN</span> <span class="o">|</span> <span class="n">COM8_AGC_EN</span> <span class="o">|</span> <span class="n">COM8_AEC_EN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">COM9</span><span class="p">,</span> <span class="n">COM9_AGC_GAIN_8x</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2c</span><span class="p">,</span>   <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x33</span><span class="p">,</span>   <span class="mh">0x78</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3a</span><span class="p">,</span>   <span class="mh">0x33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3b</span><span class="p">,</span>   <span class="mh">0xfb</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3e</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x43</span><span class="p">,</span>   <span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span>   <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span>   <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x35</span><span class="p">,</span>   <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span>   <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x37</span><span class="p">,</span>   <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x23</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ARCOM2</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span>   <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span>   <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span>   <span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span>   <span class="mh">0xb7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span>   <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4c</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4a</span><span class="p">,</span>   <span class="mh">0x81</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span>   <span class="mh">0x99</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AEW</span><span class="p">,</span>    <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AEB</span><span class="p">,</span>    <span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VV</span><span class="p">,</span>     <span class="n">VV_HIGH_TH_SET</span><span class="p">(</span><span class="mh">0x08</span><span class="p">)</span> <span class="o">|</span> <span class="n">VV_LOW_TH_SET</span><span class="p">(</span><span class="mh">0x02</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5c</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FLL</span><span class="p">,</span>    <span class="mh">0x22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">COM3</span><span class="p">,</span>   <span class="mh">0x38</span> <span class="o">|</span> <span class="n">COM3_BAND_AUTO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">REG5D</span><span class="p">,</span>  <span class="mh">0x55</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">REG5E</span><span class="p">,</span>  <span class="mh">0x7d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">REG5F</span><span class="p">,</span>  <span class="mh">0x7d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">REG60</span><span class="p">,</span>  <span class="mh">0x55</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HISTO_LOW</span><span class="p">,</span>   <span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HISTO_HIGH</span><span class="p">,</span>  <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x7c</span><span class="p">,</span>   <span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span>   <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span>   <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x6c</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x6d</span><span class="p">,</span>   <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x6e</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x70</span><span class="p">,</span>   <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x71</span><span class="p">,</span>   <span class="mh">0x94</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span>   <span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3d</span><span class="p">,</span>   <span class="mh">0x34</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">COM7</span><span class="p">,</span> <span class="n">COM7_RES_UXGA</span> <span class="o">|</span> <span class="n">COM7_ZOOM_EN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5a</span><span class="p">,</span>   <span class="mh">0x57</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BD50</span><span class="p">,</span>   <span class="mh">0xbb</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BD60</span><span class="p">,</span>   <span class="mh">0x9c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BANK_SEL</span><span class="p">,</span> <span class="n">BANK_SEL_DSP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xe5</span><span class="p">,</span>   <span class="mh">0x7f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MC_BIST</span><span class="p">,</span> <span class="n">MC_BIST_RESET</span> <span class="o">|</span> <span class="n">MC_BIST_BOOT_ROM_SEL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x41</span><span class="p">,</span>   <span class="mh">0x24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">RESET</span><span class="p">,</span> <span class="n">RESET_JPEG</span> <span class="o">|</span> <span class="n">RESET_DVP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x76</span><span class="p">,</span>   <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x33</span><span class="p">,</span>   <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x42</span><span class="p">,</span>   <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x43</span><span class="p">,</span>   <span class="mh">0x18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4c</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CTRL3</span><span class="p">,</span> <span class="n">CTRL3_BPC_EN</span> <span class="o">|</span> <span class="n">CTRL3_WPC_EN</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x88</span><span class="p">,</span>   <span class="mh">0x3f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xd7</span><span class="p">,</span>   <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xd9</span><span class="p">,</span>   <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">R_DVP_SP</span> <span class="p">,</span> <span class="n">R_DVP_SP_AUTO_MODE</span> <span class="o">|</span> <span class="mh">0x2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xc8</span><span class="p">,</span>   <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xc9</span><span class="p">,</span>   <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPADDR</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPDATA</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPADDR</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPDATA</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPDATA</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPADDR</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPDATA</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPDATA</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPDATA</span><span class="p">,</span> <span class="mh">0x0e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x90</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x0e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x1a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x5a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x69</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x75</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x7e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x8f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x96</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0xa3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0xaf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0xc4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0xd7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0xe8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x91</span><span class="p">,</span>   <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x92</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0xe3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x96</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x28</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x98</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa4</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa8</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xc5</span><span class="p">,</span>   <span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xc6</span><span class="p">,</span>   <span class="mh">0x51</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xbf</span><span class="p">,</span>   <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xc7</span><span class="p">,</span>   <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb6</span><span class="p">,</span>   <span class="mh">0x66</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb8</span><span class="p">,</span>   <span class="mh">0xA5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb7</span><span class="p">,</span>   <span class="mh">0x64</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb9</span><span class="p">,</span>   <span class="mh">0x7C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb3</span><span class="p">,</span>   <span class="mh">0xaf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb4</span><span class="p">,</span>   <span class="mh">0x97</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb5</span><span class="p">,</span>   <span class="mh">0xFF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb0</span><span class="p">,</span>   <span class="mh">0xC5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb1</span><span class="p">,</span>   <span class="mh">0x94</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb2</span><span class="p">,</span>   <span class="mh">0x0f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xc4</span><span class="p">,</span>   <span class="mh">0x5c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa6</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0xd8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x1b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0xd8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0xd8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa7</span><span class="p">,</span>   <span class="mh">0x18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x7f</span><span class="p">,</span>   <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xe5</span><span class="p">,</span>   <span class="mh">0x1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xe1</span><span class="p">,</span>   <span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xdd</span><span class="p">,</span>   <span class="mh">0x7f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CTRL0</span><span class="p">,</span>  <span class="n">CTRL0_YUV422</span> <span class="o">|</span> <span class="n">CTRL0_YUV_EN</span> <span class="o">|</span> <span class="n">CTRL0_RGB_EN</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Register settings for window size</span>
<span class="cm"> * The preamble, setup the internal DSP to input an UXGA (1600x1200) image.</span>
<span class="cm"> * Then the different zooming configurations will setup the output image size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_size_change_preamble_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">BANK_SEL</span><span class="p">,</span> <span class="n">BANK_SEL_DSP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">RESET</span><span class="p">,</span> <span class="n">RESET_DVP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HSIZE8</span><span class="p">,</span> <span class="n">HSIZE8_SET</span><span class="p">(</span><span class="n">W_UXGA</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VSIZE8</span><span class="p">,</span> <span class="n">VSIZE8_SET</span><span class="p">(</span><span class="n">H_UXGA</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CTRL2</span><span class="p">,</span> <span class="n">CTRL2_DCW_EN</span> <span class="o">|</span> <span class="n">CTRL2_SDE_EN</span> <span class="o">|</span>
		 <span class="n">CTRL2_UV_AVG_EN</span> <span class="o">|</span> <span class="n">CTRL2_CMX_EN</span> <span class="o">|</span> <span class="n">CTRL2_UV_ADJ_EN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HSIZE</span><span class="p">,</span> <span class="n">HSIZE_SET</span><span class="p">(</span><span class="n">W_UXGA</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VSIZE</span><span class="p">,</span> <span class="n">VSIZE_SET</span><span class="p">(</span><span class="n">H_UXGA</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">XOFFL</span><span class="p">,</span> <span class="n">XOFFL_SET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">YOFFL</span><span class="p">,</span> <span class="n">YOFFL_SET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VHYX</span><span class="p">,</span> <span class="n">VHYX_HSIZE_SET</span><span class="p">(</span><span class="n">W_UXGA</span><span class="p">)</span> <span class="o">|</span> <span class="n">VHYX_VSIZE_SET</span><span class="p">(</span><span class="n">H_UXGA</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VHYX_XOFF_SET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">VHYX_YOFF_SET</span><span class="p">(</span><span class="mi">0</span><span class="p">)},</span>
	<span class="p">{</span> <span class="n">TEST</span><span class="p">,</span> <span class="n">TEST_HSIZE_SET</span><span class="p">(</span><span class="n">W_UXGA</span><span class="p">)</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define PER_SIZE_REG_SEQ(x, y, v_div, h_div, pclk_div)	\</span>
<span class="cp">	{ CTRLI, CTRLI_LP_DP | CTRLI_V_DIV_SET(v_div) |	\</span>
<span class="cp">		 CTRLI_H_DIV_SET(h_div)},		\</span>
<span class="cp">	{ ZMOW, ZMOW_OUTW_SET(x) },			\</span>
<span class="cp">	{ ZMOH, ZMOH_OUTH_SET(y) },			\</span>
<span class="cp">	{ ZMHH, ZMHH_OUTW_SET(x) | ZMHH_OUTH_SET(y) },	\</span>
<span class="cp">	{ R_DVP_SP, pclk_div },				\</span>
<span class="cp">	{ RESET, 0x00}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_qcif_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_QCIF</span><span class="p">,</span> <span class="n">H_QCIF</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_qvga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_QVGA</span><span class="p">,</span> <span class="n">H_QVGA</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_cif_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_CIF</span><span class="p">,</span> <span class="n">H_CIF</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_vga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_VGA</span><span class="p">,</span> <span class="n">H_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_svga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_SVGA</span><span class="p">,</span> <span class="n">H_SVGA</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_xga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_XGA</span><span class="p">,</span> <span class="n">H_XGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="p">{</span> <span class="n">CTRLI</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_sxga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_SXGA</span><span class="p">,</span> <span class="n">H_SXGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="p">{</span> <span class="n">CTRLI</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">R_DVP_SP</span><span class="p">,</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">R_DVP_SP_AUTO_MODE</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_uxga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PER_SIZE_REG_SEQ</span><span class="p">(</span><span class="n">W_UXGA</span><span class="p">,</span> <span class="n">H_UXGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">{</span> <span class="n">CTRLI</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">R_DVP_SP</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">R_DVP_SP_AUTO_MODE</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define OV2640_SIZE(n, w, h, r) \</span>
<span class="cp">	{.name = n, .width = w , .height = h, .regs = r }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ov2640_win_size</span> <span class="n">ov2640_supported_win_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;QCIF&quot;</span><span class="p">,</span> <span class="n">W_QCIF</span><span class="p">,</span> <span class="n">H_QCIF</span><span class="p">,</span> <span class="n">ov2640_qcif_regs</span><span class="p">),</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;QVGA&quot;</span><span class="p">,</span> <span class="n">W_QVGA</span><span class="p">,</span> <span class="n">H_QVGA</span><span class="p">,</span> <span class="n">ov2640_qvga_regs</span><span class="p">),</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;CIF&quot;</span><span class="p">,</span> <span class="n">W_CIF</span><span class="p">,</span> <span class="n">H_CIF</span><span class="p">,</span> <span class="n">ov2640_cif_regs</span><span class="p">),</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;VGA&quot;</span><span class="p">,</span> <span class="n">W_VGA</span><span class="p">,</span> <span class="n">H_VGA</span><span class="p">,</span> <span class="n">ov2640_vga_regs</span><span class="p">),</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;SVGA&quot;</span><span class="p">,</span> <span class="n">W_SVGA</span><span class="p">,</span> <span class="n">H_SVGA</span><span class="p">,</span> <span class="n">ov2640_svga_regs</span><span class="p">),</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;XGA&quot;</span><span class="p">,</span> <span class="n">W_XGA</span><span class="p">,</span> <span class="n">H_XGA</span><span class="p">,</span> <span class="n">ov2640_xga_regs</span><span class="p">),</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;SXGA&quot;</span><span class="p">,</span> <span class="n">W_SXGA</span><span class="p">,</span> <span class="n">H_SXGA</span><span class="p">,</span> <span class="n">ov2640_sxga_regs</span><span class="p">),</span>
	<span class="n">OV2640_SIZE</span><span class="p">(</span><span class="s">&quot;UXGA&quot;</span><span class="p">,</span> <span class="n">W_UXGA</span><span class="p">,</span> <span class="n">H_UXGA</span><span class="p">,</span> <span class="n">ov2640_uxga_regs</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Register settings for pixel formats</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_format_change_preamble_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">BANK_SEL</span><span class="p">,</span> <span class="n">BANK_SEL_DSP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">R_BYPASS</span><span class="p">,</span> <span class="n">R_BYPASS_USE_DSP</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_yuv422_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">IMAGE_MODE</span><span class="p">,</span> <span class="n">IMAGE_MODE_LBYTE_FIRST</span> <span class="o">|</span> <span class="n">IMAGE_MODE_YUV422</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x67</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">RESET</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">R_BYPASS</span><span class="p">,</span> <span class="n">R_BYPASS_USE_DSP</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov2640_rgb565_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">IMAGE_MODE</span><span class="p">,</span> <span class="n">IMAGE_MODE_LBYTE_FIRST</span> <span class="o">|</span> <span class="n">IMAGE_MODE_RGB565</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">RESET</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">R_BYPASS</span><span class="p">,</span> <span class="n">R_BYPASS_USE_DSP</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">ov2640_codes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * General functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ov2640_priv</span> <span class="o">*</span><span class="nf">to_ov2640</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">),</span> <span class="k">struct</span> <span class="n">ov2640_priv</span><span class="p">,</span>
			    <span class="n">subdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_write_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="o">*</span><span class="n">vals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">vals</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vals</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						<span class="n">vals</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">vals</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;array: 0x%02x, 0x%02x&quot;</span><span class="p">,</span>
			 <span class="n">vals</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">vals</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">vals</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_mask_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			   <span class="n">u8</span>  <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span>  <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span>  <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">set</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;masks: 0x%02x, 0x%02x&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">reset_seq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">BANK_SEL</span><span class="p">,</span> <span class="n">BANK_SEL_SENS</span><span class="p">},</span>
		<span class="p">{</span><span class="n">COM7</span><span class="p">,</span> <span class="n">COM7_SRST</span><span class="p">},</span>
		<span class="n">ENDMARKER</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reset_seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: (ret %d)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * soc_camera_ops functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ov2640_priv</span><span class="p">,</span> <span class="n">hdl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>  <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">?</span> <span class="n">REG04_VFLIP_IMG</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ov2640_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG04</span><span class="p">,</span> <span class="n">REG04_VFLIP_IMG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">?</span> <span class="n">REG04_HFLIP_IMG</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ov2640_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG04</span><span class="p">,</span> <span class="n">REG04_HFLIP_IMG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov2640_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov2640</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span>    <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span> <span class="o">||</span>
	    <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Select the nearest higher resolution for capture */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ov2640_win_size</span> <span class="o">*</span><span class="nf">ov2640_select_win</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">default_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov2640_supported_win_sizes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov2640_supported_win_sizes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span>  <span class="o">&gt;=</span> <span class="o">*</span><span class="n">width</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
			<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">default_size</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
	<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">default_size</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ov2640_supported_win_sizes</span><span class="p">[</span><span class="n">default_size</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">height</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov2640_priv</span>       <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov2640</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="o">*</span><span class="n">selected_cfmt_regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* select win */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">=</span> <span class="n">ov2640_select_win</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="cm">/* select format */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Selected cfmt RGB565&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">selected_cfmt_regs</span> <span class="o">=</span> <span class="n">ov2640_rgb565_regs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Selected cfmt YUV422&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">selected_cfmt_regs</span> <span class="o">=</span> <span class="n">ov2640_yuv422_regs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset hardware */</span>
	<span class="n">ov2640_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* initialize the sensor with default data */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Init default&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ov2640_init_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* select preamble */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Set size to %s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ov2640_size_change_preamble_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set size win */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* cfmt preamble */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Set cfmt&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ov2640_format_change_preamble_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set cfmt */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">selected_cfmt_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt_code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Error %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">ov2640_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_g_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>  <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov2640_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov2640</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">width</span> <span class="o">=</span> <span class="n">W_SVGA</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">H_SVGA</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_set_params</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">,</span>
					    <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt_code</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span>:
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span>:
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span>:
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span>:
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_set_params</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ov2640_win_size</span> <span class="o">*</span><span class="n">win</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * select suitable win</span>
<span class="cm">	 */</span>
	<span class="n">win</span> <span class="o">=</span> <span class="n">ov2640_select_win</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span>:
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span>:
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov2640_codes</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">ov2640_codes</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">W_UXGA</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">H_UXGA</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>			<span class="o">=</span> <span class="n">W_UXGA</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">H_UXGA</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span>			<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>				<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_video_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov2640_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov2640</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">midh</span><span class="p">,</span> <span class="n">midl</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check and show product ID and manufacturer ID</span>
<span class="cm">	 */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">BANK_SEL</span><span class="p">,</span> <span class="n">BANK_SEL_SENS</span><span class="p">);</span>
	<span class="n">pid</span>  <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PID</span><span class="p">);</span>
	<span class="n">ver</span>  <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VER</span><span class="p">);</span>
	<span class="n">midh</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MIDH</span><span class="p">);</span>
	<span class="n">midl</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MIDL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">VERSION</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">ver</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PID_OV2640</span>:
		<span class="n">devname</span>     <span class="o">=</span> <span class="s">&quot;ov2640&quot;</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">V4L2_IDENT_OV2640</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Product ID error %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;%s Product ID %0x:%0x Manufacturer ID %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">devname</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">midh</span><span class="p">,</span> <span class="n">midl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">ov2640_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">ov2640_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">ov2640_subdev_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span>	<span class="o">=</span> <span class="n">ov2640_g_chip_ident</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span>	<span class="o">=</span> <span class="n">ov2640_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span>	<span class="o">=</span> <span class="n">ov2640_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_g_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span> <span class="o">|</span> <span class="n">V4L2_MBUS_MASTER</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span> <span class="o">|</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">soc_camera_apply_board_flags</span><span class="p">(</span><span class="n">icl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">ov2640_subdev_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span>	<span class="o">=</span> <span class="n">ov2640_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov2640_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov2640_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov2640_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cropcap</span>	<span class="o">=</span> <span class="n">ov2640_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_crop</span>		<span class="o">=</span> <span class="n">ov2640_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov2640_enum_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_config</span>	<span class="o">=</span> <span class="n">ov2640_g_mbus_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">ov2640_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ov2640_subdev_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ov2640_subdev_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * i2c_driver functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov2640_priv</span>	<span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span>	<span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>	<span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;OV2640: Missing platform_data for driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;OV2640: I2C-Adapter doesn&#39;t support SMBUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ov2640_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate memory for private data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov2640_subdev_ops</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov2640_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_VFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov2640_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_HFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov2640_video_probe</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OV2640 Probed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov2640_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov2640_priv</span>       <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov2640</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ov2640_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ov2640&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ov2640_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ov2640_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ov2640&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">ov2640_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">ov2640_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ov2640_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">ov2640_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SoC Camera driver for Omni Vision 2640 sensor&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Alberto Panizzo&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
