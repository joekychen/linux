<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › ov9740.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ov9740.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * OmniVision OV9740 Camera Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 NVIDIA Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Based on ov9640 camera driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>

<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>

<span class="cp">#define to_ov9740(sd)		container_of(sd, struct ov9740_priv, subdev)</span>

<span class="cm">/* General Status Registers */</span>
<span class="cp">#define OV9740_MODEL_ID_HI		0x0000</span>
<span class="cp">#define OV9740_MODEL_ID_LO		0x0001</span>
<span class="cp">#define OV9740_REVISION_NUMBER		0x0002</span>
<span class="cp">#define OV9740_MANUFACTURER_ID		0x0003</span>
<span class="cp">#define OV9740_SMIA_VERSION		0x0004</span>

<span class="cm">/* General Setup Registers */</span>
<span class="cp">#define OV9740_MODE_SELECT		0x0100</span>
<span class="cp">#define OV9740_IMAGE_ORT		0x0101</span>
<span class="cp">#define OV9740_SOFTWARE_RESET		0x0103</span>
<span class="cp">#define OV9740_GRP_PARAM_HOLD		0x0104</span>
<span class="cp">#define OV9740_MSK_CORRUP_FM		0x0105</span>

<span class="cm">/* Timing Setting */</span>
<span class="cp">#define OV9740_FRM_LENGTH_LN_HI		0x0340 </span><span class="cm">/* VTS */</span><span class="cp"></span>
<span class="cp">#define OV9740_FRM_LENGTH_LN_LO		0x0341 </span><span class="cm">/* VTS */</span><span class="cp"></span>
<span class="cp">#define OV9740_LN_LENGTH_PCK_HI		0x0342 </span><span class="cm">/* HTS */</span><span class="cp"></span>
<span class="cp">#define OV9740_LN_LENGTH_PCK_LO		0x0343 </span><span class="cm">/* HTS */</span><span class="cp"></span>
<span class="cp">#define OV9740_X_ADDR_START_HI		0x0344</span>
<span class="cp">#define OV9740_X_ADDR_START_LO		0x0345</span>
<span class="cp">#define OV9740_Y_ADDR_START_HI		0x0346</span>
<span class="cp">#define OV9740_Y_ADDR_START_LO		0x0347</span>
<span class="cp">#define OV9740_X_ADDR_END_HI		0x0348</span>
<span class="cp">#define OV9740_X_ADDR_END_LO		0x0349</span>
<span class="cp">#define OV9740_Y_ADDR_END_HI		0x034a</span>
<span class="cp">#define OV9740_Y_ADDR_END_LO		0x034b</span>
<span class="cp">#define OV9740_X_OUTPUT_SIZE_HI		0x034c</span>
<span class="cp">#define OV9740_X_OUTPUT_SIZE_LO		0x034d</span>
<span class="cp">#define OV9740_Y_OUTPUT_SIZE_HI		0x034e</span>
<span class="cp">#define OV9740_Y_OUTPUT_SIZE_LO		0x034f</span>

<span class="cm">/* IO Control Registers */</span>
<span class="cp">#define OV9740_IO_CREL00		0x3002</span>
<span class="cp">#define OV9740_IO_CREL01		0x3004</span>
<span class="cp">#define OV9740_IO_CREL02		0x3005</span>
<span class="cp">#define OV9740_IO_OUTPUT_SEL01		0x3026</span>
<span class="cp">#define OV9740_IO_OUTPUT_SEL02		0x3027</span>

<span class="cm">/* AWB Registers */</span>
<span class="cp">#define OV9740_AWB_MANUAL_CTRL		0x3406</span>

<span class="cm">/* Analog Control Registers */</span>
<span class="cp">#define OV9740_ANALOG_CTRL01		0x3601</span>
<span class="cp">#define OV9740_ANALOG_CTRL02		0x3602</span>
<span class="cp">#define OV9740_ANALOG_CTRL03		0x3603</span>
<span class="cp">#define OV9740_ANALOG_CTRL04		0x3604</span>
<span class="cp">#define OV9740_ANALOG_CTRL10		0x3610</span>
<span class="cp">#define OV9740_ANALOG_CTRL12		0x3612</span>
<span class="cp">#define OV9740_ANALOG_CTRL15		0x3615</span>
<span class="cp">#define OV9740_ANALOG_CTRL20		0x3620</span>
<span class="cp">#define OV9740_ANALOG_CTRL21		0x3621</span>
<span class="cp">#define OV9740_ANALOG_CTRL22		0x3622</span>
<span class="cp">#define OV9740_ANALOG_CTRL30		0x3630</span>
<span class="cp">#define OV9740_ANALOG_CTRL31		0x3631</span>
<span class="cp">#define OV9740_ANALOG_CTRL32		0x3632</span>
<span class="cp">#define OV9740_ANALOG_CTRL33		0x3633</span>

<span class="cm">/* Sensor Control */</span>
<span class="cp">#define OV9740_SENSOR_CTRL03		0x3703</span>
<span class="cp">#define OV9740_SENSOR_CTRL04		0x3704</span>
<span class="cp">#define OV9740_SENSOR_CTRL05		0x3705</span>
<span class="cp">#define OV9740_SENSOR_CTRL07		0x3707</span>

<span class="cm">/* Timing Control */</span>
<span class="cp">#define OV9740_TIMING_CTRL17		0x3817</span>
<span class="cp">#define OV9740_TIMING_CTRL19		0x3819</span>
<span class="cp">#define OV9740_TIMING_CTRL33		0x3833</span>
<span class="cp">#define OV9740_TIMING_CTRL35		0x3835</span>

<span class="cm">/* Banding Filter */</span>
<span class="cp">#define OV9740_AEC_MAXEXPO_60_H		0x3a02</span>
<span class="cp">#define OV9740_AEC_MAXEXPO_60_L		0x3a03</span>
<span class="cp">#define OV9740_AEC_B50_STEP_HI		0x3a08</span>
<span class="cp">#define OV9740_AEC_B50_STEP_LO		0x3a09</span>
<span class="cp">#define OV9740_AEC_B60_STEP_HI		0x3a0a</span>
<span class="cp">#define OV9740_AEC_B60_STEP_LO		0x3a0b</span>
<span class="cp">#define OV9740_AEC_CTRL0D		0x3a0d</span>
<span class="cp">#define OV9740_AEC_CTRL0E		0x3a0e</span>
<span class="cp">#define OV9740_AEC_MAXEXPO_50_H		0x3a14</span>
<span class="cp">#define OV9740_AEC_MAXEXPO_50_L		0x3a15</span>

<span class="cm">/* AEC/AGC Control */</span>
<span class="cp">#define OV9740_AEC_ENABLE		0x3503</span>
<span class="cp">#define OV9740_GAIN_CEILING_01		0x3a18</span>
<span class="cp">#define OV9740_GAIN_CEILING_02		0x3a19</span>
<span class="cp">#define OV9740_AEC_HI_THRESHOLD		0x3a11</span>
<span class="cp">#define OV9740_AEC_3A1A			0x3a1a</span>
<span class="cp">#define OV9740_AEC_CTRL1B_WPT2		0x3a1b</span>
<span class="cp">#define OV9740_AEC_CTRL0F_WPT		0x3a0f</span>
<span class="cp">#define OV9740_AEC_CTRL10_BPT		0x3a10</span>
<span class="cp">#define OV9740_AEC_CTRL1E_BPT2		0x3a1e</span>
<span class="cp">#define OV9740_AEC_LO_THRESHOLD		0x3a1f</span>

<span class="cm">/* BLC Control */</span>
<span class="cp">#define OV9740_BLC_AUTO_ENABLE		0x4002</span>
<span class="cp">#define OV9740_BLC_MODE			0x4005</span>

<span class="cm">/* VFIFO */</span>
<span class="cp">#define OV9740_VFIFO_READ_START_HI	0x4608</span>
<span class="cp">#define OV9740_VFIFO_READ_START_LO	0x4609</span>

<span class="cm">/* DVP Control */</span>
<span class="cp">#define OV9740_DVP_VSYNC_CTRL02		0x4702</span>
<span class="cp">#define OV9740_DVP_VSYNC_MODE		0x4704</span>
<span class="cp">#define OV9740_DVP_VSYNC_CTRL06		0x4706</span>

<span class="cm">/* PLL Setting */</span>
<span class="cp">#define OV9740_PLL_MODE_CTRL01		0x3104</span>
<span class="cp">#define OV9740_PRE_PLL_CLK_DIV		0x0305</span>
<span class="cp">#define OV9740_PLL_MULTIPLIER		0x0307</span>
<span class="cp">#define OV9740_VT_SYS_CLK_DIV		0x0303</span>
<span class="cp">#define OV9740_VT_PIX_CLK_DIV		0x0301</span>
<span class="cp">#define OV9740_PLL_CTRL3010		0x3010</span>
<span class="cp">#define OV9740_VFIFO_CTRL00		0x460e</span>

<span class="cm">/* ISP Control */</span>
<span class="cp">#define OV9740_ISP_CTRL00		0x5000</span>
<span class="cp">#define OV9740_ISP_CTRL01		0x5001</span>
<span class="cp">#define OV9740_ISP_CTRL03		0x5003</span>
<span class="cp">#define OV9740_ISP_CTRL05		0x5005</span>
<span class="cp">#define OV9740_ISP_CTRL12		0x5012</span>
<span class="cp">#define OV9740_ISP_CTRL19		0x5019</span>
<span class="cp">#define OV9740_ISP_CTRL1A		0x501a</span>
<span class="cp">#define OV9740_ISP_CTRL1E		0x501e</span>
<span class="cp">#define OV9740_ISP_CTRL1F		0x501f</span>
<span class="cp">#define OV9740_ISP_CTRL20		0x5020</span>
<span class="cp">#define OV9740_ISP_CTRL21		0x5021</span>

<span class="cm">/* AWB */</span>
<span class="cp">#define OV9740_AWB_CTRL00		0x5180</span>
<span class="cp">#define OV9740_AWB_CTRL01		0x5181</span>
<span class="cp">#define OV9740_AWB_CTRL02		0x5182</span>
<span class="cp">#define OV9740_AWB_CTRL03		0x5183</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL01		0x5184</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL02		0x5185</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL03		0x5186</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL04		0x5187</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL05		0x5188</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL06		0x5189</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL07		0x518a</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL08		0x518b</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL09		0x518c</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL10		0x518d</span>
<span class="cp">#define OV9740_AWB_ADV_CTRL11		0x518e</span>
<span class="cp">#define OV9740_AWB_CTRL0F		0x518f</span>
<span class="cp">#define OV9740_AWB_CTRL10		0x5190</span>
<span class="cp">#define OV9740_AWB_CTRL11		0x5191</span>
<span class="cp">#define OV9740_AWB_CTRL12		0x5192</span>
<span class="cp">#define OV9740_AWB_CTRL13		0x5193</span>
<span class="cp">#define OV9740_AWB_CTRL14		0x5194</span>

<span class="cm">/* MIPI Control */</span>
<span class="cp">#define OV9740_MIPI_CTRL00		0x4800</span>
<span class="cp">#define OV9740_MIPI_3837		0x3837</span>
<span class="cp">#define OV9740_MIPI_CTRL01		0x4801</span>
<span class="cp">#define OV9740_MIPI_CTRL03		0x4803</span>
<span class="cp">#define OV9740_MIPI_CTRL05		0x4805</span>
<span class="cp">#define OV9740_VFIFO_RD_CTRL		0x4601</span>
<span class="cp">#define OV9740_MIPI_CTRL_3012		0x3012</span>
<span class="cp">#define OV9740_SC_CMMM_MIPI_CTR		0x3014</span>

<span class="cp">#define OV9740_MAX_WIDTH		1280</span>
<span class="cp">#define OV9740_MAX_HEIGHT		720</span>

<span class="cm">/* Misc. structures */</span>
<span class="k">struct</span> <span class="n">ov9740_reg</span> <span class="p">{</span>
	<span class="n">u16</span>				<span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span>		<span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span>	<span class="n">hdl</span><span class="p">;</span>

	<span class="kt">int</span>				<span class="n">ident</span><span class="p">;</span>
	<span class="n">u16</span>				<span class="n">model</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">revision</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">manid</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">smiaver</span><span class="p">;</span>

	<span class="n">bool</span>				<span class="n">flag_vflip</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">flag_hflip</span><span class="p">;</span>

	<span class="cm">/* For suspend/resume. */</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span>	<span class="n">current_mf</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">current_enable</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ov9740_reg</span> <span class="n">ov9740_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Software Reset */</span>
	<span class="p">{</span> <span class="n">OV9740_SOFTWARE_RESET</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>

	<span class="cm">/* Banding Filter */</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_B50_STEP_HI</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_B50_STEP_LO</span><span class="p">,</span>	<span class="mh">0xe8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_CTRL0E</span><span class="p">,</span>		<span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_MAXEXPO_50_H</span><span class="p">,</span>	<span class="mh">0x15</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_MAXEXPO_50_L</span><span class="p">,</span>	<span class="mh">0xc6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_B60_STEP_HI</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_B60_STEP_LO</span><span class="p">,</span>	<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_CTRL0D</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_MAXEXPO_60_H</span><span class="p">,</span>	<span class="mh">0x18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_MAXEXPO_60_L</span><span class="p">,</span>	<span class="mh">0x20</span> <span class="p">},</span>

	<span class="cm">/* LC */</span>
	<span class="p">{</span> <span class="mh">0x5842</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5843</span><span class="p">,</span> <span class="mh">0x5e</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5844</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5845</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5846</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5847</span><span class="p">,</span> <span class="mh">0x29</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5848</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5849</span><span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>

	<span class="cm">/* Un-documented OV9740 registers */</span>
	<span class="p">{</span> <span class="mh">0x5800</span><span class="p">,</span> <span class="mh">0x29</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5801</span><span class="p">,</span> <span class="mh">0x25</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5802</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5803</span><span class="p">,</span> <span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5804</span><span class="p">,</span> <span class="mh">0x26</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5805</span><span class="p">,</span> <span class="mh">0x2e</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5806</span><span class="p">,</span> <span class="mh">0x11</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5807</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5808</span><span class="p">,</span> <span class="mh">0x09</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5809</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x580a</span><span class="p">,</span> <span class="mh">0x0e</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x580b</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x580c</span><span class="p">,</span> <span class="mh">0x06</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x580d</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x580e</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x580f</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5810</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5811</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5812</span><span class="p">,</span> <span class="mh">0x05</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5813</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5814</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5815</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5816</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5817</span><span class="p">,</span> <span class="mh">0x09</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5818</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5819</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x581a</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x581b</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x581c</span><span class="p">,</span> <span class="mh">0x0b</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x581d</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x581e</span><span class="p">,</span> <span class="mh">0x28</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x581f</span><span class="p">,</span> <span class="mh">0x23</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5820</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5821</span><span class="p">,</span> <span class="mh">0x1e</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5822</span><span class="p">,</span> <span class="mh">0x24</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5823</span><span class="p">,</span> <span class="mh">0x2a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5824</span><span class="p">,</span> <span class="mh">0x4f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5825</span><span class="p">,</span> <span class="mh">0x6f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5826</span><span class="p">,</span> <span class="mh">0x5f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5827</span><span class="p">,</span> <span class="mh">0x7f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5828</span><span class="p">,</span> <span class="mh">0x9f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5829</span><span class="p">,</span> <span class="mh">0x5f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x582a</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x582b</span><span class="p">,</span> <span class="mh">0x9e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x582c</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x582d</span><span class="p">,</span> <span class="mh">0x9f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x582e</span><span class="p">,</span> <span class="mh">0x4f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x582f</span><span class="p">,</span> <span class="mh">0x87</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5830</span><span class="p">,</span> <span class="mh">0x86</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5831</span><span class="p">,</span> <span class="mh">0x97</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5832</span><span class="p">,</span> <span class="mh">0xae</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5833</span><span class="p">,</span> <span class="mh">0x3f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5834</span><span class="p">,</span> <span class="mh">0x8e</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5835</span><span class="p">,</span> <span class="mh">0x7c</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5836</span><span class="p">,</span> <span class="mh">0x7e</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5837</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5838</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5839</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x583a</span><span class="p">,</span> <span class="mh">0x9f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x583b</span><span class="p">,</span> <span class="mh">0x7f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x583c</span><span class="p">,</span> <span class="mh">0x5f</span> <span class="p">},</span>

	<span class="cm">/* Y Gamma */</span>
	<span class="p">{</span> <span class="mh">0x5480</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5481</span><span class="p">,</span> <span class="mh">0x18</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5482</span><span class="p">,</span> <span class="mh">0x2c</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5483</span><span class="p">,</span> <span class="mh">0x4e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5484</span><span class="p">,</span> <span class="mh">0x5e</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5485</span><span class="p">,</span> <span class="mh">0x6b</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5486</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5487</span><span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5488</span><span class="p">,</span> <span class="mh">0x8c</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5489</span><span class="p">,</span> <span class="mh">0x95</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x548a</span><span class="p">,</span> <span class="mh">0xa4</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x548b</span><span class="p">,</span> <span class="mh">0xb1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x548c</span><span class="p">,</span> <span class="mh">0xc6</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x548d</span><span class="p">,</span> <span class="mh">0xd8</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x548e</span><span class="p">,</span> <span class="mh">0xe9</span> <span class="p">},</span>

	<span class="cm">/* UV Gamma */</span>
	<span class="p">{</span> <span class="mh">0x5490</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5491</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5492</span><span class="p">,</span> <span class="mh">0x0d</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5493</span><span class="p">,</span> <span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5494</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5495</span><span class="p">,</span> <span class="mh">0x1a</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5496</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5497</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5498</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5499</span><span class="p">,</span> <span class="mh">0x53</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x549a</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x549b</span><span class="p">,</span> <span class="mh">0xeb</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x549c</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x549d</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x549e</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x549f</span><span class="p">,</span> <span class="mh">0x67</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x54a0</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54a1</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54a2</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54a3</span><span class="p">,</span> <span class="mh">0x18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x54a4</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54a5</span><span class="p">,</span> <span class="mh">0xe7</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54a6</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54a7</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x54a8</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54a9</span><span class="p">,</span> <span class="mh">0x94</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54aa</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54ab</span><span class="p">,</span> <span class="mh">0x72</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x54ac</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x54ad</span><span class="p">,</span> <span class="mh">0x57</span> <span class="p">},</span>

	<span class="cm">/* AWB */</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL00</span><span class="p">,</span>		<span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL01</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL02</span><span class="p">,</span>		<span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL03</span><span class="p">,</span>		<span class="mh">0x42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL01</span><span class="p">,</span>	<span class="mh">0x8a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL02</span><span class="p">,</span>	<span class="mh">0x61</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL03</span><span class="p">,</span>	<span class="mh">0xce</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL04</span><span class="p">,</span>	<span class="mh">0xa8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL05</span><span class="p">,</span>	<span class="mh">0x17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL06</span><span class="p">,</span>	<span class="mh">0x1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL07</span><span class="p">,</span>	<span class="mh">0x27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL08</span><span class="p">,</span>	<span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL09</span><span class="p">,</span>	<span class="mh">0x34</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL10</span><span class="p">,</span>	<span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_ADV_CTRL11</span><span class="p">,</span>	<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL0F</span><span class="p">,</span>		<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL10</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL11</span><span class="p">,</span>		<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL12</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL13</span><span class="p">,</span>		<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_CTRL14</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>

	<span class="cm">/* CIP */</span>
	<span class="p">{</span> <span class="mh">0x530d</span><span class="p">,</span> <span class="mh">0x12</span> <span class="p">},</span>

	<span class="cm">/* CMX */</span>
	<span class="p">{</span> <span class="mh">0x5380</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5381</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5382</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5383</span><span class="p">,</span> <span class="mh">0x17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5384</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5385</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5386</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5387</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5388</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5389</span><span class="p">,</span> <span class="mh">0xe0</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x538a</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x538b</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x538c</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x538d</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x538e</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x538f</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5390</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5391</span><span class="p">,</span> <span class="mh">0x9c</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5392</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x5393</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5394</span><span class="p">,</span> <span class="mh">0x18</span> <span class="p">},</span>

	<span class="cm">/* 50/60 Detection */</span>
	<span class="p">{</span> <span class="mh">0x3c0a</span><span class="p">,</span> <span class="mh">0x9c</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x3c0b</span><span class="p">,</span> <span class="mh">0x3f</span> <span class="p">},</span>

	<span class="cm">/* Output Select */</span>
	<span class="p">{</span> <span class="n">OV9740_IO_OUTPUT_SEL01</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_IO_OUTPUT_SEL02</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_IO_CREL00</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_IO_CREL01</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_IO_CREL02</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>

	<span class="cm">/* AWB Control */</span>
	<span class="p">{</span> <span class="n">OV9740_AWB_MANUAL_CTRL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>

	<span class="cm">/* Analog Control */</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL03</span><span class="p">,</span>		<span class="mh">0xaa</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL32</span><span class="p">,</span>		<span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL20</span><span class="p">,</span>		<span class="mh">0x66</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL21</span><span class="p">,</span>		<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL31</span><span class="p">,</span>		<span class="mh">0x52</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL33</span><span class="p">,</span>		<span class="mh">0x50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL30</span><span class="p">,</span>		<span class="mh">0xca</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL04</span><span class="p">,</span>		<span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL01</span><span class="p">,</span>		<span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL02</span><span class="p">,</span>		<span class="mh">0x16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL10</span><span class="p">,</span>		<span class="mh">0xa1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL12</span><span class="p">,</span>		<span class="mh">0x24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL22</span><span class="p">,</span>		<span class="mh">0x9f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_ANALOG_CTRL15</span><span class="p">,</span>		<span class="mh">0xf0</span> <span class="p">},</span>

	<span class="cm">/* Sensor Control */</span>
	<span class="p">{</span> <span class="n">OV9740_SENSOR_CTRL03</span><span class="p">,</span>		<span class="mh">0x42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_SENSOR_CTRL04</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_SENSOR_CTRL05</span><span class="p">,</span>		<span class="mh">0x45</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_SENSOR_CTRL07</span><span class="p">,</span>		<span class="mh">0x14</span> <span class="p">},</span>

	<span class="cm">/* Timing Control */</span>
	<span class="p">{</span> <span class="n">OV9740_TIMING_CTRL33</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_TIMING_CTRL35</span><span class="p">,</span>		<span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_TIMING_CTRL19</span><span class="p">,</span>		<span class="mh">0x6e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_TIMING_CTRL17</span><span class="p">,</span>		<span class="mh">0x94</span> <span class="p">},</span>

	<span class="cm">/* AEC/AGC Control */</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_ENABLE</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_GAIN_CEILING_01</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_GAIN_CEILING_02</span><span class="p">,</span>	<span class="mh">0x7f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_HI_THRESHOLD</span><span class="p">,</span>	<span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_3A1A</span><span class="p">,</span>		<span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_CTRL1B_WPT2</span><span class="p">,</span>	<span class="mh">0x50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_CTRL0F_WPT</span><span class="p">,</span>	<span class="mh">0x50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_CTRL10_BPT</span><span class="p">,</span>	<span class="mh">0x4c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_CTRL1E_BPT2</span><span class="p">,</span>	<span class="mh">0x4c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_AEC_LO_THRESHOLD</span><span class="p">,</span>	<span class="mh">0x26</span> <span class="p">},</span>

	<span class="cm">/* BLC Control */</span>
	<span class="p">{</span> <span class="n">OV9740_BLC_AUTO_ENABLE</span><span class="p">,</span>	<span class="mh">0x45</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_BLC_MODE</span><span class="p">,</span>		<span class="mh">0x18</span> <span class="p">},</span>

	<span class="cm">/* DVP Control */</span>
	<span class="p">{</span> <span class="n">OV9740_DVP_VSYNC_CTRL02</span><span class="p">,</span>	<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_DVP_VSYNC_MODE</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_DVP_VSYNC_CTRL06</span><span class="p">,</span>	<span class="mh">0x08</span> <span class="p">},</span>

	<span class="cm">/* PLL Setting */</span>
	<span class="p">{</span> <span class="n">OV9740_PLL_MODE_CTRL01</span><span class="p">,</span>	<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_PRE_PLL_CLK_DIV</span><span class="p">,</span>	<span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_PLL_MULTIPLIER</span><span class="p">,</span>	<span class="mh">0x4c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_VT_SYS_CLK_DIV</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_VT_PIX_CLK_DIV</span><span class="p">,</span>	<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_PLL_CTRL3010</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_VFIFO_CTRL00</span><span class="p">,</span>		<span class="mh">0x82</span> <span class="p">},</span>

	<span class="cm">/* Timing Setting */</span>
	<span class="cm">/* VTS */</span>
	<span class="p">{</span> <span class="n">OV9740_FRM_LENGTH_LN_HI</span><span class="p">,</span>	<span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_FRM_LENGTH_LN_LO</span><span class="p">,</span>	<span class="mh">0x07</span> <span class="p">},</span>
	<span class="cm">/* HTS */</span>
	<span class="p">{</span> <span class="n">OV9740_LN_LENGTH_PCK_HI</span><span class="p">,</span>	<span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_LN_LENGTH_PCK_LO</span><span class="p">,</span>	<span class="mh">0x62</span> <span class="p">},</span>

	<span class="cm">/* MIPI Control */</span>
	<span class="p">{</span> <span class="n">OV9740_MIPI_CTRL00</span><span class="p">,</span>		<span class="mh">0x44</span> <span class="p">},</span> <span class="cm">/* 0x64 for discontinuous clk */</span>
	<span class="p">{</span> <span class="n">OV9740_MIPI_3837</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_MIPI_CTRL01</span><span class="p">,</span>		<span class="mh">0x0f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_MIPI_CTRL03</span><span class="p">,</span>		<span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_MIPI_CTRL05</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_VFIFO_RD_CTRL</span><span class="p">,</span>		<span class="mh">0x16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_MIPI_CTRL_3012</span><span class="p">,</span>	<span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OV9740_SC_CMMM_MIPI_CTR</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>

	<span class="cm">/* YUYV order */</span>
	<span class="p">{</span> <span class="n">OV9740_ISP_CTRL19</span><span class="p">,</span>		<span class="mh">0x02</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">ov9740_codes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* read a register */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">val</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed reading register 0x%04x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write a register */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed writing register 0x%04x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Read a register, alter its bits, write it back */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_reg_rmw</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">set</span><span class="p">,</span> <span class="n">u8</span> <span class="n">unset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;[Read]-Modify-Write of register 0x%04x failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">unset</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Read-Modify-[Write] of register 0x%04x failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_reg_write_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">ov9740_reg</span> <span class="o">*</span><span class="n">regarray</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">regarraylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">regarraylen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				       <span class="n">regarray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">regarray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Start/Stop streaming from the device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov9740</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Program orientation register. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_vflip</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_rmw</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_IMAGE_ORT</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_rmw</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_IMAGE_ORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_hflip</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_rmw</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_IMAGE_ORT</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_rmw</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_IMAGE_ORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling Streaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Start Streaming */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_MODE_SELECT</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling Streaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Software Reset */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_SOFTWARE_RESET</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="cm">/* Setting Streaming to Standby */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_MODE_SELECT</span><span class="p">,</span>
					       <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* select nearest higher resolution for capture */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ov9740_res_roundup</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Width must be a multiple of 4 pixels. */</span>
	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Max resolution is 1280x720 (720p). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">OV9740_MAX_WIDTH</span><span class="p">)</span>
		<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">OV9740_MAX_WIDTH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">OV9740_MAX_HEIGHT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">OV9740_MAX_HEIGHT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Setup registers according to resolution and color encoding */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_set_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">x_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x_end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y_end</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">scaling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scale_input_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scale_input_y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">width</span> <span class="o">!=</span> <span class="n">OV9740_MAX_WIDTH</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">height</span> <span class="o">!=</span> <span class="n">OV9740_MAX_HEIGHT</span><span class="p">))</span>
		<span class="n">scaling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to use as much of the sensor area as possible when supporting</span>
<span class="cm">	 * smaller resolutions.  Depending on the aspect ratio of the</span>
<span class="cm">	 * chosen resolution, we can either use the full width of the sensor,</span>
<span class="cm">	 * or the full height of the sensor (or both if the aspect ratio is</span>
<span class="cm">	 * the same as 1280x720.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">OV9740_MAX_WIDTH</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">OV9740_MAX_HEIGHT</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scale_input_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">OV9740_MAX_HEIGHT</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">scale_input_y</span> <span class="o">=</span> <span class="n">OV9740_MAX_HEIGHT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scale_input_x</span> <span class="o">=</span> <span class="n">OV9740_MAX_WIDTH</span><span class="p">;</span>
		<span class="n">scale_input_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">OV9740_MAX_WIDTH</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* These describe the area of the sensor to use. */</span>
	<span class="n">x_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">OV9740_MAX_WIDTH</span> <span class="o">-</span> <span class="n">scale_input_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">y_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">OV9740_MAX_HEIGHT</span> <span class="o">-</span> <span class="n">scale_input_y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">x_end</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">scale_input_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">y_end</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">scale_input_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_X_ADDR_START_HI</span><span class="p">,</span> <span class="n">x_start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_X_ADDR_START_LO</span><span class="p">,</span> <span class="n">x_start</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_Y_ADDR_START_HI</span><span class="p">,</span> <span class="n">y_start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_Y_ADDR_START_LO</span><span class="p">,</span> <span class="n">y_start</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_X_ADDR_END_HI</span><span class="p">,</span> <span class="n">x_end</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_X_ADDR_END_LO</span><span class="p">,</span> <span class="n">x_end</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_Y_ADDR_END_HI</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_Y_ADDR_END_LO</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_X_OUTPUT_SIZE_HI</span><span class="p">,</span> <span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_X_OUTPUT_SIZE_LO</span><span class="p">,</span> <span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_Y_OUTPUT_SIZE_HI</span><span class="p">,</span> <span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_Y_OUTPUT_SIZE_LO</span><span class="p">,</span> <span class="n">height</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_ISP_CTRL1E</span><span class="p">,</span> <span class="n">scale_input_x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_ISP_CTRL1F</span><span class="p">,</span> <span class="n">scale_input_x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_ISP_CTRL20</span><span class="p">,</span> <span class="n">scale_input_y</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_ISP_CTRL21</span><span class="p">,</span> <span class="n">scale_input_y</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_VFIFO_READ_START_HI</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">scale_input_x</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_VFIFO_READ_START_LO</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">scale_input_x</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_ISP_CTRL00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_ISP_CTRL01</span><span class="p">,</span> <span class="mh">0xef</span> <span class="o">|</span>
							  <span class="p">(</span><span class="n">scaling</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_ISP_CTRL03</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set the format we will capture in */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov9740</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">v4l2_colorspace</span> <span class="n">cspace</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ov9740_res_roundup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span>:
		<span class="n">cspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ov9740_defaults</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov9740_defaults</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_set_res</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">cspace</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_mf</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ov9740_res_roundup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov9740_codes</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">ov9740_codes</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">OV9740_MAX_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">OV9740_MAX_HEIGHT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span>		<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>			<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">OV9740_MAX_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">OV9740_MAX_HEIGHT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>			<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set status of additional camera capabilities */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ov9740_priv</span><span class="p">,</span> <span class="n">hdl</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_vflip</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_hflip</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get chip identification */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov9740</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_s_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov9740</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ov9740_s_fmt</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_mf</span><span class="p">);</span>
		<span class="n">ov9740_s_stream</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_enable</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ov9740_s_stream</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_get_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_set_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffff</span> <span class="o">||</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ov9740_reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_video_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov9740</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">modelhi</span><span class="p">,</span> <span class="n">modello</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check and show product ID and manufacturer ID</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_MODEL_ID_HI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">modelhi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_MODEL_ID_LO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">modello</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="n">modelhi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">modello</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_REVISION_NUMBER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_MANUFACTURER_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">manid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OV9740_SMIA_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">smiaver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="mh">0x9740</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_OV9740</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ov9740 Model ID 0x%04x, Revision 0x%02x, &quot;</span>
		 <span class="s">&quot;Manufacturer 0x%02x, SMIA Version 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">manid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">smiaver</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Request bus settings on camera side */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_g_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span> <span class="o">|</span> <span class="n">V4L2_MBUS_MASTER</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span> <span class="o">|</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">soc_camera_apply_board_flags</span><span class="p">(</span><span class="n">icl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">ov9740_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span>	<span class="o">=</span> <span class="n">ov9740_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov9740_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov9740_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov9740_enum_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cropcap</span>	<span class="o">=</span> <span class="n">ov9740_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_crop</span>		<span class="o">=</span> <span class="n">ov9740_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_config</span>	<span class="o">=</span> <span class="n">ov9740_g_mbus_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">ov9740_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span>		<span class="o">=</span> <span class="n">ov9740_g_chip_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_power</span>		<span class="o">=</span> <span class="n">ov9740_s_power</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span>		<span class="o">=</span> <span class="n">ov9740_get_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span>		<span class="o">=</span> <span class="n">ov9740_set_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">ov9740_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">ov9740_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">ov9740_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">ov9740_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">ov9740_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * i2c_driver function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing platform_data for driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ov9740_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate private data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov9740_subdev_ops</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov9740_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_VFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov9740_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_HFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov9740_video_probe</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov9740_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov9740_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ov9740_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ov9740&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ov9740_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ov9740_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ov9740&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">ov9740_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">ov9740_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ov9740_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">ov9740_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SoC Camera driver for OmniVision OV9740&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andrew Chew &lt;achew@nvidia.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
