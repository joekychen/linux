<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › mx3_camera.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mx3_camera.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * V4L2 Driver for i.MX3x camera host</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008</span>
<span class="cm"> * Guennadi Liakhovetski, DENX Software Engineering, &lt;lg@denx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-dev.h&gt;</span>
<span class="cp">#include &lt;media/videobuf2-dma-contig.h&gt;</span>
<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/soc_mediabus.h&gt;</span>

<span class="cp">#include &lt;mach/ipu.h&gt;</span>
<span class="cp">#include &lt;mach/mx3_camera.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>

<span class="cp">#define MX3_CAM_DRV_NAME &quot;mx3-camera&quot;</span>

<span class="cm">/* CMOS Sensor Interface Registers */</span>
<span class="cp">#define CSI_REG_START		0x60</span>

<span class="cp">#define CSI_SENS_CONF		(0x60 - CSI_REG_START)</span>
<span class="cp">#define CSI_SENS_FRM_SIZE	(0x64 - CSI_REG_START)</span>
<span class="cp">#define CSI_ACT_FRM_SIZE	(0x68 - CSI_REG_START)</span>
<span class="cp">#define CSI_OUT_FRM_CTRL	(0x6C - CSI_REG_START)</span>
<span class="cp">#define CSI_TST_CTRL		(0x70 - CSI_REG_START)</span>
<span class="cp">#define CSI_CCIR_CODE_1		(0x74 - CSI_REG_START)</span>
<span class="cp">#define CSI_CCIR_CODE_2		(0x78 - CSI_REG_START)</span>
<span class="cp">#define CSI_CCIR_CODE_3		(0x7C - CSI_REG_START)</span>
<span class="cp">#define CSI_FLASH_STROBE_1	(0x80 - CSI_REG_START)</span>
<span class="cp">#define CSI_FLASH_STROBE_2	(0x84 - CSI_REG_START)</span>

<span class="cp">#define CSI_SENS_CONF_VSYNC_POL_SHIFT		0</span>
<span class="cp">#define CSI_SENS_CONF_HSYNC_POL_SHIFT		1</span>
<span class="cp">#define CSI_SENS_CONF_DATA_POL_SHIFT		2</span>
<span class="cp">#define CSI_SENS_CONF_PIX_CLK_POL_SHIFT		3</span>
<span class="cp">#define CSI_SENS_CONF_SENS_PRTCL_SHIFT		4</span>
<span class="cp">#define CSI_SENS_CONF_SENS_CLKSRC_SHIFT		7</span>
<span class="cp">#define CSI_SENS_CONF_DATA_FMT_SHIFT		8</span>
<span class="cp">#define CSI_SENS_CONF_DATA_WIDTH_SHIFT		10</span>
<span class="cp">#define CSI_SENS_CONF_EXT_VSYNC_SHIFT		15</span>
<span class="cp">#define CSI_SENS_CONF_DIVRATIO_SHIFT		16</span>

<span class="cp">#define CSI_SENS_CONF_DATA_FMT_RGB_YUV444	(0UL &lt;&lt; CSI_SENS_CONF_DATA_FMT_SHIFT)</span>
<span class="cp">#define CSI_SENS_CONF_DATA_FMT_YUV422		(2UL &lt;&lt; CSI_SENS_CONF_DATA_FMT_SHIFT)</span>
<span class="cp">#define CSI_SENS_CONF_DATA_FMT_BAYER		(3UL &lt;&lt; CSI_SENS_CONF_DATA_FMT_SHIFT)</span>

<span class="cp">#define MAX_VIDEO_MEM 16</span>

<span class="k">enum</span> <span class="n">csi_buffer_state</span> <span class="p">{</span>
	<span class="n">CSI_BUF_NEEDS_INIT</span><span class="p">,</span>
	<span class="n">CSI_BUF_PREPARED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="p">{</span>
	<span class="cm">/* common v4l buffer stuff -- must be first */</span>
	<span class="k">struct</span> <span class="n">vb2_buffer</span>			<span class="n">vb</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">csi_buffer_state</span>			<span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>			<span class="n">queue</span><span class="p">;</span>

	<span class="cm">/* One descriptot per scatterlist (per frame) */</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>		<span class="o">*</span><span class="n">txd</span><span class="p">;</span>

	<span class="cm">/* We have to &quot;build&quot; a scatterlist ourselves - one element per frame */</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>			<span class="n">sg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mx3_camera_dev - i.MX3x camera (CSI) object</span>
<span class="cm"> * @dev:		camera device, to which the coherent buffer is attached</span>
<span class="cm"> * @icd:		currently attached camera sensor</span>
<span class="cm"> * @clk:		pointer to clock</span>
<span class="cm"> * @base:		remapped register base address</span>
<span class="cm"> * @pdata:		platform data</span>
<span class="cm"> * @platform_flags:	platform flags</span>
<span class="cm"> * @mclk:		master clock frequency in Hz</span>
<span class="cm"> * @capture:		list of capture videobuffers</span>
<span class="cm"> * @lock:		protects video buffer lists</span>
<span class="cm"> * @active:		active video buffer</span>
<span class="cm"> * @idmac_channel:	array of pointers to IPU DMAC DMA channels</span>
<span class="cm"> * @soc_host:		embedded soc_host object</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * i.MX3x is only supposed to handle one camera on its Camera Sensor</span>
<span class="cm">	 * Interface. If anyone ever builds hardware to enable more than one</span>
<span class="cm">	 * camera _simultaneously_, they will have to modify this driver too</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mx3_camera_pdata</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">platform_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">mclk</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">width_flags</span><span class="p">;</span>	<span class="cm">/* max 15 bits */</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">capture</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>		<span class="cm">/* Protects video buffer lists */</span>
	<span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">buf_total</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_alloc_ctx</span>	<span class="o">*</span><span class="n">alloc_ctx</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span>		<span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">sequence</span><span class="p">;</span>

	<span class="cm">/* IDMAC / dmaengine interface */</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span>	<span class="o">*</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* We need one channel */</span>

	<span class="k">struct</span> <span class="n">soc_camera_host</span>	<span class="n">soc_host</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dma_chan_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span>	<span class="o">*</span><span class="n">mx3_cam</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ipu_channel</span>	<span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">csi_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">mx3</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">mx3</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="o">*</span><span class="nf">to_mx3_vb</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mx3_camera_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called from the IPU IDMAC ISR */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mx3_cam_dma_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idmac_tx_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">to_tx_desc</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichannel</span> <span class="o">=</span> <span class="n">to_idmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ichannel</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;callback cookie %d, active DMA 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">?</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">to_mx3_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>

		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * stop capture - without further buffers IPU_CHA_BUF0_RDY will</span>
<span class="cm">		 * not get updated</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mx3_camera_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Videobuf operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the __buffer__ (not data) size and number of buffers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_videobuf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_planes</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sizes</span><span class="p">[],</span> <span class="kt">void</span> <span class="o">*</span><span class="n">alloc_ctxs</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">soc_camera_from_vb2q</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span> <span class="o">=</span> <span class="n">soc_camera_xlate_by_fourcc</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span>
								<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_per_line</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xlate</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_mbus_bytes_per_line</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
					      <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">bytes_per_line</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_mbus_image_size</span><span class="p">(</span><span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="p">,</span> <span class="n">bytes_per_line</span><span class="p">,</span>
					  <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Called from VIDIOC_REQBUFS or in compatibility mode */</span>
		<span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">sizeimage</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">alloc_ctxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">num_buffers</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* If *num_planes != 0, we have already verified *count. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">num_planes</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="o">*</span><span class="n">count</span> <span class="o">+</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">&gt;</span> <span class="n">MAX_VIDEO_MEM</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_VIDEO_MEM</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">-</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">buf_total</span><span class="p">)</span> <span class="o">/</span>
			<span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="o">*</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">pixel_fmt</span> <span class="nf">fourcc_to_ipu_pix</span><span class="p">(</span><span class="n">__u32</span> <span class="n">fourcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Add more formats as need arises and test possibilities appear... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fourcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
		<span class="k">return</span> <span class="n">IPU_PIX_FMT_RGB24</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_UYVY</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">IPU_PIX_FMT_GENERIC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mx3_videobuf_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">soc_camera_from_vb2q</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">to_mx3_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichan</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">idmac_video_param</span> <span class="o">*</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">video</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">host_fmt</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">new_size</span><span class="p">;</span>

	<span class="n">new_size</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">sizeimage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">new_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Buffer #%d too small (%lu &lt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">new_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CSI_BUF_NEEDS_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>	<span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>		<span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>

		<span class="n">txd</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">,</span>
			<span class="n">DMA_PREP_INTERRUPT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txd</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback_param</span>	<span class="o">=</span> <span class="n">txd</span><span class="p">;</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback</span>		<span class="o">=</span> <span class="n">mx3_cam_dma_done</span><span class="p">;</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span>		<span class="o">=</span> <span class="n">CSI_BUF_PREPARED</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">txd</span>		<span class="o">=</span> <span class="n">txd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txd</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>

	<span class="cm">/* This is the configuration of one sg-element */</span>
	<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_pixel_fmt</span> <span class="o">=</span> <span class="n">fourcc_to_ipu_pix</span><span class="p">(</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">out_pixel_fmt</span> <span class="o">==</span> <span class="n">IPU_PIX_FMT_GENERIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the IPU DMA channel is configured to transfer generic</span>
<span class="cm">		 * 8-bit data, we have to set up the geometry parameters</span>
<span class="cm">		 * correctly, according to the current pixel format. The DMA</span>
<span class="cm">		 * horizontal parameters in this case are expressed in bytes,</span>
<span class="cm">		 * not in pixels.</span>
<span class="cm">		 */</span>
		<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_width</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>
		<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_height</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">;</span>
		<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_stride</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For IPU known formats the pixel unit will be managed</span>
<span class="cm">		 * successfully by the IPU code</span>
<span class="cm">		 */</span>
		<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_width</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">;</span>
		<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_height</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">;</span>
		<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_stride</span>	<span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="cm">/* helps to see what DMA actually has written */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vb2_plane_vaddr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">vb2_plane_vaddr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">vb2_get_plane_payload</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Submitted cookie %d DMA 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cookie</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Submit error */</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mx3_videobuf_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">soc_camera_from_vb2q</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">to_mx3_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
		<span class="s">&quot;Release%s DMA 0x%08x, queue %sempty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="n">buf</span> <span class="o">?</span> <span class="s">&quot; active&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">),</span>
		<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Doesn&#39;t hurt also if the list is empty */</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CSI_BUF_NEEDS_INIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">async_tx_ack</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">-=</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_videobuf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">soc_camera_from_vb2q</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">to_mx3_vb</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>

	<span class="cm">/* This is for locking debugging only */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CSI_BUF_NEEDS_INIT</span><span class="p">;</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">+=</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_stop_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">soc_camera_from_vb2q</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichan</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mx3_camera_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ichan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">DMA_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vb2_ops</span> <span class="n">mx3_videobuf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue_setup</span>	<span class="o">=</span> <span class="n">mx3_videobuf_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>	<span class="o">=</span> <span class="n">mx3_videobuf_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_cleanup</span>	<span class="o">=</span> <span class="n">mx3_videobuf_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_init</span>	<span class="o">=</span> <span class="n">mx3_videobuf_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_prepare</span>	<span class="o">=</span> <span class="n">soc_camera_unlock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_finish</span>	<span class="o">=</span> <span class="n">soc_camera_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_streaming</span>	<span class="o">=</span> <span class="n">mx3_stop_streaming</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_init_videobuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span> <span class="o">|</span> <span class="n">VB2_USERPTR</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span> <span class="o">=</span> <span class="n">icd</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_videobuf_ops</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">mem_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vb2_dma_contig_memops</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">buf_struct_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3_camera_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vb2_queue_init</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* First part of ipu_csi_init_interface() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mx3_camera_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">conf</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* Set default size: ipu_csi_set_window_size() */</span>
	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="p">(</span><span class="mi">640</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mi">480</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">CSI_ACT_FRM_SIZE</span><span class="p">);</span>
	<span class="cm">/* ...and position to 0:0: ipu_csi_set_window_pos() */</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">csi_reg_read</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">CSI_OUT_FRM_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">CSI_OUT_FRM_CTRL</span><span class="p">);</span>

	<span class="cm">/* We use only gated clock synchronisation mode so far */</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_SENS_PRTCL_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Set generic data, platform-biggest bus-width */</span>
	<span class="n">conf</span> <span class="o">|=</span> <span class="n">CSI_SENS_CONF_DATA_FMT_BAYER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DATAWIDTH_15</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DATAWIDTH_10</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DATAWIDTH_8</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="k">else</span><span class="cm">/* if (mx3_cam-&gt;platform_flags &amp; MX3_CAMERA_DATAWIDTH_4)*/</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_CLK_SRC</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_SENS_CLKSRC_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_EXT_VSYNC</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_EXT_VSYNC_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DP</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_POL_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_PCP</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_PIX_CLK_POL_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_HSP</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_HSYNC_POL_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_VSP</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_VSYNC_POL_SHIFT</span><span class="p">;</span>

	<span class="cm">/* ipu_csi_init_interface() */</span>
	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">CSI_SENS_CONF</span><span class="p">);</span>

	<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">,</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Set SENS_CONF to %x, rate %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span>
		<span class="n">clk_set_rate</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called with .video_lock held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">icd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mx3_camera_activate</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">icd</span><span class="p">);</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">buf_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">icd</span> <span class="o">=</span> <span class="n">icd</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;MX3 Camera driver attached to camera %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">icd</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called with .video_lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mx3_camera_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">**</span><span class="n">ichan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">icd</span> <span class="o">!=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">icd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ichan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">ichan</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ichan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">icd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;MX3 Camera driver detached from camera %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">icd</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_platform_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buswidth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If requested data width is supported by the platform, use it or any</span>
<span class="cm">	 * possible lower value - i.MX31 is smart enough to shift bits</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buswidth</span> <span class="o">&gt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">width_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Platform specified synchronization and pixel clock polarities are</span>
<span class="cm">	 * only a recommendation and are only used during probing. MX3x</span>
<span class="cm">	 * camera interface only works in master mode, i.e., uses HSYNC and</span>
<span class="cm">	 * VSYNC signals from the sensor</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_MBUS_MASTER</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_PCLK_SAMPLE_FALLING</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_DATA_ACTIVE_LOW</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_try_bus_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">,};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bus_flags</span><span class="p">,</span> <span class="n">common_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">test_platform_param</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;request bus width %d bit: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_mbus_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common_flags</span> <span class="o">=</span> <span class="n">soc_mbus_config_compatible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span>
							  <span class="n">bus_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
				 <span class="s">&quot;Flags incompatible: camera 0x%x, host 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cfg</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">bus_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">chan_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan_request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3_camera_pdata</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_dma_is_ipu</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">soc_host</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">&amp;&amp;</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="n">mx3_camera_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">fourcc</span>			<span class="o">=</span> <span class="n">V4L2_PIX_FMT_SBGGR8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Bayer BGGR (sRGB) 8 bit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_sample</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">packing</span>		<span class="o">=</span> <span class="n">SOC_MBUS_PACKING_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">order</span>			<span class="o">=</span> <span class="n">SOC_MBUS_ORDER_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">layout</span>			<span class="o">=</span> <span class="n">SOC_MBUS_LAYOUT_PACKED</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fourcc</span>			<span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Monochrome 8 bit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_sample</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">packing</span>		<span class="o">=</span> <span class="n">SOC_MBUS_PACKING_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">order</span>			<span class="o">=</span> <span class="n">SOC_MBUS_ORDER_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">layout</span>			<span class="o">=</span> <span class="n">SOC_MBUS_LAYOUT_PACKED</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* This will be corrected as we get more formats */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">mx3_camera_packing_supported</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">SOC_MBUS_PACKING_NONE</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		 <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">SOC_MBUS_PACKING_2X8_PADHI</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		 <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">SOC_MBUS_PACKING_EXTEND16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_get_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">formats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">enum_mbus_fmt</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* No more formats */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">soc_mbus_get_fmtdesc</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
			 <span class="s">&quot;Unsupported format code #%u: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This also checks support for the requested bits-per-sample */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mx3_camera_try_bus_param</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span>:
		<span class="n">formats</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_camera_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">code</span><span class="p">;</span>
			<span class="n">xlate</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Providing format %s using code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mx3_camera_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_Y10_1X10</span>:
		<span class="n">formats</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_camera_formats</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">code</span><span class="p">;</span>
			<span class="n">xlate</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Providing format %s using code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mx3_camera_formats</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_camera_packing_supported</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Generic pass-through */</span>
	<span class="n">formats</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span>	<span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">code</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Providing format %c%c%c%c in pass-through mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">xlate</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">formats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">configure_geometry</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">width_field</span><span class="p">,</span> <span class="n">height_field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fourcc_to_ipu_pix</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPU_PIX_FMT_GENERIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * As the CSI will be configured to output BAYER, here</span>
<span class="cm">		 * the width parameter count the number of samples to</span>
<span class="cm">		 * capture to complete the whole image width.</span>
<span class="cm">		 */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">soc_mbus_samples_per_pixel</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">den</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup frame size - this cannot be changed on-the-fly... */</span>
	<span class="n">width_field</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">height_field</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">width_field</span> <span class="o">|</span> <span class="p">(</span><span class="n">height_field</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">CSI_SENS_FRM_SIZE</span><span class="p">);</span>

	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">width_field</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">CSI_FLASH_STROBE_1</span><span class="p">);</span>
	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="p">(</span><span class="n">height_field</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x22</span><span class="p">,</span> <span class="n">CSI_FLASH_STROBE_2</span><span class="p">);</span>

	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">width_field</span> <span class="o">|</span> <span class="p">(</span><span class="n">height_field</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">CSI_ACT_FRM_SIZE</span><span class="p">);</span>

	<span class="cm">/* ...and position */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">csi_reg_read</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">CSI_OUT_FRM_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="cm">/* Sensor does the cropping */</span>
	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">CSI_OUT_FRM_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acquire_dma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">**</span><span class="n">ichan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/* We have to use IDMAC_IC_7 for Bayer / generic data */</span>
	<span class="k">struct</span> <span class="n">dma_chan_request</span> <span class="n">rq</span> <span class="o">=</span> <span class="p">{.</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IDMAC_IC_7</span><span class="p">};</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_PRIVATE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">chan_filter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ichan</span> <span class="o">=</span> <span class="n">to_idmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">ichan</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: learn to use stride != width, then we can keep stride properly aligned</span>
<span class="cm"> * and support arbitrary (even) widths.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">stride_align</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="o">*</span><span class="n">width</span> <span class="o">&amp;</span>  <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * As long as we don&#39;t implement host-side cropping and scaling, we can use</span>
<span class="cm"> * default g_crop and cropcap from soc_camera.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_set_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">soc_camera_limit_side</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">soc_camera_limit_side</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_crop</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* The capture device might have changed its output sizes */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ouch! We can only handle 8-byte aligned width... */</span>
		<span class="n">stride_align</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span> <span class="o">||</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span><span class="p">)</span>
		<span class="n">configure_geometry</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
				   <span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Sensor cropped %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_width</span>		<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">user_height</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">xlate</span> <span class="o">=</span> <span class="n">soc_camera_xlate_by_fourcc</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Format %x not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stride_align</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Set format %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Might have to perform a complete interface initialisation like in</span>
<span class="cm">	 * ipu_csi_init_interface() in mxc_v4l2_s_param(). Also consider</span>
<span class="cm">	 * mxc_v4l2_s_fmt()</span>
<span class="cm">	 */</span>

	<span class="n">configure_geometry</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="p">);</span>

	<span class="n">mf</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">field</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">acquire_dma_channel</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span>		<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">field</span>		<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span>		<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span>	<span class="o">=</span> <span class="n">xlate</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Sensor set %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">pixfmt</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">xlate</span> <span class="o">=</span> <span class="n">soc_camera_xlate_by_fourcc</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Format %x not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* limit to MX3 hardware capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

	<span class="cm">/* limit to sensor capabilities */</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">field</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">mf</span><span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">xlate</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">try_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">mf</span><span class="p">.</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mf</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_ANY</span>:
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Field type %d unsupported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mf</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mx3_camera_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vb2_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">vb2_vidq</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* cap-&gt;name is set by the firendly caller:-&gt; */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;i.MX3x Camera&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3_camera_set_bus_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_device</span> <span class="o">*</span><span class="n">icd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">soc_camera_to_subdev</span><span class="p">(</span><span class="n">icd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">ici</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">ici</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">,};</span>
	<span class="n">u32</span> <span class="n">pixfmt</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bus_flags</span><span class="p">,</span> <span class="n">common_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">,</span> <span class="n">sens_conf</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_mbus_pixelfmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buswidth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">soc_camera_format_xlate</span> <span class="o">*</span><span class="n">xlate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">soc_mbus_get_fmtdesc</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">current_fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">xlate</span> <span class="o">=</span> <span class="n">soc_camera_xlate_by_fourcc</span><span class="p">(</span><span class="n">icd</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xlate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Format %x not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buswidth</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">test_platform_param</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">buswidth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;requested bus width %d bit: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buswidth</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_mbus_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common_flags</span> <span class="o">=</span> <span class="n">soc_mbus_config_compatible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span>
							  <span class="n">bus_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">icd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
				 <span class="s">&quot;Flags incompatible: camera 0x%x, host 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cfg</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">bus_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">common_flags</span> <span class="o">=</span> <span class="n">bus_flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Flags cam: 0x%x host: 0x%lx common: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">bus_flags</span><span class="p">,</span> <span class="n">common_flags</span><span class="p">);</span>

	<span class="cm">/* Make choices, based on platform preferences */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_HSP</span><span class="p">)</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_VSP</span><span class="p">)</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_DATA_ACTIVE_LOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DP</span><span class="p">)</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_DATA_ACTIVE_LOW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_FALLING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_PCP</span><span class="p">)</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">common_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_MBUS_PCLK_SAMPLE_FALLING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">common_flags</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_mbus_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;camera s_mbus_config(0x%lx) returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">common_flags</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * So far only gated clock mode is supported. Add a line</span>
<span class="cm">	 *	(3 &lt;&lt; CSI_SENS_CONF_SENS_PRTCL_SHIFT) |</span>
<span class="cm">	 * below and select the required mode when supporting other</span>
<span class="cm">	 * synchronisation protocols.</span>
<span class="cm">	 */</span>
	<span class="n">sens_conf</span> <span class="o">=</span> <span class="n">csi_reg_read</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">CSI_SENS_CONF</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_VSYNC_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_HSYNC_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_PIX_CLK_POL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_FMT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">));</span>

	<span class="cm">/* TODO: Support RGB and YUV formats */</span>

	<span class="cm">/* This has been set in mx3_camera_activate(), but we clear it above */</span>
	<span class="n">sens_conf</span> <span class="o">|=</span> <span class="n">CSI_SENS_CONF_DATA_FMT_BAYER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_FALLING</span><span class="p">)</span>
		<span class="n">sens_conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_PIX_CLK_POL_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">sens_conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_HSYNC_POL_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">sens_conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_VSYNC_POL_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">common_flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_DATA_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">sens_conf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_POL_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Just do what we&#39;re asked to do */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">xlate</span><span class="o">-&gt;</span><span class="n">host_fmt</span><span class="o">-&gt;</span><span class="n">bits_per_sample</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Actually it can only be 15 now, default is just to silence</span>
<span class="cm">		 * compiler warnings</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">CSI_SENS_CONF_DATA_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csi_reg_write</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">,</span> <span class="n">sens_conf</span> <span class="o">|</span> <span class="n">dw</span><span class="p">,</span> <span class="n">CSI_SENS_CONF</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set SENS_CONF to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sens_conf</span> <span class="o">|</span> <span class="n">dw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">soc_camera_host_ops</span> <span class="n">mx3_soc_camera_host_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span>		<span class="o">=</span> <span class="n">mx3_camera_add_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mx3_camera_remove_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_crop</span>	<span class="o">=</span> <span class="n">mx3_camera_set_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">mx3_camera_set_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_fmt</span>	<span class="o">=</span> <span class="n">mx3_camera_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_formats</span>	<span class="o">=</span> <span class="n">mx3_camera_get_formats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_videobuf2</span>	<span class="o">=</span> <span class="n">mx3_camera_init_videobuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reqbufs</span>	<span class="o">=</span> <span class="n">mx3_camera_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">mx3_camera_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querycap</span>	<span class="o">=</span> <span class="n">mx3_camera_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bus_param</span>	<span class="o">=</span> <span class="n">mx3_camera_set_bus_param</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mx3_camera_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">soc_host</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">egetres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mx3_cam</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_cam</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not allocate mx3 camera object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ealloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eclkget</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MX3_CAMERA_DATAWIDTH_4</span> <span class="o">|</span>
			<span class="n">MX3_CAMERA_DATAWIDTH_8</span> <span class="o">|</span> <span class="n">MX3_CAMERA_DATAWIDTH_10</span> <span class="o">|</span>
			<span class="n">MX3_CAMERA_DATAWIDTH_15</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Platform hasn&#39;t set available data widths. This is bad.</span>
<span class="cm">		 * Warn and use a default.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WARNING! Platform hasn&#39;t set available &quot;</span>
			 <span class="s">&quot;data widths, using default 8 bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">|=</span> <span class="n">MX3_CAMERA_DATAWIDTH_8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DATAWIDTH_4</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">width_flags</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DATAWIDTH_8</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">width_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DATAWIDTH_10</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">width_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">platform_flags</span> <span class="o">&amp;</span> <span class="n">MX3_CAMERA_DATAWIDTH_15</span><span class="p">)</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">width_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mclk_10khz</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;mclk_10khz == 0! Please, fix your platform data. &quot;</span>
			 <span class="s">&quot;Using default 20MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* list of video-buffers */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t map %x@%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">base</span>	<span class="o">=</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">soc_host</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">soc_host</span><span class="p">;</span>
	<span class="n">soc_host</span><span class="o">-&gt;</span><span class="n">drv_name</span>	<span class="o">=</span> <span class="n">MX3_CAM_DRV_NAME</span><span class="p">;</span>
	<span class="n">soc_host</span><span class="o">-&gt;</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_soc_camera_host_ops</span><span class="p">;</span>
	<span class="n">soc_host</span><span class="o">-&gt;</span><span class="n">priv</span>		<span class="o">=</span> <span class="n">mx3_cam</span><span class="p">;</span>
	<span class="n">soc_host</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">soc_host</span><span class="o">-&gt;</span><span class="n">nr</span>		<span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span> <span class="o">=</span> <span class="n">vb2_dma_contig_init_ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eallocctx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">soc_camera_host_register</span><span class="p">(</span><span class="n">soc_host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ecamhostreg</span><span class="p">;</span>

	<span class="cm">/* IDMAC interface */</span>
	<span class="n">dmaengine_get</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ecamhostreg:</span>
	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">);</span>
<span class="nl">eallocctx:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="nl">eioremap:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">eclkget:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">);</span>
<span class="nl">ealloc:</span>
<span class="nl">egetres:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">mx3_camera_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_camera_host</span> <span class="o">*</span><span class="n">soc_host</span> <span class="o">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3_camera_dev</span> <span class="o">*</span><span class="n">mx3_cam</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">soc_host</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mx3_camera_dev</span><span class="p">,</span> <span class="n">soc_host</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">soc_camera_host_unregister</span><span class="p">(</span><span class="n">soc_host</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The channel has either not been allocated,</span>
<span class="cm">	 * or should have been released</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>

	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">mx3_cam</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">mx3_cam</span><span class="p">);</span>

	<span class="n">dmaengine_put</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mx3_camera_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> 	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MX3_CAM_DRV_NAME</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mx3_camera_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mx3_camera_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mx3_camera_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;i.MX3x SoC Camera Host driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guennadi Liakhovetski &lt;lg@denx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.2.3&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">MX3_CAM_DRV_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
