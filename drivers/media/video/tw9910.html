<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › tw9910.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tw9910.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * tw9910 Video Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Renesas Solutions Corp.</span>
<span class="cm"> * Kuninori Morimoto &lt;morimoto.kuninori@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on ov772x driver,</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Kuninori Morimoto &lt;morimoto.kuninori@renesas.com&gt;</span>
<span class="cm"> * Copyright 2006-7 Jonathan Corbet &lt;corbet@lwn.net&gt;</span>
<span class="cm"> * Copyright (C) 2008 Magnus Damm</span>
<span class="cm"> * Copyright (C) 2008, Guennadi Liakhovetski &lt;kernel@pengutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>

<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/tw9910.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>

<span class="cp">#define GET_ID(val)  ((val &amp; 0xF8) &gt;&gt; 3)</span>
<span class="cp">#define GET_REV(val) (val &amp; 0x07)</span>

<span class="cm">/*</span>
<span class="cm"> * register offset</span>
<span class="cm"> */</span>
<span class="cp">#define ID		0x00 </span><span class="cm">/* Product ID Code Register */</span><span class="cp"></span>
<span class="cp">#define STATUS1		0x01 </span><span class="cm">/* Chip Status Register I */</span><span class="cp"></span>
<span class="cp">#define INFORM		0x02 </span><span class="cm">/* Input Format */</span><span class="cp"></span>
<span class="cp">#define OPFORM		0x03 </span><span class="cm">/* Output Format Control Register */</span><span class="cp"></span>
<span class="cp">#define DLYCTR		0x04 </span><span class="cm">/* Hysteresis and HSYNC Delay Control */</span><span class="cp"></span>
<span class="cp">#define OUTCTR1		0x05 </span><span class="cm">/* Output Control I */</span><span class="cp"></span>
<span class="cp">#define ACNTL1		0x06 </span><span class="cm">/* Analog Control Register 1 */</span><span class="cp"></span>
<span class="cp">#define CROP_HI		0x07 </span><span class="cm">/* Cropping Register, High */</span><span class="cp"></span>
<span class="cp">#define VDELAY_LO	0x08 </span><span class="cm">/* Vertical Delay Register, Low */</span><span class="cp"></span>
<span class="cp">#define VACTIVE_LO	0x09 </span><span class="cm">/* Vertical Active Register, Low */</span><span class="cp"></span>
<span class="cp">#define HDELAY_LO	0x0A </span><span class="cm">/* Horizontal Delay Register, Low */</span><span class="cp"></span>
<span class="cp">#define HACTIVE_LO	0x0B </span><span class="cm">/* Horizontal Active Register, Low */</span><span class="cp"></span>
<span class="cp">#define CNTRL1		0x0C </span><span class="cm">/* Control Register I */</span><span class="cp"></span>
<span class="cp">#define VSCALE_LO	0x0D </span><span class="cm">/* Vertical Scaling Register, Low */</span><span class="cp"></span>
<span class="cp">#define SCALE_HI	0x0E </span><span class="cm">/* Scaling Register, High */</span><span class="cp"></span>
<span class="cp">#define HSCALE_LO	0x0F </span><span class="cm">/* Horizontal Scaling Register, Low */</span><span class="cp"></span>
<span class="cp">#define BRIGHT		0x10 </span><span class="cm">/* BRIGHTNESS Control Register */</span><span class="cp"></span>
<span class="cp">#define CONTRAST	0x11 </span><span class="cm">/* CONTRAST Control Register */</span><span class="cp"></span>
<span class="cp">#define SHARPNESS	0x12 </span><span class="cm">/* SHARPNESS Control Register I */</span><span class="cp"></span>
<span class="cp">#define SAT_U		0x13 </span><span class="cm">/* Chroma (U) Gain Register */</span><span class="cp"></span>
<span class="cp">#define SAT_V		0x14 </span><span class="cm">/* Chroma (V) Gain Register */</span><span class="cp"></span>
<span class="cp">#define HUE		0x15 </span><span class="cm">/* Hue Control Register */</span><span class="cp"></span>
<span class="cp">#define CORING1		0x17</span>
<span class="cp">#define CORING2		0x18 </span><span class="cm">/* Coring and IF compensation */</span><span class="cp"></span>
<span class="cp">#define VBICNTL		0x19 </span><span class="cm">/* VBI Control Register */</span><span class="cp"></span>
<span class="cp">#define ACNTL2		0x1A </span><span class="cm">/* Analog Control 2 */</span><span class="cp"></span>
<span class="cp">#define OUTCTR2		0x1B </span><span class="cm">/* Output Control 2 */</span><span class="cp"></span>
<span class="cp">#define SDT		0x1C </span><span class="cm">/* Standard Selection */</span><span class="cp"></span>
<span class="cp">#define SDTR		0x1D </span><span class="cm">/* Standard Recognition */</span><span class="cp"></span>
<span class="cp">#define TEST		0x1F </span><span class="cm">/* Test Control Register */</span><span class="cp"></span>
<span class="cp">#define CLMPG		0x20 </span><span class="cm">/* Clamping Gain */</span><span class="cp"></span>
<span class="cp">#define IAGC		0x21 </span><span class="cm">/* Individual AGC Gain */</span><span class="cp"></span>
<span class="cp">#define AGCGAIN		0x22 </span><span class="cm">/* AGC Gain */</span><span class="cp"></span>
<span class="cp">#define PEAKWT		0x23 </span><span class="cm">/* White Peak Threshold */</span><span class="cp"></span>
<span class="cp">#define CLMPL		0x24 </span><span class="cm">/* Clamp level */</span><span class="cp"></span>
<span class="cp">#define SYNCT		0x25 </span><span class="cm">/* Sync Amplitude */</span><span class="cp"></span>
<span class="cp">#define MISSCNT		0x26 </span><span class="cm">/* Sync Miss Count Register */</span><span class="cp"></span>
<span class="cp">#define PCLAMP		0x27 </span><span class="cm">/* Clamp Position Register */</span><span class="cp"></span>
<span class="cp">#define VCNTL1		0x28 </span><span class="cm">/* Vertical Control I */</span><span class="cp"></span>
<span class="cp">#define VCNTL2		0x29 </span><span class="cm">/* Vertical Control II */</span><span class="cp"></span>
<span class="cp">#define CKILL		0x2A </span><span class="cm">/* Color Killer Level Control */</span><span class="cp"></span>
<span class="cp">#define COMB		0x2B </span><span class="cm">/* Comb Filter Control */</span><span class="cp"></span>
<span class="cp">#define LDLY		0x2C </span><span class="cm">/* Luma Delay and H Filter Control */</span><span class="cp"></span>
<span class="cp">#define MISC1		0x2D </span><span class="cm">/* Miscellaneous Control I */</span><span class="cp"></span>
<span class="cp">#define LOOP		0x2E </span><span class="cm">/* LOOP Control Register */</span><span class="cp"></span>
<span class="cp">#define MISC2		0x2F </span><span class="cm">/* Miscellaneous Control II */</span><span class="cp"></span>
<span class="cp">#define MVSN		0x30 </span><span class="cm">/* Macrovision Detection */</span><span class="cp"></span>
<span class="cp">#define STATUS2		0x31 </span><span class="cm">/* Chip STATUS II */</span><span class="cp"></span>
<span class="cp">#define HFREF		0x32 </span><span class="cm">/* H monitor */</span><span class="cp"></span>
<span class="cp">#define CLMD		0x33 </span><span class="cm">/* CLAMP MODE */</span><span class="cp"></span>
<span class="cp">#define IDCNTL		0x34 </span><span class="cm">/* ID Detection Control */</span><span class="cp"></span>
<span class="cp">#define CLCNTL1		0x35 </span><span class="cm">/* Clamp Control I */</span><span class="cp"></span>
<span class="cp">#define ANAPLLCTL	0x4C</span>
<span class="cp">#define VBIMIN		0x4D</span>
<span class="cp">#define HSLOWCTL	0x4E</span>
<span class="cp">#define WSS3		0x4F</span>
<span class="cp">#define FILLDATA	0x50</span>
<span class="cp">#define SDID		0x51</span>
<span class="cp">#define DID		0x52</span>
<span class="cp">#define WSS1		0x53</span>
<span class="cp">#define WSS2		0x54</span>
<span class="cp">#define VVBI		0x55</span>
<span class="cp">#define LCTL6		0x56</span>
<span class="cp">#define LCTL7		0x57</span>
<span class="cp">#define LCTL8		0x58</span>
<span class="cp">#define LCTL9		0x59</span>
<span class="cp">#define LCTL10		0x5A</span>
<span class="cp">#define LCTL11		0x5B</span>
<span class="cp">#define LCTL12		0x5C</span>
<span class="cp">#define LCTL13		0x5D</span>
<span class="cp">#define LCTL14		0x5E</span>
<span class="cp">#define LCTL15		0x5F</span>
<span class="cp">#define LCTL16		0x60</span>
<span class="cp">#define LCTL17		0x61</span>
<span class="cp">#define LCTL18		0x62</span>
<span class="cp">#define LCTL19		0x63</span>
<span class="cp">#define LCTL20		0x64</span>
<span class="cp">#define LCTL21		0x65</span>
<span class="cp">#define LCTL22		0x66</span>
<span class="cp">#define LCTL23		0x67</span>
<span class="cp">#define LCTL24		0x68</span>
<span class="cp">#define LCTL25		0x69</span>
<span class="cp">#define LCTL26		0x6A</span>
<span class="cp">#define HSBEGIN		0x6B</span>
<span class="cp">#define HSEND		0x6C</span>
<span class="cp">#define OVSDLY		0x6D</span>
<span class="cp">#define OVSEND		0x6E</span>
<span class="cp">#define VBIDELAY	0x6F</span>

<span class="cm">/*</span>
<span class="cm"> * register detail</span>
<span class="cm"> */</span>

<span class="cm">/* INFORM */</span>
<span class="cp">#define FC27_ON     0x40 </span><span class="cm">/* 1 : Input crystal clock frequency is 27MHz */</span><span class="cp"></span>
<span class="cp">#define FC27_FF     0x00 </span><span class="cm">/* 0 : Square pixel mode. */</span><span class="cp"></span>
			 <span class="cm">/*     Must use 24.54MHz for 60Hz field rate */</span>
			 <span class="cm">/*     source or 29.5MHz for 50Hz field rate */</span>
<span class="cp">#define IFSEL_S     0x10 </span><span class="cm">/* 01 : S-video decoding */</span><span class="cp"></span>
<span class="cp">#define IFSEL_C     0x00 </span><span class="cm">/* 00 : Composite video decoding */</span><span class="cp"></span>
			 <span class="cm">/* Y input video selection */</span>
<span class="cp">#define YSEL_M0     0x00 </span><span class="cm">/*  00 : Mux0 selected */</span><span class="cp"></span>
<span class="cp">#define YSEL_M1     0x04 </span><span class="cm">/*  01 : Mux1 selected */</span><span class="cp"></span>
<span class="cp">#define YSEL_M2     0x08 </span><span class="cm">/*  10 : Mux2 selected */</span><span class="cp"></span>
<span class="cp">#define YSEL_M3     0x10 </span><span class="cm">/*  11 : Mux3 selected */</span><span class="cp"></span>

<span class="cm">/* OPFORM */</span>
<span class="cp">#define MODE        0x80 </span><span class="cm">/* 0 : CCIR601 compatible YCrCb 4:2:2 format */</span><span class="cp"></span>
			 <span class="cm">/* 1 : ITU-R-656 compatible data sequence format */</span>
<span class="cp">#define LEN         0x40 </span><span class="cm">/* 0 : 8-bit YCrCb 4:2:2 output format */</span><span class="cp"></span>
			 <span class="cm">/* 1 : 16-bit YCrCb 4:2:2 output format.*/</span>
<span class="cp">#define LLCMODE     0x20 </span><span class="cm">/* 1 : LLC output mode. */</span><span class="cp"></span>
			 <span class="cm">/* 0 : free-run output mode */</span>
<span class="cp">#define AINC        0x10 </span><span class="cm">/* Serial interface auto-indexing control */</span><span class="cp"></span>
			 <span class="cm">/* 0 : auto-increment */</span>
			 <span class="cm">/* 1 : non-auto */</span>
<span class="cp">#define VSCTL       0x08 </span><span class="cm">/* 1 : Vertical out ctrl by DVALID */</span><span class="cp"></span>
			 <span class="cm">/* 0 : Vertical out ctrl by HACTIVE and DVALID */</span>
<span class="cp">#define OEN_TRI_SEL_MASK	0x07</span>
<span class="cp">#define OEN_TRI_SEL_ALL_ON	0x00 </span><span class="cm">/* Enable output for Rev0/Rev1 */</span><span class="cp"></span>
<span class="cp">#define OEN_TRI_SEL_ALL_OFF_r0	0x06 </span><span class="cm">/* All tri-stated for Rev0 */</span><span class="cp"></span>
<span class="cp">#define OEN_TRI_SEL_ALL_OFF_r1	0x07 </span><span class="cm">/* All tri-stated for Rev1 */</span><span class="cp"></span>

<span class="cm">/* OUTCTR1 */</span>
<span class="cp">#define VSP_LO      0x00 </span><span class="cm">/* 0 : VS pin output polarity is active low */</span><span class="cp"></span>
<span class="cp">#define VSP_HI      0x80 </span><span class="cm">/* 1 : VS pin output polarity is active high. */</span><span class="cp"></span>
			 <span class="cm">/* VS pin output control */</span>
<span class="cp">#define VSSL_VSYNC  0x00 </span><span class="cm">/*   0 : VSYNC  */</span><span class="cp"></span>
<span class="cp">#define VSSL_VACT   0x10 </span><span class="cm">/*   1 : VACT   */</span><span class="cp"></span>
<span class="cp">#define VSSL_FIELD  0x20 </span><span class="cm">/*   2 : FIELD  */</span><span class="cp"></span>
<span class="cp">#define VSSL_VVALID 0x30 </span><span class="cm">/*   3 : VVALID */</span><span class="cp"></span>
<span class="cp">#define VSSL_ZERO   0x70 </span><span class="cm">/*   7 : 0      */</span><span class="cp"></span>
<span class="cp">#define HSP_LOW     0x00 </span><span class="cm">/* 0 : HS pin output polarity is active low */</span><span class="cp"></span>
<span class="cp">#define HSP_HI      0x08 </span><span class="cm">/* 1 : HS pin output polarity is active high.*/</span><span class="cp"></span>
			 <span class="cm">/* HS pin output control */</span>
<span class="cp">#define HSSL_HACT   0x00 </span><span class="cm">/*   0 : HACT   */</span><span class="cp"></span>
<span class="cp">#define HSSL_HSYNC  0x01 </span><span class="cm">/*   1 : HSYNC  */</span><span class="cp"></span>
<span class="cp">#define HSSL_DVALID 0x02 </span><span class="cm">/*   2 : DVALID */</span><span class="cp"></span>
<span class="cp">#define HSSL_HLOCK  0x03 </span><span class="cm">/*   3 : HLOCK  */</span><span class="cp"></span>
<span class="cp">#define HSSL_ASYNCW 0x04 </span><span class="cm">/*   4 : ASYNCW */</span><span class="cp"></span>
<span class="cp">#define HSSL_ZERO   0x07 </span><span class="cm">/*   7 : 0      */</span><span class="cp"></span>

<span class="cm">/* ACNTL1 */</span>
<span class="cp">#define SRESET      0x80 </span><span class="cm">/* resets the device to its default state</span>
<span class="cm">			  * but all register content remain unchanged.</span>
<span class="cm">			  * This bit is self-resetting.</span>
<span class="cm">			  */</span><span class="cp"></span>
<span class="cp">#define ACNTL1_PDN_MASK	0x0e</span>
<span class="cp">#define CLK_PDN		0x08 </span><span class="cm">/* system clock power down */</span><span class="cp"></span>
<span class="cp">#define Y_PDN		0x04 </span><span class="cm">/* Luma ADC power down */</span><span class="cp"></span>
<span class="cp">#define C_PDN		0x02 </span><span class="cm">/* Chroma ADC power down */</span><span class="cp"></span>

<span class="cm">/* ACNTL2 */</span>
<span class="cp">#define ACNTL2_PDN_MASK	0x40</span>
<span class="cp">#define PLL_PDN		0x40 </span><span class="cm">/* PLL power down */</span><span class="cp"></span>

<span class="cm">/* VBICNTL */</span>

<span class="cm">/* RTSEL : control the real time signal output from the MPOUT pin */</span>
<span class="cp">#define RTSEL_MASK  0x07</span>
<span class="cp">#define RTSEL_VLOSS 0x00 </span><span class="cm">/* 0000 = Video loss */</span><span class="cp"></span>
<span class="cp">#define RTSEL_HLOCK 0x01 </span><span class="cm">/* 0001 = H-lock */</span><span class="cp"></span>
<span class="cp">#define RTSEL_SLOCK 0x02 </span><span class="cm">/* 0010 = S-lock */</span><span class="cp"></span>
<span class="cp">#define RTSEL_VLOCK 0x03 </span><span class="cm">/* 0011 = V-lock */</span><span class="cp"></span>
<span class="cp">#define RTSEL_MONO  0x04 </span><span class="cm">/* 0100 = MONO */</span><span class="cp"></span>
<span class="cp">#define RTSEL_DET50 0x05 </span><span class="cm">/* 0101 = DET50 */</span><span class="cp"></span>
<span class="cp">#define RTSEL_FIELD 0x06 </span><span class="cm">/* 0110 = FIELD */</span><span class="cp"></span>
<span class="cp">#define RTSEL_RTCO  0x07 </span><span class="cm">/* 0111 = RTCO ( Real Time Control ) */</span><span class="cp"></span>

<span class="cm">/* HSYNC start and end are constant for now */</span>
<span class="cp">#define HSYNC_START	0x0260</span>
<span class="cp">#define HSYNC_END	0x0300</span>

<span class="cm">/*</span>
<span class="cm"> * structure</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">regval_list</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="p">{</span>
	<span class="kt">char</span>           <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">height</span><span class="p">;</span>
	<span class="n">u16</span>             <span class="n">hscale</span><span class="p">;</span>
	<span class="n">u16</span>             <span class="n">vscale</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span>		<span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tw9910_video_info</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span>	<span class="o">*</span><span class="n">scale</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span>			<span class="n">norm</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">revision</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="n">tw9910_ntsc_scales</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;NTSC SQ&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;NTSC CCIR601&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;NTSC SQ (CIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;NTSC CCIR601 (CIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;NTSC SQ (QCIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">160</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;NTSC CCIR601 (QCIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="n">tw9910_pal_scales</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;PAL SQ&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">576</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;PAL CCIR601&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">576</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;PAL SQ (CIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">384</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;PAL CCIR601 (CIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;PAL SQ (QCIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">192</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;PAL CCIR601 (QCIF)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vscale</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * general function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="nf">to_tw9910</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">),</span> <span class="k">struct</span> <span class="n">tw9910_priv</span><span class="p">,</span>
			    <span class="n">subdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_mask_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">set</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_set_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="o">*</span><span class="n">scale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SCALE_HI</span><span class="p">,</span>
					<span class="p">(</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">vscale</span> <span class="o">&amp;</span> <span class="mh">0x0F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">hscale</span> <span class="o">&amp;</span> <span class="mh">0x0F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">HSCALE_LO</span><span class="p">,</span>
					<span class="n">scale</span><span class="o">-&gt;</span><span class="n">hscale</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VSCALE_LO</span><span class="p">,</span>
					<span class="n">scale</span><span class="o">-&gt;</span><span class="n">vscale</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_set_hsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* bit 10 - 3 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">HSBEGIN</span><span class="p">,</span>
					<span class="p">(</span><span class="n">HSYNC_START</span> <span class="o">&amp;</span> <span class="mh">0x07F8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* bit 10 - 3 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">HSEND</span><span class="p">,</span>
					<span class="p">(</span><span class="n">HSYNC_END</span> <span class="o">&amp;</span> <span class="mh">0x07F8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* So far only revisions 0 and 1 have been seen */</span>
	<span class="cm">/* bit 2 - 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">HSLOWCTL</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">HSYNC_START</span> <span class="o">&amp;</span> <span class="mh">0x0007</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span>
				      <span class="p">(</span><span class="n">HSYNC_END</span>   <span class="o">&amp;</span> <span class="mh">0x0007</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw9910_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tw9910_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ACNTL1</span><span class="p">,</span> <span class="n">SRESET</span><span class="p">,</span> <span class="n">SRESET</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">acntl1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">acntl2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acntl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acntl2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acntl1</span> <span class="o">=</span> <span class="n">CLK_PDN</span> <span class="o">|</span> <span class="n">Y_PDN</span> <span class="o">|</span> <span class="n">C_PDN</span><span class="p">;</span>
		<span class="n">acntl2</span> <span class="o">=</span> <span class="n">PLL_PDN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ACNTL1</span><span class="p">,</span> <span class="n">ACNTL1_PDN_MASK</span><span class="p">,</span> <span class="n">acntl1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tw9910_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ACNTL2</span><span class="p">,</span> <span class="n">ACNTL2_PDN_MASK</span><span class="p">,</span> <span class="n">acntl2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="o">*</span><span class="nf">tw9910_select_norm</span><span class="p">(</span><span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">,</span>
							  <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="o">*</span><span class="n">scale</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">diff</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scale</span> <span class="o">=</span> <span class="n">tw9910_ntsc_scales</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tw9910_ntsc_scales</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scale</span> <span class="o">=</span> <span class="n">tw9910_pal_scales</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tw9910_pal_scales</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">scale</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">abs</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">scale</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * subdevice operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">OEN_TRI_SEL_ALL_OFF_r0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">OEN_TRI_SEL_ALL_OFF_r1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;un-supported revision</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">OEN_TRI_SEL_ALL_ON</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;norm select error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OPFORM</span><span class="p">,</span> <span class="n">OEN_TRI_SEL_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tw9910_power</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="o">*</span><span class="n">norm</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_TW9910</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ret      = int</span>
<span class="cm">	 * reg-&gt;val = __u64</span>
<span class="cm">	 */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span> <span class="o">||</span>
	    <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_set_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * select suitable norm</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span> <span class="o">=</span> <span class="n">tw9910_select_norm</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">,</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">tw9910_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset hardware</span>
<span class="cm">	 */</span>
	<span class="n">tw9910_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set bus width</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SOCAM_DATAWIDTH_16</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">LEN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OPFORM</span><span class="p">,</span> <span class="n">LEN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">tw9910_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * select MPOUT behavior</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mpout</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_VLOSS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_VLOSS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_HLOCK</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_HLOCK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_SLOCK</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_SLOCK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_VLOCK</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_VLOCK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_MONO</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_MONO</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_DET50</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_DET50</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_FIELD</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_FIELD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW9910_MPO_RTCO</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">RTSEL_RTCO</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VBICNTL</span><span class="p">,</span> <span class="n">RTSEL_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">tw9910_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set scale</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_set_scale</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">tw9910_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set hsync</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_set_hsync</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">tw9910_set_fmt_error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">tw9910_set_fmt_error:</span>

	<span class="n">tw9910_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="mi">768</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">768</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span>			<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>				<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_g_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_set_frame</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scale</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED_BT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_ANY</span> <span class="o">&amp;&amp;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_INTERLACED_BT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * check color format</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_set_frame</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tw9910_scale_ctrl</span> <span class="o">*</span><span class="n">scale</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_ANY</span> <span class="o">==</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED_BT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_INTERLACED_BT</span> <span class="o">!=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Field type %d invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * select suitable norm</span>
<span class="cm">	 */</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="n">tw9910_select_norm</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scale</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">scale</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">scale</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_video_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * tw9910 only use 8 or 16 bit bus width</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SOCAM_DATAWIDTH_16</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buswidth</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SOCAM_DATAWIDTH_8</span>  <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bus width error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * check and show Product ID</span>
<span class="cm">	 * So far only revisions 0 and 1 have been seen</span>
<span class="cm">	 */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ID</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">GET_REV</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">GET_ID</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mh">0x0B</span> <span class="o">!=</span> <span class="n">id</span> <span class="o">||</span>
	    <span class="mh">0x01</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Product ID error %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;tw9910 Product ID %0x:%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">tw9910_subdev_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span>	<span class="o">=</span> <span class="n">tw9910_g_chip_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_std</span>		<span class="o">=</span> <span class="n">tw9910_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_std</span>		<span class="o">=</span> <span class="n">tw9910_g_std</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span>	<span class="o">=</span> <span class="n">tw9910_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span>	<span class="o">=</span> <span class="n">tw9910_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_g_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span> <span class="o">|</span> <span class="n">V4L2_MBUS_MASTER</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span> <span class="o">|</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">soc_camera_apply_board_flags</span><span class="p">(</span><span class="n">icl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_s_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="n">VSSL_VVALID</span> <span class="o">|</span> <span class="n">HSSL_DVALID</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">soc_camera_apply_board_flags</span><span class="p">(</span><span class="n">icl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set OUTCTR1</span>
<span class="cm">	 *</span>
<span class="cm">	 * We use VVALID and DVALID signals to control VSYNC and HSYNC</span>
<span class="cm">	 * outputs, in this mode their polarity is inverted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HSP_HI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VSP_HI</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">OUTCTR1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">tw9910_subdev_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span>	<span class="o">=</span> <span class="n">tw9910_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_fmt</span>	<span class="o">=</span> <span class="n">tw9910_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span>	<span class="o">=</span> <span class="n">tw9910_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span>	<span class="o">=</span> <span class="n">tw9910_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cropcap</span>	<span class="o">=</span> <span class="n">tw9910_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_crop</span>		<span class="o">=</span> <span class="n">tw9910_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span>	<span class="o">=</span> <span class="n">tw9910_enum_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_config</span>	<span class="o">=</span> <span class="n">tw9910_g_mbus_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_config</span>	<span class="o">=</span> <span class="n">tw9910_s_mbus_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">tw9910_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tw9910_subdev_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tw9910_subdev_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * i2c_driver function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span>		<span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tw9910_video_info</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>		<span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
		<span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span>		<span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span>				<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icl</span> <span class="o">||</span> <span class="o">!</span><span class="n">icl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TW9910: missing platform data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">icl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;I2C-Adapter doesn&#39;t support &quot;</span>
			<span class="s">&quot;I2C_FUNC_SMBUS_BYTE_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span>   <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw9910_subdev_ops</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tw9910_video_probe</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw9910_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tw9910_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_tw9910</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tw9910_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tw9910&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tw9910_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tw9910_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tw9910&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">tw9910_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">tw9910_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tw9910_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">tw9910_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SoC Camera driver for tw9910&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kuninori Morimoto&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
