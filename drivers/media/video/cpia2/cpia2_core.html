<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cpia2 › cpia2_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cpia2_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  Filename: cpia2_core.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2001, STMicrolectronics, Inc.</span>
<span class="cm"> *      Contact:  steve.miller@st.com</span>
<span class="cm"> *</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *     This is a USB driver for CPia2 based video cameras.</span>
<span class="cm"> *     The infrastructure of this driver is based on the cpia usb driver by</span>
<span class="cm"> *     Jochen Scharrlach and Johannes Erdfeldt.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *  Stripped of 2.4 stuff ready for main kernel submit by</span>
<span class="cm"> *		Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cp">#include &quot;cpia2.h&quot;</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cm">/* #define _CPIA2_DEBUG_ */</span>

<span class="cp">#ifdef _CPIA2_DEBUG_</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;System&quot;</span><span class="p">,</span>
	<span class="s">&quot;VC&quot;</span><span class="p">,</span>
	<span class="s">&quot;VP&quot;</span><span class="p">,</span>
	<span class="s">&quot;IDATA&quot;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debugs_on</span><span class="p">;</span>	<span class="cm">/* default 0 - DEBUG_REG */</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  Forward Declarations</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">apply_vp_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_default_user_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_vw_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">configure_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">reqwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqheight</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">config_sensor_410</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">reqwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqheight</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">config_sensor_500</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">reqwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqheight</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_all_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wake_system</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_lowlight_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_camera_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cpia2_set_high_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">);</span>

<span class="cm">/* Here we want the physical address of the memory.</span>
<span class="cm"> * This is used when initializing the contents of the</span>
<span class="cm"> * area and marking the pages as reserved.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">kvirt_to_pa</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kva</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">kva</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">page_address</span><span class="p">(</span><span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adr</span><span class="p">));</span>
	<span class="n">kva</span> <span class="o">|=</span> <span class="n">adr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* restore the offset */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">kva</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rvmalloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">;</span>

	<span class="cm">/* Round it off to PAGE_SIZE */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">vmalloc_32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>	<span class="cm">/* Clear the ram out, no junk to the user */</span>
	<span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adr</span><span class="p">));</span>
		<span class="n">adr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rvfree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adr</span><span class="p">));</span>
		<span class="n">adr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_do_command</span>
<span class="cm"> *</span>
<span class="cm"> *  Send an arbitrary command to the camera.  For commands that read from</span>
<span class="cm"> *  the camera, copy the buffers into the proper param structures.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_do_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">command</span><span class="p">,</span> <span class="n">u8</span> <span class="n">direction</span><span class="p">,</span> <span class="n">u8</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpia2_command</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* default */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>

	<span class="cm">/***</span>
<span class="cm">	 * Set up the command.</span>
<span class="cm">	 ***/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VERSION</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_DEVICE_HI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_PNP_ID</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_DESCRIP_VID_HI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_ASIC_TYPE</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VC_ASIC_ID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_SENSOR</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_SENSOR_FLAGS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_DEVICE</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_DEVICEH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VP_BRIGHTNESS</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_BRIGHTNESS</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP4_EXPOSURE_TARGET</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP5_EXPOSURE_TARGET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_CONTRAST</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_CONTRAST</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_YRANGE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VP_SATURATION</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_SATURATION</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_SATURATION</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP5_MCUVSATURATION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VP_GPIO_DATA</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_GPIO_DATA</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_GPIO_DATA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VP_GPIO_DIRECTION</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_GPIO_DIRECTION</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_GPIO_DIRECTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DATA</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VC_MP_GPIO_DATA</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VC_MP_DATA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DIRECTION</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VC_MP_GPIO_DIRECTION</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VC_MP_DIR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_ENABLE_PACKET_CTRL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_INT_PACKET_CTRL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_FLICKER_MODES</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_FLICKER_MODES</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_FLICKER_MODES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_RESET_FIFO</span>:	<span class="cm">/* clear fifo and enable stream block */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL_SRC_VC</span> <span class="o">|</span>
		    <span class="n">CPIA2_VC_ST_CTRL_DST_USB</span> <span class="o">|</span> <span class="n">CPIA2_VC_ST_CTRL_EOF_DETECT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL_SRC_VC</span> <span class="o">|</span>
		    <span class="n">CPIA2_VC_ST_CTRL_DST_USB</span> <span class="o">|</span>
		    <span class="n">CPIA2_VC_ST_CTRL_EOF_DETECT</span> <span class="o">|</span>
		    <span class="n">CPIA2_VC_ST_CTRL_FIFO_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_HI_POWER</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span>
		    <span class="n">CPIA2_SYSTEM_SYSTEM_CONTROL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span>
		    <span class="n">CPIA2_SYSTEM_SYSTEM_CONTROL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_CONTROL_CLEAR_ERR</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="n">CPIA2_SYSTEM_CONTROL_HIGH_POWER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_LOW_POWER</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_SYSTEM_CONTROL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_CLEAR_V2W_ERR</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_SYSTEM_CONTROL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_CONTROL_CLEAR_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_USER_MODE</span>:   <span class="cm">/* Then fall through */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_USER_MODE</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP4_USER_MODE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP5_USER_MODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_FRAMERATE_REQ</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP4_FRAMERATE_REQUEST</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP5_FRAMERATE_REQUEST</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_WAKEUP</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_WAKEUP</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VC_WAKEUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_PW_CONTROL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_PW_CONTROL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VC_PW_CTRL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_SYSTEM_STATE</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_SYSTEMSTATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_SYSTEM_CTRL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_SYSTEM_CTRL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_SYSTEM_CONTROL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VP_SYSTEM_CTRL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_SYSTEM_CTRL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_SYSTEMCTRL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VP_EXP_MODES</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_EXP_MODES</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_EXPOSURE_MODES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_DEVICE_CONFIG</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_DEVICE_CONFIG</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_DEVICE_CONFIG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_SERIAL_ADDR</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span>
		    <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_VP_SERIAL_ADDR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_SENSOR_CR1</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_SENSOR_CR1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_VC_CONTROL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>	<span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VC_CONTROL</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_CTRL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_TARGET_KB</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_TARGET_KB</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_DEF_JPEG_OPT</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_JPEG_OPT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="n">CPIA2_VC_VC_JPEG_OPT_DOUBLE_SQUEEZE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_USER_SQUEEZE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_CREEP_PERIOD</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_JPEG_OPT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_JPEG_OPT_DEFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_REHASH_VP4</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_REHASH_VALUES</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_SET_USER_EFFECTS</span>:  <span class="cm">/* Note: Be careful with this as</span>
<span class="cm">					     this register can also affect</span>
<span class="cm">					     flicker modes */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>      <span class="cm">/* Then fall through */</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_USER_EFFECTS</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP4_USER_EFFECTS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP5_USER_EFFECTS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">LOG</span><span class="p">(</span><span class="s">&quot;DoCommand received invalid command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/***</span>
<span class="cm">	 * Now copy any results from a read into the appropriate param struct.</span>
<span class="cm">	 ***/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VERSION</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">firmware_revision_hi</span> <span class="o">=</span>
		    <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">firmware_revision_lo</span> <span class="o">=</span>
		    <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_PNP_ID</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					    <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					     <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_revision</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x553</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DEVICE_STV_672</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0x140</span> <span class="o">||</span>
				   <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0x151</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DEVICE_STV_676</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_ASIC_TYPE</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">asic_id</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">asic_rev</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_SENSOR</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_rev</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_DEVICE</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">vp_device_hi</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">vp_device_lo</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_GPIO_DATA</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_data</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_GPIO_DIRECTION</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_direction</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VC_MP_GPIO_DIRECTION</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">vc_mp_direction</span> <span class="o">=</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VC_MP_GPIO_DATA</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">vc_mp_data</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_FLICKER_MODES</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flicker_control</span><span class="p">.</span><span class="n">cam_register</span> <span class="o">=</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_WAKEUP</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">wakeup</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_PW_CONTROL</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">pw_control</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_SYSTEM_CTRL</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">system_ctrl</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_SYSTEM_STATE</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">system_state</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_SYSTEM_CTRL</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">system_ctrl</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VP_EXP_MODES</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">exposure_modes</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_DEVICE_CONFIG</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">device_config</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_VC_CONTROL</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">vc_control</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_USER_MODE</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">video_mode</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_CMD_GET_USER_EFFECTS</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">user_effects</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_send_command</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#define DIR(cmd) ((cmd-&gt;direction == TRANSFER_WRITE) ? &quot;Write&quot; : &quot;Read&quot;)</span>
<span class="cp">#define BINDEX(cmd) (cmd-&gt;req_mode &amp; 0x03)</span>

<span class="kt">int</span> <span class="nf">cpia2_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpia2_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req_mode</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reg_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpia2_register</span><span class="p">);</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugs_on</span> <span class="o">&amp;</span> <span class="n">DEBUG_REG</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s Random: Register block %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kt">DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
			    <span class="n">block_name</span><span class="p">[</span><span class="n">BINDEX</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reg_count</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugs_on</span> <span class="o">&amp;</span> <span class="n">DEBUG_REG</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s Block: Register block %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kt">DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
			    <span class="n">block_name</span><span class="p">[</span><span class="n">BINDEX</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAMERAACCESS_TYPE_MASK</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reg_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpia2_reg_mask</span><span class="p">);</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugs_on</span> <span class="o">&amp;</span> <span class="n">DEBUG_REG</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s Mask: Register block %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kt">DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
			    <span class="n">block_name</span><span class="p">[</span><span class="n">BINDEX</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAMERAACCESS_TYPE_REPEAT</span>:	<span class="cm">/* For patch blocks only */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reg_count</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugs_on</span> <span class="o">&amp;</span> <span class="n">DEBUG_REG</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s Repeat: Register block %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kt">DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
			    <span class="n">block_name</span><span class="p">[</span><span class="n">BINDEX</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">LOG</span><span class="p">(</span><span class="s">&quot;%s: invalid request mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">cpia2_usb_transfer_cmd</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
					<span class="n">buffer</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req_mode</span><span class="p">,</span>
					<span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">);</span>
<span class="cp">#ifdef _CPIA2_DEBUG_</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugs_on</span> <span class="o">&amp;</span> <span class="n">DEBUG_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reg_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req_mode</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span><span class="p">)</span>
				<span class="n">KINFO</span><span class="p">(</span><span class="s">&quot;%s Block: [0x%02X] = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="kt">DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req_mode</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span><span class="p">)</span>
				<span class="n">KINFO</span><span class="p">(</span><span class="s">&quot;%s Random: [0x%02X] = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="kt">DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">,</span>
				    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*************</span>
<span class="cm"> * Functions to implement camera functionality</span>
<span class="cm"> *************/</span>
<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_get_version_info</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpia2_get_version_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VERSION</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_PNP_ID</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_ASIC_TYPE</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_SENSOR</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VP_DEVICE</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_reset_camera</span>
<span class="cm"> *</span>
<span class="cm"> *  Called at least during the open process, sets up initial params.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_reset_camera</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target_kb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpia2_command</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/***</span>
<span class="cm">	 * VC setup</span>
<span class="cm">	 ***/</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">configure_sensor</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
				  <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
				  <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t configure sensor, error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear FIFO and route/enable stream block */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL_SRC_VC</span> <span class="o">|</span>
		<span class="n">CPIA2_VC_ST_CTRL_DST_USB</span> <span class="o">|</span> <span class="n">CPIA2_VC_ST_CTRL_EOF_DETECT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">CPIA2_VC_ST_CTRL_SRC_VC</span> <span class="o">|</span>
		<span class="n">CPIA2_VC_ST_CTRL_DST_USB</span> <span class="o">|</span>
		<span class="n">CPIA2_VC_ST_CTRL_EOF_DETECT</span> <span class="o">|</span> <span class="n">CPIA2_VC_ST_CTRL_FIFO_ENABLE</span><span class="p">;</span>

	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">cpia2_set_high_power</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable button notification */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_SYSTEM_INT_PACKET_CTRL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
			<span class="n">CPIA2_SYSTEM_INT_PACKET_CTRL_ENABLE_SW_XX</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">apply_vp_patch</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="cm">/* wait for vp to go to sleep */</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>

	<span class="cm">/***</span>
<span class="cm">	 * If this is a 676, apply VP5 fixes before we start streaming</span>
<span class="cm">	 ***/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_676</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>

		<span class="cm">/* The following writes improve the picture */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP5_MYBLACK_LEVEL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* reduce from the default</span>
<span class="cm">						    * rec 601 pedestal of 16 */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP5_MCYRANGE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0x92</span><span class="p">;</span> <span class="cm">/* increase from 100% to</span>
<span class="cm">						       * (256/256 - 31) to fill</span>
<span class="cm">						       * available range */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP5_MYCEILING</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="cm">/* Increase from the</span>
<span class="cm">						       * default rec 601 ceiling</span>
<span class="cm">						       * of 240 */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP5_MCUVSATURATION</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="cm">/* Increase from the rec</span>
<span class="cm">						       * 601 100% level (128)</span>
<span class="cm">						       * to 145-192 */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP5_ANTIFLKRSETUP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>  <span class="cm">/* Inhibit the</span>
<span class="cm">							* anti-flicker */</span>

		<span class="cm">/* The following 4 writes are a fix to allow QVGA to work at 30 fps */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_RAM_ADDR_H</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_RAM_ADDR_L</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0xE3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_RAM_DATA</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_RAM_DATA</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Activate all settings and start the data stream */</span>
	<span class="cm">/* Set user mode */</span>
	<span class="n">set_default_user_mode</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="cm">/* Give VP time to wake up */</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>

	<span class="n">set_all_properties</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_USER_MODE</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;After SetAllProperties(cam), user mode is 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">video_mode</span><span class="p">);</span>

	<span class="cm">/***</span>
<span class="cm">	 * Set audio regulator off.  This and the code to set the compresison</span>
<span class="cm">	 * state are too complex to form a CPIA2_CMD_, and seem to be somewhat</span>
<span class="cm">	 * intertwined.  This stuff came straight from the windows driver.</span>
<span class="cm">	 ***/</span>
	<span class="cm">/* Turn AutoExposure off in VP and enable the serial bridge to the sensor */</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VP_SYSTEM_CTRL</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">system_ctrl</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp_reg</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">tmp_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CPIA2_VP_SYSTEMCTRL_HK_CONTROL</span> <span class="o">^</span> <span class="mh">0xFF</span><span class="p">));</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_DEVICE_CONFIG</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">device_config</span> <span class="o">|</span>
					<span class="n">CPIA2_VP_DEVICE_CONFIG_SERIAL_BRIDGE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_SYSTEMCTRL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_DEVICE_CONFIG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Set the correct I2C address in the CPiA-2 system register */</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
			 <span class="n">CPIA2_CMD_SET_SERIAL_ADDR</span><span class="p">,</span>
			 <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
			 <span class="n">CPIA2_SYSTEM_VP_SERIAL_ADDR_SENSOR</span><span class="p">);</span>

	<span class="cm">/* Now have sensor access - set bit to turn the audio regulator off */</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
			 <span class="n">CPIA2_CMD_SET_SENSOR_CR1</span><span class="p">,</span>
			 <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">CPIA2_SENSOR_CR1_DOWN_AUDIO_REGULATOR</span><span class="p">);</span>

	<span class="cm">/* Set the correct I2C address in the CPiA-2 system register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
		<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
				 <span class="n">CPIA2_CMD_SET_SERIAL_ADDR</span><span class="p">,</span>
				 <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
				 <span class="n">CPIA2_SYSTEM_VP_SERIAL_ADDR_VP</span><span class="p">);</span> <span class="c1">// 0x88</span>
	<span class="k">else</span>
		<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
				 <span class="n">CPIA2_CMD_SET_SERIAL_ADDR</span><span class="p">,</span>
				 <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
				 <span class="n">CPIA2_SYSTEM_VP_SERIAL_ADDR_676_VP</span><span class="p">);</span> <span class="c1">// 0x8a</span>

	<span class="cm">/* increase signal drive strength */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_676</span><span class="p">)</span>
		<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
				 <span class="n">CPIA2_CMD_SET_VP_EXP_MODES</span><span class="p">,</span>
				 <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
				 <span class="n">CPIA2_VP_EXPOSURE_MODES_COMPILE_EXP</span><span class="p">);</span>

	<span class="cm">/* Start autoexposure */</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_DEVICE_CONFIG</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">device_config</span> <span class="o">&amp;</span>
				  <span class="p">(</span><span class="n">CPIA2_VP_DEVICE_CONFIG_SERIAL_BRIDGE</span> <span class="o">^</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VP_SYSTEM_CTRL</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
	    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">system_ctrl</span> <span class="o">|</span> <span class="n">CPIA2_VP_SYSTEMCTRL_HK_CONTROL</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_DEVICE_CONFIG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VP_SYSTEMCTRL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>

	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Set compression state */</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VC_CONTROL</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">compression</span><span class="p">.</span><span class="n">inhibit_htables</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">vc_control</span> <span class="o">|</span>
			  <span class="n">CPIA2_VC_VC_CTRL_INHIBIT_H_TABLES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">vc_control</span> <span class="o">&amp;</span>
			  <span class="o">~</span><span class="n">CPIA2_VC_VC_CTRL_INHIBIT_H_TABLES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_VC_CONTROL</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span><span class="n">tmp_reg</span><span class="p">);</span>

	<span class="cm">/* Set target size (kb) on vc</span>
<span class="cm">	   This is a heuristic based on the quality parameter and the raw</span>
<span class="cm">	   framesize in kB divided by 16 (the compression factor when the</span>
<span class="cm">	   quality is 100%) */</span>
	<span class="n">target_kb</span> <span class="o">=</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">16384</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">quality</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">target_kb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_TARGET_KB</span><span class="p">,</span>
			 <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">target_kb</span><span class="p">);</span>

	<span class="cm">/* Wiggle VC Reset */</span>
	<span class="cm">/***</span>
<span class="cm">	 * First read and wait a bit.</span>
<span class="cm">	 ***/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_PW_CONTROL</span><span class="p">,</span>
				 <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">pw_control</span><span class="p">;</span>
	<span class="n">tmp_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VC_PW_CTRL_VC_RESET_N</span><span class="p">;</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_PW_CONTROL</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span><span class="n">tmp_reg</span><span class="p">);</span>

	<span class="n">tmp_reg</span> <span class="o">|=</span> <span class="n">CPIA2_VC_PW_CTRL_VC_RESET_N</span><span class="p">;</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_PW_CONTROL</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span><span class="n">tmp_reg</span><span class="p">);</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_DEF_JPEG_OPT</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_USER_MODE</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;After VC RESET, user mode is 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">video_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_high_power</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpia2_set_high_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read system status */</span>
		<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span><span class="n">CPIA2_CMD_GET_SYSTEM_CTRL</span><span class="p">,</span><span class="n">TRANSFER_READ</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* If there is an error, clear it */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">system_ctrl</span> <span class="o">&amp;</span>
		   <span class="n">CPIA2_SYSTEM_CONTROL_V2W_ERR</span><span class="p">)</span>
			<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_CLEAR_V2W_ERR</span><span class="p">,</span>
					 <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Try to set high power mode */</span>
		<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_SYSTEM_CTRL</span><span class="p">,</span>
				 <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Try to read something in VP to check if everything is awake */</span>
		<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VP_SYSTEM_STATE</span><span class="p">,</span>
				 <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">system_state</span> <span class="o">&amp;</span>
		    <span class="n">CPIA2_VP_SYSTEMSTATE_HK_ALIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">LO_POWER_MODE</span><span class="p">;</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Camera did not wake up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;System now in high power state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">HI_POWER_MODE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_low_power</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_set_low_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">LO_POWER_MODE</span><span class="p">;</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_SYSTEM_CTRL</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  apply_vp_patch</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpia2_send_onebyte_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">cpia2_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">start</span><span class="p">,</span> <span class="n">u8</span> <span class="n">datum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_vp_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fw_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;cpia2/stv0672_vp4.bin&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpia2_command</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cpia2: failed to load VP patch </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_REPEAT</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>

	<span class="cm">/* First send the start address... */</span>
	<span class="n">cpia2_send_onebyte_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="cm">/* hi */</span>
	<span class="n">cpia2_send_onebyte_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="cm">/* lo */</span>

	<span class="cm">/* ... followed by the data payload */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span> <span class="cm">/* Data */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span><span class="p">);</span>
		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Next send the start address... */</span>
	<span class="n">cpia2_send_onebyte_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="cm">/* hi */</span>
	<span class="n">cpia2_send_onebyte_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="cm">/* lo */</span>

	<span class="cm">/* ... followed by the &#39;goto&#39; command */</span>
	<span class="n">cpia2_send_onebyte_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  set_default_user_mode</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_default_user_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">user_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">frame_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_404</span>:
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_407</span>:
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_409</span>:
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_410</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_QCIF_COLS</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_QCIF_ROWS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">user_mode</span> <span class="o">=</span> <span class="n">CPIA2_VP_USER_MODE_CIF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">user_mode</span> <span class="o">=</span> <span class="n">CPIA2_VP_USER_MODE_QCIFDS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">frame_rate</span> <span class="o">=</span> <span class="n">CPIA2_VP_FRAMERATE_30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_500</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_CIF_COLS</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">user_mode</span> <span class="o">=</span> <span class="n">CPIA2_VP_USER_MODE_VGA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">user_mode</span> <span class="o">=</span> <span class="n">CPIA2_VP_USER_MODE_QVGADS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
			<span class="n">frame_rate</span> <span class="o">=</span> <span class="n">CPIA2_VP_FRAMERATE_15</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">frame_rate</span> <span class="o">=</span> <span class="n">CPIA2_VP_FRAMERATE_30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">LOG</span><span class="p">(</span><span class="s">&quot;%s: Invalid sensor flag value 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span>
		    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Sensor flag = 0x%0x, user mode = 0x%0x, frame rate = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span><span class="p">,</span> <span class="n">user_mode</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_USER_MODE</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
			 <span class="n">user_mode</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">frame_rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">frame_rate</span> <span class="o">&gt;</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">frame_rate</span><span class="p">)</span>
		<span class="n">frame_rate</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">frame_rate</span><span class="p">;</span>

	<span class="n">cpia2_set_fps</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>if (cam->params.pnp<em>id.device</em>type == DEVICE<em>STV</em>676)
    cpia2<em>do</em>command(cam,
             CPIA2<em>CMD</em>SET<em>VP</em>SYSTEM<em>CTRL,
             TRANSFER</em>WRITE,
             CPIA2<em>VP</em>SYSTEMCTRL<em>HK</em>CONTROL |
             CPIA2<em>VP</em>SYSTEMCTRL<em>POWER</em>CONTROL);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_match_video_size</span>
<span class="cm"> *</span>
<span class="cm"> *  return the best match, where &#39;best&#39; is as always</span>
<span class="cm"> *  the largest that is not bigger than what is requested.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_match_video_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_VGA_COLS</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_VGA_ROWS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_CIF_COLS</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_QVGA_COLS</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_QVGA_ROWS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_QVGA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">288</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">216</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_288_216</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">256</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">192</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_256_192</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">224</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">168</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_224_168</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">192</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">144</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_192_144</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_QCIF_COLS</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="n">STV_IMAGE_QCIF_ROWS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  SetVideoSize</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_vw_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">video_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_VGA</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Setting size to VGA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_VGA_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_VGA_ROWS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_VGA_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_VGA_ROWS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_CIF</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Setting size to CIF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_QVGA</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Setting size to QVGA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_QVGA_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_QVGA_ROWS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_QVGA_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_QVGA_ROWS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_288_216</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">288</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">216</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">288</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">216</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_256_192</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_224_168</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">224</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">168</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">224</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">168</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_192_144</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">144</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">144</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIDEOSIZE_QCIF</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Setting size to QCIF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_QCIF_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_QCIF_ROWS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_QCIF_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_QCIF_ROWS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  configure_sensor</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">req_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_404</span>:
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_407</span>:
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_409</span>:
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_410</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">config_sensor_410</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">req_width</span><span class="p">,</span> <span class="n">req_height</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_500</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">config_sensor_500</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">req_width</span><span class="p">,</span> <span class="n">req_height</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  config_sensor_410</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_sensor_410</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">req_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpia2_command</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">image_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">image_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">req_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">req_height</span><span class="p">;</span>

	<span class="cm">/***</span>
<span class="cm">	 *  Make sure size doesn&#39;t exceed CIF.</span>
<span class="cm">	 ***/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_CIF_COLS</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_COLS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">;</span>

	<span class="n">image_size</span> <span class="o">=</span> <span class="n">cpia2_match_video_size</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Config 410: width = %d, height = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Image size returned is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">image_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_size</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_vw_size</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">image_size</span><span class="p">);</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;After set_vw_size(), width = %d, height = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">176</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">144</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;image type = VIDEOSIZE_QCIF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">320</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">240</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;image type = VIDEOSIZE_QVGA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_QVGA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;image type = VIDEOSIZE_CIF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;ConfigSensor410 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>

	<span class="cm">/* VC Format */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_FORMAT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">CPIA2_VC_VC_FORMAT_UFIRST</span> <span class="o">|</span>
			  <span class="n">CPIA2_VC_VC_FORMAT_SHORTLINE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">CPIA2_VC_VC_FORMAT_UFIRST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* VC Clocks */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_CLOCKS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span><span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">CPIA2_VC_VC_672_CLOCKS_CIF_DIV_BY_3</span> <span class="o">|</span>
				     <span class="n">CPIA2_VC_VC_672_CLOCKS_SCALING</span> <span class="o">|</span>
				     <span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV2</span><span class="p">);</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;VC_Clocks (0xc4) should be B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span><span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">CPIA2_VC_VC_676_CLOCKS_CIF_DIV_BY_3</span> <span class="o">|</span>
				     <span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
			   <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">CPIA2_VC_VC_672_CLOCKS_CIF_DIV_BY_3</span> <span class="o">|</span>
				 <span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
			   <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">CPIA2_VC_VC_676_CLOCKS_CIF_DIV_BY_3</span> <span class="o">|</span>
				 <span class="n">CPIA2_VC_VC_676_CLOCKS_SCALING</span> <span class="o">|</span>
				 <span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;VC_Clocks (0xc4) = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Input reqWidth from VC */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_IHSIZE_LO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">STV_IMAGE_QCIF_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">STV_IMAGE_CIF_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Timings */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_XLIM_HI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_XLIM_LO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">208</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">160</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_YLIM_HI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_YLIM_LO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">160</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">64</span><span class="p">;</span>

	<span class="cm">/* Output Image Size */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_OHSIZE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_OVSIZE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Cropping */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HCROP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_QCIF_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_CIF_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VCROP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_QCIF_ROWS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_CIF_ROWS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Scaling registers (defaults) */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HPHASE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VPHASE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HISPAN</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">31</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VISPAN</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">31</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HICROP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VICROP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HFRACT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x81</span><span class="p">;</span>	<span class="cm">/* = 8/1 = 8 (HIBYTE/LOBYTE) */</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VFRACT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x81</span><span class="p">;</span>	<span class="cm">/* = 8/1 = 8 (HIBYTE/LOBYTE) */</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  config_sensor_500(cam)</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_sensor_500</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">req_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpia2_command</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">image_size</span> <span class="o">=</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">req_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">req_height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span><span class="p">;</span>

	<span class="n">image_size</span> <span class="o">=</span> <span class="n">cpia2_match_video_size</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_CIF_COLS</span> <span class="o">||</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">)</span>
		<span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_QVGA_COLS</span> <span class="o">||</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_QVGA_ROWS</span><span class="p">)</span>
		<span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_QCIF_COLS</span> <span class="o">||</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">STV_IMAGE_QCIF_ROWS</span><span class="p">)</span>
		<span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_QVGA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">image_type</span> <span class="o">=</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image_size</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_vw_size</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">image_size</span><span class="p">);</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;ConfigSensor500 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;image_size = %d, width = %d, height = %d, type = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">image_size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">image_type</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_RANDOM</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* VC Format */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_FORMAT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">CPIA2_VC_VC_FORMAT_UFIRST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">CPIA2_VC_VC_FORMAT_DECIMATING</span><span class="p">;</span>
	<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* VC Clocks */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_CLOCKS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">CPIA2_VC_VC_672_CLOCKS_SCALING</span> <span class="o">|</span>
				     <span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">CPIA2_VC_VC_676_CLOCKS_SCALING</span> <span class="o">|</span>
				     <span class="n">CPIA2_VC_VC_CLOCKS_LOGDIV2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;VC_CLOCKS = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Input width from VP */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_IHSIZE_LO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">STV_IMAGE_VGA_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">STV_IMAGE_QVGA_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Input width = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Timings */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_XLIM_HI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_XLIM_LO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">250</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QVGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">125</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">160</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_YLIM_HI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_YLIM_LO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QVGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">6</span><span class="p">;</span>

	<span class="cm">/* Output Image Size */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_OHSIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_COLS</span>  <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_OVSIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_ROWS</span>  <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Cropping */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HCROP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_VGA_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QVGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_QVGA_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_CIF_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/*if (image_type == VIDEOSIZE_QCIF)*/</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_QCIF_COLS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VCROP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_VGA_ROWS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QVGA</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_QVGA_ROWS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_CIF_ROWS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/*if (image_type == VIDEOSIZE_QCIF)*/</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(((</span><span class="n">STV_IMAGE_QCIF_ROWS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Scaling registers (defaults) */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HPHASE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span> <span class="o">||</span> <span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">36</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VPHASE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span> <span class="o">||</span> <span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HISPAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span> <span class="o">||</span> <span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">26</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">31</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VISPAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span> <span class="o">||</span> <span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">21</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">31</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HICROP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VICROP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_HFRACT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span> <span class="o">||</span> <span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x2B</span><span class="p">;</span>	<span class="cm">/* 2/11 */</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x81</span><span class="p">;</span>	<span class="cm">/* 8/1 */</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_VFRACT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_CIF</span> <span class="o">||</span> <span class="n">image_type</span> <span class="o">==</span> <span class="n">VIDEOSIZE_QCIF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x13</span><span class="p">;</span>	<span class="cm">/* 1/3 */</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="mh">0x81</span><span class="p">;</span>	<span class="cm">/* 8/1 */</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  setallproperties</span>
<span class="cm"> *</span>
<span class="cm"> *  This sets all user changeable properties to the values in cam-&gt;params.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_all_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Don&#39;t set target_kb here, it will be set later.</span>
<span class="cm">	 * framerate and user_mode were already set (set_default_user_mode).</span>
<span class="cm">	 **/</span>

	<span class="n">cpia2_usb_change_streaming_alternate</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
					  <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">stream_mode</span><span class="p">);</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
			 <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DIRECTION</span><span class="p">,</span>
			 <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_direction</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DATA</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
			 <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_data</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>

	<span class="n">wake_system</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="n">set_lowlight_boost</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_save_camera_state</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_save_camera_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_USER_EFFECTS</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VC_MP_GPIO_DIRECTION</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VC_MP_GPIO_DATA</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t get framerate or target_kb. Trust the values we already have */</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_flicker_mode</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_set_flicker_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cam_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Set the appropriate bits in FLICKER_MODES, preserving the rest */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_FLICKER_MODES</span><span class="p">,</span>
				   <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">cam_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flicker_control</span><span class="p">.</span><span class="n">cam_register</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NEVER_FLICKER</span>:
		<span class="n">cam_reg</span> <span class="o">|=</span> <span class="n">CPIA2_VP_FLICKER_MODES_NEVER_FLICKER</span><span class="p">;</span>
		<span class="n">cam_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VP_FLICKER_MODES_50HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLICKER_60</span>:
		<span class="n">cam_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VP_FLICKER_MODES_NEVER_FLICKER</span><span class="p">;</span>
		<span class="n">cam_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VP_FLICKER_MODES_50HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLICKER_50</span>:
		<span class="n">cam_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VP_FLICKER_MODES_NEVER_FLICKER</span><span class="p">;</span>
		<span class="n">cam_reg</span> <span class="o">|=</span> <span class="n">CPIA2_VP_FLICKER_MODES_50HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_FLICKER_MODES</span><span class="p">,</span>
				   <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">cam_reg</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set the appropriate bits in EXP_MODES, preserving the rest */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_VP_EXP_MODES</span><span class="p">,</span>
				   <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">cam_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">exposure_modes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NEVER_FLICKER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cam_reg</span> <span class="o">|=</span> <span class="n">CPIA2_VP_EXPOSURE_MODES_INHIBIT_FLICKER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cam_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VP_EXPOSURE_MODES_INHIBIT_FLICKER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_VP_EXP_MODES</span><span class="p">,</span>
				   <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">cam_reg</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_REHASH_VP4</span><span class="p">,</span>
				   <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NEVER_FLICKER</span>:
	<span class="k">case</span> <span class="n">FLICKER_60</span>:
	<span class="k">case</span> <span class="n">FLICKER_50</span>:
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flicker_control</span><span class="p">.</span><span class="n">flicker_mode_req</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_property_flip</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_set_property_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prop_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cam_reg</span><span class="p">;</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_USER_EFFECTS</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cam_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">user_effects</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prop_val</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cam_reg</span> <span class="o">|=</span> <span class="n">CPIA2_VP_USER_EFFECTS_FLIP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">cam_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VP_USER_EFFECTS_FLIP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">user_effects</span> <span class="o">=</span> <span class="n">cam_reg</span><span class="p">;</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_USER_EFFECTS</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
			 <span class="n">cam_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_property_mirror</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_set_property_mirror</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prop_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cam_reg</span><span class="p">;</span>

	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_GET_USER_EFFECTS</span><span class="p">,</span> <span class="n">TRANSFER_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cam_reg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">user_effects</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prop_val</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cam_reg</span> <span class="o">|=</span> <span class="n">CPIA2_VP_USER_EFFECTS_MIRROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">cam_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPIA2_VP_USER_EFFECTS_MIRROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">user_effects</span> <span class="o">=</span> <span class="n">cam_reg</span><span class="p">;</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_USER_EFFECTS</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
			 <span class="n">cam_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_gpio</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Set the microport direction (register 0x90, should be defined</span>
<span class="cm">	 * already) to 1 (user output), and set the microport data (0x91) to</span>
<span class="cm">	 * the value in the ioctl argument.</span>
<span class="cm">	 */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
			       <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DIRECTION</span><span class="p">,</span>
			       <span class="n">CPIA2_VC_MP_DIR_OUTPUT</span><span class="p">,</span>
			       <span class="mi">255</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_direction</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
			       <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DATA</span><span class="p">,</span>
			       <span class="n">CPIA2_VC_MP_DIR_OUTPUT</span><span class="p">,</span>
			       <span class="n">setting</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_data</span> <span class="o">=</span> <span class="n">setting</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_fps</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_set_fps</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">int</span> <span class="n">framerate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">framerate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CPIA2_VP_FRAMERATE_30</span>:
		<span class="k">case</span> <span class="n">CPIA2_VP_FRAMERATE_25</span>:
			<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span> <span class="o">&amp;&amp;</span>
			   <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span> <span class="o">==</span>
						    <span class="n">CPIA2_VP_SENSOR_FLAGS_500</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="n">CPIA2_VP_FRAMERATE_15</span>:
		<span class="k">case</span> <span class="n">CPIA2_VP_FRAMERATE_12_5</span>:
		<span class="k">case</span> <span class="n">CPIA2_VP_FRAMERATE_7_5</span>:
		<span class="k">case</span> <span class="n">CPIA2_VP_FRAMERATE_6_25</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span> <span class="o">&amp;&amp;</span>
	    <span class="n">framerate</span> <span class="o">==</span> <span class="n">CPIA2_VP_FRAMERATE_15</span><span class="p">)</span>
		<span class="n">framerate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Work around bug in VP4 */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
				 <span class="n">CPIA2_CMD_FRAMERATE_REQ</span><span class="p">,</span>
				 <span class="n">TRANSFER_WRITE</span><span class="p">,</span>
				 <span class="n">framerate</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">frame_rate</span> <span class="o">=</span> <span class="n">framerate</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_brightness</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/***</span>
<span class="cm">	 * Don&#39;t let the register be set to zero - bug in VP4 - flash of full</span>
<span class="cm">	 * brightness</span>
<span class="cm">	 ***/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span><span class="o">++</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Setting brightness to %d (0x%0x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_VP_BRIGHTNESS</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_contrast</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_set_contrast</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Setting contrast to %d (0x%0x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_CONTRAST</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_saturation</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_set_saturation</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Setting saturation to %d (0x%0x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span><span class="n">CPIA2_CMD_SET_VP_SATURATION</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  wake_system</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wake_system</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_WAKEUP</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  set_lowlight_boost</span>
<span class="cm"> *</span>
<span class="cm"> *  Valid for STV500 sensor only</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_lowlight_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpia2_command</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_STV_672</span> <span class="o">||</span>
	    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span> <span class="o">!=</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_500</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_WRITE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_RAM_ADDR_H</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* High byte of address to write to */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x59</span><span class="p">;</span>	<span class="cm">/* Low byte of address to write to */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* High byte of data to write */</span>

	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">lowlight_boost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* Low byte data to write */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP_RAM_DATA</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Rehash the VP4 values */</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_REHASH_VP4</span><span class="p">,</span> <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_set_format</span>
<span class="cm"> *</span>
<span class="cm"> *  Assumes that new size is already set in param struct.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">flush</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">cpia2_usb_stream_pause</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="cm">/* reset camera to new size */</span>
	<span class="n">cpia2_set_low_power</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="n">cpia2_reset_camera</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">flush</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">cpia2_dbg_dump_registers</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="n">cpia2_usb_stream_resume</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * cpia2_dbg_dump_registers</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_dbg_dump_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef _CPIA2_DEBUG_</span>
	<span class="k">struct</span> <span class="n">cpia2_command</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">debugs_on</span> <span class="o">&amp;</span> <span class="n">DEBUG_DUMP_REGS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">TRANSFER_READ</span><span class="p">;</span>

	<span class="cm">/* Start with bank 0 (SYSTEM) */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_SYSTEM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;System Device Hi      = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;System Device Lo      = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;System_system control = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="cm">/* Bank 1 (VC) */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VC</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ASIC_ID       = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ASIC_REV      = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PW_CONTRL     = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;WAKEUP        = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>	<span class="cm">/* ST_CTRL */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Stream ctrl   = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xA4</span><span class="p">;</span>	<span class="cm">/* Stream status */</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Stream status = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xA8</span><span class="p">;</span>	<span class="cm">/* USB status */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;USB_CTRL      = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;USB_STRM      = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;USB_STATUS    = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xAF</span><span class="p">;</span>	<span class="cm">/* USB settings */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;USB settings  = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>	<span class="cm">/* VC stuff */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC Control    = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC Format     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC Clocks     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC IHSize     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC Xlim Hi    = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC XLim Lo    = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC YLim Hi    = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC YLim Lo    = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC OHSize     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC OVSize     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC HCrop      = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC VCrop      = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC HPhase     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC VPhase     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC HIspan     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC VIspan     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC HiCrop     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">18</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC ViCrop     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC HiFract    = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC ViFract    = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC JPeg Opt   = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">22</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC Creep Per  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">23</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC User Sq.   = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">24</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VC Target KB  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">25</span><span class="p">]);</span>

	<span class="cm">/*** VP ***/</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req_mode</span> <span class="o">=</span> <span class="n">CAMERAACCESS_TYPE_BLOCK</span> <span class="o">|</span> <span class="n">CAMERAACCESS_VP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Dev Hi     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Dev Lo     = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Sys State  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Sys Ctrl   = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Sensor flg = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Sensor Rev = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Dev Config = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP GPIO_DIR   = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP GPIO_DATA  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Ram ADDR H = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Ram ADDR L = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP RAM Data   = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Do Call       = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Clock Ctrl = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Patch Rev  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Vid Mode   = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Framerate  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP UserEffect = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP White Bal  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP WB thresh  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Exp Modes  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Exp Target = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x1B</span><span class="p">;</span>
		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP FlickerMds = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Clock Ctrl = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Patch Rev  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Vid Mode   = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP Framerate  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP UserEffect = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">CPIA2_VP5_EXPOSURE_TARGET</span><span class="p">;</span>
		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP5 Exp Target= 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">reg_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3A</span><span class="p">;</span>
		<span class="n">cpia2_send_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP5 MY Black  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP5 MCY Range = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP5 MYCEILING = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VP5 MCUV Sat  = 0x%0X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">block_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  reset_camera_struct</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets all values to the defaults</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_camera_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/***</span>
<span class="cm">	 * The following parameter values are the defaults from the register map.</span>
<span class="cm">	 ***/</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">lowlight_boost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FlickerModes */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flicker_control</span><span class="p">.</span><span class="n">flicker_mode_req</span> <span class="o">=</span> <span class="n">NEVER_FLICKER</span><span class="p">;</span>

	<span class="cm">/* jpeg params */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">compression</span><span class="p">.</span><span class="n">jpeg_options</span> <span class="o">=</span> <span class="n">CPIA2_VC_VC_JPEG_OPT_DEFAULT</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">compression</span><span class="p">.</span><span class="n">creep_period</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">compression</span><span class="p">.</span><span class="n">user_squeeze</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">compression</span><span class="p">.</span><span class="n">inhibit_htables</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* gpio params */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* write, the default safe mode */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">gpio_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Target kb params */</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vc_params</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/***</span>
<span class="cm">	 * Set Sensor FPS as fast as possible.</span>
<span class="cm">	 ***/</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pnp_id</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_STV_672</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span> <span class="o">==</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_500</span><span class="p">)</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">frame_rate</span> <span class="o">=</span> <span class="n">CPIA2_VP_FRAMERATE_15</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">frame_rate</span> <span class="o">=</span> <span class="n">CPIA2_VP_FRAMERATE_30</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vp_params</span><span class="p">.</span><span class="n">frame_rate</span> <span class="o">=</span> <span class="n">CPIA2_VP_FRAMERATE_30</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/***</span>
<span class="cm">	 * Set default video mode as large as possible :</span>
<span class="cm">	 * for vga sensor set to vga, for cif sensor set to CIF.</span>
<span class="cm">	 ***/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">sensor_flags</span> <span class="o">==</span> <span class="n">CPIA2_VP_SENSOR_FLAGS_500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">sensor_type</span> <span class="o">=</span> <span class="n">CPIA2_SENSOR_500</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="n">VIDEOSIZE_VGA</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_VGA_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_VGA_ROWS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">sensor_type</span> <span class="o">=</span> <span class="n">CPIA2_SENSOR_410</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="n">VIDEOSIZE_CIF</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_COLS</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">STV_IMAGE_CIF_ROWS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">roi</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_init_camera_struct</span>
<span class="cm"> *</span>
<span class="cm"> *  Initializes camera struct, does not call reset to fill in defaults.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="nf">cpia2_init_camera_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">;</span>

	<span class="n">cam</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cam</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;couldn&#39;t kmalloc cpia2 struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">cpia2_camera_release</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register v4l2_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">wq_stream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cam</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_init_camera</span>
<span class="cm"> *</span>
<span class="cm"> *  Initializes camera.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_init_camera</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">mmapped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Get sensor and asic types before reset. */</span>
	<span class="n">cpia2_set_high_power</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="n">cpia2_get_version_info</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">asic_id</span> <span class="o">!=</span> <span class="n">CPIA2_ASIC_672</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Device IO error (asicID has incorrect value of 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">asic_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set GPIO direction and data to a safe state. */</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DIRECTION</span><span class="p">,</span>
			 <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpia2_do_command</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">CPIA2_CMD_SET_VC_MP_GPIO_DATA</span><span class="p">,</span>
			 <span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* resetting struct requires version info for sensor and asic types */</span>
	<span class="n">reset_camera_struct</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="n">cpia2_set_low_power</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;End</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_allocate_buffers</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_allocate_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">framebuf</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;couldn&#39;t kmalloc frame buffer structures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">rvmalloc</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;couldn&#39;t vmalloc frame buffer data area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
			<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span> <span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">FRAME_EMPTY</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span> <span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">FRAME_EMPTY</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">curbuff</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">;</span>
	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">workbuff</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">curbuff</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;buffers=%p, curbuff=%p, workbuff=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">curbuff</span><span class="p">,</span>
	    <span class="n">cam</span><span class="o">-&gt;</span><span class="n">workbuff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_free_buffers</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">cpia2_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rvfree</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">,</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">);</span>
		<span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_read</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">long</span> <span class="nf">cpia2_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">framebuf</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;%s: buffer NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;%s: Internal error, camera_data NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Start streaming */</span>
		<span class="n">cpia2_usb_stream_start</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
				       <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">stream_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Copy cam-&gt;curbuff in case it changes while we&#39;re processing */</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">curbuff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">noblock</span> <span class="o">&amp;&amp;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">FRAME_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">FRAME_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">wq_stream</span><span class="p">,</span>
			       <span class="o">!</span><span class="n">video_is_registered</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="o">||</span>
			       <span class="p">(</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">curbuff</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">FRAME_READY</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">video_is_registered</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy data to user space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">FRAME_EMPTY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_poll</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cpia2_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			<span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">v4l2_ctrl_poll</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">poll_requested_events</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Start streaming */</span>
		<span class="n">cpia2_usb_stream_start</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span>
				       <span class="n">cam</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">camera_state</span><span class="p">.</span><span class="n">stream_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">wq_stream</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">curbuff</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">FRAME_READY</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  cpia2_remap_buffer</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">cpia2_remap_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">camera_data</span> <span class="o">*</span><span class="n">cam</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="o">-</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">adr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mmap offset:%ld size:%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">video_is_registered</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">num_frames</span>  <span class="o">||</span>
	    <span class="p">(</span><span class="n">start_offset</span> <span class="o">%</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">start_offset</span><span class="o">+</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">))</span> <span class="o">+</span> <span class="n">start_offset</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">kvirt_to_pa</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SHARED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cam</span><span class="o">-&gt;</span><span class="n">mmapped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
