<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s5p-mfc › s5p_mfc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>s5p_mfc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Samsung S5P Multi Format Codec v 5.1</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Kamil Debski, &lt;k.debski@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;media/videobuf2-core.h&gt;</span>
<span class="cp">#include &quot;regs-mfc.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_ctrl.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_debug.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_dec.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_enc.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_intr.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_opr.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_pm.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_shm.h&quot;</span>

<span class="cp">#define S5P_MFC_NAME		&quot;s5p-mfc&quot;</span>
<span class="cp">#define S5P_MFC_DEC_NAME	&quot;s5p-mfc-dec&quot;</span>
<span class="cp">#define S5P_MFC_ENC_NAME	&quot;s5p-mfc-enc&quot;</span>

<span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level - higher value produces more verbose messages&quot;</span><span class="p">);</span>

<span class="cm">/* Helper functions for interrupt processing */</span>
<span class="cm">/* Remove from hw execution round robin */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_work_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Wake up context wait_queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wake_up_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_cond</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_type</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Wake up device wait_queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wake_up_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_cond</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_type</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">))</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_cnt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MFC_WATCHDOG_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This means that hw is busy and no interrupts were</span>
<span class="cm">		 * generated by hw for the Nth time of running this</span>
<span class="cm">		 * watchdog timer. This usually means a serious hw</span>
<span class="cm">		 * error. Now it is time to kill all instances and</span>
<span class="cm">		 * reset the MFC. */</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Time out during waiting for HW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MFC_WATCHDOG_INTERVAL</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_watchdog_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mutex_locked</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_dev</span><span class="p">,</span> <span class="n">watchdog_work</span><span class="p">);</span>

	<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Driver timeout error handling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Lock the mutex that protects open and release.</span>
<span class="cm">	 * This is necessary as they may load and unload firmware. */</span>
	<span class="n">mutex_locked</span> <span class="o">=</span> <span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_locked</span><span class="p">)</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Error: some instance may be closing/opening</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MFC_NUM_CONTEXTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_ERROR</span><span class="p">;</span>
		<span class="n">s5p_mfc_cleanup_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">);</span>
		<span class="n">s5p_mfc_cleanup_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">);</span>
		<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">wake_up_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">S5P_FIMV_R2H_CMD_ERR_RET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Double check if there is at least one instance running.</span>
<span class="cm">	 * If no instance is in memory than no firmware should be present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_inst</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_reload_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to reload FW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s5p_mfc_clock_on</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_init_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to reinit FW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">unlock:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_locked</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">s5p_mfc_node_type</span> <span class="nf">s5p_mfc_get_node_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to get video_device&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">MFCNODE_INVALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MFCNODE_DECODER</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MFCNODE_ENCODER</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">MFCNODE_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_RISC_HOST_INT</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_RISC2HOST_CMD</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_RTN_CHID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_handle_frame_all_extracted</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">dst_buf</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_FINISHED</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst_buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Cleaning up buffer: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
		<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">PIC_TIME_TOP</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">PIC_TIME_BOT</span><span class="p">))</span>
			<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>

		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dec_dst_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_handle_frame_copy_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span>  <span class="o">*</span><span class="n">dst_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">src_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dec_y_addr</span> <span class="o">=</span> <span class="n">s5p_mfc_get_dec_y_adr</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_type</span> <span class="o">=</span> <span class="n">s5p_mfc_get_frame_type</span><span class="p">();</span>

	<span class="cm">/* Copy timestamp / timecode from decoded src to dst and set</span>
<span class="cm">	   appropraite flags */</span>
	<span class="n">src_buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dst_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">dec_y_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timecode</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timecode</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_timecode</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span><span class="p">));</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">frame_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">S5P_FIMV_DECODE_FRAME_I_FRAME</span>:
				<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
						<span class="n">V4L2_BUF_FLAG_KEYFRAME</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S5P_FIMV_DECODE_FRAME_P_FRAME</span>:
				<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
						<span class="n">V4L2_BUF_FLAG_PFRAME</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S5P_FIMV_DECODE_FRAME_B_FRAME</span>:
				<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
						<span class="n">V4L2_BUF_FLAG_BFRAME</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_handle_frame_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span>  <span class="o">*</span><span class="n">dst_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dspl_y_addr</span> <span class="o">=</span> <span class="n">s5p_mfc_get_dspl_y_adr</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_type</span> <span class="o">=</span> <span class="n">s5p_mfc_get_frame_type</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* If frame is same as previous then skip and do not dequeue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">S5P_FIMV_DECODE_FRAME_SKIPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">after_packed_pb</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">after_packed_pb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* The MFC returns address of the buffer, now we have to</span>
<span class="cm">	 * check which videobuf does it correspond to */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dst_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if this is the buffer we&#39;re looking for */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">dspl_y_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">PIC_TIME_TOP</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">PIC_TIME_BOT</span><span class="p">))</span>
				<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span>
							<span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
			<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">);</span>
			<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dec_dst_flag</span><span class="p">);</span>

			<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span>
				<span class="n">err</span> <span class="o">?</span> <span class="n">VB2_BUF_STATE_ERROR</span> <span class="o">:</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>

			<span class="n">index</span> <span class="o">=</span> <span class="n">dst_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Handle frame decoding interrupt */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_handle_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_frame_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">src_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res_change</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">dst_frame_status</span> <span class="o">=</span> <span class="n">s5p_mfc_get_dspl_status</span><span class="p">()</span>
				<span class="o">&amp;</span> <span class="n">S5P_FIMV_DEC_STATUS_DECODING_STATUS_MASK</span><span class="p">;</span>
	<span class="n">res_change</span> <span class="o">=</span> <span class="n">s5p_mfc_get_dspl_status</span><span class="p">()</span>
				<span class="o">&amp;</span> <span class="n">S5P_FIMV_DEC_STATUS_RESOLUTION_MASK</span><span class="p">;</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Frame Status: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dst_frame_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_RES_CHANGE_INIT</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_RES_CHANGE_FLUSH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_RES_CHANGE_INIT</span><span class="p">;</span>
		<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">wake_up_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
		<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpb_flush_flag</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpb_flush_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* All frames remaining in the buffer have been extracted  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_frame_status</span> <span class="o">==</span> <span class="n">S5P_FIMV_DEC_STATUS_DECODING_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_RES_CHANGE_FLUSH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s5p_mfc_handle_frame_all_extracted</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_RES_CHANGE_END</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">leave_handle_frame</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s5p_mfc_handle_frame_all_extracted</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_frame_status</span> <span class="o">==</span> <span class="n">S5P_FIMV_DEC_STATUS_DECODING_DISPLAY</span> <span class="o">||</span>
		<span class="n">dst_frame_status</span> <span class="o">==</span> <span class="n">S5P_FIMV_DEC_STATUS_DECODING_ONLY</span><span class="p">)</span>
		<span class="n">s5p_mfc_handle_frame_copy_time</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/* A frame has been decoded and is in the buffer  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_frame_status</span> <span class="o">==</span> <span class="n">S5P_FIMV_DEC_STATUS_DISPLAY_ONLY</span> <span class="o">||</span>
	    <span class="n">dst_frame_status</span> <span class="o">==</span> <span class="n">S5P_FIMV_DEC_STATUS_DECODING_DISPLAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s5p_mfc_handle_frame_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;No frame decode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Mark source buffer as complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_frame_status</span> <span class="o">!=</span> <span class="n">S5P_FIMV_DEC_STATUS_DISPLAY_ONLY</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">src_buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span>
								<span class="n">list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">consumed_stream</span> <span class="o">+=</span> <span class="n">s5p_mfc_get_consumed_stream</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">!=</span> <span class="n">S5P_FIMV_CODEC_H264_DEC</span> <span class="o">&amp;&amp;</span>
			<span class="n">s5p_mfc_get_frame_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">S5P_FIMV_DECODE_FRAME_P_FRAME</span>
					<span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">consumed_stream</span> <span class="o">+</span> <span class="n">STUFF_BYTE</span> <span class="o">&lt;</span>
					<span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Run MFC again on the same buffer */</span>
			<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Running again the same buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">after_packed_pb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
			<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;MFC needs next buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">consumed_stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_err_dec</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">leave_handle_frame:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MFCINST_FINISHING</span><span class="p">)</span>
				    <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpb_count</span><span class="p">)</span>
		<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wake_up_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
	<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Error handling for interrupt */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If no context is available then all necessary</span>
<span class="cm">	 * processing has been done. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Interrupt Error: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wake_up_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* Error recovery is dependent on the state of context */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MFCINST_INIT</span>:
		<span class="cm">/* This error had to happen while acquireing instance */</span>
	<span class="k">case</span> <span class="n">MFCINST_GOT_INST</span>:
		<span class="cm">/* This error had to happen while parsing the header */</span>
	<span class="k">case</span> <span class="n">MFCINST_HEAD_PARSED</span>:
		<span class="cm">/* This error had to happen while setting dst buffers */</span>
	<span class="k">case</span> <span class="n">MFCINST_RETURN_INST</span>:
		<span class="cm">/* This error had to happen while releasing instance */</span>
		<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">wake_up_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFCINST_FINISHING</span>:
	<span class="k">case</span> <span class="n">MFCINST_FINISHED</span>:
	<span class="k">case</span> <span class="n">MFCINST_RUNNING</span>:
		<span class="cm">/* It is higly probable that an error occured</span>
<span class="cm">		 * while decoding a frame */</span>
		<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_ERROR</span><span class="p">;</span>
		<span class="cm">/* Mark all dst buffers as having an error */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">s5p_mfc_cleanup_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">);</span>
		<span class="cm">/* Mark all src buffers as having an error */</span>
		<span class="n">s5p_mfc_cleanup_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Encountered an error interrupt which had not been handled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Header parsing interrupt handling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_handle_seq_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">guard_width</span><span class="p">,</span> <span class="n">guard_height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">post_seq_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">post_seq_start</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;post_seq_start() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">s5p_mfc_get_img_width</span><span class="p">();</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">s5p_mfc_get_img_height</span><span class="p">();</span>

		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_height</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;SEQ Done: Movie dimensions %dx%d, &quot;</span>
			<span class="s">&quot;buffer dimensions: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span><span class="p">,</span>
						<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_DEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span> <span class="o">*</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_height</span><span class="p">,</span> <span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span> <span class="o">*</span>
					 <span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
					       <span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">),</span>
					       <span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mv_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span> <span class="o">*</span>
					<span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_height</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span>
					<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">),</span>
					<span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">guard_width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span>
					<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">);</span>
			<span class="n">guard_height</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">guard_width</span> <span class="o">*</span>
				<span class="n">guard_height</span><span class="p">,</span> <span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
			<span class="n">guard_width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">);</span>
			<span class="n">guard_height</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">guard_width</span> <span class="o">*</span>
				<span class="n">guard_height</span><span class="p">,</span> <span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mv_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpb_count</span> <span class="o">=</span> <span class="n">s5p_mfc_get_dpb_count</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_ERROR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_HEAD_PARSED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
	<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wake_up_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Header parsing interrupt handling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_handle_init_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">src_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_type</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_cond</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_RUNNING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpb_flush_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">src_buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">src_buf</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span>
						<span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpb_flush_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>

		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>

		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Interrupt processing */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s5p_mfc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mfc_debug_enter</span><span class="p">();</span>
	<span class="cm">/* Reset the timeout watchdog */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span><span class="p">];</span>
	<span class="cm">/* Get the reason of interrupt and the error code */</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">s5p_mfc_get_int_reason</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">s5p_mfc_get_int_err</span><span class="p">();</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Int reason: %d (err: %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_ERR_RET</span>:
		<span class="cm">/* An error has occured */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_RUNNING</span> <span class="o">&amp;&amp;</span>
			<span class="n">s5p_mfc_err_dec</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">S5P_FIMV_ERR_WARNINGS_START</span><span class="p">)</span>
			<span class="n">s5p_mfc_handle_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">s5p_mfc_handle_error</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enter_suspend</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_SLICE_DONE_RET</span>:
	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_FRAME_DONE_RET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">post_frame_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">post_frame_start</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
				<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;post_frame_start() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">wake_up_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
			<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s5p_mfc_handle_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_SEQ_DONE_RET</span>:
		<span class="n">s5p_mfc_handle_seq_done</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_OPEN_INSTANCE_RET</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span> <span class="o">=</span> <span class="n">s5p_mfc_get_inst_no</span><span class="p">();</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_GOT_INST</span><span class="p">;</span>
		<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">irq_cleanup_hw</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_CLOSE_INSTANCE_RET</span>:
		<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_FREE</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">irq_cleanup_hw</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_SYS_INIT_RET</span>:
	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_FW_STATUS_RET</span>:
	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_SLEEP_RET</span>:
	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_WAKEUP_RET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
			<span class="n">clear_work_bit</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">wake_up_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enter_suspend</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S5P_FIMV_R2H_CMD_INIT_BUFFERS_RET</span>:
		<span class="n">s5p_mfc_handle_init_buffers</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Unknown int reason</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mfc_debug_leave</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="nl">irq_cleanup_hw:</span>
	<span class="n">s5p_mfc_clear_int_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_type</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">int_cond</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to unlock hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>

	<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Exit via irq_cleanup_hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Open an MFC node */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mfc_debug_enter</span><span class="p">();</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_inst</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* It is guarded by mfc_mutex in vfd */</span>
	<span class="cm">/* Allocate memory for context */</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Not enough memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">;</span>
	<span class="n">v4l2_fh_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Get context number */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">MFC_NUM_CONTEXTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Too many open contexts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_no_ctx</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Mark context as idle */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_get_node_type</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFCNODE_DECODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MFCINST_DECODER</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">c_ops</span> <span class="o">=</span> <span class="n">get_dec_codec_ops</span><span class="p">();</span>
		<span class="cm">/* Setup ctrl handler */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_dec_ctrls_setup</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to setup mfc controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_ctrls_setup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_get_node_type</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFCNODE_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MFCINST_ENCODER</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">c_ops</span> <span class="o">=</span> <span class="n">get_enc_codec_ops</span><span class="p">();</span>
		<span class="cm">/* only for encoder */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Setup ctrl handler */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_enc_ctrls_setup</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to setup mfc controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_ctrls_setup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_bad_node</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Load firmware if this is the first instance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_inst</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MFC_WATCHDOG_INTERVAL</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_power_on</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;power on failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_pwr_enable</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s5p_mfc_clock_on</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_alloc_and_load_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_alloc_fw</span><span class="p">;</span>
		<span class="cm">/* Init the FW */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_init_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_init_hw</span><span class="p">;</span>
		<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* Init videobuf2 queue for CAPTURE */</span>
	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_get_node_type</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFCNODE_DECODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">get_dec_queue_ops</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_get_node_type</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFCNODE_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span> <span class="o">|</span> <span class="n">VB2_USERPTR</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">get_enc_queue_ops</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_queue_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">mem_ops</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vb2_mem_ops</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vb2_dma_contig_memops</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_queue_init</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to initialize videobuf2 queue(capture)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_queue_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Init videobuf2 queue for OUTPUT */</span>
	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_get_node_type</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFCNODE_DECODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">get_dec_queue_ops</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_get_node_type</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFCNODE_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span> <span class="o">|</span> <span class="n">VB2_USERPTR</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">get_enc_queue_ops</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_queue_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">mem_ops</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vb2_mem_ops</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vb2_dma_contig_memops</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_queue_init</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to initialize videobuf2 queue(output)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_queue_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">mfc_debug_leave</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Deinit when failure occured */</span>
<span class="nl">err_queue_init:</span>
<span class="nl">err_init_hw:</span>
	<span class="n">s5p_mfc_release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_alloc_fw:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
<span class="nl">err_pwr_enable:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_inst</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_power_off</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;power off failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s5p_mfc_release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_ctrls_setup:</span>
	<span class="n">s5p_mfc_dec_ctrls_delete</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="nl">err_bad_node:</span>
<span class="nl">err_no_ctx:</span>
	<span class="n">v4l2_fh_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">v4l2_fh_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="nl">err_alloc:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_inst</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mfc_debug_leave</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release MFC context */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mfc_debug_enter</span><span class="p">();</span>
	<span class="n">s5p_mfc_clock_on</span><span class="p">();</span>
	<span class="n">vb2_queue_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">);</span>
	<span class="n">vb2_queue_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">);</span>
	<span class="cm">/* Mark context as idle */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* If instance was initialised then</span>
<span class="cm">	 * return instance and free reosurces */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span> <span class="o">!=</span> <span class="n">MFC_NO_INSTANCE_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Has to free instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_RETURN_INST</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* Wait until instance is returned or timeout occured */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_wait_for_done_ctx</span>
		    <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">S5P_FIMV_R2H_CMD_CLOSE_INSTANCE_RET</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Err returning instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;After free instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Free resources */</span>
		<span class="n">s5p_mfc_release_codec_buffers</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">s5p_mfc_release_instance_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MFCINST_DECODER</span><span class="p">)</span>
			<span class="n">s5p_mfc_release_dec_desc_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span> <span class="o">=</span> <span class="n">MFC_NO_INSTANCE_SET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* hardware locking scheme */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_inst</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_inst</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Last instance - release firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* reset &lt;-&gt; F/W release */</span>
		<span class="n">s5p_mfc_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">s5p_mfc_release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_power_off</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Power off failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Shutting down clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s5p_mfc_dec_ctrls_delete</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">v4l2_fh_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">v4l2_fh_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">mfc_debug_leave</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Poll */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">s5p_mfc_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">src_q</span><span class="p">,</span> <span class="o">*</span><span class="n">dst_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">src_vb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">dst_vb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">src_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">;</span>
	<span class="n">dst_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * There has to be at least one buffer queued on each queued_list, which</span>
<span class="cm">	 * means either in driver already or waiting for driver to claim it</span>
<span class="cm">	 * and start processing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">src_q</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_q</span><span class="o">-&gt;</span><span class="n">queued_list</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">dst_q</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_q</span><span class="o">-&gt;</span><span class="n">queued_list</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">POLLERR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">);</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_q</span><span class="o">-&gt;</span><span class="n">done_wq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_q</span><span class="o">-&gt;</span><span class="n">done_wq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_q</span><span class="o">-&gt;</span><span class="n">done_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_q</span><span class="o">-&gt;</span><span class="n">done_list</span><span class="p">))</span>
		<span class="n">src_vb</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_q</span><span class="o">-&gt;</span><span class="n">done_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vb2_buffer</span><span class="p">,</span>
								<span class="n">done_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src_vb</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">src_vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VB2_BUF_STATE_DONE</span>
				<span class="o">||</span> <span class="n">src_vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_q</span><span class="o">-&gt;</span><span class="n">done_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_q</span><span class="o">-&gt;</span><span class="n">done_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_q</span><span class="o">-&gt;</span><span class="n">done_list</span><span class="p">))</span>
		<span class="n">dst_vb</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_q</span><span class="o">-&gt;</span><span class="n">done_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vb2_buffer</span><span class="p">,</span>
								<span class="n">done_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_vb</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dst_vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VB2_BUF_STATE_DONE</span>
				<span class="o">||</span> <span class="n">dst_vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_q</span><span class="o">-&gt;</span><span class="n">done_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Mmap */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">DST_QUEUE_OFF_BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;mmaping source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_mmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* capture */</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;mmaping destination</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">-=</span> <span class="p">(</span><span class="n">DST_QUEUE_OFF_BASE</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_mmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* v4l2 ops */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">s5p_mfc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">s5p_mfc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">s5p_mfc_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">s5p_mfc_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">s5p_mfc_mmap</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">match_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* MFC probe function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s++</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough memory for MFC device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">plat_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_init_pm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get mfc clock source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs_base</span> <span class="o">=</span> <span class="n">devm_request_and_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to obtain io memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get irq resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">s5p_mfc_irq</span><span class="p">,</span>
					<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to install irq (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_dev_l</span> <span class="o">=</span> <span class="n">device_find_child</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;s5p-mfc-l&quot;</span><span class="p">,</span>
					   <span class="n">match_child</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_dev_l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Mem child (L) device get failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_dev_r</span> <span class="o">=</span> <span class="n">device_find_child</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;s5p-mfc-r&quot;</span><span class="p">,</span>
					   <span class="n">match_child</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_dev_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Mem child (R) device get failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vb2_dma_contig_init_ctx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_dev_l</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vb2_dma_contig_init_ctx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_dev_r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">err_mem_init_ctx_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_v4l2_dev_reg</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* decoder */</span>
	<span class="n">vfd</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vfd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate video device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dec_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">fops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s5p_mfc_fops</span><span class="p">,</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="n">get_dec_v4l2_ioctl_ops</span><span class="p">();</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">release</span>	<span class="o">=</span> <span class="n">video_device_release</span><span class="p">,</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">lock</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">;</span>
	<span class="cm">/* Locking in file operations other than ioctl should be done</span>
<span class="cm">	   by the driver, not the V4L2 core.</span>
<span class="cm">	   This driver needs auditing so that this flag can be removed. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_LOCK_ALL_FOPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">S5P_MFC_DEC_NAME</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vfd_dec</span>	<span class="o">=</span> <span class="n">vfd</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to register video device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dec_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		  <span class="s">&quot;decoder registered as /dev/video%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vfd</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* encoder */</span>
	<span class="n">vfd</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vfd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate video device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_enc_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">fops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s5p_mfc_fops</span><span class="p">,</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="n">get_enc_v4l2_ioctl_ops</span><span class="p">();</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">release</span>	<span class="o">=</span> <span class="n">video_device_release</span><span class="p">,</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">lock</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">;</span>
	<span class="cm">/* This should not be necessary */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_LOCK_ALL_FOPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">S5P_MFC_ENC_NAME</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vfd_enc</span>	<span class="o">=</span> <span class="n">vfd</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to register video device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_enc_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
		  <span class="s">&quot;encoder registered as /dev/video%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vfd</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">S5P_MFC_NAME</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_work</span><span class="p">,</span> <span class="n">s5p_mfc_watchdog_worker</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">s5p_mfc_watchdog</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Deinit MFC if probe had failed */</span>
<span class="nl">err_enc_reg:</span>
	<span class="n">video_device_release</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vfd_enc</span><span class="p">);</span>
<span class="nl">err_enc_alloc:</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vfd_dec</span><span class="p">);</span>
<span class="nl">err_dec_reg:</span>
	<span class="n">video_device_release</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vfd_dec</span><span class="p">);</span>
<span class="nl">err_dec_alloc:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">err_v4l2_dev_reg:</span>
	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nl">err_mem_init_ctx_1:</span>
	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">err_res:</span>
	<span class="n">s5p_mfc_final_pm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s-- with error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Remove the driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">s5p_mfc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Removing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_workqueue</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_workqueue</span><span class="p">);</span>

	<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vfd_enc</span><span class="p">);</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vfd_dec</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">vb2_dma_contig_cleanup_ctx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">s5p_mfc_final_pm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">m_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">num_inst</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5p_mfc_sleep</span><span class="p">(</span><span class="n">m_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">enter_suspend</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Error: going to suspend for a second time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if we&#39;re processing then wait if it necessary. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Try and lock the HW */</span>
		<span class="cm">/* Wait on the interrupt waitqueue */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			<span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">int_cond</span> <span class="o">||</span> <span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">int_cond</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MFC_INT_TIMEOUT</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Waiting for hardware to finish timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">m_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">num_inst</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5p_mfc_wakeup</span><span class="p">(</span><span class="n">m_dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">m_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">m_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pre_power</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pre_power</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_dev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Power management */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">s5p_mfc_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">s5p_mfc_suspend</span><span class="p">,</span> <span class="n">s5p_mfc_resume</span><span class="p">)</span>
	<span class="n">SET_RUNTIME_PM_OPS</span><span class="p">(</span><span class="n">s5p_mfc_runtime_suspend</span><span class="p">,</span> <span class="n">s5p_mfc_runtime_resume</span><span class="p">,</span>
			   <span class="nb">NULL</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">s5p_mfc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">s5p_mfc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">s5p_mfc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">S5P_MFC_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s5p_mfc_pm_ops</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">s5p_mfc_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kamil Debski &lt;k.debski@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Samsung S5P Multi Format Codec V4L2 driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
