<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s5p-mfc › s5p_mfc_common.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>s5p_mfc_common.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Samsung S5P Multi Format Codec v 5.0</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains definitions of enums and structs used by the codec</span>
<span class="cm"> * driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Kamil Debski, &lt;k.debski@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version</span>
<span class="cm"> */</span>

<span class="cp">#ifndef S5P_MFC_COMMON_H_</span>
<span class="cp">#define S5P_MFC_COMMON_H_</span>

<span class="cp">#include &quot;regs-mfc.h&quot;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/videobuf2-core.h&gt;</span>

<span class="cm">/* Definitions related to MFC memory */</span>

<span class="cm">/* Offset base used to differentiate between CAPTURE and OUTPUT</span>
<span class="cm">*  while mmaping */</span>
<span class="cp">#define DST_QUEUE_OFF_BASE      (TASK_SIZE / 2)</span>

<span class="cm">/* Offset used by the hardware to store addresses */</span>
<span class="cp">#define MFC_OFFSET_SHIFT	11</span>

<span class="cp">#define FIRMWARE_ALIGN		0x20000		</span><span class="cm">/* 128KB */</span><span class="cp"></span>
<span class="cp">#define MFC_H264_CTX_BUF_SIZE	0x96000		</span><span class="cm">/* 600KB per H264 instance */</span><span class="cp"></span>
<span class="cp">#define MFC_CTX_BUF_SIZE	0x2800		</span><span class="cm">/* 10KB per instance */</span><span class="cp"></span>
<span class="cp">#define DESC_BUF_SIZE		0x20000		</span><span class="cm">/* 128KB for DESC buffer */</span><span class="cp"></span>
<span class="cp">#define SHARED_BUF_SIZE		0x2000		</span><span class="cm">/* 8KB for shared buffer */</span><span class="cp"></span>

<span class="cp">#define DEF_CPB_SIZE		0x40000		</span><span class="cm">/* 512KB */</span><span class="cp"></span>

<span class="cp">#define MFC_BANK1_ALLOC_CTX	0</span>
<span class="cp">#define MFC_BANK2_ALLOC_CTX	1</span>

<span class="cp">#define MFC_BANK1_ALIGN_ORDER	13</span>
<span class="cp">#define MFC_BANK2_ALIGN_ORDER	13</span>
<span class="cp">#define MFC_BASE_ALIGN_ORDER	17</span>

<span class="cp">#include &lt;media/videobuf2-dma-contig.h&gt;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">dma_addr_t</span> <span class="nf">s5p_mfc_mem_cookie</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Same functionality as the vb2_dma_contig_plane_paddr */</span>
	<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">cookie</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MFC definitions */</span>
<span class="cp">#define MFC_MAX_EXTRA_DPB       5</span>
<span class="cp">#define MFC_MAX_BUFFERS		32</span>
<span class="cp">#define MFC_NUM_CONTEXTS	4</span>
<span class="cm">/* Interrupt timeout */</span>
<span class="cp">#define MFC_INT_TIMEOUT		2000</span>
<span class="cm">/* Busy wait timeout */</span>
<span class="cp">#define MFC_BW_TIMEOUT		500</span>
<span class="cm">/* Watchdog interval */</span>
<span class="cp">#define MFC_WATCHDOG_INTERVAL   1000</span>
<span class="cm">/* After how many executions watchdog should assume lock up */</span>
<span class="cp">#define MFC_WATCHDOG_CNT        10</span>
<span class="cp">#define MFC_NO_INSTANCE_SET	-1</span>
<span class="cp">#define MFC_ENC_CAP_PLANE_COUNT	1</span>
<span class="cp">#define MFC_ENC_OUT_PLANE_COUNT	2</span>
<span class="cp">#define STUFF_BYTE		4</span>
<span class="cp">#define MFC_MAX_CTRLS		64</span>

<span class="cp">#define mfc_read(dev, offset)		readl(dev-&gt;regs_base + (offset))</span>
<span class="cp">#define mfc_write(dev, data, offset)	writel((data), dev-&gt;regs_base + \</span>
<span class="cp">								(offset))</span>

<span class="cm">/**</span>
<span class="cm"> * enum s5p_mfc_fmt_type - type of the pixelformat</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">s5p_mfc_fmt_type</span> <span class="p">{</span>
	<span class="n">MFC_FMT_DEC</span><span class="p">,</span>
	<span class="n">MFC_FMT_ENC</span><span class="p">,</span>
	<span class="n">MFC_FMT_RAW</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum s5p_mfc_node_type - The type of an MFC device node.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">s5p_mfc_node_type</span> <span class="p">{</span>
	<span class="n">MFCNODE_INVALID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">MFCNODE_DECODER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MFCNODE_ENCODER</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum s5p_mfc_inst_type - The type of an MFC instance.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">s5p_mfc_inst_type</span> <span class="p">{</span>
	<span class="n">MFCINST_INVALID</span><span class="p">,</span>
	<span class="n">MFCINST_DECODER</span><span class="p">,</span>
	<span class="n">MFCINST_ENCODER</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum s5p_mfc_inst_state - The state of an MFC instance.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">s5p_mfc_inst_state</span> <span class="p">{</span>
	<span class="n">MFCINST_FREE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MFCINST_INIT</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="n">MFCINST_GOT_INST</span><span class="p">,</span>
	<span class="n">MFCINST_HEAD_PARSED</span><span class="p">,</span>
	<span class="n">MFCINST_BUFS_SET</span><span class="p">,</span>
	<span class="n">MFCINST_RUNNING</span><span class="p">,</span>
	<span class="n">MFCINST_FINISHING</span><span class="p">,</span>
	<span class="n">MFCINST_FINISHED</span><span class="p">,</span>
	<span class="n">MFCINST_RETURN_INST</span><span class="p">,</span>
	<span class="n">MFCINST_ERROR</span><span class="p">,</span>
	<span class="n">MFCINST_ABORT</span><span class="p">,</span>
	<span class="n">MFCINST_RES_CHANGE_INIT</span><span class="p">,</span>
	<span class="n">MFCINST_RES_CHANGE_FLUSH</span><span class="p">,</span>
	<span class="n">MFCINST_RES_CHANGE_END</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum s5p_mfc_queue_state - The state of buffer queue.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">s5p_mfc_queue_state</span> <span class="p">{</span>
	<span class="n">QUEUE_FREE</span><span class="p">,</span>
	<span class="n">QUEUE_BUFS_REQUESTED</span><span class="p">,</span>
	<span class="n">QUEUE_BUFS_QUERIED</span><span class="p">,</span>
	<span class="n">QUEUE_BUFS_MMAPED</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum s5p_mfc_decode_arg - type of frame decoding</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">s5p_mfc_decode_arg</span> <span class="p">{</span>
	<span class="n">MFC_DEC_FRAME</span><span class="p">,</span>
	<span class="n">MFC_DEC_LAST_FRAME</span><span class="p">,</span>
	<span class="n">MFC_DEC_RES_CHANGE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_buf - MFC buffer</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">luma</span><span class="p">;</span>
			<span class="kt">size_t</span> <span class="n">chroma</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">raw</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">stream</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_pm - power management data structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_pm</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span>	<span class="o">*</span><span class="n">clock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>	<span class="o">*</span><span class="n">clock_gate</span><span class="p">;</span>
	<span class="n">atomic_t</span>	<span class="n">power</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">device</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_dev - The struct containing driver internal parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * @v4l2_dev:		v4l2_device</span>
<span class="cm"> * @vfd_dec:		video device for decoding</span>
<span class="cm"> * @vfd_enc:		video device for encoding</span>
<span class="cm"> * @plat_dev:		platform device</span>
<span class="cm"> * @mem_dev_l:		child device of the left memory bank (0)</span>
<span class="cm"> * @mem_dev_r:		child device of the right memory bank (1)</span>
<span class="cm"> * @regs_base:		base address of the MFC hw registers</span>
<span class="cm"> * @irq:		irq resource</span>
<span class="cm"> * @dec_ctrl_handler:	control framework handler for decoding</span>
<span class="cm"> * @enc_ctrl_handler:	control framework handler for encoding</span>
<span class="cm"> * @pm:			power management control</span>
<span class="cm"> * @num_inst:		couter of active MFC instances</span>
<span class="cm"> * @irqlock:		lock for operations on videobuf2 queues</span>
<span class="cm"> * @condlock:		lock for changing/checking if a context is ready to be</span>
<span class="cm"> *			processed</span>
<span class="cm"> * @mfc_mutex:		lock for video_device</span>
<span class="cm"> * @int_cond:		variable used by the waitqueue</span>
<span class="cm"> * @int_type:		type of last interrupt</span>
<span class="cm"> * @int_err:		error number for last interrupt</span>
<span class="cm"> * @queue:		waitqueue for waiting for completion of device commands</span>
<span class="cm"> * @fw_size:		size of firmware</span>
<span class="cm"> * @bank1:		address of the beggining of bank 1 memory</span>
<span class="cm"> * @bank2:		address of the beggining of bank 2 memory</span>
<span class="cm"> * @hw_lock:		used for hardware locking</span>
<span class="cm"> * @ctx:		array of driver contexts</span>
<span class="cm"> * @curr_ctx:		number of the currently running context</span>
<span class="cm"> * @ctx_work_bits:	used to mark which contexts are waiting for hardware</span>
<span class="cm"> * @watchdog_cnt:	counter for the watchdog</span>
<span class="cm"> * @watchdog_workqueue:	workqueue for the watchdog</span>
<span class="cm"> * @watchdog_work:	worker for the watchdog</span>
<span class="cm"> * @alloc_ctx:		videobuf2 allocator contexts for two memory banks</span>
<span class="cm"> * @enter_suspend:	flag set when entering suspend</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span>	<span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span>	<span class="o">*</span><span class="n">vfd_dec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span>	<span class="o">*</span><span class="n">vfd_enc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">plat_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">mem_dev_l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">mem_dev_r</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs_base</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">dec_ctrl_handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">enc_ctrl_handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_pm</span>	<span class="n">pm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_inst</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">irqlock</span><span class="p">;</span>	<span class="cm">/* lock when operating on videobuf2 queues */</span>
	<span class="n">spinlock_t</span> <span class="n">condlock</span><span class="p">;</span>	<span class="cm">/* lock when changing/checking if a context is</span>
<span class="cm">					ready to be processed */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mfc_mutex</span><span class="p">;</span> <span class="cm">/* video_device lock */</span>
	<span class="kt">int</span> <span class="n">int_cond</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">int_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_err</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">queue</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">fw_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bank1</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bank2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">[</span><span class="n">MFC_NUM_CONTEXTS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">curr_ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctx_work_bits</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">watchdog_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">watchdog_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">watchdog_workqueue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">watchdog_work</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">enter_suspend</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_h264_enc_params - encoding parameters for h264</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_h264_enc_params</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_h264_profile</span> <span class="n">profile</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_h264_loop_filter_mode</span> <span class="n">loop_filter_mode</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">loop_filter_alpha</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">loop_filter_beta</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_h264_entropy_mode</span> <span class="n">entropy_mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_ref_pic</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_ref_pic_4p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">_8x8_transform</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_mb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_mb_dark</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_mb_smooth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_mb_static</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_mb_activity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vui_sar</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vui_sar_idc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vui_ext_sar_width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vui_ext_sar_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">open_gop</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">open_gop_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_frame_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_min_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_max_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_p_frame_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_b_frame_qp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_h264_level</span> <span class="n">level_v4l2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cpb_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_mpeg4_enc_params - encoding parameters for h263 and mpeg4</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_mpeg4_enc_params</span> <span class="p">{</span>
	<span class="cm">/* MPEG4 Only */</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_mpeg4_profile</span> <span class="n">profile</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quarter_pixel</span><span class="p">;</span>
	<span class="cm">/* Common for MPEG4, H263 */</span>
	<span class="n">u16</span> <span class="n">vop_time_res</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vop_frm_delta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_frame_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_min_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_max_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_p_frame_qp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_b_frame_qp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_mpeg4_level</span> <span class="n">level_v4l2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_enc_params - general encoding parameters</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">height</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">gop_size</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_multi_slice_mode</span> <span class="n">slice_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">slice_mb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">slice_bit</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intra_refresh_mb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad_luma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad_cb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad_cr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc_frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc_bitrate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rc_reaction_coeff</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vbv_size</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">v4l2_mpeg_video_header_mode</span> <span class="n">seq_hdr_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_mpeg_mfc51_video_frame_skip_mode</span> <span class="n">frame_skip_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fixed_target_bit</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">num_b_frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc_framerate_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc_framerate_denom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interlace</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">s5p_mfc_h264_enc_params</span> <span class="n">h264</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">s5p_mfc_mpeg4_enc_params</span> <span class="n">mpeg4</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">codec</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_codec_ops - codec ops, used by encoding</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_codec_ops</span> <span class="p">{</span>
	<span class="cm">/* initialization routines */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pre_seq_start</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">post_seq_start</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
	<span class="cm">/* execution routines */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pre_frame_start</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">post_frame_start</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define call_cop(c, op, args...)				\</span>
<span class="cp">	(((c)-&gt;c_ops-&gt;op) ?					\</span>
<span class="cp">		((c)-&gt;c_ops-&gt;op(args)) : 0)</span>

<span class="cm">/**</span>
<span class="cm"> * struct s5p_mfc_ctx - This struct contains the instance context</span>
<span class="cm"> *</span>
<span class="cm"> * @dev:		pointer to the s5p_mfc_dev of the device</span>
<span class="cm"> * @fh:			struct v4l2_fh</span>
<span class="cm"> * @num:		number of the context that this structure describes</span>
<span class="cm"> * @int_cond:		variable used by the waitqueue</span>
<span class="cm"> * @int_type:		type of the last interrupt</span>
<span class="cm"> * @int_err:		error number received from MFC hw in the interrupt</span>
<span class="cm"> * @queue:		waitqueue that can be used to wait for this context to</span>
<span class="cm"> *			finish</span>
<span class="cm"> * @src_fmt:		source pixelformat information</span>
<span class="cm"> * @dst_fmt:		destination pixelformat information</span>
<span class="cm"> * @vq_src:		vb2 queue for source buffers</span>
<span class="cm"> * @vq_dst:		vb2 queue for destination buffers</span>
<span class="cm"> * @src_queue:		driver internal queue for source buffers</span>
<span class="cm"> * @dst_queue:		driver internal queue for destination buffers</span>
<span class="cm"> * @src_queue_cnt:	number of buffers queued on the source internal queue</span>
<span class="cm"> * @dst_queue_cnt:	number of buffers queued on the dest internal queue</span>
<span class="cm"> * @type:		type of the instance - decoder or encoder</span>
<span class="cm"> * @state:		state of the context</span>
<span class="cm"> * @inst_no:		number of hw instance associated with the context</span>
<span class="cm"> * @img_width:		width of the image that is decoded or encoded</span>
<span class="cm"> * @img_height:		height of the image that is decoded or encoded</span>
<span class="cm"> * @buf_width:		width of the buffer for processed image</span>
<span class="cm"> * @buf_height:		height of the buffer for processed image</span>
<span class="cm"> * @luma_size:		size of a luma plane</span>
<span class="cm"> * @chroma_size:	size of a chroma plane</span>
<span class="cm"> * @mv_size:		size of a motion vectors buffer</span>
<span class="cm"> * @consumed_stream:	number of bytes that have been used so far from the</span>
<span class="cm"> *			decoding buffer</span>
<span class="cm"> * @dpb_flush_flag:	flag used to indicate that a DPB buffers are being</span>
<span class="cm"> *			flushed</span>
<span class="cm"> * @bank1_buf:		handle to memory allocated for temporary buffers from</span>
<span class="cm"> *			memory bank 1</span>
<span class="cm"> * @bank1_phys:		address of the temporary buffers from memory bank 1</span>
<span class="cm"> * @bank1_size:		size of the memory allocated for temporary buffers from</span>
<span class="cm"> *			memory bank 1</span>
<span class="cm"> * @bank2_buf:		handle to memory allocated for temporary buffers from</span>
<span class="cm"> *			memory bank 2</span>
<span class="cm"> * @bank2_phys:		address of the temporary buffers from memory bank 2</span>
<span class="cm"> * @bank2_size:		size of the memory allocated for temporary buffers from</span>
<span class="cm"> *			memory bank 2</span>
<span class="cm"> * @capture_state:	state of the capture buffers queue</span>
<span class="cm"> * @output_state:	state of the output buffers queue</span>
<span class="cm"> * @src_bufs:		information on allocated source buffers</span>
<span class="cm"> * @dst_bufs:		information on allocated destination buffers</span>
<span class="cm"> * @sequence:		counter for the sequence number for v4l2</span>
<span class="cm"> * @dec_dst_flag:	flags for buffers queued in the hardware</span>
<span class="cm"> * @dec_src_buf_size:	size of the buffer for source buffers in decoding</span>
<span class="cm"> * @codec_mode:		number of codec mode used by MFC hw</span>
<span class="cm"> * @slice_interface:	slice interface flag</span>
<span class="cm"> * @loop_filter_mpeg4:	loop filter for MPEG4 flag</span>
<span class="cm"> * @display_delay:	value of the display delay for H264</span>
<span class="cm"> * @display_delay_enable:	display delay for H264 enable flag</span>
<span class="cm"> * @after_packed_pb:	flag used to track buffer when stream is in</span>
<span class="cm"> *			Packed PB format</span>
<span class="cm"> * @dpb_count:		count of the DPB buffers required by MFC hw</span>
<span class="cm"> * @total_dpb_count:	count of DPB buffers with additional buffers</span>
<span class="cm"> *			requested by the application</span>
<span class="cm"> * @ctx_buf:		handle to the memory associated with this context</span>
<span class="cm"> * @ctx_phys:		address of the memory associated with this context</span>
<span class="cm"> * @ctx_size:		size of the memory associated with this context</span>
<span class="cm"> * @desc_buf:		description buffer for decoding handle</span>
<span class="cm"> * @desc_phys:		description buffer for decoding address</span>
<span class="cm"> * @shm_alloc:		handle for the shared memory buffer</span>
<span class="cm"> * @shm:		virtual address for the shared memory buffer</span>
<span class="cm"> * @shm_ofs:		address offset for shared memory</span>
<span class="cm"> * @enc_params:		encoding parameters for MFC</span>
<span class="cm"> * @enc_dst_buf_size:	size of the buffers for encoder output</span>
<span class="cm"> * @frame_type:		used to force the type of the next encoded frame</span>
<span class="cm"> * @ref_queue:		list of the reference buffers for encoding</span>
<span class="cm"> * @ref_queue_cnt:	number of the buffers in the reference list</span>
<span class="cm"> * @c_ops:		ops for encoding</span>
<span class="cm"> * @ctrls:		array of controls, used when adding controls to the</span>
<span class="cm"> *			v4l2 control framework</span>
<span class="cm"> * @ctrl_handler:	handler for v4l2 framework</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="n">fh</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">int_cond</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">int_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_err</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">queue</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="o">*</span><span class="n">src_fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="o">*</span><span class="n">dst_fmt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="n">vq_src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="n">vq_dst</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">src_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dst_queue</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_queue_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_queue_cnt</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">s5p_mfc_inst_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">s5p_mfc_inst_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inst_no</span><span class="p">;</span>

	<span class="cm">/* Image parameters */</span>
	<span class="kt">int</span> <span class="n">img_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">img_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_height</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">luma_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chroma_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mv_size</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">consumed_stream</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dpb_flush_flag</span><span class="p">;</span>

	<span class="cm">/* Buffers */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bank1_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bank1_phys</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bank1_size</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">bank2_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bank2_phys</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bank2_size</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">s5p_mfc_queue_state</span> <span class="n">capture_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">s5p_mfc_queue_state</span> <span class="n">output_state</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="n">src_bufs</span><span class="p">[</span><span class="n">MFC_MAX_BUFFERS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">src_bufs_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="n">dst_bufs</span><span class="p">[</span><span class="n">MFC_MAX_BUFFERS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">dst_bufs_cnt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sequence</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dec_dst_flag</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dec_src_buf_size</span><span class="p">;</span>

	<span class="cm">/* Control values */</span>
	<span class="kt">int</span> <span class="n">codec_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slice_interface</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop_filter_mpeg4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">display_delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">display_delay_enable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">after_packed_pb</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dpb_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_dpb_count</span><span class="p">;</span>

	<span class="cm">/* Buffers */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctx_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ctx_phys</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ctx_ofs</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ctx_size</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">desc_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">desc_phys</span><span class="p">;</span>


	<span class="kt">void</span> <span class="o">*</span><span class="n">shm_alloc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">shm</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">shm_ofs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="n">enc_params</span><span class="p">;</span>

	<span class="kt">size_t</span> <span class="n">enc_dst_buf_size</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">v4l2_mpeg_mfc51_video_force_frame_type</span> <span class="n">force_frame_type</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">ref_queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ref_queue_cnt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">s5p_mfc_codec_ops</span> <span class="o">*</span><span class="n">c_ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">[</span><span class="n">MFC_MAX_CTRLS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">ctrl_handler</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * struct s5p_mfc_fmt -	structure used to store information about pixelformats</span>
<span class="cm"> *			used by the MFC</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fourcc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">codec_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">s5p_mfc_fmt_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_planes</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mfc_control -	structure used to store information about MFC controls</span>
<span class="cm"> *			it is used to initialize the control framework.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mfc_control</span> <span class="p">{</span>
	<span class="n">__u32</span>			<span class="n">id</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_ctrl_type</span>	<span class="n">type</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>  <span class="cm">/* Whatever */</span>
	<span class="n">__s32</span>			<span class="n">minimum</span><span class="p">;</span>   <span class="cm">/* Note signedness */</span>
	<span class="n">__s32</span>			<span class="n">maximum</span><span class="p">;</span>
	<span class="n">__s32</span>			<span class="n">step</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">menu_skip_mask</span><span class="p">;</span>
	<span class="n">__s32</span>			<span class="n">default_value</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__u8</span>			<span class="n">is_volatile</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define fh_to_ctx(__fh) container_of(__fh, struct s5p_mfc_ctx, fh)</span>
<span class="cp">#define ctrl_to_ctx(__ctrl) \</span>
<span class="cp">	container_of((__ctrl)-&gt;handler, struct s5p_mfc_ctx, ctrl_handler)</span>

<span class="cp">#endif </span><span class="cm">/* S5P_MFC_COMMON_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
