<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s5p-mfc › s5p_mfc_enc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>s5p_mfc_enc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/media/video/s5p-mfc/s5p_mfc_enc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2010-2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> *		http://www.samsung.com/</span>
<span class="cm"> *</span>
<span class="cm"> * Jeongtae Park	&lt;jtp.park@samsung.com&gt;</span>
<span class="cm"> * Kamil Debski		&lt;k.debski@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/version.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/videobuf2-core.h&gt;</span>
<span class="cp">#include &quot;regs-mfc.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_common.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_debug.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_enc.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_intr.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_opr.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4:2:0 2 Planes 64x32 Tiles&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV12MT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">codec_mode</span> <span class="o">=</span> <span class="n">S5P_FIMV_CODEC_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MFC_FMT_RAW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4:2:0 2 Planes&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV12M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">codec_mode</span> <span class="o">=</span> <span class="n">S5P_FIMV_CODEC_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MFC_FMT_RAW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H264 Encoded Stream&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_H264</span><span class="p">,</span>
		<span class="p">.</span><span class="n">codec_mode</span> <span class="o">=</span> <span class="n">S5P_FIMV_CODEC_H264_ENC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MFC_FMT_ENC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPEG4 Encoded Stream&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MPEG4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">codec_mode</span> <span class="o">=</span> <span class="n">S5P_FIMV_CODEC_MPEG4_ENC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MFC_FMT_ENC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H263 Encoded Stream&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_H263</span><span class="p">,</span>
		<span class="p">.</span><span class="n">codec_mode</span> <span class="o">=</span> <span class="n">S5P_FIMV_CODEC_H263_ENC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MFC_FMT_ENC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_FORMATS ARRAY_SIZE(formats)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="o">*</span><span class="nf">find_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">&amp;&amp;</span>
		    <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfc_control</span> <span class="n">controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MULTI_SLICE_MODE_SINGLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_BYTES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MULTI_SLICE_MODE_SINGLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_MB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_BYTES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1900</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1900</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_CYCLIC_INTRA_REFRESH_MB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_PADDING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Padding Control Enable&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_PADDING_YUV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Padding Color YUV Value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_FRAME_RC_ENABLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_RC_REACTION_COEFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Rate Control Reaction Coeff.&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_FORCE_FRAME_TYPE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Force frame type&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_MFC51_VIDEO_FORCE_FRAME_TYPE_DISABLED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_MFC51_VIDEO_FORCE_FRAME_TYPE_NOT_CODED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_MFC51_VIDEO_FORCE_FRAME_TYPE_DISABLED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_VBV_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_CPB_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_HEADER_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_HEADER_MODE_SEPARATE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_HEADER_MODE_JOINED_WITH_1ST_FRAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_HEADER_MODE_SEPARATE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Frame Skip Enable&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_DISABLED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_BUF_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_DISABLED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_RC_FIXED_TARGET_BIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fixed Target Bit Enable&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_B_FRAMES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_PROFILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_MULTIVIEW_HIGH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_MAIN</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_HIGH</span><span class="p">)</span>
				<span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LEVEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_LEVEL_1_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_LEVEL_4_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_LEVEL_1_0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_LEVEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_LEVEL_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_LEVEL_5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_LEVEL_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_LOOP_FILTER_MODE_ENABLED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_LOOP_FILTER_MODE_DISABLED_AT_SLICE_BOUNDARY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_LOOP_FILTER_MODE_ENABLED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_ALPHA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_BETA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_ENTROPY_MODE_CAVLC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_ENTROPY_MODE_CABAC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_ENTROPY_MODE_CAVLC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_NUM_REF_PIC_FOR_P</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;The Number of Ref. Pic for P&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_8X8_TRANSFORM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MB_RC_ENABLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_I_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_MIN_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_MAX_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_P_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_B_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_I_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H263 I-Frame QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_MIN_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H263 Minimum QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_MAX_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H263 Maximum QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_P_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H263 P frame QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_B_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H263 B frame QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_I_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPEG4 I-Frame QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_MIN_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPEG4 Minimum QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_MAX_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPEG4 Maximum QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_P_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPEG4 P frame QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_B_FRAME_QP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPEG4 B frame QP value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_DARK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H264 Dark Reg Adaptive RC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_SMOOTH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H264 Smooth Reg Adaptive RC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_STATIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H264 Static Reg Adaptive RC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_ACTIVITY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H264 Activity Reg Adaptive RC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_ENABLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_IDC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_UNSPECIFIED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_EXTENDED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_UNSPECIFIED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_EXT_SAR_WIDTH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_EXT_SAR_HEIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_I_PERIOD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_PROFILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_PROFILE_SIMPLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_PROFILE_ADVANCED_SIMPLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_PROFILE_SIMPLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_QPEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_CTRLS ARRAY_SIZE(controls)</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="nf">mfc51_get_menu</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mfc51_video_frame_skip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Disabled&quot;</span><span class="p">,</span>
		<span class="s">&quot;Level Limit&quot;</span><span class="p">,</span>
		<span class="s">&quot;VBV/CPB Limit&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mfc51_video_force_frame</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Disabled&quot;</span><span class="p">,</span>
		<span class="s">&quot;I Frame&quot;</span><span class="p">,</span>
		<span class="s">&quot;Not Coded&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE</span>:
		<span class="k">return</span> <span class="n">mfc51_video_frame_skip</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_FORCE_FRAME_TYPE</span>:
		<span class="k">return</span> <span class="n">mfc51_video_force_frame</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_ctx_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;src=%d, dst=%d, state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="cm">/* context is ready to make header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_GOT_INST</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* context is ready to encode a frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_RUNNING</span> <span class="o">&amp;&amp;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* context is ready to encode remain frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_FINISHING</span> <span class="o">&amp;&amp;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ctx is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_ref_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">mb_entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mb_y_addr</span><span class="p">,</span> <span class="n">mb_c_addr</span><span class="p">;</span>

	<span class="cm">/* move buffers in ref queue to src queue */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mb_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">((</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">mb_y_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mb_c_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;enc src count: %d, enc ref count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue_cnt</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc_pre_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">dst_mb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dst_mb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dst_size</span> <span class="o">=</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_enc_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst_size</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc_post_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">dst_mb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_hdr_mode</span> <span class="o">==</span> <span class="n">V4L2_MPEG_VIDEO_HEADER_MODE_SEPARATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dst_mb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">s5p_mfc_get_enc_strm_size</span><span class="p">());</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_RUNNING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_ctx_ready</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc_pre_frame_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">dst_mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">src_mb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_y_addr</span><span class="p">,</span> <span class="n">src_c_addr</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_size</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">src_mb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">src_y_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">src_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">src_c_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">src_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_enc_frame_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">src_y_addr</span><span class="p">,</span> <span class="n">src_c_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dst_mb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dst_size</span> <span class="o">=</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_enc_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst_size</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc_post_frame_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">mb_entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">enc_y_addr</span><span class="p">,</span> <span class="n">enc_c_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mb_y_addr</span><span class="p">,</span> <span class="n">mb_c_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slice_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strm_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">slice_type</span> <span class="o">=</span> <span class="n">s5p_mfc_get_enc_slice_type</span><span class="p">();</span>
	<span class="n">strm_size</span> <span class="o">=</span> <span class="n">s5p_mfc_get_enc_strm_size</span><span class="p">();</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Encoded slice type: %d&quot;</span><span class="p">,</span> <span class="n">slice_type</span><span class="p">);</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Encoded stream size: %d&quot;</span><span class="p">,</span> <span class="n">strm_size</span><span class="p">);</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Display order: %d&quot;</span><span class="p">,</span>
		  <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_SI_PIC_CNT</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slice_type</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s5p_mfc_get_enc_frame_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enc_y_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enc_c_addr</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mb_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mb_y_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mb_c_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">enc_y_addr</span> <span class="o">==</span> <span class="n">mb_y_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">enc_c_addr</span> <span class="o">==</span> <span class="n">mb_c_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span>
							<span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mb_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mb_y_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mb_c_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">enc_y_addr</span> <span class="o">==</span> <span class="n">mb_y_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">enc_c_addr</span> <span class="o">==</span> <span class="n">mb_c_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span>
							<span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_RUNNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mb_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span>
									<span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;enc src count: %d, enc ref count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ref_queue_cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strm_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* at least one more dest. buffers exist always  */</span>
		<span class="n">mb_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span>
									<span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">slice_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">S5P_FIMV_ENC_SI_SLICE_TYPE_I</span>:
			<span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_KEYFRAME</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S5P_FIMV_ENC_SI_SLICE_TYPE_P</span>:
			<span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_PFRAME</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S5P_FIMV_ENC_SI_SLICE_TYPE_B</span>:
			<span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_BFRAME</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strm_size</span><span class="p">);</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">mb_entry</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s5p_mfc_codec_ops</span> <span class="n">encoder_codec_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pre_seq_start</span>		<span class="o">=</span> <span class="n">enc_pre_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_seq_start</span>		<span class="o">=</span> <span class="n">enc_post_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_frame_start</span>	<span class="o">=</span> <span class="n">enc_pre_frame_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_frame_start</span>	<span class="o">=</span> <span class="n">enc_post_frame_start</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Query capabilities of the device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">KERNEL_VERSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE_MPLANE</span>
			  <span class="o">|</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT_MPLANE</span>
			  <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mplane</span><span class="p">,</span> <span class="n">bool</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">formats</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mplane</span> <span class="o">&amp;&amp;</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_planes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mplane</span> <span class="o">&amp;&amp;</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_planes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MFC_FMT_RAW</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MFC_FMT_ENC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">j</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pirv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vidioc_enum_fmt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap_mplane</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pirv</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vidioc_enum_fmt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">prov</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vidioc_enum_fmt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_out_mplane</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">prov</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vidioc_enum_fmt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span> <span class="o">*</span><span class="n">pix_fmt_mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">;</span>

	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;f-&gt;type = %d ctx-&gt;state = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is run on output (encoder dest) */</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">num_planes</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">;</span>

		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_dst_buf_size</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_dst_buf_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is run on capture (encoder src) */</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">;</span>

		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">num_planes</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">;</span>

		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid buf type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span> <span class="o">*</span><span class="n">pix_fmt_mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">find_format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">MFC_FMT_ENC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to try output format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;must be set encoding output size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sizeimage</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">find_format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">MFC_FMT_RAW</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to try output format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span> <span class="o">!=</span> <span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to try output format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid buf type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format_mplane</span> <span class="o">*</span><span class="n">pix_fmt_mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix_mp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_try_fmt</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">.</span><span class="n">streaming</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">.</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;%s queue busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">find_format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">MFC_FMT_ENC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to set capture format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_INIT</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_dst_buf_size</span> <span class="o">=</span>	<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sizeimage</span><span class="p">;</span>
		<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">capture_state</span> <span class="o">=</span> <span class="n">QUEUE_FREE</span><span class="p">;</span>
		<span class="n">s5p_mfc_alloc_instance_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_wait_for_done_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> \
				<span class="n">S5P_FIMV_R2H_CMD_OPEN_INSTANCE_RET</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Error or timeout */</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Error getting instance from hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">s5p_mfc_release_instance_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Got instance number: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">find_format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">MFC_FMT_RAW</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to set output format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span> <span class="o">!=</span> <span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to set output format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;codec number: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">);</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;fmt - w: %d, h: %d, ctx - w: %d, h: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12M</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12M_HALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
				<span class="n">S5P_FIMV_NV12M_HALIGN</span><span class="p">)</span> <span class="o">*</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span>
				<span class="n">S5P_FIMV_NV12M_LVALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
				<span class="n">S5P_FIMV_NV12M_HALIGN</span><span class="p">)</span> <span class="o">*</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span>
				<span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">S5P_FIMV_NV12M_CVALIGN</span><span class="p">);</span>

			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12M_SALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12M_SALIGN</span><span class="p">);</span>

			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">;</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span><span class="p">;</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">;</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12MT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
				<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">)</span>	<span class="o">*</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span>
				<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
				<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">)</span> <span class="o">*</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span>
				<span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>

			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">;</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span><span class="p">;</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">;</span>
			<span class="n">pix_fmt_mp</span><span class="o">-&gt;</span><span class="n">plane_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buf_width</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_bufs_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">output_state</span> <span class="o">=</span> <span class="n">QUEUE_FREE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid buf type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mfc_debug_leave</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">reqbufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if memory is not mmp or userptr return error */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reqbufs</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">reqbufs</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqbufs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">capture_state</span> <span class="o">!=</span> <span class="n">QUEUE_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid capture state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">capture_state</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">reqbufs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;error in vb2_reqbufs() for E(D)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">capture_state</span> <span class="o">=</span> <span class="n">QUEUE_BUFS_REQUESTED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_alloc_codec_buffers</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate encoding buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">reqbufs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">reqbufs</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reqbufs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">output_state</span> <span class="o">!=</span> <span class="n">QUEUE_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid output state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">output_state</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">,</span> <span class="n">reqbufs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;error in vb2_reqbufs() for E(S)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">output_state</span> <span class="o">=</span> <span class="n">QUEUE_BUFS_REQUESTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid buf type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if memory is not mmp or userptr return error */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MFCINST_GOT_INST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid context state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;error in vb2_querybuf() for E(D)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">m</span><span class="p">.</span><span class="n">mem_offset</span> <span class="o">+=</span> <span class="n">DST_QUEUE_OFF_BASE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;error in vb2_querybuf() for E(S)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid buf type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Queue a buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Call on QBUF after unrecoverable error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_qbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_qbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Dequeue a buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Call on DQBUF after unrecoverable error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Stream on */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_streamon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_streamon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Stream off, which equals to a pause */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vb2_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">h264_level</span><span class="p">(</span><span class="k">enum</span> <span class="n">v4l2_mpeg_video_h264_level</span> <span class="n">lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">[</span><span class="n">V4L2_MPEG_VIDEO_H264_LEVEL_4_0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_1_0   */</span> <span class="mi">10</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_1B    */</span> <span class="mi">9</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_1_1   */</span> <span class="mi">11</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_1_2   */</span> <span class="mi">12</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_1_3   */</span> <span class="mi">13</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_2_0   */</span> <span class="mi">20</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_2_1   */</span> <span class="mi">21</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_2_2   */</span> <span class="mi">22</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_3_0   */</span> <span class="mi">30</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_3_1   */</span> <span class="mi">31</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_3_2   */</span> <span class="mi">32</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_LEVEL_4_0   */</span> <span class="mi">40</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">lvl</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mpeg4_level</span><span class="p">(</span><span class="k">enum</span> <span class="n">v4l2_mpeg_video_mpeg4_level</span> <span class="n">lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">[</span><span class="n">V4L2_MPEG_VIDEO_MPEG4_LEVEL_5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_0    */</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_0B   */</span> <span class="mi">9</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_1    */</span> <span class="mi">1</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_2    */</span> <span class="mi">2</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_3    */</span> <span class="mi">3</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_3B   */</span> <span class="mi">7</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_4    */</span> <span class="mi">4</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_MPEG4_LEVEL_5    */</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">lvl</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vui_sar_idc</span><span class="p">(</span><span class="k">enum</span> <span class="n">v4l2_mpeg_video_h264_vui_sar_idc</span> <span class="n">sar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">[</span><span class="n">V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_EXTENDED</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_UNSPECIFIED     */</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_1x1             */</span> <span class="mi">1</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_12x11           */</span> <span class="mi">2</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_10x11           */</span> <span class="mi">3</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_16x11           */</span> <span class="mi">4</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_40x33           */</span> <span class="mi">5</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_24x11           */</span> <span class="mi">6</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_20x11           */</span> <span class="mi">7</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_32x11           */</span> <span class="mi">8</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_80x33           */</span> <span class="mi">9</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_18x11           */</span> <span class="mi">10</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_15x11           */</span> <span class="mi">11</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_64x33           */</span> <span class="mi">12</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_160x99          */</span> <span class="mi">13</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_4x3             */</span> <span class="mi">14</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_3x2             */</span> <span class="mi">15</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_2x1             */</span> <span class="mi">16</span><span class="p">,</span>
		<span class="cm">/* V4L2_MPEG_VIDEO_H264_VUI_SAR_IDC_EXTENDED        */</span> <span class="mi">255</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">sar</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_enc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ctrl_to_ctx</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">gop_size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MODE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_mode</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_MB</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_mb</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_BYTES</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_bit</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_CYCLIC_INTRA_REFRESH_MB</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">intra_refresh_mb</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_PADDING</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_PADDING_YUV</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pad_luma</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pad_cb</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pad_cr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_FRAME_RC_ENABLE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_bitrate</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_RC_REACTION_COEFF</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_reaction_coeff</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_FORCE_FRAME_TYPE</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">force_frame_type</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_VBV_SIZE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">vbv_size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_CPB_SIZE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">cpb_size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_HEADER_MODE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_hdr_mode</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">frame_skip_mode</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_RC_FIXED_TARGET_BIT</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">fixed_target_bit</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_B_FRAMES</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">num_b_frame</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_PROFILE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_MAIN</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span>
					<span class="n">S5P_FIMV_ENC_PROFILE_H264_MAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_HIGH</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span>
					<span class="n">S5P_FIMV_ENC_PROFILE_H264_HIGH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span>
				<span class="n">S5P_FIMV_ENC_PROFILE_H264_BASELINE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LEVEL</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">level_v4l2</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">h264_level</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Level number is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_LEVEL</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">level_v4l2</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">mpeg4_level</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Level number is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_MODE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">loop_filter_mode</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_ALPHA</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">loop_filter_alpha</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_BETA</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">loop_filter_beta</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">entropy_mode</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_NUM_REF_PIC_FOR_P</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">num_ref_pic_4p</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_8X8_TRANSFORM</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">_8x8_transform</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MB_RC_ENABLE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_mb</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_I_FRAME_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_frame_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_MIN_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_min_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_MAX_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_max_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_P_FRAME_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_p_frame_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_B_FRAME_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_b_frame_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_I_FRAME_QP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_I_FRAME_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">rc_frame_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_MIN_QP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_MIN_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">rc_min_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_MAX_QP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_MAX_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">rc_max_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_P_FRAME_QP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_P_FRAME_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">rc_p_frame_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_B_FRAME_QP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_B_FRAME_QP</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">rc_b_frame_qp</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_DARK</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_mb_dark</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_SMOOTH</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_mb_smooth</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_STATIC</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_mb_static</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_MFC51_VIDEO_H264_ADAPTIVE_RC_ACTIVITY</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">rc_mb_activity</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_ENABLE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">vui_sar</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_IDC</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">vui_sar_idc</span> <span class="o">=</span> <span class="n">vui_sar_idc</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_EXT_SAR_WIDTH</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">vui_ext_sar_width</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_EXT_SAR_HEIGHT</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">vui_ext_sar_height</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">open_gop</span> <span class="o">=</span> <span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_I_PERIOD</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">.</span><span class="n">open_gop_size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_PROFILE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_PROFILE_SIMPLE</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span>
				<span class="n">S5P_FIMV_ENC_PROFILE_MPEG4_SIMPLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_MPEG4_PROFILE_ADVANCED_SIMPLE</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span>
			<span class="n">S5P_FIMV_ENC_PROFILE_MPEG4_ADVANCED_SIMPLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_QPEL</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">.</span><span class="n">quarter_pixel</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Invalid control, id=%d, val=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">s5p_mfc_enc_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">s5p_mfc_enc_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">.</span><span class="n">rc_framerate_num</span> <span class="o">=</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">.</span><span class="n">rc_framerate_denom</span> <span class="o">=</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Setting FPS is only possible for the output queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">.</span><span class="n">rc_framerate_num</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">.</span><span class="n">rc_framerate_denom</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Setting FPS is only possible for the output queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">s5p_mfc_enc_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span> <span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap_mplane</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap_mplane</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out_mplane</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_out_mplane</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap_mplane</span> <span class="o">=</span> <span class="n">vidioc_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out_mplane</span> <span class="o">=</span> <span class="n">vidioc_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap_mplane</span> <span class="o">=</span> <span class="n">vidioc_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out_mplane</span> <span class="o">=</span> <span class="n">vidioc_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap_mplane</span> <span class="o">=</span> <span class="n">vidioc_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out_mplane</span> <span class="o">=</span> <span class="n">vidioc_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span> <span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span> <span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span> <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span> <span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span> <span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span> <span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_parm</span> <span class="o">=</span> <span class="n">vidioc_s_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_parm</span> <span class="o">=</span> <span class="n">vidioc_g_parm</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_vb_with_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_fmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span> <span class="o">!=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;invalid plane number for the format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;failed to get plane cookie</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;index: %d, plane[%d] cookie: 0x%08zx&quot;</span><span class="p">,</span>
				<span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_queue_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buf_count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">plane_count</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">psize</span><span class="p">[],</span> <span class="kt">void</span> <span class="o">*</span><span class="n">allocators</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MFCINST_GOT_INST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;inavlid state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span><span class="p">)</span>
			<span class="o">*</span><span class="n">plane_count</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">plane_count</span> <span class="o">=</span> <span class="n">MFC_ENC_CAP_PLANE_COUNT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf_count</span> <span class="o">&gt;</span> <span class="n">MFC_MAX_BUFFERS</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">MFC_MAX_BUFFERS</span><span class="p">;</span>
		<span class="n">psize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_dst_buf_size</span><span class="p">;</span>
		<span class="n">allocators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK1_ALLOC_CTX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="p">)</span>
			<span class="o">*</span><span class="n">plane_count</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">plane_count</span> <span class="o">=</span> <span class="n">MFC_ENC_OUT_PLANE_COUNT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf_count</span> <span class="o">&gt;</span> <span class="n">MFC_MAX_BUFFERS</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">MFC_MAX_BUFFERS</span><span class="p">;</span>
		<span class="n">psize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">;</span>
		<span class="n">psize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">;</span>
		<span class="n">allocators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK2_ALLOC_CTX</span><span class="p">];</span>
		<span class="n">allocators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK2_ALLOC_CTX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;inavlid queue type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mfc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_buf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_vb_with_fmt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">.</span><span class="n">stream</span> <span class="o">=</span>
					<span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_vb_with_fmt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">luma</span> <span class="o">=</span>
					<span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">chroma</span> <span class="o">=</span>
					<span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_bufs_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;inavlid queue type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_buf_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_vb_with_fmt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_fmt</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;plane size: %ld, dst size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_dst_buf_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_dst_buf_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;plane size is too small for capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_vb_with_fmt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;plane size: %ld, luma size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">);</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;plane size: %ld, chroma size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span> <span class="o">||</span>
		    <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;plane size is too small for output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;inavlid queue type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_start_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="cm">/* If context is ready then dev = work-&gt;data;schedule it to run */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_ctx_ready</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_stop_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_FINISHING</span> <span class="o">||</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_ABORT</span><span class="p">;</span>
		<span class="n">s5p_mfc_wait_for_done_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">S5P_FIMV_R2H_CMD_FRAME_DONE_RET</span><span class="p">,</span>
					  <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_FINISHED</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s5p_mfc_cleanup_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_dst</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cleanup_ref_queue</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">s5p_mfc_cleanup_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vq_src</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_buf_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">fh_to_ctx</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">mfc_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MFCINST_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
		<span class="n">cleanup_ref_queue</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
		<span class="n">mfc_buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Mark destination as available for use by MFC */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mfc_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_bufs</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
		<span class="n">mfc_buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;change state to FINISHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_FINISHING</span><span class="p">;</span>
			<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
			<span class="n">cleanup_ref_queue</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mfc_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;unsupported buffer type (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_ctx_ready</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_try_run</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vb2_ops</span> <span class="n">s5p_mfc_enc_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue_setup</span>		<span class="o">=</span> <span class="n">s5p_mfc_queue_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_prepare</span>		<span class="o">=</span> <span class="n">s5p_mfc_unlock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_finish</span>		<span class="o">=</span> <span class="n">s5p_mfc_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_init</span>		<span class="o">=</span> <span class="n">s5p_mfc_buf_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>		<span class="o">=</span> <span class="n">s5p_mfc_buf_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_streaming</span>	<span class="o">=</span> <span class="n">s5p_mfc_start_streaming</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_streaming</span>		<span class="o">=</span> <span class="n">s5p_mfc_stop_streaming</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>		<span class="o">=</span> <span class="n">s5p_mfc_buf_queue</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5p_mfc_codec_ops</span> <span class="o">*</span><span class="nf">get_enc_codec_ops</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">encoder_codec_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">vb2_ops</span> <span class="o">*</span><span class="nf">get_enc_queue_ops</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">s5p_mfc_enc_qops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="o">*</span><span class="nf">get_enc_v4l2_ioctl_ops</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">s5p_mfc_enc_ioctl_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IS_MFC51_PRIV(x) ((V4L2_CTRL_ID2CLASS(x) == V4L2_CTRL_CLASS_MPEG) \</span>
<span class="cp">						&amp;&amp; V4L2_CTRL_DRIVER_PRIV(x))</span>

<span class="kt">int</span> <span class="nf">s5p_mfc_enc_ctrls_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_config</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">NUM_CTRLS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;v4l2_ctrl_handler_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CTRLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MFC51_PRIV</span><span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5p_mfc_enc_ctrl_ops</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">minimum</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">maximum</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_value</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">menu_skip_mask</span><span class="p">;</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">qmenu</span> <span class="o">=</span> <span class="n">mfc51_get_menu</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">step</span><span class="p">;</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">menu_skip_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_custom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">s5p_mfc_enc_ctrl_ops</span><span class="p">,</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">,</span>
					<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">maximum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_value</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">s5p_mfc_enc_ctrl_ops</span><span class="p">,</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">,</span>
					<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">minimum</span><span class="p">,</span>
					<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">maximum</span><span class="p">,</span> <span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">step</span><span class="p">,</span>
					<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_value</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Adding control (%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_volatile</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">s5p_mfc_enc_ctrls_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CTRLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
