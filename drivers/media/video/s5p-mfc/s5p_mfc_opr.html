<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s5p-mfc › s5p_mfc_opr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>s5p_mfc_opr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/media/video/samsung/mfc5/s5p_mfc_opr.c</span>
<span class="cm"> *</span>
<span class="cm"> * Samsung MFC (Multi Function Codec - FIMV) driver</span>
<span class="cm"> * This file contains hw related functions.</span>
<span class="cm"> *</span>
<span class="cm"> * Kamil Debski, Copyright (c) 2011 Samsung Electronics</span>
<span class="cm"> * http://www.samsung.com/</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;regs-mfc.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_cmd.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_common.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_ctrl.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_debug.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_intr.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_opr.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_pm.h&quot;</span>
<span class="cp">#include &quot;s5p_mfc_shm.h&quot;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#define OFFSETA(x)		(((x) - dev-&gt;bank1) &gt;&gt; MFC_OFFSET_SHIFT)</span>
<span class="cp">#define OFFSETB(x)		(((x) - dev-&gt;bank2) &gt;&gt; MFC_OFFSET_SHIFT)</span>

<span class="cm">/* Allocate temporary buffers for decoding */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_alloc_dec_temp_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span> <span class="o">=</span> <span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK1_ALLOC_CTX</span><span class="p">],</span> <span class="n">DESC_BUF_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Allocating DESC buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_phys</span> <span class="o">=</span> <span class="n">s5p_mfc_mem_cookie</span><span class="p">(</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK1_ALLOC_CTX</span><span class="p">],</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_phys</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MFC_BANK1_ALIGN_ORDER</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">desc_virt</span> <span class="o">=</span> <span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">vaddr</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc_virt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Remapping DESC buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">desc_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DESC_BUF_SIZE</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release temporary buffers for decoding */</span>
<span class="kt">void</span> <span class="nf">s5p_mfc_release_dec_desc_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Allocate codec buffers */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_alloc_codec_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enc_ref_y_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enc_ref_c_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">guard_width</span><span class="p">,</span> <span class="n">guard_height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MFCINST_DECODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Luma size:%d Chroma size:%d MV size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mv_size</span><span class="p">);</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Totals bufs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total_dpb_count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MFCINST_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enc_ref_y_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">)</span>
			<span class="o">*</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
		<span class="n">enc_ref_y_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">enc_ref_y_size</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_ENC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enc_ref_c_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">)</span>
						<span class="o">*</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
			<span class="n">enc_ref_c_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">enc_ref_c_size</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">guard_width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">);</span>
			<span class="n">guard_height</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
							<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
			<span class="n">enc_ref_c_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">guard_width</span> <span class="o">*</span> <span class="n">guard_height</span><span class="p">,</span>
					       <span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;recon luma size: %d chroma size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">enc_ref_y_size</span><span class="p">,</span> <span class="n">enc_ref_c_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Codecs have different memory requirements */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H264_DEC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span>
		    <span class="n">ALIGN</span><span class="p">(</span><span class="n">S5P_FIMV_DEC_NB_IP_SIZE</span> <span class="o">+</span>
					<span class="n">S5P_FIMV_DEC_VERT_NB_MV_SIZE</span><span class="p">,</span>
					<span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total_dpb_count</span> <span class="o">*</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mv_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_MPEG4_DEC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span>
		    <span class="n">ALIGN</span><span class="p">(</span><span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span> <span class="o">+</span>
				     <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span> <span class="o">+</span>
				     <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span> <span class="o">+</span>
				     <span class="n">S5P_FIMV_DEC_STX_PARSER_SIZE</span> <span class="o">+</span>
				     <span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span><span class="p">,</span>
				     <span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_VC1RCV_DEC</span>:
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_VC1_DEC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span>
		    <span class="n">ALIGN</span><span class="p">(</span><span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span> <span class="o">+</span>
			     <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span> <span class="o">+</span>
			     <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span> <span class="o">+</span>
			     <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span> <span class="o">+</span>
			     <span class="mi">3</span> <span class="o">*</span> <span class="n">S5P_FIMV_DEC_VC1_BITPLANE_SIZE</span><span class="p">,</span>
			     <span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_MPEG2_DEC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H263_DEC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span>
		    <span class="n">ALIGN</span><span class="p">(</span><span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span> <span class="o">+</span>
			     <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span> <span class="o">+</span>
			     <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span> <span class="o">+</span>
			     <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span><span class="p">,</span>
			     <span class="n">S5P_FIMV_DEC_BUF_ALIGN</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H264_ENC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc_ref_y_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_COLFLG_SIZE</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_INTRAMD_SIZE</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_NBORINFO_SIZE</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc_ref_y_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">enc_ref_c_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_INTRAPRED_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_MPEG4_ENC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc_ref_y_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_COLFLG_SIZE</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_ACDCCOEF_SIZE</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc_ref_y_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">enc_ref_c_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H263_ENC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc_ref_y_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span> <span class="o">+</span>
				   <span class="n">S5P_FIMV_ENC_ACDCCOEF_SIZE</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc_ref_y_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">enc_ref_c_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate only if memory from bank 1 is necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_buf</span> <span class="o">=</span> <span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK1_ALLOC_CTX</span><span class="p">],</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_buf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Buf alloc for decoding failed (port A)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_phys</span> <span class="o">=</span> <span class="n">s5p_mfc_mem_cookie</span><span class="p">(</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK1_ALLOC_CTX</span><span class="p">],</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_buf</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_phys</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MFC_BANK1_ALIGN_ORDER</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate only if memory from bank 2 is necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_buf</span> <span class="o">=</span> <span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK2_ALLOC_CTX</span><span class="p">],</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_buf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Buf alloc for decoding failed (port B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_phys</span> <span class="o">=</span> <span class="n">s5p_mfc_mem_cookie</span><span class="p">(</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK2_ALLOC_CTX</span><span class="p">],</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_buf</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_phys</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MFC_BANK2_ALIGN_ORDER</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release buffers allocated for codec */</span>
<span class="kt">void</span> <span class="nf">s5p_mfc_release_codec_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_buf</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_buf</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Allocate memory for instance data buffer */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_alloc_instance_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">context_virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_DEC</span> <span class="o">||</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_ENC</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_size</span> <span class="o">=</span> <span class="n">MFC_H264_CTX_BUF_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_size</span> <span class="o">=</span> <span class="n">MFC_CTX_BUF_SIZE</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span> <span class="o">=</span> <span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK1_ALLOC_CTX</span><span class="p">],</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Allocating context buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_phys</span> <span class="o">=</span> <span class="n">s5p_mfc_mem_cookie</span><span class="p">(</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">alloc_ctx</span><span class="p">[</span><span class="n">MFC_BANK1_ALLOC_CTX</span><span class="p">],</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_phys</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MFC_BANK1_ALIGN_ORDER</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_ofs</span> <span class="o">=</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_phys</span><span class="p">);</span>
	<span class="n">context_virt</span> <span class="o">=</span> <span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">vaddr</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context_virt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Remapping instance buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Zero content of the allocated memory */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">context_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_size</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5p_mfc_init_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release instance buffer */</span>
<span class="kt">void</span> <span class="nf">s5p_mfc_release_instance_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shm_alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_dma_contig_memops</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shm_alloc</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shm_alloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Set registers for decoding temporary buffers */</span>
<span class="kt">void</span> <span class="nf">s5p_mfc_set_dec_desc_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">desc_phys</span><span class="p">),</span> <span class="n">S5P_FIMV_SI_CH0_DESC_ADR</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DESC_BUF_SIZE</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_DESC_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set registers for shared buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_set_shared_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shm_ofs</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_HOST_WR_ADR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set registers for decoding stream buffer */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_set_dec_stream_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_addr</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_num_byte</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">),</span> <span class="n">S5P_FIMV_SI_CH0_SB_ST_ADR</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dec_src_buf_size</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_CPB_SIZE</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_SB_FRM_SIZE</span><span class="p">);</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">start_num_byte</span><span class="p">,</span> <span class="n">START_BYTE_NUM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set decoding frame buffer */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_set_dec_frame_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_size_ch</span><span class="p">,</span> <span class="n">frame_size_mv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dpb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_addr1</span><span class="p">,</span> <span class="n">buf_addr2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_size1</span><span class="p">,</span> <span class="n">buf_size2</span><span class="p">;</span>

	<span class="n">buf_addr1</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_phys</span><span class="p">;</span>
	<span class="n">buf_size1</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span><span class="p">;</span>
	<span class="n">buf_addr2</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_phys</span><span class="p">;</span>
	<span class="n">buf_size2</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span><span class="p">;</span>
	<span class="n">dpb</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_DPB_CONF_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="n">S5P_FIMV_DPB_COUNT_MASK</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total_dpb_count</span> <span class="o">|</span> <span class="n">dpb</span><span class="p">,</span>
						<span class="n">S5P_FIMV_SI_CH0_DPB_CONF_CTRL</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_shared_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H264_DEC</span>:
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
						<span class="n">S5P_FIMV_H264_VERT_NB_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_VERT_NB_MV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_VERT_NB_MV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H264_NB_IP_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_NB_IP_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_NB_IP_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_MPEG4_DEC</span>:
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_MPEG4_NB_DCAC_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_MPEG4_UP_NB_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_MPEG4_SA_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_MPEG4_SP_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_STX_PARSER_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_STX_PARSER_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_MPEG4_OT_LINE_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H263_DEC</span>:
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H263_OT_LINE_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H263_UP_NB_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H263_SA_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H263_NB_DCAC_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_VC1_DEC</span>:
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_VC1RCV_DEC</span>:
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_VC1_NB_DCAC_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_NB_DCAC_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_VC1_OT_LINE_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_OVERLAP_TRANSFORM_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_VC1_UP_NB_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_UPNB_MV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_VC1_SA_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_SUB_ANCHOR_MV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_VC1_BITPLANE3_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_VC1_BITPLANE_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_VC1_BITPLANE_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_VC1_BITPLANE2_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_VC1_BITPLANE_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_VC1_BITPLANE_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_VC1_BITPLANE1_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_DEC_VC1_BITPLANE_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_DEC_VC1_BITPLANE_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_MPEG2_DEC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Unknown codec for decoding (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">frame_size</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">luma_size</span><span class="p">;</span>
	<span class="n">frame_size_ch</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chroma_size</span><span class="p">;</span>
	<span class="n">frame_size_mv</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mv_size</span><span class="p">;</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Frm size: %d ch: %d mv: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="n">frame_size_ch</span><span class="p">,</span>
								<span class="n">frame_size_mv</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total_dpb_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bank2 */</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Luma %d: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">luma</span><span class="p">);</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">luma</span><span class="p">),</span>
						<span class="n">S5P_FIMV_DEC_LUMA_ADR</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Chroma %d: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">chroma</span><span class="p">);</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">chroma</span><span class="p">),</span>
					       <span class="n">S5P_FIMV_DEC_CHROMA_ADR</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_DEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Buf2: %x, size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">buf_addr2</span><span class="p">,</span> <span class="n">buf_size2</span><span class="p">);</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
						<span class="n">S5P_FIMV_H264_MV_ADR</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">frame_size_mv</span><span class="p">;</span>
			<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">frame_size_mv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Buf1: %u, buf_size1: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf_addr1</span><span class="p">,</span> <span class="n">buf_size1</span><span class="p">);</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Buf 1/2 size after: %d/%d (frames %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf_size1</span><span class="p">,</span>  <span class="n">buf_size2</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total_dpb_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf_size1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf_size2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Not enough memory has been allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="n">ALLOC_LUMA_DPB_SIZE</span><span class="p">);</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">frame_size_ch</span><span class="p">,</span> <span class="n">ALLOC_CHROMA_DPB_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_DEC</span><span class="p">)</span>
		<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">frame_size_mv</span><span class="p">,</span> <span class="n">ALLOC_MV_SIZE</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="n">S5P_FIMV_CH_INIT_BUFS</span> <span class="o">&amp;</span> <span class="n">S5P_FIMV_CH_MASK</span><span class="p">)</span>
					<span class="o">&lt;&lt;</span> <span class="n">S5P_FIMV_CH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">),</span>
						<span class="n">S5P_FIMV_SI_CH0_INST_ID</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set registers for encoding stream buffer */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_set_enc_stream_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">S5P_FIMV_ENC_SI_CH0_SB_ADR</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_SI_CH0_SB_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">s5p_mfc_set_enc_frame_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">y_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">c_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">y_addr</span><span class="p">),</span> <span class="n">S5P_FIMV_ENC_SI_CH0_CUR_Y_ADR</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">c_addr</span><span class="p">),</span> <span class="n">S5P_FIMV_ENC_SI_CH0_CUR_C_ADR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">s5p_mfc_get_enc_frame_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">y_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">c_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">y_addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bank2</span> <span class="o">+</span> <span class="p">(</span><span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENCODED_Y_ADDR</span><span class="p">)</span>
							<span class="o">&lt;&lt;</span> <span class="n">MFC_OFFSET_SHIFT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">c_addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bank2</span> <span class="o">+</span> <span class="p">(</span><span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENCODED_C_ADDR</span><span class="p">)</span>
							<span class="o">&lt;&lt;</span> <span class="n">MFC_OFFSET_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set encoding ref &amp; codec buffer */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_set_enc_ref_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_addr1</span><span class="p">,</span> <span class="n">buf_addr2</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_size1</span><span class="p">,</span> <span class="n">buf_size2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enc_ref_y_size</span><span class="p">,</span> <span class="n">enc_ref_c_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">guard_width</span><span class="p">,</span> <span class="n">guard_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">buf_addr1</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_phys</span><span class="p">;</span>
	<span class="n">buf_size1</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank1_size</span><span class="p">;</span>
	<span class="n">buf_addr2</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_phys</span><span class="p">;</span>
	<span class="n">buf_size2</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bank2_size</span><span class="p">;</span>
	<span class="n">enc_ref_y_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">)</span>
		<span class="o">*</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
	<span class="n">enc_ref_y_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">enc_ref_y_size</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_ENC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enc_ref_c_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">)</span>
			<span class="o">*</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
		<span class="n">enc_ref_c_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">enc_ref_c_size</span><span class="p">,</span> <span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">guard_width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_HALIGN</span><span class="p">);</span>
		<span class="n">guard_height</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
						<span class="n">S5P_FIMV_NV12MT_VALIGN</span><span class="p">);</span>
		<span class="n">enc_ref_c_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">guard_width</span> <span class="o">*</span> <span class="n">guard_height</span><span class="p">,</span>
				       <span class="n">S5P_FIMV_NV12MT_SALIGN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;buf_size1: %d, buf_size2: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf_size1</span><span class="p">,</span> <span class="n">buf_size2</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H264_ENC</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF0_LUMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>

			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF2_LUMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF0_CHROMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">enc_ref_c_size</span><span class="p">;</span>
			<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">enc_ref_c_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H264_UP_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
					<span class="n">S5P_FIMV_H264_COZERO_FLAG_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_COLFLG_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_COLFLG_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
					<span class="n">S5P_FIMV_H264_UP_INTRA_MD_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_INTRAMD_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_INTRAMD_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
					<span class="n">S5P_FIMV_H264_UP_INTRA_PRED_ADR</span><span class="p">);</span>
		<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_INTRAPRED_SIZE</span><span class="p">;</span>
		<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_INTRAPRED_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
					<span class="n">S5P_FIMV_H264_NBOR_INFO_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_NBORINFO_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_NBORINFO_SIZE</span><span class="p">;</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;buf_size1: %d, buf_size2: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf_size1</span><span class="p">,</span> <span class="n">buf_size2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_MPEG4_ENC</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF0_LUMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF2_LUMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF0_CHROMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">enc_ref_c_size</span><span class="p">;</span>
			<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">enc_ref_c_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_MPEG4_UP_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
						<span class="n">S5P_FIMV_MPEG4_COZERO_FLAG_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_COLFLG_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_COLFLG_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
						<span class="n">S5P_FIMV_MPEG4_ACDC_COEF_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_ACDCCOEF_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_ACDCCOEF_SIZE</span><span class="p">;</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;buf_size1: %d, buf_size2: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf_size1</span><span class="p">,</span> <span class="n">buf_size2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S5P_FIMV_CODEC_H263_ENC</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF0_LUMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF2_LUMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
			<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">enc_ref_y_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETB</span><span class="p">(</span><span class="n">buf_addr2</span><span class="p">),</span>
				<span class="n">S5P_FIMV_ENC_REF0_CHROMA_ADR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">buf_addr2</span> <span class="o">+=</span> <span class="n">enc_ref_c_size</span><span class="p">;</span>
			<span class="n">buf_size2</span> <span class="o">-=</span> <span class="n">enc_ref_c_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H263_UP_MV_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_UPMV_SIZE</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFFSETA</span><span class="p">(</span><span class="n">buf_addr1</span><span class="p">),</span> <span class="n">S5P_FIMV_H263_ACDC_COEF_ADR</span><span class="p">);</span>
		<span class="n">buf_addr1</span> <span class="o">+=</span> <span class="n">S5P_FIMV_ENC_ACDCCOEF_SIZE</span><span class="p">;</span>
		<span class="n">buf_size1</span> <span class="o">-=</span> <span class="n">S5P_FIMV_ENC_ACDCCOEF_SIZE</span><span class="p">;</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;buf_size1: %d, buf_size2: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf_size1</span><span class="p">,</span> <span class="n">buf_size2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Unknown codec set for encoding: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_set_enc_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shm</span><span class="p">;</span>

	<span class="cm">/* width */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_width</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_HSIZE_PX</span><span class="p">);</span>
	<span class="cm">/* height */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_VSIZE_PX</span><span class="p">);</span>
	<span class="cm">/* pictype : enable, IDR period */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PIC_TYPE_CTRL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">gop_size</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PIC_TYPE_CTRL</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_B_RECON_WRITE_ON</span><span class="p">);</span>
	<span class="cm">/* multi-slice control */</span>
	<span class="cm">/* multi-slice MB number or bit size */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_mode</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MSLICE_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_mode</span> <span class="o">==</span> <span class="n">V4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_MB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_mb</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MSLICE_MB</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_mode</span> <span class="o">==</span> <span class="n">V4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">slice_bit</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MSLICE_BIT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MSLICE_MB</span><span class="p">);</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MSLICE_BIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* cyclic intra refresh */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">intra_refresh_mb</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_CIR_CTRL</span><span class="p">);</span>
	<span class="cm">/* memory structure cur. frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12M</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MAP_FOR_CUR</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12MT</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MAP_FOR_CUR</span><span class="p">);</span>
	<span class="cm">/* padding control &amp; value */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PADDING_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/** enable */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="cm">/** cr value */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pad_cr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="cm">/** cb value */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pad_cb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="cm">/** y value */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pad_luma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/** disable &amp; all value clear */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PADDING_CTRL</span><span class="p">);</span>
	<span class="cm">/* rate control config. */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/** frame-level rate control */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/* bit rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_bitrate</span><span class="p">,</span>
			<span class="n">S5P_FIMV_ENC_RC_BIT_RATE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_BIT_RATE</span><span class="p">);</span>
	<span class="cm">/* reaction coefficient */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_reaction_coeff</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_RPARA</span><span class="p">);</span>
	<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="cm">/* seq header ctrl */</span>
	<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_hdr_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="cm">/* frame skip mode */</span>
	<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frame_skip_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="cm">/* fixed target bit */</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fixed_target_bit</span><span class="p">,</span> <span class="n">RC_CONTROL_CONFIG</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_set_enc_params_h264</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_h264_enc_params</span> <span class="o">*</span><span class="n">p_264</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">h264</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shm</span><span class="p">;</span>

	<span class="n">s5p_mfc_set_enc_params</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="cm">/* pictype : number of B */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PIC_TYPE_CTRL</span><span class="p">);</span>
	<span class="cm">/* num_b_frame - 0 ~ 2 */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_b_frame</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PIC_TYPE_CTRL</span><span class="p">);</span>
	<span class="cm">/* profile &amp; level */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PROFILE</span><span class="p">);</span>
	<span class="cm">/* level */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* profile - 0 ~ 2 */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PROFILE</span><span class="p">);</span>
	<span class="cm">/* interlace  */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">interlace</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PIC_STRUCT</span><span class="p">);</span>
	<span class="cm">/* height */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">interlace</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">img_height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_VSIZE_PX</span><span class="p">);</span>
	<span class="cm">/* loopfilter ctrl */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">loop_filter_mode</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_LF_CTRL</span><span class="p">);</span>
	<span class="cm">/* loopfilter alpha offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">loop_filter_alpha</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">loop_filter_alpha</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">loop_filter_alpha</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_ALPHA_OFF</span><span class="p">);</span>
	<span class="cm">/* loopfilter beta offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">loop_filter_beta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">loop_filter_beta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">loop_filter_beta</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_BETA_OFF</span><span class="p">);</span>
	<span class="cm">/* entropy coding mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">entropy_mode</span> <span class="o">==</span> <span class="n">V4L2_MPEG_VIDEO_H264_ENTROPY_MODE_CABAC</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_H264_ENTROPY_MODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_H264_ENTROPY_MODE</span><span class="p">);</span>
	<span class="cm">/* number of ref. picture */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_H264_NUM_OF_REF</span><span class="p">);</span>
	<span class="cm">/* num of ref. pictures of P */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">num_ref_pic_4p</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* max number of ref. pictures */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">max_ref_pic</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_H264_NUM_OF_REF</span><span class="p">);</span>
	<span class="cm">/* 8x8 transform enable */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">_8x8_transform</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_H264_TRANS_FLAG</span><span class="p">);</span>
	<span class="cm">/* rate control config. */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/* macroblock level rate control */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_mb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* frame QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_frame_qp</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/* frame rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_denom</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_num</span> <span class="o">*</span> <span class="mi">1000</span>
			<span class="o">/</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_denom</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_FRAME_RATE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_FRAME_RATE</span><span class="p">);</span>
	<span class="cm">/* max &amp; min value of QP */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_QBOUND</span><span class="p">);</span>
	<span class="cm">/* max QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_max_qp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* min QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_min_qp</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_QBOUND</span><span class="p">);</span>
	<span class="cm">/* macroblock adaptive scaling features */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_mb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_MB_CTRL</span><span class="p">);</span>
		<span class="cm">/* dark region */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_mb_dark</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="cm">/* smooth region */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_mb_smooth</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* static region */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_mb_static</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* high activity region */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_mb_activity</span><span class="p">;</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_MB_CTRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_mb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">P_B_FRAME_QP</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFF</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">((</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_b_frame_qp</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">rc_p_frame_qp</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">P_B_FRAME_QP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* extended encoder ctrl */</span>
	<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="cm">/* AR VUI control */</span>
	<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">vui_sar</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">vui_sar</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* aspect ration IDC */</span>
		<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SAMPLE_ASPECT_RATIO_IDC</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">vui_sar_idc</span><span class="p">;</span>
		<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">SAMPLE_ASPECT_RATIO_IDC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">vui_sar_idc</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* sample  AR info */</span>
			<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">EXTENDED_SAR</span><span class="p">);</span>
			<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">);</span>
			<span class="n">shm</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">vui_ext_sar_width</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">shm</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">vui_ext_sar_height</span><span class="p">;</span>
			<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">EXTENDED_SAR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* intra picture period for H.264 */</span>
	<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">H264_I_PERIOD</span><span class="p">);</span>
	<span class="cm">/* control */</span>
	<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">open_gop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="cm">/* value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">open_gop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="n">p_264</span><span class="o">-&gt;</span><span class="n">open_gop_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">H264_I_PERIOD</span><span class="p">);</span>
	<span class="cm">/* extended encoder ctrl */</span>
	<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="cm">/* vbv buffer size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frame_skip_mode</span> <span class="o">==</span>
			<span class="n">V4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_BUF_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_264</span><span class="o">-&gt;</span><span class="n">cpb_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_set_enc_params_mpeg4</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_mpeg4_enc_params</span> <span class="o">*</span><span class="n">p_mpeg4</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">framerate</span><span class="p">;</span>

	<span class="n">s5p_mfc_set_enc_params</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="cm">/* pictype : number of B */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PIC_TYPE_CTRL</span><span class="p">);</span>
	<span class="cm">/* num_b_frame - 0 ~ 2 */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_b_frame</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PIC_TYPE_CTRL</span><span class="p">);</span>
	<span class="cm">/* profile &amp; level */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PROFILE</span><span class="p">);</span>
	<span class="cm">/* level */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* profile - 0 ~ 2 */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_PROFILE</span><span class="p">);</span>
	<span class="cm">/* quarter_pixel */</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">quarter_pixel</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MPEG4_QUART_PXL</span><span class="p">);</span>
	<span class="cm">/* qp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">P_B_FRAME_QP</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFF</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">((</span><span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">rc_b_frame_qp</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">rc_p_frame_qp</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">P_B_FRAME_QP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* frame rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">framerate</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_num</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span>
						<span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_denom</span><span class="p">;</span>
			<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">framerate</span><span class="p">,</span>
				<span class="n">S5P_FIMV_ENC_RC_FRAME_RATE</span><span class="p">);</span>
			<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RC_VOP_TIMING</span><span class="p">);</span>
			<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">);</span>
			<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
			<span class="n">shm</span> <span class="o">|=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_num</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_denom</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">RC_VOP_TIMING</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_FRAME_RATE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* rate control config. */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/* frame QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">rc_frame_qp</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/* max &amp; min value of QP */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_QBOUND</span><span class="p">);</span>
	<span class="cm">/* max QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">rc_max_qp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* min QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_mpeg4</span><span class="o">-&gt;</span><span class="n">rc_min_qp</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_QBOUND</span><span class="p">);</span>
	<span class="cm">/* extended encoder ctrl */</span>
	<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="cm">/* vbv buffer size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frame_skip_mode</span> <span class="o">==</span>
			<span class="n">V4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_BUF_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">vbv_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_set_enc_params_h263</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_enc_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enc_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_mpeg4_enc_params</span> <span class="o">*</span><span class="n">p_h263</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">mpeg4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shm</span><span class="p">;</span>

	<span class="n">s5p_mfc_set_enc_params</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="cm">/* qp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">P_B_FRAME_QP</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFF</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_h263</span><span class="o">-&gt;</span><span class="n">rc_p_frame_qp</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">P_B_FRAME_QP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* frame rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_frame</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_denom</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_num</span> <span class="o">*</span> <span class="mi">1000</span>
			<span class="o">/</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rc_framerate_denom</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_FRAME_RATE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_FRAME_RATE</span><span class="p">);</span>
	<span class="cm">/* rate control config. */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/* frame QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_h263</span><span class="o">-&gt;</span><span class="n">rc_frame_qp</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_CONFIG</span><span class="p">);</span>
	<span class="cm">/* max &amp; min value of QP */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_QBOUND</span><span class="p">);</span>
	<span class="cm">/* max QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p_h263</span><span class="o">-&gt;</span><span class="n">rc_max_qp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* min QP */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">p_h263</span><span class="o">-&gt;</span><span class="n">rc_min_qp</span><span class="p">;</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_RC_QBOUND</span><span class="p">);</span>
	<span class="cm">/* extended encoder ctrl */</span>
	<span class="n">shm</span> <span class="o">=</span> <span class="n">s5p_mfc_read_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="cm">/* vbv buffer size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frame_skip_mode</span> <span class="o">==</span>
			<span class="n">V4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_BUF_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">shm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">vbv_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_write_shm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shm</span><span class="p">,</span> <span class="n">EXT_ENC_CONTROL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize decoding */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_init_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">s5p_mfc_set_shared_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="cm">/* Setup loop filter, for decoding this is only valid for MPEG4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_MPEG4_DEC</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">loop_filter_mpeg4</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_LF_CTRL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_LF_CTRL</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">slice_interface</span> <span class="o">&amp;</span> <span class="n">S5P_FIMV_SLICE_INT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">S5P_FIMV_SLICE_INT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">display_delay_enable</span> <span class="o">&lt;&lt;</span>
		<span class="n">S5P_FIMV_DDELAY_ENA_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">display_delay</span> <span class="o">&amp;</span>
		<span class="n">S5P_FIMV_DDELAY_VAL_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S5P_FIMV_DDELAY_VAL_SHIFT</span><span class="p">),</span>
		<span class="n">S5P_FIMV_SI_CH0_DPB_CONF_CTRL</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
	<span class="p">((</span><span class="n">S5P_FIMV_CH_SEQ_HEADER</span> <span class="o">&amp;</span> <span class="n">S5P_FIMV_CH_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S5P_FIMV_CH_SHIFT</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">),</span> <span class="n">S5P_FIMV_SI_CH0_INST_ID</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_set_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dpb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">dpb</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_DPB_CONF_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
			<span class="n">S5P_FIMV_DPB_FLUSH_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">S5P_FIMV_DPB_FLUSH_SHIFT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dpb</span> <span class="o">=</span> <span class="n">mfc_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_DPB_CONF_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">S5P_FIMV_DPB_FLUSH_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">S5P_FIMV_DPB_FLUSH_SHIFT</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dpb</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_DPB_CONF_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Decode a single frame */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_decode_one_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">s5p_mfc_decode_arg</span> <span class="n">last_frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dec_dst_flag</span><span class="p">,</span> <span class="n">S5P_FIMV_SI_CH0_RELEASE_BUF</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_shared_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_flush</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpb_flush_flag</span><span class="p">);</span>
	<span class="cm">/* Issue different commands to instance basing on whether it</span>
<span class="cm">	 * is the last frame or not. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">last_frame</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MFC_DEC_FRAME</span>:
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="n">S5P_FIMV_CH_FRAME_START</span> <span class="o">&amp;</span> <span class="n">S5P_FIMV_CH_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">S5P_FIMV_CH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">),</span> <span class="n">S5P_FIMV_SI_CH0_INST_ID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFC_DEC_LAST_FRAME</span>:
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="n">S5P_FIMV_CH_LAST_FRAME</span> <span class="o">&amp;</span> <span class="n">S5P_FIMV_CH_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">S5P_FIMV_CH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">),</span> <span class="n">S5P_FIMV_SI_CH0_INST_ID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFC_DEC_RES_CHANGE</span>:
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="n">S5P_FIMV_CH_FRAME_START_REALLOC</span> <span class="o">&amp;</span>
		<span class="n">S5P_FIMV_CH_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S5P_FIMV_CH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">),</span>
		<span class="n">S5P_FIMV_SI_CH0_INST_ID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Decoding a usual frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">s5p_mfc_init_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H264_ENC</span><span class="p">)</span>
		<span class="n">s5p_mfc_set_enc_params_h264</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_MPEG4_ENC</span><span class="p">)</span>
		<span class="n">s5p_mfc_set_enc_params_mpeg4</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span> <span class="o">==</span> <span class="n">S5P_FIMV_CODEC_H263_ENC</span><span class="p">)</span>
		<span class="n">s5p_mfc_set_enc_params_h263</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Unknown codec for encoding (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">codec_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_set_shared_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="n">S5P_FIMV_CH_SEQ_HEADER</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70000</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">),</span> <span class="n">S5P_FIMV_SI_CH0_INST_ID</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Encode a single frame */</span>
<span class="kt">int</span> <span class="nf">s5p_mfc_encode_one_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* memory structure cur. frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12M</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MAP_FOR_CUR</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_NV12MT</span><span class="p">)</span>
		<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">S5P_FIMV_ENC_MAP_FOR_CUR</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_shared_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">mfc_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">S5P_FIMV_CH_FRAME_START</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0x70000</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">inst_no</span><span class="p">),</span> <span class="n">S5P_FIMV_SI_CH0_INST_ID</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_get_new_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">new_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MFC_NUM_CONTEXTS</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">new_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx_work_bits</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_ctx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MFC_NUM_CONTEXTS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">MFC_NUM_CONTEXTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No contexts to run */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">condlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new_ctx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_run_res_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">s5p_mfc_set_dec_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">s5p_mfc_decode_one_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">MFC_DEC_RES_CHANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_run_dec_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last_frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">temp_vb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Frames are being decoded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;No src buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get the next source buffer */</span>
	<span class="n">temp_vb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s5p_mfc_set_dec_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
		<span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">consumed_stream</span><span class="p">,</span>
					<span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_frame</span> <span class="o">=</span> <span class="n">MFC_DEC_LAST_FRAME</span><span class="p">;</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Setting ctx-&gt;state to FINISHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_FINISHING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s5p_mfc_decode_one_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">last_frame</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_run_enc_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">dst_mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">src_mb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_y_addr</span><span class="p">,</span> <span class="n">src_c_addr</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_size</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;no src buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;no dst buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">src_mb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">src_mb</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">src_y_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">src_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">src_c_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">src_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_enc_frame_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">src_y_addr</span><span class="p">,</span> <span class="n">src_c_addr</span><span class="p">);</span>
	<span class="n">dst_mb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dst_size</span> <span class="o">=</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_enc_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst_size</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">s5p_mfc_encode_one_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_run_init_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">temp_vb</span><span class="p">;</span>

	<span class="cm">/* Initializing decoding - parsing header */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Preparing to init decoding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">temp_vb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_dec_desc_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Header size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_dec_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
				<span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">s5p_mfc_init_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5p_mfc_run_init_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">dst_mb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_size</span><span class="p">;</span>

	<span class="n">s5p_mfc_set_enc_ref_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dst_mb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dst_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dst_size</span> <span class="o">=</span> <span class="n">vb2_plane_size</span><span class="p">(</span><span class="n">dst_mb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_enc_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst_size</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">s5p_mfc_init_encode</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5p_mfc_run_init_dec_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">temp_vb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Header was parsed now starting processing</span>
<span class="cm">	 * First set the output frame buffers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">capture_state</span> <span class="o">!=</span> <span class="n">QUEUE_BUFS_MMAPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;It seems that not all destionation buffers were &quot;</span>
			<span class="s">&quot;mmaped</span><span class="se">\n</span><span class="s">MFC requires that all destination are mmaped &quot;</span>
			<span class="s">&quot;before starting processing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Header has been deallocated in the middle of&quot;</span>
			<span class="s">&quot; initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">temp_vb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">src_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Header size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="n">s5p_mfc_set_dec_stream_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
				<span class="n">vb2_dma_contig_plane_dma_addr</span><span class="p">(</span><span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">temp_vb</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">v4l2_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">curr_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_set_dec_frame_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to alloc frame mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MFCINST_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try running an operation on hardware */</span>
<span class="kt">void</span> <span class="nf">s5p_mfc_try_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5p_mfc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enter_suspend</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Entering suspend so do not schedule any jobs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check whether hardware is not running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is perfectly ok, the scheduled ctx should wait */</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t lock HW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Choose the context to run */</span>
	<span class="n">new_ctx</span> <span class="o">=</span> <span class="n">s5p_mfc_get_new_ctx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ctx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No contexts to run */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to unlock hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No ctx is scheduled to be run</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">[</span><span class="n">new_ctx</span><span class="p">];</span>
	<span class="cm">/* Got context to run in ctx */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Last frame has already been sent to MFC.</span>
<span class="cm">	 * Now obtaining frames from MFC buffer</span>
<span class="cm">	 */</span>
	<span class="n">s5p_mfc_clock_on</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MFCINST_DECODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s5p_mfc_set_dec_desc_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MFCINST_FINISHING</span>:
			<span class="n">s5p_mfc_run_dec_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">MFC_DEC_LAST_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_RUNNING</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_run_dec_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">MFC_DEC_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_INIT</span>:
			<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_open_inst_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_RETURN_INST</span>:
			<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_close_inst_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_GOT_INST</span>:
			<span class="n">s5p_mfc_run_init_dec</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_HEAD_PARSED</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_run_init_dec_buffers</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;head parsed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_RES_CHANGE_INIT</span>:
			<span class="n">s5p_mfc_run_res_change</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_RES_CHANGE_FLUSH</span>:
			<span class="n">s5p_mfc_run_dec_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">MFC_DEC_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_RES_CHANGE_END</span>:
			<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Finished remaining frames after resolution change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">capture_state</span> <span class="o">=</span> <span class="n">QUEUE_FREE</span><span class="p">;</span>
			<span class="n">mfc_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Will re-init the codec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">s5p_mfc_run_init_dec</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MFCINST_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MFCINST_FINISHING</span>:
		<span class="k">case</span> <span class="n">MFCINST_RUNNING</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_run_enc_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_INIT</span>:
			<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_open_inst_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_RETURN_INST</span>:
			<span class="n">s5p_mfc_clean_ctx_int_flags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5p_mfc_close_inst_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFCINST_GOT_INST</span>:
			<span class="n">s5p_mfc_run_init_enc</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Invalid context type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Free hardware lock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mfc_err</span><span class="p">(</span><span class="s">&quot;Failed to unlock hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* This is in deed imporant, as no operation has been</span>
<span class="cm">		 * scheduled, reduce the clock count as no one will</span>
<span class="cm">		 * ever do this, because no interrupt related to this try_run</span>
<span class="cm">		 * will ever come from hardware. */</span>
		<span class="n">s5p_mfc_clock_off</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">s5p_mfc_cleanup_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_mfc_buf</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">lh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">lh</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5p_mfc_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vb2_set_plane_payload</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
