<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › tvp5150.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tvp5150.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * tvp5150 - Texas Instruments TVP5150A/AM1 video decoder driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2005,2006 Mauro Carvalho Chehab (mchehab@infradead.org)</span>
<span class="cm"> * This code is placed under the terms of the GNU General Public License v2</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/tvp5150.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>

<span class="cp">#include &quot;tvp5150_reg.h&quot;</span>

<span class="cp">#define TVP5150_H_MAX		720</span>
<span class="cp">#define TVP5150_V_MAX_525_60	480</span>
<span class="cp">#define TVP5150_V_MAX_OTHERS	576</span>
<span class="cp">#define TVP5150_MAX_CROP_LEFT	511</span>
<span class="cp">#define TVP5150_MAX_CROP_TOP	127</span>
<span class="cp">#define TVP5150_CROP_SHIFT	2</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Texas Instruments TVP5150A video decoder driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mauro Carvalho Chehab&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-2)&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">tvp5150</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">rect</span><span class="p">;</span>

	<span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">;</span>	<span class="cm">/* Current set standard */</span>
	<span class="n">u32</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">output</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="nf">to_tvp5150</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tvp5150</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">to_sd</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tvp5150</span><span class="p">,</span> <span class="n">hdl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;i2c i/o error: rc == %d (should be 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;i2c i/o error: rc == %d (should be 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tvp5150: read 0x%02x = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tvp5150_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tvp5150: writing 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;i2c i/o error: rc == %d (should be 2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_reg_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u8</span> <span class="n">init</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">end</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">init</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">max_line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: %s reg 0x%02x = &quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">init</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">init</span><span class="p">));</span>

		<span class="n">init</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Video input source selection #1 = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VD_IN_SRC_SEL_1</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Analog channel controls = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ANAL_CHL_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Operation mode controls = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_OP_MODE_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Miscellaneous controls = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_MISC_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Autoswitch mask= 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_AUTOSW_MSK</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Color killer threshold control = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_COLOR_KIL_THSH_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Luminance processing controls #1 #2 and #3 = %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_LUMA_PROC_CTL_1</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_LUMA_PROC_CTL_2</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_LUMA_PROC_CTL_3</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Brightness control = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_BRIGHT_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Color saturation control = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_SATURATION_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Hue control = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_HUE_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Contrast control = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CONTRAST_CTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Outputs and data rates select = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_DATA_RATE_SEL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Configuration shared pins = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CONF_SHARED_PIN</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Active video cropping start = 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_ST_MSB</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_ST_LSB</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Active video cropping stop  = 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_STP_MSB</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_STP_LSB</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Genlock/RTC = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_GENLOCK</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Horizontal sync start = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_HORIZ_SYNC_START</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Vertical blanking start = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_BLANKING_START</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Vertical blanking stop = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_BLANKING_STOP</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Chrominance processing control #1 and #2 = %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CHROMA_PROC_CTL_1</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CHROMA_PROC_CTL_2</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt reset register B = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INT_RESET_REG_B</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt enable register B = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INT_ENABLE_REG_B</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt configuration register B = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INTT_CONFIG_REG_B</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Video standard = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VIDEO_STD</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Chroma gain factor: Cb=0x%02x Cr=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CB_GAIN_FACT</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CR_GAIN_FACTOR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Macrovision on counter = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_MACROVISION_ON_CTR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Macrovision off counter = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_MACROVISION_OFF_CTR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: ITU-R BT.656.%d timing(TVP5150AM1 only)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_REV_SELECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Device ID = %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_MSB_DEV_ID</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_LSB_DEV_ID</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: ROM version = (hex) %02x.%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ROM_MAJOR_VER</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ROM_MINOR_VER</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Vertical line count = 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_LN_COUNT_MSB</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_LN_COUNT_LSB</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt status register B = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INT_STATUS_REG_B</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt active register B = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INT_ACTIVE_REG_B</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Status regs #1 to #5 = %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_STATUS_REG_1</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_STATUS_REG_2</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_STATUS_REG_3</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_STATUS_REG_4</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_STATUS_REG_5</span><span class="p">));</span>

	<span class="n">dump_reg_range</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Teletext filter 1&quot;</span><span class="p">,</span>   <span class="n">TVP5150_TELETEXT_FIL1_INI</span><span class="p">,</span>
			<span class="n">TVP5150_TELETEXT_FIL1_END</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">dump_reg_range</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Teletext filter 2&quot;</span><span class="p">,</span>   <span class="n">TVP5150_TELETEXT_FIL2_INI</span><span class="p">,</span>
			<span class="n">TVP5150_TELETEXT_FIL2_END</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Teletext filter enable = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_TELETEXT_FIL_ENA</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt status register A = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INT_STATUS_REG_A</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt enable register A = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INT_ENABLE_REG_A</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Interrupt configuration = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_INT_CONF</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: VDP status register = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VDP_STATUS_REG</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: FIFO word count = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FIFO_WORD_COUNT</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: FIFO interrupt threshold = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FIFO_INT_THRESHOLD</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: FIFO reset = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FIFO_RESET</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Line number interrupt = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_LINE_NUMBER_INT</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Pixel alignment register = 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_PIX_ALIGN_REG_HIGH</span><span class="p">),</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_PIX_ALIGN_REG_LOW</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: FIFO output control = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FIFO_OUT_CTRL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Full field enable = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FULL_FIELD_ENA</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tvp5150: Full field mode register = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FULL_FIELD_MODE_REG</span><span class="p">));</span>

	<span class="n">dump_reg_range</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;CC   data&quot;</span><span class="p">,</span>   <span class="n">TVP5150_CC_DATA_INI</span><span class="p">,</span>
			<span class="n">TVP5150_CC_DATA_END</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dump_reg_range</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;WSS  data&quot;</span><span class="p">,</span>   <span class="n">TVP5150_WSS_DATA_INI</span><span class="p">,</span>
			<span class="n">TVP5150_WSS_DATA_END</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dump_reg_range</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;VPS  data&quot;</span><span class="p">,</span>   <span class="n">TVP5150_VPS_DATA_INI</span><span class="p">,</span>
			<span class="n">TVP5150_VPS_DATA_END</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dump_reg_range</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;VITC data&quot;</span><span class="p">,</span>   <span class="n">TVP5150_VITC_DATA_INI</span><span class="p">,</span>
			<span class="n">TVP5150_VITC_DATA_END</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">dump_reg_range</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Line mode&quot;</span><span class="p">,</span>   <span class="n">TVP5150_LINE_MODE_INI</span><span class="p">,</span>
			<span class="n">TVP5150_LINE_MODE_END</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">			Basic functions</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tvp5150_selmux</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">opmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">TVP5150_BLACK_SCREEN</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">input</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TVP5150_COMPOSITE1</span>:
		<span class="n">input</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">TVP5150_COMPOSITE0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVP5150_SVIDEO</span>:
	<span class="nl">default:</span>
		<span class="n">input</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Selecting video route: route input=%i, output=%i &quot;</span>
			<span class="s">&quot;=&gt; tvp5150 input=%i, opmode=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">decoder</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">,</span>
			<span class="n">input</span><span class="p">,</span> <span class="n">opmode</span><span class="p">);</span>

	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_OP_MODE_CTL</span><span class="p">,</span> <span class="n">opmode</span><span class="p">);</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VD_IN_SRC_SEL_1</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

	<span class="cm">/* Svideo should enable YCrCb output and disable GPCL output</span>
<span class="cm">	 * For Composite and TV, it should be the reverse</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_MISC_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">TVP5150_SVIDEO</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_MISC_CTL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Default values as sugested at TVP5150AM1 datasheet */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp5150_init_default</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/* 0x00 */</span>
		<span class="n">TVP5150_VD_IN_SRC_SEL_1</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x01 */</span>
		<span class="n">TVP5150_ANAL_CHL_CTL</span><span class="p">,</span><span class="mh">0x15</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x02 */</span>
		<span class="n">TVP5150_OP_MODE_CTL</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x03 */</span>
		<span class="n">TVP5150_MISC_CTL</span><span class="p">,</span><span class="mh">0x01</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x06 */</span>
		<span class="n">TVP5150_COLOR_KIL_THSH_CTL</span><span class="p">,</span><span class="mh">0x10</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x07 */</span>
		<span class="n">TVP5150_LUMA_PROC_CTL_1</span><span class="p">,</span><span class="mh">0x60</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x08 */</span>
		<span class="n">TVP5150_LUMA_PROC_CTL_2</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x09 */</span>
		<span class="n">TVP5150_BRIGHT_CTL</span><span class="p">,</span><span class="mh">0x80</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x0a */</span>
		<span class="n">TVP5150_SATURATION_CTL</span><span class="p">,</span><span class="mh">0x80</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x0b */</span>
		<span class="n">TVP5150_HUE_CTL</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x0c */</span>
		<span class="n">TVP5150_CONTRAST_CTL</span><span class="p">,</span><span class="mh">0x80</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x0d */</span>
		<span class="n">TVP5150_DATA_RATE_SEL</span><span class="p">,</span><span class="mh">0x47</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x0e */</span>
		<span class="n">TVP5150_LUMA_PROC_CTL_3</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x0f */</span>
		<span class="n">TVP5150_CONF_SHARED_PIN</span><span class="p">,</span><span class="mh">0x08</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x11 */</span>
		<span class="n">TVP5150_ACT_VD_CROP_ST_MSB</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x12 */</span>
		<span class="n">TVP5150_ACT_VD_CROP_ST_LSB</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x13 */</span>
		<span class="n">TVP5150_ACT_VD_CROP_STP_MSB</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x14 */</span>
		<span class="n">TVP5150_ACT_VD_CROP_STP_LSB</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x15 */</span>
		<span class="n">TVP5150_GENLOCK</span><span class="p">,</span><span class="mh">0x01</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x16 */</span>
		<span class="n">TVP5150_HORIZ_SYNC_START</span><span class="p">,</span><span class="mh">0x80</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x18 */</span>
		<span class="n">TVP5150_VERT_BLANKING_START</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x19 */</span>
		<span class="n">TVP5150_VERT_BLANKING_STOP</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x1a */</span>
		<span class="n">TVP5150_CHROMA_PROC_CTL_1</span><span class="p">,</span><span class="mh">0x0c</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x1b */</span>
		<span class="n">TVP5150_CHROMA_PROC_CTL_2</span><span class="p">,</span><span class="mh">0x14</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x1c */</span>
		<span class="n">TVP5150_INT_RESET_REG_B</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x1d */</span>
		<span class="n">TVP5150_INT_ENABLE_REG_B</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x1e */</span>
		<span class="n">TVP5150_INTT_CONFIG_REG_B</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x28 */</span>
		<span class="n">TVP5150_VIDEO_STD</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x2e */</span>
		<span class="n">TVP5150_MACROVISION_ON_CTR</span><span class="p">,</span><span class="mh">0x0f</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0x2f */</span>
		<span class="n">TVP5150_MACROVISION_OFF_CTR</span><span class="p">,</span><span class="mh">0x01</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xbb */</span>
		<span class="n">TVP5150_TELETEXT_FIL_ENA</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xc0 */</span>
		<span class="n">TVP5150_INT_STATUS_REG_A</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xc1 */</span>
		<span class="n">TVP5150_INT_ENABLE_REG_A</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xc2 */</span>
		<span class="n">TVP5150_INT_CONF</span><span class="p">,</span><span class="mh">0x04</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xc8 */</span>
		<span class="n">TVP5150_FIFO_INT_THRESHOLD</span><span class="p">,</span><span class="mh">0x80</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xc9 */</span>
		<span class="n">TVP5150_FIFO_RESET</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xca */</span>
		<span class="n">TVP5150_LINE_NUMBER_INT</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xcb */</span>
		<span class="n">TVP5150_PIX_ALIGN_REG_LOW</span><span class="p">,</span><span class="mh">0x4e</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xcc */</span>
		<span class="n">TVP5150_PIX_ALIGN_REG_HIGH</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xcd */</span>
		<span class="n">TVP5150_FIFO_OUT_CTRL</span><span class="p">,</span><span class="mh">0x01</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xcf */</span>
		<span class="n">TVP5150_FULL_FIELD_ENA</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xd0 */</span>
		<span class="n">TVP5150_LINE_MODE_INI</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* 0xfc */</span>
		<span class="n">TVP5150_FULL_FIELD_MODE_REG</span><span class="p">,</span><span class="mh">0x7f</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end of data */</span>
		<span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Default values as sugested at TVP5150AM1 datasheet */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="n">tvp5150_init_enable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">TVP5150_CONF_SHARED_PIN</span><span class="p">,</span> <span class="mi">2</span>
	<span class="p">},{</span>	<span class="cm">/* Automatic offset and AGC enabled */</span>
		<span class="n">TVP5150_ANAL_CHL_CTL</span><span class="p">,</span> <span class="mh">0x15</span>
	<span class="p">},{</span>	<span class="cm">/* Activate YCrCb output 0x9 or 0xd ? */</span>
		<span class="n">TVP5150_MISC_CTL</span><span class="p">,</span> <span class="mh">0x6f</span>
	<span class="p">},{</span>	<span class="cm">/* Activates video std autodetection for all standards */</span>
		<span class="n">TVP5150_AUTOSW_MSK</span><span class="p">,</span> <span class="mh">0x0</span>
	<span class="p">},{</span>	<span class="cm">/* Default format: 0x47. For 4:2:2: 0x40 */</span>
		<span class="n">TVP5150_DATA_RATE_SEL</span><span class="p">,</span> <span class="mh">0x47</span>
	<span class="p">},{</span>
		<span class="n">TVP5150_CHROMA_PROC_CTL_1</span><span class="p">,</span> <span class="mh">0x0c</span>
	<span class="p">},{</span>
		<span class="n">TVP5150_CHROMA_PROC_CTL_2</span><span class="p">,</span> <span class="mh">0x54</span>
	<span class="p">},{</span>	<span class="cm">/* Non documented, but initialized on WinTV USB2 */</span>
		<span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x20</span>
	<span class="p">},{</span>
		<span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tvp5150_vbi_type</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vbi_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ini_line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end_line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">by_field</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_vbi_ram_value</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvp5150_vbi_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">values</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* This struct have the values for each supported VBI Standard</span>
<span class="cm"> * by</span>
<span class="cm"> tvp5150_vbi_types should follow the same order as vbi_ram_default</span>
<span class="cm"> * value 0 means rom position 0x10, value 1 means rom position 0x30</span>
<span class="cm"> * and so on. There are 16 possible locations from 0 to 15.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_vbi_ram_value</span> <span class="n">vbi_ram_default</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: Current api doesn&#39;t handle all VBI types, those not</span>
<span class="cm">	   yet supported are placed under #if 0 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{0x010, /* Teletext, SECAM, WST System A */</span>
<span class="c">		{V4L2_SLICED_TELETEXT_SECAM,6,23,1},</span>
<span class="c">		{ 0xaa, 0xaa, 0xff, 0xff, 0xe7, 0x2e, 0x20, 0x26,</span>
<span class="c">		  0xe6, 0xb4, 0x0e, 0x00, 0x00, 0x00, 0x10, 0x00 }</span>
<span class="c">	},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="mh">0x030</span><span class="p">,</span> <span class="cm">/* Teletext, PAL, WST System B */</span>
		<span class="p">{</span><span class="n">V4L2_SLICED_TELETEXT_B</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span>
		  <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
	<span class="p">},</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{0x050, /* Teletext, PAL, WST System C */</span>
<span class="c">		{V4L2_SLICED_TELETEXT_PAL_C,6,22,1},</span>
<span class="c">		{ 0xaa, 0xaa, 0xff, 0xff, 0xe7, 0x2e, 0x20, 0x22,</span>
<span class="c">		  0xa6, 0x98, 0x0d, 0x00, 0x00, 0x00, 0x10, 0x00 }</span>
<span class="c">	},</span>
<span class="c">	{0x070, /* Teletext, NTSC, WST System B */</span>
<span class="c">		{V4L2_SLICED_TELETEXT_NTSC_B,10,21,1},</span>
<span class="c">		{ 0xaa, 0xaa, 0xff, 0xff, 0x27, 0x2e, 0x20, 0x23,</span>
<span class="c">		  0x69, 0x93, 0x0d, 0x00, 0x00, 0x00, 0x10, 0x00 }</span>
<span class="c">	},</span>
<span class="c">	{0x090, /* Tetetext, NTSC NABTS System C */</span>
<span class="c">		{V4L2_SLICED_TELETEXT_NTSC_C,10,21,1},</span>
<span class="c">		{ 0xaa, 0xaa, 0xff, 0xff, 0xe7, 0x2e, 0x20, 0x22,</span>
<span class="c">		  0x69, 0x93, 0x0d, 0x00, 0x00, 0x00, 0x15, 0x00 }</span>
<span class="c">	},</span>
<span class="c">	{0x0b0, /* Teletext, NTSC-J, NABTS System D */</span>
<span class="c">		{V4L2_SLICED_TELETEXT_NTSC_D,10,21,1},</span>
<span class="c">		{ 0xaa, 0xaa, 0xff, 0xff, 0xa7, 0x2e, 0x20, 0x23,</span>
<span class="c">		  0x69, 0x93, 0x0d, 0x00, 0x00, 0x00, 0x10, 0x00 }</span>
<span class="c">	},</span>
<span class="c">	{0x0d0, /* Closed Caption, PAL/SECAM */</span>
<span class="c">		{V4L2_SLICED_CAPTION_625,22,22,1},</span>
<span class="c">		{ 0xaa, 0x2a, 0xff, 0x3f, 0x04, 0x51, 0x6e, 0x02,</span>
<span class="c">		  0xa6, 0x7b, 0x09, 0x00, 0x00, 0x00, 0x27, 0x00 }</span>
<span class="c">	},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="mh">0x0f0</span><span class="p">,</span> <span class="cm">/* Closed Caption, NTSC */</span>
		<span class="p">{</span><span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
		  <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span><span class="mh">0x110</span><span class="p">,</span> <span class="cm">/* Wide Screen Signal, PAL/SECAM */</span>
		<span class="p">{</span><span class="n">V4L2_SLICED_WSS_625</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span>
		  <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
	<span class="p">},</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{0x130, /* Wide Screen Signal, NTSC C */</span>
<span class="c">		{V4L2_SLICED_WSS_525,20,20,1},</span>
<span class="c">		{ 0x38, 0x00, 0x3f, 0x00, 0x00, 0x71, 0x6e, 0x43,</span>
<span class="c">		  0x69, 0x7c, 0x08, 0x00, 0x00, 0x00, 0x39, 0x00 }</span>
<span class="c">	},</span>
<span class="c">	{0x150, /* Vertical Interval Timecode (VITC), PAL/SECAM */</span>
<span class="c">		{V4l2_SLICED_VITC_625,6,22,0},</span>
<span class="c">		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x8f, 0x6d, 0x49,</span>
<span class="c">		  0xa6, 0x85, 0x08, 0x00, 0x00, 0x00, 0x4c, 0x00 }</span>
<span class="c">	},</span>
<span class="c">	{0x170, /* Vertical Interval Timecode (VITC), NTSC */</span>
<span class="c">		{V4l2_SLICED_VITC_525,10,20,0},</span>
<span class="c">		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x8f, 0x6d, 0x49,</span>
<span class="c">		  0x69, 0x94, 0x08, 0x00, 0x00, 0x00, 0x4c, 0x00 }</span>
<span class="c">	},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="mh">0x190</span><span class="p">,</span> <span class="cm">/* Video Program System (VPS), PAL */</span>
		<span class="p">{</span><span class="n">V4L2_SLICED_VPS</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span>
		  <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="cm">/* 0x1d0 User programmable */</span>

	<span class="cm">/* End of struct */</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_write_inittab</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_reg_value</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">regs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_vdp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_vbi_ram_value</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Disable Full Field */</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FULL_FIELD_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Before programming, Line mode should be at 0xff */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TVP5150_LINE_MODE_INI</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TVP5150_LINE_MODE_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* Load Ram Table */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CONF_RAM_ADDR_HIGH</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CONF_RAM_ADDR_LOW</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VDP_CONF_RAM_DATA</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">regs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fills VBI capabilities based on i2c_vbi_ram_value struct */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_g_sliced_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_sliced_vbi_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_vbi_ram_value</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vbi_ram_default</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;g_sliced_vbi_cap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">cap</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">ini_line</span><span class="p">;</span><span class="n">line</span><span class="o">&lt;=</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">end_line</span><span class="p">;</span><span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">line</span><span class="p">]</span> <span class="o">|=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">vbi_type</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">|=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">vbi_type</span><span class="p">;</span>

		<span class="n">regs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set vbi processing</span>
<span class="cm"> * type - one of tvp5150_vbi_types</span>
<span class="cm"> * line - line to gather data</span>
<span class="cm"> * fields: bit 0 field1, bit 1, field2</span>
<span class="cm"> * flags (default=0xf0) is a bitmask, were set means:</span>
<span class="cm"> *	bit 7: enable filtering null bytes on CC</span>
<span class="cm"> *	bit 6: send data also to FIFO</span>
<span class="cm"> *	bit 5: don&#39;t allow data with errors on FIFO</span>
<span class="cm"> *	bit 4: enable ECC when possible</span>
<span class="cm"> * pix_align = pix alignment:</span>
<span class="cm"> *	LSB = field1</span>
<span class="cm"> *	MSB = field2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_set_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_vbi_ram_value</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span><span class="n">u8</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">fields</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;VBI can&#39;t be configured without knowing number of lines</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t follow NTSC Line number convension */</span>
		<span class="n">line</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">&lt;</span><span class="mi">6</span><span class="o">||</span><span class="n">line</span><span class="o">&gt;</span><span class="mi">27</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">vbi_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">line</span><span class="o">&gt;=</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">ini_line</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">line</span><span class="o">&lt;=</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">end_line</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">type</span><span class="o">=</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">vbi_type</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">regs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">type</span><span class="o">=</span><span class="n">pos</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">=</span><span class="p">((</span><span class="n">line</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">TVP5150_LINE_MODE_INI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fields</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fields</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_get_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_vbi_ram_value</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;VBI can&#39;t be configured without knowing number of lines</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t follow NTSC Line number convension */</span>
		<span class="n">line</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="mi">27</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">line</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">TVP5150_LINE_MODE_INI</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">type</span><span class="p">.</span><span class="n">vbi_type</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">|=</span> <span class="n">regs</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">type</span><span class="p">.</span><span class="n">vbi_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_set_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">fmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">std</span><span class="p">;</span>

	<span class="cm">/* First tests should be against specific std */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">VIDEO_STD_AUTO_SWITCH_BIT</span><span class="p">;</span>	<span class="cm">/* Autodetect mode */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC_443</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">VIDEO_STD_NTSC_4_43_BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">VIDEO_STD_PAL_M_BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_N</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">VIDEO_STD_PAL_COMBINATION_N_BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Then, test against generic ones */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">VIDEO_STD_NTSC_MJ_BIT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">VIDEO_STD_PAL_BDGHIN_BIT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">VIDEO_STD_SECAM_BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Set video std register to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VIDEO_STD</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">==</span> <span class="n">std</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Change cropping height limits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">decoder</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_525_60</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">decoder</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_OTHERS</span><span class="p">;</span>


	<span class="k">return</span> <span class="n">tvp5150_set_std</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="cm">/* Initializes TVP5150 to its default values */</span>
	<span class="n">tvp5150_write_inittab</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">tvp5150_init_default</span><span class="p">);</span>

	<span class="cm">/* Initializes VDP registers */</span>
	<span class="n">tvp5150_vdp_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">vbi_ram_default</span><span class="p">);</span>

	<span class="cm">/* Selects decoder input */</span>
	<span class="n">tvp5150_selmux</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="cm">/* Initializes TVP5150 to stream enabled values */</span>
	<span class="n">tvp5150_write_inittab</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">tvp5150_init_enable</span><span class="p">);</span>

	<span class="cm">/* Initialize image preferences */</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>

	<span class="n">tvp5150_set_std</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_BRIGHT_CTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_CONTRAST_CTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_SATURATION_CTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_HUE_CTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">v4l2_std_id</span> <span class="nf">tvp5150_read_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_STATUS_REG_5</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="k">return</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="k">return</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="k">return</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="k">return</span> <span class="n">V4L2_STD_PAL_N</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x09</span>:
		<span class="k">return</span> <span class="n">V4L2_STD_NTSC_443</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb</span>:
		<span class="k">return</span> <span class="n">V4L2_STD_SECAM</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">V4L2_STD_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_enum_mbus_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_mbus_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tvp5150_reset</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;width = %d, height = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">rect</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hmax</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s left=%d, top=%d, width=%d, height=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* tvp5150 has some special limits */</span>
	<span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TVP5150_MAX_CROP_LEFT</span><span class="p">);</span>
	<span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			   <span class="n">TVP5150_H_MAX</span> <span class="o">-</span> <span class="n">TVP5150_MAX_CROP_LEFT</span> <span class="o">-</span> <span class="n">rect</span><span class="p">.</span><span class="n">left</span><span class="p">,</span>
			   <span class="n">TVP5150_H_MAX</span> <span class="o">-</span> <span class="n">rect</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
	<span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TVP5150_MAX_CROP_TOP</span><span class="p">);</span>

	<span class="cm">/* Calculate height based on current standard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">==</span> <span class="n">V4L2_STD_ALL</span><span class="p">)</span>
		<span class="n">std</span> <span class="o">=</span> <span class="n">tvp5150_read_std</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">std</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">hmax</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_525_60</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hmax</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_OTHERS</span><span class="p">;</span>

	<span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			    <span class="n">hmax</span> <span class="o">-</span> <span class="n">TVP5150_MAX_CROP_TOP</span> <span class="o">-</span> <span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">,</span>
			    <span class="n">hmax</span> <span class="o">-</span> <span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_BLANKING_START</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_BLANKING_STOP</span><span class="p">,</span>
		      <span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">hmax</span><span class="p">);</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_ST_MSB</span><span class="p">,</span>
		      <span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">&gt;&gt;</span> <span class="n">TVP5150_CROP_SHIFT</span><span class="p">);</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_ST_LSB</span><span class="p">,</span>
		      <span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TVP5150_CROP_SHIFT</span><span class="p">));</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_STP_MSB</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">TVP5150_MAX_CROP_LEFT</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		      <span class="n">TVP5150_CROP_SHIFT</span><span class="p">);</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ACT_VD_CROP_STP_LSB</span><span class="p">,</span>
		      <span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">TVP5150_MAX_CROP_LEFT</span><span class="p">);</span>

	<span class="n">decoder</span><span class="o">-&gt;</span><span class="n">rect</span> <span class="o">=</span> <span class="n">rect</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tvp5150</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span>	<span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tvp5150</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>			<span class="o">=</span> <span class="n">TVP5150_H_MAX</span><span class="p">;</span>

	<span class="cm">/* Calculate height based on current standard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">==</span> <span class="n">V4L2_STD_ALL</span><span class="p">)</span>
		<span class="n">std</span> <span class="o">=</span> <span class="n">tvp5150_read_std</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">std</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">norm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_525_60</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_OTHERS</span><span class="p">;</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span>			<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">			I2C Command</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_s_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">input</span><span class="p">,</span> <span class="n">u32</span> <span class="n">output</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">decoder</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">decoder</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">;</span>
	<span class="n">tvp5150_selmux</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_s_raw_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_vbi_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this is for capturing 36 raw vbi lines</span>
<span class="cm">	   if there&#39;s a way to cut off the beginning 2 vbi lines</span>
<span class="cm">	   with the tvp5150 then the vbi line count could be lowered</span>
<span class="cm">	   to 17 lines/field again, although I couldn&#39;t find a register</span>
<span class="cm">	   which could do that cropping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">sample_format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">)</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_LUMA_PROC_CTL_1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">18</span> <span class="o">&amp;&amp;</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">18</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_BLANKING_START</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_VERT_BLANKING_STOP</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_s_sliced_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">svbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svbi</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">svbi</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">svbi</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">tvp5150_set_vbi</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">vbi_ram_default</span><span class="p">,</span>
				       <span class="n">svbi</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Enables FIFO */</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FIFO_OUT_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Disables FIFO*/</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FIFO_OUT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Disable Full Field */</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_FULL_FIELD_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Disable Line modes */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TVP5150_LINE_MODE_INI</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TVP5150_LINE_MODE_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_g_sliced_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">svbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">svbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">svbi</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svbi</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">tvp5150_get_vbi</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">vbi_ram_default</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">svbi</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">svbi</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ROM_MAJOR_VER</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
	      <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ROM_MINOR_VER</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_chip_ident_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_IDENT_TVP5150</span><span class="p">,</span>
					  <span class="n">rev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>

	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">tvp5150_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">tvp5150_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">tvp5150_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">log_status</span> <span class="o">=</span> <span class="n">tvp5150_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_try_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queryctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querymenu</span> <span class="o">=</span> <span class="n">v4l2_subdev_querymenu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_std</span> <span class="o">=</span> <span class="n">tvp5150_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">tvp5150_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_chip_ident</span> <span class="o">=</span> <span class="n">tvp5150_g_chip_ident</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span> <span class="o">=</span> <span class="n">tvp5150_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span> <span class="o">=</span> <span class="n">tvp5150_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_tuner_ops</span> <span class="n">tvp5150_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_tuner</span> <span class="o">=</span> <span class="n">tvp5150_g_tuner</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">tvp5150_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_routing</span> <span class="o">=</span> <span class="n">tvp5150_s_routing</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp5150_enum_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp5150_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp5150_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_fmt</span> <span class="o">=</span> <span class="n">tvp5150_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_crop</span> <span class="o">=</span> <span class="n">tvp5150_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_crop</span> <span class="o">=</span> <span class="n">tvp5150_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cropcap</span> <span class="o">=</span> <span class="n">tvp5150_cropcap</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_vbi_ops</span> <span class="n">tvp5150_vbi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_sliced_vbi_cap</span> <span class="o">=</span> <span class="n">tvp5150_g_sliced_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_sliced_fmt</span> <span class="o">=</span> <span class="n">tvp5150_g_sliced_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_sliced_fmt</span> <span class="o">=</span> <span class="n">tvp5150_s_sliced_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_raw_fmt</span> <span class="o">=</span> <span class="n">tvp5150_s_raw_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">tvp5150_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp5150_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp5150_tuner_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp5150_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp5150_vbi_ops</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/****************************************************************************</span>
<span class="cm">			I2C Client &amp; Driver</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msb_id</span><span class="p">,</span> <span class="n">lsb_id</span><span class="p">,</span> <span class="n">msb_rom</span><span class="p">,</span> <span class="n">lsb_rom</span><span class="p">;</span>

	<span class="cm">/* Check if the adapter supports the needed features */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
	     <span class="n">I2C_FUNC_SMBUS_READ_BYTE</span> <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_WRITE_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">core</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tvp5150</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">core</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp5150_ops</span><span class="p">);</span>
	<span class="n">v4l_info</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;chip found @ 0x%02x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">msb_id</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_MSB_DEV_ID</span><span class="p">);</span>
	<span class="n">lsb_id</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_LSB_DEV_ID</span><span class="p">);</span>
	<span class="n">msb_rom</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ROM_MAJOR_VER</span><span class="p">);</span>
	<span class="n">lsb_rom</span> <span class="o">=</span> <span class="n">tvp5150_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_ROM_MINOR_VER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msb_rom</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">lsb_rom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Is TVP5150AM1 */</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tvp%02x%02xam1 detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msb_id</span><span class="p">,</span> <span class="n">lsb_id</span><span class="p">);</span>

		<span class="cm">/* ITU-T BT.656.4 timing */</span>
		<span class="n">tvp5150_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">TVP5150_REV_SELECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msb_rom</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">lsb_rom</span> <span class="o">==</span> <span class="mh">0x21</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Is TVP5150A */</span>
			<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tvp%02x%02xa detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msb_id</span><span class="p">,</span> <span class="n">lsb_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;*** unknown tvp%02x%02x chip detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">msb_id</span><span class="p">,</span> <span class="n">lsb_id</span><span class="p">);</span>
			<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;*** Rom ver is %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msb_rom</span><span class="p">,</span> <span class="n">lsb_rom</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">core</span><span class="o">-&gt;</span><span class="n">norm</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>	<span class="cm">/* Default is autodetect */</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">TVP5150_COMPOSITE1</span><span class="p">;</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp5150_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp5150_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp5150_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_SATURATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp5150_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_HUE</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>

	<span class="cm">/* Default is no cropping */</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tvp5150_read_std</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_525_60</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">TVP5150_V_MAX_OTHERS</span><span class="p">;</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">TVP5150_H_MAX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tvp5150_log_status</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvp5150_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tvp5150</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span>
		<span class="s">&quot;tvp5150.c: removing tvp5150 adapter on address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">to_tvp5150</span><span class="p">(</span><span class="n">sd</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tvp5150_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tvp5150&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tvp5150_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tvp5150_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;tvp5150&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tvp5150_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">tvp5150_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tvp5150_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">tvp5150_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
