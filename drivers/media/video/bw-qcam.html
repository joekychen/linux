<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › bw-qcam.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bw-qcam.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    QuickCam Driver For Video4Linux.</span>
<span class="cm"> *</span>
<span class="cm"> *	Video4Linux conversion work by Alan Cox.</span>
<span class="cm"> *	Parport compatibility by Phil Blundell.</span>
<span class="cm"> *	Busy loop avoidance by Mark Cooke.</span>
<span class="cm"> *</span>
<span class="cm"> *    Module parameters:</span>
<span class="cm"> *</span>
<span class="cm"> *	maxpoll=&lt;1 - 5000&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	  When polling the QuickCam for a response, busy-wait for a</span>
<span class="cm"> *	  maximum of this many loops. The default of 250 gives little</span>
<span class="cm"> *	  impact on interactive response.</span>
<span class="cm"> *</span>
<span class="cm"> *	  NOTE: If this parameter is set too high, the processor</span>
<span class="cm"> *		will busy wait until this loop times out, and then</span>
<span class="cm"> *		slowly poll for a further 5 seconds before failing</span>
<span class="cm"> *		the transaction. You have been warned.</span>
<span class="cm"> *</span>
<span class="cm"> *	yieldlines=&lt;1 - 250&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	  When acquiring a frame from the camera, the data gathering</span>
<span class="cm"> *	  loop will yield back to the scheduler after completing</span>
<span class="cm"> *	  this many lines. The default of 4 provides a trade-off</span>
<span class="cm"> *	  between increased frame acquisition time and impact on</span>
<span class="cm"> *	  interactive response.</span>
<span class="cm"> */</span>

<span class="cm">/* qcam-lib.c -- Library for programming with the Connectix QuickCam.</span>
<span class="cm"> * See the included documentation for usage instructions and details</span>
<span class="cm"> * of the protocol involved. */</span>


<span class="cm">/* Version 0.5, August 4, 1996 */</span>
<span class="cm">/* Version 0.7, August 27, 1996 */</span>
<span class="cm">/* Version 0.9, November 17, 1996 */</span>


<span class="cm">/******************************************************************</span>

<span class="cm">Copyright (C) 1996 by Scott Laird</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining</span>
<span class="cm">a copy of this software and associated documentation files (the</span>
<span class="cm">&quot;Software&quot;), to deal in the Software without restriction, including</span>
<span class="cm">without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="cm">distribute, sublicense, and/or sell copies of the Software, and to</span>
<span class="cm">permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm">the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be</span>
<span class="cm">included in all copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm">EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm">MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span>
<span class="cm">IN NO EVENT SHALL SCOTT LAIRD BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm">OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm">ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm">OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="cm">******************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/parport.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-fh.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>

<span class="cm">/* One from column A... */</span>
<span class="cp">#define QC_NOTSET 0</span>
<span class="cp">#define QC_UNIDIR 1</span>
<span class="cp">#define QC_BIDIR  2</span>
<span class="cp">#define QC_SERIAL 3</span>

<span class="cm">/* ... and one from column B */</span>
<span class="cp">#define QC_ANY          0x00</span>
<span class="cp">#define QC_FORCE_UNIDIR 0x10</span>
<span class="cp">#define QC_FORCE_BIDIR  0x20</span>
<span class="cp">#define QC_FORCE_SERIAL 0x30</span>
<span class="cm">/* in the port_mode member */</span>

<span class="cp">#define QC_MODE_MASK    0x07</span>
<span class="cp">#define QC_FORCE_MASK   0x70</span>

<span class="cp">#define MAX_HEIGHT 243</span>
<span class="cp">#define MAX_WIDTH 336</span>

<span class="cm">/* Bit fields for status flags */</span>
<span class="cp">#define QC_PARAM_CHANGE	0x01 </span><span class="cm">/* Camera status change has occurred */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">qcam</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">whitebal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transfer_scale</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saved_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">in_use</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxpoll</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>   <span class="cm">/* Maximum busy-loop count for qcam I/O */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yieldlines</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>  <span class="cm">/* Yield after this many during capture */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">force_init</span><span class="p">;</span>		<span class="cm">/* Whether to probe aggressively */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">maxpoll</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">yieldlines</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Set force_init=1 to avoid detection by polling status register and</span>
<span class="cm"> * immediately attempt to initialize qcam */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_init</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#define MAX_CAMS 4</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcams</span><span class="p">[</span><span class="n">MAX_CAMS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_cams</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">read_lpstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">read_lpdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">parport_read_data</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_lpdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">parport_write_data</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_lpcontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set bidirectional mode to reverse (data in) */</span>
		<span class="n">parport_data_reverse</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set bidirectional mode to forward (data out) */</span>
		<span class="n">parport_data_forward</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now issue the regular port command, but strip out the</span>
<span class="cm">	 * direction flag */</span>
	<span class="n">d</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
	<span class="n">parport_write_control</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* qc_waithand busy-waits for a handshake signal from the QuickCam.</span>
<span class="cm"> * Almost all communication with the camera requires handshaking. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qc_waithand</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">runs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">read_lpstatus</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* 1000 is enough spins on the I/O for all normal</span>
<span class="cm">			   cases, at that point we start to poll slowly</span>
<span class="cm">			   until the camera wakes up. However, we are</span>
<span class="cm">			   busy blocked until the camera responds, so</span>
<span class="cm">			   setting it lower is much better for interactive</span>
<span class="cm">			   response. */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">runs</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">maxpoll</span><span class="p">)</span>
				<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runs</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxpoll</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">))</span> <span class="cm">/* 5 seconds */</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(((</span><span class="n">status</span> <span class="o">=</span> <span class="n">read_lpstatus</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* 1000 is enough spins on the I/O for all normal</span>
<span class="cm">			   cases, at that point we start to poll slowly</span>
<span class="cm">			   until the camera wakes up. However, we are</span>
<span class="cm">			   busy blocked until the camera responds, so</span>
<span class="cm">			   setting it lower is much better for interactive</span>
<span class="cm">			   response. */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">runs</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">maxpoll</span><span class="p">)</span>
				<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runs</span><span class="o">++</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxpoll</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">))</span> <span class="cm">/* 5 seconds */</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Waithand2 is used when the qcam is in bidirectional mode, and the</span>
<span class="cm"> * handshaking signal is CamRdy2 (bit 0 of data reg) instead of CamRdy1</span>
<span class="cm"> * (bit 3 of status register).  It also returns the last value read,</span>
<span class="cm"> * since this data is useful. */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qc_waithand2</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">runs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_lpdata</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="cm">/* 1000 is enough spins on the I/O for all normal</span>
<span class="cm">		   cases, at that point we start to poll slowly</span>
<span class="cm">		   until the camera wakes up. However, we are</span>
<span class="cm">		   busy blocked until the camera responds, so</span>
<span class="cm">		   setting it lower is much better for interactive</span>
<span class="cm">		   response. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">runs</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">maxpoll</span><span class="p">)</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runs</span><span class="o">++</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxpoll</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">))</span> <span class="cm">/* 5 seconds */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* qc_command is probably a bit of a misnomer -- it&#39;s used to send</span>
<span class="cm"> * bytes *to* the camera.  Generally, these bytes are either commands</span>
<span class="cm"> * or arguments to commands, so the name fits, but it still bugs me a</span>
<span class="cm"> * bit.  See the documentation for a list of commands. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qc_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">write_lpdata</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">n1</span> <span class="o">=</span> <span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">);</span>
	<span class="n">n2</span> <span class="o">=</span> <span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">n1</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">n2</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qc_readparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">n1</span> <span class="o">=</span> <span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">);</span>
	<span class="n">n2</span> <span class="o">=</span> <span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">n1</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">n2</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Try to detect a QuickCam.  It appears to flash the upper 4 bits of</span>
<span class="cm">   the status register at 5-10 Hz.  This is only used in the autoprobe</span>
<span class="cm">   code.  Be aware that this isn&#39;t the way Connectix detects the</span>
<span class="cm">   camera (they send a reset and try to handshake), but this should be</span>
<span class="cm">   almost completely safe, while their method screws up my printer if</span>
<span class="cm">   I plug it in before the camera. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qc_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">lastreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force_init</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">lastreg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">read_lpstatus</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">read_lpstatus</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">lastreg</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lastreg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Force camera detection during testing. Sometimes the camera</span>
<span class="c">	   won&#39;t be flashing these bits. Possibly unloading the module</span>
<span class="c">	   in the middle of a grab? Or some timeout condition?</span>
<span class="c">	   I&#39;ve seen this parameter as low as 19 on my 450Mhz box - mpc */</span>
<span class="c">	printk(KERN_DEBUG &quot;Debugging: QCam detection counter &lt;30-200 counts as detected&gt;: %d\n&quot;, count);</span>
<span class="c">	return 1;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Be (even more) liberal in what you accept...  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* found */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No Quickcam found on port %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Quickcam detection counter: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* not found */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Decide which scan mode to use.  There&#39;s no real requirement that</span>
<span class="cm"> * the scanmode match the resolution in q-&gt;height and q-&gt; width -- the</span>
<span class="cm"> * camera takes the picture at the resolution specified in the</span>
<span class="cm"> * &quot;scanmode&quot; and then returns the image at the resolution specified</span>
<span class="cm"> * with the resolution commands.  If the scan is bigger than the</span>
<span class="cm"> * requested resolution, the upper-left hand corner of the scan is</span>
<span class="cm"> * returned.  If the scan is smaller, then the rest of the image</span>
<span class="cm"> * returned contains garbage. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qc_setscanmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_mode</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QC_BIDIR</span>:
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QC_NOTSET</span>:
	<span class="k">case</span> <span class="n">QC_UNIDIR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">old_mode</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">QC_PARAM_CHANGE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Reset the QuickCam.  This uses the same sequence the Windows</span>
<span class="cm"> * QuickPic program uses.  Someone with a bi-directional port should</span>
<span class="cm"> * check that bi-directional mode is detected right, and then</span>
<span class="cm"> * implement bi-directional mode in qc_readbyte(). */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_FORCE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QC_FORCE_UNIDIR</span>:
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">QC_UNIDIR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QC_FORCE_BIDIR</span>:
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">QC_BIDIR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QC_ANY</span>:
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">write_lpdata</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_lpdata</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x75</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">QC_BIDIR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">QC_UNIDIR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">);</span>
	<span class="n">qc_setscanmode</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>		<span class="cm">/* in case port_mode changed */</span>
<span class="p">}</span>



<span class="cm">/* Reset the QuickCam and program for brightness, contrast,</span>
<span class="cm"> * white-balance, and resolution. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qc_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val2</span><span class="p">;</span>

	<span class="n">qc_reset</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="cm">/* Set the brightness.  Yes, this is repetitive, but it works.</span>
<span class="cm">	 * Shorter versions seem to fail subtly.  Feel free to try :-). */</span>
	<span class="cm">/* I think the problem was in qc_command, not here -- bls */</span>

	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">;</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">QC_UNIDIR</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The normal &quot;transfers per line&quot; calculation doesn&#39;t seem to work</span>
<span class="cm">		   as expected here (and yet it works fine in qc_scan).  No idea</span>
<span class="cm">		   why this case is the odd man out.  Fortunately, Laird&#39;s original</span>
<span class="cm">		   working version gives me a good way to guess at working values.</span>
<span class="cm">		   -- bls */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">transfer_scale</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="p">(((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">QC_BIDIR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">24</span> <span class="o">:</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Setting top and left -- bls */</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">whitebal</span><span class="p">);</span>

	<span class="cm">/* Clear flag that we must update the grabbing parameters on the camera</span>
<span class="cm">	   before we grab the next frame */</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">QC_PARAM_CHANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Qc_readbytes reads some bytes from the QC and puts them in</span>
<span class="cm">   the supplied buffer.  It returns the number of bytes read,</span>
<span class="cm">   or -1 on error. */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qc_readbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hi2</span><span class="p">,</span> <span class="n">lo2</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QC_BIDIR</span>:		<span class="cm">/* Bi-directional Port */</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">qc_waithand2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_lpstatus</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
		<span class="n">lo2</span> <span class="o">=</span> <span class="p">(</span><span class="n">qc_waithand2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hi2</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_lpstatus</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo2</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lo2</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">hi2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi2</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo2</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lo2</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hi2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QC_UNIDIR</span>:	<span class="cm">/* Unidirectional Port */</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">);</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">saved_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">|</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">saved_bits</span><span class="p">;</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">saved_bits</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">saved_bits</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">hi</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* requests a scan from the camera.  It sends the correct instructions</span>
<span class="cm"> * to the camera and then reads back the correct number of bytes.  In</span>
<span class="cm"> * previous versions of this routine the return structure contained</span>
<span class="cm"> * the raw output from the camera, and there was a &#39;qc_convertscan&#39;</span>
<span class="cm"> * function that converted that to a useful format.  In version 0.3 I</span>
<span class="cm"> * rolled qc_convertscan into qc_scan and now I only return the</span>
<span class="cm"> * converted scan.  The format is just an one-dimensional array of</span>
<span class="cm"> * characters, one for each pixel, with 0=black up to n=white, where</span>
<span class="cm"> * n=2^(bit depth)-1.  Ask me for more details if you don&#39;t understand</span>
<span class="cm"> * this. */</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">qc_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">yield</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linestotrans</span><span class="p">,</span> <span class="n">transperline</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixels_per_line</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixels_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">got</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span>  <span class="n">shift</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">invert</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">QC_BIDIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>	<span class="cm">/* turn port around */</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
		<span class="n">qc_waithand</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* strange -- should be 15:63 below, but 4bpp is odd */</span>
	<span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">63</span><span class="p">;</span>

	<span class="n">linestotrans</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">;</span>
	<span class="n">pixels_per_line</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">;</span>
	<span class="n">transperline</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="n">divisor</span> <span class="o">=</span> <span class="p">(((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">QC_BIDIR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">24</span> <span class="o">:</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">;</span>
	<span class="n">transperline</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">transperline</span><span class="p">,</span> <span class="n">divisor</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yield</span> <span class="o">=</span> <span class="n">yieldlines</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">linestotrans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pixels_read</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">transperline</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">qc_readbytes</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pixels_read</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pixels_per_line</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">o</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* 4bpp is odd (again) -- inverter is 16, not 15, but output</span>
<span class="cm">					   must be 0-15 -- bls */</span>
					<span class="n">buffer</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">o</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">pixels_per_line</span> <span class="o">+</span> <span class="n">pixels_read</span> <span class="o">+</span> <span class="n">k</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u8</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">invert</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
					<span class="n">got</span><span class="o">++</span><span class="p">;</span>
					<span class="n">put_user</span><span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">o</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">pixels_read</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qc_readbytes</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>	<span class="cm">/* reset state machine */</span>

		<span class="cm">/* Grabbing an entire frame from the quickcam is a lengthy</span>
<span class="cm">		   process. We don&#39;t (usually) want to busy-block the</span>
<span class="cm">		   processor for the entire frame. yieldlines is a module</span>
<span class="cm">		   parameter. If we yield every line, the minimum frame</span>
<span class="cm">		   time will be 240 / 200 = 1.2 seconds. The compile-time</span>
<span class="cm">		   default is to yield every 4 lines. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">yield</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">yield</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">yieldlines</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">&amp;</span> <span class="n">QC_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">QC_BIDIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">write_lpcontrol</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">got</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Video4linux interfacing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">vcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Connectix B&amp;W Quickcam&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_READWRITE</span><span class="p">;</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">vcap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">|</span> <span class="n">V4L2_CAP_DEVICE_CAPS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Camera&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vin</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">audioset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">inp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">transfer_scale</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">V4L2_PIX_FMT_Y4</span> <span class="o">:</span> <span class="n">V4L2_PIX_FMT_Y6</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/* Just a guess */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">60</span> <span class="o">||</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">120</span> <span class="o">||</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">160</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">160</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_Y4</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_Y6</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_Y4</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/* Just a guess */</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">qcam_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">transfer_scale</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="mi">120</span><span class="p">)</span>
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">transfer_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">transfer_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_Y6</span><span class="p">)</span>
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">qc_setscanmode</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
	<span class="cm">/* We must update the camera before we grab. We could</span>
<span class="cm">	   just have changed the grab size */</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">QC_PARAM_CHANGE</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="s">&quot;4-Bit Monochrome&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_Y4</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="s">&quot;6-Bit Monochrome&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_Y6</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">},</span>
	<span class="p">};</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_enum_framesizes</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">v4l2_frmsizeenum</span> <span class="o">*</span><span class="n">fsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_frmsize_discrete</span> <span class="n">sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">80</span><span class="p">,</span>  <span class="mi">60</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">120</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">pixel_format</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_Y4</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fsize</span><span class="o">-&gt;</span><span class="n">pixel_format</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_Y6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMSIZE_TYPE_DISCRETE</span><span class="p">;</span>
	<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">discrete</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">[</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qcam_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">parport_claim_or_block</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">qc_reset</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>

	<span class="cm">/* Update the camera parameters if we need to */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">QC_PARAM_CHANGE</span><span class="p">)</span>
		<span class="n">qc_set</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">qc_capture</span><span class="p">(</span><span class="n">qcam</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qcam_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v4l2_ctrl_poll</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">wait</span><span class="p">)</span> <span class="o">|</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcam_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qcam</span><span class="p">,</span> <span class="n">hdl</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_GAMMA</span>:
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">whitebal</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qc_setscanmode</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">QC_PARAM_CHANGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">qcam_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">v4l2_fh_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">v4l2_fh_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">qcam_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">qcam_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">qcam_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>    		    <span class="o">=</span> <span class="n">qcam_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>      		    <span class="o">=</span> <span class="n">qcam_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>      		    <span class="o">=</span> <span class="n">qcam_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>   		    <span class="o">=</span> <span class="n">qcam_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> 	    <span class="o">=</span> <span class="n">qcam_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_framesizes</span>		    <span class="o">=</span> <span class="n">qcam_enum_framesizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> 		    <span class="o">=</span> <span class="n">qcam_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>  		    <span class="o">=</span> <span class="n">qcam_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>  	    <span class="o">=</span> <span class="n">qcam_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_log_status</span>		    <span class="o">=</span> <span class="n">v4l2_ctrl_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_subscribe_event</span>		    <span class="o">=</span> <span class="n">v4l2_ctrl_subscribe_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_unsubscribe_event</span>	    <span class="o">=</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">qcam_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">qcam_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Initialize the QuickCam driver control structure.  This is where</span>
<span class="cm"> * defaults are set for people who don&#39;t have a config file.*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="nf">qcam_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">;</span>

	<span class="n">qcam</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;bw-qcam%d&quot;</span><span class="p">,</span> <span class="n">num_cams</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Could not register v4l2_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">192</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_GAMMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">105</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">parport_register_device</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register for %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Connectix QuickCam&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam_fops</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qcam_ioctl_ops</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_USE_FH_PRIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release_empty</span><span class="p">;</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">qcam</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">QC_ANY</span> <span class="o">|</span> <span class="n">QC_NOTSET</span><span class="p">);</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">transfer_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">whitebal</span> <span class="o">=</span> <span class="mi">105</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">qcam</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">QC_PARAM_CHANGE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qcam</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qc_calibrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Bugfix by Hanno Mueller hmueller@kabel.de, Mai 21 96</span>
<span class="cm">	 *	The white balance is an individual value for each</span>
<span class="cm">	 *	quickcam.</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span>	<span class="cm">/* AutoAdjustOffset */</span>
	<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Dummy Parameter, ignored by the camera */</span>

	<span class="cm">/* GetOffset (33) will read 255 until autocalibration */</span>
	<span class="cm">/* is finished. After that, a value of 1-254 will be */</span>
	<span class="cm">/* returned. */</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">qc_command</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">33</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">qc_readparam</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">);</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">whitebal</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_bwqcam</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_cams</span> <span class="o">==</span> <span class="n">MAX_CAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Too many Quickcams (max %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MAX_CAMS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qcam</span> <span class="o">=</span> <span class="n">qcam_init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">parport_claim_or_block</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">qc_reset</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc_detect</span><span class="p">(</span><span class="n">qcam</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qc_calibrate</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>

	<span class="n">parport_release</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Connectix Quickcam on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="n">video_nr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qcams</span><span class="p">[</span><span class="n">num_cams</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">qcam</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_bwqcam</span><span class="p">(</span><span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The parport parameter controls which parports will be scanned.</span>
<span class="cm"> * Scanning all parports causes some printers to print a garbage page.</span>
<span class="cm"> *       -- March 14, 1999  Billy Donahue &lt;billy@escape.com&gt; */</span>
<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">parport</span><span class="p">[</span><span class="n">MAX_CAMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">parport</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">accept_bwqcam</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MODULE</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parport</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">parport</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* user gave parport parameters */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">MAX_CAMS</span> <span class="o">&amp;&amp;</span> <span class="n">parport</span><span class="p">[</span><span class="n">n</span><span class="p">];</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">parport</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">parport</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;bw-qcam: bad port specifier </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">parport</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bwqcam_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">accept_bwqcam</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">init_bwqcam</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bwqcam_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qcam</span> <span class="o">*</span><span class="n">qcam</span> <span class="o">=</span> <span class="n">qcams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qcam</span> <span class="o">&amp;&amp;</span> <span class="n">qcam</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qcams</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">close_bwqcam</span><span class="p">(</span><span class="n">qcam</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">parport_driver</span> <span class="n">bwqcam_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;bw-qcam&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>	<span class="o">=</span> <span class="n">bwqcam_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>	<span class="o">=</span> <span class="n">bwqcam_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_bw_qcams</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">parport_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bwqcam_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_bw_qcams</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MODULE</span>
	<span class="cm">/* Do some sanity checks on the module parameters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxpoll</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Connectix Quickcam max-poll was above 5000. Using 5000.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">maxpoll</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yieldlines</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Connectix Quickcam yieldlines was less than 1. Using 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">yieldlines</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">parport_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bwqcam_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_bw_qcams</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_bw_qcams</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.0.3&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
