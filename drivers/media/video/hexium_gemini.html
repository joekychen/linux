<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › hexium_gemini.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hexium_gemini.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    hexium_gemini.c - v4l2 driver for Hexium Gemini frame grabber cards</span>

<span class="cm">    Visit http://www.mihu.de/linux/saa7146/ and follow the link</span>
<span class="cm">    to &quot;hexium&quot; for further details about this card.</span>

<span class="cm">    Copyright (C) 2003 Michael Hunold &lt;michael@mihu.de&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define DEBUG_VARIABLE debug</span>

<span class="cp">#include &lt;media/saa7146_vv.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;debug verbosity&quot;</span><span class="p">);</span>

<span class="cm">/* global variables */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hexium_num</span><span class="p">;</span>

<span class="cp">#define HEXIUM_GEMINI			4</span>
<span class="cp">#define HEXIUM_GEMINI_DUAL		5</span>

<span class="cp">#define HEXIUM_INPUTS	9</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="n">hexium_inputs</span><span class="p">[</span><span class="n">HEXIUM_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;CVBS 1&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CVBS 2&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;CVBS 3&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;CVBS 4&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;CVBS 5&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;CVBS 6&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Y/C 1&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;Y/C 2&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;Y/C 3&quot;</span><span class="p">,</span>	<span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define HEXIUM_AUDIOS	0</span>

<span class="k">struct</span> <span class="n">hexium_data</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">adr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define HEXIUM_GEMINI_V_1_0		1</span>
<span class="cp">#define HEXIUM_GEMINI_DUAL_V_1_0	2</span>

<span class="k">struct</span> <span class="n">hexium</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">video_device</span>	<span class="o">*</span><span class="n">video_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>	<span class="n">i2c_adapter</span><span class="p">;</span>

	<span class="kt">int</span> 		<span class="n">cur_input</span><span class="p">;</span>	<span class="cm">/* current input */</span>
	<span class="n">v4l2_std_id</span> 	<span class="n">cur_std</span><span class="p">;</span>	<span class="cm">/* current standard */</span>
<span class="p">};</span>

<span class="cm">/* Samsung KS0127B decoder default registers */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">hexium_ks0127b</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span><span class="o">=</span><span class="p">{</span>
<span class="cm">/*00*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x2A</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span>
<span class="cm">/*08*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span>
<span class="cm">/*10*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xE4</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*18*/</span> <span class="mh">0x14</span><span class="p">,</span><span class="mh">0x9B</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFC</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span>
<span class="cm">/*20*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*28*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x2C</span><span class="p">,</span><span class="mh">0x9B</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*30*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span>
<span class="cm">/*38*/</span> <span class="mh">0x01</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x29</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*40*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*48*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*50*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*58*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*60*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*68*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*70*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*78*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*80*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*88*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*90*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*98*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*A0*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*A8*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*B0*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*B8*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*C0*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*C8*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*D0*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*D8*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*E0*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*E8*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*F0*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
<span class="cm">/*F8*/</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hexium_data</span> <span class="n">hexium_pal</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x52</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x2C</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x9B</span> <span class="p">},</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="mh">0xFF</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hexium_data</span> <span class="n">hexium_ntsc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x53</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x23</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="mh">0xFF</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hexium_data</span> <span class="n">hexium_secam</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x52</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x2C</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x9B</span> <span class="p">},</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="mh">0xFF</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hexium_data</span> <span class="n">hexium_input_select</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x61</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x65</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x62</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x66</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x68</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x69</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x6A</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* fixme: h_offset = 0 for Hexium Gemini *Dual*, which</span>
<span class="cm">   are currently *not* supported*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_standard</span> <span class="n">hexium_standards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;PAL&quot;</span><span class="p">,</span> 	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v_offset</span>	<span class="o">=</span> <span class="mi">28</span><span class="p">,</span>	<span class="p">.</span><span class="n">v_field</span> 	<span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
		<span class="p">.</span><span class="n">h_offset</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="p">.</span><span class="n">h_pixels</span> 	<span class="o">=</span> <span class="mi">680</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v_max_out</span>	<span class="o">=</span> <span class="mi">576</span><span class="p">,</span>	<span class="p">.</span><span class="n">h_max_out</span>	<span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;NTSC&quot;</span><span class="p">,</span> 	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v_offset</span>	<span class="o">=</span> <span class="mi">28</span><span class="p">,</span>	<span class="p">.</span><span class="n">v_field</span> 	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">h_offset</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="p">.</span><span class="n">h_pixels</span> 	<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v_max_out</span>	<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>	<span class="p">.</span><span class="n">h_max_out</span>	<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;SECAM&quot;</span><span class="p">,</span> 	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v_offset</span>	<span class="o">=</span> <span class="mi">28</span><span class="p">,</span>	<span class="p">.</span><span class="n">v_field</span> 	<span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
		<span class="p">.</span><span class="n">h_offset</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="p">.</span><span class="n">h_pixels</span> 	<span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v_max_out</span>	<span class="o">=</span> <span class="mi">576</span><span class="p">,</span>	<span class="p">.</span><span class="n">h_max_out</span>	<span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* bring hardware to a sane state. this has to be done, just in case someone</span>
<span class="cm">   wants to capture from this device before it has been properly initialized.</span>
<span class="cm">   the capture engine would badly fail, because no valid signal arrives on the</span>
<span class="cm">   saa7146, thus leading to timeouts and stuff. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexium_init_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">i2c_smbus_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEB_D</span><span class="p">(</span><span class="s">&quot;hexium_init_done called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* initialize the helper ics to useful values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hexium_ks0127b</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">hexium_ks0127b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">i2c_smbus_xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_SMBUS_WRITE</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">I2C_SMBUS_BYTE_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;hexium_init_done() failed for address 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexium_set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">i2c_smbus_data</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">DEB_D</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">data</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">hexium_input_select</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">byte</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">i2c_smbus_xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_SMBUS_WRITE</span><span class="p">,</span> <span class="n">hexium_input_select</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">adr</span><span class="p">,</span> <span class="n">I2C_SMBUS_BYTE_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexium_set_standard</span><span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hexium_data</span> <span class="o">*</span><span class="n">vdec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">i2c_smbus_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEB_D</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">vdec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">vdec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">byte</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">i2c_smbus_xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_SMBUS_WRITE</span><span class="p">,</span> <span class="n">vdec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adr</span><span class="p">,</span> <span class="n">I2C_SMBUS_BYTE_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;hexium_init_done: hexium_set_standard() failed for address 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEB_EE</span><span class="p">(</span><span class="s">&quot;VIDIOC_ENUMINPUT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">HEXIUM_INPUTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hexium_inputs</span><span class="p">[</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_input</span><span class="p">));</span>

	<span class="n">DEB_D</span><span class="p">(</span><span class="s">&quot;v4l2_ioctl: VIDIOC_ENUMINPUT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="p">)</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">;</span>

	<span class="n">DEB_D</span><span class="p">(</span><span class="s">&quot;VIDIOC_G_INPUT: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">input</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="p">)</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="n">DEB_EE</span><span class="p">(</span><span class="s">&quot;VIDIOC_S_INPUT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="n">HEXIUM_INPUTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">hexium_set_input</span><span class="p">(</span><span class="n">hexium</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_ext_vv</span> <span class="n">vv_data</span><span class="p">;</span>

<span class="cm">/* this function only gets called when the probing was successful */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexium_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_pci_extension_data</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DEB_EE</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">hexium</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">hexium</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;not enough kernel memory in hexium_attach()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="n">hexium</span><span class="p">;</span>

	<span class="cm">/* enable i2c-port pins */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_08</span> <span class="o">|</span> <span class="n">MASK_24</span> <span class="o">|</span> <span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">));</span>

	<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hexium gemini&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">saa7146_i2c_adapter_prepare</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="n">SAA7146_I2C_BUS_BIT_RATE_480</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB_S</span><span class="p">(</span><span class="s">&quot;cannot register i2c-device. skipping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hexium</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  set HWControl GPIO number 2 */</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>

	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_INIT</span><span class="p">,</span> <span class="mh">0x07000700</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span> <span class="o">|</span> <span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">));</span>

	<span class="cm">/* the rest */</span>
	<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hexium_init_done</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hexium_set_standard</span><span class="p">(</span><span class="n">hexium</span><span class="p">,</span> <span class="n">hexium_pal</span><span class="p">);</span>
	<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>

	<span class="n">hexium_set_input</span><span class="p">(</span><span class="n">hexium</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">saa7146_vv_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vv_data</span><span class="p">);</span>

	<span class="n">vv_data</span><span class="p">.</span><span class="n">vid_ops</span><span class="p">.</span><span class="n">vidioc_enum_input</span> <span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">;</span>
	<span class="n">vv_data</span><span class="p">.</span><span class="n">vid_ops</span><span class="p">.</span><span class="n">vidioc_g_input</span> <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">;</span>
	<span class="n">vv_data</span><span class="p">.</span><span class="n">vid_ops</span><span class="p">.</span><span class="n">vidioc_s_input</span> <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7146_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hexium gemini&quot;</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register capture v4l2 device. skipping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;found &#39;hexium gemini&#39; frame grabber-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hexium_num</span><span class="p">);</span>
	<span class="n">hexium_num</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexium_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="n">DEB_EE</span><span class="p">(</span><span class="s">&quot;dev:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">saa7146_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7146_vv_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hexium_num</span><span class="o">--</span><span class="p">;</span>

	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hexium</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">std_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_standard</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="n">hexium</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hexium</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_PAL</span> <span class="o">==</span> <span class="n">std</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hexium_set_standard</span><span class="p">(</span><span class="n">hexium</span><span class="p">,</span> <span class="n">hexium_pal</span><span class="p">);</span>
		<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_NTSC</span> <span class="o">==</span> <span class="n">std</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hexium_set_standard</span><span class="p">(</span><span class="n">hexium</span><span class="p">,</span> <span class="n">hexium_ntsc</span><span class="p">);</span>
		<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_SECAM</span> <span class="o">==</span> <span class="n">std</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hexium_set_standard</span><span class="p">(</span><span class="n">hexium</span><span class="p">,</span> <span class="n">hexium_secam</span><span class="p">);</span>
		<span class="n">hexium</span><span class="o">-&gt;</span><span class="n">cur_std</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">hexium_extension</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_pci_extension_data</span> <span class="n">hexium_gemini_4bnc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="s">&quot;Hexium Gemini (4 BNC)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hexium_extension</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_pci_extension_data</span> <span class="n">hexium_gemini_dual_4bnc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="s">&quot;Hexium Gemini Dual (4 BNC)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hexium_extension</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_PHILIPS</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7146</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x17c8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2401</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hexium_gemini_4bnc</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_PHILIPS</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7146</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x17c8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2402</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hexium_gemini_dual_4bnc</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_ext_vv</span> <span class="n">vv_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">HEXIUM_INPUTS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hexium_standards</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">num_stds</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hexium_standards</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_standard</span><span class="p">),</span>
	<span class="p">.</span><span class="n">std_callback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">std_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">hexium_extension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hexium gemini&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SAA7146_USE_I2C_IRQ</span><span class="p">,</span>

	<span class="p">.</span><span class="n">pci_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">hexium_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">hexium_detach</span><span class="p">,</span>

	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hexium_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">saa7146_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium_extension</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEB_S</span><span class="p">(</span><span class="s">&quot;failed to register extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hexium_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa7146_unregister_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hexium_extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hexium_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hexium_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;video4linux-2 driver for Hexium Gemini frame grabber cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Michael Hunold &lt;michael@mihu.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
