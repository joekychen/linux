<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx23885 › cx23885-input.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx23885-input.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for the Conexant CX23885/7/8 PCIe bridge</span>
<span class="cm"> *</span>
<span class="cm"> *  Infrared remote control input device</span>
<span class="cm"> *</span>
<span class="cm"> *  Most of this file is</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2009  Andy Walls &lt;awalls@md.metrocast.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  However, the cx23885_input_{init,fini} functions contained herein are</span>
<span class="cm"> *  derived from Linux kernel files linux/media/video/.../...-input.c marked as:</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2008 &lt;srinivasa.deevi at conexant dot com&gt;</span>
<span class="cm"> *  Copyright (C) 2005 Ludovico Cavedon &lt;cavedon@sssup.it&gt;</span>
<span class="cm"> *		       Markus Rechberger &lt;mrechberger@gmail.com&gt;</span>
<span class="cm"> *		       Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>
<span class="cm"> *		       Sascha Sommer &lt;saschasommer@freenet.de&gt;</span>
<span class="cm"> *  Copyright (C) 2004, 2005 Chris Pascoe</span>
<span class="cm"> *  Copyright (C) 2003, 2004 Gerd Knorr</span>
<span class="cm"> *  Copyright (C) 2003 Pavel Machek</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version 2</span>
<span class="cm"> *  of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> *  02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>

<span class="cp">#include &quot;cx23885.h&quot;</span>

<span class="cp">#define MODULE_NAME &quot;cx23885&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_input_process_measurements</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">bool</span> <span class="n">overrun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_kernel_ir</span> <span class="o">*</span><span class="n">kernel_ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span><span class="p">;</span>

	<span class="kt">ssize_t</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">handle</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ir_raw_event</span> <span class="n">ir_core_event</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_read</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ir_core_event</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">ir_core_event</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ir_raw_event</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ir_raw_event_store</span><span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">ir_core_event</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overrun</span><span class="p">)</span>
		<span class="n">ir_raw_event_reset</span><span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="p">)</span>
		<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_input_rx_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_ir_parameters</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">overrun</span><span class="p">,</span> <span class="n">data_available</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">events</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1270</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1850</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1290</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_TEVII_S470</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1250</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The only boards we handle right now.  However other boards</span>
<span class="cm">		 * using the CX2388x integrated IR controller should be similar</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">overrun</span> <span class="o">=</span> <span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_SUBDEV_IR_RX_SW_FIFO_OVERRUN</span> <span class="o">|</span>
			    <span class="n">V4L2_SUBDEV_IR_RX_HW_FIFO_OVERRUN</span><span class="p">);</span>

	<span class="n">data_available</span> <span class="o">=</span> <span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_SUBDEV_IR_RX_END_OF_RX_DETECTED</span> <span class="o">|</span>
				   <span class="n">V4L2_SUBDEV_IR_RX_FIFO_SERVICE_REQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overrun</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If there was a FIFO overrun, stop the device */</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_g_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
		<span class="n">params</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* Mitigate race with cx23885_input_ir_stop() */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_input_stopping</span><span class="p">);</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_s_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_available</span><span class="p">)</span>
		<span class="n">cx23885_input_process_measurements</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">overrun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overrun</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If there was a FIFO overrun, clear &amp; restart the device */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Mitigate race with cx23885_input_ir_stop() */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_input_stopping</span><span class="p">);</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_s_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_input_ir_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_ir_parameters</span> <span class="n">params</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_input_stopping</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_g_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1270</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1850</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1290</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1250</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The IR controller on this board only returns pulse widths.</span>
<span class="cm">		 * Any other mode setting will fail to set up the device.</span>
<span class="cm">		*/</span>
		<span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_SUBDEV_IR_MODE_PULSE_WIDTH</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">interrupt_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Setup for baseband compatible with both RC-5 and RC-6A */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* RC-5:  2,222,222 ns = 1/36 kHz * 32 cycles * 2 marks * 1.25*/</span>
		<span class="cm">/* RC-6A: 3,333,333 ns = 1/36 kHz * 16 cycles * 6 marks * 1.25*/</span>
		<span class="n">params</span><span class="p">.</span><span class="n">max_pulse_width</span> <span class="o">=</span> <span class="mi">3333333</span><span class="p">;</span> <span class="cm">/* ns */</span>
		<span class="cm">/* RC-5:    666,667 ns = 1/36 kHz * 32 cycles * 1 mark * 0.75 */</span>
		<span class="cm">/* RC-6A:   333,333 ns = 1/36 kHz * 16 cycles * 1 mark * 0.75 */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">noise_filter_min_width</span> <span class="o">=</span> <span class="mi">333333</span><span class="p">;</span> <span class="cm">/* ns */</span>
		<span class="cm">/*</span>
<span class="cm">		 * This board has inverted receive sense:</span>
<span class="cm">		 * mark is received as low logic level;</span>
<span class="cm">		 * falling edges are detected as rising edges; etc.</span>
<span class="cm">		 */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">invert_level</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_TEVII_S470</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The IR controller on this board only returns pulse widths.</span>
<span class="cm">		 * Any other mode setting will fail to set up the device.</span>
<span class="cm">		 */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_SUBDEV_IR_MODE_PULSE_WIDTH</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">interrupt_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Setup for a standard NEC protocol */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">carrier_freq</span> <span class="o">=</span> <span class="mi">37917</span><span class="p">;</span> <span class="cm">/* Hz, 455 kHz/12 for NEC */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">carrier_range_lower</span> <span class="o">=</span> <span class="mi">33000</span><span class="p">;</span> <span class="cm">/* Hz */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">carrier_range_upper</span> <span class="o">=</span> <span class="mi">43000</span><span class="p">;</span> <span class="cm">/* Hz */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">duty_cycle</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span> <span class="cm">/* percent, 33 percent for NEC */</span>

		<span class="cm">/*</span>
<span class="cm">		 * NEC max pulse width: (64/3)/(455 kHz/12) * 16 nec_units</span>
<span class="cm">		 * (64/3)/(455 kHz/12) * 16 nec_units * 1.375 = 12378022 ns</span>
<span class="cm">		 */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">max_pulse_width</span> <span class="o">=</span> <span class="mi">12378022</span><span class="p">;</span> <span class="cm">/* ns */</span>

		<span class="cm">/*</span>
<span class="cm">		 * NEC noise filter min width: (64/3)/(455 kHz/12) * 1 nec_unit</span>
<span class="cm">		 * (64/3)/(455 kHz/12) * 1 nec_units * 0.625 = 351648 ns</span>
<span class="cm">		 */</span>
		<span class="n">params</span><span class="p">.</span><span class="n">noise_filter_min_width</span> <span class="o">=</span> <span class="mi">351648</span><span class="p">;</span> <span class="cm">/* ns */</span>

		<span class="n">params</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">invert_level</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_s_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_input_ir_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_kernel_ir</span> <span class="o">*</span><span class="n">kernel_ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cx23885_input_ir_start</span><span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_input_ir_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_ir_parameters</span> <span class="n">params</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop the sd_ir subdevice from generating notifications and</span>
<span class="cm">	 * scheduling work.</span>
<span class="cm">	 * It is shutdown this way in order to mitigate a race with</span>
<span class="cm">	 * cx23885_input_rx_work_handler() in the overrun case, which could</span>
<span class="cm">	 * re-enable the subdevice.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_input_stopping</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_g_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">shutdown</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">interrupt_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_s_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">rx_g_parameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx25840_work</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_rx_work</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_tx_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_input_ir_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_kernel_ir</span> <span class="o">*</span><span class="n">kernel_ir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cx23885_input_ir_stop</span><span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx23885_input_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_kernel_ir</span> <span class="o">*</span><span class="n">kernel_ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rc_map</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">rc_driver_type</span> <span class="n">driver_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">allowed_protos</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the IR device (hardware registers, chip, GPIO lines, etc.) isn&#39;t</span>
<span class="cm">	 * encapsulated in a v4l2_subdev, then I&#39;m not going to deal with it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1270</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1850</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1290</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_HAUPPAUGE_HVR1250</span>:
		<span class="cm">/* Integrated CX2388[58] IR controller */</span>
		<span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">;</span>
		<span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_ALL</span><span class="p">;</span>
		<span class="cm">/* The grey Hauppauge RC-5 remote */</span>
		<span class="n">rc_map</span> <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_TEVII_S470</span>:
		<span class="cm">/* Integrated CX23885 IR controller */</span>
		<span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">;</span>
		<span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_ALL</span><span class="p">;</span>
		<span class="cm">/* A guess at the remote */</span>
		<span class="n">rc_map</span> <span class="o">=</span> <span class="n">RC_MAP_TEVII_NEC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* cx23885 board instance kernel IR state */</span>
	<span class="n">kernel_ir</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_kernel_ir</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_ir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;cx23885 IR (%s)&quot;</span><span class="p">,</span>
				    <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;pci-%s/ir0&quot;</span><span class="p">,</span>
				    <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>

	<span class="cm">/* input device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_PCI</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">driver_type</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">allowed_protos</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">kernel_ir</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">cx23885_input_ir_open</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">cx23885_input_ir_close</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">rc_map</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">;</span>

	<span class="cm">/* Go */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span> <span class="o">=</span> <span class="n">kernel_ir</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_stop</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_stop:</span>
	<span class="n">cx23885_input_ir_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="nl">err_out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kernel_ir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_input_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Always stop the IR hardware from generating interrupts */</span>
	<span class="n">cx23885_input_ir_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">kernel_ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
