<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx23885 › cimax2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cimax2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cimax2.c</span>
<span class="cm"> *</span>
<span class="cm"> * CIMax2(R) SP2 driver in conjunction with NetUp Dual DVB-S2 CI card</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 NetUP Inc.</span>
<span class="cm"> * Copyright (C) 2009 Igor M. Liplianin &lt;liplianin@netup.ru&gt;</span>
<span class="cm"> * Copyright (C) 2009 Abylay Ospan &lt;aospan@netup.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;cx23885.h&quot;</span>
<span class="cp">#include &quot;dvb_ca_en50221.h&quot;</span>
<span class="cm">/**** Bit definitions for MC417_RWD and MC417_OEN registers  ***</span>
<span class="cm">  bits 31-16</span>
<span class="cm">+-----------+</span>
<span class="cm">| Reserved  |</span>
<span class="cm">+-----------+</span>
<span class="cm">  bit 15  bit 14  bit 13 bit 12  bit 11  bit 10  bit 9   bit 8</span>
<span class="cm">+-------+-------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm">|  WR#  |  RD#  |       |  ACK# |  ADHI |  ADLO |  CS1# |  CS0# |</span>
<span class="cm">+-------+-------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm"> bit 7   bit 6   bit 5   bit 4   bit 3   bit 2   bit 1   bit 0</span>
<span class="cm">+-------+-------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm">|  DATA7|  DATA6|  DATA5|  DATA4|  DATA3|  DATA2|  DATA1|  DATA0|</span>
<span class="cm">+-------+-------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm">***/</span>
<span class="cm">/* MC417 */</span>
<span class="cp">#define NETUP_DATA		0x000000ff</span>
<span class="cp">#define NETUP_WR		0x00008000</span>
<span class="cp">#define NETUP_RD		0x00004000</span>
<span class="cp">#define NETUP_ACK		0x00001000</span>
<span class="cp">#define NETUP_ADHI		0x00000800</span>
<span class="cp">#define NETUP_ADLO		0x00000400</span>
<span class="cp">#define NETUP_CS1		0x00000200</span>
<span class="cp">#define NETUP_CS0		0x00000100</span>
<span class="cp">#define NETUP_EN_ALL		0x00001000</span>
<span class="cp">#define NETUP_CTRL_OFF		(NETUP_CS1 | NETUP_CS0 | NETUP_WR | NETUP_RD)</span>
<span class="cp">#define NETUP_CI_CTL		0x04</span>
<span class="cp">#define NETUP_CI_RD		1</span>

<span class="cp">#define NETUP_IRQ_DETAM 	0x1</span>
<span class="cp">#define NETUP_IRQ_IRQAM		0x4</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ci_dbg</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ci_dbg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ci_dbg</span><span class="p">,</span> <span class="s">&quot;Enable CI debugging&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ci_irq_enable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ci_irq_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ci_irq_enable</span><span class="p">,</span> <span class="s">&quot;Enable IRQ from CAM&quot;</span><span class="p">);</span>

<span class="cp">#define ci_dbg_print(args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (ci_dbg) \</span>
<span class="cp">			printk(KERN_DEBUG args); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define ci_irq_flags() (ci_irq_enable ? NETUP_IRQ_IRQAM : 0)</span>

<span class="cm">/* stores all private variables for communication with CI */</span>
<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="n">ca</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">ca_mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ci_i2c_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_irq_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_ci_flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_status_checked_time</span><span class="p">;</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">netup_read_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="n">len</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: i2c read error, Reg = 0x%02x, Status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: i2c read Addr=0x%04x, Reg = 0x%02x, data = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_write_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="p">};</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: i2c write error, Reg=[0x%02x], Status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_get_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="n">NETUP_ACK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cx_set</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="n">NETUP_CTRL_OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mem</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_op_cam</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">flag</span><span class="p">,</span> <span class="n">u8</span> <span class="n">read</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">en50221</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">store</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_ci_flag</span> <span class="o">!=</span> <span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">netup_read_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">store</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">store</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0c</span><span class="p">;</span>
		<span class="n">store</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">store</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_ci_flag</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>

	<span class="cm">/* write addr */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MC417_OEN</span><span class="p">,</span> <span class="n">NETUP_EN_ALL</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="n">NETUP_CTRL_OFF</span> <span class="o">|</span>
				<span class="n">NETUP_ADLO</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">addr</span><span class="p">));</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="n">NETUP_ADLO</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="n">NETUP_CTRL_OFF</span> <span class="o">|</span>
				<span class="n">NETUP_ADHI</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="n">NETUP_ADHI</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* data in */</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">MC417_OEN</span><span class="p">,</span> <span class="n">NETUP_EN_ALL</span> <span class="o">|</span> <span class="n">NETUP_DATA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* data out */</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="n">NETUP_CTRL_OFF</span> <span class="o">|</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* choose chip */</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="n">NETUP_CS0</span> <span class="o">:</span> <span class="n">NETUP_CS1</span><span class="p">);</span>
	<span class="cm">/* read/write */</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">?</span> <span class="n">NETUP_RD</span> <span class="o">:</span> <span class="n">NETUP_WR</span><span class="p">);</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">netup_ci_get_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>

	<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: %s: chipaddr=[0x%x] addr=[0x%02x], %s=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			<span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">NETUP_CI_CTL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ctl&quot;</span> <span class="o">:</span> <span class="s">&quot;mem&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">?</span> <span class="n">mem</span> <span class="o">:</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mem</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_read_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netup_ci_op_cam</span><span class="p">(</span><span class="n">en50221</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NETUP_CI_RD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_write_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netup_ci_op_cam</span><span class="p">(</span><span class="n">en50221</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_read_cam_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netup_ci_op_cam</span><span class="p">(</span><span class="n">en50221</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">NETUP_CI_CTL</span><span class="p">,</span>
							<span class="n">NETUP_CI_RD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_write_cam_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
							<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netup_ci_op_cam</span><span class="p">(</span><span class="n">en50221</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">NETUP_CI_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">en50221</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span> <span class="o">=</span>  <span class="mh">0x80</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">dvb_ca_en50221_camready_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_slot_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* not implemented */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_set_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="n">u8</span> <span class="n">irq_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">en50221</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_mode</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_irq_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: chipaddr=[0x%x] setting ci IRQ to [0x%x] </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span> <span class="n">irq_mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
							<span class="mh">0x1b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_irq_mode</span> <span class="o">=</span> <span class="n">irq_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_slot_ts_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">en50221</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">netup_read_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">|=</span> <span class="mh">0x60</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* work handler */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netup_read_ci_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netup_ci_state</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* CAM module IRQ processing. fast operation */</span>
	<span class="n">dvb_ca_en50221_frda_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CAM module INSERT/REMOVE processing. slow operation because of i2c</span>
<span class="cm">	 * transfers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">next_status_checked_time</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">netup_read_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">33</span><span class="p">);</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">next_status_checked_time</span> <span class="o">=</span> <span class="n">jiffies</span>
			<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: Slot Status Addr=[0x%04x], &quot;</span>
				<span class="s">&quot;Reg=[0x%02x], data=%02x, &quot;</span>
				<span class="s">&quot;TS config = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span> <span class="o">|</span>
				<span class="n">DVB_CA_EN50221_POLL_CAM_READY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* CI irq handler */</span>
<span class="kt">int</span> <span class="nf">netup_ci_slot_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pci_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_MSK_GPIO0</span> <span class="o">|</span> <span class="n">PCI_MSK_GPIO1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_GPIO0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_priv</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: Wakeup CI0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_GPIO1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts2</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_priv</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: Wakeup CI1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_poll_ci_slot_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">en50221</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">en50221</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">netup_ci_set_irq</span><span class="p">(</span><span class="n">en50221</span><span class="p">,</span> <span class="n">open</span> <span class="o">?</span> <span class="p">(</span><span class="n">NETUP_IRQ_DETAM</span> <span class="o">|</span> <span class="n">ci_irq_flags</span><span class="p">())</span>
			<span class="o">:</span> <span class="n">NETUP_IRQ_DETAM</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netup_ci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cimax_init</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* module A control*/</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select mask high A */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select mask low A */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select pattern high A */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select pattern low A */</span>
		<span class="mh">0x44</span><span class="p">,</span> <span class="cm">/* memory access time A */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* invert input A */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* RFU */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* RFU */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* module B control*/</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select mask high B */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select mask low B */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select pattern high B */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select pattern low B */</span>
		<span class="mh">0x44</span><span class="p">,</span> <span class="cm">/* memory access time B */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* invert input B */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* RFU */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* RFU */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select mask high Ext */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select mask low Ext */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select pattern high Ext */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* auto select pattern low Ext */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* RFU */</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* destination - module A */</span>
		<span class="mh">0x01</span><span class="p">,</span> <span class="cm">/* power on (use it like store place) */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* RFU */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* int status read only */</span>
		<span class="n">ci_irq_flags</span><span class="p">()</span> <span class="o">|</span> <span class="n">NETUP_IRQ_DETAM</span><span class="p">,</span> <span class="cm">/* DETAM, IRQAM unmasked */</span>
		<span class="mh">0x05</span><span class="p">,</span> <span class="cm">/* EXTINT=active-high, INT=push-pull */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* USCG1 */</span>
		<span class="mh">0x04</span><span class="p">,</span> <span class="cm">/* ack active low */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* LOCK = 0 */</span>
		<span class="mh">0x33</span><span class="p">,</span> <span class="cm">/* serial mode, rising in, rising out, MSB first*/</span>
		<span class="mh">0x31</span><span class="p">,</span> <span class="cm">/* synchronization */</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netup_ci_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: Unable create CI structure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_attribute_mem</span> <span class="o">=</span> <span class="n">netup_ci_read_attribute_mem</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_attribute_mem</span> <span class="o">=</span> <span class="n">netup_ci_write_attribute_mem</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_cam_control</span> <span class="o">=</span> <span class="n">netup_ci_read_cam_ctl</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_cam_control</span> <span class="o">=</span> <span class="n">netup_ci_write_cam_ctl</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">netup_ci_slot_reset</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_shutdown</span> <span class="o">=</span> <span class="n">netup_ci_slot_shutdown</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_ts_enable</span> <span class="o">=</span> <span class="n">netup_ci_slot_ts_ctl</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">poll_slot_status</span> <span class="o">=</span> <span class="n">netup_poll_ci_slot_status</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_irq_mode</span> <span class="o">=</span> <span class="n">ci_irq_flags</span><span class="p">()</span> <span class="o">|</span> <span class="n">NETUP_IRQ_DETAM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cimax_init</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">34</span><span class="p">);</span>
	<span class="cm">/* lock registers */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
						<span class="mh">0x1f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cimax_init</span><span class="p">[</span><span class="mh">0x18</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* power on slots */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">netup_write_i2c</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ci_i2c_addr</span><span class="p">,</span>
						<span class="mh">0x18</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cimax_init</span><span class="p">[</span><span class="mh">0x18</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">frontends</span><span class="p">.</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span>
				   <span class="cm">/* flags */</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="cm">/* n_slots */</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">netup_read_ci_status</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: CI initialized!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">ci_dbg_print</span><span class="p">(</span><span class="s">&quot;%s: Cannot initialize CI: Error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">netup_ci_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netup_ci_state</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dvb_ca_en50221_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
