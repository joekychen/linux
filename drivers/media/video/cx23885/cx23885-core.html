<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx23885 › cx23885-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx23885-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for the Conexant CX23885 PCIe bridge</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2006 Steven Toth &lt;stoth@linuxtv.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cp">#include &quot;cx23885.h&quot;</span>
<span class="cp">#include &quot;cimax2.h&quot;</span>
<span class="cp">#include &quot;altera-ci.h&quot;</span>
<span class="cp">#include &quot;cx23888-ir.h&quot;</span>
<span class="cp">#include &quot;cx23885-ir.h&quot;</span>
<span class="cp">#include &quot;cx23885-av.h&quot;</span>
<span class="cp">#include &quot;cx23885-input.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for cx23885 based TV cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steven Toth &lt;stoth@linuxtv.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">CX23885_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">card</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">CX23885_MAXBOARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">UNSET</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>  <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;card type&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(level, fmt, arg...)\</span>
<span class="cp">	do { if (debug &gt;= level)\</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s: &quot; fmt, dev-&gt;name, ## arg);\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cx23885_devcount</span><span class="p">;</span>

<span class="cp">#define NO_SYNC_LINE (-1U)</span>

<span class="cm">/* FIXME, these allocations will change when</span>
<span class="cm"> * analog arrives. The be reviewed.</span>
<span class="cm"> * CX23887 Assumptions</span>
<span class="cm"> * 1 line = 16 bytes of CDT</span>
<span class="cm"> * cmds size = 80</span>
<span class="cm"> * cdt size = 16 * linesize</span>
<span class="cm"> * iqsize = 64</span>
<span class="cm"> * maxlines = 6</span>
<span class="cm"> *</span>
<span class="cm"> * Address Space:</span>
<span class="cm"> * 0x00000000 0x00008fff FIFO clusters</span>
<span class="cm"> * 0x00010000 0x000104af Channel Management Data Structures</span>
<span class="cm"> * 0x000104b0 0x000104ff Free</span>
<span class="cm"> * 0x00010500 0x000108bf 15 channels * iqsize</span>
<span class="cm"> * 0x000108c0 0x000108ff Free</span>
<span class="cm"> * 0x00010900 0x00010e9f IQ&#39;s + Cluster Descriptor Tables</span>
<span class="cm"> *                       15 channels * (iqsize + (maxlines * linesize))</span>
<span class="cm"> * 0x00010ea0 0x00010xxx Free</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sram_channel</span> <span class="n">cx23885_sram_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SRAM_CH01</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;VID A&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x10380</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x104c0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x2800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA1_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA1_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA1_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA1_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH02</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA2_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA2_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA2_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA2_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH03</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TS1 B&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x100A0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x10400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x10580</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x5000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA3_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA3_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA3_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA3_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH04</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch4&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA4_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA4_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA4_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA4_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH05</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH06</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TS2 C&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x10140</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x10440</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x105e0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x6000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH07</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TV Audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x10190</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x10480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x10a00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x7000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA6_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA6_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA6_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA6_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH08</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch8&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA7_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA7_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA7_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA7_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH09</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch9&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA8_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA8_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA8_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA8_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sram_channel</span> <span class="n">cx23887_sram_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SRAM_CH01</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;VID A&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x105b0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x107b0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x2800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA1_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA1_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA1_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA1_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH02</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;VID A (VBI)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x10050</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x105F0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x10810</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x3000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA2_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA2_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA2_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA2_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH03</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TS1 B&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x100A0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x10630</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x10870</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x5000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA3_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA3_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA3_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA3_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH04</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch4&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA4_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA4_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA4_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA4_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH05</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH06</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TS2 C&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x10140</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x10670</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x108d0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x6000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA5_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA5_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH07</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TV Audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x10190</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x106B0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x10930</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x7000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA6_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA6_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA6_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA6_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH08</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch8&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA7_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA7_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA7_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA7_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH09</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ch9&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>	<span class="o">=</span> <span class="n">DMA8_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>	<span class="o">=</span> <span class="n">DMA8_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>	<span class="o">=</span> <span class="n">DMA8_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>	<span class="o">=</span> <span class="n">DMA8_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">cx23885_irq_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_irq_add_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">cx_set</span><span class="p">(</span><span class="n">PCI_INT_MSK</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">cx_set</span><span class="p">(</span><span class="n">PCI_INT_MSK</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cx23885_irq_enable_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cx23885_irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cx_clear</span><span class="p">(</span><span class="n">PCI_INT_MSK</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cx23885_irq_disable_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cx23885_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_irq_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">PCI_INT_MSK</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">cx23885_irq_get_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">PCI_INT_MSK</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_risc_decode</span><span class="p">(</span><span class="n">u32</span> <span class="n">risc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">instr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">RISC_SYNC</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;sync&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITE</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITEC</span>  <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writec&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_READ</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_READC</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;readc&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_JUMP</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;jump&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_SKIP</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;skip&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITERM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writerm&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITECM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writecm&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITECR</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writecr&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">incr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">RISC_WRITE</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_JUMP</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_SKIP</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_SYNC</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITERM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITECM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">[</span><span class="n">RISC_WRITECR</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;12&quot;</span><span class="p">,</span>   <span class="s">&quot;13&quot;</span><span class="p">,</span>   <span class="s">&quot;14&quot;</span><span class="p">,</span>   <span class="s">&quot;resync&quot;</span><span class="p">,</span>
		<span class="s">&quot;cnt0&quot;</span><span class="p">,</span> <span class="s">&quot;cnt1&quot;</span><span class="p">,</span> <span class="s">&quot;18&quot;</span><span class="p">,</span>   <span class="s">&quot;19&quot;</span><span class="p">,</span>
		<span class="s">&quot;20&quot;</span><span class="p">,</span>   <span class="s">&quot;21&quot;</span><span class="p">,</span>   <span class="s">&quot;22&quot;</span><span class="p">,</span>   <span class="s">&quot;23&quot;</span><span class="p">,</span>
		<span class="s">&quot;irq1&quot;</span><span class="p">,</span> <span class="s">&quot;irq2&quot;</span><span class="p">,</span> <span class="s">&quot;eol&quot;</span><span class="p">,</span>  <span class="s">&quot;sol&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x [ %s&quot;</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span>
	       <span class="n">instr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">?</span> <span class="n">instr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;INVALID&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">risc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; count=%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">risc</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">incr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">?</span> <span class="n">incr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cx23885_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">bc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cx23885_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

		<span class="cm">/* count comes from the hw and is is 16bit wide --</span>
<span class="cm">		 * this trick handles wrap-arounds correctly for</span>
<span class="cm">		 * up to 32767 buffers in flight... */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s16</span><span class="p">)</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;[%p/%d] wakeup reg=%d buf=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">,</span>
			<span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %d buffers handled (should be 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx23885_sram_channel_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">sram_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">risc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">lines</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cdt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() Erasing channel [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr1_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr2_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt2_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt1_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() Configuring channel [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bpl</span>   <span class="o">=</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span> <span class="cm">/* alignment */</span>
	<span class="n">cdt</span>   <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdt</span><span class="p">;</span>
	<span class="n">lines</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">/</span> <span class="n">bpl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lines</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">cx_write</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RISC_JUMP</span> <span class="o">|</span> <span class="n">RISC_IRQ1</span> <span class="o">|</span> <span class="n">RISC_CNT_INC</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* write CDT */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s() 0x%08x &lt;- 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cdt</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span> <span class="o">+</span> <span class="n">bpl</span><span class="o">*</span><span class="n">i</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">cdt</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span> <span class="o">+</span> <span class="n">bpl</span><span class="o">*</span><span class="n">i</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">cdt</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">cdt</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">cdt</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write CMDS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">jumponly</span><span class="p">)</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">risc</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* 64 bits 63-32 */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">cdt</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">lines</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">jumponly</span><span class="p">)</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">64</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* fill registers */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr1_reg</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr2_reg</span><span class="p">,</span> <span class="n">cdt</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt2_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">lines</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt1_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;[bridge %d] sram setup %s: bpl=%d lines=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">,</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">bpl</span><span class="p">,</span>
		<span class="n">lines</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_sram_channel_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">sram_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;init risc lo&quot;</span><span class="p">,</span>
		<span class="s">&quot;init risc hi&quot;</span><span class="p">,</span>
		<span class="s">&quot;cdt base&quot;</span><span class="p">,</span>
		<span class="s">&quot;cdt size&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq base&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq size&quot;</span><span class="p">,</span>
		<span class="s">&quot;risc pc lo&quot;</span><span class="p">,</span>
		<span class="s">&quot;risc pc hi&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq wr ptr&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq rd ptr&quot;</span><span class="p">,</span>
		<span class="s">&quot;cdt current&quot;</span><span class="p">,</span>
		<span class="s">&quot;pci target lo&quot;</span><span class="p">,</span>
		<span class="s">&quot;pci target hi&quot;</span><span class="p">,</span>
		<span class="s">&quot;line / byte&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">risc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s - dma channel status dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   cmds: %-15s: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">risc</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   risc%d: &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">cx23885_risc_decode</span><span class="p">(</span><span class="n">risc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">risc</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/* No consideration for bits 63-32 */</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   (0x%08x) iq %x: &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">cx23885_risc_decode</span><span class="p">(</span><span class="n">risc</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">risc</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   iq %x: 0x%08x [ arg #%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: fifo: 0x%08x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span><span class="o">+</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: ctrl: 0x%08x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   ptr1_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr1_reg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   ptr2_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr2_reg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   cnt1_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt1_reg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:   cnt2_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt2_reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_risc_disasm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: risc disasm: %p [dma=0x%08lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:   %04d: &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">cx23885_risc_decode</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:   %04d: 0x%08x [ arg #%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">j</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_JUMP</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable RISC controller */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">DEV_CNTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable all IR activity */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">IR_CNTRL_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable Video A/B activity */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_A_DMA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_B_DMA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_C_DMA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable Audio activity */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">AUD_INT_DMA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">AUD_EXT_DMA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable Serial port */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">UART_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable Interrupts */</span>
	<span class="n">cx23885_irq_disable_all</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_A_INT_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_B_INT_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_C_INT_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">AUDIO_INT_INT_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">AUDIO_EXT_INT_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">cx23885_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cx_write</span><span class="p">(</span><span class="n">PCI_INT_STAT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_A_INT_STAT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_B_INT_STAT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_C_INT_STAT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">AUDIO_INT_INT_STAT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">AUDIO_EXT_INT_STAT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">CLK_DELAY</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">CLK_DELAY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">,</span> <span class="mh">0x00500300</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH01</span><span class="p">],</span>
		<span class="mi">720</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH02</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH03</span><span class="p">],</span>
		<span class="mi">188</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH04</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH05</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH06</span><span class="p">],</span>
		<span class="mi">188</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH07</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH08</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">SRAM_CH09</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cx23885_gpio_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_pci_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* The cx23885 bridge has a weird bug which causes NMI to be asserted</span>
<span class="cm">	 * when DMA begins if RDR_TLCTL0 bit4 is not cleared. It does not</span>
<span class="cm">	 * occur on the cx23887 bridge.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">==</span> <span class="n">CX23885_BRIDGE_885</span><span class="p">)</span>
		<span class="n">cx_clear</span><span class="p">(</span><span class="n">RDR_TLCTL0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t get MMIO memory @ 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cx23885_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">cx23885_risc_stopper</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_init_tsport</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(portno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">portno</span><span class="p">);</span>

	<span class="cm">/* Transport bus init dma queue  - Common settings */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_ctl_val</span>        <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span> <span class="cm">/* Enable RISC controller and Fifo */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_int_msk_val</span>     <span class="o">=</span> <span class="mh">0x1111</span><span class="p">;</span> <span class="cm">/* TS port bits for RISC */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">vld_misc_val</span>       <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">hw_sop_ctrl_val</span>    <span class="o">=</span> <span class="p">(</span><span class="mh">0x47</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="mi">188</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">portno</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">.</span><span class="n">queued</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">cx23885_timeout</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">frontends</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">frontends</span><span class="p">.</span><span class="n">felist</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">frontends</span><span class="p">.</span><span class="n">active_fe_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This should be hardcoded allow a single frontend</span>
<span class="cm">	 * attachment to this tsport, keeping the -dvb.c</span>
<span class="cm">	 * code clean and safe.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_frontends</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">portno</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span>          <span class="o">=</span> <span class="n">VID_B_GPCNT</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt_ctl</span>      <span class="o">=</span> <span class="n">VID_B_GPCNT_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span>        <span class="o">=</span> <span class="n">VID_B_DMA_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_lngth</span>          <span class="o">=</span> <span class="n">VID_B_LNGTH</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_hw_sop_ctrl</span>    <span class="o">=</span> <span class="n">VID_B_HW_SOP_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gen_ctrl</span>       <span class="o">=</span> <span class="n">VID_B_GEN_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_bd_pkt_status</span>  <span class="o">=</span> <span class="n">VID_B_BD_PKT_STATUS</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_sop_status</span>     <span class="o">=</span> <span class="n">VID_B_SOP_STATUS</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_fifo_ovfl_stat</span> <span class="o">=</span> <span class="n">VID_B_FIFO_OVFL_STAT</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_vld_misc</span>       <span class="o">=</span> <span class="n">VID_B_VLD_MISC</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_clk_en</span>      <span class="o">=</span> <span class="n">VID_B_TS_CLK_EN</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span>        <span class="o">=</span> <span class="n">VID_B_SRC_SEL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_msk</span>     <span class="o">=</span> <span class="n">VID_B_INT_MSK</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_stat</span>    <span class="o">=</span> <span class="n">VID_B_INT_STAT</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">sram_chno</span>          <span class="o">=</span> <span class="n">SRAM_CH03</span><span class="p">;</span> <span class="cm">/* VID_B */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span>        <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* VID_B bit1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span>          <span class="o">=</span> <span class="n">VID_C_GPCNT</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt_ctl</span>      <span class="o">=</span> <span class="n">VID_C_GPCNT_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span>        <span class="o">=</span> <span class="n">VID_C_DMA_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_lngth</span>          <span class="o">=</span> <span class="n">VID_C_LNGTH</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_hw_sop_ctrl</span>    <span class="o">=</span> <span class="n">VID_C_HW_SOP_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gen_ctrl</span>       <span class="o">=</span> <span class="n">VID_C_GEN_CTL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_bd_pkt_status</span>  <span class="o">=</span> <span class="n">VID_C_BD_PKT_STATUS</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_sop_status</span>     <span class="o">=</span> <span class="n">VID_C_SOP_STATUS</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_fifo_ovfl_stat</span> <span class="o">=</span> <span class="n">VID_C_FIFO_OVFL_STAT</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_vld_misc</span>       <span class="o">=</span> <span class="n">VID_C_VLD_MISC</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_clk_en</span>      <span class="o">=</span> <span class="n">VID_C_TS_CLK_EN</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_msk</span>     <span class="o">=</span> <span class="n">VID_C_INT_MSK</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_stat</span>    <span class="o">=</span> <span class="n">VID_C_INT_STAT</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">sram_chno</span>          <span class="o">=</span> <span class="n">SRAM_CH06</span><span class="p">;</span> <span class="cm">/* VID_C */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span>        <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* VID_C bit2 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">cx23885_risc_stopper</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">.</span><span class="n">stopper</span><span class="p">,</span>
		     <span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_ctl_val</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_dev_checkrevision</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cx_read</span><span class="p">(</span><span class="n">RDR_CFG2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="cm">/* cx23885 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="cm">/* CX23885-12Z */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xa1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="cm">/* CX23885-13Z/14Z */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xb0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x8880</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* CX23888-21Z/22Z */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* CX23885-14Z */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xa4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x8880</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* CX23888-31Z */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* CX23885-15Z, CX23888-31Z */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xa5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0e</span>:
		<span class="cm">/* CX23887-15Z */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0f</span>:
		<span class="cm">/* CX23887-14Z */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span> <span class="o">=</span> <span class="mh">0xb1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() New hardware revision found 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() Hardware revision = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Hardware revision unknown 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwrevision</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Find the first v4l2_subdev member of the group id in hw */</span>
<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">cx23885_find_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">v4l2_device_for_each_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">==</span> <span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_dev_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_irqmask_lock</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">cx23885_devcount</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cx23885[%d]&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="cm">/* Configure the internal memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x8880</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Could be 887 or 888, assume a default */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">CX23885_BRIDGE_887</span><span class="p">;</span>
		<span class="cm">/* Apply a sensible clock frequency for the PCIe bridge */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk_freq</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span> <span class="o">=</span> <span class="n">cx23887_sram_channels</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x8852</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">CX23885_BRIDGE_885</span><span class="p">;</span>
		<span class="cm">/* Apply a sensible clock frequency for the PCIe bridge */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk_freq</span> <span class="o">=</span> <span class="mi">28000000</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span> <span class="o">=</span> <span class="n">cx23885_sram_channels</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() Memory configured for PCIe bridge type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">);</span>

	<span class="cm">/* board config */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cx23885_bcount</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">UNSET</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span>  <span class="o">&amp;&amp;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cx23885_idcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">cx23885_subids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subvendor</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="n">cx23885_subids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdevice</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">cx23885_subids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">CX23885_BOARD_UNKNOWN</span><span class="p">;</span>
		<span class="n">cx23885_card_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If the user specific a clk freq override, apply it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">clk_freq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk_freq</span> <span class="o">=</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">clk_freq</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_bus</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">cx23885_irq_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x001f00</span><span class="p">);</span>

	<span class="cm">/* External Master 1 Bus */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg_stat</span>  <span class="o">=</span> <span class="n">I2C1_STAT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg_ctrl</span>  <span class="o">=</span> <span class="n">I2C1_CTRL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg_addr</span>  <span class="o">=</span> <span class="n">I2C1_ADDR</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg_rdata</span> <span class="o">=</span> <span class="n">I2C1_RDATA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg_wdata</span> <span class="o">=</span> <span class="n">I2C1_WDATA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_period</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x9d</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span> <span class="cm">/* 100kHz */</span>

	<span class="cm">/* External Master 2 Bus */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg_stat</span>  <span class="o">=</span> <span class="n">I2C2_STAT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg_ctrl</span>  <span class="o">=</span> <span class="n">I2C2_CTRL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg_addr</span>  <span class="o">=</span> <span class="n">I2C2_ADDR</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg_rdata</span> <span class="o">=</span> <span class="n">I2C2_RDATA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg_wdata</span> <span class="o">=</span> <span class="n">I2C2_WDATA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_period</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x9d</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span> <span class="cm">/* 100kHz */</span>

	<span class="cm">/* Internal Master 3 Bus */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">reg_stat</span>  <span class="o">=</span> <span class="n">I2C3_STAT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">reg_ctrl</span>  <span class="o">=</span> <span class="n">I2C3_CTRL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">reg_addr</span>  <span class="o">=</span> <span class="n">I2C3_ADDR</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">reg_rdata</span> <span class="o">=</span> <span class="n">I2C3_RDATA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">reg_wdata</span> <span class="o">=</span> <span class="n">I2C3_WDATA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">i2c_period</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span> <span class="cm">/* 1.95MHz */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">))</span>
		<span class="n">cx23885_init_tsport</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">))</span>
		<span class="n">cx23885_init_tsport</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CORE %s No more PCIe resources for &quot;</span>
		       <span class="s">&quot;subsystem: %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>

		<span class="n">cx23885_devcount</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PCIe stuff */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CORE %s: subsystem: %04x:%04x, board: %s [card=%d,%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">,</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">,</span> <span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">?</span>
	       <span class="s">&quot;insmod option&quot;</span> <span class="o">:</span> <span class="s">&quot;autodetected&quot;</span><span class="p">);</span>

	<span class="n">cx23885_pci_quirks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Assume some sensible defaults */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">=</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">tuner_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_addr</span> <span class="o">=</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">tuner_addr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_bus</span> <span class="o">=</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">tuner_bus</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_type</span> <span class="o">=</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">radio_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_addr</span> <span class="o">=</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">radio_addr</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() tuner_type = 0x%x tuner_addr = 0x%x tuner_bus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_bus</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() radio_type = 0x%x radio_addr = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_type</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_addr</span><span class="p">);</span>

	<span class="cm">/* The cx23417 encoder has GPIO&#39;s that need to be initialised</span>
<span class="cm">	 * before DVB, so that demodulators and tuners are out of</span>
<span class="cm">	 * reset before DVB uses them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">))</span>
			<span class="n">cx23885_mc417_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* init hardware */</span>
	<span class="n">cx23885_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cx23885_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">cx23885_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">cx23885_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">cx23885_card_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx23885_ir_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">porta</span> <span class="o">==</span> <span class="n">CX23885_ANALOG_VIDEO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_video_register</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Failed to register analog &quot;</span>
				<span class="s">&quot;video adapters on VID_A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">num_fds_portb</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1</span><span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span>
				<span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">num_fds_portb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_dvb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Failed to register dvb adapters on VID_B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_417_register</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s() Failed to register 417 on VID_B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">num_fds_portc</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts2</span><span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span>
				<span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">num_fds_portc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_dvb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s() Failed to register dvb on VID_C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_417_register</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s() Failed to register 417 on VID_C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cx23885_dev_checkrevision</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* disable MSI for NetUP cards, otherwise CI is not working */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">ci_type</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cx_clear</span><span class="p">(</span><span class="n">RDR_RDRCTL1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_TEVII_S470</span>:
	<span class="k">case</span> <span class="n">CX23885_BOARD_TEVII_S471</span>:
		<span class="n">cx_clear</span><span class="p">(</span><span class="n">RDR_RDRCTL1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_dev_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">porta</span> <span class="o">==</span> <span class="n">CX23885_ANALOG_VIDEO</span><span class="p">)</span>
		<span class="n">cx23885_video_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span>
		<span class="n">cx23885_dvb_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span>
		<span class="n">cx23885_417_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span>
		<span class="n">cx23885_dvb_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span>
		<span class="n">cx23885_417_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cx23885_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">cx23885_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">cx23885_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__le32</span> <span class="o">*</span><span class="nf">cx23885_risc_field</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sync_line</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">,</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">todo</span><span class="p">,</span> <span class="n">sol</span><span class="p">;</span>

	<span class="cm">/* sync instruction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_line</span> <span class="o">!=</span> <span class="n">NO_SYNC_LINE</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_RESYNC</span> <span class="o">|</span> <span class="n">sync_line</span><span class="p">);</span>

	<span class="cm">/* scan lines */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="p">;</span> <span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lpi</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">line</span> <span class="o">%</span> <span class="n">lpi</span><span class="p">))</span>
			<span class="n">sol</span> <span class="o">=</span> <span class="n">RISC_SOL</span> <span class="o">|</span> <span class="n">RISC_IRQ1</span> <span class="o">|</span> <span class="n">RISC_CNT_INC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sol</span> <span class="o">=</span> <span class="n">RISC_SOL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">&lt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fits into current chunk */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span><span class="n">sol</span><span class="o">|</span><span class="n">RISC_EOL</span><span class="o">|</span><span class="n">bpl</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* bits 63-32 */</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">bpl</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* scanline needs to be split */</span>
			<span class="n">todo</span> <span class="o">=</span> <span class="n">bpl</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span><span class="n">sol</span><span class="o">|</span>
					    <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">));</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* bits 63-32 */</span>
			<span class="n">todo</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span>
						    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* bits 63-32 */</span>
				<span class="n">todo</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
				<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span><span class="n">RISC_EOL</span><span class="o">|</span><span class="n">todo</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* bits 63-32 */</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">padding</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx23885_risc_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">top_offset</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bottom_offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">fields</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">fields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">top_offset</span><span class="p">)</span>
		<span class="n">fields</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">bottom_offset</span><span class="p">)</span>
		<span class="n">fields</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is one write per page border +</span>
<span class="cm">	   one write per scan line + syncs + jump (all 2 dwords).  Padding</span>
<span class="cm">	   can cause next bpl to start close to a page border.  First DMA</span>
<span class="cm">	   region may be smaller than PAGE_SIZE */</span>
	<span class="cm">/* write and jump need and extra dword */</span>
	<span class="n">instructions</span>  <span class="o">=</span> <span class="n">fields</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpl</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span> <span class="o">*</span> <span class="n">lines</span><span class="p">)</span>
		<span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">lines</span><span class="p">);</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">instructions</span><span class="o">*</span><span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* write risc instructions */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">top_offset</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">cx23885_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">top_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">bpl</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">bottom_offset</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">cx23885_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">bottom_offset</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span>
					<span class="n">bpl</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx23885_risc_databuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">instructions</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is one write per page border +</span>
<span class="cm">	   one write per scan line + syncs + jump (all 2 dwords).  Here</span>
<span class="cm">	   there is no padding and no sync.  First DMA region may be smaller</span>
<span class="cm">	   than PAGE_SIZE */</span>
	<span class="cm">/* Jump and write need an extra dword */</span>
	<span class="n">instructions</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">*</span> <span class="n">lines</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">lines</span><span class="p">;</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">instructions</span><span class="o">*</span><span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* write risc instructions */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">cx23885_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_SYNC_LINE</span><span class="p">,</span>
				<span class="n">bpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">lpi</span><span class="p">);</span>

	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx23885_risc_vbibuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">top_offset</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bottom_offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">fields</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">fields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">top_offset</span><span class="p">)</span>
		<span class="n">fields</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">bottom_offset</span><span class="p">)</span>
		<span class="n">fields</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is one write per page border +</span>
<span class="cm">	   one write per scan line + syncs + jump (all 2 dwords).  Padding</span>
<span class="cm">	   can cause next bpl to start close to a page border.  First DMA</span>
<span class="cm">	   region may be smaller than PAGE_SIZE */</span>
	<span class="cm">/* write and jump need and extra dword */</span>
	<span class="n">instructions</span>  <span class="o">=</span> <span class="n">fields</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpl</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span> <span class="o">*</span> <span class="n">lines</span><span class="p">)</span>
		<span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">lines</span><span class="p">);</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">instructions</span><span class="o">*</span><span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* write risc instructions */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="cm">/* Sync to line 6, so US CC line 21 will appear in line &#39;12&#39;</span>
<span class="cm">	 * in the userland vbi payload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">top_offset</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">cx23885_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">top_offset</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
					<span class="n">bpl</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">bottom_offset</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">cx23885_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">bottom_offset</span><span class="p">,</span> <span class="mh">0x207</span><span class="p">,</span>
					<span class="n">bpl</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>



	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cx23885_risc_stopper</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* write risc instructions */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITECR</span>  <span class="o">|</span> <span class="n">RISC_IRQ2</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_JUMP</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* bits 63-32 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx23885_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>
	<span class="n">videobuf_waiton</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">videobuf_dma_free</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">btcx_riscmem_free</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_tsport_reg_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() Register Dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() DEV_CNTRL2               0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">DEV_CNTRL2</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() PCI_INT_MSK              0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx23885_irq_get_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() AUD_INT_INT_MSK          0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">AUDIO_INT_INT_MSK</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() AUD_INT_DMA_CTL          0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">AUD_INT_DMA_CTL</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() AUD_EXT_INT_MSK          0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">AUDIO_EXT_INT_MSK</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() AUD_EXT_DMA_CTL          0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">AUD_EXT_DMA_CTL</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() PAD_CTRL                 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() ALT_PIN_OUT_SEL          0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">ALT_PIN_OUT_SEL</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() GPIO2                    0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx_read</span><span class="p">(</span><span class="n">GPIO2</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() gpcnt(0x%08X)          0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() gpcnt_ctl(0x%08X)      0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt_ctl</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt_ctl</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() dma_ctl(0x%08X)        0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() src_sel(0x%08X)        0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() lngth(0x%08X)          0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_lngth</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_lngth</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() hw_sop_ctrl(0x%08X)    0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_hw_sop_ctrl</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_hw_sop_ctrl</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() gen_ctrl(0x%08X)       0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gen_ctrl</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gen_ctrl</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() bd_pkt_status(0x%08X)  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_bd_pkt_status</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_bd_pkt_status</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() sop_status(0x%08X)     0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_sop_status</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_sop_status</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() fifo_ovfl_stat(0x%08X) 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_fifo_ovfl_stat</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_fifo_ovfl_stat</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() vld_misc(0x%08X)       0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_vld_misc</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_vld_misc</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() ts_clk_en(0x%08X)      0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_clk_en</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_clk_en</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() ts_int_msk(0x%08X)     0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_msk</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_msk</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cx23885_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cx23885_buffer</span>   <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() w: %d, h: %d, f: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>

	<span class="cm">/* Stop the fifo and risc engine for this port */</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_ctl_val</span><span class="p">);</span>

	<span class="cm">/* setup fifo + format */</span>
	<span class="n">cx23885_sram_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sram_chno</span><span class="p">],</span>
				   <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_packet_size</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx23885_sram_channel_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sram_chno</span><span class="p">]);</span>
		<span class="n">cx23885_risc_disasm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write TS length to chip */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_lngth</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">&amp;</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">&amp;</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s() Unsupported .portb/c (0x%08x)/(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span><span class="p">,</span>
			<span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span>
		<span class="n">cx23885_av_clk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* If the port supports SRC SELECT, configure it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span><span class="p">)</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">src_sel_val</span><span class="p">);</span>

	<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_hw_sop_ctrl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hw_sop_ctrl_val</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_clk_en</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_clk_en_val</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_vld_misc</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vld_misc_val</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gen_ctrl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">gen_ctrl_val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* NOTE: this is 2 (reserved) for portb, does it matter? */</span>
	<span class="cm">/* reset counter to zero */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt_ctl</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set VIDB pins to input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span> <span class="cm">/* Clear TS1_OE &amp; TS1_SOP_OE */</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set VIDC pins to input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span> <span class="cm">/* Clear TS2_SOP_OE */</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>    <span class="cm">/* Clear TS1_OE */</span>

		<span class="cm">/* FIXME, bit 2 writing here is questionable */</span>
		<span class="cm">/* set TS1_SOP_OE and TS1_OE_HI */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0xa</span><span class="p">;</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* FIXME and these two registers should be documented. */</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">CLK_DELAY</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">CLK_DELAY</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000011</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ALT_PIN_OUT_SEL</span><span class="p">,</span> <span class="mh">0x10100045</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX23885_BRIDGE_885</span>:
	<span class="k">case</span> <span class="n">CX23885_BRIDGE_887</span>:
	<span class="k">case</span> <span class="n">CX23885_BRIDGE_888</span>:
		<span class="cm">/* enable irqs */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() enabling TS int&#39;s and DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cx_set</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_msk</span><span class="p">,</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_int_msk_val</span><span class="p">);</span>
		<span class="n">cx_set</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_ctl_val</span><span class="p">);</span>
		<span class="n">cx23885_irq_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span><span class="p">);</span>
		<span class="n">cx23885_irq_enable_all</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">cx_set</span><span class="p">(</span><span class="n">DEV_CNTRL2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">));</span> <span class="cm">/* Enable RISC controller */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span>
		<span class="n">cx23885_av_clk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">cx23885_tsport_reg_dump</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_stop_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Stop interrupts and DMA */</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_msk</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_int_msk_val</span><span class="p">);</span>
	<span class="n">cx_clear</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_ctl_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">);</span>

		<span class="cm">/* Set TS1_OE */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">;</span>

		<span class="cm">/* clear TS1_SOP_OE and TS1_OE_HI */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xa</span><span class="p">;</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">PAD_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_src_sel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gen_ctrl</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span>
		<span class="n">cx23885_av_clk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx23885_restart_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cx23885_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cx23885_buffer</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%s() queue is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx23885_buffer</span><span class="p">,</span>
					 <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
				<span class="n">cx23885_start_dma</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span>    <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;[%p/%d] restart_queue - f/active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span>  <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span>  <span class="o">&amp;&amp;</span>
				   <span class="n">prev</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&amp;&amp;</span>
				   <span class="n">prev</span><span class="o">-&gt;</span><span class="n">fmt</span>       <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span>    <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">jmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
				<span class="cm">/* 64 bit bits 63-32 */</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">jmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;[%p/%d] restart_queue - m/active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx23885_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;restart_queue [%p/%d]: restart dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
	<span class="n">cx23885_start_dma</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">int</span> <span class="nf">cx23885_buf_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cx23885_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_packet_size</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_packet_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">baddr</span>  <span class="o">&amp;&amp;</span>  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_packet_size</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ts_packet_count</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span>   <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span>  <span class="o">=</span> <span class="n">field</span> <span class="cm">/*V4L2_FIELD_TOP*/</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">cx23885_risc_databuffer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">,</span>
					<span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">cx23885_free_buffer</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_buf_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx23885_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_buffer</span>    <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_dmaqueue</span>  <span class="o">*</span><span class="n">cx88q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">;</span>

	<span class="cm">/* add jump to stopper */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">jmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_JUMP</span> <span class="o">|</span> <span class="n">RISC_IRQ1</span> <span class="o">|</span> <span class="n">RISC_CNT_INC</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">jmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">stopper</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">jmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* bits 63-32 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;queue is empty - first active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
		<span class="n">cx23885_start_dma</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">cx88q</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span>    <span class="o">=</span> <span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;[%p/%d] %s - first active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;queue is not empty - append to active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx23885_buffer</span><span class="p">,</span>
				  <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span>    <span class="o">=</span> <span class="n">cx88q</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">jmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">jmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* 64 bit bits 63-32 */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;[%p/%d] %s - append to active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_cancel_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">restart</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_dmaqueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx23885_buffer</span><span class="p">,</span>
				 <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;[%p/%d] %s - dma=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;restarting queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cx23885_restart_queue</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_cancel_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_dmaqueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">cx23885_stop_dma</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">do_cancel_buffers</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;cancel&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">cx23885_sram_channel_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sram_chno</span><span class="p">]);</span>

	<span class="n">cx23885_stop_dma</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">do_cancel_buffers</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx23885_irq_417</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: port1 assumption here. */</span>
	<span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;status: 0x%08x  mask: 0x%08x count: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_msk</span><span class="p">),</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_BAD_PKT</span><span class="p">)</span>         <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_OPC_ERR</span><span class="p">)</span>     <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_VBI_OPC_ERR</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_SYNC</span><span class="p">)</span>        <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_VBI_SYNC</span><span class="p">)</span>    <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_OF</span><span class="p">)</span>          <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_VBI_OF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: V4L mpeg risc op code error, status &quot;</span>
			<span class="s">&quot;= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_BAD_PKT</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_BAD_PKT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_OPC_ERR</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_OPC_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_VBI_OPC_ERR</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_VBI_OPC_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_SYNC</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_SYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_VBI_SYNC</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_VBI_SYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_OF</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_OF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_VBI_OF</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_VBI_OF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">cx_clear</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_ctl_val</span><span class="p">);</span>
		<span class="n">cx23885_sram_channel_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sram_chno</span><span class="p">]);</span>
		<span class="n">cx23885_417_check_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_RISCI1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_RISCI1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">cx23885_wakeup</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_B_MSK_RISCI2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;        VID_B_MSK_RISCI2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">cx23885_restart_queue</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_stat</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx23885_irq_ts</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_OPC_ERR</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_BAD_PKT</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_SYNC</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_OF</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_OPC_ERR</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (VID_BC_MSK_OPC_ERR 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">VID_BC_MSK_OPC_ERR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_BAD_PKT</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (VID_BC_MSK_BAD_PKT 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">VID_BC_MSK_BAD_PKT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_SYNC</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (VID_BC_MSK_SYNC    0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">VID_BC_MSK_SYNC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_OF</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (VID_BC_MSK_OF      0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">VID_BC_MSK_OF</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: mpeg risc op code error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">cx_clear</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_dma_ctl</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_ctl_val</span><span class="p">);</span>
		<span class="n">cx23885_sram_channel_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram_channels</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sram_chno</span><span class="p">]);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_RISCI1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (RISCI1            0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">VID_BC_MSK_RISCI1</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span><span class="p">);</span>
		<span class="n">cx23885_wakeup</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VID_BC_MSK_RISCI2</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (RISCI2            0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">VID_BC_MSK_RISCI2</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">cx23885_restart_queue</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mpegq</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reg_ts_int_stat</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cx23885_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">ts1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx23885_tsport</span> <span class="o">*</span><span class="n">ts2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pci_status</span><span class="p">,</span> <span class="n">pci_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vida_status</span><span class="p">,</span> <span class="n">vida_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">audint_status</span><span class="p">,</span> <span class="n">audint_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ts1_status</span><span class="p">,</span> <span class="n">ts1_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ts2_status</span><span class="p">,</span> <span class="n">ts2_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vida_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ts1_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ts2_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">audint_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">subdev_handled</span><span class="p">;</span>

	<span class="n">pci_status</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">PCI_INT_STAT</span><span class="p">);</span>
	<span class="n">pci_mask</span> <span class="o">=</span> <span class="n">cx23885_irq_get_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">vida_status</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">VID_A_INT_STAT</span><span class="p">);</span>
	<span class="n">vida_mask</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">VID_A_INT_MSK</span><span class="p">);</span>
	<span class="n">audint_status</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">AUDIO_INT_INT_STAT</span><span class="p">);</span>
	<span class="n">audint_mask</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">AUDIO_INT_INT_MSK</span><span class="p">);</span>
	<span class="n">ts1_status</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">VID_B_INT_STAT</span><span class="p">);</span>
	<span class="n">ts1_mask</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">VID_B_INT_MSK</span><span class="p">);</span>
	<span class="n">ts2_status</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">VID_C_INT_STAT</span><span class="p">);</span>
	<span class="n">ts2_mask</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">VID_C_INT_MSK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ts2_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ts1_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">vida_count</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">VID_A_GPCNT</span><span class="p">);</span>
	<span class="n">audint_count</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">AUD_INT_A_GPCNT</span><span class="p">);</span>
	<span class="n">ts1_count</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ts1</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span><span class="p">);</span>
	<span class="n">ts2_count</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ts2</span><span class="o">-&gt;</span><span class="n">reg_gpcnt</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;pci_status: 0x%08x  pci_mask: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pci_status</span><span class="p">,</span> <span class="n">pci_mask</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;vida_status: 0x%08x vida_mask: 0x%08x count: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vida_status</span><span class="p">,</span> <span class="n">vida_mask</span><span class="p">,</span> <span class="n">vida_count</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;audint_status: 0x%08x audint_mask: 0x%08x count: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">audint_status</span><span class="p">,</span> <span class="n">audint_mask</span><span class="p">,</span> <span class="n">audint_count</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;ts1_status: 0x%08x  ts1_mask: 0x%08x count: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ts1_status</span><span class="p">,</span> <span class="n">ts1_mask</span><span class="p">,</span> <span class="n">ts1_count</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;ts2_status: 0x%08x  ts2_mask: 0x%08x count: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ts2_status</span><span class="p">,</span> <span class="n">ts2_mask</span><span class="p">,</span> <span class="n">ts2_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_MSK_RISC_RD</span> <span class="o">|</span> <span class="n">PCI_MSK_RISC_WR</span> <span class="o">|</span>
			  <span class="n">PCI_MSK_AL_RD</span>   <span class="o">|</span> <span class="n">PCI_MSK_AL_WR</span>   <span class="o">|</span> <span class="n">PCI_MSK_APB_DMA</span> <span class="o">|</span>
			  <span class="n">PCI_MSK_VID_C</span>   <span class="o">|</span> <span class="n">PCI_MSK_VID_B</span>   <span class="o">|</span> <span class="n">PCI_MSK_VID_A</span>   <span class="o">|</span>
			  <span class="n">PCI_MSK_AUD_INT</span> <span class="o">|</span> <span class="n">PCI_MSK_AUD_EXT</span> <span class="o">|</span>
			  <span class="n">PCI_MSK_GPIO0</span>   <span class="o">|</span> <span class="n">PCI_MSK_GPIO1</span>   <span class="o">|</span>
			  <span class="n">PCI_MSK_AV_CORE</span> <span class="o">|</span> <span class="n">PCI_MSK_IR</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_RISC_RD</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_RISC_RD   0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_RISC_RD</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_RISC_WR</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_RISC_WR   0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_RISC_WR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_AL_RD</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_AL_RD     0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_AL_RD</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_AL_WR</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_AL_WR     0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_AL_WR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_APB_DMA</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_APB_DMA   0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_APB_DMA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_VID_C</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_VID_C     0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_VID_C</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_VID_B</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_VID_B     0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_VID_B</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_VID_A</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_VID_A     0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_VID_A</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_AUD_INT</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_AUD_INT   0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_AUD_INT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_AUD_EXT</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_AUD_EXT   0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_AUD_EXT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_GPIO0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_GPIO0     0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_GPIO0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_GPIO1</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_GPIO1     0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_GPIO1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_AV_CORE</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_AV_CORE   0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_AV_CORE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_IR</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot; (PCI_MSK_IR        0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_MSK_IR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">ci_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_MSK_GPIO1</span> <span class="o">|</span> <span class="n">PCI_MSK_GPIO0</span><span class="p">)))</span>
		<span class="n">handled</span> <span class="o">+=</span> <span class="n">netup_ci_slot_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">ci_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_GPIO0</span><span class="p">))</span>
		<span class="n">handled</span> <span class="o">+=</span> <span class="n">altera_ci_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts1_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span>
			<span class="n">handled</span> <span class="o">+=</span> <span class="n">cx23885_irq_ts</span><span class="p">(</span><span class="n">ts1</span><span class="p">,</span> <span class="n">ts1_status</span><span class="p">);</span>
		<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span>
			<span class="n">handled</span> <span class="o">+=</span> <span class="n">cx23885_irq_417</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ts1_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts2_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_DVB</span><span class="p">)</span>
			<span class="n">handled</span> <span class="o">+=</span> <span class="n">cx23885_irq_ts</span><span class="p">(</span><span class="n">ts2</span><span class="p">,</span> <span class="n">ts2_status</span><span class="p">);</span>
		<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">)</span>
			<span class="n">handled</span> <span class="o">+=</span> <span class="n">cx23885_irq_417</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ts2_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vida_status</span><span class="p">)</span>
		<span class="n">handled</span> <span class="o">+=</span> <span class="n">cx23885_video_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vida_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audint_status</span><span class="p">)</span>
		<span class="n">handled</span> <span class="o">+=</span> <span class="n">cx23885_audio_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">audint_status</span><span class="p">,</span> <span class="n">audint_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_IR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">subdev_handled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">interrupt_service_routine</span><span class="p">,</span>
				 <span class="n">pci_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subdev_handled</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subdev_handled</span><span class="p">)</span>
			<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci_status</span> <span class="o">&amp;</span> <span class="n">pci_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCI_MSK_AV_CORE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx23885_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_MSK_AV_CORE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx25840_work</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to set up deferred work for&quot;</span>
			       <span class="s">&quot; AV Core/IR interrupt. Interrupt is disabled&quot;</span>
			       <span class="s">&quot; and won&#39;t be re-enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handled</span><span class="p">)</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">PCI_INT_STAT</span><span class="p">,</span> <span class="n">pci_status</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_v4l2_dev_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">notification</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">to_cx23885</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">notification</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_IR_RX_NOTIFY</span>: <span class="cm">/* Possibly called in an IRQ context */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">)</span>
			<span class="n">cx23885_ir_rx_v4l2_dev_notify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_IR_TX_NOTIFY</span>: <span class="cm">/* Possibly called in an IRQ context */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sd_ir</span><span class="p">)</span>
			<span class="n">cx23885_ir_tx_v4l2_dev_notify</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx23885_v4l2_dev_notify_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cx25840_work</span><span class="p">,</span> <span class="n">cx23885_av_work_handler</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_rx_work</span><span class="p">,</span> <span class="n">cx23885_ir_rx_work_handler</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ir_tx_work</span><span class="p">,</span> <span class="n">cx23885_ir_tx_work_handler</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">cx23885_v4l2_dev_notify</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">encoder_on_portb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">encoder_on_portc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx23885_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">CX23885_MPEG_ENCODER</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Mask represents 32 different GPIOs, GPIO&#39;s are split into multiple</span>
<span class="cm"> * registers depending on the board configuration (and whether the</span>
<span class="cm"> * 417 encoder (wi it&#39;s own GPIO&#39;s) are present. Each GPIO bit will</span>
<span class="cm"> * be pushed into the correct hardware register, regardless of the</span>
<span class="cm"> * physical location. Certain registers are shared so we sanity check</span>
<span class="cm"> * and report errors if we think we&#39;re tampering with a GPIo that might</span>
<span class="cm"> * be assigned to the encoder (and used for the host bus).</span>
<span class="cm"> *</span>
<span class="cm"> * GPIO  2 thru  0 - On the cx23885 bridge</span>
<span class="cm"> * GPIO 18 thru  3 - On the cx23417 host bus interface</span>
<span class="cm"> * GPIO 23 thru 19 - On the cx25840 a/v core</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cx23885_gpio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span>
		<span class="n">cx_set</span><span class="p">(</span><span class="n">GP0_IO</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0007fff8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder_on_portb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">encoder_on_portc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: Setting GPIO on encoder ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">cx_set</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0007fff8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: 23-19 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00f80000</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_gpio_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00000007</span><span class="p">)</span>
		<span class="n">cx_clear</span><span class="p">(</span><span class="n">GP0_IO</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0007fff8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder_on_portb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">encoder_on_portc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: Clearing GPIO moving on encoder ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">cx_clear</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7fff8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: 23-19 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00f80000</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">cx23885_gpio_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00000007</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">cx_read</span><span class="p">(</span><span class="n">GP0_IO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0007fff8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder_on_portb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">encoder_on_portc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: Reading GPIO moving on encoder ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">cx_read</span><span class="p">(</span><span class="n">MC417_RWD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7fff8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: 23-19 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00f80000</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx23885_gpio_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">asoutput</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00000007</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">asoutput</span><span class="p">)</span>
		<span class="n">cx_set</span><span class="p">(</span><span class="n">GP0_IO</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00000007</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">asoutput</span><span class="p">)</span>
		<span class="n">cx_clear</span><span class="p">(</span><span class="n">GP0_IO</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0007fff8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder_on_portb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">encoder_on_portc</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s: Enabling GPIO on encoder ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* MC417_OEN is active low for output, write 1 for an input */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0007fff8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">asoutput</span><span class="p">)</span>
		<span class="n">cx_clear</span><span class="p">(</span><span class="n">MC417_OEN</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7fff8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0007fff8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">asoutput</span><span class="p">)</span>
		<span class="n">cx_set</span><span class="p">(</span><span class="n">MC417_OEN</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x7fff8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* TODO: 23-19 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cx23885_initdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>

	<span class="cm">/* Prepare to handle notifications from subdevices */</span>
	<span class="n">cx23885_v4l2_dev_notify_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* pci init */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx23885_dev_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* print pci info */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_rev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_lat</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s/0: found at %s, rev: %d, irq: %d, &quot;</span>
	       <span class="s">&quot;latency: %d, mmio: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_rev</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_lat</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_dma_supported</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s/0: Oops: no 32bit PCI DMA ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cx23885_irq</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_NETUP_DUAL_DVBS2_CI</span>:
		<span class="n">cx23885_irq_add_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_MSK_GPIO1</span> <span class="o">|</span> <span class="n">PCI_MSK_GPIO0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX23885_BOARD_NETUP_DUAL_DVB_T_C_CI_RF</span>:
		<span class="n">cx23885_irq_add_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_MSK_GPIO0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The CX2388[58] IR controller can start firing interrupts when</span>
<span class="cm">	 * enabled, so these have to take place after the cx23885_irq() handler</span>
<span class="cm">	 * is hooked up by the call to request_irq() above.</span>
<span class="cm">	 */</span>
	<span class="n">cx23885_ir_pci_int_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cx23885_input_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_irq:</span>
	<span class="n">cx23885_dev_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">fail_unreg:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">fail_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cx23885_finidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx23885_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_cx23885</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">cx23885_input_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cx23885_ir_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cx23885_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/* unregister stuff */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">cx23885_dev_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">cx23885_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* CX23885 */</span>
		<span class="p">.</span><span class="n">vendor</span>       <span class="o">=</span> <span class="mh">0x14f1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>       <span class="o">=</span> <span class="mh">0x8852</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>    <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>    <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* CX23887 Rev 2 */</span>
		<span class="p">.</span><span class="n">vendor</span>       <span class="o">=</span> <span class="mh">0x14f1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>       <span class="o">=</span> <span class="mh">0x8880</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>    <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>    <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* --- end of list --- */</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cx23885_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cx23885_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;cx23885&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cx23885_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">cx23885_initdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cx23885_finidev</span><span class="p">),</span>
	<span class="cm">/* TODO */</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cx23885_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cx23885 driver version %s loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">CX23885_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx23885_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cx23885_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx23885_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cx23885_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cx23885_fini</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
