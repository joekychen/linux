<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s2255drv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>s2255drv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  s2255drv.c - a driver for the Sensoray 2255 USB video capture device</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2007-2010 by Sensoray Company Inc.</span>
<span class="cm"> *                              Dean Anderson</span>
<span class="cm"> *</span>
<span class="cm"> * Some video buffer code based on vivi driver:</span>
<span class="cm"> *</span>
<span class="cm"> * Sensoray 2255 device supports 4 simultaneous channels.</span>
<span class="cm"> * The channels are not &quot;crossbar&quot; inputs, they are physically</span>
<span class="cm"> * attached to separate video decoders.</span>
<span class="cm"> *</span>
<span class="cm"> * Because of USB2.0 bandwidth limitations. There is only a</span>
<span class="cm"> * certain amount of data which may be transferred at one time.</span>
<span class="cm"> *</span>
<span class="cm"> * Example maximum bandwidth utilization:</span>
<span class="cm"> *</span>
<span class="cm"> * -full size, color mode YUYV or YUV422P: 2 channels at once</span>
<span class="cm"> * -full or half size Grey scale: all 4 channels at once</span>
<span class="cm"> * -half size, color mode YUYV or YUV422P: all 4 channels at once</span>
<span class="cm"> * -full size, color mode YUYV or YUV422P 1/2 frame rate: all 4 channels</span>
<span class="cm"> *  at once.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;media/videobuf-vmalloc.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>

<span class="cp">#define S2255_VERSION		&quot;1.22.1&quot;</span>
<span class="cp">#define FIRMWARE_FILE_NAME &quot;f2255usb.bin&quot;</span>

<span class="cm">/* default JPEG quality */</span>
<span class="cp">#define S2255_DEF_JPEG_QUAL     50</span>
<span class="cm">/* vendor request in */</span>
<span class="cp">#define S2255_VR_IN		0</span>
<span class="cm">/* vendor request out */</span>
<span class="cp">#define S2255_VR_OUT		1</span>
<span class="cm">/* firmware query */</span>
<span class="cp">#define S2255_VR_FW		0x30</span>
<span class="cm">/* USB endpoint number for configuring the device */</span>
<span class="cp">#define S2255_CONFIG_EP         2</span>
<span class="cm">/* maximum time for DSP to start responding after last FW word loaded(ms) */</span>
<span class="cp">#define S2255_DSP_BOOTTIME      800</span>
<span class="cm">/* maximum time to wait for firmware to load (ms) */</span>
<span class="cp">#define S2255_LOAD_TIMEOUT      (5000 + S2255_DSP_BOOTTIME)</span>
<span class="cp">#define S2255_DEF_BUFS          16</span>
<span class="cp">#define S2255_SETMODE_TIMEOUT   500</span>
<span class="cp">#define S2255_VIDSTATUS_TIMEOUT 350</span>
<span class="cp">#define S2255_MARKER_FRAME	cpu_to_le32(0x2255DA4AL)</span>
<span class="cp">#define S2255_MARKER_RESPONSE	cpu_to_le32(0x2255ACACL)</span>
<span class="cp">#define S2255_RESPONSE_SETMODE  cpu_to_le32(0x01)</span>
<span class="cp">#define S2255_RESPONSE_FW       cpu_to_le32(0x10)</span>
<span class="cp">#define S2255_RESPONSE_STATUS   cpu_to_le32(0x20)</span>
<span class="cp">#define S2255_USB_XFER_SIZE	(16 * 1024)</span>
<span class="cp">#define MAX_CHANNELS		4</span>
<span class="cp">#define SYS_FRAMES		4</span>
<span class="cm">/* maximum size is PAL full size plus room for the marker header(s) */</span>
<span class="cp">#define SYS_FRAMES_MAXSIZE	(720*288*2*2 + 4096)</span>
<span class="cp">#define DEF_USB_BLOCK		S2255_USB_XFER_SIZE</span>
<span class="cp">#define LINE_SZ_4CIFS_NTSC	640</span>
<span class="cp">#define LINE_SZ_2CIFS_NTSC	640</span>
<span class="cp">#define LINE_SZ_1CIFS_NTSC	320</span>
<span class="cp">#define LINE_SZ_4CIFS_PAL	704</span>
<span class="cp">#define LINE_SZ_2CIFS_PAL	704</span>
<span class="cp">#define LINE_SZ_1CIFS_PAL	352</span>
<span class="cp">#define NUM_LINES_4CIFS_NTSC	240</span>
<span class="cp">#define NUM_LINES_2CIFS_NTSC	240</span>
<span class="cp">#define NUM_LINES_1CIFS_NTSC	240</span>
<span class="cp">#define NUM_LINES_4CIFS_PAL	288</span>
<span class="cp">#define NUM_LINES_2CIFS_PAL	288</span>
<span class="cp">#define NUM_LINES_1CIFS_PAL	288</span>
<span class="cp">#define LINE_SZ_DEF		640</span>
<span class="cp">#define NUM_LINES_DEF		240</span>


<span class="cm">/* predefined settings */</span>
<span class="cp">#define FORMAT_NTSC	1</span>
<span class="cp">#define FORMAT_PAL	2</span>

<span class="cp">#define SCALE_4CIFS	1	</span><span class="cm">/* 640x480(NTSC) or 704x576(PAL) */</span><span class="cp"></span>
<span class="cp">#define SCALE_2CIFS	2	</span><span class="cm">/* 640x240(NTSC) or 704x288(PAL) */</span><span class="cp"></span>
<span class="cp">#define SCALE_1CIFS	3	</span><span class="cm">/* 320x240(NTSC) or 352x288(PAL) */</span><span class="cp"></span>
<span class="cm">/* SCALE_4CIFSI is the 2 fields interpolated into one */</span>
<span class="cp">#define SCALE_4CIFSI	4	</span><span class="cm">/* 640x480(NTSC) or 704x576(PAL) high quality */</span><span class="cp"></span>

<span class="cp">#define COLOR_YUVPL	1	</span><span class="cm">/* YUV planar */</span><span class="cp"></span>
<span class="cp">#define COLOR_YUVPK	2	</span><span class="cm">/* YUV packed */</span><span class="cp"></span>
<span class="cp">#define COLOR_Y8	4	</span><span class="cm">/* monochrome */</span><span class="cp"></span>
<span class="cp">#define COLOR_JPG       5       </span><span class="cm">/* JPEG */</span><span class="cp"></span>

<span class="cp">#define MASK_COLOR       0x000000ff</span>
<span class="cp">#define MASK_JPG_QUALITY 0x0000ff00</span>
<span class="cp">#define MASK_INPUT_TYPE  0x000f0000</span>
<span class="cm">/* frame decimation. */</span>
<span class="cp">#define FDEC_1		1	</span><span class="cm">/* capture every frame. default */</span><span class="cp"></span>
<span class="cp">#define FDEC_2		2	</span><span class="cm">/* capture every 2nd frame */</span><span class="cp"></span>
<span class="cp">#define FDEC_3		3	</span><span class="cm">/* capture every 3rd frame */</span><span class="cp"></span>
<span class="cp">#define FDEC_5		5	</span><span class="cm">/* capture every 5th frame */</span><span class="cp"></span>

<span class="cm">/*-------------------------------------------------------</span>
<span class="cm"> * Default mode parameters.</span>
<span class="cm"> *-------------------------------------------------------*/</span>
<span class="cp">#define DEF_SCALE	SCALE_4CIFS</span>
<span class="cp">#define DEF_COLOR	COLOR_YUVPL</span>
<span class="cp">#define DEF_FDEC	FDEC_1</span>
<span class="cp">#define DEF_BRIGHT	0</span>
<span class="cp">#define DEF_CONTRAST	0x5c</span>
<span class="cp">#define DEF_SATURATION	0x80</span>
<span class="cp">#define DEF_HUE		0</span>

<span class="cm">/* usb config commands */</span>
<span class="cp">#define IN_DATA_TOKEN	cpu_to_le32(0x2255c0de)</span>
<span class="cp">#define CMD_2255	0xc2255000</span>
<span class="cp">#define CMD_SET_MODE	cpu_to_le32((CMD_2255 | 0x10))</span>
<span class="cp">#define CMD_START	cpu_to_le32((CMD_2255 | 0x20))</span>
<span class="cp">#define CMD_STOP	cpu_to_le32((CMD_2255 | 0x30))</span>
<span class="cp">#define CMD_STATUS	cpu_to_le32((CMD_2255 | 0x40))</span>

<span class="k">struct</span> <span class="n">s2255_mode</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">format</span><span class="p">;</span>	<span class="cm">/* input video format (NTSC, PAL) */</span>
	<span class="n">u32</span> <span class="n">scale</span><span class="p">;</span>	<span class="cm">/* output video scale */</span>
	<span class="n">u32</span> <span class="n">color</span><span class="p">;</span>	<span class="cm">/* output video color format */</span>
	<span class="n">u32</span> <span class="n">fdec</span><span class="p">;</span>	<span class="cm">/* frame decimation */</span>
	<span class="n">u32</span> <span class="n">bright</span><span class="p">;</span>	<span class="cm">/* brightness */</span>
	<span class="n">u32</span> <span class="n">contrast</span><span class="p">;</span>	<span class="cm">/* contrast */</span>
	<span class="n">u32</span> <span class="n">saturation</span><span class="p">;</span>	<span class="cm">/* saturation */</span>
	<span class="n">u32</span> <span class="n">hue</span><span class="p">;</span>	<span class="cm">/* hue (NTSC only)*/</span>
	<span class="n">u32</span> <span class="n">single</span><span class="p">;</span>	<span class="cm">/* capture 1 frame at a time (!=0), continuously (==0)*/</span>
	<span class="n">u32</span> <span class="n">usb_block</span><span class="p">;</span>	<span class="cm">/* block size. should be 4096 of DEF_USB_BLOCK */</span>
	<span class="n">u32</span> <span class="n">restart</span><span class="p">;</span>	<span class="cm">/* if DSP requires restart */</span>
<span class="p">};</span>


<span class="cp">#define S2255_READ_IDLE		0</span>
<span class="cp">#define S2255_READ_FRAME	1</span>

<span class="cm">/* frame structure */</span>
<span class="k">struct</span> <span class="n">s2255_framei</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ulState</span><span class="p">;</span>	<span class="cm">/* ulState:S2255_READ_IDLE, S2255_READ_FRAME*/</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">lpvbits</span><span class="p">;</span>		<span class="cm">/* image data */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cur_size</span><span class="p">;</span>	<span class="cm">/* current data copied to it */</span>
<span class="p">};</span>

<span class="cm">/* image buffer structure */</span>
<span class="k">struct</span> <span class="n">s2255_bufferi</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwFrames</span><span class="p">;</span>			<span class="cm">/* number of frames in buffer */</span>
	<span class="k">struct</span> <span class="n">s2255_framei</span> <span class="n">frame</span><span class="p">[</span><span class="n">SYS_FRAMES</span><span class="p">];</span>	<span class="cm">/* array of FRAME structures */</span>
<span class="p">};</span>

<span class="cp">#define DEF_MODEI_NTSC_CONT	{FORMAT_NTSC, DEF_SCALE, DEF_COLOR,	\</span>
<span class="cp">			DEF_FDEC, DEF_BRIGHT, DEF_CONTRAST, DEF_SATURATION, \</span>
<span class="cp">			DEF_HUE, 0, DEF_USB_BLOCK, 0}</span>

<span class="k">struct</span> <span class="n">s2255_dmaqueue</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* for firmware loading, fw_state */</span>
<span class="cp">#define S2255_FW_NOTLOADED	0</span>
<span class="cp">#define S2255_FW_LOADED_DSPWAIT	1</span>
<span class="cp">#define S2255_FW_SUCCESS	2</span>
<span class="cp">#define S2255_FW_FAILED		3</span>
<span class="cp">#define S2255_FW_DISCONNECTING  4</span>
<span class="cp">#define S2255_FW_MARKER		cpu_to_le32(0x22552f2f)</span>
<span class="cm">/* 2255 read states */</span>
<span class="cp">#define S2255_READ_IDLE         0</span>
<span class="cp">#define S2255_READ_FRAME        1</span>
<span class="k">struct</span> <span class="n">s2255_fw</span> <span class="p">{</span>
	<span class="kt">int</span>		      <span class="n">fw_loaded</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">fw_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>	      <span class="o">*</span><span class="n">fw_urb</span><span class="p">;</span>
	<span class="n">atomic_t</span>	      <span class="n">fw_state</span><span class="p">;</span>
	<span class="kt">void</span>		      <span class="o">*</span><span class="n">pfw_data</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>     <span class="n">wait_fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s2255_pipeinfo</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_transfer_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_transfer_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">stream_urb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>	<span class="cm">/* back pointer to s2255_dev struct*/</span>
	<span class="n">u32</span> <span class="n">err_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s2255_fmt</span><span class="p">;</span> <span class="cm">/*forward declaration */</span>
<span class="k">struct</span> <span class="n">s2255_dev</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span>	<span class="n">vdev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">resources</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dmaqueue</span>	<span class="n">vidq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_bufferi</span>	<span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_mode</span>	<span class="n">mode</span><span class="p">;</span>
	<span class="cm">/* jpeg compression */</span>
	<span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="n">jc</span><span class="p">;</span>
	<span class="cm">/* capture parameters (for high quality mode full size) */</span>
	<span class="k">struct</span> <span class="n">v4l2_captureparm</span> <span class="n">cap_parm</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cur_frame</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">last_frame</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">b_acquire</span><span class="p">;</span>
	<span class="cm">/* allocated image size */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">req_image_size</span><span class="p">;</span>
	<span class="cm">/* received packet size */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pkt_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">bad_payload</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">frame_count</span><span class="p">;</span>
	<span class="cm">/* if JPEG image */</span>
	<span class="kt">int</span>                     <span class="n">jpg_size</span><span class="p">;</span>
	<span class="cm">/* if channel configured to default state */</span>
	<span class="kt">int</span>                     <span class="n">configured</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>       <span class="n">wait_setmode</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">setmode_ready</span><span class="p">;</span>
	<span class="cm">/* video status items */</span>
	<span class="kt">int</span>                     <span class="n">vidstatus</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>       <span class="n">wait_vidstatus</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">vidstatus_ready</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">height</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s2255_fmt</span>	<span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span> <span class="cm">/* channel number on device, 0-3 */</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span>    <span class="n">channel</span><span class="p">[</span><span class="n">MAX_CHANNELS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> 	<span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">atomic_t</span>                <span class="n">num_channels</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">frames</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">lock</span><span class="p">;</span>	<span class="cm">/* channels[].vdev.lock */</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">open_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span>	<span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span>	<span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">read_endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_fw</span>	<span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_pipeinfo</span>	<span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cc</span><span class="p">;</span>	<span class="cm">/* current channel */</span>
	<span class="kt">int</span>			<span class="n">frame_ready</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">chn_ready</span><span class="p">;</span>
	<span class="n">spinlock_t</span>              <span class="n">slock</span><span class="p">;</span>
	<span class="cm">/* dsp firmware version (f2255usb.bin) */</span>
	<span class="kt">int</span>                     <span class="n">dsp_fw_ver</span><span class="p">;</span>
	<span class="n">u16</span>                     <span class="n">pid</span><span class="p">;</span> <span class="cm">/* product id */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="nf">to_s2255_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_dev</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">s2255_fmt</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fourcc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* buffer for one video frame */</span>
<span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="p">{</span>
	<span class="cm">/* common v4l buffer stuff -- must be first */</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="n">vb</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s2255_fmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span>	<span class="n">vb_vidq</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span>	<span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span>	<span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">resources</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* current cypress EEPROM firmware version */</span>
<span class="cp">#define S2255_CUR_USB_FWVER	((3 &lt;&lt; 8) | 12)</span>
<span class="cm">/* current DSP FW version */</span>
<span class="cp">#define S2255_CUR_DSP_FWVER     10104</span>
<span class="cm">/* Need DSP version 5+ for video status feature */</span>
<span class="cp">#define S2255_MIN_DSP_STATUS      5</span>
<span class="cp">#define S2255_MIN_DSP_COLORFILTER 8</span>
<span class="cp">#define S2255_NORMS		(V4L2_STD_PAL | V4L2_STD_NTSC)</span>

<span class="cm">/* private V4L2 controls */</span>

<span class="cm">/*</span>
<span class="cm"> * The following chart displays how COLORFILTER should be set</span>
<span class="cm"> *  =========================================================</span>
<span class="cm"> *  =     fourcc              =     COLORFILTER             =</span>
<span class="cm"> *  =                         ===============================</span>
<span class="cm"> *  =                         =   0             =    1      =</span>
<span class="cm"> *  =========================================================</span>
<span class="cm"> *  =  V4L2_PIX_FMT_GREY(Y8)  = monochrome from = monochrome=</span>
<span class="cm"> *  =                         = s-video or      = composite =</span>
<span class="cm"> *  =                         = B/W camera      = input     =</span>
<span class="cm"> *  =========================================================</span>
<span class="cm"> *  =    other                = color, svideo   = color,    =</span>
<span class="cm"> *  =                         =                 = composite =</span>
<span class="cm"> *  =========================================================</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *   channels 0-3 on 2255 are composite</span>
<span class="cm"> *   channels 0-1 on 2257 are composite, 2-3 are s-video</span>
<span class="cm"> * If COLORFILTER is 0 with a composite color camera connected,</span>
<span class="cm"> * the output will appear monochrome but hatching</span>
<span class="cm"> * will occur.</span>
<span class="cm"> * COLORFILTER is different from &quot;color killer&quot; and &quot;color effects&quot;</span>
<span class="cm"> * for reasons above.</span>
<span class="cm"> */</span>
<span class="cp">#define S2255_V4L2_YC_ON  1</span>
<span class="cp">#define S2255_V4L2_YC_OFF 0</span>
<span class="cp">#define V4L2_CID_PRIVATE_COLORFILTER (V4L2_CID_PRIVATE_BASE + 0)</span>

<span class="cm">/* frame prefix size (sent once every frame) */</span>
<span class="cp">#define PREFIX_SIZE		512</span>

<span class="cm">/* Channels on box are in reverse order */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">G_chnmap</span><span class="p">[</span><span class="n">MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="o">*</span><span class="n">s2255_debug</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">debug</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">s2255_start_readpipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">s2255_stop_readpipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">s2255_start_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">s2255_stop_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">s2255_fillbuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">chn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">jpgsize</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">s2255_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">s2255_board_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">s2255_fwload_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">s2255_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">s2255_vendor_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">req</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="n">s32</span> <span class="n">buf_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bOut</span><span class="p">);</span>

<span class="cm">/* dev_err macro with driver name */</span>
<span class="cp">#define S2255_DRIVER_NAME &quot;s2255&quot;</span>
<span class="cp">#define s2255_dev_err(dev, fmt, arg...)					\</span>
<span class="cp">		dev_err(dev, S2255_DRIVER_NAME &quot; - &quot; fmt, ##arg)</span>

<span class="cp">#define dprintk(level, fmt, arg...)					\</span>
<span class="cp">	do {								\</span>
<span class="cp">		if (*s2255_debug &gt;= (level)) {				\</span>
<span class="cp">			printk(KERN_DEBUG S2255_DRIVER_NAME		\</span>
<span class="cp">				&quot;: &quot; fmt, ##arg);			\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">s2255_driver</span><span class="p">;</span>

<span class="cm">/* Declare static vars that will be used as parameters */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vid_limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* Video memory limit, in Mb */</span>

<span class="cm">/* start video number */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* /dev/videoN, -1 for autodetect */</span>

<span class="cm">/* Enable jpeg capture. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">jpeg_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level(0-100) default 0&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vid_limit</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vid_limit</span><span class="p">,</span> <span class="s">&quot;video memory limit(Mb)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="s">&quot;start video minor(-1 default autodetect)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">jpeg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">jpeg_enable</span><span class="p">,</span> <span class="s">&quot;Jpeg enable(1-on 0-off) default 1&quot;</span><span class="p">);</span>

<span class="cm">/* USB device table */</span>
<span class="cp">#define USB_SENSORAY_VID	0x1943</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">s2255_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_SENSORAY_VID</span><span class="p">,</span> <span class="mh">0x2255</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_SENSORAY_VID</span><span class="p">,</span> <span class="mh">0x2257</span><span class="p">)},</span> <span class="cm">/*same family as 2255*/</span>
	<span class="p">{</span> <span class="p">}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">s2255_table</span><span class="p">);</span>

<span class="cp">#define BUFFER_TIMEOUT msecs_to_jiffies(400)</span>

<span class="cm">/* image formats.  */</span>
<span class="cm">/* JPEG formats must be defined last to support jpeg_enable parameter */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">s2255_fmt</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4:2:2, planar, YUV422P&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span>

	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4:2:2, packed, YUYV&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span>

	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4:2:2, packed, UYVY&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;8bpp GREY&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">8</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;JPG&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_JPEG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">24</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MJPG&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">24</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">norm_maxw</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">current_norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">LINE_SZ_4CIFS_NTSC</span> <span class="o">:</span> <span class="n">LINE_SZ_4CIFS_PAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">norm_maxh</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">current_norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">?</span>
	    <span class="p">(</span><span class="n">NUM_LINES_1CIFS_NTSC</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">NUM_LINES_1CIFS_PAL</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">norm_minw</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">current_norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">LINE_SZ_1CIFS_NTSC</span> <span class="o">:</span> <span class="n">LINE_SZ_1CIFS_PAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">norm_minh</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">current_norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">?</span>
	    <span class="p">(</span><span class="n">NUM_LINES_1CIFS_NTSC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">NUM_LINES_1CIFS_PAL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * TODO: fixme: move YUV reordering to hardware</span>
<span class="cm"> * converts 2255 planar format to yuyv or uyvy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">planar422p_to_yuv_packed</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pY</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pCb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pCr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pY</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">;</span>
	<span class="n">pCr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">in</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">pCb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">in</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">pY</span><span class="o">++</span> <span class="o">:</span> <span class="o">*</span><span class="n">pCr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">pCr</span><span class="o">++</span> <span class="o">:</span> <span class="o">*</span><span class="n">pY</span><span class="o">++</span><span class="p">;</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">pY</span><span class="o">++</span> <span class="o">:</span> <span class="o">*</span><span class="n">pCb</span><span class="o">++</span><span class="p">;</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">pCb</span><span class="o">++</span> <span class="o">:</span> <span class="o">*</span><span class="n">pY</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_reset_dsppower</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s2255_vendor_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">s2255_vendor_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>
	<span class="n">s2255_vendor_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* kickstarts the firmware loading. from probe</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s2255_fw</span> <span class="o">*</span><span class="p">)</span><span class="n">user_data</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;s2255: can&#39;t submit urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S2255_FW_FAILED</span><span class="p">);</span>
		<span class="cm">/* wake up anything waiting for the firmware */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* this loads the firmware asynchronously.</span>
<span class="cm">   Originally this was done synchroously in probe.</span>
<span class="cm">   But it is better to load it asynchronously here than block</span>
<span class="cm">   inside the probe function. Blocking inside probe affects boot time.</span>
<span class="cm">   FW loading is triggered by the timer in the probe function</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_fwchunk_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;%s: udev %p urb %p&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;URB failed with status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S2255_FW_FAILED</span><span class="p">);</span>
		<span class="cm">/* wake up anything waiting for the firmware */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s2255_dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S2255_FW_FAILED</span><span class="p">);</span>
		<span class="cm">/* wake up anything waiting for the firmware */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#define CHUNK_SIZE 512</span>
	<span class="cm">/* all USB transfers must be done with continuous kernel memory.</span>
<span class="cm">	   can&#39;t allocate more than 128k in current linux kernel, so</span>
<span class="cm">	   upload the firmware in chunks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_loaded</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_loaded</span> <span class="o">+</span> <span class="n">CHUNK_SIZE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">?</span>
		    <span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">%</span> <span class="n">CHUNK_SIZE</span> <span class="o">:</span> <span class="n">CHUNK_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">CHUNK_SIZE</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;completed len %d, loaded %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_loaded</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_loaded</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
				  <span class="n">data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">,</span>
				  <span class="n">s2255_fwchunk_complete</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed submit URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S2255_FW_FAILED</span><span class="p">);</span>
			<span class="cm">/* wake up anything waiting for the firmware */</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_loaded</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S2255_FW_LOADED_DSPWAIT</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;%s: firmware upload complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_got_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">jpgsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_dmaqueue</span> <span class="o">*</span><span class="n">dma_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No active queue to serve</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dma_q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">s2255_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">s2255_fillbuff</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">jpgsize</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: [buf/i] [%p/%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">s2255_fmt</span> <span class="o">*</span><span class="nf">format_by_fourcc</span><span class="p">(</span><span class="kt">int</span> <span class="n">fourcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">formats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jpeg_enable</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_JPEG</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)))</span>
	    <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">fourcc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">formats</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* video buffer vmalloc implementation based partly on VIVI driver which is</span>
<span class="cm"> *          Copyright (c) 2006 by</span>
<span class="cm"> *                  Mauro Carvalho Chehab &lt;mchehab--a.t--infradead.org&gt;</span>
<span class="cm"> *                  Ted Walther &lt;ted--a.t--enumera.com&gt;</span>
<span class="cm"> *                  John Sokol &lt;sokol--a.t--videotechnology.com&gt;</span>
<span class="cm"> *                  http://v4l.videotechnology.com/</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_fillbuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">jpgsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmpbuf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vbuf</span> <span class="o">=</span> <span class="n">videobuf_to_vmalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vbuf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">last_frame</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_frame</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmpbuf</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">last_frame</span><span class="p">].</span><span class="n">lpvbits</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_YUYV</span>:
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_UYVY</span>:
			<span class="n">planar422p_to_yuv_packed</span><span class="p">((</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tmpbuf</span><span class="p">,</span>
						 <span class="n">vbuf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
						 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
						 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_GREY</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">vbuf</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_JPEG</span>:
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_MJPEG</span>:
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">jpgsize</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">vbuf</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_PIX_FMT_YUV422P</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">vbuf</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span>
			       <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;s2255: unknown format?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">last_frame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;s2255: =======no frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;s2255fill at : Buffer 0x%08lx size= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vbuf</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="cm">/* tell v4l buffer was filled */</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ------------------------------------------------------------------</span>
<span class="cm">   Videobuf operations</span>
<span class="cm">   ------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">S2255_DEF_BUFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">*</span> <span class="o">*</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">vid_limit</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid_limit</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">videobuf_vmalloc_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s, field=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">norm_minw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">norm_maxw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">norm_minh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">norm_maxh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;invalid buffer prepare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">baddr</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;invalid buffer prepare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">free_buffer</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dmaqueue</span> <span class="o">*</span><span class="n">vidq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidq</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vidq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">free_buffer</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">s2255_video_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span> <span class="o">=</span> <span class="n">buffer_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span> <span class="o">=</span> <span class="n">buffer_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span> <span class="o">=</span> <span class="n">buffer_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span> <span class="o">=</span> <span class="n">buffer_release</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">res_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="cm">/* is it free? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no, someone else uses it */</span>
	<span class="cm">/* it&#39;s free, grab it */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;s2255: res: get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">res_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">res_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">res_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;res: put</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querymenu</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">qmenu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">colorfilter</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Off&quot;</span><span class="p">,</span>
		<span class="s">&quot;On&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_CID_PRIVATE_COLORFILTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">menu_items</span> <span class="o">=</span> <span class="n">colorfilter</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;&amp;</span> <span class="n">menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span> <span class="cm">/* do nothing (from v4l2-common.c) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">menu_items</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">menu_items</span><span class="p">[</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">qmenu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">v4l2_ctrl_query_menu</span><span class="p">(</span><span class="n">qmenu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;s2255&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;s2255&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">formats</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jpeg_enable</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_JPEG</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s2255_fmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">b_any_field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_ntsc</span><span class="p">;</span>
	<span class="n">is_ntsc</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">current_norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">)</span>
		<span class="n">b_any_field</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;%s NTSC: %d suggested width: %d, height: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">is_ntsc</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ntsc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NTSC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;=</span> <span class="n">NUM_LINES_1CIFS_NTSC</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">NUM_LINES_1CIFS_NTSC</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_any_field</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">)</span> <span class="o">||</span>
				      <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">)</span> <span class="o">||</span>
				      <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_INTERLACED_TB</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unsupported field setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">NUM_LINES_1CIFS_NTSC</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_any_field</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">)</span> <span class="o">||</span>
				      <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unsupported field setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">LINE_SZ_4CIFS_NTSC</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_4CIFS_NTSC</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">LINE_SZ_2CIFS_NTSC</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_2CIFS_NTSC</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">LINE_SZ_1CIFS_NTSC</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_1CIFS_NTSC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_1CIFS_NTSC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PAL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;=</span> <span class="n">NUM_LINES_1CIFS_PAL</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">NUM_LINES_1CIFS_PAL</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_any_field</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">)</span> <span class="o">||</span>
				      <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">)</span> <span class="o">||</span>
				      <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_INTERLACED_TB</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unsupported field setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">NUM_LINES_1CIFS_PAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_any_field</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">)</span> <span class="o">||</span>
				     <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unsupported field setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">LINE_SZ_4CIFS_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_4CIFS_PAL</span><span class="p">;</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">LINE_SZ_2CIFS_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_2CIFS_PAL</span><span class="p">;</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">LINE_SZ_1CIFS_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_1CIFS_PAL</span><span class="p">;</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_1CIFS_PAL</span><span class="p">;</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;%s: set width %d height %d field %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s2255_fmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">vb_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">videobuf_queue_is_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;queue busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_s_fmt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_locked</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: channel busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_s_fmt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">norm_minw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">norm_minh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">cap_parm</span><span class="p">.</span><span class="n">capturemode</span> <span class="o">&amp;</span>
			    <span class="n">V4L2_MODE_HIGHQUALITY</span><span class="p">)</span>
				<span class="n">mode</span><span class="p">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">SCALE_4CIFSI</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mode</span><span class="p">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">SCALE_4CIFS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">SCALE_2CIFS</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">SCALE_1CIFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* color mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_GREY</span>:
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_COLOR</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">|=</span> <span class="n">COLOR_Y8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_JPEG</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_MJPEG</span>:
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_COLOR</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">|=</span> <span class="n">COLOR_JPG</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">|=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">jc</span><span class="p">.</span><span class="n">quality</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_YUV422P</span>:
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_COLOR</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">|=</span> <span class="n">COLOR_YUVPL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_YUYV</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_UYVY</span>:
	<span class="nl">default:</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_COLOR</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">|=</span> <span class="n">COLOR_YUVPK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;</span> <span class="n">MASK_COLOR</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;</span> <span class="n">MASK_COLOR</span><span class="p">))</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">scale</span><span class="p">)</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span><span class="p">)</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">s2255_set_mode</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_s_fmt:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write to the configuration pipe, synchronously */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">S2255_CONFIG_EP</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_transfer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">linesPerFrame</span> <span class="o">=</span> <span class="n">LINE_SZ_DEF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixelsPerLine</span> <span class="o">=</span> <span class="n">NUM_LINES_DEF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">outImageSize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">usbInSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask_mult</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">FORMAT_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCALE_4CIFS</span>:
		<span class="k">case</span> <span class="n">SCALE_4CIFSI</span>:
			<span class="n">linesPerFrame</span> <span class="o">=</span> <span class="n">NUM_LINES_4CIFS_NTSC</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">pixelsPerLine</span> <span class="o">=</span> <span class="n">LINE_SZ_4CIFS_NTSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCALE_2CIFS</span>:
			<span class="n">linesPerFrame</span> <span class="o">=</span> <span class="n">NUM_LINES_2CIFS_NTSC</span><span class="p">;</span>
			<span class="n">pixelsPerLine</span> <span class="o">=</span> <span class="n">LINE_SZ_2CIFS_NTSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCALE_1CIFS</span>:
			<span class="n">linesPerFrame</span> <span class="o">=</span> <span class="n">NUM_LINES_1CIFS_NTSC</span><span class="p">;</span>
			<span class="n">pixelsPerLine</span> <span class="o">=</span> <span class="n">LINE_SZ_1CIFS_NTSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">FORMAT_PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCALE_4CIFS</span>:
		<span class="k">case</span> <span class="n">SCALE_4CIFSI</span>:
			<span class="n">linesPerFrame</span> <span class="o">=</span> <span class="n">NUM_LINES_4CIFS_PAL</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">pixelsPerLine</span> <span class="o">=</span> <span class="n">LINE_SZ_4CIFS_PAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCALE_2CIFS</span>:
			<span class="n">linesPerFrame</span> <span class="o">=</span> <span class="n">NUM_LINES_2CIFS_PAL</span><span class="p">;</span>
			<span class="n">pixelsPerLine</span> <span class="o">=</span> <span class="n">LINE_SZ_2CIFS_PAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCALE_1CIFS</span>:
			<span class="n">linesPerFrame</span> <span class="o">=</span> <span class="n">NUM_LINES_1CIFS_PAL</span><span class="p">;</span>
			<span class="n">pixelsPerLine</span> <span class="o">=</span> <span class="n">LINE_SZ_1CIFS_PAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">outImageSize</span> <span class="o">=</span> <span class="n">linesPerFrame</span> <span class="o">*</span> <span class="n">pixelsPerLine</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&amp;</span> <span class="n">MASK_COLOR</span><span class="p">)</span> <span class="o">!=</span> <span class="n">COLOR_Y8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2 bytes/pixel if not monochrome */</span>
		<span class="n">outImageSize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* total bytes to send including prefix and 4K padding;</span>
<span class="cm">	   must be a multiple of USB_READ_SIZE */</span>
	<span class="n">usbInSize</span> <span class="o">=</span> <span class="n">outImageSize</span> <span class="o">+</span> <span class="n">PREFIX_SIZE</span><span class="p">;</span>	<span class="cm">/* always send prefix */</span>
	<span class="n">mask_mult</span> <span class="o">=</span> <span class="mh">0xffffffffUL</span> <span class="o">-</span> <span class="n">DEF_USB_BLOCK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* if size not a multiple of USB_READ_SIZE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbInSize</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask_mult</span><span class="p">)</span>
		<span class="n">usbInSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbInSize</span> <span class="o">&amp;</span> <span class="n">mask_mult</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DEF_USB_BLOCK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usbInSize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_print_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;format: %d</span><span class="se">\n</span><span class="s">scale %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fdec: %d</span><span class="se">\n</span><span class="s">color %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">fdec</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bright: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bright</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set mode is the function which controls the DSP.</span>
<span class="cm"> * the restart parameter in struct s2255_mode should be set whenever</span>
<span class="cm"> * the image size could change via color format, video system or image</span>
<span class="cm"> * size.</span>
<span class="cm"> * When the restart parameter is set, we sleep for ONE frame to allow the</span>
<span class="cm"> * DSP time to get the new frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">s2255_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chn_rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">chn_rev</span> <span class="o">=</span> <span class="n">G_chnmap</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s channel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="cm">/* if JPEG, set the quality */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&amp;</span> <span class="n">MASK_COLOR</span><span class="p">)</span> <span class="o">==</span> <span class="n">COLOR_JPG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_COLOR</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">|=</span> <span class="n">COLOR_JPG</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_JPG_QUALITY</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">|=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">jc</span><span class="p">.</span><span class="n">quality</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* save the mode */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">req_image_size</span> <span class="o">=</span> <span class="n">get_transfer_size</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: reqsize %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">req_image_size</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set the mode */</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_DATA_TOKEN</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span><span class="p">)</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chn_rev</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_SET_MODE</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_mode</span><span class="p">));</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">setmode_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">s2255_write_config</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">s2255_print_cfg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="cm">/* wait at least 3 frames before continuing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_setmode</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">setmode_ready</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
				   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">S2255_SETMODE_TIMEOUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">setmode_ready</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;s2255: no set mode response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* clear the restart flag */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s chn %d, result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_cmd_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chn_rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">chn_rev</span> <span class="o">=</span> <span class="n">G_chnmap</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s chan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* form the get vid status command */</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_DATA_TOKEN</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span><span class="p">)</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chn_rev</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_STATUS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidstatus_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">s2255_write_config</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_vidstatus</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidstatus_ready</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">S2255_VIDSTATUS_TIMEOUT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidstatus_ready</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;s2255: no vidstatus response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidstatus</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s, vid status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">pstatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid fh type0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid fh type1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_get</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s2255_dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stream busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">last_frame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">bad_payload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">SYS_FRAMES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ulState</span> <span class="o">=</span> <span class="n">S2255_READ_IDLE</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">cur_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s2255_start_acquire</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">b_acquire</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">res_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">, channel: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid fh type0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid type i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s2255_stop_acquire</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>
	<span class="n">res_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">videobuf_queue_is_busy</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;queue busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_s_std</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_locked</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;can&#39;t change standard after started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_s_std</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* if changing format, reset frame decimation/intervals */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">!=</span> <span class="n">FORMAT_NTSC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_NTSC</span><span class="p">;</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">fdec</span> <span class="o">=</span> <span class="n">FDEC_1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">!=</span> <span class="n">FORMAT_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_PAL</span><span class="p">;</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">fdec</span> <span class="o">=</span> <span class="n">FDEC_1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">restart</span><span class="p">)</span>
		<span class="n">s2255_set_mode</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
<span class="nl">out_s_std:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sensoray 2255 is a multiple channel capture device.</span>
<span class="cm">   It does not have a &quot;crossbar&quot; of inputs.</span>
<span class="cm">   We use one V4L device per channel. The user must</span>
<span class="cm">   be aware that certain combinations are not allowed.</span>
<span class="cm">   For instance, you cannot do full FPS on more than 2 channels(2 videodevs)</span>
<span class="cm">   at once in color(you can do full fps on 4 channels with greyscale.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">S2255_NORMS</span><span class="p">;</span>
	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dsp_fw_ver</span> <span class="o">&gt;=</span> <span class="n">S2255_MIN_DSP_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">s2255_cmd_status</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;s2255_cmd_status rc: %d status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">inp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>  <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span>
				<span class="o">:</span> <span class="n">V4L2_IN_ST_NO_SIGNAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x2255</span>:
	<span class="nl">default:</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2257</span>:
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Composite&quot;</span> <span class="o">:</span> <span class="s">&quot;S-Video&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --- controls ---------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEF_BRIGHT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEF_CONTRAST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEF_SATURATION</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEF_HUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_COLORFILTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dsp_fw_ver</span> <span class="o">&lt;</span> <span class="n">S2255_MIN_DSP_COLORFILTER</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="mh">0x2257</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Color Filter&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s, id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bright</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">contrast</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">saturation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_COLORFILTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dsp_fw_ver</span> <span class="o">&lt;</span> <span class="n">S2255_MIN_DSP_COLORFILTER</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="mh">0x2257</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="o">!</span><span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;</span> <span class="n">MASK_INPUT_TYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s, id %d val %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2255_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* update the mode to the corresponding value */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">mode</span><span class="p">.</span><span class="n">bright</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">mode</span><span class="p">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">mode</span><span class="p">.</span><span class="n">hue</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">mode</span><span class="p">.</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_COLORFILTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dsp_fw_ver</span> <span class="o">&lt;</span> <span class="n">S2255_MIN_DSP_COLORFILTER</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="mh">0x2257</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_INPUT_TYPE</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* set mode here.  Note: stream does not need restarted.</span>
<span class="cm">	   some V4L programs restart stream unnecessarily</span>
<span class="cm">	   after a s_crtl.</span>
<span class="cm">	*/</span>
	<span class="n">s2255_set_mode</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">jc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="o">*</span><span class="n">jc</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">jc</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: quality %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">jc</span><span class="o">-&gt;</span><span class="n">quality</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">jc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jc</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">jc</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">jc</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">jc</span><span class="o">-&gt;</span><span class="n">quality</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: quality %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">jc</span><span class="o">-&gt;</span><span class="n">quality</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">def_num</span><span class="p">,</span> <span class="n">def_dem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_streamparm</span><span class="p">));</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_CAP_TIMEPERFRAME</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capturemode</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">cap_parm</span><span class="p">.</span><span class="n">capturemode</span><span class="p">;</span>
	<span class="n">def_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">FORMAT_NTSC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1001</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">def_dem</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">FORMAT_NTSC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">30000</span> <span class="o">:</span> <span class="mi">25000</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">def_dem</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">fdec</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">FDEC_1</span>:
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDEC_2</span>:
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDEC_3</span>:
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDEC_5</span>:
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s capture mode, %d timeperframe %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capturemode</span><span class="p">,</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fdec</span> <span class="o">=</span> <span class="n">FDEC_1</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">def_num</span><span class="p">,</span> <span class="n">def_dem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="cm">/* high quality capture mode requires a stream restart */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">cap_parm</span><span class="p">.</span><span class="n">capturemode</span>
	    <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capturemode</span> <span class="o">&amp;&amp;</span> <span class="n">res_locked</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">def_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">FORMAT_NTSC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1001</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">def_dem</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">FORMAT_NTSC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">30000</span> <span class="o">:</span> <span class="mi">25000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_dem</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">&lt;=</span> <span class="n">def_num</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">def_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">fdec</span> <span class="o">=</span> <span class="n">FDEC_2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">def_num</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">fdec</span> <span class="o">=</span> <span class="n">FDEC_3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">def_num</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">fdec</span> <span class="o">=</span> <span class="n">FDEC_5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mode</span><span class="p">.</span><span class="n">fdec</span> <span class="o">=</span> <span class="n">fdec</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">def_dem</span><span class="p">;</span>
	<span class="n">s2255_set_mode</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s capture mode, %d timeperframe %d/%d, fdec %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capturemode</span><span class="p">,</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">,</span> <span class="n">fdec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_frameintervals</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_frmivalenum</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_ntsc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#define NUM_FRAME_ENUMS 4</span>
	<span class="kt">int</span> <span class="n">frm_dec</span><span class="p">[</span><span class="n">NUM_FRAME_ENUMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">NUM_FRAME_ENUMS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">640</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">240</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">480</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">is_ntsc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">320</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">240</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">is_ntsc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">704</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">288</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">576</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">352</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">288</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMIVAL_TYPE_DISCRETE</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">is_ntsc</span> <span class="o">?</span> <span class="mi">30000</span> <span class="o">:</span> <span class="mi">25000</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_ntsc</span> <span class="o">?</span> <span class="mi">1001</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">frm_dec</span><span class="p">[</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s discrete %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">denominator</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;s2255: open called (dev=%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">video_device_node_name</span><span class="p">(</span><span class="n">vdev</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * open lock necessary to prevent multiple instances</span>
<span class="cm">	 * of v4l-conf (or other programs) from simultaneously</span>
<span class="cm">	 * reloading firmware.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S2255_FW_DISCONNECTING</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S2255_FW_FAILED</span>:
		<span class="n">s2255_dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;firmware load failed. retrying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s2255_fwload_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">,</span>
				   <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">)</span>
				     <span class="o">==</span> <span class="n">S2255_FW_SUCCESS</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">)</span>
				     <span class="o">==</span> <span class="n">S2255_FW_DISCONNECTING</span><span class="p">)),</span>
				   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">S2255_LOAD_TIMEOUT</span><span class="p">));</span>
		<span class="cm">/* state may have changed, re-read */</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S2255_FW_NOTLOADED</span>:
	<span class="k">case</span> <span class="n">S2255_FW_LOADED_DSPWAIT</span>:
		<span class="cm">/* give S2255_LOAD_TIMEOUT time for firmware to load in case</span>
<span class="cm">		   driver loaded and then device immediately opened */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s waiting for firmware load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">,</span>
				   <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">)</span>
				     <span class="o">==</span> <span class="n">S2255_FW_SUCCESS</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">)</span>
				     <span class="o">==</span> <span class="n">S2255_FW_DISCONNECTING</span><span class="p">)),</span>
				   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">S2255_LOAD_TIMEOUT</span><span class="p">));</span>
		<span class="cm">/* state may have changed, re-read */</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S2255_FW_SUCCESS</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* state may have changed in above switch statement */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S2255_FW_SUCCESS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S2255_FW_FAILED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;2255 firmware load failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S2255_FW_DISCONNECTING</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: disconnecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S2255_FW_LOADED_DSPWAIT</span>:
	<span class="k">case</span> <span class="n">S2255_FW_NOTLOADED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: firmware not loaded yet&quot;</span>
		       <span class="s">&quot;please try again later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Timeout on firmware load means device unusable.</span>
<span class="cm">		 * Set firmware failure state.</span>
<span class="cm">		 * On next s2255_open the firmware will be reloaded.</span>
<span class="cm">		 */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span>
			   <span class="n">S2255_FW_FAILED</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: unknown state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="cm">/* allocate + initialize per filehandle data */</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fh</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fh</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* configure channel to default state */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">formats</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s2255_set_mode</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: dev=%s type=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">video_device_node_name</span><span class="p">(</span><span class="n">vdev</span><span class="p">),</span> <span class="n">v4l2_type_names</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: fh=0x%08lx, dev=0x%08lx, vidq=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fh</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidq</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s: list_empty active=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidq</span><span class="p">.</span><span class="n">active</span><span class="p">));</span>
	<span class="n">videobuf_queue_vmalloc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s2255_video_qops</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span>
				    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				    <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_buffer</span><span class="p">),</span>
				    <span class="n">fh</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">s2255_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POLLERR</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* board shutdown stops the read pipe if it is running */</span>
	<span class="n">s2255_board_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* make sure firmware still not trying to load */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>  <span class="cm">/* only started in .probe and .open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="p">);</span>
	<span class="cm">/* reset the DSP so firmware can be reloaded next time */</span>
	<span class="n">s2255_reset_dsppower</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="cm">/* turn off stream */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">b_acquire</span><span class="p">)</span>
			<span class="n">s2255_stop_acquire</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>
		<span class="n">res_free</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s (dev=%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">vdev</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_mmap_v4l</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s, vma=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vma</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_mmap_mapper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s vma start=0x%08lx, size=%ld, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">s2255_fops_v4l</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">s2255_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">s2255_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">s2255_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>	<span class="cm">/* V4L2 ioctl handler */</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">s2255_mmap_v4l</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">s2255_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querymenu</span> <span class="o">=</span> <span class="n">vidioc_querymenu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span> <span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span> <span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span> <span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span> <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span> <span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span> <span class="o">=</span> <span class="n">vidioc_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span> <span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span> <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span> <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span> <span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span> <span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span> <span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span> <span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span> <span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_jpegcomp</span> <span class="o">=</span> <span class="n">vidioc_s_jpegcomp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_jpegcomp</span> <span class="o">=</span> <span class="n">vidioc_g_jpegcomp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_parm</span> <span class="o">=</span> <span class="n">vidioc_s_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_parm</span> <span class="o">=</span> <span class="n">vidioc_g_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_frameintervals</span> <span class="o">=</span> <span class="n">vidioc_enum_frameintervals</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_video_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s, chnls: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">))</span>
		<span class="n">s2255_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;s2255v&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s2255_fops_v4l</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s2255_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">s2255_video_device_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span> <span class="o">=</span> <span class="n">S2255_NORMS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">current_norm</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_probe_v4l</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_nr</span> <span class="o">=</span> <span class="n">video_nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* initialize all video 4 linux */</span>
	<span class="cm">/* register 4 video devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidq</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidq</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="cm">/* register 4 video devices */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">template</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="cm">/* Locking in file operations other than ioctl should be done</span>
<span class="cm">		   by the driver, not the V4L2 core.</span>
<span class="cm">		   This driver needs auditing so that this flag can be removed. */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_LOCK_ALL_FOPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
		<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_nr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span>
						    <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span>
						    <span class="n">video_nr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span>
						    <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span>
						    <span class="n">cur_nr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to register video device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">);</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;V4L2 device registered as %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">video_device_node_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Sensoray 2255 V4L driver Revision: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">S2255_VERSION</span><span class="p">);</span>
	<span class="cm">/* if no channels registered, return error and probe will fail*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MAX_CHANNELS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;s2255: Not all channels available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function moves the usb stream read pipe data</span>
<span class="cm"> * into the system buffers.</span>
<span class="cm"> * returns 0 on success, EAGAIN if more data to process( call this</span>
<span class="cm"> * function again).</span>
<span class="cm"> *</span>
<span class="cm"> * Received frame structure:</span>
<span class="cm"> * bytes 0-3:  marker : 0x2255DA4AL (S2255_MARKER_FRAME)</span>
<span class="cm"> * bytes 4-7:  channel: 0-3</span>
<span class="cm"> * bytes 8-11: payload size:  size of the frame</span>
<span class="cm"> * bytes 12-payloadsize+12:  frame data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">save_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2255_pipeinfo</span> <span class="o">*</span><span class="n">pipe_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pdest</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bframe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psrc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">copy_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_framei</span> <span class="o">*</span><span class="n">frm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;buffer to user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">];</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>
	<span class="n">frm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frm</span><span class="o">-&gt;</span><span class="n">ulState</span> <span class="o">==</span> <span class="n">S2255_READ_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">jj</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="o">*</span><span class="n">pdword</span><span class="p">;</span> <span class="cm">/*data from dsp is little endian */</span>
		<span class="kt">int</span> <span class="n">payload</span><span class="p">;</span>
		<span class="cm">/* search for marker codes */</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
		<span class="n">pdword</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">pdata</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">cur_transfer_size</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span> <span class="n">jj</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pdword</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">S2255_MARKER_FRAME</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;found frame marker at offset:&quot;</span>
					<span class="s">&quot; %d [%x %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">pdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">+</span> <span class="n">PREFIX_SIZE</span><span class="p">;</span>
				<span class="n">bframe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					       <span class="s">&quot;bad channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* reverse it */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="n">G_chnmap</span><span class="p">[</span><span class="n">cc</span><span class="p">];</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">];</span>
				<span class="n">payload</span> <span class="o">=</span>  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">payload</span> <span class="o">&gt;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">req_image_size</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">channel</span><span class="o">-&gt;</span><span class="n">bad_payload</span><span class="o">++</span><span class="p">;</span>
					<span class="cm">/* discard the bad frame */</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">channel</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>
				<span class="n">channel</span><span class="o">-&gt;</span><span class="n">jpg_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S2255_MARKER_RESPONSE</span>:

				<span class="n">pdata</span> <span class="o">+=</span> <span class="n">DEF_USB_BLOCK</span><span class="p">;</span>
				<span class="n">jj</span> <span class="o">+=</span> <span class="n">DEF_USB_BLOCK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNELS</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">cc</span> <span class="o">=</span> <span class="n">G_chnmap</span><span class="p">[</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">1</span><span class="p">])];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNELS</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">cc</span><span class="p">];</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">S2255_RESPONSE_SETMODE</span>:
					<span class="cm">/* check if channel valid */</span>
					<span class="cm">/* set mode ready */</span>
					<span class="n">channel</span><span class="o">-&gt;</span><span class="n">setmode_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_setmode</span><span class="p">);</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;setmode ready %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">S2255_RESPONSE_FW</span>:
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">chn_ready</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cc</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chn_ready</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0f</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="cm">/* all channels ready */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;s2255: fw loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span>
						   <span class="n">S2255_FW_SUCCESS</span><span class="p">);</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">S2255_RESPONSE_STATUS</span>:
					<span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidstatus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
					<span class="n">channel</span><span class="o">-&gt;</span><span class="n">vidstatus_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_vidstatus</span><span class="p">);</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;got vidstatus %x chan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdword</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">cc</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;s2255 unknown resp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="nl">default:</span>
				<span class="n">pdata</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bframe</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* for */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bframe</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">];</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>
	<span class="n">frm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="cm">/* search done.  now find out if should be acquiring on this channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">b_acquire</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we found a frame, but this channel is turned off */</span>
		<span class="n">frm</span><span class="o">-&gt;</span><span class="n">ulState</span> <span class="o">=</span> <span class="n">S2255_READ_IDLE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frm</span><span class="o">-&gt;</span><span class="n">ulState</span> <span class="o">==</span> <span class="n">S2255_READ_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frm</span><span class="o">-&gt;</span><span class="n">ulState</span> <span class="o">=</span> <span class="n">S2255_READ_FRAME</span><span class="p">;</span>
		<span class="n">frm</span><span class="o">-&gt;</span><span class="n">cur_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* skip the marker 512 bytes (and offset if out of sync) */</span>
	<span class="n">psrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">frm</span><span class="o">-&gt;</span><span class="n">lpvbits</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;s2255 frame buffer == NULL.%p %p %d %d&quot;</span><span class="p">,</span>
			<span class="n">frm</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdest</span> <span class="o">=</span> <span class="n">frm</span><span class="o">-&gt;</span><span class="n">lpvbits</span> <span class="o">+</span> <span class="n">frm</span><span class="o">-&gt;</span><span class="n">cur_size</span><span class="p">;</span>

	<span class="n">copy_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">cur_transfer_size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">-</span> <span class="n">PREFIX_SIZE</span><span class="p">;</span>

	<span class="cm">/* sanity check on pdest */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">copy_size</span> <span class="o">+</span> <span class="n">frm</span><span class="o">-&gt;</span><span class="n">cur_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">req_image_size</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pdest</span><span class="p">,</span> <span class="n">psrc</span><span class="p">,</span> <span class="n">copy_size</span><span class="p">);</span>

	<span class="n">frm</span><span class="o">-&gt;</span><span class="n">cur_size</span> <span class="o">+=</span> <span class="n">copy_size</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;cur_size size %lu size %lu </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frm</span><span class="o">-&gt;</span><span class="n">cur_size</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frm</span><span class="o">-&gt;</span><span class="n">cur_size</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;****************[%d]Buffer[%d]full*************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">last_frame</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* end of system frame ring buffer, start at zero */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">==</span> <span class="n">SYS_FRAMES</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">==</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">dwFrames</span><span class="p">))</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* frame ready */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">b_acquire</span><span class="p">)</span>
			<span class="n">s2255_got_frame</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">jpg_size</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">frm</span><span class="o">-&gt;</span><span class="n">ulState</span> <span class="o">=</span> <span class="n">S2255_READ_IDLE</span><span class="p">;</span>
		<span class="n">frm</span><span class="o">-&gt;</span><span class="n">cur_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* done successfully */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_read_video_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">s2255_pipeinfo</span> <span class="o">*</span><span class="n">pipe_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;callback read video </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* otherwise copy to the system buffers */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">save_frame</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;s2255: read callback failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;callback read video done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">s2255_vendor_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Request</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">Index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">Value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">TransferBuffer</span><span class="p">,</span>
			     <span class="n">s32</span> <span class="n">TransferBufferLength</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bOut</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bOut</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				    <span class="n">Request</span><span class="p">,</span>
				    <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span>
				    <span class="n">USB_DIR_IN</span><span class="p">,</span>
				    <span class="n">Value</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TransferBuffer</span><span class="p">,</span>
				    <span class="n">TransferBufferLength</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				    <span class="n">Request</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
				    <span class="n">Value</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TransferBuffer</span><span class="p">,</span>
				    <span class="n">TransferBufferLength</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * retrieve FX2 firmware version. future use.</span>
<span class="cm"> * @param dev pointer to device extension</span>
<span class="cm"> * @return -1 for fail, else returns firmware version as an int(16 bits)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_get_fx2fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">transBuffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">s2255_vendor_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S2255_VR_FW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">transBuffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">S2255_VR_IN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;get fw error: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">fw</span> <span class="o">=</span> <span class="n">transBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">transBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Get FW %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">transBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">fw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create the system ring buffer to copy frames into from the</span>
<span class="cm"> * usb read pipe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_create_sys_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reqsize</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;create sys buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">dwFrames</span> <span class="o">=</span> <span class="n">SYS_FRAMES</span><span class="p">;</span>
	<span class="cm">/* always allocate maximum size(PAL) for system buffers */</span>
	<span class="n">reqsize</span> <span class="o">=</span> <span class="n">SYS_FRAMES_MAXSIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reqsize</span> <span class="o">&gt;</span> <span class="n">SYS_FRAMES_MAXSIZE</span><span class="p">)</span>
		<span class="n">reqsize</span> <span class="o">=</span> <span class="n">SYS_FRAMES_MAXSIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYS_FRAMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allocate the frames */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpvbits</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">reqsize</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;valloc %p chan %d, idx %lu, pdata %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpvbits</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">reqsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpvbits</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;out of memory.  using less frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">dwFrames</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* make sure internal states are set */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYS_FRAMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cur_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">last_frame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_release_sys_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;release sys buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYS_FRAMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpvbits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;vfree %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpvbits</span><span class="p">);</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpvbits</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpvbits</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_board_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_mode</span> <span class="n">mode_def</span> <span class="o">=</span> <span class="n">DEF_MODEI_NTSC_CONT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_pipeinfo</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;board init: %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">cur_transfer_size</span> <span class="o">=</span> <span class="n">S2255_USB_XFER_SIZE</span><span class="p">;</span>
	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_transfer_size</span> <span class="o">=</span> <span class="n">S2255_USB_XFER_SIZE</span><span class="p">;</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_transfer_size</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* query the firmware */</span>
	<span class="n">fw_ver</span> <span class="o">=</span> <span class="n">s2255_get_fx2fw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;s2255: usb firmware version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">fw_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	       <span class="n">fw_ver</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ver</span> <span class="o">&lt;</span> <span class="n">S2255_CUR_USB_FWVER</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;s2255: newer USB firmware available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">b_acquire</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode_def</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="mh">0x2257</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">color</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">jc</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">S2255_DEF_JPEG_QUAL</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">LINE_SZ_4CIFS_NTSC</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">NUM_LINES_4CIFS_NTSC</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">formats</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">req_image_size</span> <span class="o">=</span> <span class="n">get_transfer_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode_def</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* create the system buffers */</span>
		<span class="n">s2255_create_sys_buffers</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* start read pipe */</span>
	<span class="n">s2255_start_readpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_board_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: dev: %p&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_acquire</span><span class="p">)</span>
			<span class="n">s2255_stop_acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">s2255_stop_readpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s2255_release_sys_buffers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="cm">/* release transfer buffer */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_pipe_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_pipeinfo</span> <span class="o">*</span><span class="n">pipe_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">pipe_info</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;%s: urb:%p, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">purb</span><span class="p">,</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no context!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no context!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="cm">/* if shutting down, do not resubmit, exit immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: err shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">err_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: exiting USB pipe&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s2255_read_video_callback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe_info</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">err_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: failed URB %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_endpoint</span><span class="p">);</span>
	<span class="cm">/* reuse urb */</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			  <span class="n">pipe</span><span class="p">,</span>
			  <span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			  <span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">cur_transfer_size</span><span class="p">,</span>
			  <span class="n">read_pipe_completion</span><span class="p">,</span> <span class="n">pipe_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error submitting urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s :complete state 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_start_readpipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_pipeinfo</span> <span class="o">*</span><span class="n">pipe_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_endpoint</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: IN %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_endpoint</span><span class="p">);</span>
	<span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">err_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">stream_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;ReadStream: Unable to alloc URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* transfer buffer allocated in board_init */</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			  <span class="n">pipe</span><span class="p">,</span>
			  <span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			  <span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">cur_transfer_size</span><span class="p">,</span>
			  <span class="n">read_pipe_completion</span><span class="p">,</span> <span class="n">pipe_info</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pipe_info</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;s2255: start read pipe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* starts acquisition process */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_start_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chn_rev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">chn_rev</span> <span class="o">=</span> <span class="n">G_chnmap</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">last_frame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">bad_payload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">SYS_FRAMES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ulState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">cur_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send the start command */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">IN_DATA_TOKEN</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span><span class="p">)</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chn_rev</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">CMD_START</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">s2255_write_config</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CMD_START error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;start acquire exit[%d] %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_stop_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chn_rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">chn_rev</span> <span class="o">=</span> <span class="n">G_chnmap</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* send the stop command */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">IN_DATA_TOKEN</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span><span class="p">)</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chn_rev</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">CMD_STOP</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">s2255_write_config</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CMD_STOP error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">b_acquire</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s: chn %d, res %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_stop_readpipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_pipeinfo</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* cancel urb */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_urb</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_fwload_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">s2255_reset_dsppower</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S2255_FW_NOTLOADED</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_loaded</span> <span class="o">=</span> <span class="n">CHUNK_SIZE</span><span class="p">;</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			  <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">,</span>
			  <span class="n">CHUNK_SIZE</span><span class="p">,</span> <span class="n">s2255_fwchunk_complete</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* standard usb probe function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2255_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_size</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* allocate memory for our device state and initialize it to zero */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s2255_dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2255_fw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errorFWDATA1</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="cm">/* grab usb_device and save it */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;null usb device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errorUDEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;dev: %p, udev %p interface %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">interface</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span><span class="p">;</span>
	<span class="cm">/* set up the endpoint information  */</span>
	<span class="n">iface_desc</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;num endpoints %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_endpoint</span> <span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_is_bulk_in</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* we found the bulk in endpoint */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_endpoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not find bulk-in endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errorEP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">s2255_timer</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">s2255_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_setmode</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_vidstatus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errorFWURB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">pfw_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errorFWDATA2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* load the first chunk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span>
			     <span class="n">FIRMWARE_FILE_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sensoray 2255 failed to get firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errorREQFW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check the firmware is valid */</span>
	<span class="n">fw_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">fw_size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pdata</span> <span class="o">!=</span> <span class="n">S2255_FW_MARKER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Firmware invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errorFWMARKER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* make sure firmware is the latest */</span>
		<span class="n">__le32</span> <span class="o">*</span><span class="n">pRel</span><span class="p">;</span>
		<span class="n">pRel</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">fw_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;s2255 dsp fw version %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pRel</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dsp_fw_ver</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pRel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dsp_fw_ver</span> <span class="o">&lt;</span> <span class="n">S2255_CUR_DSP_FWVER</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;s2255: f2255usb.bin out of date.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="mh">0x2257</span> <span class="o">&amp;&amp;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dsp_fw_ver</span> <span class="o">&lt;</span> <span class="n">S2255_MIN_DSP_COLORFILTER</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;s2255: 2257 requires firmware %d&quot;</span>
			       <span class="s">&quot; or above.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">S2255_MIN_DSP_COLORFILTER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="cm">/* load 2255 board specific */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">s2255_board_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errorBOARDINIT</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">s2255_fwload_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* loads v4l specific */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">s2255_probe_v4l</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errorBOARDINIT</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sensoray 2255 detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">errorBOARDINIT:</span>
	<span class="n">s2255_board_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">errorFWMARKER:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
<span class="nl">errorREQFW:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">pfw_data</span><span class="p">);</span>
<span class="nl">errorFWDATA2:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_urb</span><span class="p">);</span>
<span class="nl">errorFWURB:</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="nl">errorEP:</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
<span class="nl">errorUDEV:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">errorFWDATA1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sensoray 2255 driver load failed: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* disconnect routine. when board is removed physically or with rmmod */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2255_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2255_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_s2255_dev</span><span class="p">(</span><span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">v4l2_device_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*see comments in the uvc_driver.c usb disconnect function */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">);</span>
	<span class="cm">/* unregister each video device. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vdev</span><span class="p">);</span>
	<span class="cm">/* wake up any of our timers */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S2255_FW_DISCONNECTING</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="o">-&gt;</span><span class="n">wait_fw</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setmode_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_setmode</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vidstatus_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_vidstatus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">))</span>
		<span class="n">s2255_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">s2255_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">S2255_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">s2255_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">s2255_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">s2255_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">s2255_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sensoray 2255 Video for Linux driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dean Anderson (Sensoray Company Inc.)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">S2255_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
